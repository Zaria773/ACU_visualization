<template>
  <div>
    <div class="music-container" style="display: grid; grid-template-columns: 1fr 64px; width: 100%">
      <div style="display: flex; flex-direction: column; margin-top: 8px; overflow: hidden; max-width: 100%">
        <div class="hide-title music-name" style="font-size: 1.2rem">
          <strong>{{ props.song }}</strong>
        </div>
        <div class="hide-title music-author" style="color: #8d8c8d; margin-left: 3px; margin-top: 5px; font-size: 1rem">
          {{ props.singer }}
        </div>
      </div>
      <div style="margin-left: auto; position: relative; height: 64px; width: 64px">
        <div class="icon-container" style="width: 64px; width: 64px; position: relative">
          <svg style="position: absolute; left: -3px; top: -5px" viewBox="0 0 1024 1024" width="72" height="72">
            <path
              d="M773.9392 301.8752m-200.0384 0a200.0384 200.0384 0 1 0 400.0768 0 200.0384 200.0384 0 1 0-400.0768 0Z"
              fill="#d81e06"
              p-id="51386"
            ></path>
            <path
              d="M924.4672 706.2528a24.32 24.32 0 0 1-24.2688 24.2688h-145.7664a24.3712 24.3712 0 0 0-24.2688 24.32 24.2688 24.2688 0 0 0 24.2688 24.2688h48.5888a24.32 24.32 0 0 1 24.2688 24.32 24.32 24.32 0 0 1-24.2688 24.2688h-64.512A388.7616 388.7616 0 0 1 122.88 390.4512h-48.5888a24.32 24.32 0 0 1 0-48.5888h97.28a24.2688 24.2688 0 0 0 6.8096-47.5648l0.768-0.9728H122.88a24.32 24.32 0 1 1 0-48.5888h101.632a388.7616 388.7616 0 0 1 619.52 437.248h56.32a24.32 24.32 0 0 1 24.1152 24.2688z"
              fill="#2c2c2c"
              p-id="51387"
            ></path>
            <path
              d="M565.8112 478.8736a3.84 3.84 0 0 0-4.5568 4.608c3.1744 14.7456 7.8848 40.96 9.984 60.0576 3.6352 32.2048-28.5696 62.3104-53.6064 70.7584-39.424 13.568-84.8896-18.688-95.1296-56.32-11.776-43.9808 12.6464-97.5872 53.2992-115.0464 4.5056-2.0992 9.0112-3.8912 13.568-5.9904 9.3184-4.2496 4.8128-11.1616 3.2768-17.5104-4.1984-17.4592-6.6048-34.9184 2.4064-51.2 13.568-24.4224 48.7936-43.6736 76.1856-31.9488a276.48 276.48 0 0 1 34.6624 16.5888 25.1904 25.1904 0 0 1 10.5472 28.2624c-5.7344 15.36-20.7872 18.9952-36.7616 9.6768a196.1984 196.1984 0 0 0-17.4592-9.9328 16.2304 16.2304 0 0 0-23.808 15.36 150.3744 150.3744 0 0 0 1.9456 18.0224 18.4832 18.4832 0 0 0 13.568 14.8992 200.3456 200.3456 0 0 1 29.3888 8.9088c38.8096 17.152 66.56 45.1584 79.5136 87.04 24.064 77.6704-21.0944 155.0848-87.9616 184.6272a182.016 182.016 0 0 1-116.8384 13.2096 185.6 185.6 0 0 1-126.464-104.8064c-18.0736-40.96-22.8864-82.7904-8.7552-127.0784 18.9952-59.2384 56.9344-99.6352 114.7392-121.9072a23.4496 23.4496 0 0 1 28.0064 9.728 21.1456 21.1456 0 0 1-6.0416 29.5424 259.8912 259.8912 0 0 1-25.2928 13.568c-31.8976 16.2304-51.7632 42.752-64.4096 75.8784-24.7296 64.4096 9.3184 139.1104 65.6384 168.3456 51.7632 27.0848 122.5728 16.2304 160.8192-28.3136A106.2912 106.2912 0 0 0 619.52 542.72c-5.12-25.6-34.5088-59.2896-53.7088-63.8464z m-53.4016 5.9904a6.144 6.144 0 0 0-7.9872-4.5056c-33.28 11.4688-47.5136 47.2576-31.9488 76.4416a28.0064 28.0064 0 0 0 30.1056 13.824c14.1824-4.1984 24.1152-14.4384 22.016-27.6992-2.9696-19.5072-7.936-38.8096-12.1856-58.0608z"
              fill="#d81e06"
              p-id="51388"
            ></path>
          </svg>
          <div
            v-show="musicImg"
            class="music-img"
            :style="`width: 64px;
              height: 64px;
              position: absolute;
              left: 0;
              top: 0;
              background-size: cover;
              z-index: 1;
              background-image: url('${musicImg}');`"
          ></div>
        </div>

        <div class="music-play-button">
          <svg
            v-show="!playing"
            @click="playMusic"
            class="icon-music-play"
            viewBox="0 0 1024 1024"
            width="24"
            height="24"
          >
            <path
              d="M902.420317 544.833016l-585.142857-357.587302v715.174603l585.142857-357.587301z"
              p-id="42990"
              fill="#ffffff"
            ></path>
          </svg>
          <svg
            class="icon-music-stop"
            @click="stopMusic"
            t="1743245033745"
            viewBox="0 0 1024 1024"
            width="19"
            height="19"
            v-show="playing"
          >
            <path
              d="M290.133333 128h-39.808C206.336 128 170.666667 178.944 170.666667 241.792v540.416C170.666667 845.056 206.336 896 250.325333 896H290.133333c43.946667 0 79.658667-50.944 79.658667-113.792V241.792C369.792 178.944 334.08 128 290.133333 128zM773.674667 128H733.866667c-43.989333 0-79.658667 50.944-79.658667 113.792v540.416c0 62.848 35.669333 113.792 79.658667 113.792h39.808C817.664 896 853.333333 845.056 853.333333 782.208V241.792C853.333333 178.944 817.664 128 773.674667 128z"
              fill="#ffffff"
              p-id="43402"
            ></path>
          </svg>
        </div>
      </div>
    </div>
    <div style="width: 100%; height: 2px; background-color: #efefef; margin-bottom: 5px; margin-top: 5px"></div>
    <div style="display: flex; align-items: center; gap: 5px">
      <svg viewBox="0 0 1024 1024" style="width: 0.9rem; height: 0.9rem">
        <path
          d="M0 0m184.32 0l655.36 0q184.32 0 184.32 184.32l0 655.36q0 184.32-184.32 184.32l-655.36 0q-184.32 0-184.32-184.32l0-655.36q0-184.32 184.32-184.32Z"
          fill="#EA3E3C"
          p-id="1500"
        ></path>
        <path
          d="M527.616 849.43872a373.6064 373.6064 0 0 1-162.54976-39.00416c-112.36352-55.16288-180.00896-176.29184-172.55424-308.67456 7.41376-130.34496 85.10464-237.4656 202.752-279.552a35.85024 35.85024 0 0 1 24.15616 67.51232c-107.66336 38.49216-150.81472 136.86784-155.29984 216.13568-5.86752 103.51616 46.08 197.79584 132.34176 240.13824 124.69248 60.30336 216.91392 22.35392 260.82304-5.64224 59.8016-38.16448 97.86368-100.01408 96.95232-157.55264-1.024-63.72352-24.064-120.99584-63.27296-157.14304a145.408 145.408 0 0 0-65.5872-35.28704q2.82624 9.76896 5.64224 19.32288c13.38368 45.63968 24.94464 85.05344 25.6 114.40128a134.26688 134.26688 0 0 1-37.69344 97.76128 139.1104 139.1104 0 0 1-100.6592 40.45824 140.10368 140.10368 0 0 1-100.47488-42.24 169.12384 169.12384 0 0 1-46.2848-122.76736c1.19808-85.12512 80.11776-153.28256 162.816-175.104a324.80256 324.80256 0 0 1-6.71744-67.05152 92.0576 92.0576 0 0 1 69.18144-91.81184c46.21312-12.53376 104.448 5.19168 124.66176 37.888a35.84 35.84 0 0 1-11.70432 49.31584 35.84 35.84 0 0 1-49.26464-11.65312 62.34112 62.34112 0 0 0-48.45568-5.21216c-4.32128 1.71008-12.35968 4.90496-12.76928 23.10144a270.87872 270.87872 0 0 0 6.73792 58.51136 217.4976 217.4976 0 0 1 133.56032 57.6512c53.57568 49.38752 85.0432 125.46048 86.35392 208.71168 1.29024 81.85856-49.7664 167.86432-130.048 219.136a310.14912 310.14912 0 0 1-168.2432 48.65024z m23.6544-457.55392c-56.77056 15.6672-107.4688 63.03744-108.07296 106.42432a98.304 98.304 0 0 0 25.6512 71.43424 68.0448 68.0448 0 0 0 49.36704 20.87936 67.24608 67.24608 0 0 0 49.44896-18.944 63.19104 63.19104 0 0 0 17.23392-46.08c-0.4096-19.79392-11.7248-58.368-22.67136-95.6928-3.61472-12.42112-7.35232-25.14944-10.9568-38.02112z"
          fill="#FFFFFF"
          p-id="1501"
        ></path>
      </svg>
      <div style="font-size: 0.9rem; color: #8d8c8c">网易云音乐</div>
    </div>
  </div>
</template>
<script setup lang="ts">
import { defineProps, computed, watch } from 'vue';
import { sharedState } from '../../shared-state';
const props = defineProps(['song', 'singer']);
const musicId = sharedState.GetRandomId(10);
const musicImg = ref('');
let musicUrl = '';
const playing = ref(false);
let stopOnce: (() => void) | null = null;

async function playMusic() {
  playing.value = true;

  if (!musicUrl) {
    let source = await WY_MusicGetUrl(props.song, props.singer);
    console.log(JSON.stringify(source));
    if (!source?.url) {
      console.log(`网易云获取失败,开始在QQ音乐中搜索`);
      source = await QQ_MusicGetUrl(props.song);
      if (!source || !source.url) {
        toastr.error('获取音源失败!');
        return;
      }
    }
    musicUrl = source.url;
    musicImg.value = source.cover;
  }

  if (sharedState.QQ.music.audio.src != musicUrl) {
    sharedState.QQ.music.audio.src = musicUrl;
  }
  sharedState.QQ.music.id = musicId;
  sharedState.QQ.music.audio.play();

  stopOnce?.();
  stopOnce = watch(
    () => sharedState.QQ.music.id,
    (newValue, oldValue) => {
      if (oldValue === musicId && newValue !== musicId) {
        playing.value = false;
        stopOnce?.(); // 触发一次后自毁
        stopOnce = null;
      }
    },
  );
}

function stopMusic() {
  if (sharedState.QQ.music.id == musicId) {
    sharedState.QQ.music.audio.pause();
  }
  playing.value = false;
}

async function QQ_MusicGetUrl(name: string) {
  try {
    // 获取歌曲列表

    name = name.replace(/\s/g, '');

    let cover = '';

    const result = await sharedState.Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${name}`);
    if (!result?.data?.length) {
      //   QQ_Error('搜索歌曲失败');
      return;
    }

    // 提取所有id
    let ids: string[] = [];
    for (const data of result.data) {
      if (!cover && data.cover) {
        cover = data.cover;
      }
      if (data.id) {
        ids.push(data.id);
      }
      if (data.grp) {
        for (const grp of data.grp) {
          if (grp.id) {
            ids.push(grp.id);
          }
        }
      }
    }
    console.log(`id数量:${ids.length}`);
    // 遍历音质组检测可用音源
    for (const id of ids) {
      try {
        // 获取具体音源URL
        console.log(`准备检测音源 ID:${id}`);
        const r = await sharedState.Http_Get(`https://api.vkeys.cn/v2/music/tencent?id=${id}`);
        if (!r?.data?.url) continue;

        // 异步检测音源可用性
        const isAvailable = await sharedState.checkAudioAvailability(r.data.url);
        if (isAvailable) {
          console.log(`找到可用音源: ${r.data.url}`);
          return {
            url: r.data.url,
            cover: cover,
          };
        }
      } catch (e) {
        console.warn(`音源检测失败: ${id}`, e);
      }
    }

    // QQ_Error('没有找到可用音源');
  } catch (e) {
    // QQ_Error('歌曲搜索异常');
    console.error('获取音源失败:', e);
  }
}

async function WY_MusicGetUrl(name: string, singer?: string) {
  let url = `https://api.vkeys.cn/v2/music/netease?word=${name}`;
  if (singer) {
    url += `-${singer}`;
  }
  let result = await sharedState.Http_Get(url);
  if (!result) return;

  let cover = '';
  let ids = [];
  for (const data of result.data) {
    if (!cover && data.cover) {
      cover = data.cover;
    }
    if (data.id) {
      ids.push(data.id);
    }
  }

  for (const id of ids) {
    try {
      // 获取具体音源URL
      console.log(`准备检测音源 ID:${id}`);
      const r = await sharedState.Http_Get(`https://api.vkeys.cn/v2/music/netease?id=${id}`);
      if (!r?.data?.url) continue;

      // 异步检测音源可用性
      const isAvailable = await sharedState.checkAudioAvailability(r.data.url);
      if (isAvailable) {
        console.log(`找到可用音源: ${r.data.url}`);
        return {
          url: r.data.url,
          cover: cover,
        };
      }
    } catch (e) {
      console.warn(`音源检测失败: ${id}`, e);
    }
  }
}
</script>
