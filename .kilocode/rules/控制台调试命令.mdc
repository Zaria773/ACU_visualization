---
description: 当需要在酒馆浏览器控制台进行调试、检查数据或诊断问题时使用
alwaysApply: false
---

# SillyTavern 控制台调试命令速查

> 在 SillyTavern 浏览器控制台中执行，用于调试和诊断问题。

## 1. 获取酒馆上下文

```javascript
// 获取 SillyTavern 上下文（包含 chat, characters 等）
const ctx = SillyTavern.getContext();
console.log('Chat length:', ctx.chat?.length);
console.log('Current character:', ctx.name2);

// 直接获取聊天数据
const chat = SillyTavern.getContext().chat;
```

## 2. 检查 ACU 数据库 API

```javascript
// 检查 API 是否可用
console.log('AutoCardUpdaterAPI:', !!window.AutoCardUpdaterAPI);
console.log('exportTableAsJson:', !!window.AutoCardUpdaterAPI?.exportTableAsJson);

// 获取当前表格数据
const tableData = window.AutoCardUpdaterAPI?.exportTableAsJson();
console.log('Tables:', Object.keys(tableData).filter(k => k.startsWith('sheet_')));

// 刷新数据库 UI
window.AutoCardUpdaterAPI?.notifyTableUpdate?.();
```

## 3. 检查指定楼层的 IsolatedData

```javascript
// 检查某楼层的 ACU 数据（chatIndex 是数组索引，非 AI 楼层号）
function inspectFloor(chatIndex) {
    const ctx = SillyTavern.getContext();
    const msg = ctx.chat[chatIndex];
    if (!msg) return console.log('楼层不存在');

    console.log(`楼层 ${chatIndex} 是否为用户消息:`, msg.is_user);

    if (msg.TavernDB_ACU_IsolatedData) {
        const tag = Object.keys(msg.TavernDB_ACU_IsolatedData)[0];
        const tagData = msg.TavernDB_ACU_IsolatedData[tag];
        console.log('隔离标签:', tag);
        console.log('modifiedKeys:', tagData.modifiedKeys);
        console.log('updateGroupKeys:', tagData.updateGroupKeys);
        console.log('independentData keys:', Object.keys(tagData.independentData || {}));
    } else {
        console.log('此楼层无 IsolatedData');
    }
}
// 使用：inspectFloor(190);
```

## 4. 遍历所有有 ACU 数据的楼层

```javascript
const ctx = SillyTavern.getContext();
ctx.chat?.forEach((msg, i) => {
    if (msg.TavernDB_ACU_IsolatedData) {
        console.log(`楼层${i}:`, Object.keys(msg.TavernDB_ACU_IsolatedData), msg.TavernDB_ACU_IsolatedData);
    }
});
```

## 5. 检查指导表 (SheetGuide)

```javascript
// 检查 chat[0] 中的指导表
const ctx = SillyTavern.getContext();
console.log('指导表:', ctx.chat?.[0]?.TavernDB_ACU_InternalSheetGuide);
```

## 6. LocalStorage 操作

```javascript
// 查找 ACU 设置键
Object.keys(localStorage).filter(k => k.includes('allSettings'));

// 清除可视化工具的 localStorage
Object.keys(localStorage).filter(k => k.startsWith('acu_')).forEach(k => localStorage.removeItem(k));
location.reload();

// 查看数据库隔离配置
const settingsKey = Object.keys(localStorage).find(k => k.match(/shujuku_v\d+_allSettings_v2/));
if (settingsKey) {
    const settings = JSON.parse(localStorage.getItem(settingsKey));
    console.log('数据隔离启用:', settings.dataIsolationEnabled);
    console.log('隔离标签:', settings.dataIsolationCode);
}
```

## 7. AI 楼层与 Chat 索引转换

```javascript
// 计算 AI 楼层号（只统计非用户消息）
function getAiFloorNumber(chatIndex) {
    const ctx = SillyTavern.getContext();
    return ctx.chat.slice(0, chatIndex + 1).filter(m => !m.is_user).length;
}

// 根据 AI 楼层号找 Chat 索引
function getChatIndexByAiFloor(aiFloor) {
    const ctx = SillyTavern.getContext();
    let aiCount = 0;
    for (let i = 0; i < ctx.chat.length; i++) {
        if (!ctx.chat[i].is_user) {
            aiCount++;
            if (aiCount === aiFloor) return i;
        }
    }
    return -1;
}
// 使用：getChatIndexByAiFloor(93) → 返回 chat 数组索引
```

## 8. 关键字段说明

| 字段 | 作用 | 写入时机 |
|------|------|----------|
| `modifiedKeys` | 记录哪些表在此楼层被修改 | 任何保存操作 |
| `updateGroupKeys` | 记录参与合并更新的表组 | 仅 AI 自动填表时 |
| `independentData` | 实际的表格数据 | 任何保存操作 |
| `TavernDB_ACU_InternalSheetGuide` | 指导表（表头+参数） | 首次填表/可视化保存 |

## 9. 数据库行为速查

| 操作 | 数据来源 | 楼层计算依据 |
|------|----------|-------------|
| 合并数据 | 取最新找到的表数据 | 不看 keys |
| 未记录楼层 | 不适用 | 看 `updateGroupKeys` 优先，否则 `modifiedKeys` |
| 触发自动更新 | 不适用 | 比较 `lastUpdatedAiFloor` 与当前 AI 楼层 |

## 10. 快速诊断命令组合

### 诊断"保存后数据丢失"问题

```javascript
// 1. 检查隔离标签是否正确
const settingsKey = Object.keys(localStorage).find(k => k.match(/shujuku_v\d+_allSettings_v2/));
console.log('设置键:', settingsKey);
if (settingsKey) {
    const s = JSON.parse(localStorage.getItem(settingsKey));
    console.log('隔离:', s.dataIsolationEnabled, s.dataIsolationCode);
}

// 2. 检查最新楼层的数据
const ctx = SillyTavern.getContext();
for (let i = ctx.chat.length - 1; i >= Math.max(0, ctx.chat.length - 10); i--) {
    if (ctx.chat[i].TavernDB_ACU_IsolatedData) {
        console.log(`楼层${i}:`, Object.keys(ctx.chat[i].TavernDB_ACU_IsolatedData));
    }
}
```

### 诊断"未记录楼层不更新"问题

```javascript
// 检查指定楼层的 updateGroupKeys
[180, 182, 184, 186, 188, 190].forEach(idx => {
    const ctx = SillyTavern.getContext();
    const msg = ctx.chat[idx];
    if (msg?.TavernDB_ACU_IsolatedData) {
        const tag = Object.keys(msg.TavernDB_ACU_IsolatedData)[0];
        const data = msg.TavernDB_ACU_IsolatedData[tag];
        console.log(`${idx}: updateGroupKeys=${data.updateGroupKeys?.length || 0}, modifiedKeys=${data.modifiedKeys?.length || 0}`);
    }
});
