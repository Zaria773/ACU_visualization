---
description: 当需要让 ACU 脚本支持同层界面全屏时使用
alwaysApply: false
---

# 同层界面全屏支持

当用户在使用同层流式楼层界面（如 Galgame 对话界面）时，可能会触发全屏模式。此时 ACU 可视化表格需要跟随迁移到全屏元素内，否则会被遮挡。

## 三种全屏场景

| 全屏方式 | ACU 默认行为 | 解决方案 |
|---------|-------------|---------|
| **CSS 全屏** (`position: fixed`) | ✅ 可见 | ACU 本身就在父窗口，只需确保 z-index 够高 |
| **浏览器全屏** (`requestFullscreen()`) | ❌ 被遮挡 | 将 ACU wrapper 迁移到全屏元素内 |
| **同层 iframe 内全屏** | ❌ 被遮挡 | 跨 iframe 插入 DOM + 复制样式 |

## 实现方案

### 1. ACU 侧 - useFullscreenSupport composable

已创建 `src/可视化表格/composables/useFullscreenSupport.ts`，核心逻辑：

```typescript
// 检测全屏元素（主页面或 iframe 内）
function detectFullscreenElement(): { doc: Document; element: Element | null } {
  const parentDoc = window.parent?.document || document;

  // 1. 检查主页面全屏
  if (parentDoc.fullscreenElement) {
    return { doc: parentDoc, element: parentDoc.fullscreenElement };
  }

  // 2. 检查所有流式 iframe
  const iframes = parentDoc.querySelectorAll('.mes_streaming iframe');
  for (const iframe of iframes) {
    const iframeDoc = (iframe as HTMLIFrameElement).contentDocument;
    if (iframeDoc?.fullscreenElement) {
      return { doc: iframeDoc, element: iframeDoc.fullscreenElement };
    }
  }

  return { doc: parentDoc, element: null };
}

// 迁移 ACU 到全屏元素
function migrateToFullscreen(fullscreenElement: Element, targetDoc: Document) {
  const wrapper = getACUWrapper();

  // 如果在 iframe 内，先注入样式
  if (targetDoc !== window.parent.document) {
    teleportStyle(targetDoc.head);
  }

  // 迁移 DOM
  fullscreenElement.appendChild(wrapper);
  wrapper.style.zIndex = '2147483647';
}
```

### 2. 同层界面侧 - 暴露挂载点（可选）

如果同层界面希望主动支持 ACU，可以在 iframe 加载时暴露 API：

```typescript
// 在同层界面的入口文件中
window.getACUMountPoint = () => document.body;
window.isFullscreen = () => !!document.fullscreenElement;
```

### 3. 在 App.vue 中启用

```typescript
// 在 App.vue 的 <script setup> 中
import { useFullscreenSupport } from './composables/useFullscreenSupport';

// 启用全屏支持（会自动在 onMounted 初始化）
useFullscreenSupport();
```

## 注意事项

1. **同源限制**：跨 iframe 操作需要同源，酒馆所有脚本通常都是同源的
2. **样式复制**：迁移到 iframe 内时需要 `teleportStyle()` 复制样式
3. **z-index**：全屏内的 ACU 需要最高 z-index (`2147483647`)
4. **恢复**：退出全屏时必须将 ACU 恢复到原位置

## 相关文件

- `src/可视化表格/composables/useFullscreenSupport.ts` - 全屏支持 composable
- `util/streaming.ts` - 流式楼层界面框架（模板文件，不修改）
