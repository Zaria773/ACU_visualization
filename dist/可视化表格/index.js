import{createPinia as e,defineStore as t,storeToRefs as a}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import{klona as o}from'https://testingcf.jsdelivr.net/npm/klona/+esm';import{v4 as n}from'https://testingcf.jsdelivr.net/npm/uuid/+esm';import{default as r}from'https://testingcf.jsdelivr.net/npm/cytoscape/+esm';import{default as l}from'https://testingcf.jsdelivr.net/npm/cytoscape-cola/+esm';import{default as i}from'https://testingcf.jsdelivr.net/npm/cytoscape-fcose/+esm';import{default as c}from'https://testingcf.jsdelivr.net/npm/cytoscape-node-html-label/+esm';var s={15(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'.acu-word-pool-search[data-v-385b48d1]{width:100%;padding:8px 12px;border-radius:var(--acu-radius-md);border:1px solid var(--acu-border);background:var(--acu-input-bg);color:var(--acu-text-main);font-size:13px}.acu-word-pool-search[data-v-385b48d1]:focus{border-color:var(--acu-title-color);outline:none}.acu-edit-textarea[data-v-385b48d1]{width:100%;padding:8px;border-radius:var(--acu-radius-md);border:1px solid var(--acu-border);background:var(--acu-input-bg);color:var(--acu-text-main);resize:vertical;font-family:inherit;font-size:13px}.acu-edit-textarea[data-v-385b48d1]:focus{border-color:var(--acu-title-color);outline:none}.acu-word-pool-item[data-v-385b48d1]:last-child{border-bottom:none !important}','',{version:3,sources:['webpack://./src/可视化表格/components/settings/divination/WordPoolPanel.vue'],names:[],mappings:'AAEA,uCACE,UAAA,CACA,gBAAA,CACA,kCAAA,CACA,kCAAA,CACA,8BAAA,CACA,0BAAA,CACA,cAAA,CAEA,6CACE,mCAAA,CACA,YAAA,CAIJ,oCACE,UAAA,CACA,WAAA,CACA,kCAAA,CACA,kCAAA,CACA,8BAAA,CACA,0BAAA,CACA,eAAA,CACA,mBAAA,CACA,cAAA,CAEA,0CACE,mCAAA,CACA,YAAA,CAIJ,gDACE,6BAAA',sourcesContent:['\n// 样式使用全局类，这里只写少量特定的\n.acu-word-pool-search {\n  width: 100%;\n  padding: 8px 12px;\n  border-radius: var(--acu-radius-md);\n  border: 1px solid var(--acu-border);\n  background: var(--acu-input-bg);\n  color: var(--acu-text-main);\n  font-size: 13px;\n\n  &:focus {\n    border-color: var(--acu-title-color);\n    outline: none;\n  }\n}\n\n.acu-edit-textarea {\n  width: 100%;\n  padding: 8px;\n  border-radius: var(--acu-radius-md);\n  border: 1px solid var(--acu-border);\n  background: var(--acu-input-bg);\n  color: var(--acu-text-main);\n  resize: vertical;\n  font-family: inherit;\n  font-size: 13px;\n\n  &:focus {\n    border-color: var(--acu-title-color);\n    outline: none;\n  }\n}\n\n.acu-word-pool-item:last-child {\n  border-bottom: none !important;\n}\n'],sourceRoot:''}]);const i=l},16(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},23(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'\n','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},61(e){e.exports=Vue},80(e){e.exports=function(e){var t=e[1],a=e[3];if(!a)return t;if('function'==typeof btoa){var o=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),n='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(o),r='/*# '.concat(n,' */');return[t].concat([r]).join('\n')}return[t].join('\n')}},149(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},157(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},162(e,t,a){a.d(t,{d:()=>d,toast:()=>p});var o=a(61);const n=(0,o.ref)({visible:!1,message:'',type:'info',timer:null});function r(e,t='info',a=3e3){n.value.timer&&clearTimeout(n.value.timer),n.value.visible=!0,n.value.message=e,n.value.type=t,n.value.timer=setTimeout(()=>{n.value.visible=!1,n.value.timer=null},a)}function l(){n.value.timer&&clearTimeout(n.value.timer),n.value.visible=!1,n.value.timer=null}function i(e,t=3e3){r(e,'success',t)}function c(e,t=4e3){r(e,'error',t)}function s(e,t=3500){r(e,'warning',t)}function u(e,t=3e3){r(e,'info',t)}function d(){return{state:n,show:r,hide:l,success:i,error:c,warning:s,info:u}}const p={show:r,hide:l,success:i,error:c,warning:s,info:u}},167(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},186(e,t,a){var o=a(16);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('2e7b5b75',o,!1,{ssrId:!0})},285(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},311(e,t,a){var o=a(157);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('7d0279aa',o,!1,{ssrId:!0})},315(e,t,a){var o=a(342);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('4d8a6f58',o,!1,{ssrId:!0})},342(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'\n','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},365(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},372(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'\n','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},390(e,t,a){var o=a(929);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('2ae638b2',o,!1,{ssrId:!0})},424(e,t,a){function o(e,t){for(var a=[],o={},n=0;n<t.length;n++){var r=t[n],l=r[0],i={id:e+':'+n,css:r[1],media:r[2],sourceMap:r[3]};o[l]?o[l].parts.push(i):a.push(o[l]={id:l,parts:[i]})}return a}a.d(t,{A:()=>f});var n='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!n)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var r={},l=n&&(document.head||document.getElementsByTagName('head')[0]),i=null,c=0,s=!1,u=function(){},d=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,a,n){s=a,d=n||{};var l=o(e,t);return g(l),function(t){for(var a=[],n=0;n<l.length;n++){var i=l[n];(c=r[i.id]).refs--,a.push(c)}t?g(l=o(e,t)):l=[];for(n=0;n<a.length;n++){var c;if(0===(c=a[n]).refs){for(var s=0;s<c.parts.length;s++)c.parts[s]();delete r[c.id]}}}}function g(e){for(var t=0;t<e.length;t++){var a=e[t],o=r[a.id];if(o){o.refs++;for(var n=0;n<o.parts.length;n++)o.parts[n](a.parts[n]);for(;n<a.parts.length;n++)o.parts.push(b(a.parts[n]));o.parts.length>a.parts.length&&(o.parts.length=a.parts.length)}else{var l=[];for(n=0;n<a.parts.length;n++)l.push(b(a.parts[n]));r[a.id]={id:a.id,refs:1,parts:l}}}}function v(){var e=document.createElement('style');return e.type='text/css',l.appendChild(e),e}function b(e){var t,a,o=document.querySelector('style['+p+'~="'+e.id+'"]');if(o){if(s)return u;o.parentNode.removeChild(o)}if(m){var n=c++;o=i||(i=v()),t=y.bind(null,o,n,!1),a=y.bind(null,o,n,!0)}else o=v(),t=w.bind(null,o),a=function(){o.parentNode.removeChild(o)};return t(e),function(o){if(o){if(o.css===e.css&&o.media===e.media&&o.sourceMap===e.sourceMap)return;t(e=o)}else a()}}var h,x=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join('\n')});function y(e,t,a,o){var n=a?'':o.css;if(e.styleSheet)e.styleSheet.cssText=x(t,n);else{var r=document.createTextNode(n),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(r,l[t]):e.appendChild(r)}}function w(e,t){var a=t.css,o=t.media,n=t.sourceMap;if(o&&e.setAttribute('media',o),d.ssrId&&e.setAttribute(p,t.id),n&&(a+='\n/*# sourceURL='+n.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},426(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'.template-settings-group[data-v-5337b804]{padding:12px;display:flex;flex-direction:column;gap:12px}.template-shortcuts-row[data-v-5337b804]{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.template-shortcuts-row .hint[data-v-5337b804]{font-size:12px;color:var(--acu-text-sub)}.acu-wildcard-btn[data-v-5337b804]{background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:4px;padding:2px 6px;cursor:pointer;font-size:12px;color:var(--acu-title-color);transition:all 0.2s}.acu-wildcard-btn[data-v-5337b804]:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-wildcard-btn code[data-v-5337b804]{font-family:monospace}.template-textarea[data-v-5337b804]{min-height:120px;resize:vertical;line-height:1.5;font-family:monospace;width:100%;pointer-events:auto !important}.acu-wildcard-help[data-v-5337b804]{background:rgba(0,0,0,0.05);border-radius:8px;padding:8px 12px}.acu-help-header[data-v-5337b804]{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--acu-text-sub);-webkit-user-select:none;user-select:none}.acu-help-header strong[data-v-5337b804]{flex:1}.acu-wildcard-help ul[data-v-5337b804]{margin:8px 0 0 0;padding-left:20px;list-style-type:disc;font-size:12px;color:var(--acu-text-sub)}.acu-wildcard-help li[data-v-5337b804]{margin-bottom:4px}.acu-wildcard-help code[data-v-5337b804]{background:rgba(0,0,0,0.1);padding:0 4px;border-radius:3px;font-family:monospace;color:var(--acu-text-main)}\n','',{version:3,sources:['webpack://./src/可视化表格/components/settings/divination/DimensionManagerPanel.vue'],names:[],mappings:'AA8bA,0CACE,YAAa,CACb,YAAa,CACb,qBAAsB,CACtB,QACF,CAEA,yCACE,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,cACF,CAEA,+CACE,cAAe,CACf,yBACF,CAEA,mCACE,8BAA+B,CAC/B,kCAAmC,CACnC,iBAAkB,CAClB,eAAgB,CAChB,cAAe,CACf,cAAe,CACf,4BAA6B,CAC7B,mBACF,CAEA,yCACE,+BAAgC,CAChC,mCACF,CAEA,wCACE,qBACF,CAEA,oCACE,gBAAiB,CACjB,eAAgB,CAChB,eAAgB,CAChB,qBAAsB,CACtB,UAAW,CACX,8BACF,CAEA,oCACE,2BAA+B,CAC/B,iBAAkB,CAClB,gBACF,CAEA,kCACE,YAAa,CACb,kBAAmB,CACnB,OAAQ,CACR,cAAe,CACf,cAAe,CACf,yBAA0B,CAC1B,wBAAiB,CAAjB,gBACF,CAEA,yCACE,MACF,CAEA,uCACE,gBAAiB,CACjB,iBAAkB,CAClB,oBAAqB,CACrB,cAAe,CACf,yBACF,CAEA,uCACE,iBACF,CAEA,yCACE,0BAA8B,CAC9B,aAAc,CACd,iBAAkB,CAClB,qBAAsB,CACtB,0BACF',sourcesContent:['<template>\n  <div class="acu-dimension-manager">\n    \x3c!-- 预设管理头部 --\x3e\n    <PresetManagerHeader\n      :presets="divinationStore.presets"\n      :active-preset-id="divinationStore.activePresetId"\n      title="维度预设"\n      hint="保存和加载维度配置"\n      @select="handleSelectPreset"\n      @restore-default="handleRestoreDefault"\n      @delete="handleDeletePreset"\n      @save="handleQuickSave"\n      @save-as="openSaveDialog"\n    />\n\n    \x3c!-- 维度列表 --\x3e\n    <div\n      v-for="(dim, dimIndex) in divinationStore.config.dimensions"\n      :key="dim.id"\n      class="acu-settings-section dimension-container"\n      :class="{ \'is-collapsed\': collapsedDimensions[dim.id] }"\n    >\n      \x3c!-- 维度标题行 --\x3e\n      <div class="acu-settings-title dimension-header" @click="toggleCollapse(dim.id)">\n        <div class="header-left">\n          <i class="fas fa-chevron-right collapse-icon" :class="{ \'is-expanded\': !collapsedDimensions[dim.id] }"></i>\n          <input v-model="dim.name" class="acu-input-minimal dimension-name-input" placeholder="维度名称" @click.stop />\n        </div>\n        <div class="header-right">\n          <label class="acu-switch" @click.stop>\n            <input v-model="dim.enabled" type="checkbox" />\n            <span class="slider"></span>\n          </label>\n          <button\n            class="acu-icon-btn danger"\n            :disabled="dim.id === \'luck\'"\n            :title="dim.id === \'luck\' ? \'运势维度不可删除\' : \'删除维度\'"\n            @click.stop="handleRemoveDimension(dimIndex)"\n          >\n            <i class="fas fa-trash"></i>\n          </button>\n        </div>\n      </div>\n\n      \x3c!-- 档位列表 (展开区域) --\x3e\n      <div v-show="!collapsedDimensions[dim.id]" class="dimension-content">\n        <div class="tier-list">\n          <div v-for="(tier, tierIndex) in dim.tiers" :key="tier.id" class="tier-item">\n            \x3c!-- 第一行: 基本信息 --\x3e\n            <div class="tier-row basic-info">\n              <div class="tier-name-wrapper">\n                <input v-model="tier.name" class="acu-input-minimal tier-name-input" placeholder="档位名称" />\n                \x3c!-- 颜色选择器 (仅运势维度显示) --\x3e\n                <input\n                  v-if="dim.id === \'luck\'"\n                  v-model="tier.color"\n                  type="color"\n                  class="acu-color-picker-mini"\n                  title="档位颜色"\n                />\n              </div>\n              <button class="acu-icon-btn small danger" title="删除档位" @click="removeTier(dimIndex, tierIndex)">\n                <i class="fas fa-times"></i>\n              </button>\n            </div>\n\n            \x3c!-- 第二行: 权重调节 --\x3e\n            <div class="tier-row weight-control">\n              <span class="label">权重</span>\n              <input v-model.number="tier.weight" type="range" min="0" max="100" step="1" class="acu-range-input" />\n              <span class="acu-badge">{{ tier.weight }}</span>\n            </div>\n\n            \x3c!-- 第三行: 提示词 --\x3e\n            <div class="tier-row prompt-editor">\n              <textarea\n                v-model="tier.prompt"\n                class="acu-edit-textarea compact"\n                placeholder="在此输入该档位的提示词..."\n                rows="2"\n              ></textarea>\n            </div>\n          </div>\n        </div>\n\n        \x3c!-- 添加档位按钮 --\x3e\n        <button class="acu-btn-dashed full-width" @click="addTier(dimIndex)">\n          <i class="fas fa-plus"></i> 添加新档位\n        </button>\n      </div>\n    </div>\n\n    \x3c!-- 新建维度按钮 --\x3e\n    <button class="acu-btn-dashed full-width add-dimension-btn" @click="handleAddDimension">\n      <i class="fas fa-layer-group"></i> 新建维度\n    </button>\n\n    \x3c!-- 高级设置：自定义模板 --\x3e\n    <div class="acu-settings-section advanced-settings">\n      <div class="acu-settings-title">\n        <div class="header-left">\n          <i class="fas fa-file-alt"></i>\n          提示词模板\n        </div>\n      </div>\n      <div class="acu-settings-group template-settings-group">\n        \x3c!-- 1. 快捷按钮行 --\x3e\n        <div class="template-shortcuts-row">\n          <span class="hint">快捷插入:</span>\n          <button class="acu-wildcard-btn" @click="insertTemplatePlaceholder(\'{{luck}}\')">\n            <code>{{ \'\\{\\{luck\\}\\}\' }}</code>\n          </button>\n          <button class="acu-wildcard-btn" @click="insertTemplatePlaceholder(\'{{words}}\')">\n            <code>{{ \'\\{\\{words\\}\\}\' }}</code>\n          </button>\n          <button class="acu-wildcard-btn" @click="insertTemplatePlaceholder(\'{{dimensions}}\')">\n            <code>{{ \'\\{\\{dimensions\\}\\}\' }}</code>\n          </button>\n        </div>\n\n        \x3c!-- 2. 文本框行 --\x3e\n        <div class="template-editor-row">\n          <textarea\n            ref="templateInputRef"\n            v-model="divinationStore.config.customTemplate"\n            class="acu-edit-textarea template-textarea"\n            placeholder="在此输入自定义模板..."\n            rows="6"\n          ></textarea>\n        </div>\n\n        \x3c!-- 3. 说明行 --\x3e\n        <div class="template-help-row">\n          <div class="acu-wildcard-help">\n            <div class="acu-help-header" @click="toggleHelp">\n              <i class="fas fa-lightbulb"></i>\n              <strong>通配符说明</strong>\n              <i class="fas" :class="showHelp ? \'fa-chevron-up\' : \'fa-chevron-down\'"></i>\n            </div>\n            <ul v-show="showHelp">\n              <li>\n                <code>{{ \'\\{\\{luck\\}\\}\' }}</code> - 运势结果（如：大吉...）\n              </li>\n              <li>\n                <code>{{ \'\\{\\{words\\}\\}\' }}</code> - 随机词列表（如：苹果、香蕉）\n              </li>\n              <li>\n                <code>{{ \'\\{\\{dimensions\\}\\}\' }}</code> - 其他维度结果拼接\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- 导入/导出操作 (移至底部以适应移动端布局) --\x3e\n    <div class="acu-settings-section">\n      <div class="acu-settings-title">\n        <i class="fas fa-exchange-alt"></i>\n        数据管理\n      </div>\n      <div class="acu-settings-group">\n        <div class="acu-settings-row column">\n          <div class="acu-settings-label">\n            预设数据\n            <span class="hint">导入或导出维度预设</span>\n          </div>\n          <div class="acu-settings-control" style="justify-content: flex-end; flex-wrap: wrap">\n            <button class="acu-tool-btn" title="导出当前预设" @click.stop="handleExportCurrentPreset">\n              <i class="fas fa-file-export"></i> 导出当前\n            </button>\n            <button class="acu-tool-btn" title="备份所有预设" @click.stop="handleExportPresets">\n              <i class="fas fa-archive"></i> 备份所有\n            </button>\n            <button class="acu-tool-btn" title="导入预设" @click.stop="triggerImport">\n              <i class="fas fa-upload"></i> 导入\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- 隐藏的文件输入 --\x3e\n    <input ref="fileInputRef" type="file" accept=".json" style="display: none" @change="handleImportPresets" />\n  </div>\n</template>\n\n<script setup lang="ts">\nimport { useTextareaAutosize } from \'@vueuse/core\';\nimport { v4 as uuidv4 } from \'uuid\';\nimport { onMounted, ref, toRef } from \'vue\';\nimport { TEMPLATE_WITH_DIMENSIONS } from \'../../../composables/usePromptBuild\';\nimport { useToast } from \'../../../composables/useToast\';\nimport { useDivinationStore } from \'../../../stores/useDivinationStore\';\nimport { useUIStore } from \'../../../stores/useUIStore\';\nimport type { Dimension, DimensionTier, DivinationPreset } from \'../../../types\';\nimport PresetManagerHeader from \'../PresetManagerHeader.vue\';\n\nconst divinationStore = useDivinationStore() as any;\nconst uiStore = useUIStore();\nconst toast = useToast();\n\n// 折叠状态管理\nconst collapsedDimensions = ref<Record<string, boolean>>({});\nconst fileInputRef = ref<HTMLInputElement | null>(null);\nconst templateInputRef = ref<HTMLTextAreaElement | null>(null);\nconst showHelp = ref(true);\n\n// 自动调整高度\nconst customTemplateRef = toRef(divinationStore.config, \'customTemplate\');\nuseTextareaAutosize({ element: templateInputRef, input: customTemplateRef });\n\nconst toggleHelp = () => {\n  showHelp.value = !showHelp.value;\n};\n\n// 初始化：如果自定义模板为空，填充默认模板\nonMounted(() => {\n  if (!divinationStore.config.customTemplate) {\n    divinationStore.config.customTemplate = TEMPLATE_WITH_DIMENSIONS;\n  }\n});\n\n// ============================================================\n// 预设管理\n// ============================================================\n\nfunction handleSelectPreset(id: string) {\n  divinationStore.applyPreset(id);\n  toast.success(\'已应用维度预设\');\n}\n\nfunction handleRestoreDefault() {\n  if (confirm(\'确定要恢复默认维度配置吗？当前未保存的修改将丢失。\')) {\n    divinationStore.restoreDefaultDimensions();\n    toast.success(\'已恢复默认维度配置\');\n  }\n}\n\nfunction handleDeletePreset(id: string) {\n  const preset = divinationStore.presets.find(p => p.id === id);\n  if (!preset) return;\n\n  if (confirm(`确定要删除预设「${preset.name}」吗？`)) {\n    divinationStore.deletePreset(id);\n    toast.info(\'预设已删除\');\n  }\n}\n\nfunction handleQuickSave() {\n  const activeId = divinationStore.activePresetId;\n  if (activeId) {\n    const preset = divinationStore.presets.find(p => p.id === activeId);\n    if (preset) {\n      divinationStore.saveCurrentToPreset(preset.name);\n      toast.success(`预设「${preset.name}」已更新`);\n      return;\n    }\n  }\n  // 如果没有激活的预设，则打开另存为对话框\n  openSaveDialog();\n}\n\nfunction openSaveDialog() {\n  uiStore.openPresetSaveDialog(\n    {\n      presetType: \'divination\', // 使用自定义类型或通用类型\n      summaryItems: [],\n      initialName: \'\',\n      checkDuplicate: (name: string) => divinationStore.presets.some(p => p.name === name),\n    },\n    {\n      onSave: (name: string) => {\n        divinationStore.saveCurrentToPreset(name);\n        toast.success(`预设「${name}」已保存`);\n      },\n    },\n  );\n}\n\n// 导出当前预设\nfunction handleExportCurrentPreset() {\n  const activeId = divinationStore.activePresetId;\n  if (!activeId) {\n    toast.warning(\'请先选择一个预设\');\n    return;\n  }\n  const preset = divinationStore.presets.find(p => p.id === activeId);\n  if (!preset) return;\n\n  const data = {\n    type: \'acu_divination_presets\',\n    version: \'1.0\',\n    timestamp: new Date().toISOString(),\n    presets: [preset], // 仅导出当前预设\n  };\n\n  downloadJson(data, `acu-preset-${preset.name}-${Date.now()}.json`);\n  toast.success(`预设「${preset.name}」已导出`);\n}\n\n// 备份所有预设\nfunction handleExportPresets() {\n  const data = {\n    type: \'acu_divination_presets\',\n    version: \'1.0\',\n    timestamp: new Date().toISOString(),\n    presets: divinationStore.presets,\n  };\n\n  downloadJson(data, `acu-divination-backup-${Date.now()}.json`);\n  toast.success(\'所有预设已备份\');\n}\n\nfunction downloadJson(data: any, filename: string) {\n  const blob = new Blob([JSON.stringify(data, null, 2)], { type: \'application/json\' });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement(\'a\');\n  a.href = url;\n  a.download = filename;\n  a.click();\n  URL.revokeObjectURL(url);\n}\n\n// 触发导入\nfunction triggerImport() {\n  fileInputRef.value?.click();\n}\n\n// 导入预设\nfunction handleImportPresets(event: Event) {\n  const file = (event.target as HTMLInputElement).files?.[0];\n  if (!file) return;\n\n  const reader = new FileReader();\n  reader.onload = e => {\n    try {\n      const content = e.target?.result as string;\n      const data = JSON.parse(content);\n\n      if (data.type === \'acu_divination_presets\' && Array.isArray(data.presets)) {\n        let importedCount = 0;\n        data.presets.forEach((importedPreset: DivinationPreset) => {\n          // 检查 ID 冲突，如果有冲突则重新生成 ID\n          const existing = divinationStore.presets.find(p => p.id === importedPreset.id);\n          if (existing) {\n            // 如果 ID 冲突但内容不同，或者只是想合并，这里简单处理为追加并重命名\n            // 实际策略可以是：覆盖、跳过或重命名。这里采用：如果 ID 相同则覆盖\n            const index = divinationStore.presets.findIndex(p => p.id === importedPreset.id);\n            divinationStore.presets[index] = importedPreset;\n          } else {\n            divinationStore.presets.push(importedPreset);\n          }\n          importedCount++;\n        });\n\n        // 强制保存一次\n        divinationStore.saveConfig();\n        toast.success(`成功导入 ${importedCount} 个预设`);\n      } else {\n        toast.error(\'无效的预设文件格式\');\n      }\n    } catch (err) {\n      console.error(\'导入失败:\', err);\n      toast.error(\'导入失败：文件格式错误\');\n    }\n  };\n  reader.readAsText(file);\n  // 重置 input\n  (event.target as HTMLInputElement).value = \'\';\n}\n\n// 切换折叠\nconst toggleCollapse = (id: string) => {\n  collapsedDimensions.value[id] = !collapsedDimensions.value[id];\n};\n\n// 添加新维度\nconst handleAddDimension = () => {\n  const newDim: Dimension = {\n    id: uuidv4(),\n    name: \'新维度\',\n    enabled: true,\n    tiers: [\n      {\n        id: uuidv4(),\n        name: \'默认档位\',\n        weight: 50,\n        prompt: \'\',\n      },\n    ],\n  };\n  divinationStore.addDimension(newDim);\n  // 自动展开新维度\n  collapsedDimensions.value[newDim.id] = false;\n};\n\n// 删除维度\nconst handleRemoveDimension = (index: any) => {\n  if (confirm(\'确定要删除这个维度吗？此操作不可撤销。\')) {\n    divinationStore.removeDimension(index);\n  }\n};\n\n// 添加档位\nconst addTier = (dimIndex: any) => {\n  const newTier: DimensionTier = {\n    id: uuidv4(),\n    name: \'新档位\',\n    weight: 10,\n    prompt: \'\',\n    color: \'#808080\',\n  };\n  divinationStore.config.dimensions[dimIndex].tiers.push(newTier);\n};\n\n// 删除档位\nconst removeTier = (dimIndex: any, tierIndex: any) => {\n  divinationStore.config.dimensions[dimIndex].tiers.splice(tierIndex, 1);\n};\n\n// 插入模板占位符 (追加到末尾)\nconst insertTemplatePlaceholder = (placeholder: string) => {\n  const current = divinationStore.config.customTemplate || \'\';\n  divinationStore.config.customTemplate = current + placeholder;\n\n  // 滚动到底部并聚焦\n  const textarea = templateInputRef.value;\n  if (textarea) {\n    setTimeout(() => {\n      textarea.focus();\n      textarea.scrollTop = textarea.scrollHeight;\n      // 移动光标到末尾\n      const len = divinationStore.config.customTemplate.length;\n      textarea.setSelectionRange(len, len);\n    }, 0);\n  }\n};\n<\/script>\n\n<style scoped>\n/*\n  注意：由于样式隔离限制，主要样式应写在 src/可视化表格/styles/components/settings-panel.scss\n  或 src/可视化表格/styles/components/divination-settings.scss 中。\n  这里只保留极少量无法提取的样式或临时样式。\n*/\n.template-settings-group {\n  padding: 12px;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n.template-shortcuts-row {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  flex-wrap: wrap;\n}\n\n.template-shortcuts-row .hint {\n  font-size: 12px;\n  color: var(--acu-text-sub);\n}\n\n.acu-wildcard-btn {\n  background: var(--acu-bg-panel);\n  border: 1px solid var(--acu-border);\n  border-radius: 4px;\n  padding: 2px 6px;\n  cursor: pointer;\n  font-size: 12px;\n  color: var(--acu-title-color);\n  transition: all 0.2s;\n}\n\n.acu-wildcard-btn:hover {\n  background: var(--acu-btn-hover);\n  border-color: var(--acu-title-color);\n}\n\n.acu-wildcard-btn code {\n  font-family: monospace;\n}\n\n.template-textarea {\n  min-height: 120px;\n  resize: vertical;\n  line-height: 1.5;\n  font-family: monospace;\n  width: 100%;\n  pointer-events: auto !important; /* 强制可点击 */\n}\n\n.acu-wildcard-help {\n  background: rgba(0, 0, 0, 0.05);\n  border-radius: 8px;\n  padding: 8px 12px;\n}\n\n.acu-help-header {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  cursor: pointer;\n  font-size: 12px;\n  color: var(--acu-text-sub);\n  user-select: none;\n}\n\n.acu-help-header strong {\n  flex: 1;\n}\n\n.acu-wildcard-help ul {\n  margin: 8px 0 0 0;\n  padding-left: 20px;\n  list-style-type: disc;\n  font-size: 12px;\n  color: var(--acu-text-sub);\n}\n\n.acu-wildcard-help li {\n  margin-bottom: 4px;\n}\n\n.acu-wildcard-help code {\n  background: rgba(0, 0, 0, 0.1);\n  padding: 0 4px;\n  border-radius: 3px;\n  font-family: monospace;\n  color: var(--acu-text-main);\n}\n</style>\n'],sourceRoot:''}]);const i=l},465(e){e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',o=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),o&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),o&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,o,n,r){'string'==typeof e&&(e=[[null,e,void 0]]);var l={};if(o)for(var i=0;i<this.length;i++){var c=this[i][0];null!=c&&(l[c]=!0)}for(var s=0;s<e.length;s++){var u=[].concat(e[s]);o&&l[u[0]]||(void 0!==r&&(void 0===u[5]||(u[1]='@layer'.concat(u[5].length>0?' '.concat(u[5]):'',' {').concat(u[1],'}')),u[5]=r),a&&(u[2]?(u[1]='@media '.concat(u[2],' {').concat(u[1],'}'),u[2]=a):u[2]=a),n&&(u[4]?(u[1]='@supports ('.concat(u[4],') {').concat(u[1],'}'),u[4]=n):u[4]=''.concat(n)),t.push(u))}},t}},503(e,t,a){var o=a(149);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('1d8c4adf',o,!1,{ssrId:!0})},523(e,t,a){var o=a(625);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('029a7e6d',o,!1,{ssrId:!0})},564(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},590(e,t,a){var o=a(988);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('ce24e6b6',o,!1,{ssrId:!0})},625(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},651(e,t,a){var o=a(365);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('1e8020cb',o,!1,{ssrId:!0})},717(e,t,a){var o=a(372);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('5e1fe17a',o,!1,{ssrId:!0})},732(e,t,a){var o=a(23);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('13187087',o,!1,{ssrId:!0})},778(e,t,a){var o=a(564);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('d442c36e',o,!1,{ssrId:!0})},833(e,t,a){var o=a(167);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('6bab70d1',o,!1,{ssrId:!0})},929(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'\n','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l},931(e,t,a){var o=a(285);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('03f12ab2',o,!1,{ssrId:!0})},946(e,t){t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,o]of t)a[e]=o;return a}},961(e,t,a){var o=a(15);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('2ec3ac55',o,!1,{ssrId:!0})},977(e,t,a){var o=a(426);o.__esModule&&(o=o.default),'string'==typeof o&&(o=[[e.id,o,'']]),o.locals&&(e.exports=o.locals);(0,a(424).A)('2fa8d092',o,!1,{ssrId:!0})},988(e,t,a){a.r(t),a.d(t,{default:()=>i});var o=a(80),n=a.n(o),r=a(465),l=a.n(r)()(n());l.push([e.id,'','',{version:3,sources:[],names:[],mappings:'',sourceRoot:''}]);const i=l}},u={};function d(e){var t=u[e];if(void 0!==t)return t.exports;var a=u[e]={id:e,exports:{}};return s[e](a,a.exports,d),a.exports}d.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return d.d(t,{a:t}),t},d.d=(e,t)=>{for(var a in t)d.o(t,a)&&!d.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),d.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};var p=d(61);function m(e){return!!(0,p.getCurrentScope)()&&((0,p.onScopeDispose)(e),!0)}const f='undefined'!=typeof window&&'undefined'!=typeof document,g=('undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope),Object.prototype.toString),v=e=>'[object Object]'===g.call(e),b=()=>{},h=x();function x(){var e,t;return f&&(null==(e=null==window?void 0:window.navigator)?void 0:e.userAgent)&&(/iP(?:ad|hone|od)/.test(window.navigator.userAgent)||(null==(t=null==window?void 0:window.navigator)?void 0:t.maxTouchPoints)>2&&/iPad|Macintosh/.test(null==window?void 0:window.navigator.userAgent))}function y(...e){if(1!==e.length)return(0,p.toRef)(...e);const t=e[0];return'function'==typeof t?(0,p.readonly)((0,p.customRef)(()=>({get:t,set:b}))):(0,p.ref)(t)}function w(e,t){return function(...a){return new Promise((o,n)=>{Promise.resolve(e(()=>t.apply(this,a),{fn:t,thisArg:this,args:a})).then(o).catch(n)})}}const k=e=>e();function C(e,t={}){let a,o,n=b;const r=e=>{clearTimeout(e),n(),n=b};let l;return i=>{const c=(0,p.toValue)(e),s=(0,p.toValue)(t.maxWait);return a&&r(a),c<=0||void 0!==s&&s<=0?(o&&(r(o),o=void 0),Promise.resolve(i())):new Promise((e,u)=>{n=t.rejectOnCancel?u:e,l=i,s&&!o&&(o=setTimeout(()=>{a&&r(a),o=void 0,e(l())},s)),a=setTimeout(()=>{o&&r(o),o=void 0,e(i())},c)})}}function N(e){return Array.isArray(e)?e:[e]}function V(e){const t=Object.create(null);return a=>t[a]||(t[a]=e(a))}const E=/\B([A-Z])/g,B=(V(e=>e.replace(E,'-$1').toLowerCase()),/-(\w)/g);V(e=>e.replace(B,(_,e)=>e?e.toUpperCase():''));function S(e){return e||(0,p.getCurrentInstance)()}function T(e,t=200,a={}){return w(C(t,a),e)}function D(e,t,a={}){const{eventFilter:o=k,...n}=a;return(0,p.watch)(e,w(o,t),n)}function A(e,t,a={}){const{eventFilter:o,initialState:n='active',...r}=a,{eventFilter:l,pause:i,resume:c,isActive:s}=function(e=k,t={}){const{initialState:a='active'}=t,o=y('active'===a);return{isActive:(0,p.readonly)(o),pause:function(){o.value=!1},resume:function(){o.value=!0},eventFilter:(...t)=>{o.value&&e(...t)}}}(o,{initialState:n});return{stop:D(e,t,{...r,eventFilter:l}),pause:i,resume:c,isActive:s}}function I(e,t={}){if(!(0,p.isRef)(e))return(0,p.toRefs)(e);const a=Array.isArray(e.value)?Array.from({length:e.value.length}):{};for(const o in e.value)a[o]=(0,p.customRef)(()=>({get:()=>e.value[o],set(a){var n;if(null==(n=(0,p.toValue)(t.replaceRef))||n)if(Array.isArray(e.value)){const t=[...e.value];t[o]=a,e.value=t}else{const t={...e.value,[o]:a};Object.setPrototypeOf(t,Object.getPrototypeOf(e.value)),e.value=t}else e.value[o]=a}}));return a}function U(e,t=!0,a){S(a)?(0,p.onMounted)(e,a):t?e():(0,p.nextTick)(e)}function M(e,t,a={}){const{immediate:o=!0,immediateCallback:n=!1}=a,r=(0,p.shallowRef)(!1);let l;function i(){l&&(clearTimeout(l),l=void 0)}function c(){r.value=!1,i()}function s(...a){n&&e(),i(),r.value=!0,l=setTimeout(()=>{r.value=!1,l=void 0,e(...a)},(0,p.toValue)(t))}return o&&(r.value=!0,f&&s()),m(c),{isPending:(0,p.shallowReadonly)(r),start:s,stop:c}}const L=f?window:void 0,P=(f&&window.document,f?window.navigator:void 0);f&&window.location;function F(e){var t;const a=(0,p.toValue)(e);return null!=(t=null==a?void 0:a.$el)?t:a}function j(...e){const t=[],a=()=>{t.forEach(e=>e()),t.length=0},o=(0,p.computed)(()=>{const t=N((0,p.toValue)(e[0])).filter(e=>null!=e);return t.every(e=>'string'!=typeof e)?t:void 0}),n=(r=()=>{var t,a;return[null!=(a=null==(t=o.value)?void 0:t.map(e=>F(e)))?a:[L].filter(e=>null!=e),N((0,p.toValue)(o.value?e[1]:e[0])),N((0,p.unref)(o.value?e[2]:e[1])),(0,p.toValue)(o.value?e[3]:e[2])]},l=([e,o,n,r])=>{if(a(),!(null==e?void 0:e.length)||!(null==o?void 0:o.length)||!(null==n?void 0:n.length))return;const l=v(r)?{...r}:r;t.push(...e.flatMap(e=>o.flatMap(t=>n.map(a=>((e,t,a,o)=>(e.addEventListener(t,a,o),()=>e.removeEventListener(t,a,o)))(e,t,a,l)))))},i={flush:'post'},(0,p.watch)(r,l,{...i,immediate:!0}));var r,l,i;return m(a),()=>{n(),a()}}let R=!1;function O(e,t,a={}){const{window:o=L,ignore:n=[],capture:r=!0,detectIframe:l=!1,controls:i=!1}=a;if(!o)return i?{stop:b,cancel:b,trigger:b}:b;if(h&&!R){R=!0;const e={passive:!0};Array.from(o.document.body.children).forEach(t=>t.addEventListener('click',b,e)),o.document.documentElement.addEventListener('click',b,e)}let c=!0;const s=e=>(0,p.toValue)(n).some(t=>{if('string'==typeof t)return Array.from(o.document.querySelectorAll(t)).some(t=>t===e.target||e.composedPath().includes(t));{const a=F(t);return a&&(e.target===a||e.composedPath().includes(a))}});const u=a=>{const o=F(e);null!=a.target&&(o instanceof Element||!function(e){const t=(0,p.toValue)(e);return t&&16===t.$.subTree.shapeFlag}(e)||!function(e,t){const a=(0,p.toValue)(e),o=a.$.subTree&&a.$.subTree.children;return!(null==o||!Array.isArray(o))&&o.some(e=>e.el===t.target||t.composedPath().includes(e.el))}(e,a))&&o&&o!==a.target&&!a.composedPath().includes(o)&&('detail'in a&&0===a.detail&&(c=!s(a)),c?t(a):c=!0)};let d=!1;const m=[j(o,'click',e=>{d||(d=!0,setTimeout(()=>{d=!1},0),u(e))},{passive:!0,capture:r}),j(o,'pointerdown',t=>{const a=F(e);c=!s(t)&&!(!a||t.composedPath().includes(a))},{passive:!0}),l&&j(o,'blur',a=>{setTimeout(()=>{var n;const r=F(e);'IFRAME'!==(null==(n=o.document.activeElement)?void 0:n.tagName)||(null==r?void 0:r.contains(o.document.activeElement))||t(a)},0)},{passive:!0})].filter(Boolean),f=()=>m.forEach(e=>e());return i?{stop:f,cancel:()=>{c=!1},trigger:e=>{c=!0,u(e),c=!1}}:f}function H(e){const t=function(){const e=(0,p.shallowRef)(!1),t=(0,p.getCurrentInstance)();return t&&(0,p.onMounted)(()=>{e.value=!0},t),e}();return(0,p.computed)(()=>(t.value,Boolean(e())))}Symbol('vueuse-ssr-width');function W(e,t={}){const{controls:a=!1,navigator:o=P}=t,n=H(()=>o&&'permissions'in o),r=(0,p.shallowRef)(),l='string'==typeof e?{name:e}:e,i=(0,p.shallowRef)(),c=()=>{var e,t;i.value=null!=(t=null==(e=r.value)?void 0:e.state)?t:'prompt'};j(r,'change',c,{passive:!0});const s=function(e){let t;function a(){return t||(t=e()),t}return a.reset=async()=>{const e=t;t=void 0,e&&await e},a}(async()=>{if(n.value){if(!r.value)try{r.value=await o.permissions.query(l)}catch(e){r.value=void 0}finally{c()}return a?(0,p.toRaw)(r.value):void 0}});return s(),a?{state:i,isSupported:n,query:s}:i}function G(e={}){const{navigator:t=P,read:a=!1,source:o,copiedDuring:n=1500,legacy:r=!1}=e,l=H(()=>t&&'clipboard'in t),i=W('clipboard-read'),c=W('clipboard-write'),s=(0,p.computed)(()=>l.value||r),u=(0,p.shallowRef)(''),d=(0,p.shallowRef)(!1),m=M(()=>d.value=!1,n,{immediate:!1});function f(e){return'granted'===e||'prompt'===e}return s.value&&a&&j(['copy','cut'],async function(){let e=!(l.value&&f(i.value));if(!e)try{u.value=await t.clipboard.readText()}catch(t){e=!0}var a,o,n;e&&(u.value=null!=(n=null==(o=null==(a=null==document?void 0:document.getSelection)?void 0:a.call(document))?void 0:o.toString())?n:'')},{passive:!0}),{isSupported:s,text:u,copied:d,copy:async function(e=(0,p.toValue)(o)){if(s.value&&null!=e){let a=!(l.value&&f(c.value));if(!a)try{await t.clipboard.writeText(e)}catch(e){a=!0}a&&function(e){const t=document.createElement('textarea');t.value=null!=e?e:'',t.style.position='absolute',t.style.opacity='0',document.body.appendChild(t),t.select(),document.execCommand('copy'),t.remove()}(e),u.value=e,d.value=!0,m.start()}}}}const Y='undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof self?self:{},X='__vueuse_ssr_handlers__',K=q();function q(){return X in Y||(Y[X]=Y[X]||{}),Y[X]}function J(e,t){return K[e]||t}function Z(e){return null==e?'any':e instanceof Set?'set':e instanceof Map?'map':e instanceof Date?'date':'boolean'==typeof e?'boolean':'string'==typeof e?'string':'object'==typeof e?'object':Number.isNaN(e)?'any':'number'}const Q={boolean:{read:e=>'true'===e,write:e=>String(e)},object:{read:e=>JSON.parse(e),write:e=>JSON.stringify(e)},number:{read:e=>Number.parseFloat(e),write:e=>String(e)},any:{read:e=>e,write:e=>String(e)},string:{read:e=>e,write:e=>String(e)},map:{read:e=>new Map(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e.entries()))},set:{read:e=>new Set(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e))},date:{read:e=>new Date(e),write:e=>e.toISOString()}},ee='vueuse-storage';function te(e,t,a,o={}){var n;const{flush:r='pre',deep:l=!0,listenToStorageChanges:i=!0,writeDefaults:c=!0,mergeDefaults:s=!1,shallow:u,window:d=L,eventFilter:m,onError:f=e=>{console.error(e)},initOnMounted:g}=o,v=(u?p.shallowRef:p.ref)('function'==typeof t?t():t),b=(0,p.computed)(()=>(0,p.toValue)(e));if(!a)try{a=J('getDefaultStorage',()=>{var e;return null==(e=L)?void 0:e.localStorage})()}catch(e){f(e)}if(!a)return v;const h=(0,p.toValue)(t),x=Z(h),y=null!=(n=o.serializer)?n:Q[x],{pause:w,resume:k}=A(v,e=>function(e){try{const t=a.getItem(b.value);if(null==e)V(t,null),a.removeItem(b.value);else{const o=y.write(e);t!==o&&(a.setItem(b.value,o),V(t,o))}}catch(e){f(e)}}(e),{flush:r,deep:l,eventFilter:m});(0,p.watch)(b,()=>E(),{flush:r});let C=!1;const N=e=>{g&&!C||E(e.detail)};function V(e,t){if(d){const o={key:b.value,oldValue:e,newValue:t,storageArea:a};d.dispatchEvent(a instanceof Storage?new StorageEvent('storage',o):new CustomEvent(ee,{detail:o}))}}function E(e){if(!e||e.storageArea===a)if(e&&null==e.key)v.value=h;else if(!e||e.key===b.value){w();try{const t=y.write(v.value);void 0!==e&&(null==e?void 0:e.newValue)===t||(v.value=function(e){const t=e?e.newValue:a.getItem(b.value);if(null==t)return c&&null!=h&&a.setItem(b.value,y.write(h)),h;if(!e&&s){const e=y.read(t);return'function'==typeof s?s(e,h):'object'!==x||Array.isArray(e)?e:{...h,...e}}return'string'!=typeof t?t:y.read(t)}(e))}catch(e){f(e)}finally{e?(0,p.nextTick)(k):k()}}}return d&&i&&(a instanceof Storage?j(d,'storage',e=>{g&&!C||E(e)},{passive:!0}):j(d,ee,N)),g?U(()=>{C=!0,E()}):E(),v}function ae(e,t,a={}){const{window:o=L,...n}=a;let r;const l=H(()=>o&&'ResizeObserver'in o),i=()=>{r&&(r.disconnect(),r=void 0)},c=(0,p.computed)(()=>{const t=(0,p.toValue)(e);return Array.isArray(t)?t.map(e=>F(e)):[F(t)]}),s=(0,p.watch)(c,e=>{if(i(),l.value&&o){r=new ResizeObserver(t);for(const t of e)t&&r.observe(t,n)}},{immediate:!0,flush:'post'}),u=()=>{i(),s()};return m(u),{isSupported:l,stop:u}}function oe(e={}){const{window:t=L}=e,a=(0,p.ref)(null),o=(0,p.computed)(()=>{var e,t;return null!=(t=null==(e=a.value)?void 0:e.toString())?t:''}),n=(0,p.computed)(()=>a.value?function(e){var t;const a=null!=(t=e.rangeCount)?t:0;return Array.from({length:a},(_,t)=>e.getRangeAt(t))}(a.value):[]),r=(0,p.computed)(()=>n.value.map(e=>e.getBoundingClientRect()));return t&&j(t.document,'selectionchange',function(){a.value=null,t&&(a.value=t.getSelection())},{passive:!0}),{text:o,rects:r,ranges:n,selection:a}}function ne(e={}){var t,a;const{window:o=L}=e,n=y(null==e?void 0:e.element),r=y(null!=(t=null==e?void 0:e.input)?t:''),l=null!=(a=null==e?void 0:e.styleProp)?a:'height',i=(0,p.shallowRef)(1),c=(0,p.shallowRef)(0);function s(){var t;if(!n.value)return;let a='';n.value.style[l]='1px',i.value=null==(t=n.value)?void 0:t.scrollHeight;const o=(0,p.toValue)(null==e?void 0:e.styleTarget);o?o.style[l]=`${i.value}px`:a=`${i.value}px`,n.value.style[l]=a}return(0,p.watch)([r,n],()=>(0,p.nextTick)(s),{immediate:!0}),(0,p.watch)(i,()=>{var t;return null==(t=null==e?void 0:e.onResize)?void 0:t.call(e)}),ae(n,([{contentRect:e}])=>{c.value!==e.width&&function(e=L,t){e&&'function'==typeof e.requestAnimationFrame?e.requestAnimationFrame(t):t()}(o,()=>{c.value=e.width,s()})}),(null==e?void 0:e.watch)&&(0,p.watch)(e.watch,s,{immediate:!0,deep:!0}),{textarea:n,input:r,triggerResize:s}}Number.POSITIVE_INFINITY;function re(e,t){const{containerStyle:a,wrapperProps:o,scrollTo:n,calculateRange:r,currentList:l,containerRef:i}='itemHeight'in t?function(e,t){const a=le(t),{state:o,source:n,currentList:r,size:l,containerRef:i}=a,c={overflowY:'auto'},{itemHeight:s,overscan:u=5}=e,d=ie(o,n,s),m=ce(n,s),f=se('vertical',u,m,d,a),g=ue(s,n),v=(0,p.computed)(()=>g(o.value.start)),b=pe(s,n);de(l,t,i,f);const h=fe('vertical',f,g,i),x=(0,p.computed)(()=>({style:{width:'100%',height:b.value-v.value+'px',marginTop:`${v.value}px`}}));return{calculateRange:f,scrollTo:h,containerStyle:c,wrapperProps:x,currentList:r,containerRef:i}}(t,e):function(e,t){const a=le(t),{state:o,source:n,currentList:r,size:l,containerRef:i}=a,c={overflowX:'auto'},{itemWidth:s,overscan:u=5}=e,d=ie(o,n,s),m=ce(n,s),f=se('horizontal',u,m,d,a),g=ue(s,n),v=(0,p.computed)(()=>g(o.value.start)),b=pe(s,n);de(l,t,i,f);const h=fe('horizontal',f,g,i),x=(0,p.computed)(()=>({style:{height:'100%',width:b.value-v.value+'px',marginLeft:`${v.value}px`,display:'flex'}}));return{scrollTo:h,calculateRange:f,wrapperProps:x,containerStyle:c,currentList:r,containerRef:i}}(t,e);return{list:l,scrollTo:n,containerProps:{ref:i,onScroll:()=>{r()},style:a},wrapperProps:o}}function le(e){const t=(0,p.shallowRef)(null),a=function(e,t={width:0,height:0},a={}){const{window:o=L,box:n='content-box'}=a,r=(0,p.computed)(()=>{var t,a;return null==(a=null==(t=F(e))?void 0:t.namespaceURI)?void 0:a.includes('svg')}),l=(0,p.shallowRef)(t.width),i=(0,p.shallowRef)(t.height),{stop:c}=ae(e,([t])=>{const a='border-box'===n?t.borderBoxSize:'content-box'===n?t.contentBoxSize:t.devicePixelContentBoxSize;if(o&&r.value){const t=F(e);if(t){const e=t.getBoundingClientRect();l.value=e.width,i.value=e.height}}else if(a){const e=N(a);l.value=e.reduce((e,{inlineSize:t})=>e+t,0),i.value=e.reduce((e,{blockSize:t})=>e+t,0)}else l.value=t.contentRect.width,i.value=t.contentRect.height},a);U(()=>{const a=F(e);a&&(l.value='offsetWidth'in a?a.offsetWidth:t.width,i.value='offsetHeight'in a?a.offsetHeight:t.height)});const s=(0,p.watch)(()=>F(e),e=>{l.value=e?t.width:0,i.value=e?t.height:0});return{width:l,height:i,stop:function(){c(),s()}}}(t),o=(0,p.ref)([]),n=(0,p.shallowRef)(e);return{state:(0,p.ref)({start:0,end:10}),source:n,currentList:o,size:a,containerRef:t}}function ie(e,t,a){return o=>{if('number'==typeof a)return Math.ceil(o/a);const{start:n=0}=e.value;let r=0,l=0;for(let e=n;e<t.value.length;e++){if(r+=a(e),l=e,r>o)break}return l-n}}function ce(e,t){return a=>{if('number'==typeof t)return Math.floor(a/t)+1;let o=0,n=0;for(let r=0;r<e.value.length;r++){if(o+=t(r),o>=a){n=r;break}}return n+1}}function se(e,t,a,o,{containerRef:n,state:r,currentList:l,source:i}){return()=>{const c=n.value;if(c){const n=a('vertical'===e?c.scrollTop:c.scrollLeft),s=o('vertical'===e?c.clientHeight:c.clientWidth),u=n-t,d=n+s+t;r.value={start:u<0?0:u,end:d>i.value.length?i.value.length:d},l.value=i.value.slice(r.value.start,r.value.end).map((e,t)=>({data:e,index:t+r.value.start}))}}}function ue(e,t){return a=>{if('number'==typeof e){return a*e}return t.value.slice(0,a).reduce((t,_,a)=>t+e(a),0)}}function de(e,t,a,o){(0,p.watch)([e.width,e.height,()=>(0,p.toValue)(t),a],()=>{o()})}function pe(e,t){return(0,p.computed)(()=>'number'==typeof e?t.value.length*e:t.value.reduce((t,_,a)=>t+e(a),0))}const me={horizontal:'scrollLeft',vertical:'scrollTop'};function fe(e,t,a,o){return n=>{o.value&&(o.value[me[e]]=a(n),t())}}const ge='acu_visualizer_config',ve={type:'icon',content:'fa-layer-group',size:50,notifyAnimation:'ripple',borderColor:'#ffffff',borderOpacity:40,bgColor:'#ffffff',bgOpacity:25,imageInvert:!1},be=[{id:'save',icon:'fa-save',label:'保存'},{id:'saveAs',icon:'fa-file-export',label:'另存为'},{id:'undo',icon:'fa-undo',label:'撤回'},{id:'refresh',icon:'fa-sync-alt',label:'刷新'},{id:'manualUpdate',icon:'fa-hand-sparkles',label:'手动更新'},{id:'purge',icon:'fa-eraser',label:'清除范围'},{id:'pin',icon:'fa-thumbtack',label:'固定面板'},{id:'toggle',icon:'fa-compress',label:'收起面板'},{id:'openNative',icon:'fa-external-link-alt',label:'原生编辑器'},{id:'collapseTab',icon:'fa-box-open',label:'收纳Tab'},{id:'director',icon:'fa-clapperboard',label:'导演控制台'},{id:'settings',icon:'fa-cog',label:'设置'}],he=['save','collapseTab','refresh','director','toggle','settings'],xe=['save','collapseTab','refresh','director','toggle','settings','saveAs','undo','manualUpdate','purge','pin','openNative'],ye=[],we={theme:'retro',fontFamily:'default',cardWidth:280,fontSize:13,itemsPerPage:20,highlightNew:!0,highlightColor:'orange',highlightManualColor:'orange',highlightAiColor:'blue',customTitleColor:!1,titleColor:'orange',layout:'vertical',limitLongText:!1,showDashboard:!0,showPagination:!0,lockPanel:!1,purgeConfirmation:!0,gridColumns:0,autoSave:!1,autoSaveDelay:5e3,visibleButtons:he,buttonOrder:xe,buttonGroups:ye,longPressDirectExec:!1,clearTableOnSwipe:!0,collapseTabBar:!1,mobileSafeAreaBottom:50,autoImportInteractions:!1},ke=[{id:'retro',name:'复古羊皮',icon:'fa-scroll'},{id:'dark',name:'极夜深空',icon:'fa-moon'},{id:'modern',name:'现代清爽',icon:'fa-sun'},{id:'forest',name:'森之物语',icon:'fa-tree'},{id:'ocean',name:'深海幽蓝',icon:'fa-water'},{id:'cyber',name:'赛博霓虹',icon:'fa-bolt'},{id:'purple',name:'梦幻浅紫',icon:'fa-magic'}],Ce=[{id:'default',name:'系统默认 (Modern)',val:'\'Segoe UI\', \'Microsoft YaHei\', sans-serif'},{id:'hanchan',name:'寒蝉全圆体',val:'"寒蝉全圆体", sans-serif'},{id:'maple',name:'Maple Mono (代码风)',val:'"Maple Mono NF CN", monospace'},{id:'huiwen',name:'汇文明朝体 (Huiwen)',val:'"Huiwen-mincho", serif'},{id:'cooper',name:'Cooper正楷',val:'"CooperZhengKai", serif'},{id:'yffyt',name:'YFFYT (艺术体)',val:'"YFFYT", sans-serif'},{id:'fusion',name:'Fusion Pixel (像素风)',val:'"Fusion Pixel 12px M latin", monospace'},{id:'wenkai',name:'霞鹜文楷 (WenKai)',val:'"LXGW WenKai", serif'},{id:'notosans',name:'思源黑体 (Noto Sans)',val:'"Noto Sans CJK", sans-serif'},{id:'zhuque',name:'朱雀仿宋 (Zhuque)',val:'"Zhuque Fangsong (technical preview)", serif'}],Ne={orange:{main:'#d35400',bg:'rgba(211, 84, 0, 0.1)',name:'活力橙'},red:{main:'#e74c3c',bg:'rgba(231, 76, 60, 0.1)',name:'警示红'},blue:{main:'#3498db',bg:'rgba(52, 152, 219, 0.1)',name:'天空蓝'},green:{main:'#27ae60',bg:'rgba(39, 174, 96, 0.1)',name:'自然绿'},purple:{main:'#9b59b6',bg:'rgba(155, 89, 182, 0.1)',name:'罗兰紫'},teal:{main:'#1abc9c',bg:'rgba(26, 188, 156, 0.1)',name:'青绿'},pink:{main:'#e91e63',bg:'rgba(233, 30, 99, 0.1)',name:'少女粉'},lime:{main:'#82c91e',bg:'rgba(130, 201, 30, 0.1)',name:'酸橙'},indigo:{main:'#3f51b5',bg:'rgba(63, 81, 181, 0.1)',name:'靛蓝'},cyan:{main:'#00bcd4',bg:'rgba(0, 188, 212, 0.1)',name:'青色'},brown:{main:'#795548',bg:'rgba(121, 85, 72, 0.1)',name:'咖啡'},grey:{main:'#607d8b',bg:'rgba(96, 125, 139, 0.1)',name:'蓝灰'}},Ve=t('acu-config',()=>{const e=te('acu_ui_config_v18',we,localStorage,{mergeDefaults:!0}),t=(0,p.computed)(()=>e.value.theme),a=(0,p.computed)(()=>e.value.fontFamily),o=(0,p.computed)(()=>{const t=Ce.find(t=>t.id===e.value.fontFamily);return t?.val||Ce[0].val});function n(e){const t=e.startsWith('#')?e:`#${e}`,a=parseInt(t.slice(1,3),16),o=parseInt(t.slice(3,5),16),n=parseInt(t.slice(5,7),16);return{main:t,bg:`rgba(${a}, ${o}, ${n}, 0.1)`,name:'自定义颜色'}}const r=(0,p.computed)(()=>Ne[e.value.highlightColor]||Ne.orange),l=(0,p.computed)(()=>{if('custom'===e.value.highlightManualColor&&e.value.customHighlightManualHex)return n(e.value.customHighlightManualHex);const t=e.value.highlightManualColor||e.value.highlightColor;return Ne[t]||Ne.orange}),i=(0,p.computed)(()=>{if('custom'===e.value.highlightAiColor&&e.value.customHighlightAiHex)return n(e.value.customHighlightAiHex);const t=e.value.highlightAiColor||'blue';return Ne[t]||Ne.blue}),c=(0,p.computed)(()=>e.value.customTitleColor?'custom'===e.value.titleColor&&e.value.customTitleHex?n(e.value.customTitleHex):Ne[e.value.titleColor]||Ne.orange:l.value),s=(0,p.computed)(()=>e.value.gridColumns&&e.value.gridColumns>0?`repeat(${e.value.gridColumns}, 1fr)`:'repeat(auto-fill, minmax(110px, 1fr))');function u(t){e.value={...e.value,...t}}const d=(0,p.computed)(()=>{const t=e.value.buttonOrder,a=e.value.visibleButtons;return t.filter(e=>a.includes(e))}),m=(0,p.computed)(()=>{const t=e.value.visibleButtons,a=(e.value.buttonGroups||[]).map(e=>e.secondaryId).filter(Boolean);return be.filter(e=>!e.hidden&&!t.includes(e.id)&&!a.includes(e.id))}),f=(0,p.computed)(()=>m.value.length>0);const g=(0,p.computed)(()=>e.value.buttonGroups||[]),v=(0,p.computed)(()=>e.value.longPressDirectExec||!1);return{config:e,theme:t,fontFamily:a,fontFamilyValue:o,highlightColorObj:r,highlightManualColorObj:l,highlightAiColorObj:i,titleColorObj:c,gridColumnsCss:s,updateConfig:u,resetConfig:function(){e.value={...we}},setTheme:function(e){u({theme:e})},setFontFamily:function(e){u({fontFamily:e})},setLayout:function(e){u({layout:e})},setHighlightColor:function(e){u({highlightColor:e,highlightManualColor:e})},setHighlightManualColor:function(e){u({highlightManualColor:e,highlightColor:e})},setHighlightAiColor:function(e){u({highlightAiColor:e})},setTitleColor:function(e){u({titleColor:e})},toggleHighlightNew:function(){u({highlightNew:!e.value.highlightNew})},toggleCustomTitleColor:function(){u({customTitleColor:!e.value.customTitleColor})},toggleShowDashboard:function(){u({showDashboard:!e.value.showDashboard})},toggleShowPagination:function(){u({showPagination:!e.value.showPagination})},toggleLockPanel:function(){u({lockPanel:!e.value.lockPanel})},toggleLimitLongText:function(){u({limitLongText:!e.value.limitLongText})},setVisibleButtons:function(t){e.value.visibleButtons=t},setButtonOrder:function(t){e.value.buttonOrder=t},isButtonVisible:function(t){return e.value.visibleButtons.includes(t)},toggleButtonVisibility:function(t){const a=[...e.value.visibleButtons],o=a.indexOf(t);o>-1?a.splice(o,1):a.push(t),e.value.visibleButtons=a},sortedVisibleButtons:d,hiddenButtons:m,hasHiddenButtons:f,getButtonConfig:function(e){return be.find(t=>t.id===e)},buttonGroups:g,longPressDirectExec:v,setButtonGroups:function(t){e.value.buttonGroups=t},addButtonGroup:function(t,a){const o=(e.value.buttonGroups||[]).filter(e=>e.secondaryId!==a&&e.primaryId!==t);o.push({primaryId:t,secondaryId:a}),e.value.buttonGroups=[...o],console.log('[ACU] addButtonGroup:',t,'->',a,'groups:',e.value.buttonGroups)},removeButtonGroupSecondary:function(t){const a=(e.value.buttonGroups||[]).filter(e=>e.primaryId!==t);e.value.buttonGroups=[...a],console.log('[ACU] removeButtonGroupSecondary:',t,'groups:',e.value.buttonGroups)},getSecondaryButtonId:function(t){const a=(e.value.buttonGroups||[]).find(e=>e.primaryId===t);return a?.secondaryId||null},isSecondaryButton:function(t){return(e.value.buttonGroups||[]).some(e=>e.secondaryId===t)},toggleLongPressDirectExec:function(){e.value.longPressDirectExec=!e.value.longPressDirectExec},setLongPressDirectExec:function(t){e.value.longPressDirectExec=t},resetButtonConfig:function(){e.value.visibleButtons=[...he],e.value.buttonOrder=[...xe],e.value.buttonGroups=[...ye],e.value.longPressDirectExec=!1}}}),Ee=t('acu-ball-appearance',()=>{const e=(0,p.ref)({...ve}),t=(0,p.ref)([]),a=(0,p.ref)(!1);function o(){try{if('function'!=typeof getVariables||'function'!=typeof replaceVariables)return void console.warn('[ACU] 变量 API 不可用');const a=getVariables({type:'global'}),o={...a[ge]||{},configVersion:1,ballAppearance:e.value,customFonts:t.value};replaceVariables({...a,[ge]:o},{type:'global'}),console.info('[ACU] 已保存配置到全局变量')}catch(e){console.error('[ACU] 保存全局变量失败:',e)}}(0,p.watch)([e,t],()=>{a.value&&o()},{deep:!0});const n=(0,p.computed)(()=>t.value.filter(e=>e.importUrl).map(e=>e.importUrl)),r=(0,p.computed)(()=>[...Ce,...t.value.map(e=>({id:e.id,name:e.name,val:e.fontFamily}))]);function l(e,t){const a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!a)return e;return`rgba(${parseInt(a[1],16)}, ${parseInt(a[2],16)}, ${parseInt(a[3],16)}, ${t/100})`}const i=(0,p.computed)(()=>{const t=e.value;return{'--ball-size':`${t.size}px`,'--ball-border-color':t.borderColor,'--ball-border-color-rgba':l(t.borderColor,t.borderOpacity),'--ball-bg-color':l(t.bgColor,t.bgOpacity)}});return{appearance:e,customFonts:t,isLoaded:a,loadFromGlobalVariables:function(){try{if('function'!=typeof getVariables)return console.warn('[ACU] getVariables 不可用，使用默认配置'),void(a.value=!0);const o=getVariables({type:'global'})[ge];o?.ballAppearance&&(e.value={...ve,...o.ballAppearance}),o?.customFonts&&(t.value=o.customFonts),a.value=!0,console.info('[ACU] 已从全局变量加载配置')}catch(e){console.error('[ACU] 加载全局变量失败:',e),a.value=!0}},saveToGlobalVariables:o,updateAppearance:function(t){e.value={...e.value,...t}},setIcon:function(t,a){e.value.type=t,e.value.content=a},setSize:function(t){e.value.size=Math.max(40,Math.min(100,t))},setBorderColor:function(t,a){e.value.borderColor=t,void 0!==a&&(e.value.borderOpacity=a)},setBgColor:function(t,a){e.value.bgColor=t,void 0!==a&&(e.value.bgOpacity=a)},setNotifyAnimation:function(t){e.value.notifyAnimation=t},resetAppearance:function(){e.value={...ve}},addFont:function(e){const a={...e,id:`custom_${Date.now()}`};return t.value.push(a),a},removeFont:function(e){const a=t.value.findIndex(t=>t.id===e);a>-1&&t.value.splice(a,1)},fontImportUrls:n,allFonts:r,cssVariables:i,hexToRgba:l}}),Be='backgrounds',Se='global_theme_background';let Te=null;async function De(){return Te||new Promise((e,t)=>{const a=indexedDB.open('acu_background_db',1);a.onerror=()=>{console.error('[ACU Background] 打开数据库失败:',a.error),t(a.error)},a.onsuccess=()=>{Te=a.result,console.info('[ACU Background] 数据库连接成功'),e(Te)},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(Be)||(t.createObjectStore(Be,{keyPath:'chatId'}),console.info('[ACU Background] 创建背景图片表成功'))}})}async function Ae(e,t,a='image/png'){const o=await De();return new Promise((n,r)=>{const l=o.transaction(Be,'readwrite').objectStore(Be),i={chatId:e,imageData:t,mimeType:a,timestamp:Date.now()},c=l.put(i);c.onsuccess=()=>{console.info('[ACU Background] 保存背景图片成功, chatId:',e),n()},c.onerror=()=>{console.error('[ACU Background] 保存背景图片失败:',c.error),r(c.error)}})}async function ze(e){const t=await De();return new Promise((a,o)=>{const n=t.transaction(Be,'readonly').objectStore(Be).get(e);n.onsuccess=()=>{const t=n.result;if(t?.imageData){const o=URL.createObjectURL(t.imageData);console.info('[ACU Background] 加载背景图片成功, chatId:',e),a(o)}else a(null)},n.onerror=()=>{console.error('[ACU Background] 加载背景图片失败:',n.error),o(n.error)}})}function Ie(e){e.startsWith('blob:')&&URL.revokeObjectURL(e)}const _e={enabled:!1,hasIndexedDBImage:!1,externalUrl:void 0,imageUrl:'',opacity:30,size:'cover',blur:0,offsetX:0,offsetY:0,scale:100},Ue={bgNav:'--acu-bg-nav',bgPanel:'--acu-bg-panel',cardBg:'--acu-card-bg',tableHead:'--acu-table-head',tableHover:'--acu-table-hover',badgeBg:'--acu-badge-bg',inputBg:'--acu-input-bg',menuBg:'--acu-menu-bg',overlayBg:'--acu-overlay-bg',textMain:'--acu-text-main',textSub:'--acu-text-sub',menuText:'--acu-menu-text',border:'--acu-border',btnBg:'--acu-btn-bg',btnHover:'--acu-btn-hover',btnActiveBg:'--acu-btn-active-bg',btnActiveText:'--acu-btn-active-text',shadow:'--acu-shadow'},Me=[{id:'background',name:'背景色',icon:'fa-fill-drip',vars:[{key:'bgNav',label:'导航栏背景'},{key:'bgPanel',label:'面板背景'},{key:'cardBg',label:'卡片背景'},{key:'tableHead',label:'表头背景'},{key:'tableHover',label:'悬浮背景'},{key:'badgeBg',label:'徽章背景'},{key:'inputBg',label:'输入框背景'},{key:'menuBg',label:'菜单背景'},{key:'overlayBg',label:'遮罩背景'}]},{id:'text',name:'文本色',icon:'fa-font',vars:[{key:'textMain',label:'主文本色'},{key:'textSub',label:'次要文本色'},{key:'menuText',label:'菜单文本色'}]},{id:'button',name:'边框与按钮',icon:'fa-square',vars:[{key:'border',label:'边框色'},{key:'btnBg',label:'按钮背景'},{key:'btnHover',label:'按钮悬浮'},{key:'btnActiveBg',label:'按钮激活背景'},{key:'btnActiveText',label:'按钮激活文本'}]},{id:'effect',name:'效果',icon:'fa-magic',vars:[{key:'shadow',label:'阴影色'}]}],Le=[{value:'list',label:'普通列表'},{value:'grid',label:'普通网格'},{value:'global',label:'全局状态'},{value:'interaction',label:'交互表'}],$e={goToTable:{id:'goToTable',icon:'fa-external-link-alt',label:'跳转',tooltip:'跳转到表格'},clear:{id:'clear',icon:'fa-eraser',label:'清除',tooltip:'清除表格数据'},undo:{id:'undo',icon:'fa-undo',label:'撤回',tooltip:'撤回上次修改'},manualUpdate:{id:'manualUpdate',icon:'fa-hand-sparkles',label:'更新',tooltip:'手动更新'},relationshipGraph:{id:'relationshipGraph',icon:'fa-project-diagram',label:'关系图',tooltip:'人物关系图'},settings:{id:'settings',icon:'fa-cog',label:'设置',tooltip:'看板设置'},nativeEdit:{id:'nativeEdit',icon:'fa-external-link-alt',label:'原生编辑器',tooltip:'打开原生编辑器'},divination:{id:'divination',icon:'fa-dice',label:'抽签',tooltip:'赛博算卦 - 注入隐藏提示词'},console:{id:'console',icon:'fa-solid fa-clapperboard',label:'导演控制台',tooltip:'打开导演控制台'}},Pe={task:{type:'table',title:'任务',icon:'fa-tasks',displayColumns:['名称','任务名','name','Name','类型','状态'],maxRows:5,actions:['goToTable'],colSpan:1,displayStyle:'list'},item:{type:'table',title:'物品',icon:'fa-box-open',displayColumns:['名称','物品名','name','Name','数量'],maxRows:12,actions:['goToTable','clear'],colSpan:1,displayStyle:'grid'},character:{type:'table',title:'主角',icon:'fa-user',displayColumns:[],maxRows:1,actions:['goToTable'],colSpan:2,displayStyle:'list'},location:{type:'table',title:'地点',icon:'fa-map-marker-alt',displayColumns:['名称','地点','name','Name','描述'],maxRows:5,actions:['goToTable'],colSpan:1,displayStyle:'list'}},Fe={task:['任务','Task','task','Quest','quest','日程'],item:['物品','道具','Item','item','背包','库存','装备'],character:['主角','玩家','Player','player','protagonist'],location:['地点','位置','Location','location','场景']},je='acu_theme_config_global_v1',Re='acu_theme_presets_v1',Oe='acu_custom_css_v1',He={manualColor:'orange',manualHex:'#d35400',aiColor:'blue',aiHex:'#3498db',titleColor:'orange',titleHex:'#d35400'};function We(e,t=.1){const a=e.startsWith('#')?e:`#${e}`;return`rgba(${parseInt(a.slice(1,3),16)}, ${parseInt(a.slice(3,5),16)}, ${parseInt(a.slice(5,7),16)}, ${t})`}function Ge(e,t){const a=e.startsWith('#')?e:`#${e}`;return`rgba(${parseInt(a.slice(1,3),16)}, ${parseInt(a.slice(3,5),16)}, ${parseInt(a.slice(5,7),16)}, ${t})`}function Ye(e,t){if('custom'===e&&t)return t;const a=Ne[e];return a?.main||'#d35400'}const Xe=t('acu-theme',()=>{const e=(0,p.ref)([]),t=(0,p.ref)(null),a=(0,p.ref)({}),o=(0,p.ref)({}),n=(0,p.ref)({...He}),r=(0,p.ref)({..._e}),l=(0,p.ref)(''),i=(0,p.ref)(!1),c=Ve(),s=(0,p.computed)(()=>c.config.theme),u=(0,p.computed)(()=>Ye(n.value.manualColor,n.value.manualHex)),d=(0,p.computed)(()=>Ye(n.value.aiColor,n.value.aiHex)),m=(0,p.computed)(()=>Ye(n.value.titleColor,n.value.titleHex)),f=(0,p.computed)(()=>We(m.value,.08)),g=(0,p.computed)(()=>t.value&&e.value.find(e=>e.id===t.value)||null);function v(){try{if(localStorage.setItem(Re,JSON.stringify(e.value)),localStorage.setItem(Oe,l.value),'function'==typeof getVariables&&'function'==typeof insertOrAssignVariables){const n={themePresets:e.value,activePresetId:t.value||void 0,themeVars:a.value,themeVarOpacities:o.value,backgroundConfig:r.value,customCSS:l.value};insertOrAssignVariables({[je]:n},{type:'global'})}h(),console.info('[ACU Theme] 已保存主题配置 (Global)')}catch(e){console.error('[ACU Theme] 保存配置失败:',e)}}function b(){const e=c.config;n.value={manualColor:e.highlightManualColor||e.highlightColor||'orange',manualHex:e.customHighlightManualHex,aiColor:e.highlightAiColor||'blue',aiHex:e.customHighlightAiHex,titleColor:e.titleColor||'orange',titleHex:e.customTitleHex}}function h(){c.updateConfig({highlightManualColor:n.value.manualColor,highlightColor:n.value.manualColor,customHighlightManualHex:n.value.manualHex,highlightAiColor:n.value.aiColor,customHighlightAiHex:n.value.aiHex,titleColor:n.value.titleColor,customTitleHex:n.value.titleHex,highlightNew:!0,customTitleColor:!0})}function x(t){const i={id:`preset_${Date.now()}`,name:t,createdAt:(new Date).toISOString(),baseTheme:s.value,themeVars:{...a.value},themeVarOpacities:{...o.value},highlight:{...n.value},backgroundConfig:{...r.value},customCSS:l.value};return e.value.push(i),v(),i}function y(t,a){const o=e.value.findIndex(e=>e.id===t);o>-1&&(e.value[o]={...e.value[o],...a},v())}function w(){const e=[];for(const[t,n]of Object.entries(a.value))if(n){const a=Ue[t];if(a){const r=o.value[t]??100;if(r<100&&n.startsWith('#')){const t=Ge(n,r/100);e.push(`${a}: ${t};`)}else e.push(`${a}: ${n};`)}}if(e.push(`--acu-highlight: ${u.value};`),e.push(`--acu-highlight-manual: ${u.value};`),e.push(`--acu-highlight-manual-bg: ${We(u.value)};`),e.push(`--acu-highlight-ai: ${d.value};`),e.push(`--acu-highlight-ai-bg: ${We(d.value)};`),e.push(`--acu-title-color: ${m.value};`),e.push(`--acu-title-color-bg: ${f.value};`),e.push(`--acu-accent: ${m.value};`),r.value.enabled&&r.value.imageUrl){const t=r.value,a=(t.offsetX,t.offsetY,(t.scale||100)/100),o='auto'===t.size?'100%':t.size;e.push(`--acu-bg-image: url("${t.imageUrl}");`),e.push('--acu-bg-position: center center;'),e.push(`--acu-bg-size: ${o};`),e.push(`--acu-bg-scale: ${a};`),e.push(`--acu-bg-offset-x: ${t.offsetX||0}%;`),e.push(`--acu-bg-offset-y: ${t.offsetY||0}%;`),e.push('--acu-bg-repeat: no-repeat;'),e.push(`--acu-bg-opacity: ${t.opacity/100};`),e.push(`--acu-bg-blur: ${t.blur}px;`)}else e.push('--acu-bg-image: none;');if(0===e.length)return'';let t=`.acu-app, .acu-wrapper, .acu-modal-container { ${e.join(' ')} }`;return r.value.enabled&&r.value.imageUrl&&(t+='\n        .acu-data-display::before {\n          content: "";\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background-image: var(--acu-bg-image);\n          background-position: var(--acu-bg-position);\n          background-size: var(--acu-bg-size);\n          background-repeat: var(--acu-bg-repeat);\n          transform: translate(var(--acu-bg-offset-x), var(--acu-bg-offset-y)) scale(var(--acu-bg-scale));\n          transform-origin: center center;\n          opacity: var(--acu-bg-opacity);\n          filter: blur(var(--acu-bg-blur));\n          pointer-events: none;\n          z-index: -1;\n          border-radius: 12px; /* 保持圆角一致 */\n        }\n        .acu-data-display {\n          position: relative;\n          z-index: 0;\n          background: transparent !important; /* 让背景透出来 */\n        }\n      '),t}return(0,p.watch)([n,a,o,r,l],()=>{i.value&&v()},{deep:!0}),{presets:e,activePresetId:t,currentThemeVars:a,currentThemeVarOpacities:o,currentHighlight:n,backgroundConfig:r,customCSS:l,isLoaded:i,baseTheme:s,manualHighlightColor:u,aiHighlightColor:d,titleColor:m,titleBgColor:f,activePreset:g,loadFromStorage:async function(){try{const n=localStorage.getItem(Re);n&&(e.value=JSON.parse(n));const c=localStorage.getItem(Oe);if(c&&(l.value=c),'function'==typeof getVariables){const n=getVariables({type:'global'});let i=n[je];if(!i){const e=getVariables({type:'script',script_id:'acu_visualizer_ui'});e&&(e.themeVars||e.backgroundConfig)&&(console.info('[ACU Theme] 检测到旧版配置，正在迁移到全局变量...'),i=e,setTimeout(()=>v(),1e3))}if(i){if(i.activePresetId&&(t.value=i.activePresetId),i.themePresets&&(e.value=i.themePresets),i.themeVars&&(a.value=i.themeVars),i.themeVarOpacities&&(o.value=i.themeVarOpacities),i.backgroundConfig&&(r.value=i.backgroundConfig,r.value.enabled&&r.value.hasIndexedDBImage))try{const e=await ze(Se);e&&(r.value.imageUrl=e,console.info('[ACU Theme] 已从 IndexedDB 恢复背景图片'))}catch(e){console.warn('[ACU Theme] 恢复背景图片失败:',e)}i.customCSS&&(l.value=i.customCSS)}}b(),i.value=!0,console.info('[ACU Theme] 已加载主题配置')}catch(e){console.error('[ACU Theme] 加载配置失败:',e),i.value=!0}},saveToStorage:v,syncFromConfigStore:b,syncToConfigStore:h,createPreset:x,saveCurrentToPreset:function(i){const c=e.value.findIndex(e=>e.name===i);if(c>-1){const i=e.value[c],u={...i,baseTheme:s.value,themeVars:{...a.value},themeVarOpacities:{...o.value},highlight:{...n.value},backgroundConfig:{...r.value},customCSS:l.value};return e.value[c]=u,t.value=i.id,v(),u}{const e=x(i);return t.value=e.id,v(),e}},deletePreset:function(a){const o=e.value.findIndex(e=>e.id===a);o>-1&&(e.value.splice(o,1),t.value===a&&(t.value=null),v())},applyPreset:function(i){const s=e.value.find(e=>e.id===i);s&&(c.setTheme(s.baseTheme),a.value={...s.themeVars},o.value={...s.themeVarOpacities},n.value={...s.highlight},r.value=s.backgroundConfig||{..._e},r.value.enabled&&r.value.hasIndexedDBImage&&ze(Se).then(e=>{e?(r.value.imageUrl=e,console.info('[ACU Theme] 预设应用：已恢复背景图片')):(r.value.imageUrl='',console.warn('[ACU Theme] 预设应用：IndexedDB 中未找到背景图片'))}).catch(e=>{console.warn('[ACU Theme] 预设应用：恢复背景图片失败',e)}),l.value=s.customCSS||'',t.value=i,v())},updatePreset:y,renamePreset:function(e,t){y(e,{name:t})},setManualHighlightColor:function(e,t){n.value.manualColor=e,n.value.manualHex=t,v()},setAiHighlightColor:function(e,t){n.value.aiColor=e,n.value.aiHex=t,v()},setTitleColor:function(e,t){n.value.titleColor=e,n.value.titleHex=t,v()},setThemeVar:function(e,t){a.value[e]=t},removeThemeVar:function(e){delete a.value[e]},clearThemeVars:function(){a.value={}},setThemeVarOpacity:function(e,t){o.value[e]=Math.max(0,Math.min(100,t))},removeThemeVarOpacity:function(e){delete o.value[e]},clearThemeVarOpacities:function(){o.value={}},setBackgroundConfig:function(e){r.value={...r.value,...e},v()},getBackgroundConfig:function(){return r.value},setCustomCSS:function(e){l.value=e,v()},clearCustomCSS:function(){l.value='',v()},getInjectedStyles:w,getFullInjectedCSS:function(){return[w(),l.value].filter(Boolean).join('\n\n')}}}),Ke=[{level:'S',name:'爱/沉迷',color:'#E91E63',keywords:['恋','恋人','男友','女友','爱','暧昧','暗恋','情人','伴侣','老婆','老公','丈夫','妻子','粉丝','迷','爱慕','倾心','心上人','挚爱','深爱','相恋','热恋','初恋','单恋','苦恋','痴迷','迷恋','倾慕']},{level:'A',name:'亲属',color:'#2196F3',keywords:['父','母','兄','哥','弟','姐','妹','爷','奶','叔','姑','舅','姨','义兄','义妹','义父','义子','义弟','义姐','义母','义女','养父','养母','养子','养女','亲人','家人','至亲','血亲','族人','堂兄','堂弟','表兄','表弟','表姐','表妹','外公','外婆','祖父','祖母','曾祖','儿子','女儿','孙子','孙女']},{level:'B',name:'师/友/同伴',color:'#4CAF50',keywords:['友','盟','朋友','挚友','知己','故交','青梅竹马','发小','闺蜜','死党','战友','伙伴','同窗','师徒','弟子','师傅','老师','学生','队友','搭档','同伴','好友','密友','旧友','故友','同门','师兄','师姐','师弟','师妹','徒弟','徒儿','恩师','导师','教官','学徒','盟友','向导','哨兵']},{level:'C',name:'社会关系/未分类',color:'#9E9E9E',keywords:['同事','邻居','舍友','室友','顾客','客户','上司','下属','同学','路人','熟人','认识','相识','同乡','老乡','房东','租客','店员','老板','员工','主管','经理','助手','秘书','管家','仆人','侍从','护卫','保镖']},{level:'D',name:'利益关系',color:'#FF9800',keywords:['合作','雇佣','交易','债务','炮友','利用','工具人','棋子','操控','傀儡','买卖','债主','欠债','商业','合伙','投资','赞助','金主','资助','包养','契约','协议']},{level:'E',name:'敌对关系',color:'#F44336',keywords:['仇','敌','死','对手','竞争','仇敌','死敌','宿敌','威胁','敌对','仇人','仇家','敌人','对头','冤家','杀父','杀母','血仇','深仇','世仇','夙敌','劲敌','强敌','死对头','眼中钉','宿主','夺舍','寄生']}],qe='?',Je='复杂/未知',Ze='#9C27B0';function Qe(e,t){return t.keywords.some(t=>e.includes(t))}function et(e,t){const a=e.split(/[,，、;；|]/).map(e=>e.trim()).filter(e=>e.length>0);if(0===a.length)return{color:Ke.find(e=>'C'===e.level).color,level:'C',typeName:'社会关系',isComplex:!1};if(t&&t.length>0)for(const e of t)if(e.keywords&&e.keywords.length>0)for(const t of a)if(e.keywords.some(e=>t.includes(e)))return{color:e.color,level:'C',typeName:e.label,isComplex:!1};const o=new Set;if(a.forEach(e=>{for(const t of Ke)if(Qe(e,t)){o.add(t.level);break}}),0===o.size)return{color:Ke.find(e=>'C'===e.level).color,level:'C',typeName:'社会关系',isComplex:!1};const n=['S','A','B'].some(e=>o.has(e)),r=o.has('E');if(n&&r)return{color:Ze,level:qe,typeName:Je,isComplex:!0};const l=['S','A','E','D','B','C'];for(const e of l)if(o.has(e)){const t=Ke.find(t=>t.level===e);return{color:t.color,level:t.level,typeName:t.name,isComplex:!1}}return{color:Ke.find(e=>'C'===e.level).color,level:'C',typeName:'社会关系',isComplex:!1}}function tt(e,t){const a=(e||'')+(t||'');return['过去','过往','从前','曾经','曾','前','原','故','昔','已故','已逝','前任','旧','暗','秘','隐','伪','假','表面','疑','可能','潜在','疑似'].some(e=>a.includes(e))}function at(e){return e?e.replace(/[。.]+$/,'').replace(/\s+/g,'').trim():''}const ot=/[;；|\n]/,nt=/[、,，/&]/,rt=/[：:]/;function lt(e,t){const a=e.cells.find(e=>e.colIndex===t);return a?String(a.value??'').trim():''}function it(e,t){return t&&e&&t.get(e)||e}function ct(e,t){const a=e.map(e=>e.toLowerCase());for(const e of t){const t=a.findIndex(t=>t.includes(e.toLowerCase()));if(-1!==t)return t}return-1}function st(e,t){const a=e.toLowerCase(),o=t.toLowerCase();return['人物','角色','npc','character','主角','protagonist','player'].some(e=>a.includes(e)||o.includes(e))}function ut(e){return/^[A-Za-z\s'-]+$/.test(e)&&e.includes(' ')}function dt(e){if(ut(e)){const t=e.split(' ')[0];return t.length>6?t.slice(0,6):t}return e.length>0?e[e.length-1]:e}function pt(e,t=[],a,o,n){const r=[],l=[],i=[],c=new Set;if(!e||0===e.rows.length)return{elements:[],nodeCount:0,edgeCount:0,warnings:['关系表为空或不存在']};const s=e.headers,u=ct(s,['source','源','主体','发起方','from']),d=ct(s,['target','目标','客体','接收方','to']),p=ct(s,['关系','relation','关系词']),m=ct(s,['备注','note','说明','remark']);if(-1===u||-1===d)return{elements:[],nodeCount:0,edgeCount:0,warnings:['关系表缺少 source/target 列，无法解析']};const f=new Set,g=new Set,v=new Set;if(t.forEach(e=>{const t=e.name.toLowerCase(),a=t.includes('主角')||t.includes('protagonist'),o=ct(e.headers,['姓名','name','名称','角色名']);-1!==o&&e.rows.forEach(e=>{const t=lt(e,o);t&&(a?f.add(t):g.add(t))})}),a){const e=ct(a.headers,['名称','name','势力名']);-1!==e&&a.rows.forEach(t=>{const a=lt(t,e);a&&v.add(a)})}function b(e){if(!e||c.has(e))return;c.add(e);const t=function(e){return f.has(e)?'protagonist':g.has(e)?'character':v.has(e)?'faction':'unknown'}(e),a=dt(e);l.push({data:{id:e,label:a,type:t},classes:t})}return e.rows.forEach((e,t)=>{const a=lt(e,u),l=lt(e,d),c=-1!==p?lt(e,p):'',s=-1!==m?lt(e,m):'';if(!a||!l)return void((a||l)&&r.push(`第 ${t+1} 行数据不完整（source: "${a}", target: "${l}"）`));const f=it(a,o),g=it(l,o);b(f),b(g);const v=et(c,n);i.push({data:{id:`edge-${t}`,source:f,target:g,label:c||'关系',note:s,color:v.color,lineStyle:tt(s)?'dashed':'solid',level:v.level}})}),{elements:[...l,...i],nodeCount:l.length,edgeCount:i.length,warnings:r}}function mt(e,t){const a=[],o=[],n=new Set;let r=0;const l=new Set(t.validTargets||[]);function i(e,o=t.nodeType){if(!e||n.has(e))return;n.add(e);const r=dt(e);a.push({data:{id:e,label:r,type:o},classes:o})}const c=new Map;e.forEach(e=>{const a=ct(e.headers,t.nameColKeywords),o=ct(e.headers,t.relationColKeywords);-1!==a&&-1!==o&&e.rows.forEach(e=>{const n=lt(e,a),r=lt(e,o);if(!n||!r)return;const s=it(n,t.aliasMap);i(s),l.add(s);const u=function(e,t=new Set){if(!e||'string'!=typeof e)return[];const a=[],o=e.split(ot).map(e=>e.trim()).filter(Boolean);for(const e of o){let o='',n=e;const r=e.match(/[（(]([^）)]+)[）)]/);r&&(o=r[1],n=e.replace(/[（(][^）)]+[）)]/g,'').trim()),n=n.replace(/[""]([^""]+)[""]/g,'$1');const l=n.match(/^(.+?)与(.+?)的(.+)$/);if(l){const e=l[1].trim(),t=l[2].trim(),n=l[3].split(nt).map(e=>e.trim()).filter(Boolean);for(const r of n){const n=at(r);n&&a.push({targets:[e,t],relation:n,note:o})}continue}const i=n.match(/^(.+?[、,，].+?)的(.+)$/);if(i){const e=i[1],t=i[2],n=e.split(nt).map(e=>e.trim()).filter(Boolean);if(n.length>1){const e=t.split(nt).map(e=>e.trim()).filter(Boolean);for(const t of e){const e=at(t);e&&a.push({targets:n,relation:e,note:o})}continue}}const c=n.match(/^(.+?)的(.+)$/);if(c){const e=c[1].trim(),t=c[2];let n;n=t.includes('与')?t.split(/与/).map(e=>e.trim()).filter(Boolean):t.split(nt).map(e=>e.trim()).filter(Boolean);for(const t of n){const n=at(t);n&&a.push({targets:[e],relation:n,note:o})}continue}const s=n.match(/^与(.+?)([^、,，\s]+)$/);if(s){const e=s[1].trim(),t=s[2].trim(),n=e.split(nt).map(e=>e.trim()).filter(Boolean),r=t.split(nt).map(e=>e.trim()).filter(Boolean);let l=!1;for(const e of r){const t=at(e);n.length>0&&t&&(a.push({targets:n,relation:t,note:o}),l=!0)}if(l)continue}const u=n.match(new RegExp(`^(.+?)${rt.source}(.+)$`));if(u){let e=u[1].trim(),n=u[2].trim(),r=!1;const l=e=>e.split(nt).map(e=>e.trim()).some(e=>t.has(e));if(t.size>0){const t=l(e),a=l(n);!t&&a&&(r=!0)}r&&([e,n]=[n,e]);const i=n,c=e.split(nt).map(e=>e.trim()).filter(Boolean),s=i.split(nt).map(e=>e.trim()).filter(Boolean);for(const e of s){const t=at(e);t&&a.push({targets:c,relation:t,note:o})}continue}console.info(`[RelationshipParser] 无法解析: "${e}"`)}return a}(r,l);for(const e of u){const a=at(e.relation);if(a)for(const o of e.targets){const n=it(o,t.aliasMap);if(t.validTargets&&!t.validTargets.has(n))continue;i(n);const r=`${s}->${n}`,l=et(a,t.customLegendItems),u=tt(e.note,a);if(c.has(r)){const t=c.get(r);t.relations.includes(a)||t.relations.push(a),e.note&&!t.notes.includes(e.note)&&t.notes.push(e.note);const o=['S','A','E','D','B','C','?'],n=o.indexOf(t.level);(o.indexOf(l.level)<n||-1===n)&&(t.color=l.color,t.level=l.level),u&&(t.useDashed=!0)}else c.set(r,{relations:[e.relation],notes:e.note?[e.note]:[],color:l.color,level:l.level,useDashed:u})}}})});const s=new Set;return c.forEach((e,t)=>{const[a,n]=t.split('->'),l=[a,n].sort().join('<->');if(s.has(l))return;const i=`${n}->${a}`,u=c.get(i);let d=!1;if(u){d=[...e.relations].sort().join(',')===[...u.relations].sort().join(',')}const p=e.relations.join('/'),m=e.notes.join('; ');d?(s.add(l),o.push({data:{id:'edge-'+r++,source:a,target:n,label:p||'关系',note:m,color:e.color,lineStyle:e.useDashed?'dashed':'solid',level:e.level,bidirectional:!0}})):o.push({data:{id:'edge-'+r++,source:a,target:n,label:p||'关系',note:m,color:e.color,lineStyle:e.useDashed?'dashed':'solid',level:e.level,bidirectional:!1}})}),{elements:[...a,...o],nodeCount:a.length,edgeCount:o.length,warnings:[]}}function ft(e){const t=['势力','faction','组织','organization','阵营'];return e.find(e=>{const a=e.name.toLowerCase(),o=e.id.toLowerCase();return t.some(e=>a.includes(e)||o.includes(e))})||null}function gt(e,t){const a=function(e){const t=ft(e);if(!t)return console.info('[FactionMapping] 未找到势力表'),[];const a=ct(t.headers,['名称','name','势力名','组织名','阵营名']);if(-1===a)return console.info('[FactionMapping] 势力表中未找到名称列'),[];const o=[];return t.rows.forEach(e=>{const t=lt(e,a);t&&!o.includes(t)&&o.push(t)}),console.info(`[FactionMapping] 从势力表提取 ${o.length} 个势力:`,o),o}(e),o=function(e,t){const a=new Map,o=['所属','势力','阵营','组织','身份','职业','faction','affiliation','organization'];for(const n of e){const e=ct(n.headers,['姓名','name','名称','角色名']),r=ct(n.headers,o);-1!==e&&-1!==r&&n.rows.forEach(o=>{const n=lt(o,e),l=lt(o,r);if(!n||!l)return;const i=[...t].sort((e,t)=>t.length-e.length);for(const e of i)if(l.includes(e)){a.set(n,e),console.info(`[FactionMapping] 角色 "${n}" 匹配势力 "${e}" (来自 "${l}")`);break}})}return console.info(`[FactionMapping] 从人物表提取 ${a.size} 个角色的势力归属`),a}(t,a),n=ft(e),r=[];if(n&&a.length>0){mt([n],{nameColKeywords:['名称','name','势力名','组织名','阵营名'],relationColKeywords:['关系','外交','relation','relationship','势力关系'],nodeType:'faction',validTargets:new Set(a)}).elements.forEach(e=>{e.data.source&&e.data.target&&r.push({source:e.data.source,target:e.data.target,relation:e.data.label||'关系'})}),console.info(`[FactionMapping] 使用通用解析器解析出 ${r.length} 条势力间关系`)}return{factionList:a,characterToFaction:o,factionRelations:r}}function vt(e){return new Promise((t,a)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=()=>t(o.result),o.onerror=a})}function bt(e,t=100,a=.8){return new Promise((o,n)=>{const r=new Image;r.onload=()=>{try{const e=document.createElement('canvas'),l=Math.min(1,t/Math.max(r.width,r.height));e.width=r.width*l,e.height=r.height*l;const i=e.getContext('2d');if(!i)return void n(new Error('无法创建 canvas context'));i.drawImage(r,0,0,e.width,e.height),o(e.toDataURL('image/jpeg',a))}catch(e){n(e)}},r.onerror=()=>n(new Error('图片加载失败')),r.src=e})}function ht(e,t){const a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!a)return e;return`rgba(${parseInt(a[1],16)}, ${parseInt(a[2],16)}, ${parseInt(a[3],16)}, ${t/100})`}function xt(){const e=window.parent||window;return{$:window.jQuery||e.jQuery,getDB:()=>e.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI}}function yt(){const e=xt().getDB();try{return e&&e.exportTableAsJson?e.exportTableAsJson():null}catch(e){return console.warn('[ACU] getTableData error:',e),null}}function wt(e){if(!e||'object'!=typeof e)return{};const t={};for(const a in e)if(e[a]?.name){const o=e[a];t[o.name]={key:a,headers:o.content?.[0]||[],rows:o.content?.slice(1)||[]}}return Object.keys(t).length>0?t:null}const kt='acu-styles',Ct='acu-dynamic-font',Nt='acu-theme-custom';function Vt(){const e=Ve(),t=Xe(),{$}=xt(),a=()=>{try{return window.parent?.document||document}catch{return document}},o=(0,p.computed)(()=>{try{return getScriptId()}catch{return'acu-visualizer'}}),n=(0,p.ref)(null),r=(0,p.ref)(null),l=(0,p.ref)(null),i=(0,p.ref)(null),c=(0,p.ref)(!1),s=()=>{const t=a(),n=`${Ct}-${o.value}`;t.getElementById(n)?.remove();const r=t.createElement('style');r.id=n,r.setAttribute('data-source','acu-visualizer');const i=(()=>{const t=e.config.fontFamily||'default',a=Ce.find(e=>e.id===t);return a?.val||Ce[0].val})();r.textContent=`\n      \n      @import url("https://fontsapi.zeoseven.com/3/main/result.css");   /* 寒蝉全圆体 */\n      @import url("https://fontsapi.zeoseven.com/442/main/result.css"); /* Maple Mono */\n      @import url("https://fontsapi.zeoseven.com/256/main/result.css"); /* 汇文明朝 */\n      @import url("https://fontsapi.zeoseven.com/482/main/result.css"); /* Cooper正楷 */\n      @import url("https://fontsapi.zeoseven.com/446/main/result.css"); /* YFFYT */\n      @import url("https://fontsapi.zeoseven.com/570/main/result.css"); /* Fusion Pixel */\n      @import url("https://fontsapi.zeoseven.com/292/main/result.css"); /* 霞鹜文楷 */\n      @import url("https://fontsapi.zeoseven.com/69/main/result.css");  /* 思源黑体 */\n      @import url("https://fontsapi.zeoseven.com/7/main/result.css");   /* 朱雀仿宋 */\n    \n\n      /* 主容器字体 */\n      .acu-wrapper,\n      .acu-modal-container,\n      .acu-attachment-picker-overlay,\n      .acu-toast,\n      .acu-edit-dialog,\n      .acu-cell-menu,\n      .acu-nav-container,\n      #acu-ghost-preview {\n        font-family: ${i} !important;\n      }\n\n      /* 所有文本元素字体（排除图标） */\n      .acu-wrapper p,\n      .acu-wrapper div:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-wrapper span:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-wrapper label,\n      .acu-wrapper button,\n      .acu-wrapper a,\n      .acu-wrapper input,\n      .acu-wrapper select,\n      .acu-wrapper textarea,\n      .acu-wrapper th,\n      .acu-wrapper td,\n      .acu-modal-container p,\n      .acu-modal-container div:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-modal-container span:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-modal-container label,\n      .acu-modal-container button,\n      .acu-modal-container a,\n      .acu-modal-container input,\n      .acu-modal-container select,\n      .acu-modal-container textarea,\n      .acu-modal-container th,\n      .acu-modal-container td {\n        font-family: ${i} !important;\n      }\n\n      /* Toast - 字体跟随设置，颜色使用主文本色 */\n      .acu-toast,\n      .acu-toast p,\n      .acu-toast div,\n      .acu-toast span,\n      .acu-toast-message {\n        font-family: ${i} !important;\n        color: var(--acu-text-main) !important;\n        text-shadow: none !important;\n      }\n\n      /* Toast 图标 */\n      .acu-toast i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n        color: var(--acu-text-main) !important;\n      }\n\n      /* Tab/导航按钮 - 普通态：主文本色 */\n      .acu-tab-btn,\n      .acu-tab-btn span,\n      .acu-tab-btn i,\n      .acu-nav-btn,\n      .acu-nav-btn span,\n      .acu-nav-btn i {\n        font-family: ${i} !important;\n        text-shadow: none !important;\n        color: var(--acu-text-main) !important;\n      }\n\n      /* 导航按钮激活状态 - 背景使用主文本色，文字使用面板背景色(反色) */\n      .acu-nav-btn.active,\n      .acu-nav-btn.active span,\n      .acu-nav-btn.active i {\n        background: var(--acu-text-main) !important;\n        background-color: var(--acu-text-main) !important;\n        color: var(--acu-bg-panel) !important;\n      }\n\n      /* 卡片文本 */\n      .acu-data-card,\n      .acu-data-card p,\n      .acu-data-card div:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-data-card span:not(.fa):not(.fas):not(.far):not(.fab),\n      .acu-card-label,\n      .acu-card-value,\n      .acu-grid-label,\n      .acu-grid-value,\n      .acu-full-label,\n      .acu-full-value,\n      .acu-editable-title {\n        font-family: ${i} !important;\n        text-shadow: none !important;\n      }\n\n      /* 其他组件 */\n      .acu-panel-title,\n      .acu-settings-label,\n      .acu-btn-block,\n      .acu-nav-btn,\n      .acu-edit-textarea {\n        font-family: ${i} !important;\n      }\n\n      /* 保护 Font Awesome 图标字体 */\n      .acu-wrapper i.fa,\n      .acu-wrapper i.fas,\n      .acu-wrapper i.far,\n      .acu-wrapper i.fab,\n      .acu-wrapper .fa,\n      .acu-wrapper .fas,\n      .acu-wrapper .far,\n      .acu-wrapper .fab,\n      .acu-modal-container i.fa,\n      .acu-modal-container i.fas,\n      .acu-modal-container i.far,\n      .acu-modal-container i.fab,\n      .acu-modal-container .fa,\n      .acu-modal-container .fas,\n      .acu-modal-container .far,\n      .acu-modal-container .fab {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n      }\n\n      /* 颜色污染防护 - 只重置 text-shadow，不覆盖颜色 */\n      .acu-wrapper p,\n      .acu-wrapper div,\n      .acu-wrapper span,\n      .acu-wrapper label,\n      .acu-wrapper button,\n      .acu-modal-container p,\n      .acu-modal-container div,\n      .acu-modal-container span,\n      .acu-modal-container label,\n      .acu-modal-container button {\n        text-shadow: none !important;\n      }\n\n      /* 卡片标题 - 使用主题色 + 用户字体 */\n      .acu-editable-title,\n      .acu-panel-title {\n        color: var(--acu-title-color) !important;\n        font-family: ${i} !important;\n      }\n\n      /* 仪表盘标题和内容 */\n      .acu-dash-title,\n      .acu-dash-title span,\n      .acu-dash-title-text {\n        font-family: ${i} !important;\n        color: var(--acu-title-color) !important;\n        text-shadow: none !important;\n      }\n\n      /* 仪表盘图标 */\n      .acu-dash-title i,\n      .acu-dash-empty i,\n      .acu-dash-card i,\n      .acu-dash-npc-item i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n        color: var(--acu-text-sub) !important;\n      }\n\n      /* 仪表盘空状态 */\n      .acu-dash-empty,\n      .acu-dash-empty span {\n        font-family: ${i} !important;\n        color: var(--acu-text-sub) !important;\n        text-shadow: none !important;\n      }\n\n      /* 表格空状态"暂无数据" */\n      .acu-empty-state,\n      .acu-empty-state p,\n      .acu-empty-state span,\n      .acu-no-data {\n        font-family: ${i} !important;\n        color: var(--acu-text-sub) !important;\n        text-shadow: none !important;\n      }\n\n      /* 空状态图标 */\n      .acu-empty-state i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n        color: var(--acu-text-sub) !important;\n      }\n\n      /* 卡片列名 label - 字体大小受设置控制 */\n      label.acu-card-label,\n      label.acu-grid-label,\n      label.acu-full-label,\n      .acu-data-card label.acu-card-label,\n      .acu-data-card label.acu-grid-label,\n      .acu-data-card label.acu-full-label,\n      .acu-wrapper label.acu-card-label,\n      .acu-wrapper label.acu-grid-label,\n      .acu-wrapper label.acu-full-label {\n        font-family: ${i} !important;\n        font-size: calc(var(--acu-font-size, 13px) - 2px) !important;\n        text-shadow: none !important;\n      }\n\n      /* hint文本 - 使用次要文本色，字体大小受设置控制 */\n      .acu-wrapper .hint,\n      .acu-wrapper .acu-text-sub,\n      .acu-modal-container .hint,\n      .acu-modal-container .acu-text-sub,\n      .acu-settings-label .hint {\n        color: var(--acu-text-sub) !important;\n        font-size: calc(var(--acu-font-size, 13px) - 2px) !important;\n      }\n\n      /* Tab/Nav 图标使用 Font Awesome */\n      .acu-tab-btn i,\n      .acu-nav-btn i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n      }\n\n      /* 手动更新弹窗文本 */\n      .acu-manual-update-dialog p,\n      .acu-manual-update-dialog div,\n      .acu-manual-update-dialog span,\n      .acu-manual-update-dialog label,\n      .acu-modal-body p,\n      .acu-modal-body div,\n      .acu-modal-body span,\n      .acu-modal-body label {\n        color: var(--acu-text-main) !important;\n        text-shadow: none !important;\n      }\n\n      /* 设置面板返回按钮 - 使用主文本色 */\n      .acu-modal-back,\n      .acu-modal-back i,\n      .acu-back-btn,\n      .acu-back-btn i {\n        color: var(--acu-text-main) !important;\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n      }\n\n      /* 设置面板关闭按钮 */\n      .acu-modal-close i,\n      .acu-close-pill i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n        color: inherit !important;\n      }\n\n      /* 所有按钮字体 - 统一使用用户设置的字体 */\n      .acu-wrapper button,\n      .acu-modal-container button,\n      .acu-close-pill,\n      .acu-tool-btn,\n      .acu-btn,\n      .acu-btn-primary,\n      .acu-btn-secondary,\n      .acu-btn-danger,\n      .acu-btn-save,\n      .btn-cancel,\n      .btn-confirm,\n      .acu-preset-dropdown-btn,\n      .acu-modal-btn,\n      .acu-action-btn,\n      .acu-page-btn,\n      .acu-dialog-btn {\n        font-family: ${i} !important;\n      }\n\n      /* 主题面板CSS按钮 */\n      .acu-theme-panel button,\n      .acu-css-actions button,\n      .acu-css-actions .acu-tool-btn {\n        font-family: ${i} !important;\n      }\n\n      /* 头像管理弹窗 */\n      .acu-avatar-manager-modal button,\n      .acu-avatar-manager-modal label,\n      .acu-avatar-manager-modal span,\n      .acu-avatar-manager button,\n      .acu-avatar-manager label,\n      .acu-avatar-manager span,\n      .acu-avatar-dialog button,\n      .acu-avatar-dialog label,\n      .acu-avatar-dialog span {\n        font-family: ${i} !important;\n      }\n\n      /* 设置面板标题图标 - 使用主文本色 */\n      .acu-modal-header i:not(.acu-close-pill i),\n      .acu-settings-title i {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n        color: var(--acu-text-main) !important;\n      }\n    `,t.head.appendChild(r),l.value=r,console.info('[ACU Styles] Font styles injected')},u=()=>{if(!r.value)return;const t=e.config,a=e.highlightColorObj,o=e.highlightManualColorObj,n=e.highlightAiColorObj,l=e.titleColorObj,i=t.gridColumns&&t.gridColumns>0?`repeat(${t.gridColumns}, 1fr)`:'repeat(auto-fill, minmax(110px, 1fr))',c=`\n      .acu-wrapper,\n      .acu-modal-container,\n      .acu-attachment-picker-overlay,\n      .acu-toast,\n      .acu-cell-menu {\n        /* 卡片配置 */\n        --acu-card-width: ${t.cardWidth||280}px;\n        --acu-font-size: ${t.fontSize||13}px;\n\n        /* 高亮色 (兼容旧样式) */\n        --acu-highlight: ${a.main};\n        --acu-highlight-bg: ${a.bg};\n        --acu-accent: ${a.main};\n\n        /* 手动修改高亮色 */\n        --acu-highlight-manual: ${o.main};\n        --acu-highlight-manual-bg: ${o.bg};\n\n        /* AI填表高亮色 */\n        --acu-highlight-ai: ${n.main};\n        --acu-highlight-ai-bg: ${n.bg};\n\n        /* 标题色 */\n        --acu-title-color: ${l.main};\n        --acu-title-color-bg: ${l.bg};\n        --acu-title-color-rgb: ${function(e){const t=e.replace('#',''),a=parseInt(t,16);return`${a>>16&255}, ${a>>8&255}, ${255&a}`}(l.main)};\n\n        /* 导航栏 */\n        --acu-nav-cols: ${i};\n\n        /* 文本限制 */\n        --acu-text-max-height: ${!1!==t.limitLongText?'80px':'none'};\n        --acu-text-overflow: ${!1!==t.limitLongText?'auto':'visible'};\n      }\n\n      /* ============================================================\n       * 双色高亮样式 (已移除背景色和动画效果)\n       * ============================================================ */\n\n      /* 手动修改高亮 (橙色系) - 覆盖值元素及其所有子元素 */\n      .acu-cell-changed-manual .acu-grid-value,\n      .acu-cell-changed-manual .acu-full-value,\n      .acu-cell-changed-manual .acu-card-value,\n      .acu-cell-changed-manual .acu-grid-value *,\n      .acu-cell-changed-manual .acu-full-value *,\n      .acu-cell-changed-manual .acu-card-value *,\n      .acu-row-changed-manual .acu-editable-title {\n        color: var(--acu-highlight-manual) !important;\n        font-weight: 600;\n      }\n\n      /* AI填表高亮 (蓝色系) - 覆盖值元素及其所有子元素 */\n      .acu-cell-changed-ai .acu-grid-value,\n      .acu-cell-changed-ai .acu-full-value,\n      .acu-cell-changed-ai .acu-card-value,\n      .acu-cell-changed-ai .acu-grid-value *,\n      .acu-cell-changed-ai .acu-full-value *,\n      .acu-cell-changed-ai .acu-card-value *,\n      .acu-row-changed-ai .acu-editable-title {\n        color: var(--acu-highlight-ai) !important;\n        font-weight: 600;\n      }\n\n      /* 通用变更高亮 (兼容旧样式) */\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-grid-value,\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-full-value,\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-card-value,\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-grid-value *,\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-full-value *,\n      .acu-cell-changed:not(.acu-cell-changed-manual):not(.acu-cell-changed-ai) .acu-card-value *,\n      .acu-highlight-changed {\n        color: var(--acu-title-color) !important;\n        font-weight: 600;\n      }\n\n      /* ============================================================\n       * 酒馆主题污染防护 - 最高优先级覆盖\n       * 使用全局选择器 + !important 确保优先级高于酒馆主题\n       * ============================================================ */\n\n      /* 滑块 (Range Input) 完全重置 */\n      .acu-wrapper input[type="range"],\n      .acu-modal-container input[type="range"],\n      .acu-settings-control input[type="range"] {\n        -webkit-appearance: none !important;\n        -moz-appearance: none !important;\n        appearance: none !important;\n        background: transparent !important;\n        background-color: transparent !important;\n        background-image: none !important;\n        border: none !important;\n        box-shadow: none !important;\n        outline: none !important;\n        width: 120px !important;\n        height: 20px !important;\n      }\n\n      /* 滑块圆点 - Webkit */\n      .acu-wrapper input[type="range"]::-webkit-slider-thumb,\n      .acu-modal-container input[type="range"]::-webkit-slider-thumb,\n      .acu-settings-control input[type="range"]::-webkit-slider-thumb {\n        -webkit-appearance: none !important;\n        appearance: none !important;\n        width: 16px !important;\n        height: 16px !important;\n        background: var(--acu-title-color) !important;\n        background-color: var(--acu-title-color) !important;\n        background-image: none !important;\n        border-radius: 50% !important;\n        border: none !important;\n        margin-top: -5px !important;\n        cursor: pointer !important;\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;\n      }\n\n      /* 滑块轨道 - Webkit */\n      .acu-wrapper input[type="range"]::-webkit-slider-runnable-track,\n      .acu-modal-container input[type="range"]::-webkit-slider-runnable-track,\n      .acu-settings-control input[type="range"]::-webkit-slider-runnable-track {\n        -webkit-appearance: none !important;\n        width: 100% !important;\n        height: 6px !important;\n        background: var(--acu-border) !important;\n        background-color: var(--acu-border) !important;\n        background-image: none !important;\n        border-radius: 3px !important;\n        border: none !important;\n        cursor: pointer !important;\n        box-shadow: none !important;\n      }\n\n      /* 滑块圆点 - Firefox */\n      .acu-wrapper input[type="range"]::-moz-range-thumb,\n      .acu-modal-container input[type="range"]::-moz-range-thumb,\n      .acu-settings-control input[type="range"]::-moz-range-thumb {\n        -moz-appearance: none !important;\n        width: 16px !important;\n        height: 16px !important;\n        background: var(--acu-title-color) !important;\n        background-color: var(--acu-title-color) !important;\n        background-image: none !important;\n        border-radius: 50% !important;\n        border: none !important;\n        cursor: pointer !important;\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2) !important;\n      }\n\n      /* 滑块轨道 - Firefox */\n      .acu-wrapper input[type="range"]::-moz-range-track,\n      .acu-modal-container input[type="range"]::-moz-range-track,\n      .acu-settings-control input[type="range"]::-moz-range-track {\n        -moz-appearance: none !important;\n        width: 100% !important;\n        height: 6px !important;\n        background: var(--acu-border) !important;\n        background-color: var(--acu-border) !important;\n        background-image: none !important;\n        border-radius: 3px !important;\n        border: none !important;\n        cursor: pointer !important;\n        box-shadow: none !important;\n      }\n\n      /* 输入框/选择框 污染防护 */\n      .acu-wrapper input[type="text"],\n      .acu-wrapper input[type="number"],\n      .acu-wrapper input[type="password"],\n      .acu-wrapper select,\n      .acu-wrapper textarea,\n      .acu-modal-container input[type="text"],\n      .acu-modal-container input[type="number"],\n      .acu-modal-container input[type="password"],\n      .acu-modal-container select,\n      .acu-modal-container textarea,\n      .acu-settings-control input[type="text"],\n      .acu-settings-control input[type="number"],\n      .acu-settings-control select {\n        background: var(--acu-card-bg) !important;\n        background-color: var(--acu-card-bg) !important;\n        background-image: none !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 6px !important;\n        color: var(--acu-text-main) !important;\n        font-family: inherit !important;\n        font-size: 13px !important;\n        text-shadow: none !important;\n        box-shadow: none !important;\n        backdrop-filter: none !important;\n        filter: none !important;\n      }\n\n      .acu-wrapper input[type="text"]:hover,\n      .acu-wrapper input[type="number"]:hover,\n      .acu-wrapper select:hover,\n      .acu-modal-container input[type="text"]:hover,\n      .acu-modal-container input[type="number"]:hover,\n      .acu-modal-container select:hover,\n      .acu-settings-control input:hover,\n      .acu-settings-control select:hover {\n        border-color: var(--acu-title-color) !important;\n        background: var(--acu-card-bg) !important;\n        background-color: var(--acu-card-bg) !important;\n        background-image: none !important;\n        box-shadow: 0 0 0 2px var(--acu-title-color-bg) !important;\n      }\n\n      .acu-wrapper input[type="text"]:focus,\n      .acu-wrapper input[type="number"]:focus,\n      .acu-wrapper select:focus,\n      .acu-modal-container input[type="text"]:focus,\n      .acu-modal-container input[type="number"]:focus,\n      .acu-modal-container select:focus,\n      .acu-settings-control input:focus,\n      .acu-settings-control select:focus {\n        border-color: var(--acu-title-color) !important;\n        background: var(--acu-card-bg) !important;\n        background-color: var(--acu-card-bg) !important;\n        background-image: none !important;\n        box-shadow: 0 0 0 2px var(--acu-title-color-bg) !important;\n        outline: none !important;\n      }\n\n      /* 选择框下拉箭头 */\n      .acu-wrapper select,\n      .acu-modal-container select,\n      .acu-settings-control select {\n        -webkit-appearance: none !important;\n        -moz-appearance: none !important;\n        appearance: none !important;\n        padding-right: 30px !important;\n        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") !important;\n        background-repeat: no-repeat !important;\n        background-position: right 8px center !important;\n        background-size: 16px !important;\n      }\n\n      /* 滚动条 污染防护 */\n      .acu-wrapper::-webkit-scrollbar,\n      .acu-wrapper *::-webkit-scrollbar,\n      .acu-modal-container::-webkit-scrollbar,\n      .acu-modal-container *::-webkit-scrollbar {\n        width: 6px !important;\n        height: 6px !important;\n      }\n\n      .acu-wrapper::-webkit-scrollbar-track,\n      .acu-wrapper *::-webkit-scrollbar-track,\n      .acu-modal-container::-webkit-scrollbar-track,\n      .acu-modal-container *::-webkit-scrollbar-track {\n        background: transparent !important;\n        background-color: transparent !important;\n      }\n\n      .acu-wrapper::-webkit-scrollbar-thumb,\n      .acu-wrapper *::-webkit-scrollbar-thumb,\n      .acu-modal-container::-webkit-scrollbar-thumb,\n      .acu-modal-container *::-webkit-scrollbar-thumb {\n        background: var(--acu-border) !important;\n        background-color: var(--acu-border) !important;\n        background-image: none !important;\n        border-radius: 3px !important;\n        border: none !important;\n        box-shadow: none !important;\n      }\n\n      .acu-wrapper::-webkit-scrollbar-thumb:hover,\n      .acu-wrapper *::-webkit-scrollbar-thumb:hover,\n      .acu-modal-container::-webkit-scrollbar-thumb:hover,\n      .acu-modal-container *::-webkit-scrollbar-thumb:hover {\n        background: var(--acu-text-sub) !important;\n        background-color: var(--acu-text-sub) !important;\n      }\n\n      /* 文本元素 污染防护 - 必须同时重置 font-family */\n      .acu-wrapper,\n      .acu-wrapper p,\n      .acu-wrapper div,\n      .acu-wrapper span,\n      .acu-wrapper label,\n      .acu-wrapper li,\n      .acu-wrapper a,\n      .acu-wrapper button,\n      .acu-wrapper th,\n      .acu-wrapper td,\n      .acu-modal-container,\n      .acu-modal-container p,\n      .acu-modal-container div,\n      .acu-modal-container span,\n      .acu-modal-container label,\n      .acu-modal-container li,\n      .acu-modal-container a,\n      .acu-modal-container button,\n      .acu-modal-container th,\n      .acu-modal-container td {\n        font-family: var(--acu-font-family) !important;\n        font-size: var(--acu-font-size, 13px) !important;\n        text-shadow: none !important;\n        line-height: 1.5 !important;\n      }\n\n      /* 普通文本颜色 - 特定选择器 */\n      .acu-settings-label,\n      .acu-card-label,\n      .acu-grid-label,\n      .acu-full-label,\n      .acu-wrapper .acu-card-value,\n      .acu-wrapper .acu-grid-value,\n      .acu-modal-container .acu-modal-body {\n        color: var(--acu-text-main) !important;\n        font-size: var(--acu-font-size, 13px) !important;\n      }\n\n      /* 次要文本颜色 */\n      .acu-wrapper .hint,\n      .acu-wrapper .acu-text-sub,\n      .acu-modal-container .hint,\n      .acu-modal-container .acu-text-sub,\n      .acu-settings-label .hint {\n        color: var(--acu-text-sub) !important;\n        font-size: 11px !important;\n      }\n\n      /* 标题 - 使用 --acu-title-color 防止酒馆污染 */\n      .acu-wrapper h1,\n      .acu-wrapper h2,\n      .acu-wrapper h3,\n      .acu-wrapper h4,\n      .acu-wrapper h5,\n      .acu-wrapper h6,\n      .acu-modal-container h1,\n      .acu-modal-container h2,\n      .acu-modal-container h3,\n      .acu-modal-container h4,\n      .acu-modal-container h5,\n      .acu-modal-container h6 {\n        color: var(--acu-title-color) !important;\n        text-shadow: none !important;\n        font-weight: 600 !important;\n      }\n\n      /* 弹窗标题 - 使用 --acu-text-main */\n      .acu-settings-title,\n      .acu-modal-title {\n        color: var(--acu-text-main) !important;\n        text-shadow: none !important;\n        font-weight: 600 !important;\n      }\n\n      /* 面板标题和行标题 - 使用 --acu-title-color + 用户字体 */\n      .acu-panel-title,\n      .acu-editable-title,\n      .acu-card-label,\n      .acu-grid-label,\n      .acu-full-label {\n        color: var(--acu-title-color) !important;\n        font-family: var(--acu-font-family) !important;\n        text-shadow: none !important;\n        font-weight: 600 !important;\n      }\n\n      /* Tab 按钮 - 精确保护 */\n      .acu-tab-btn,\n      .acu-tab-btn span,\n      .acu-nav-btn,\n      .acu-action-btn {\n        font-family: var(--acu-font-family) !important;\n        font-size: var(--acu-font-size, 13px) !important;\n        text-shadow: none !important;\n      }\n\n\n      /* Tab 按钮字体 */\n      .acu-tab-btn,\n      .acu-nav-btn,\n      .acu-action-btn {\n        font-family: var(--acu-font-family) !important;\n        font-size: var(--acu-font-size, 13px) !important;\n        text-shadow: none !important;\n      }\n\n      /* 折叠栏标题 */\n      .acu-settings-section .acu-settings-title,\n      .acu-config-section h4,\n      .acu-collapse-header,\n      .acu-collapse-title,\n      summary {\n        font-family: var(--acu-font-family) !important;\n        font-size: var(--acu-font-size, 13px) !important;\n        color: var(--acu-text-main) !important;\n        text-shadow: none !important;\n      }\n\n      /* 图标字体保护 - Font Awesome 不应被覆盖 */\n      .acu-wrapper i.fa,\n      .acu-wrapper i.fas,\n      .acu-wrapper i.far,\n      .acu-wrapper i.fab,\n      .acu-wrapper .fa,\n      .acu-wrapper .fas,\n      .acu-wrapper .far,\n      .acu-wrapper .fab,\n      .acu-modal-container i.fa,\n      .acu-modal-container i.fas,\n      .acu-modal-container i.far,\n      .acu-modal-container i.fab,\n      .acu-modal-container .fa,\n      .acu-modal-container .fas,\n      .acu-modal-container .far,\n      .acu-modal-container .fab {\n        font-family: 'Font Awesome 6 Free', 'Font Awesome 5 Free', FontAwesome !important;\n      }\n    `;r.value.textContent=c},d=()=>{if(!i.value)return;const e=t.getFullInjectedCSS();i.value.textContent=e,console.info('[ACU Styles] Theme custom styles updated')},m=t=>{const o=a().querySelector('.acu-wrapper');if(!o)return;const n=t||e.config.theme||'retro';ke.forEach(e=>{o.classList.remove(`acu-theme-${e.id}`)}),o.classList.add(`acu-theme-${n}`),console.info(`[ACU Styles] Theme applied: ${n}`)},f=t=>{const o=a().querySelector('.acu-data-display');if(!o)return;const n=t||e.config.layout||'vertical';o.classList.remove('acu-layout-vertical','acu-layout-horizontal'),o.classList.add(`acu-layout-${n}`),console.info(`[ACU Styles] Layout applied: ${n}`)},g=t=>{s(),console.info(`[ACU Styles] Font applied: ${t||e.config.fontFamily}`)},v=()=>{const e=a(),t=o.value;e.getElementById(`${kt}-base-${t}`)?.remove(),e.getElementById(`${kt}-dynamic-${t}`)?.remove(),e.getElementById(`${Ct}-${t}`)?.remove(),e.getElementById(`${Nt}-${t}`)?.remove(),n.value=null,r.value=null,l.value=null,i.value=null,c.value=!1,console.info('[ACU Styles] Styles cleaned up')},b=()=>{c.value?console.info('[ACU Styles] Already initialized'):((()=>{const e=a(),t=`${kt}-base-${o.value}`;if(e.getElementById(t))return console.info('[ACU Styles] Base styles already injected'),void(n.value=e.getElementById(t));const r=e.createElement('style');r.id=t,r.setAttribute('data-source','acu-visualizer'),r.textContent='/*! tailwindcss v4.1.18 | MIT License | https://tailwindcss.com */@import "https://fontsapi.zeoseven.com/69/main/result.css";@import "https://fontsapi.zeoseven.com/3/main/result.css";@import "https://fontsapi.zeoseven.com/442/main/result.css";@import "https://fontsapi.zeoseven.com/256/main/result.css";@import "https://fontsapi.zeoseven.com/482/main/result.css";@import "https://fontsapi.zeoseven.com/446/main/result.css";@import "https://fontsapi.zeoseven.com/570/main/result.css";@import "https://fontsapi.zeoseven.com/292/main/result.css";@import "https://fontsapi.zeoseven.com/7/main/result.css";:root{--acu-neutral-50:#fafafa;--acu-neutral-100:#f5f5f5;--acu-neutral-200:#eeeeee;--acu-neutral-300:#e0e0e0;--acu-neutral-400:#bdbdbd;--acu-neutral-500:#9e9e9e;--acu-neutral-600:#757575;--acu-neutral-700:#616161;--acu-neutral-800:#424242;--acu-neutral-900:#212121;--acu-success:#27ae60;--acu-warning:#f39c12;--acu-danger:#e74c3c;--acu-info:#3498db;--acu-z-ball:2147483646;--acu-z-overlay:2147483647;--acu-z-menu:2147483648;--acu-radius-sm:6px;--acu-radius-md:12px;--acu-radius-lg:16px;--acu-shadow-sm:0 2px 8px rgba(0,0,0,0.1);--acu-shadow-md:0 4px 16px rgba(0,0,0,0.15);--acu-shadow-lg:0 15px 50px rgba(0,0,0,0.3);--acu-transition-fast:0.15s;--acu-transition-normal:0.3s;--acu-transition-slow:0.5s}.acu-wrapper,.acu-theme-retro{--acu-bg-nav:#e6e2d3;--acu-bg-panel:#e6e2d3;--acu-card-bg:#fffef9;--acu-table-head:#efebe4;--acu-table-hover:#f0ebe0;--acu-badge-bg:#efebe4;--acu-input-bg:rgba(255,255,255,0.5);--acu-menu-bg:#fff;--acu-overlay-bg:rgba(94,75,53,0.4);--acu-text-main:#5e4b35;--acu-text-sub:#999;--acu-menu-text:#333;--acu-border:#dcd0c0;--acu-btn-bg:#dcd0c0;--acu-btn-hover:#cbbba8;--acu-btn-active-bg:#8d7b6f;--acu-btn-active-text:#fdfaf5;--acu-shadow:rgba(0,0,0,0.1);--acu-card-width:280px;--acu-font-size:13px;--acu-highlight:#d35400;--acu-title-color-bg:rgba(211,84,0,0.08);--acu-title-color:#d35400;--acu-accent:#d35400;--acu-nav-cols:repeat(auto-fill,minmax(90px,1fr));--acu-text-max-height:80px;--acu-text-overflow:auto;--acu-win-width:400px;--acu-win-left:100px;--acu-win-bottom:100px}.acu-theme-dark{--acu-bg-nav:rgba(43,43,43,0.95);--acu-bg-panel:rgba(37,37,37,0.95);--acu-border:#444;--acu-text-main:#eee;--acu-text-sub:#aaa;--acu-btn-bg:rgba(58,58,58,0.5);--acu-btn-hover:#4a4a4a;--acu-btn-active-bg:#6a5acd;--acu-btn-active-text:#fff;--acu-table-head:rgba(51,51,51,0.8);--acu-table-hover:rgba(58,58,58,0.5);--acu-shadow:rgba(0,0,0,0.6);--acu-card-bg:rgba(45,48,53,0.8);--acu-badge-bg:#3a3f4b;--acu-menu-bg:#333;--acu-menu-text:#eee;--acu-input-bg:rgba(0,0,0,0.3);--acu-overlay-bg:rgba(0,0,0,0.75)}.acu-theme-modern{--acu-bg-nav:#ffffff;--acu-bg-panel:#f8f9fa;--acu-border:#e0e0e0;--acu-text-main:#333;--acu-text-sub:#888;--acu-btn-bg:#f1f3f5;--acu-btn-hover:#e9ecef;--acu-btn-active-bg:#007bff;--acu-btn-active-text:#fff;--acu-table-head:#f8f9fa;--acu-table-hover:#f1f3f5;--acu-shadow:rgba(0,0,0,0.08);--acu-card-bg:#ffffff;--acu-badge-bg:#f1f3f5;--acu-menu-bg:#fff;--acu-menu-text:#333;--acu-input-bg:#ffffff;--acu-overlay-bg:rgba(0,0,0,0.3)}.acu-theme-forest{--acu-bg-nav:#e8f5e9;--acu-bg-panel:#e8f5e9;--acu-border:#c8e6c9;--acu-text-main:#2e7d32;--acu-text-sub:#81c784;--acu-btn-bg:#c8e6c9;--acu-btn-hover:#a5d6a7;--acu-btn-active-bg:#43a047;--acu-btn-active-text:#fff;--acu-table-head:#dcedc8;--acu-table-hover:#f1f8e9;--acu-shadow:rgba(0,0,0,0.1);--acu-card-bg:#ffffff;--acu-badge-bg:#dcedc8;--acu-menu-bg:#fff;--acu-menu-text:#2e7d32;--acu-input-bg:rgba(255,255,255,0.7);--acu-overlay-bg:rgba(46,125,50,0.2)}.acu-theme-ocean{--acu-bg-nav:#e3f2fd;--acu-bg-panel:#e3f2fd;--acu-border:#bbdefb;--acu-text-main:#1565c0;--acu-text-sub:#64b5f6;--acu-btn-bg:#bbdefb;--acu-btn-hover:#90caf9;--acu-btn-active-bg:#1976d2;--acu-btn-active-text:#fff;--acu-table-head:#bbdefb;--acu-table-hover:#e1f5fe;--acu-shadow:rgba(0,0,0,0.15);--acu-card-bg:#ffffff;--acu-badge-bg:#e3f2fd;--acu-menu-bg:#fff;--acu-menu-text:#1565c0;--acu-input-bg:rgba(255,255,255,0.7);--acu-overlay-bg:rgba(21,101,192,0.2)}.acu-theme-cyber{--acu-bg-nav:#000000;--acu-bg-panel:#0a0a0a;--acu-border:#333;--acu-text-main:#00ffcc;--acu-text-sub:#ff00ff;--acu-btn-bg:#1a1a1a;--acu-btn-hover:#333;--acu-btn-active-bg:#ff00ff;--acu-btn-active-text:#fff;--acu-table-head:#111;--acu-table-hover:#1a1a1a;--acu-shadow:0 0 10px rgba(0,255,204,0.3);--acu-card-bg:#050505;--acu-badge-bg:#222;--acu-menu-bg:#111;--acu-menu-text:#00ffcc;--acu-input-bg:#111;--acu-overlay-bg:rgba(0,0,0,0.85)}.acu-theme-purple{--acu-bg-nav:#ede7f6;--acu-bg-panel:#ede7f6;--acu-border:#d1c4e9;--acu-text-main:#4a148c;--acu-text-sub:#7b1fa2;--acu-btn-bg:#d1c4e9;--acu-btn-hover:#b39ddb;--acu-btn-active-bg:#7b1fa2;--acu-btn-active-text:#fff;--acu-table-head:#f5f0fa;--acu-table-hover:#f3e5f5;--acu-shadow:rgba(74,20,140,0.1);--acu-card-bg:#faf8fc;--acu-badge-bg:#f5f0fa;--acu-menu-bg:#faf8fc;--acu-menu-text:#4a148c;--acu-input-bg:rgba(255,255,255,0.8);--acu-overlay-bg:rgba(74,20,140,0.3)}.acu-wrapper[data-font=hanchan]{--acu-font-family:\'HanChanQuanYuan\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=maple]{--acu-font-family:\'Maple Mono\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=huiwen]{--acu-font-family:\'Huiwen-mincho\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=cooper]{--acu-font-family:\'Cooper Zhengkai\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=yffyt]{--acu-font-family:\'YFFYT\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=fusion]{--acu-font-family:\'Fusion Pixel 12px M latin\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=lxgw]{--acu-font-family:\'LXGW WenKai\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=siyuan]{--acu-font-family:\'Source Han Sans SC\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper[data-font=zhuque]{--acu-font-family:\'Zhuque Fangsong (technical preview)\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-hanchan{--acu-font-family:\'HanChanQuanYuan\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-maple{--acu-font-family:\'Maple Mono\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-huiwen{--acu-font-family:\'Huiwen-mincho\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-cooper{--acu-font-family:\'Cooper Zhengkai\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-yffyt{--acu-font-family:\'YFFYT\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-fusion{--acu-font-family:\'Fusion Pixel 12px M latin\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-lxgw{--acu-font-family:\'LXGW WenKai\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-siyuan{--acu-font-family:\'Source Han Sans SC\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-font-zhuque{--acu-font-family:\'Zhuque Fangsong (technical preview)\',-apple-system,BlinkMacSystemFont,\'Segoe UI\',Roboto,sans-serif}.acu-wrapper,.acu-wrapper *,.acu-modal-container,.acu-modal-container *,#acu-ghost-preview{font-family:var(--acu-font-family,Source Han Sans SC,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif)}.acu-text-xs{font-size:11px}.acu-text-sm{font-size:12px}.acu-text-base{font-size:13px}.acu-text-md{font-size:14px}.acu-text-lg{font-size:15px}.acu-text-xl{font-size:16px}.acu-text-2xl{font-size:18px}.acu-text-3xl{font-size:20px}.acu-font-normal{font-weight:400}.acu-font-medium{font-weight:500}.acu-font-semibold{font-weight:600}.acu-font-bold{font-weight:700}.acu-font-extrabold{font-weight:800}.acu-title{font-weight:700;color:var(--acu-title-color);line-height:1.35}.acu-wrapper[data-font=fusion],.acu-font-fusion{-webkit-font-smoothing:none;-moz-osx-font-smoothing:unset;font-smooth:never;text-rendering:optimizeSpeed}:where(.acu-wrapper,.acu-modal-container) input,:where(.acu-wrapper,.acu-modal-container) select,:where(.acu-wrapper,.acu-modal-container) textarea{background:var(--acu-card-bg) !important;background-color:var(--acu-card-bg) !important;background-image:none !important;border:1px solid var(--acu-border) !important;border-radius:6px !important;font-family:inherit !important;font-size:inherit !important;color:var(--acu-text-main) !important;text-shadow:none !important;box-shadow:none !important;backdrop-filter:none !important;filter:none !important;transition:border-color .2s ease !important}:where(.acu-wrapper,.acu-modal-container) input:hover,:where(.acu-wrapper,.acu-modal-container) input:focus,:where(.acu-wrapper,.acu-modal-container) select:hover,:where(.acu-wrapper,.acu-modal-container) select:focus,:where(.acu-wrapper,.acu-modal-container) textarea:hover,:where(.acu-wrapper,.acu-modal-container) textarea:focus{background:var(--acu-card-bg) !important;background-color:var(--acu-card-bg) !important;background-image:none !important;border-color:var(--acu-title-color) !important;box-shadow:0 0 0 2px rgba(var(--acu-title-color-rgb,52,152,219),0.15) !important;outline:none !important}:where(.acu-wrapper,.acu-modal-container) input[type=range]{-webkit-appearance:none !important;appearance:none !important;background:rgba(0,0,0,0) !important;background-color:rgba(0,0,0,0) !important;background-image:none !important;border:none !important;box-shadow:none !important;height:20px !important}:where(.acu-wrapper,.acu-modal-container) input[type=range]::-webkit-slider-thumb{-webkit-appearance:none !important;appearance:none !important;width:16px !important;height:16px !important;background:var(--acu-title-color) !important;background-color:var(--acu-title-color) !important;background-image:none !important;border-radius:50% !important;border:none !important;margin-top:-5px !important;cursor:pointer !important;box-shadow:0 1px 3px rgba(0,0,0,.2) !important}:where(.acu-wrapper,.acu-modal-container) input[type=range]::-webkit-slider-runnable-track{-webkit-appearance:none !important;width:100% !important;height:6px !important;background:var(--acu-border) !important;background-color:var(--acu-border) !important;background-image:none !important;border-radius:3px !important;border:none !important;cursor:pointer !important;box-shadow:none !important}:where(.acu-wrapper,.acu-modal-container) input[type=range]::-moz-range-thumb{-moz-appearance:none !important;width:16px !important;height:16px !important;background:var(--acu-title-color) !important;background-color:var(--acu-title-color) !important;background-image:none !important;border-radius:50% !important;border:none !important;cursor:pointer !important;box-shadow:0 1px 3px rgba(0,0,0,.2) !important}:where(.acu-wrapper,.acu-modal-container) input[type=range]::-moz-range-track{-moz-appearance:none !important;width:100% !important;height:6px !important;background:var(--acu-border) !important;background-color:var(--acu-border) !important;background-image:none !important;border-radius:3px !important;border:none !important;cursor:pointer !important;box-shadow:none !important}:where(.acu-wrapper,.acu-modal-container) select{-webkit-appearance:none !important;appearance:none !important;padding-right:30px !important;background-image:url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23666\'%3E%3Cpath d=\'M7 10l5 5 5-5z\'/%3E%3C/svg%3E") !important;background-repeat:no-repeat !important;background-position:right 8px center !important;background-size:16px !important}:where(.acu-wrapper,.acu-modal-container),:where(.acu-wrapper,.acu-modal-container) p,:where(.acu-wrapper,.acu-modal-container) div,:where(.acu-wrapper,.acu-modal-container) span,:where(.acu-wrapper,.acu-modal-container) label,:where(.acu-wrapper,.acu-modal-container) li,:where(.acu-wrapper,.acu-modal-container) a,:where(.acu-wrapper,.acu-modal-container) button,:where(.acu-wrapper,.acu-modal-container) input,:where(.acu-wrapper,.acu-modal-container) select,:where(.acu-wrapper,.acu-modal-container) textarea,:where(.acu-wrapper,.acu-modal-container) th,:where(.acu-wrapper,.acu-modal-container) td{font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;font-size:inherit;text-shadow:none !important;line-height:1.5}:where(.acu-wrapper,.acu-modal-container)>p,:where(.acu-wrapper,.acu-modal-container)>div:not([class*=title]):not([class*=Title]),:where(.acu-wrapper,.acu-modal-container)>span:not([class*=title]):not([class*=Title]),:where(.acu-wrapper,.acu-modal-container) .acu-settings-label,:where(.acu-wrapper,.acu-modal-container) .acu-card-label,:where(.acu-wrapper,.acu-modal-container) .acu-grid-label,:where(.acu-wrapper,.acu-modal-container) .acu-full-label{color:var(--acu-text-main);font-size:var(--acu-font-size,13px)}:where(.acu-wrapper,.acu-modal-container) .hint,:where(.acu-wrapper,.acu-modal-container) .acu-text-sub,:where(.acu-wrapper,.acu-modal-container) .acu-settings-label .hint{color:var(--acu-text-sub);font-size:11px}:where(.acu-wrapper,.acu-modal-container) h1,:where(.acu-wrapper,.acu-modal-container) h2,:where(.acu-wrapper,.acu-modal-container) h3,:where(.acu-wrapper,.acu-modal-container) h4,:where(.acu-wrapper,.acu-modal-container) h5,:where(.acu-wrapper,.acu-modal-container) h6{color:var(--acu-title-color);font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;text-shadow:none !important;font-weight:600}:where(.acu-wrapper,.acu-modal-container) .acu-modal-title,:where(.acu-wrapper,.acu-modal-container) .acu-settings-title{color:var(--acu-text-main);font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;text-shadow:none !important;font-weight:600}:where(.acu-wrapper,.acu-modal-container) .acu-panel-title,:where(.acu-wrapper,.acu-modal-container) .acu-editable-title,:where(.acu-wrapper,.acu-modal-container) .acu-card-label,:where(.acu-wrapper,.acu-modal-container) .acu-grid-label,:where(.acu-wrapper,.acu-modal-container) .acu-full-label{color:var(--acu-title-color);font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;text-shadow:none !important;font-weight:600}:where(.acu-wrapper,.acu-modal-container) .acu-tab-btn,:where(.acu-wrapper,.acu-modal-container) .acu-tab-btn span,:where(.acu-wrapper,.acu-modal-container) .acu-nav-btn,:where(.acu-wrapper,.acu-modal-container) .acu-action-btn{font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;font-size:var(--acu-font-size,13px);text-shadow:none !important}:where(.acu-wrapper,.acu-modal-container) .acu-toast,:where(.acu-wrapper,.acu-modal-container) .acu-toast-message,:where(.acu-wrapper,.acu-modal-container) .acu-toast span{font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;font-size:var(--acu-font-size,13px);text-shadow:none !important;color:var(--acu-text-main)}:where(.acu-wrapper,.acu-modal-container) .acu-settings-section .acu-settings-title,:where(.acu-wrapper,.acu-modal-container) .acu-config-section h4,:where(.acu-wrapper,.acu-modal-container) .acu-collapse-header,:where(.acu-wrapper,.acu-modal-container) .acu-collapse-title,:where(.acu-wrapper,.acu-modal-container) summary{font-family:var(--acu-font-family,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif) !important;font-size:var(--acu-font-size,13px);color:var(--acu-text-main);text-shadow:none !important}:where(.acu-wrapper,.acu-modal-container) i.fa,:where(.acu-wrapper,.acu-modal-container) i.fas,:where(.acu-wrapper,.acu-modal-container) i.far,:where(.acu-wrapper,.acu-modal-container) i.fab,:where(.acu-wrapper,.acu-modal-container) .fa,:where(.acu-wrapper,.acu-modal-container) .fas,:where(.acu-wrapper,.acu-modal-container) .far,:where(.acu-wrapper,.acu-modal-container) .fab{font-family:"Font Awesome 6 Free","Font Awesome 5 Free",FontAwesome !important;font-weight:900 !important;font-style:normal !important;font-variant:normal !important;line-height:1 !important;text-rendering:auto !important;-webkit-font-smoothing:antialiased !important}.acu-wrapper,.acu-modal-container,.acu-wrapper *,.acu-modal-container *{scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-wrapper::-webkit-scrollbar,.acu-modal-container::-webkit-scrollbar,.acu-wrapper *::-webkit-scrollbar,.acu-modal-container *::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-wrapper::-webkit-scrollbar-track,.acu-modal-container::-webkit-scrollbar-track,.acu-wrapper *::-webkit-scrollbar-track,.acu-modal-container *::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important;background-color:rgba(0,0,0,0) !important}.acu-wrapper::-webkit-scrollbar-thumb,.acu-modal-container::-webkit-scrollbar-thumb,.acu-wrapper *::-webkit-scrollbar-thumb,.acu-modal-container *::-webkit-scrollbar-thumb{background:var(--acu-border) !important;background-color:var(--acu-border) !important;background-image:none !important;border-radius:3px !important;border:none !important;box-shadow:none !important}.acu-wrapper::-webkit-scrollbar-thumb:hover,.acu-modal-container::-webkit-scrollbar-thumb:hover,.acu-wrapper *::-webkit-scrollbar-thumb:hover,.acu-modal-container *::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important;background-color:var(--acu-text-sub) !important}.acu-wrapper::-webkit-scrollbar-corner,.acu-modal-container::-webkit-scrollbar-corner,.acu-wrapper *::-webkit-scrollbar-corner,.acu-modal-container *::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-wrapper,.acu-wrapper *,.acu-wrapper *::before,.acu-wrapper *::after{box-sizing:border-box}.acu-wrapper{font-family:var(--acu-font-family,Source Han Sans SC,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif);font-size:var(--acu-font-size,13px);color:var(--acu-text-main);line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.acu-wrapper{scrollbar-width:thin !important;scrollbar-color:var(--acu-title-color,var(--acu-border)) rgba(0,0,0,0) !important}.acu-wrapper::-webkit-scrollbar,.acu-wrapper *::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-wrapper::-webkit-scrollbar-track,.acu-wrapper *::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-wrapper::-webkit-scrollbar-thumb,.acu-wrapper *::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:3px !important}.acu-wrapper::-webkit-scrollbar-thumb:hover,.acu-wrapper *::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-wrapper::-webkit-scrollbar-corner,.acu-wrapper *::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-wrapper *{scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-panel-content{scrollbar-width:thin !important;scrollbar-color:var(--acu-title-color) rgba(0,0,0,0) !important}.acu-panel-content::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-panel-content::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-panel-content::-webkit-scrollbar-thumb{background-color:var(--acu-title-color) !important;border-radius:3px !important}.acu-panel-content::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-modal-container{scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-modal-container::-webkit-scrollbar,.acu-modal-container *::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-modal-container::-webkit-scrollbar-track,.acu-modal-container *::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-modal-container::-webkit-scrollbar-thumb,.acu-modal-container *::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:3px !important}.acu-modal-container::-webkit-scrollbar-thumb:hover,.acu-modal-container *::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-modal-container::-webkit-scrollbar-corner,.acu-modal-container *::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-modal-container *{scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-wrapper ::selection{background:var(--acu-title-color);color:#fff}.acu-wrapper ::-moz-selection{background:var(--acu-title-color);color:#fff}#acu-parent-container{position:fixed !important;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;z-index:var(--acu-z-overlay);pointer-events:none !important;display:flex;flex-direction:column-reverse;justify-content:flex-start}#acu-parent-container .acu-wrapper{position:absolute !important;width:var(--acu-win-width,600px) !important;left:var(--acu-win-left,50%) !important;bottom:var(--acu-win-bottom,50%) !important;max-width:98vw;pointer-events:none;display:flex;flex-direction:column-reverse;transform-origin:bottom center;will-change:transform;transition:none !important;touch-action:none}.acu-hidden{display:none !important}.acu-grid-value,.acu-full-value,.acu-card-value,.acu-editable-title,.acu-grid-label,.acu-full-label,.acu-card-label{user-select:text !important;-webkit-user-select:text !important;cursor:text}.acu-app{font-family:var(--acu-font-family,"Microsoft YaHei",sans-serif);font-size:var(--acu-font-size,13px);color:var(--acu-text-main,#333);position:relative;z-index:2147483640}.acu-no-data{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;color:var(--acu-text-muted,#999);text-align:center}.acu-no-data i{font-size:48px;margin-bottom:16px;opacity:.5}.acu-no-data p{margin:0;font-size:var(--acu-font-size,13px)}@keyframes acu-shake{0%,100%{transform:rotate(0deg)}25%{transform:rotate(10deg)}50%{transform:rotate(0deg)}75%{transform:rotate(-10deg)}}@keyframes acu-shake-x{0%,100%{transform:translateX(0)}10%,30%,50%,70%,90%{transform:translateX(-4px)}20%,40%,60%,80%{transform:translateX(4px)}}@keyframes acu-fade-in{from{opacity:0}to{opacity:1}}@keyframes acu-fade-out{from{opacity:1}to{opacity:0}}@keyframes acu-pop-up{from{opacity:0;transform:scale(0.9) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}@keyframes acu-pop-down{from{opacity:1;transform:scale(1) translateY(0)}to{opacity:0;transform:scale(0.9) translateY(10px)}}@keyframes acu-slide-in-right{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}@keyframes acu-slide-in-left{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}@keyframes acu-slide-in-up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes acu-slide-in-down{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}@keyframes acu-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes acu-bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}.acu-animate-spin{animation:acu-spin 1s linear infinite}.acu-highlight-changed:not(.acu-data-card){color:var(--acu-title-color) !important;font-weight:bold}.acu-save-alert{animation:acu-shake .4s ease-in-out infinite;color:#fff !important;background-color:#e74c3c !important;text-shadow:0 0 5px rgba(231,76,60,.5);border-color:#c0392b !important}.acu-badge-pending{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-15deg);width:80px;height:80px;border:4px solid #e74c3c;border-radius:50%;color:#e74c3c;font-size:20px;font-weight:900;display:flex;align-items:center;justify-content:center;z-index:50;pointer-events:none;opacity:.6;box-shadow:inset 0 0 10px rgba(231,76,60,.2);background:hsla(0,0%,100%,.1)}.acu-wrapper{position:fixed;left:var(--acu-win-left,50%);bottom:var(--acu-win-bottom,50%);width:var(--acu-win-width,400px);transform:translate(-50%,50%);display:flex;flex-direction:column-reverse;z-index:2147483645;pointer-events:auto !important;max-height:100vh;max-height:calc(100vh - var(--acu-win-bottom,50%))}.acu-wrapper.collapsed{display:none}#acu-parent-container{position:fixed !important;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;z-index:2147483647;pointer-events:none !important;display:flex;flex-direction:column-reverse;justify-content:flex-start}#acu-parent-container .acu-wrapper{position:relative;max-width:98vw;pointer-events:auto !important;display:flex;flex-direction:column-reverse;transform-origin:bottom center;will-change:transform;transition:none !important}#acu-parent-container .acu-wrapper{position:absolute !important;width:min(var(--acu-win-width,600px),100vw - 20px) !important;left:var(--acu-win-left,50%) !important;bottom:var(--acu-win-bottom,50%) !important;transform:translate(-50%,50%);touch-action:none;max-height:calc(100vh - var(--acu-win-bottom,50%)) !important}.acu-wrapper.acu-centered-mode{bottom:auto !important;top:50vh !important;left:50vw !important;transform:translate(-50%,-50%) !important;max-height:none !important}.acu-wrapper.acu-centered-mode .acu-data-display{display:none !important}#acu-parent-container .acu-wrapper.acu-centered-mode{position:fixed !important;bottom:auto !important;top:50vh !important;left:50vw !important;transform:translate(-50%,-50%) !important;max-height:none !important}.acu-data-display{order:2;flex:1 1 auto;min-height:150px;margin-bottom:3px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;position:relative;display:none;flex-direction:column;backdrop-filter:blur(8px);box-shadow:0 -5px 25px rgba(0,0,0,.3);width:100%;overscroll-behavior:contain;isolation:isolate;pointer-events:auto !important;overflow:hidden}.acu-data-display.visible{display:flex}.acu-data-display.has-modal{z-index:100;overflow:visible !important}.acu-data-display.acu-layout-horizontal{touch-action:pan-x pan-y !important;overflow:hidden}.acu-data-display.acu-layout-vertical{touch-action:pan-y !important;overflow:hidden}.acu-panel-content{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;padding:0;scrollbar-width:thin;scrollbar-color:var(--acu-title-color) rgba(0,0,0,0)}.acu-panel-content::-webkit-scrollbar{width:6px;height:6px}.acu-panel-content::-webkit-scrollbar-thumb{background-color:var(--acu-title-color);border-radius:3px}.acu-panel-header{flex:0 0 auto;display:flex;justify-content:space-between;align-items:center;padding:4px 12px;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border);border-radius:12px 12px 0 0}.acu-panel-title{font-weight:bold;color:var(--acu-text-main);display:flex;align-items:center;gap:8px;white-space:nowrap;font-size:15px}.acu-header-actions{display:flex;align-items:center;gap:10px}.acu-resize-handle{display:block !important;pointer-events:auto !important;position:absolute;right:-12px;top:0;bottom:0;width:14px;cursor:ew-resize;z-index:2147483650;touch-action:none}.acu-resize-handle::after{content:"";position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--acu-border);opacity:.3;transition:opacity .2s}.acu-resize-handle:hover::after{background:var(--acu-title-color);opacity:1;width:4px;left:0}@media (max-width:768px){.acu-resize-handle{display:none !important;pointer-events:none !important}}.acu-close-btn{background:none;border:none;color:var(--acu-text-sub);cursor:pointer;font-size:16px;padding:4px;transition:color .2s}.acu-close-btn:hover{color:#e74c3c}.acu-layout-horizontal .acu-panel-content{overflow:hidden !important;min-height:150px}.acu-data-display.acu-layout-horizontal{min-height:200px}.acu-data-display.acu-layout-horizontal.visible{display:flex;flex-direction:column}@media (max-width:768px){#acu-btn-pin{display:none !important}.acu-panel-header{padding:4px 10px !important;min-height:38px !important}.acu-panel-title{font-size:13px !important;margin-right:auto}.acu-search-input{height:28px !important;width:80px !important;font-size:12px !important}.acu-search-input:focus{width:120px !important}.acu-nav-container{padding:8px 6px !important;gap:0 !important}.acu-nav-separator{margin:1px 0 !important;opacity:.2}.acu-nav-tabs-area{gap:1px !important}.acu-nav-btn{padding:6px 2px !important;font-size:12px !important;min-height:32px !important}.acu-nav-actions-area{padding-top:2px !important;gap:8px !important;display:flex !important;width:100% !important}.acu-action-btn{width:auto !important;flex:1 !important;height:40px !important;border-radius:8px !important;background:var(--acu-btn-bg);margin:0 !important}.acu-action-btn i{font-size:18px !important}.acu-action-btn:active{background:var(--acu-btn-active-bg);color:#fff}}@media (max-width:700px){.acu-dash-container{grid-template-columns:1fr}}.acu-settings-modal{max-width:720px}.acu-settings-modal .acu-modal-body{padding:0}.acu-settings-section{padding:12px 16px}.acu-settings-section:first-child{padding-top:16px}.acu-settings-title{font-size:13px;font-weight:600;color:var(--acu-text-main);margin-bottom:8px;padding:0 4px;display:flex;align-items:center;gap:8px}.acu-settings-title i{color:var(--acu-text-main);font-size:14px}.acu-settings-group{padding:12px 16px;background:var(--acu-table-head);border-radius:12px;border:none}.acu-settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0}.acu-settings-row:not(:last-child){border-bottom:1px solid var(--acu-border)}.acu-settings-row.column{flex-direction:column;align-items:stretch;gap:8px}.acu-settings-row.column .acu-settings-label{width:100%}.acu-settings-row.column .acu-settings-control{width:100%}.acu-settings-label{font-size:13px;font-weight:600;color:var(--acu-text-main);display:flex;flex-direction:column;gap:2px}.acu-settings-label .hint{font-size:11px;font-weight:400;color:var(--acu-text-sub)}.acu-settings-control{display:flex;align-items:center;gap:8px}.acu-settings-control select{appearance:auto !important;-webkit-appearance:menulist !important;-moz-appearance:menulist !important;padding:8px 12px !important;background:var(--acu-btn-bg) !important;border:1px solid var(--acu-border) !important;border-radius:6px !important;color:var(--acu-text-main) !important;font-size:13px !important;font-family:inherit !important;cursor:pointer !important;outline:none !important;box-shadow:none !important;min-height:auto !important;height:auto !important;line-height:normal !important;margin:0 !important}.acu-settings-control select:focus{border-color:var(--acu-title-color) !important}.acu-settings-control select option{background:var(--acu-bg-panel) !important;color:var(--acu-text-main) !important}.acu-settings-control input[type=text],.acu-settings-control input[type=number]{padding:8px 12px !important;background:var(--acu-btn-bg) !important;border:1px solid var(--acu-border) !important;border-radius:6px !important;color:var(--acu-text-main) !important;font-size:13px !important;font-family:inherit !important;outline:none !important}.acu-settings-control input[type=text]:focus,.acu-settings-control input[type=number]:focus{border-color:var(--acu-title-color) !important}.acu-settings-control input[type=color]{width:32px !important;height:32px !important}.acu-settings-control input[type=range]{-webkit-appearance:none;appearance:none;height:6px;background:var(--acu-border);border-radius:3px;outline:none;cursor:pointer}.acu-settings-control input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;cursor:pointer;-webkit-transition:transform .2s;transition:transform .2s;filter:none !important}.acu-settings-control input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2)}.acu-settings-control input[type=range]::-moz-range-thumb{width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;border:none;cursor:pointer;filter:none !important}.acu-nav-row{cursor:pointer;transition:background .2s ease}.acu-nav-row:hover{background:var(--acu-table-hover)}.acu-nav-row:active{opacity:.8}.acu-nav-row .acu-settings-control i.fa-chevron-right{font-size:12px;color:var(--acu-text-sub)}.acu-modal-back{display:flex;align-items:center;justify-content:center;width:32px;height:32px;margin-right:8px;background:rgba(0,0,0,0);border:none;border-radius:6px;cursor:pointer;color:inherit;opacity:.7;transition:all .2s ease}.acu-modal-back:hover{opacity:1;background:var(--acu-hover-bg,rgba(255,255,255,0.1))}.acu-modal-title{font-size:16px;font-weight:bold}.acu-bottom-spacer{height:calc(30px + var(--acu-safe-area-bottom,50px));padding-bottom:var(--acu-safe-area-bottom,50px);width:100%;text-align:center;color:var(--acu-text-sub,#999);font-size:10px;display:flex;align-items:center;justify-content:center;opacity:.5;flex-shrink:0}.acu-floating-ball-vue{--ball-size:50px;--ball-border-color:#ffffff;--ball-border-color-rgba:rgba(255,255,255,0.4);--ball-bg-color:rgba(255,255,255,0.25);position:fixed;width:var(--ball-size);height:var(--ball-size);font-size:calc(var(--ball-size)*.4);background:var(--ball-bg-color);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:2px solid var(--ball-border-color-rgba);border-radius:50%;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:2147483647;display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:none;color:var(--acu-text-main,#333);-webkit-user-select:none;user-select:none;transition:all .3s cubic-bezier(0.18,0.89,0.32,1.28);pointer-events:auto !important;overflow:visible;box-sizing:border-box}.acu-floating-ball-vue i{display:flex;align-items:center;justify-content:center;width:100%;height:100%;line-height:1;position:relative;z-index:2}.acu-floating-ball-vue .ball-emoji{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:calc(var(--ball-size)*.46);position:relative;z-index:2}.acu-floating-ball-vue img{width:100%;height:100%;object-fit:cover;border-radius:50%;pointer-events:none;position:relative;z-index:2}.acu-floating-ball-vue .ball-image{width:100%;height:100%;border-radius:50%;pointer-events:none;position:relative;z-index:2}.acu-floating-ball-vue .ball-image.ball-image-invert{filter:invert(1)}.acu-floating-ball-vue:active{transform:scale(0.9);background:var(--ball-bg-color);filter:brightness(1.2)}.acu-floating-ball-vue.has-issues{animation:pulse-warning 1.5s ease-in-out infinite;border-color:rgba(245,108,108,.6);box-shadow:0 4px 15px rgba(245,108,108,.4)}.acu-floating-ball-vue.has-issues .acu-issue-badge{position:absolute;top:-4px;right:-4px;width:18px;height:18px;background:#f56c6c;border-radius:50%;font-size:12px;font-weight:bold;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(245,108,108,.5);animation:badge-bounce 1s ease-in-out infinite}.acu-floating-ball-vue.has-issues:hover{box-shadow:0 6px 20px rgba(245,108,108,.5)}.acu-floating-ball-vue.docked{left:0 !important;width:20px !important;height:50px !important;border-radius:0 8px 8px 0 !important;opacity:.3;background:#000;border:1px solid #666;border-left:none;font-size:0 !important;transform:none !important}.acu-floating-ball-vue.docked::after{content:"›";color:#fff;font-size:16px;font-weight:bold;display:block}.acu-floating-ball-vue.docked:hover,.acu-floating-ball-vue.docked:active{opacity:.8;width:30px !important}.acu-floating-ball-vue.docked .acu-issue-badge{display:none}@keyframes pulse-warning{0%,100%{box-shadow:0 4px 15px rgba(245,108,108,.4),0 0 0 0 rgba(245,108,108,.4)}50%{box-shadow:0 4px 15px rgba(245,108,108,.4),0 0 0 10px rgba(245,108,108,0)}}@keyframes badge-bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}@keyframes acu-notify-ripple-1{0%{transform:scale(1);opacity:.8}100%{transform:scale(2.5);opacity:0}}@keyframes acu-notify-ripple-2{0%{transform:scale(1);opacity:.6}100%{transform:scale(2.2);opacity:0}}@keyframes acu-notify-ripple-3{0%{transform:scale(1);opacity:.4}100%{transform:scale(1.9);opacity:0}}.acu-floating-ball-vue.ai-notify.anim-ripple{border-color:var(--ball-border-color-rgba)}.acu-floating-ball-vue.ai-notify.anim-ripple::before,.acu-floating-ball-vue.ai-notify.anim-ripple::after{content:"";position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--ball-border-color,#90cdf4);animation:acu-notify-ripple-1 1.5s ease-out infinite;pointer-events:none}.acu-floating-ball-vue.ai-notify.anim-ripple::after{animation:acu-notify-ripple-2 1.5s ease-out .5s infinite}@keyframes acu-arc-rotate{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@keyframes acu-arc-flash-1{0%,90%,100%{opacity:0}92%,95%{opacity:1}}@keyframes acu-arc-flash-2{0%,80%,100%{opacity:0}82%,88%{opacity:1}}.acu-floating-ball-vue.ai-notify.anim-arc{border-color:var(--ball-border-color-rgba)}.acu-floating-ball-vue.ai-notify.anim-arc::before{content:"";position:absolute;width:120%;height:120%;border-radius:50%;background:radial-gradient(circle at 20% 0%,var(--ball-border-color,#a29bfe) 0%,transparent 30%),radial-gradient(circle at 80% 100%,var(--ball-border-color,#a29bfe) 0%,transparent 30%);animation:acu-arc-rotate 1s linear infinite,acu-arc-flash-1 .3s ease infinite;opacity:.8;pointer-events:none}.acu-floating-ball-vue.ai-notify.anim-arc::after{content:"";position:absolute;width:130%;height:130%;border-radius:50%;background:radial-gradient(circle at 50% 0%,var(--ball-border-color,#74b9ff) 0%,transparent 25%),radial-gradient(circle at 50% 100%,var(--ball-border-color,#74b9ff) 0%,transparent 25%);animation:acu-arc-rotate 1.5s linear infinite reverse,acu-arc-flash-2 .5s ease infinite;opacity:.6;pointer-events:none}.acu-ball-preview{--ball-size:56px;--ball-border-color:#90cdf4;--ball-border-color-rgba:rgba(144,205,244,1);--ball-bg-color:rgba(43,43,43,1);width:var(--ball-size);height:var(--ball-size);font-size:calc(var(--ball-size)*.46);background:var(--ball-bg-color);border:2px solid var(--ball-border-color-rgba);border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;overflow:visible;box-sizing:border-box;transition:all .2s ease}.acu-ball-preview i{position:relative;z-index:2}.acu-ball-preview img{width:100%;height:100%;object-fit:cover;border-radius:50%;position:relative;z-index:2}.acu-ball-preview.p-anim-ripple{border-color:var(--ball-border-color-rgba)}.acu-ball-preview.p-anim-ripple::before,.acu-ball-preview.p-anim-ripple::after{content:"";position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--ball-border-color);animation:acu-notify-ripple-1 1.5s ease-out infinite;pointer-events:none}.acu-ball-preview.p-anim-ripple::after{animation:acu-notify-ripple-2 1.5s ease-out .5s infinite}.acu-ball-preview.p-anim-arc{border-color:var(--ball-border-color-rgba)}.acu-ball-preview.p-anim-arc::before{content:"";position:absolute;width:120%;height:120%;border-radius:50%;background:radial-gradient(circle at 20% 0%,var(--ball-border-color) 0%,transparent 30%),radial-gradient(circle at 80% 100%,var(--ball-border-color) 0%,transparent 30%);animation:acu-arc-rotate 1s linear infinite,acu-arc-flash-1 .3s ease infinite;opacity:.8;pointer-events:none}.acu-ball-preview.p-anim-arc::after{content:"";position:absolute;width:130%;height:130%;border-radius:50%;background:radial-gradient(circle at 50% 0%,var(--ball-border-color) 0%,transparent 25%),radial-gradient(circle at 50% 100%,var(--ball-border-color) 0%,transparent 25%);animation:acu-arc-rotate 1.5s linear infinite reverse,acu-arc-flash-2 .5s ease infinite;opacity:.6;pointer-events:none}.acu-ball-preview.p-notify{animation:acu-notify-glow 2s infinite ease-in-out}@keyframes acu-notify-glow{0%,100%{box-shadow:0 0 5px var(--ball-border-color,#55efc4);border-color:var(--ball-border-color,#55efc4)}50%{box-shadow:0 0 25px var(--ball-border-color,#55efc4);border-color:var(--ball-border-color,#55efc4)}}.acu-tab-bar{width:100%}.acu-nav-container{position:relative;order:1;flex:0 0 auto;display:flex;flex-direction:column;gap:0;padding:6px 10px;background:var(--acu-bg-nav);border-top:1px solid var(--acu-border);border-radius:14px 14px 0 0;backdrop-filter:blur(5px);box-shadow:0 -4px 20px rgba(0,0,0,.2);transition:transform .2s;touch-action:pan-y;width:100%;pointer-events:auto !important;cursor:move;z-index:10}.acu-nav-container.editing-order .acu-nav-btn{border:1px dashed #f0ad4e;cursor:grab;opacity:.8}.acu-nav-tabs-area{display:grid;grid-template-columns:var(--acu-nav-cols,repeat(auto-fill,minmax(110px,1fr)));gap:3px;width:100%}.acu-nav-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:6px;padding:5px 3px;border:1px solid rgba(0,0,0,0);border-radius:8px;background:var(--acu-btn-bg);color:var(--acu-text-main);font-weight:600;font-size:13px;cursor:pointer;transition:all .2s ease;-webkit-user-select:none;user-select:none;text-align:center;white-space:nowrap;overflow:hidden}.acu-nav-btn span{overflow:hidden;text-overflow:ellipsis}.acu-nav-btn:hover{background:var(--acu-btn-hover);transform:translateY(-2px)}.acu-nav-btn.active{background:var(--acu-btn-active-bg);color:var(--acu-btn-active-text);box-shadow:0 2px 6px rgba(0,0,0,.15)}.acu-nav-separator{width:100%;height:1px;border-top:1px dashed var(--acu-border);margin:5px 0;opacity:.6}.acu-nav-actions-area{position:relative;display:flex;width:100%;justify-content:space-between;align-items:stretch;background:rgba(0,0,0,0);padding-top:0;gap:8px}.acu-order-controls{display:none;width:100%;text-align:center;background:var(--acu-table-head);padding:5px;margin-bottom:5px;border-radius:4px;border:1px dashed var(--acu-border)}.acu-order-controls.visible{display:block}.acu-order-controls{font-size:12px;color:var(--acu-text-sub)}.acu-order-done-btn{background:var(--acu-btn-active-bg);color:var(--acu-btn-active-text);border:none;border-radius:4px;padding:2px 8px;margin-left:8px;cursor:pointer;font-size:12px;transition:all .2s}.acu-order-done-btn:hover{opacity:.9;transform:scale(1.05)}.acu-nav-btn.drag-handle{border:1px dashed #f0ad4e;cursor:grab;opacity:.8}.acu-nav-btn.drag-handle:active{cursor:grabbing}.acu-nav-btn.dragging{opacity:.5;border:2px solid var(--acu-title-color)}.acu-nav-btn.has-ai-changes{border:2px solid var(--acu-highlight-ai,#3498db)}.acu-nav-btn.has-ai-changes:hover{border-color:var(--acu-highlight-ai,#3498db)}.acu-nav-btn.has-ai-changes.active{border-color:var(--acu-highlight-ai,#3498db)}.acu-nav-btn.has-issues{border:2px solid #f56c6c;animation:tab-issue-pulse 2s ease-in-out infinite;position:relative}.acu-nav-btn.has-issues::before{content:"";position:absolute;top:-3px;right:-3px;width:8px;height:8px;background:#f56c6c;border-radius:50%;box-shadow:0 0 4px rgba(245,108,108,.6)}.acu-nav-btn.has-issues:hover{border-color:#f56c6c;box-shadow:0 2px 8px rgba(245,108,108,.3)}.acu-nav-btn.has-issues.active{border-color:#f56c6c;box-shadow:0 2px 10px rgba(245,108,108,.4)}@keyframes tab-issue-pulse{0%,100%{border-color:#f56c6c}50%{border-color:rgba(245,108,108,.4)}}.acu-action-btn{display:flex;align-items:center;justify-content:center;flex:1;min-width:36px;height:36px;border:1px solid var(--acu-border);border-radius:8px;background:var(--acu-btn-bg);color:var(--acu-text-main);font-size:14px;cursor:pointer;transition:all .2s ease}.acu-action-btn:hover{background:var(--acu-btn-hover);transform:translateY(-1px)}.acu-action-btn:active{transform:translateY(0)}.acu-action-btn.refreshing i{animation:acu-spin 1s linear infinite}.acu-action-btn.has-changes{animation:acu-pulse 1.5s ease-in-out infinite;border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-action-btn.acu-btn-danger{color:#e74c3c}.acu-action-btn.acu-btn-danger:hover{background:rgba(231,76,60,.1);border-color:#e74c3c}.acu-action-btn.acu-btn-toggle.active{background:var(--acu-btn-hover);color:var(--acu-title-color);border-color:var(--acu-title-color)}@keyframes acu-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes acu-pulse{0%,100%{box-shadow:0 0 0 0 rgba(var(--acu-title-color-rgb,211,84,0),0.4)}50%{box-shadow:0 0 0 8px rgba(var(--acu-title-color-rgb,211,84,0),0)}}.acu-data-card{background:var(--acu-card-bg);border:none;box-shadow:0 2px 8px var(--acu-shadow);border-radius:12px;transition:all .25s ease;display:flex;flex-direction:column;position:relative;-webkit-user-select:none;user-select:none;touch-action:pan-x pan-y;overflow-y:auto;overflow-x:hidden;overscroll-behavior:contain;scrollbar-width:thin;scrollbar-color:hsla(0,0%,100%,.2) rgba(0,0,0,0)}.acu-data-card::-webkit-scrollbar{width:4px;height:4px}.acu-data-card::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-data-card::-webkit-scrollbar-thumb{background:hsla(0,0%,100%,.2);border-radius:2px;-webkit-transition:background .2s ease;transition:background .2s ease}.acu-data-card::-webkit-scrollbar-thumb:hover{background:hsla(0,0%,100%,.4)}.acu-data-card.acu-editing-lock{border-color:var(--acu-title-color) !important;box-shadow:0 0 0 1px var(--acu-title-color) !important;z-index:5;-webkit-user-select:text !important;user-select:text !important;touch-action:none !important}@keyframes acu-shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}.acu-grid-value,.acu-full-value,.acu-card-value,.acu-editable-title,.acu-grid-label,.acu-full-label,.acu-card-label{user-select:text !important;-webkit-user-select:text !important;cursor:text}.acu-layout-vertical .acu-card-grid{display:flex;flex-wrap:wrap;justify-content:center;align-items:stretch;gap:14px}.acu-layout-vertical .acu-data-card{flex:0 0 var(--acu-card-width,280px);width:var(--acu-card-width,280px);height:auto;overflow-y:visible;overflow-x:visible;display:flex;flex-direction:column}.acu-layout-vertical .acu-data-card:hover{transform:translateY(-4px);box-shadow:0 8px 25px var(--acu-shadow);z-index:5}.acu-layout-horizontal .acu-card-grid{display:inline-flex;flex-wrap:nowrap;gap:14px;height:auto;align-items:flex-start;padding-bottom:10px;min-width:100%}.acu-layout-horizontal .acu-data-card{flex:0 0 var(--acu-card-width,280px);width:var(--acu-card-width,280px);height:-moz-fit-content;height:fit-content;max-height:98%;overflow-y:auto;white-space:normal;touch-action:pan-x pan-y !important}.acu-card-header{padding:10px 15px;background:rgba(0,0,0,0);border-bottom:1px solid rgba(0,0,0,.05);font-weight:bold;color:var(--acu-title-color);font-size:14px;display:flex;justify-content:center;align-items:center;position:relative;flex:0 0 auto}.acu-editable-title{cursor:pointer;border-bottom:1px dashed rgba(0,0,0,0);transition:all .2s;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:15px;font-weight:800;text-align:center;width:100%;padding:2px 5px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;gap:6px}.acu-editable-title:hover{background:var(--acu-table-hover);color:var(--acu-title-color)}.acu-editable-title.acu-title-locked{background:var(--acu-title-color-bg);border:1px solid var(--acu-title-color)}.acu-title-lock-icon{font-size:10px;opacity:.8;flex-shrink:0}.acu-title-editor{flex:1;min-width:0}.acu-title-editor textarea{width:100%;font-size:15px;font-weight:800;text-align:center;background:hsla(0,0%,100%,.15);border:1px solid var(--acu-title-color,#667eea);border-radius:4px;padding:4px 8px;color:var(--acu-title-color)}.acu-title-editor textarea:focus{outline:none;box-shadow:0 0 0 2px var(--acu-title-color-bg,rgba(102,126,234,0.2))}.acu-card-index{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--acu-text-sub);font-weight:normal;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;opacity:.8}.acu-history-btns{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:flex !important;flex-direction:row !important;flex-wrap:nowrap !important;align-items:center;gap:2px}.acu-undo-trigger,.acu-history-trigger{width:26px;height:26px;min-width:26px;min-height:26px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);border:none;border-radius:50%;color:var(--acu-text-sub);cursor:pointer;font-size:11px;transition:all .2s ease;opacity:.6;padding:0}.acu-undo-trigger:hover,.acu-history-trigger:hover{background:var(--acu-table-hover);color:var(--acu-title-color);opacity:1}.acu-undo-trigger:active,.acu-history-trigger:active{transform:scale(0.9)}@media (max-width:768px){.acu-undo-trigger,.acu-history-trigger{width:32px;height:32px;min-width:32px;min-height:32px;font-size:13px}}.acu-undo-trigger.acu-loading{opacity:.5;cursor:wait;pointer-events:none}.acu-undo-trigger:disabled{opacity:.3;cursor:not-allowed}.acu-row-lock-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:50%;color:var(--acu-text-sub);cursor:pointer;font-size:12px;transition:all .2s ease}.acu-row-lock-btn:hover{background:var(--acu-title-color-bg);color:var(--acu-title-color);border-color:var(--acu-title-color)}.acu-row-lock-btn.acu-row-locked{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color)}.acu-row-lock-btn.acu-row-locked:hover{background:var(--acu-title-color);filter:brightness(1.1)}.acu-card-body{padding:0;display:flex;flex-direction:column;gap:0;font-size:var(--acu-font-size,13px);flex:1}.acu-card-main-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px;flex:1}.acu-grid-item{display:flex;flex-direction:column;gap:2px;padding:5px;border-radius:6px;cursor:pointer;overflow:hidden}.acu-grid-item:hover{background:var(--acu-table-hover)}.acu-grid-label{font-size:11px;color:var(--acu-title-color);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-grid-value{font-size:var(--acu-font-size,13px);color:var(--acu-text-main);font-weight:500;white-space:pre-wrap;word-break:break-word;line-height:1.35}.acu-card-full-area{display:flex;flex-direction:column;gap:8px;padding:0 12px 10px 12px}.acu-full-item{display:flex;flex-direction:column;gap:3px;padding:6px;border-radius:6px;border-top:1px dashed rgba(0,0,0,.05);cursor:pointer}.acu-full-item:hover{background:var(--acu-table-hover)}.acu-full-label{font-size:11px;color:var(--acu-title-color);font-weight:bold}.acu-full-value{font-size:var(--acu-font-size,13px);color:var(--acu-text-main);line-height:1.4;word-break:break-all;white-space:pre-wrap;max-height:var(--acu-text-max-height,80px);overflow-y:var(--acu-text-overflow,auto);scrollbar-width:none}.acu-data-card.acu-style-list .acu-card-body{padding:6px 12px;display:flex;flex-direction:column;gap:0}.acu-data-card.acu-style-list .acu-card-row{display:block !important;padding:6px 0 !important;border-bottom:1px dashed var(--acu-border);cursor:pointer;overflow:hidden}.acu-data-card.acu-style-list .acu-card-row:last-child{border-bottom:none}.acu-data-card.acu-style-list .acu-card-row:hover{background:var(--acu-table-hover)}.acu-data-card.acu-style-list .acu-card-label{float:left !important;clear:left;width:auto !important;margin-right:8px !important;color:var(--acu-title-color);font-size:.9em;font-weight:bold;line-height:1.5}.acu-data-card.acu-style-list .acu-card-value{display:block !important;width:auto !important;margin:0 !important;text-align:left !important;word-break:break-all !important;white-space:pre-wrap !important;line-height:1.5 !important;color:var(--acu-text-main);max-height:var(--acu-text-max-height,80px);overflow-y:var(--acu-text-overflow,auto);scrollbar-width:none}.acu-data-card.acu-style-list .acu-card-value::-webkit-scrollbar{display:none}.acu-data-card.acu-style-list .acu-highlight-changed{display:inline-block;width:auto;line-height:1.4}.acu-cell-changed .acu-grid-value,.acu-cell-changed .acu-full-value,.acu-cell-changed .acu-card-value{font-weight:600}.acu-cell-changed-manual .acu-grid-value,.acu-cell-changed-manual .acu-full-value,.acu-cell-changed-manual .acu-card-value{color:var(--acu-highlight-manual,#d35400) !important;font-weight:600}.acu-cell-changed-ai .acu-grid-value,.acu-cell-changed-ai .acu-full-value,.acu-cell-changed-ai .acu-card-value{color:var(--acu-highlight-ai,#3498db) !important;font-weight:600}.acu-cell-locked{position:relative;background:rgba(231,76,60,.08) !important;border-left:3px solid #e74c3c !important}.acu-cell-locked::after{content:"";font-family:"Font Awesome 6 Free","Font Awesome 5 Free",FontAwesome;font-weight:900;position:absolute;top:4px;right:6px;font-size:10px;color:#e74c3c;opacity:.7;pointer-events:none}.acu-cell-locked .acu-grid-value,.acu-cell-locked .acu-full-value,.acu-cell-locked .acu-card-value{color:#c0392b !important}.acu-cell-locked .acu-grid-label,.acu-cell-locked .acu-full-label,.acu-cell-locked .acu-card-label{color:#e74c3c;font-weight:600}.acu-row-locked{background:rgba(231,76,60,.05) !important;border:1px solid rgba(231,76,60,.3) !important}.acu-row-locked .acu-card-header{background:rgba(231,76,60,.1);color:#c0392b}.acu-row-locked .acu-card-header::after{content:"已锁定";font-family:"Font Awesome 6 Free","Font Awesome 5 Free",FontAwesome,inherit;font-weight:600;font-size:11px;color:#e74c3c;margin-left:8px;opacity:.8}.acu-pull-overlay{display:flex;align-items:center;justify-content:center;overflow:hidden;width:100%;flex:0 0 auto;height:0;transition:height .1s linear}.acu-pull-top{background:rgba(46,204,113,.15);border-bottom:2px dashed #27ae60;color:#27ae60}.acu-pull-bottom{background:rgba(231,76,60,.15);border-top:2px dashed #c0392b;color:#c0392b}.acu-pull-restore{background:rgba(52,152,219,.15) !important;border-top:2px dashed #2980b9 !important;color:#2980b9 !important}.acu-pull-icon{display:flex;flex-direction:column;align-items:center;gap:5px;opacity:.8}.acu-pull-text{font-size:12px;opacity:.9}.acu-swipe-overlay{position:absolute;top:0;bottom:0;width:0;display:flex;align-items:center;justify-content:center;overflow:hidden;pointer-events:none;z-index:10;font-size:18px;font-weight:bold;transition:width .1s linear;white-space:nowrap}.acu-swipe-right{left:0;background:rgba(46,204,113,.2);border-right:2px dashed #27ae60;color:#27ae60}.acu-swipe-left{right:0;background:rgba(231,76,60,.2);border-left:2px dashed #c0392b;color:#c0392b}.acu-swipe-restore{background:rgba(52,152,219,.2) !important;border-left:2px dashed #2980b9 !important;color:#2980b9 !important}.acu-data-table{display:flex;flex-direction:column;flex:1;min-height:0;height:100%;gap:0}.acu-data-table.acu-table-loading{opacity:.6;pointer-events:none}.acu-table-toolbar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--acu-table-head,rgba(0,0,0,0.03));border-bottom:1px solid var(--acu-border,rgba(0,0,0,0.06));border-radius:0;gap:12px;z-index:10;flex-shrink:0}.acu-toolbar-left{display:flex;align-items:center;gap:8px;flex-shrink:0;min-width:0}.acu-table-title{font-weight:600;font-size:calc(var(--acu-font-size,13px) + 1px);color:var(--acu-title-color,var(--acu-text-main,#333));white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-table-count{font-size:calc(var(--acu-font-size,13px) - 2px);color:var(--acu-text-muted,#999);white-space:nowrap}.acu-table-badge{font-size:11px;padding:2px 6px;border-radius:10px;white-space:nowrap}.acu-table-badge.acu-badge-changed{background:rgba(102,126,234,.15);color:var(--acu-title-color,#667eea)}.acu-table-badge.acu-badge-deleting{background:rgba(231,76,60,.15);color:var(--acu-danger,#e74c3c)}.acu-toolbar-right{display:flex;align-items:center;gap:8px;flex-shrink:0}.acu-icon-btn.acu-height-handle{cursor:ns-resize}.acu-icon-btn.acu-close-btn:hover{background:rgba(231,76,60,.1);color:var(--acu-danger,#e74c3c)}.acu-search-input.acu-search-inline{width:100px;padding:4px 8px;border:none;border-radius:var(--acu-radius-sm,4px);background:rgba(0,0,0,0);color:var(--acu-text-main,#333);font-size:calc(var(--acu-font-size,13px) - 1px);outline:none;transition:all .2s}.acu-search-input.acu-search-inline:focus{width:140px;background:var(--acu-btn-hover,rgba(0,0,0,0.05))}.acu-search-input.acu-search-inline::placeholder{color:var(--acu-text-muted,#999)}.acu-search-clear{color:var(--acu-text-muted,#999);cursor:pointer;font-size:11px;flex-shrink:0}.acu-search-clear:hover{color:var(--acu-text-main,#333)}.acu-cards-container{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;overscroll-behavior:contain;padding:12px}.acu-cards-container.acu-view-card{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-content:flex-start;align-items:stretch}.acu-cards-container.acu-view-card>.acu-data-card{flex:0 0 var(--acu-card-width,280px);width:var(--acu-card-width,280px)}.acu-cards-container.acu-view-list{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-content:flex-start;align-items:stretch}.acu-cards-container.acu-view-list>.acu-data-card{flex:0 0 var(--acu-card-width,280px);width:var(--acu-card-width,280px)}.acu-layout-horizontal .acu-cards-container{flex:1 1 0;height:0;min-height:0;display:flex !important;flex-wrap:nowrap !important;gap:14px;align-items:flex-start;justify-content:flex-start;white-space:nowrap;overflow-x:auto !important;overflow-y:hidden !important;touch-action:pan-x pan-y !important;padding:12px;padding-bottom:8px;overscroll-behavior-x:contain}.acu-layout-horizontal .acu-cards-container.acu-view-card,.acu-layout-horizontal .acu-cards-container.acu-view-list{display:flex !important;flex-wrap:nowrap !important}.acu-layout-horizontal .acu-data-card{flex:0 0 var(--acu-card-width,280px) !important;width:var(--acu-card-width,280px) !important;min-width:var(--acu-card-width,280px);align-self:flex-start;height:-moz-fit-content;height:fit-content;max-height:calc(100% - 4px);overflow-y:auto;white-space:normal;touch-action:pan-x pan-y !important;display:flex !important}.acu-layout-horizontal .acu-data-table{height:100%;min-height:200px;display:flex;flex-direction:column;overflow:hidden}.acu-layout-horizontal .acu-table-toolbar{flex-shrink:0;position:relative;z-index:10}.acu-layout-horizontal .acu-pagination-container{flex-shrink:0;position:relative;z-index:10}.acu-layout-horizontal .acu-panel-content{overflow:hidden !important;min-height:150px}.acu-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;color:var(--acu-text-muted,#999);grid-column:1/-1}.acu-empty-state i{font-size:48px;margin-bottom:16px;opacity:.5}.acu-empty-state p{margin:0;font-size:var(--acu-font-size,13px)}.acu-pagination{display:flex;justify-content:center;align-items:center;gap:4px;padding:12px;flex-wrap:wrap}.acu-btn-page{min-width:32px;padding:4px 8px;font-size:calc(var(--acu-font-size,13px) - 1px)}.acu-btn-page.active{font-weight:600}.acu-page-ellipsis{padding:4px 8px;color:var(--acu-text-muted,#999)}.acu-modal-btn{padding:10px 24px;border:none;border-radius:8px;font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .2s ease}.acu-modal-btn.primary{background:var(--acu-title-color);color:#fff}.acu-modal-btn.primary:hover{filter:brightness(1.1);transform:translateY(-1px)}.acu-modal-btn.secondary{background:var(--acu-btn-bg);color:var(--acu-text-main);border:1px solid var(--acu-border)}.acu-modal-btn.secondary:hover{background:var(--acu-btn-hover)}.acu-modal-btn.danger{background:#e74c3c;color:#fff}.acu-modal-btn.danger:hover{background:#c0392b}.acu-modal-btn:disabled{opacity:.5;cursor:not-allowed;transform:none !important}.acu-action-btn{flex:1;height:36px;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border-radius:8px;color:var(--acu-text-sub);cursor:pointer;border:1px solid rgba(0,0,0,0);transition:all .2s;font-size:16px;font-family:inherit;-webkit-user-select:none;user-select:none}.acu-action-btn:hover{background:var(--acu-btn-hover);color:var(--acu-text-main);transform:translateY(-2px);border-color:var(--acu-border)}.acu-tool-btn{padding:6px 12px;font-size:12px;font-family:inherit;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;transition:all .2s ease;white-space:nowrap}.acu-tool-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-tool-btn.small{padding:4px 10px;font-size:11px}.acu-icon-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);border:none;border-radius:4px;color:var(--acu-text-sub);cursor:pointer;transition:all .2s}.acu-icon-btn:hover{background:var(--acu-btn-hover);color:var(--acu-title-color)}.acu-icon-btn.active{background:var(--acu-title-color-bg);color:var(--acu-title-color)}#acu-btn-save-global{color:var(--acu-title-color)}#acu-btn-save-global:hover{background:var(--acu-btn-active-bg);color:var(--acu-btn-active-text)}#acu-btn-save-specific{color:#9b59b6;display:none}.acu-dialog-btn{background:none;border:none;cursor:pointer;font-size:14px;font-weight:bold;display:flex;align-items:center;gap:6px;color:var(--acu-text-sub);transition:color .2s}.acu-page-btn{padding:0;border:1px solid var(--acu-border);background:var(--acu-btn-bg);color:var(--acu-title-color);border-radius:6px;cursor:pointer;font-size:12px;min-width:32px;height:32px;display:flex;align-items:center;justify-content:center;transition:all .2s;-webkit-user-select:none;user-select:none;font-weight:500;flex-shrink:0}.acu-page-btn:not(.disabled):not(.active):hover{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.1)}.acu-page-btn.active{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color);font-weight:bold;cursor:default}.acu-page-btn.disabled{opacity:.5;cursor:not-allowed;background:var(--acu-text-sub)}.acu-page-arrow{width:36px;font-size:14px}.acu-tab-btn{padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;color:var(--acu-text-sub);border-bottom:2px solid rgba(0,0,0,0);transition:all .2s}.acu-tab-btn:hover{color:var(--acu-text-main);background:var(--acu-table-hover);border-radius:4px 4px 0 0}.acu-tab-btn.active{color:var(--acu-title-color);border-bottom-color:var(--acu-title-color)}.acu-action-bar{display:flex;align-items:center;gap:4px;padding:4px}.acu-action-bar .acu-action-btn{flex:none;width:32px;height:32px;padding:0;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);cursor:pointer;border-radius:6px;transition:all .2s ease}.acu-action-bar .acu-action-btn:hover{background:var(--acu-hover-bg,rgba(255,255,255,0.1));color:var(--acu-text-main);transform:none;border-color:rgba(0,0,0,0)}.acu-action-bar .acu-action-btn:active{transform:scale(0.95)}.acu-action-bar .acu-action-btn.acu-btn-active{background:var(--acu-title-color-bg,rgba(52,152,219,0.2));color:var(--acu-title-color,#3498db);border-color:var(--acu-title-color)}.acu-action-bar .acu-action-btn i{font-size:14px}.acu-btn-danger{color:#e74c3c}.acu-btn-danger:hover{background:rgba(231,76,60,.2)}.acu-btn-toggle.active{background:var(--acu-title-color-bg,rgba(52,152,219,0.2)) !important;color:var(--acu-title-color,#3498db) !important;border:1px solid var(--acu-title-color,#3498db) !important;box-shadow:inset 0 0 0 1px rgba(52,152,219,.3)}.has-changes{color:#f39c12;animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}.acu-action-btn-wrapper{position:relative;display:flex;align-items:center;flex:1}.acu-action-bar .acu-action-btn-wrapper{flex:none}.has-secondary{position:relative}.secondary-indicator{position:absolute;top:2px;right:2px;width:6px;height:6px;background:var(--acu-primary-color,#3498db);border-radius:50%;pointer-events:none}.acu-popup-btn{position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:4px;z-index:100;background:var(--acu-panel-bg,#2a2a2a) !important;border:1px solid var(--acu-primary-color,#3498db) !important;box-shadow:0 4px 12px rgba(0,0,0,.3)}.acu-popup-btn:hover{background:var(--acu-primary-color,#3498db) !important;color:#fff !important}.acu-btn-success{color:#27ae60 !important;background:rgba(39,174,96,.15) !important;border:1px solid rgba(39,174,96,.3) !important}.acu-btn-success:hover{background:rgba(39,174,96,.25) !important;color:#2ecc71 !important}.acu-search-input{background:var(--acu-btn-bg);border:1px solid var(--acu-border);color:var(--acu-text-main);padding:2px 2px 3px 22px;border-radius:16px;font-size:12px;width:100px;transition:all .2s}.acu-search-input:focus{width:140px;outline:none;border-color:var(--acu-title-color);background:var(--acu-input-bg)}.acu-search-icon{position:absolute;left:10px;font-size:10px;color:var(--acu-text-sub);pointer-events:none}.acu-inline-editor{width:100%;position:relative;touch-action:manipulation}.acu-edit-textarea{width:100%;min-height:24px;padding:6px 8px;border:2px solid var(--acu-title-color,#667eea);border-radius:var(--acu-radius-sm,4px);background:var(--acu-input-bg,#fff);color:var(--acu-text-main,#333);font-size:var(--acu-font-size,13px);font-family:inherit;line-height:1.5;resize:none;outline:none;box-sizing:border-box;overflow:hidden;user-select:text !important;-webkit-user-select:text !important;touch-action:manipulation}.acu-edit-textarea:focus{box-shadow:0 0 0 3px var(--acu-title-color-bg,rgba(102,126,234,0.2))}.acu-textarea-scrollable{width:100%;min-height:24px;padding:6px 8px;border:2px solid var(--acu-title-color);border-radius:var(--acu-radius-sm);background:var(--acu-input-bg);color:var(--acu-text-main);font-size:var(--acu-font-size);font-family:inherit;line-height:1.5;outline:none;box-sizing:border-box;overflow-y:auto !important;resize:vertical;user-select:text !important;-webkit-user-select:text !important;touch-action:manipulation}.acu-textarea-scrollable:focus{box-shadow:0 0 0 3px var(--acu-title-color-bg)}.acu-editing-lock .acu-inline-editor{touch-action:manipulation}.acu-settings-input{background:var(--acu-input-bg);border:1px solid var(--acu-border);border-radius:6px;padding:8px 12px;color:var(--acu-text-main);font-size:14px;transition:border-color .2s}.acu-settings-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-range-input{-webkit-appearance:none;appearance:none;width:100%;height:6px;background:var(--acu-border);border-radius:3px;outline:none;cursor:pointer}.acu-range-input::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;cursor:pointer;-webkit-transition:transform .2s;transition:transform .2s}.acu-range-input::-webkit-slider-thumb:hover{transform:scale(1.2)}.acu-range-input::-webkit-slider-thumb{filter:none !important}.acu-range-input::-moz-range-thumb{width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;border:none;cursor:pointer;filter:none !important}.acu-select{appearance:auto !important;-webkit-appearance:menulist !important;-moz-appearance:menulist !important;padding:8px 12px !important;background:var(--acu-btn-bg) !important;border:1px solid var(--acu-border) !important;border-radius:6px !important;color:var(--acu-text-main) !important;font-size:13px !important;font-family:inherit !important;cursor:pointer !important;text-align:center !important;text-align-last:center !important;width:auto !important;min-width:80px;outline:none !important;box-shadow:none !important;min-height:auto !important;height:auto !important;line-height:normal !important;margin:0 !important;transition:border-color .2s ease}.acu-select:focus{border-color:var(--acu-title-color) !important}.acu-select option{background:var(--acu-bg-panel) !important;color:var(--acu-text-main) !important;text-align:center}input[type=color]{width:32px;height:32px;padding:0;border:2px solid var(--acu-border) !important;border-radius:6px;cursor:pointer;background:rgba(0,0,0,0);flex-shrink:0;transition:all .2s ease}input[type=color]:hover{border-color:var(--acu-title-color);transform:scale(1.05)}input[type=color]::-webkit-color-swatch-wrapper{padding:2px}input[type=color]::-webkit-color-swatch{border-radius:3px;border:none}input[type=color]::-moz-color-swatch{border-radius:3px;border:none}input[type=color].acu-dashed{border-style:dashed !important}.acu-color-swatch{width:32px !important;height:32px !important}.acu-textarea{width:100%;padding:10px 12px;font-size:12px;line-height:1.5;background:var(--acu-table-head);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);resize:vertical;font-family:inherit}.acu-textarea:focus{outline:none;border-color:var(--acu-title-color)}.acu-textarea::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-search-box{display:flex;align-items:center;gap:12px}.acu-search-input-wrapper{position:relative;display:flex;align-items:center;flex:1;max-width:300px;min-width:180px}.acu-search-box .acu-search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--acu-text-sub,#999);font-size:14px;pointer-events:none;transition:color var(--acu-transition-fast,0.15s);z-index:1}.focused .acu-search-box .acu-search-icon{color:var(--acu-title-color,#d35400)}.acu-search-box .acu-search-input{width:100%;height:36px;padding:0 36px;border:1px solid var(--acu-border,#dcd0c0);border-radius:var(--acu-radius-md,12px);background:var(--acu-input-bg,rgba(255,255,255,0.5));color:var(--acu-text-main,#5e4b35);font-size:var(--acu-font-size,13px);outline:none;transition:border-color var(--acu-transition-fast,0.15s),box-shadow var(--acu-transition-fast,0.15s),background var(--acu-transition-fast,0.15s)}.acu-search-box .acu-search-input::placeholder{color:var(--acu-text-sub,#999);opacity:.7}.acu-search-box .acu-search-input:focus{border-color:var(--acu-title-color,#d35400);box-shadow:0 0 0 3px var(--acu-title-color-bg,rgba(211,84,0,0.08));background:var(--acu-card-bg,#fffef9)}.has-value .acu-search-box .acu-search-input{padding-right:40px}.acu-search-clear{position:absolute;right:8px;display:flex;align-items:center;justify-content:center;width:24px;height:24px;border:none;border-radius:50%;background:var(--acu-badge-bg,#efebe4);color:var(--acu-text-sub,#999);cursor:pointer;transition:background var(--acu-transition-fast,0.15s),color var(--acu-transition-fast,0.15s),transform var(--acu-transition-fast,0.15s)}.acu-search-clear i{font-size:12px}.acu-search-clear:hover{background:var(--acu-danger,#e74c3c);color:#fff;transform:scale(1.1)}.acu-search-clear:active{transform:scale(0.95)}.acu-search-result{font-size:.85em;color:var(--acu-text-sub,#999);white-space:nowrap}.acu-search-result strong{color:var(--acu-title-color,#d35400);font-weight:600}.acu-search-result .no-result{color:var(--acu-warning,#f39c12)}.acu-fade-enter-active,.acu-fade-leave-active{transition:opacity .15s ease,transform .15s ease}.acu-fade-enter-from,.acu-fade-leave-to{opacity:0;transform:scale(0.8)}.acu-fade-enter-to,.acu-fade-leave-from{opacity:1;transform:scale(1)}@media (max-width:480px){.acu-search-box{flex-direction:column;align-items:stretch;gap:8px}.acu-search-input-wrapper{max-width:none;min-width:auto}.acu-search-box .acu-search-input{height:40px}.acu-search-result{text-align:center;font-size:.8em}}.acu-switch{position:relative;display:inline-flex;align-items:center;width:44px;height:24px;cursor:pointer;flex-shrink:0}.acu-switch input[type=checkbox]{opacity:0;width:0;height:0;position:absolute;pointer-events:none}.acu-switch .slider,.acu-switch .acu-switch-slider{position:absolute;inset:0;background:var(--acu-btn-bg);border:none;border-radius:12px;transition:background .2s ease}.acu-switch .slider::after,.acu-switch .acu-switch-slider::after{content:"";position:absolute;top:50%;left:2px;transform:translateY(-50%);width:20px;height:20px;background:var(--acu-text-sub);border:none;border-radius:50%;transition:all .2s ease;box-shadow:0 1px 3px rgba(0,0,0,.15)}.acu-switch input[type=checkbox]:checked+.slider,.acu-switch input[type=checkbox]:checked+.acu-switch-slider{background:var(--acu-title-color)}.acu-switch input[type=checkbox]:checked+.slider::after,.acu-switch input[type=checkbox]:checked+.acu-switch-slider::after{left:calc(100% - 22px);background:#fff}.acu-switch:hover .slider,.acu-switch:hover .acu-switch-slider{opacity:.85}.acu-switch:not(:has(input)){background:var(--acu-btn-bg);border:none;border-radius:12px;transition:background .2s ease}.acu-switch:not(:has(input))::after{content:"";position:absolute;top:50%;left:2px;transform:translateY(-50%);width:20px;height:20px;background:var(--acu-text-sub);border:none;border-radius:50%;transition:all .2s ease;box-shadow:0 1px 3px rgba(0,0,0,.15)}.acu-switch:not(:has(input)).active{background:var(--acu-title-color)}.acu-switch:not(:has(input)).active::after{left:calc(100% - 22px);background:#fff}.acu-switch:not(:has(input)):hover{opacity:.9}.acu-badge,.acu-badge-default,.acu-badge-female,.acu-badge-male,.acu-badge-pill,.acu-badge-tag{display:inline-block;padding:2px 8px;border-radius:var(--acu-radius-sm,4px);font-size:calc(var(--acu-font-size,13px) - 1px);background:var(--acu-badge-bg,rgba(0,0,0,0.05));color:var(--acu-text-main,#333);line-height:1.4;word-break:break-word;white-space:pre-wrap}.acu-badge-default,.acu-badge-female,.acu-badge-male{background:rgba(0,0,0,0);padding:0;color:inherit}.acu-badge-pill,.acu-badge-tag{border-radius:999px;padding:2px 10px}.acu-badge-count{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:50%;font-size:11px;font-weight:bold;background:var(--acu-title-color);color:#fff;line-height:1}.acu-badge-primary,.acu-badge-percent,.acu-badge-level,.acu-badge-danger,.acu-badge-warning,.acu-badge-success,.acu-badge-number{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-badge-secondary,.acu-badge-info{background:var(--acu-table-head);color:var(--acu-text-sub)}.acu-badge-outline,.acu-badge-tag{background:rgba(0,0,0,0);border:1px solid var(--acu-border);color:var(--acu-text-sub);padding:1px 7px}.acu-badge-outline-primary{background:rgba(0,0,0,0);border:1px solid var(--acu-title-color);color:var(--acu-title-color);padding:1px 7px}.acu-badge-interactive{cursor:pointer;transition:all .15s ease;-webkit-user-select:none;user-select:none}.acu-badge-interactive:hover{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color)}.acu-badge-interactive:active{transform:translateY(1px)}.acu-stamp-delete{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-15deg);width:80px;height:80px;border:4px solid #e74c3c;border-radius:50%;color:#e74c3c;font-size:20px;font-weight:900;display:flex;align-items:center;justify-content:center;z-index:50;pointer-events:none;opacity:.6;box-shadow:inset 0 0 10px rgba(231,76,60,.2);background:hsla(0,0%,100%,.1)}.acu-badge-default,.acu-badge-female,.acu-badge-male{background:rgba(0,0,0,0)}.acu-pagination-container{flex:0 0 auto;flex-shrink:0;width:100%;display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:var(--acu-bg-panel);border-top:1px solid var(--acu-border);z-index:10;box-sizing:border-box}.acu-pagination-container.hidden{display:none !important}.acu-pagination-numbers{display:flex;justify-content:center;align-items:center;gap:4px;flex:1;overflow:hidden}.acu-page-btn{padding:0;border:1px solid var(--acu-border);background:var(--acu-btn-bg);color:var(--acu-title-color);border-radius:5px;cursor:pointer;font-size:11px;min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;transition:all .2s;-webkit-user-select:none;user-select:none;font-weight:500;flex-shrink:0}.acu-page-btn:not(.disabled):not(.active):hover{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color);transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,.1)}.acu-page-btn.active{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color);font-weight:bold;cursor:default}.acu-page-btn.disabled{opacity:.5;cursor:not-allowed;background:var(--acu-text-sub)}.acu-page-arrow{width:30px;font-size:12px}.acu-page-dots{color:var(--acu-text-sub);font-size:11px;padding:0 2px;letter-spacing:1px}.acu-pagination-info{color:var(--acu-text-sub);font-size:11px;white-space:nowrap}.acu-pagination{display:flex;align-items:center;justify-content:center;padding:8px 15px;gap:5px;flex-wrap:nowrap;font-size:var(--acu-font-size,13px);background:var(--acu-bg-panel);border-top:1px solid var(--acu-border);box-sizing:border-box;width:100%;flex:0 0 auto}.acu-pagination .acu-pagination-info{display:flex;align-items:center;gap:4px;color:var(--acu-text-sub,#999);white-space:nowrap}.acu-pagination .acu-pagination-info strong{color:var(--acu-text-main,#5e4b35);font-weight:600}.acu-pagination .acu-pagination-info .acu-pagination-total{opacity:.7;font-size:.9em}.acu-pagination-controls{display:flex;align-items:center;gap:4px}.acu-page-list{display:flex;align-items:center;gap:4px}.acu-pagination .acu-btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--acu-border,#dcd0c0);background:var(--acu-btn-bg,#dcd0c0);color:var(--acu-text-main,#5e4b35);cursor:pointer;transition:background var(--acu-transition-fast,0.15s),border-color var(--acu-transition-fast,0.15s),color var(--acu-transition-fast,0.15s),transform var(--acu-transition-fast,0.15s);-webkit-user-select:none;user-select:none;flex-shrink:0}.acu-pagination .acu-btn:hover:not(:disabled){background:var(--acu-title-color,#5e4b35);color:#fff;border-color:var(--acu-title-color,#5e4b35);transform:translateY(-2px);box-shadow:0 2px 5px rgba(0,0,0,.1)}.acu-pagination .acu-btn:active:not(:disabled){transform:scale(0.95)}.acu-pagination .acu-btn:disabled,.acu-pagination .acu-btn.disabled{opacity:.5;cursor:not-allowed;background:var(--acu-text-sub,#999)}.acu-pagination .acu-btn-icon{width:32px;height:32px;padding:0;border-radius:var(--acu-radius-sm,6px)}.acu-pagination .acu-btn-icon i{font-size:14px}.acu-pagination .acu-btn-page{min-width:32px;height:32px;padding:0;border-radius:6px;font-size:12px;font-weight:500;flex-shrink:0}.acu-pagination .acu-btn-page.active{background:var(--acu-title-color,#5e4b35);border-color:var(--acu-title-color,#5e4b35);color:#fff;font-weight:bold;cursor:default}.acu-pagination .acu-btn-page.active:hover{transform:none}.acu-pagination .acu-btn-page i{font-size:14px}.acu-pagination .acu-btn-sm{height:28px;padding:0 12px;font-size:12px;border-radius:var(--acu-radius-sm,6px)}.acu-page-ellipsis{display:flex;align-items:center;justify-content:center;min-width:24px;height:32px;color:var(--acu-text-sub,#999);font-size:12px;padding:0 2px;letter-spacing:1px;flex-shrink:0}.acu-page-ellipsis i{font-size:12px}.acu-pagination-jump{display:flex;align-items:center;gap:8px;color:var(--acu-text-sub,#999);white-space:nowrap}.acu-pagination-jump .acu-input-sm{width:56px;height:28px;padding:0 8px;border:1px solid var(--acu-border,#dcd0c0);border-radius:var(--acu-radius-sm,6px);background:var(--acu-input-bg,rgba(255,255,255,0.5));color:var(--acu-text-main,#5e4b35);font-size:var(--acu-font-size,13px);text-align:center;outline:none;transition:border-color var(--acu-transition-fast,0.15s),box-shadow var(--acu-transition-fast,0.15s);-moz-appearance:textfield}.acu-pagination-jump .acu-input-sm::-webkit-outer-spin-button,.acu-pagination-jump .acu-input-sm::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.acu-pagination-jump .acu-input-sm:focus{border-color:var(--acu-title-color,#d35400);box-shadow:0 0 0 3px var(--acu-title-color-bg,rgba(211,84,0,0.08))}@media (max-width:480px){.acu-pagination{flex-direction:column;gap:12px}.acu-pagination .acu-pagination-info{order:-1}.acu-pagination-jump{font-size:12px}.acu-pagination-jump .acu-input-sm{width:48px;height:26px}.acu-pagination-jump .acu-btn-sm{height:26px;padding:0 10px}}.acu-dash-container{display:grid;grid-template-columns:1fr 2fr;gap:16px;height:100%;padding:5px;overflow-y:auto;font-size:var(--acu-font-size);touch-action:pan-y}@media (max-width:700px){.acu-dash-container{grid-template-columns:1fr}}.acu-dash-card{background:var(--acu-card-bg);border-radius:12px;border:1px solid var(--acu-border);padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:0 4px 12px var(--acu-shadow);min-height:0;overflow:hidden}.acu-dash-title{font-size:1.2em;font-weight:bold;color:var(--acu-title-color);border-bottom:1px dashed var(--acu-border);padding:0 16px 2px 16px;margin-bottom:0;display:flex;justify-content:space-between;align-items:center;transition:background .2s;gap:8px;-webkit-user-select:none;user-select:none}.acu-dash-title *{font-size:inherit}.acu-dash-title.acu-dash-title-clickable{cursor:pointer}.acu-dash-title.acu-dash-title-clickable:hover{background:var(--acu-table-hover);border-radius:6px 6px 0 0}.acu-dash-collapse-icon{font-size:.7em;color:var(--acu-text-sub);transition:transform .2s;flex-shrink:0;display:flex;align-items:center;justify-content:center;height:28px}.acu-dash-title-text{display:flex;align-items:center;gap:8px;cursor:pointer;padding:2px 6px;margin:-2px -6px;border-radius:4px;transition:color .2s,background .2s}.acu-dash-title-text i{font-size:.9em}.acu-dash-title-clickable .acu-dash-title-text:hover{color:var(--acu-highlight,var(--acu-title-color));background:rgba(var(--acu-highlight-rgb,144,205,244),0.15)}.acu-dash-actions{display:flex;gap:2px}.acu-dash-npc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;padding:0 16px}.acu-dash-npc-item{background:var(--acu-table-head);padding:10px;border-radius:8px;cursor:default;border:1px solid rgba(0,0,0,0);transition:all .2s;font-weight:500;color:var(--acu-text-main);font-size:1em;display:flex;align-items:center;justify-content:center;gap:8px}.acu-dash-npc-item:hover{border-color:var(--acu-highlight);color:var(--acu-highlight);background:var(--acu-btn-bg)}.acu-dash-npc-text{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}.acu-dash-list-item{padding:6px 16px;border-bottom:1px solid var(--acu-border);color:var(--acu-text-sub);font-size:1em;display:flex;align-items:center;gap:6px;cursor:default}.acu-dash-list-item:hover{color:var(--acu-text-main);padding-left:20px}.acu-dash-list-item i{font-size:.8em;color:var(--acu-highlight)}.acu-dash-interactive{cursor:pointer !important;position:relative}.acu-tab-btn{padding:6px 12px;cursor:pointer;font-size:13px;font-weight:bold;color:var(--acu-text-sub);transition:all .2s;background:rgba(0,0,0,0);border:none;border-bottom:2px solid rgba(0,0,0,0)}.acu-tab-btn:hover{color:var(--acu-text-main);background:var(--acu-table-hover);border-radius:4px 4px 0 0}.acu-tab-btn.active{color:var(--acu-highlight);border-bottom-color:var(--acu-highlight)}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.acu-dash-npc-item.acu-highlight-changed,.acu-dash-list-item.acu-highlight-changed{color:var(--acu-highlight) !important;background-color:var(--acu-highlight-bg);font-weight:bold;animation:pulse-highlight 2s infinite}.acu-dash-widget.acu-highlight-ai-table .acu-dash-title-text{color:var(--acu-highlight-ai)}.acu-dash-widget.acu-highlight-ai-table .acu-dash-title-text i{color:var(--acu-highlight-ai)}.acu-dash-widget.acu-highlight-ai-table .acu-dash-count{background:var(--acu-highlight-ai-bg);color:var(--acu-highlight-ai)}.acu-dash-npc-item.acu-highlight-ai,.acu-dash-list-item.acu-highlight-ai{color:var(--acu-highlight-ai) !important;background:var(--acu-highlight-ai-bg) !important;font-weight:600;border-color:var(--acu-highlight-ai) !important}.acu-dash-display-tag{display:inline-flex;align-items:center;padding:2px 8px;font-size:11px;font-weight:500;color:var(--acu-text-sub);background:var(--acu-table-head);border:1px solid var(--acu-border);border-radius:10px;white-space:nowrap;flex-shrink:0;max-width:80px;overflow:hidden;text-overflow:ellipsis}.acu-dash-interactive-tag{display:inline-flex;align-items:center;padding:2px 8px;font-size:11px;font-weight:500;color:var(--acu-title-color);background:var(--acu-title-color-bg);border:1px solid var(--acu-title-color);border-radius:10px;white-space:nowrap;flex-shrink:0;cursor:pointer;transition:all .15s ease}.acu-dash-interactive-tag:hover{background:var(--acu-title-color);color:#fff}.acu-dash-interactive-tag.fixed{border-style:dashed}.acu-dash-interactive-tag.acu-dash-global-tag{border-width:1.5px;font-weight:600}.acu-dash-interactive-tag.acu-dash-global-tag:hover{transform:scale(1.05)}.acu-dash-category-btn{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;font-size:11px;font-weight:500;color:var(--acu-text-sub);background:var(--acu-table-head);border:1px dashed var(--acu-border);border-radius:10px;white-space:nowrap;flex-shrink:0;cursor:pointer;transition:all .15s ease}.acu-dash-category-btn i{font-size:10px;opacity:.7}.acu-dash-category-btn:hover{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-dash-category-btn:hover i{opacity:1}.acu-dash-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;color:var(--acu-text-sub);text-align:center}.acu-dash-empty i{font-size:24px;margin-bottom:8px;opacity:.5}.acu-dash-widget{position:relative;background:var(--acu-card-bg);border-radius:12px;border:1px solid var(--acu-border);padding:4px 0;display:flex;flex-direction:column;gap:2px;box-shadow:0 4px 12px var(--acu-shadow);transition:all .2s ease;min-width:0;max-height:250px}.acu-dash-widget.acu-dash-widget-wide{grid-column:span 2}@media (max-width:700px){.acu-dash-widget.acu-dash-widget-wide{grid-column:span 1}}.acu-dash-widget:has(.acu-global-widget){padding:0 !important;gap:0 !important}.acu-dash-widget-editing{border:2px dashed var(--acu-title-color);cursor:grab;background:linear-gradient(var(--acu-card-bg),var(--acu-card-bg)) padding-box,linear-gradient(45deg,var(--acu-title-color),var(--acu-border)) border-box}.acu-dash-widget-editing:active{cursor:grabbing}.acu-widget-remove{position:absolute;top:-10px;left:-10px;width:24px;height:24px;border-radius:50%;background:#e74c3c;color:#fff;border:2px solid var(--acu-card-bg);cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:transform .15s ease}.acu-widget-remove:hover{transform:scale(1.1)}.acu-widget-config{position:absolute;top:-10px;right:-10px;width:24px;height:24px;border-radius:50%;background:var(--acu-title-color);color:#fff;border:2px solid var(--acu-card-bg);cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:transform .15s ease}.acu-widget-config:hover{transform:scale(1.1)}.acu-widget-resize{position:absolute;bottom:-10px;right:-10px;width:24px;height:24px;border-radius:50%;background:var(--acu-btn-bg);color:var(--acu-text-sub);border:2px solid var(--acu-border);cursor:nwse-resize;z-index:10;display:flex;align-items:center;justify-content:center;font-size:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .15s ease}.acu-widget-resize:hover{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color)}.acu-dash-body-scrollable{flex:1;min-height:0;max-height:100%;overflow-y:auto;overflow-x:hidden}.acu-dash-body-scrollable::-webkit-scrollbar{width:4px}.acu-dash-body-scrollable::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-dash-body-scrollable::-webkit-scrollbar-thumb{background:var(--acu-border);border-radius:2px}.acu-dash-body-scrollable::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub)}.acu-dash-count{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 5px;font-size:11px;font-weight:600;color:var(--acu-title-color);background:var(--acu-title-color-bg,rgba(var(--acu-title-color-rgb),0.15));border-radius:9px}.acu-dash-list-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-dash-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--acu-border);background:var(--acu-bg-nav);flex-shrink:0}.acu-dash-header-left{display:flex;align-items:center;gap:8px;flex-shrink:0}.acu-dash-header-title{font-size:1.1em;font-weight:600;color:var(--acu-text-main);display:flex;align-items:center;gap:6px}.acu-dash-header-title i{color:var(--acu-title-color)}.acu-dash-header-spacer{flex:1;min-width:16px}.acu-dash-header-actions{display:flex;gap:6px;align-items:center;flex-shrink:0}.acu-dash-header-actions .acu-icon-btn.acu-btn-primary{background:var(--acu-title-color) !important;color:#fff !important;border-color:var(--acu-title-color) !important}.acu-dash-header-actions .acu-icon-btn.acu-btn-primary:hover{opacity:.9}.acu-dash-grid{flex:1;overflow-y:auto;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:8px;align-content:start}@media (max-width:700px){.acu-dash-grid{grid-template-columns:1fr}}.acu-dash-widget-dragging{opacity:.5}.acu-dash-widget-drop-target{border:2px dashed var(--acu-title-color);background:var(--acu-title-color-bg,rgba(var(--acu-title-color-rgb),0.1))}.acu-dash-container-new{display:flex;flex-direction:column;height:100%;overflow:hidden}.acu-dash-empty-state{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;text-align:center;color:var(--acu-text-sub)}.acu-dash-empty-state i{font-size:48px;margin-bottom:16px;opacity:.5}.acu-dash-empty-state p{margin:0 0 16px;font-size:14px}.acu-dash-add-first-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:var(--acu-title-color);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:opacity .2s}.acu-dash-add-first-btn:hover{opacity:.9}.acu-actions-config-modal{max-width:320px}@media (max-width:400px){.acu-actions-config-modal{max-width:95%}}.acu-dash-row-edit-btn{width:24px;height:24px;min-width:24px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);border:none;border-radius:4px;color:var(--acu-text-sub);cursor:pointer;transition:all .2s;opacity:0;margin-left:auto;flex-shrink:0}.acu-dash-row-edit-btn i{font-size:11px}.acu-dash-row-edit-btn:hover{background:var(--acu-btn-hover);color:var(--acu-title-color)}.acu-dash-npc-item:hover .acu-dash-row-edit-btn{opacity:1}.acu-dash-list-item:hover .acu-dash-row-edit-btn{opacity:1}@media (max-width:768px){.acu-row-edit-modal-container{align-items:flex-start !important;padding-top:8vh;padding-bottom:0}}.acu-row-edit-modal{max-width:500px;width:90%;max-height:80vh;display:flex;flex-direction:column}@media (max-width:768px){.acu-row-edit-modal{max-width:100%;width:100%;max-height:60vh;border-radius:16px 16px 0 0;margin-bottom:auto}}.acu-row-edit-modal .acu-modal-body{flex:1;overflow-y:auto;padding:16px}.acu-row-edit-content .acu-data-card{background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:12px;padding:12px;width:100% !important;max-width:none !important;box-sizing:border-box}.acu-status-board{width:100%;display:flex;flex-direction:column;gap:8px}.acu-status-board-header{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border-bottom:1px dashed var(--acu-border);flex-wrap:wrap;gap:8px}.acu-status-board-summary{font-size:11px;color:var(--acu-text-sub);white-space:nowrap}.acu-status-table-wrapper{overflow-x:auto}.acu-status-table{width:100%;border-collapse:collapse;font-size:12px}.acu-status-table th,.acu-status-table td{padding:6px 8px;text-align:left;border-bottom:1px solid var(--acu-border);font-family:var(--acu-font-family) !important}.acu-status-table th{font-weight:600;color:var(--acu-text-sub);background:var(--acu-table-head);font-size:11px;white-space:nowrap}.acu-status-table td{color:var(--acu-text-main)}.acu-status-table tbody tr{cursor:pointer;transition:background .15s}.acu-status-table tbody tr:hover{background:var(--acu-table-hover)}.acu-status-table tbody tr:last-child td{border-bottom:none}.acu-status-name{font-weight:500;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-status-freq,.acu-status-unrecorded,.acu-status-last-update{text-align:center !important}.acu-status-col-freq,.acu-status-col-unrecorded,.acu-status-col-last{text-align:center !important}.acu-status-disabled{color:var(--acu-text-sub);opacity:.6}.acu-status-global-hint{font-size:10px;color:var(--acu-text-sub);margin-left:2px}.acu-status-empty,.acu-status-loading{text-align:center;padding:20px !important;color:var(--acu-text-sub)}.acu-status-empty i,.acu-status-loading i{margin-right:6px}.acu-status-table tbody tr.acu-highlight-ai td{color:var(--acu-highlight-ai) !important;font-weight:600}.acu-status-table tbody tr.acu-highlight-ai .acu-status-name{color:var(--acu-highlight-ai) !important;font-weight:700}.acu-status-table tbody tr.acu-row-selected{background:var(--acu-title-color-bg) !important}.acu-status-table tbody tr.acu-row-selected td{color:var(--acu-title-color)}.acu-status-table tbody tr.acu-row-selected .acu-status-name{font-weight:600}.acu-status-board-actions{display:flex;align-items:center;gap:8px;margin-left:auto}.acu-status-toolbar{display:flex;align-items:center;gap:4px;padding-right:8px;border-right:1px solid var(--acu-border);margin-right:4px}.acu-freq-input{width:60px;padding:4px 6px;text-align:center;font-size:13px;font-weight:500;border:1px solid var(--acu-border);border-radius:4px;background:var(--acu-btn-bg);color:var(--acu-text-main);transition:border-color .15s ease}.acu-freq-input:focus{outline:none;border-color:var(--acu-title-color);background:var(--acu-card-bg)}.acu-freq-input::-webkit-inner-spin-button,.acu-freq-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.acu-freq-input[type=number]{-moz-appearance:textfield}.acu-status-table td.acu-status-name span{display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-icon-btn.acu-edit-active{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}@media (max-width:768px){.acu-status-toolbar{flex-wrap:wrap;gap:2px;padding-right:4px;margin-right:2px}.acu-freq-input{width:50px;padding:3px 4px;font-size:12px}.acu-status-board-actions{gap:4px}}.acu-embedded-options{width:100%;display:flex;flex-direction:column;gap:12px}.acu-embedded-options-list{display:flex;flex-direction:column;gap:12px}.acu-embedded-option-group{display:flex;flex-direction:column;gap:6px}.acu-embedded-option-rows{display:flex;flex-direction:column;gap:4px}.acu-embedded-option-row{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--acu-table-head);border-radius:6px;cursor:pointer;transition:all .15s}.acu-embedded-option-row:hover{background:var(--acu-table-hover);color:var(--acu-title-color)}.acu-embedded-option-tags{display:flex;gap:4px;flex-shrink:0}.acu-option-tag{font-size:10px !important;padding:1px 5px !important;background:var(--acu-title-color-bg,rgba(var(--acu-title-color-rgb),0.15)) !important;color:var(--acu-title-color) !important}.acu-embedded-option-text{flex:1;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-dash-add-section{grid-column:1/-1;display:flex;flex-direction:column;gap:0}.acu-dash-add-section .acu-action-btn{width:100%;justify-content:center;border-radius:12px;padding:10px 16px}.acu-dash-add-section .acu-action-btn.active{border-bottom-left-radius:0;border-bottom-right-radius:0;border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-dash-add-list{border-top:none;border-top-left-radius:0;border-top-right-radius:0}.acu-dash-add-list .acu-switch-list-body{max-height:200px}.acu-dash-add-list .acu-switch-list-item.is-selected .item-label i{color:var(--acu-title-color)}.acu-dash-virtual-container{max-height:200px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}.acu-dash-virtual-container::-webkit-scrollbar{width:4px}.acu-dash-virtual-container::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-dash-virtual-container::-webkit-scrollbar-thumb{background:var(--acu-border);border-radius:2px}.acu-dash-virtual-container::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub)}.acu-dash-virtual-container .acu-dash-npc-grid{margin-bottom:8px}.acu-dash-virtual-container .acu-dash-npc-grid:last-child{margin-bottom:0}.acu-selected-tags{display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--acu-table-head);border-radius:8px;min-height:40px}.acu-selected-tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--acu-title-color-bg);border:1px solid var(--acu-title-color);border-radius:6px;color:var(--acu-title-color);font-size:12px;font-weight:500}.acu-tag-remove{display:flex;align-items:center;justify-content:center;width:16px;height:16px;background:rgba(0,0,0,0);border:none;border-radius:50%;color:var(--acu-title-color);cursor:pointer;transition:all .15s ease;padding:0}.acu-tag-remove:hover{background:rgba(231,76,60,.2);color:#e74c3c}.acu-tag-remove i{font-size:10px}.acu-tab-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);font-size:13px;cursor:pointer;white-space:nowrap;position:relative;transition:all .2s ease}.acu-tab-btn i{font-size:14px}.acu-tab-btn:hover{color:var(--acu-text-main);background:var(--acu-btn-hover)}.acu-tab-btn.active{color:var(--acu-title-color);font-weight:600}.acu-tab-btn.active::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:60%;height:3px;background:var(--acu-title-color);border-radius:3px 3px 0 0}.acu-options-panel{display:flex;flex-direction:column;height:100%;min-height:0}.acu-options-header{flex:0 0 auto;padding:8px 12px;-webkit-user-select:none;user-select:none}.acu-options-title{font-size:1.2em;font-weight:800;color:var(--acu-title-color,#333);display:flex;align-items:center;gap:8px}.acu-options-title i{color:var(--acu-title-color,#667eea)}.acu-options-count{color:var(--acu-text-sub,#666);font-size:.9em}.acu-options-content{flex:1;overflow-y:auto !important;min-height:0;padding:10px;touch-action:pan-y;-webkit-overflow-scrolling:touch;position:relative;z-index:10}.acu-options-list{display:flex;flex-direction:column;gap:12px;padding-bottom:20px;flex:1;min-height:0}.acu-options-list .acu-dash-card{flex:1;min-height:0;display:flex;flex-direction:column}.acu-empty-state{text-align:center;color:var(--acu-text-sub,#666);padding:30px;font-size:.9em}.acu-option-rows{display:flex;flex-direction:column;gap:6px;overflow-y:auto;min-height:0;flex:1;padding-right:4px}.acu-option-rows::-webkit-scrollbar{width:4px}.acu-option-rows::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-option-rows::-webkit-scrollbar-thumb{background:var(--acu-border);border-radius:2px}.acu-option-rows::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub)}.acu-embedded-option-row{display:flex;flex-direction:column;align-items:flex-start;gap:8px;padding:12px;background:hsla(0,0%,100%,.05);border-radius:8px;border:1px solid var(--acu-border,rgba(255,255,255,0.1));cursor:pointer;transition:background .1s,transform .1s;-webkit-user-select:none;user-select:none;touch-action:pan-y}.acu-embedded-option-row:hover{background:var(--acu-table-hover,rgba(255,255,255,0.1));border-color:var(--acu-title-color,#667eea)}.acu-embedded-option-row:active{transform:translateY(1px)}.acu-embedded-option-tags{display:flex;flex-wrap:wrap;gap:4px;width:100%;flex-shrink:0}.acu-option-tag{background:var(--acu-btn-bg,rgba(255,255,255,0.1));color:var(--acu-title-color,#fff);border:1px solid var(--acu-border);font-weight:bold}.acu-embedded-option-text{width:100%;color:var(--acu-text-main,#333);font-weight:500;font-size:var(--acu-font-size,14px);line-height:1.5;word-break:break-word;white-space:pre-wrap}.acu-tab-config-panel,.acu-button-config-panel{display:flex;flex-direction:column;gap:16px}.acu-btn-text{display:flex;align-items:center;gap:4px;padding:4px 8px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub,#999);cursor:pointer;font-size:12px;border-radius:4px;transition:all .2s}.acu-btn-text:hover{background:var(--acu-btn-hover,#cbbba8);color:var(--acu-text-main,#5e4b35)}.acu-btn-text.acu-btn-clear{font-size:11px}.acu-btn-text.acu-btn-clear:hover{color:#e74c3c;background:rgba(231,76,60,.1)}.acu-config-section{display:flex;flex-direction:column;gap:8px}.acu-config-section h4{margin:0;font-size:13px;font-weight:600;color:var(--acu-text-main,#5e4b35);display:flex;align-items:center;gap:6px}.acu-config-section h4 .acu-btn-reset{margin-left:auto;font-size:11px}.acu-config-hint{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--acu-table-head,#efebe4);border:1px solid var(--acu-border,#dcd0c0);border-radius:6px;font-size:12px;color:var(--acu-text-sub,#999)}.acu-config-hint i{color:var(--acu-title-color,#d35400)}.acu-visible-area{background:var(--acu-title-color-bg,rgba(211,84,0,0.08));border-radius:8px;padding:12px;border:1px dashed var(--acu-border,#dcd0c0)}.acu-visible-area h4{display:flex;align-items:center;gap:6px;font-weight:600}.acu-visible-area h4 i{color:var(--acu-title-color,#d35400)}.acu-hidden-area{background:var(--acu-table-head,#efebe4);border-radius:8px;padding:12px}.acu-hidden-area h4{display:flex;align-items:center;gap:6px;font-weight:600}.acu-hidden-area h4 i{color:var(--acu-text-sub,#999)}.acu-tab-visible-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px;max-height:160px;overflow-y:auto;padding:4px}@media (max-width:480px){.acu-tab-visible-grid{grid-template-columns:repeat(2,1fr)}}.acu-tab-config-btn{position:relative;cursor:grab;touch-action:none}.acu-tab-config-btn:hover{border-color:#e74c3c !important;background:rgba(231,76,60,.1) !important}.acu-tab-config-btn.dragging{opacity:.5;cursor:grabbing;border:2px dashed var(--acu-title-color,#d35400) !important}.acu-tab-config-btn .tab-type-badge-mini{position:absolute;top:-4px;right:-4px;font-size:8px;padding:1px 4px;border-radius:3px;background:var(--acu-title-color,#d35400);color:#fff;line-height:1.2}.acu-tab-hidden-list{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-height:150px;overflow-y:auto;padding:4px}@media (max-width:480px){.acu-tab-hidden-list{grid-template-columns:repeat(2,1fr)}}.acu-tab-hidden-item{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--acu-border,#dcd0c0);border-radius:6px;background:var(--acu-card-bg,#fffef9);color:var(--acu-text-sub,#999);cursor:pointer;transition:all .2s;font-size:12px}.acu-tab-hidden-item:hover{background:var(--acu-title-color-bg,rgba(211,84,0,0.08));border-color:var(--acu-title-color,#d35400);color:var(--acu-title-color,#d35400)}.acu-tab-hidden-item:hover .add-icon{color:var(--acu-title-color,#d35400)}.acu-tab-hidden-item.is-special{border-left:2px solid var(--acu-text-sub,#999)}.acu-tab-hidden-item .tab-icon{width:14px;text-align:center}.acu-tab-hidden-item .tab-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-tab-hidden-item .tab-type-badge{font-size:9px;padding:1px 4px;border-radius:2px;background:rgba(0,0,0,.05)}.acu-tab-hidden-item .add-icon{font-size:10px;color:var(--acu-text-sub,#999)}.acu-empty-hint{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;color:var(--acu-text-sub,#999);font-size:12px;font-style:italic}.acu-empty-hint i{font-size:14px}.acu-btn-visible-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:8px;max-height:180px;overflow-y:auto;padding:4px}@media (max-width:480px){.acu-btn-visible-grid{grid-template-columns:repeat(auto-fill,48px);justify-content:flex-start}}.acu-btn-config-item{position:relative;display:flex;align-items:center;justify-content:center;width:48px;height:48px;border:1px solid var(--acu-border,#dcd0c0);border-radius:8px;background:var(--acu-card-bg,#fffef9);cursor:grab;touch-action:none;transition:all .2s}.acu-btn-config-item .btn-icon{font-size:16px;color:var(--acu-text-main,#5e4b35)}.acu-btn-config-item:hover{background:rgba(231,76,60,.1);border-color:#e74c3c}.acu-btn-config-item:hover .btn-icon{color:#e74c3c}.acu-btn-config-item.is-required{cursor:default;border-color:var(--acu-title-color,#d35400)}.acu-btn-config-item.is-required:hover{background:var(--acu-card-bg,#fffef9);border-color:var(--acu-title-color,#d35400)}.acu-btn-config-item.is-required:hover .btn-icon{color:var(--acu-text-main,#5e4b35)}.acu-btn-config-item .required-dot{position:absolute;top:4px;right:4px;width:6px;height:6px;border-radius:50%;background:var(--acu-title-color,#d35400)}.acu-btn-config-item .attachment-indicator{position:absolute;bottom:-4px;right:-4px;display:flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--acu-title-color,#d35400);color:#fff;font-size:8px;cursor:pointer;border:2px solid var(--acu-bg-panel,#e6e2d3);transition:all .2s}.acu-btn-config-item .attachment-indicator:hover{background:#e74c3c;transform:scale(1.1)}.acu-btn-config-item .attachment-add-btn{position:absolute;bottom:-4px;right:-4px;display:flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;border:1px dashed var(--acu-text-sub,#999);background:var(--acu-bg-panel,#e6e2d3);color:var(--acu-text-sub,#999);font-size:8px;cursor:pointer;padding:0;transition:all .2s}.acu-btn-config-item .attachment-add-btn:hover{border-color:var(--acu-title-color,#d35400);color:var(--acu-title-color,#d35400);background:var(--acu-title-color-bg,rgba(211,84,0,0.08))}.acu-btn-hidden-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:6px;max-height:100px;overflow-y:auto;padding:4px}@media (max-width:480px){.acu-btn-hidden-grid{grid-template-columns:repeat(auto-fill,40px);justify-content:flex-start}}.acu-btn-hidden-item{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border:1px solid var(--acu-border,#dcd0c0);border-radius:6px;background:var(--acu-card-bg,#fffef9);color:var(--acu-text-sub,#999);cursor:pointer;transition:all .2s;font-size:14px;padding:0}.acu-btn-hidden-item:hover{background:var(--acu-title-color-bg,rgba(211,84,0,0.08));border-color:var(--acu-title-color,#d35400);color:var(--acu-title-color,#d35400)}.acu-config-hint-fixed{position:sticky;bottom:0;margin-top:auto;background:var(--acu-bg-panel,#e6e2d3);border-top:1px solid var(--acu-border,#dcd0c0);border-left:none;border-right:none;border-bottom:none;border-radius:0;margin-left:-16px;margin-right:-16px;padding:10px 16px;margin-bottom:-16px}.acu-attachment-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw !important;height:100vh !important;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:2147483647;padding:20px;box-sizing:border-box}.acu-attachment-picker{width:90%;max-width:300px;max-height:calc(100vh - 100px);background:var(--acu-bg-panel,#e6e2d3);border:1px solid var(--acu-border,#dcd0c0);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.3);overflow:hidden}.acu-attachment-picker .picker-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--acu-table-head,#efebe4);border-bottom:1px solid var(--acu-border,#dcd0c0)}.acu-attachment-picker .picker-header h4{margin:0;font-size:14px;font-weight:600;color:var(--acu-title-color,#d35400)}.acu-attachment-picker .picker-header .btn-close{display:flex;align-items:center;justify-content:center;width:28px;height:28px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub,#999);cursor:pointer;border-radius:4px;transition:all .2s}.acu-attachment-picker .picker-header .btn-close:hover{background:var(--acu-btn-hover,#cbbba8);color:var(--acu-text-main,#5e4b35)}.acu-attachment-picker .picker-content{padding:16px}.acu-attachment-picker .picker-hint{margin:0 0 12px;font-size:12px;color:var(--acu-text-sub,#999)}.acu-attachment-picker .picker-options{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:8px;max-height:200px;overflow-y:auto}.acu-attachment-picker .picker-option{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:10px 6px;border:1px solid var(--acu-border,#dcd0c0);border-radius:8px;background:var(--acu-card-bg,#fffef9);color:var(--acu-text-main,#5e4b35);cursor:pointer;transition:all .2s;font-size:10px;text-align:center}.acu-attachment-picker .picker-option:hover{background:var(--acu-title-color-bg,rgba(211,84,0,0.08));border-color:var(--acu-title-color,#d35400);color:var(--acu-title-color,#d35400)}.acu-attachment-picker .picker-option i{font-size:18px;color:var(--acu-text-sub,#999)}.acu-attachment-picker .picker-option:hover i{color:var(--acu-title-color,#d35400)}.acu-attachment-picker .picker-option span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}@media (max-width:768px){.acu-attachment-picker-overlay{padding:16px}.acu-attachment-picker{width:100%;max-width:320px}.acu-attachment-picker .picker-options{max-height:250px}}.acu-mode-control{display:flex !important;flex-direction:column !important;align-items:flex-end !important;gap:8px !important;width:100%}.acu-mode-control .acu-select{width:auto !important;min-width:120px}.acu-mode-control .acu-range-wrapper{display:flex;align-items:center;gap:8px;width:100%;justify-content:flex-end;margin-top:4px}.acu-mode-control .acu-inline-range{width:120px !important;flex-shrink:0}.acu-mode-control .acu-range-value{min-width:24px;text-align:right;font-variant-numeric:tabular-nums;color:var(--acu-title-color,#d35400);font-weight:bold}.acu-update-layout{display:flex;gap:0}@media (max-width:768px){.acu-update-layout{flex-direction:column}}.acu-update-left{flex:1;min-width:0;max-height:calc(80vh - 120px);overflow-y:auto;padding-right:16px;scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-update-left::-webkit-scrollbar{width:4px !important;height:4px !important}.acu-update-left::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-update-left::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:2px !important}.acu-update-left::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-update-left::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}@media (max-width:768px){.acu-update-left{max-height:none;padding-right:0}}.acu-update-right{width:260px;flex-shrink:0;border-left:1px solid var(--acu-border);padding-left:20px;display:flex;flex-direction:column}@media (max-width:768px){.acu-update-right{display:none}}.acu-table-selector{background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:12px;overflow:hidden}.acu-table-selector-header{display:flex;flex-wrap:wrap;gap:6px;padding:10px 12px;border-bottom:1px solid var(--acu-border);background:var(--acu-table-head);justify-content:flex-end}.acu-table-selector-list{max-height:280px;overflow-y:auto;padding:8px;scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-table-selector-list::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-table-selector-list::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-table-selector-list::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:3px !important}.acu-table-selector-list::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-table-selector-list::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-table-selector-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .15s;-webkit-user-select:none;user-select:none}.acu-table-selector-item:hover{background:var(--acu-table-hover)}.acu-table-selector-item .acu-switch.small{transform:scale(0.65);transform-origin:center;margin:0 -4px;flex-shrink:0}.acu-table-selector-item input[type=checkbox]:not(.acu-switch input){appearance:checkbox !important;-webkit-appearance:checkbox !important;-moz-appearance:checkbox !important;width:16px !important;height:16px !important;min-width:16px !important;min-height:16px !important;margin:0 !important;padding:0 !important;cursor:pointer !important;accent-color:var(--acu-title-color) !important;background:none !important;background-color:rgba(0,0,0,0) !important;background-image:none !important;border:revert !important;outline:none !important;box-shadow:none !important;vertical-align:middle !important;flex-shrink:0 !important;position:relative !important}.acu-table-selector-item input[type=checkbox]:not(.acu-switch input)::before,.acu-table-selector-item input[type=checkbox]:not(.acu-switch input)::after{content:none !important;display:none !important}.acu-table-selector-item .table-name{flex:1;font-size:13px;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-table-selector-item.is-summary-outline .table-name::after{content:"★";color:var(--acu-title-color);margin-left:4px;font-size:10px}.acu-table-selector-item.is-selected{background:var(--acu-title-color-bg)}.acu-table-selector-footer{padding:8px 12px;border-top:1px solid var(--acu-border);font-size:12px;color:var(--acu-text-sub);text-align:center}.acu-table-selector-empty{padding:20px;text-align:center;color:var(--acu-text-sub);font-size:13px}.acu-table-selector-empty i{display:block;font-size:24px;margin-bottom:8px;opacity:.5}.acu-quick-select-btn{padding:4px 10px;font-size:11px;border-radius:6px;border:1px solid var(--acu-border);background:var(--acu-btn-bg);color:var(--acu-text-main);cursor:pointer;transition:all .15s;white-space:nowrap}.acu-quick-select-btn:hover{background:var(--acu-btn-hover)}.acu-quick-select-btn.active{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-quick-select-btn i{margin-right:4px;font-size:10px}.acu-table-selector-mobile{margin-top:12px}.acu-table-selector-mobile .acu-table-selector{margin-top:8px}.acu-collapsible{cursor:pointer;display:flex;align-items:center;justify-content:space-between}.acu-collapsible .acu-collapse-indicator{font-size:12px;color:var(--acu-text-sub);transition:transform .2s}.acu-collapsible.is-expanded .acu-collapse-indicator{transform:rotate(180deg)}@media (max-width:768px){.acu-hide-mobile{display:none !important}}.acu-show-mobile-only{display:none}@media (max-width:768px){.acu-show-mobile-only{display:block}}@media (min-width:769px){.acu-manual-update-modal{max-width:800px}.acu-manual-update-modal .acu-modal-body{overflow:visible;max-height:none;padding:20px}}.acu-switch-list{background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:12px;overflow:hidden}.acu-switch-list-header{display:flex;flex-wrap:wrap;gap:6px;padding:10px 12px;border-bottom:1px solid var(--acu-border);background:var(--acu-table-head);justify-content:flex-end}.acu-switch-list-body{max-height:280px;overflow-y:auto;padding:8px;scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-switch-list-body::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-switch-list-body::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-switch-list-body::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:3px !important}.acu-switch-list-body::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-switch-list-body::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-switch-list-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .15s;-webkit-user-select:none;user-select:none}.acu-switch-list-item:hover{background:var(--acu-table-hover)}.acu-switch-list-item.is-selected{background:var(--acu-title-color-bg)}.acu-switch-list-item .item-label{flex:1;font-size:13px;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-switch-list-item .item-badge{color:var(--acu-title-color);margin-left:4px;font-size:10px}.acu-switch-list-item .acu-switch.small{transform:scale(0.65);transform-origin:center;margin:0 -4px;flex-shrink:0}.acu-switch-list-empty{padding:20px;text-align:center;color:var(--acu-text-sub);font-size:13px}.acu-switch-list-empty i{display:block;font-size:24px;margin-bottom:8px;opacity:.5}.acu-switch-list-footer{padding:8px 12px;border-top:1px solid var(--acu-border);font-size:12px;color:var(--acu-text-sub);text-align:center}.acu-switch-list-footer .empty-hint{color:var(--acu-title-color)}.acu-relationship-graph{position:relative;width:100%;flex:1 1 auto;min-height:400px;background:var(--acu-bg-panel);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}.acu-graph-background{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0;pointer-events:none;background-color:rgba(0,0,0,0);background-repeat:no-repeat}.acu-panel-content:has(.acu-relationship-graph){display:flex;flex-direction:column;flex:1;min-height:450px;overflow:hidden}.acu-data-table:has(.acu-relationship-graph){min-height:450px;height:auto !important;overflow:hidden}.acu-graph-container{width:100%;position:absolute;top:40px;bottom:48px;left:0;right:0;overflow:hidden;z-index:1;background:rgba(0,0,0,0)}.acu-graph-search-input{position:absolute;bottom:56px;left:50%;transform:translateX(-50%);width:200px;z-index:10}.acu-graph-search-input .acu-search-input-wrapper{background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}.acu-slide-up-enter-active,.acu-slide-up-leave-active{transition:all .2s ease}.acu-slide-up-enter-from,.acu-slide-up-leave-to{opacity:0;transform:translateX(-50%) translateY(10px)}.acu-graph-toolbar{position:absolute;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:center;gap:4px;background:var(--acu-bg-panel);padding:8px 12px;border-top:1px solid var(--acu-border);z-index:10}.acu-graph-legend{position:absolute;top:0;left:0;right:0;display:flex;flex-wrap:wrap;justify-content:center;gap:8px;background:var(--acu-bg-panel);padding:8px 12px;font-size:11px;border-bottom:1px solid var(--acu-border);z-index:10}.acu-toolbar-divider{width:1px;height:20px;background:var(--acu-border);margin:0 4px}.acu-graph-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border:none;border-radius:6px;background:rgba(0,0,0,0);color:var(--acu-text-main);cursor:pointer;transition:all .15s ease;font-size:14px}.acu-graph-btn:hover{background:var(--acu-table-hover)}.acu-graph-btn:active{transform:scale(0.95)}.acu-graph-btn.active{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-graph-btn.saved{background:var(--acu-success,#27ae60);color:#fff;animation:pulse-success .3s ease}@keyframes pulse-success{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}.acu-legend-item{display:flex;align-items:center;gap:4px;white-space:nowrap}.acu-legend-item .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}.acu-legend-item .dot.dashed{width:18px;height:2px;border-radius:0;border:none;background:rgba(0,0,0,0) !important;position:relative}.acu-legend-item .dot.dashed::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;border-top:2px dashed currentColor;color:inherit}.acu-legend-item .label{color:var(--acu-text-sub)}.acu-graph-empty{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:12px;color:var(--acu-text-sub);text-align:center}.acu-graph-empty i{font-size:48px;opacity:.3}.acu-graph-empty p{margin:0;font-size:14px}.acu-graph-empty .hint{font-size:12px;opacity:.7}.acu-node-fullname{margin:0 0 6px 0;font-size:13px;color:var(--acu-text-main)}.acu-node-hint{margin:0 0 12px 0;font-size:11px;color:var(--acu-text-sub)}.acu-node-preview{margin:0 0 12px 0;padding:8px 12px;font-size:14px;font-weight:600;color:var(--acu-text-main);background:var(--acu-table-head);border-radius:6px;text-align:center}.acu-char-selector{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}.acu-char-btn{width:40px;height:40px;border:2px solid var(--acu-border);border-radius:8px;background:var(--acu-card-bg);color:var(--acu-text-main);font-size:18px;cursor:pointer;transition:all .15s ease}.acu-char-btn:hover{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-char-btn.active{border-color:var(--acu-title-color);background:var(--acu-title-color);color:#fff}.acu-node-config-actions{display:flex;gap:8px;justify-content:flex-end}.acu-action-btn{padding:8px 16px;border:none;border-radius:6px;font-size:13px;cursor:pointer;transition:all .15s ease}.acu-action-btn.primary{background:var(--acu-title-color);color:#fff}.acu-action-btn.primary:hover{filter:brightness(1.1)}.acu-action-btn.secondary{background:var(--acu-table-head);color:var(--acu-text-main)}.acu-action-btn.secondary:hover{background:var(--acu-table-hover)}@media (max-width:768px){.acu-relationship-graph{min-height:calc(100vh - var(--acu-win-bottom,100px) - 120px);max-height:calc(100vh - var(--acu-win-bottom,100px) - 80px)}.acu-data-display:has(.acu-relationship-graph){flex:1 1 auto;min-height:calc(100vh - var(--acu-win-bottom,100px) - 80px)}.acu-panel-content:has(.acu-relationship-graph){flex:1;min-height:0;height:100%;overflow:hidden !important}.acu-graph-toolbar{padding:6px 8px;gap:2px;flex-wrap:wrap;position:absolute;bottom:0;left:0;right:0}.acu-graph-btn{width:28px;height:28px;font-size:12px}.acu-graph-legend{padding:6px 10px;font-size:10px;gap:6px;position:absolute;top:0;left:0;right:0}.acu-graph-container{top:36px;bottom:44px}.acu-legend-item .dot{width:8px;height:8px}}.acu-graph-avatar-wrapper{display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none}.acu-graph-avatar{border:2px solid var(--acu-text-main,#333);box-shadow:0 2px 8px rgba(0,0,0,.15);overflow:hidden;background-color:var(--acu-card-bg,#fff)}.acu-graph-avatar-name{font-weight:bold;color:var(--acu-text-main,#333);text-shadow:-1px -1px 0 var(--acu-card-bg,#fff),1px -1px 0 var(--acu-card-bg,#fff),-1px 1px 0 var(--acu-card-bg,#fff),1px 1px 0 var(--acu-card-bg,#fff);white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis}.acu-graph-btn[title=势力分组布局].active{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-interaction-list{display:flex;flex-direction:column;gap:8px;padding:8px}.acu-interaction-item{background:var(--acu-table-head);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:8px;border:1px solid rgba(0,0,0,0);transition:all .2s}.acu-interaction-item:hover{background:var(--acu-btn-bg);border-color:var(--acu-border)}.acu-interaction-item.acu-highlight-ai{background:var(--acu-highlight-ai-bg);border-color:var(--acu-highlight-ai)}.acu-interaction-header{display:flex;justify-content:space-between;align-items:center;width:100%}.acu-interaction-target{font-weight:bold;color:var(--acu-text-main);font-size:1em}.acu-interaction-actions{display:flex;flex-direction:row;gap:8px;align-items:center}.acu-interaction-meta{display:flex;align-items:center;gap:8px;font-size:.9em;flex-wrap:wrap}.acu-badge{padding:2px 6px;border-radius:4px;font-size:.8em;font-weight:500}.acu-badge.acu-badge-primary{background:var(--acu-title-color-bg);color:var(--acu-title-color);border:1px solid var(--acu-title-color)}.acu-badge.acu-badge-secondary{background:var(--acu-table-head);color:var(--acu-text-sub);border:1px solid var(--acu-border)}.acu-interaction-text{font-size:.95em;color:var(--acu-text-main);background:rgba(0,0,0,.05);padding:6px 8px;border-radius:6px;line-height:1.4;white-space:pre-wrap}.acu-btn-success{color:#2ecc71 !important;border-color:#2ecc71 !important}.acu-btn-success:hover{background:rgba(46,204,113,.1) !important}.acu-dimension-manager{display:flex;flex-direction:column;gap:12px}.dimension-container{transition:all .2s ease;border:1px solid var(--acu-border);background:var(--acu-bg-panel);border-radius:8px;overflow:hidden}.dimension-container.is-collapsed{background:var(--acu-card-bg)}.dimension-container.is-collapsed .dimension-header{border-bottom:none}.dimension-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;cursor:pointer;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border);transition:background .2s}.dimension-header:hover{background:var(--acu-table-hover)}.dimension-header .header-left{display:flex;align-items:center;gap:8px;flex:1}.dimension-header .header-right{display:flex;align-items:center;gap:8px}.dimension-header .collapse-icon{font-size:12px;color:var(--acu-text-sub);transition:transform .2s;width:16px;text-align:center}.dimension-header .collapse-icon.is-expanded{transform:rotate(90deg)}.dimension-name-input{background:rgba(0,0,0,0);border:1px solid rgba(0,0,0,0);color:var(--acu-text-main);font-weight:600;font-size:14px;padding:4px 8px;border-radius:4px;width:100%;max-width:200px;transition:all .2s}.dimension-name-input:hover{border-color:var(--acu-border);background:var(--acu-input-bg)}.dimension-name-input:focus{outline:none;border-color:var(--acu-title-color);background:var(--acu-input-bg)}.dimension-content{padding:12px;background:var(--acu-bg-panel)}.tier-list{display:flex;flex-direction:column;gap:12px;margin-bottom:12px}.tier-item{display:flex;flex-direction:column;gap:8px;padding-bottom:12px;border-bottom:1px dashed var(--acu-border)}.tier-item:last-child{border-bottom:none;padding-bottom:0}.tier-row{display:flex;align-items:center;gap:8px}.tier-row.basic-info{justify-content:space-between}.tier-row.weight-control{background:var(--acu-table-head);padding:6px 10px;border-radius:6px}.tier-row.weight-control .label{font-size:12px;color:var(--acu-text-sub);white-space:nowrap}.tier-row.weight-control .acu-range-input{flex:1;height:4px}.tier-row.weight-control .acu-badge{min-width:24px;text-align:center}.tier-row.prompt-editor .acu-edit-textarea{min-height:48px;font-size:12px;padding:6px;border-color:var(--acu-border);background:var(--acu-input-bg)}.tier-row.prompt-editor .acu-edit-textarea:focus{border-color:var(--acu-title-color);min-height:80px}.tier-name-wrapper{display:flex;align-items:center;gap:8px;flex:1}.tier-name-input{background:rgba(0,0,0,0);border:none;border-bottom:1px solid var(--acu-border);color:var(--acu-text-main);font-size:13px;padding:2px 4px;width:100%;max-width:150px;border-radius:0;transition:border-color .2s}.tier-name-input:focus{outline:none;border-bottom-color:var(--acu-title-color)}.acu-color-picker-mini{width:20px !important;height:20px !important;border-radius:4px !important;border:1px solid var(--acu-border) !important;padding:0 !important;appearance:none;-webkit-appearance:none;background-color:rgba(0,0,0,0);cursor:pointer}.acu-color-picker-mini::-webkit-color-swatch-wrapper{padding:0}.acu-color-picker-mini::-webkit-color-swatch{border-radius:3px;border:none}.acu-btn-dashed{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:8px;background:rgba(0,0,0,0);border:1px dashed var(--acu-border);border-radius:6px;color:var(--acu-text-sub);font-size:12px;cursor:pointer;transition:all .2s}.acu-btn-dashed:hover{border-color:var(--acu-title-color);color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-btn-dashed.add-dimension-btn{margin-top:8px;padding:12px;font-size:13px;border-style:solid;background:var(--acu-card-bg)}.acu-btn-dashed.add-dimension-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-border);color:var(--acu-text-main)}.acu-input-minimal{font-family:inherit}.acu-preset-header{position:sticky;top:0;margin:0 0 16px;padding:12px 16px;z-index:10;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border)}.acu-preset-header .acu-settings-row{margin-bottom:0}.acu-preset-header .hint{white-space:nowrap}.acu-preset-control{display:flex;align-items:center;gap:8px;margin-left:auto;justify-content:flex-end}.acu-preset-dropdown{position:relative;flex:1;min-width:120px;max-width:200px}.acu-preset-dropdown.open .acu-preset-dropdown-btn i{transform:rotate(180deg)}.acu-preset-dropdown-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:8px 12px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);font-size:13px;cursor:pointer;transition:all .2s ease}.acu-preset-dropdown-btn:hover{border-color:var(--acu-text-sub)}.acu-preset-dropdown-btn .acu-preset-selected-name{flex:1;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-preset-dropdown-btn i{font-size:10px;color:var(--acu-text-sub);transition:transform .2s ease;margin-left:8px}.acu-preset-dropdown-menu{position:absolute;top:100%;left:0;right:0;margin-top:4px;max-height:200px;overflow-y:auto;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:100}.acu-preset-option{display:flex;align-items:center;padding:10px 12px;cursor:pointer;transition:background .15s ease}.acu-preset-option:hover{background:var(--acu-btn-hover)}.acu-preset-option.active{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-preset-option:first-child{border-radius:7px 7px 0 0}.acu-preset-option:last-child{border-radius:0 0 7px 7px}.acu-preset-option .acu-preset-option-name{flex:1;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-preset-option .acu-preset-delete-btn{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0);border:none;border-radius:4px;color:var(--acu-text-sub);cursor:pointer;opacity:0;transition:all .15s ease}.acu-preset-option .acu-preset-delete-btn:hover{background:rgba(231,76,60,.1);color:#e74c3c}.acu-preset-option .acu-preset-delete-btn i{font-size:10px}.acu-preset-option:hover .acu-preset-delete-btn{opacity:1}.acu-preset-actions{display:flex;gap:8px}.acu-global-widget{width:100%;height:auto;min-height:100%;display:block;color:var(--acu-text-main);position:relative}.acu-global-header{display:flex;flex-direction:column;gap:8px;width:100%;padding:12px 16px}.acu-global-body{display:flex;flex-wrap:wrap;gap:8px;width:100%;padding:0 16px 12px 16px}.acu-global-footer{width:100%;padding:0 16px 12px 16px}.acu-global-time-group{display:flex;align-items:center;gap:12px;flex-wrap:wrap}.acu-global-widget .acu-global-time-primary{display:flex;align-items:center;gap:8px;font-size:1.4em;font-weight:600;color:var(--acu-title-color)}.acu-global-widget .acu-global-time-primary *{font-size:inherit}.acu-global-widget .acu-global-time-primary i{opacity:.8}.acu-global-time-secondary{display:flex;gap:8px}.acu-global-widget .acu-global-location{display:flex;align-items:center;gap:10px;font-size:1.5em;font-weight:600;line-height:1.4;color:var(--acu-text-main)}.acu-global-widget .acu-global-location *{font-size:inherit}.acu-global-widget .acu-global-location i{color:var(--acu-title-color);font-size:.9em;flex-shrink:0;opacity:.8}.acu-global-widget .acu-global-location .location-path{display:flex;flex-wrap:wrap;align-items:center;gap:6px}.acu-global-widget .acu-global-location .location-part{font-weight:500}.acu-global-widget .acu-global-location .location-part:last-child{color:var(--acu-title-color);font-weight:600}.acu-global-widget .acu-global-location .location-sep{color:var(--acu-text-sub);font-size:.8em;opacity:.6}.acu-global-item{display:flex;align-items:center;background:rgba(0,0,0,.03);border-radius:var(--acu-radius-md);padding:6px 10px;font-size:.95em;transition:all .2s ease;border:1px solid rgba(0,0,0,0)}.acu-theme-dark .acu-global-item{background:hsla(0,0%,100%,.05)}.acu-global-item:hover{background:var(--acu-table-hover);border-color:var(--acu-border)}.acu-global-item.layout-inline{width:auto;flex-grow:1;max-width:48%;min-width:120px}.acu-global-item.layout-inline.people-group{max-width:100%}.acu-global-item.layout-block{width:100%;background:rgba(0,0,0,.02)}.acu-global-item.layout-block .item-value{white-space:normal}.acu-global-item .item-icon{flex-shrink:0;width:20px;text-align:center;margin-right:8px;color:var(--acu-text-sub);font-size:.9em}.acu-global-item .item-content{display:flex;flex-direction:column;flex:1;min-width:0}.acu-global-item .item-label{font-size:.75em;color:var(--acu-text-sub);margin-bottom:2px}.acu-global-item .item-value{font-weight:500;color:var(--acu-text-main);line-height:1.3}.acu-global-person-list{display:flex;flex-wrap:wrap;gap:6px;width:100%;padding-top:4px}.acu-global-person-list .person-tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;background:var(--acu-badge-bg);border-radius:12px;font-size:.85em;color:var(--acu-text-main);border:1px solid rgba(0,0,0,0);transition:all .2s}.acu-global-person-list .person-tag:hover{border-color:var(--acu-title-color);color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-global-person-list .person-tag:hover i{opacity:1}.acu-badge-outline{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border:1px solid var(--acu-border);border-radius:10px;font-size:.85em;color:var(--acu-text-sub);white-space:nowrap}.acu-badge-outline i{font-size:.9em}.acu-badge-outline.is-highlight{color:var(--acu-title-color);border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.rwp-header{cursor:pointer}.rwp-body{padding:8px;max-height:400px;overflow-y:auto}.rwp-column-group{margin-bottom:8px;border-radius:8px;background:var(--acu-card-bg)}.rwp-column-group:last-child{margin-bottom:0}.rwp-column-group.collapsed .rwp-group-content{display:none}.rwp-group-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--acu-table-head);cursor:pointer;transition:background .15s ease;border-radius:8px}.rwp-group-header:hover{background:var(--acu-table-hover)}.rwp-group-header .rwp-header-left{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--acu-text-main)}.rwp-group-header .rwp-header-left i{font-size:10px;color:var(--acu-text-sub);transition:transform .2s ease}.rwp-group-header .rwp-column-name{font-weight:500}.rwp-group-header .rwp-word-count{font-size:11px;color:var(--acu-text-sub)}.rwp-group-header .rwp-header-right{display:flex;align-items:center;gap:8px}.rwp-limit-wrapper{position:relative;display:flex;align-items:center}.rwp-limit-popover{position:absolute;top:calc(100% + 8px);right:0;width:200px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:var(--acu-radius-md);box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;padding:12px;cursor:default}.rwp-limit-popover .popover-header{font-size:12px;color:var(--acu-text-sub);margin-bottom:8px}.rwp-limit-popover .popover-body{display:flex;flex-direction:column;gap:8px}.rwp-limit-popover .limit-control{display:flex;align-items:center;gap:8px}.rwp-limit-popover .limit-control input[type=range]{flex:1}.rwp-limit-popover .limit-control .limit-value{font-size:13px;font-weight:500;min-width:32px;text-align:right}.rwp-limit-popover .popover-actions{display:flex;justify-content:flex-end}.rwp-group-content{display:flex;flex-wrap:wrap;gap:6px;padding:10px 12px;background:var(--acu-card-bg);border-top:1px solid var(--acu-border)}.rwp-word-badge{display:inline-flex;align-items:center;padding:4px 10px;font-size:12px;color:var(--acu-text-main);background:var(--acu-btn-bg);border-radius:12px;transition:all .15s ease}.rwp-word-badge:hover{background:var(--acu-btn-hover)}.rwp-word-badge.disabled{opacity:.5;color:var(--acu-text-sub)}.rwp-empty-hint{font-size:12px;color:var(--acu-text-sub);font-style:italic}@media (max-width:768px){.rwp-body{max-height:300px}.rwp-group-header{padding:8px 10px}.rwp-group-content{padding:8px 10px}.rwp-word-badge{padding:3px 8px;font-size:11px}}.acu-modal-container{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw !important;height:100vh !important;z-index:2147483647;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);animation:acu-fadeIn .2s ease;pointer-events:auto !important}.acu-modal{position:relative;width:90%;max-width:500px;max-height:80vh;background:var(--acu-bg-panel);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);display:flex;flex-direction:column;overflow:hidden;animation:acu-slideUp .3s ease}.acu-modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--acu-border);background:var(--acu-table-head)}.acu-modal-header h3{margin:0;font-size:16px;font-weight:600;color:var(--acu-text-main);display:flex;align-items:center;gap:8px}.acu-modal-header h3 i{color:var(--acu-title-color)}.acu-modal-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);font-size:18px;cursor:pointer;border-radius:8px;transition:all .2s ease}.acu-modal-close:hover{background:rgba(231,76,60,.15);color:#e74c3c}.acu-modal-body{flex:1;padding:20px;overflow-y:auto;overflow-x:hidden;scrollbar-width:thin !important;scrollbar-color:var(--acu-border) rgba(0,0,0,0) !important}.acu-modal-body::-webkit-scrollbar{width:6px !important;height:6px !important}.acu-modal-body::-webkit-scrollbar-track{background:rgba(0,0,0,0) !important}.acu-modal-body::-webkit-scrollbar-thumb{background:var(--acu-border) !important;border-radius:3px !important}.acu-modal-body::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub) !important}.acu-modal-body::-webkit-scrollbar-corner{background:rgba(0,0,0,0) !important}.acu-modal-footer{display:flex;align-items:center;justify-content:flex-end;gap:12px;padding:16px 20px;border-top:1px solid var(--acu-border);background:var(--acu-bg-panel)}.acu-close-pill{background-color:var(--acu-text-main,#333) !important;color:var(--acu-bg-panel,#fff) !important;border:none !important;padding:6px 20px;border-radius:20px;font-weight:bold;font-size:13px;cursor:pointer;box-shadow:0 4px 10px var(--acu-title-color-bg,rgba(74,158,255,0.2));transition:transform .2s,filter .2s;display:inline-flex;align-items:center;justify-content:center;margin-left:auto}.acu-close-pill:hover{filter:brightness(0.85);transform:scale(1.05)}.modal-enter-active,.modal-leave-active{transition:opacity .2s ease}.modal-enter-active .acu-modal,.modal-leave-active .acu-modal{transition:transform .3s cubic-bezier(0.4,0,0.2,1)}.modal-enter-from,.modal-leave-to{opacity:0}.modal-enter-from .acu-modal,.modal-leave-to .acu-modal{transform:scale(0.95) translateY(-20px)}.acu-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2147483647;display:flex;align-items:center;gap:10px;padding:14px 24px;border-radius:12px;font-size:14px;font-weight:500;box-shadow:0 8px 32px rgba(0,0,0,.25);backdrop-filter:blur(10px);pointer-events:none;background:var(--acu-bg-panel);color:var(--acu-text-main);border:1px solid var(--acu-border)}.acu-toast i{font-size:18px;flex-shrink:0;color:var(--acu-text-main)}.acu-toast .acu-toast-message{max-width:300px;line-height:1.4}.toast-enter-active,.toast-leave-active{transition:all .35s cubic-bezier(0.4,0,0.2,1)}.toast-enter-from{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.9)}.toast-leave-to{opacity:0;transform:translateX(-50%) translateY(-10px) scale(0.95)}.acu-graph-settings-modal{max-width:480px}.acu-graph-settings-modal .acu-modal-body{padding:0}.acu-background-config-section{margin-top:12px}.acu-background-preview-container{margin-bottom:12px}.acu-background-preview{position:relative;width:100%;height:150px;border:1px solid var(--acu-border);border-radius:12px;background:var(--acu-table-head);overflow:hidden;cursor:grab;-webkit-user-select:none;user-select:none;transition:border-color .2s ease}.acu-background-preview.dragging{cursor:grabbing;border-color:var(--acu-title-color)}.acu-background-preview.has-image{background:rgba(0,0,0,0)}.acu-background-preview:hover{border-color:var(--acu-title-color)}.acu-preview-image{width:100%;height:100%;background-size:cover;background-position:center;background-repeat:no-repeat;transition:background-position .05s ease}.acu-no-image-hint{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:var(--acu-text-sub)}.acu-no-image-hint i{font-size:32px;opacity:.5}.acu-no-image-hint span{font-size:12px;opacity:.7}.acu-background-actions{display:flex;gap:8px;margin-bottom:12px}.acu-background-actions .acu-action-btn{flex:1;height:36px;font-size:13px;gap:6px}.acu-background-actions .acu-action-btn i{font-size:14px}.acu-url-input-row{margin-bottom:12px}.acu-url-input-row .acu-background-url-input{width:100%;padding:10px 12px !important;background:var(--acu-btn-bg) !important;border:1px solid var(--acu-border) !important;border-radius:8px !important;color:var(--acu-text-main) !important;font-size:12px !important;font-family:monospace !important}.acu-url-input-row .acu-background-url-input:focus{border-color:var(--acu-title-color) !important;box-shadow:0 0 0 2px var(--acu-title-color-bg) !important}.acu-url-input-row .acu-background-url-input::placeholder{color:var(--acu-text-sub) !important;opacity:.7 !important}.acu-faction-color-hint{display:flex;align-items:center;gap:16px;padding:8px 16px;margin-bottom:8px;font-size:11px;color:var(--acu-text-sub)}.acu-faction-color-hint .hint-item{display:flex;align-items:center;gap:4px}.acu-faction-color-hint .hint-box{width:14px;height:14px;border-radius:3px}.acu-faction-color-hint .hint-box.dashed{border:2px dashed var(--acu-text-sub);background:rgba(0,0,0,0)}.acu-faction-color-hint .hint-box.solid{background:var(--acu-text-sub);opacity:.3}.acu-faction-color-group{padding:12px 16px;background:var(--acu-table-head);border-radius:12px;border:none}.acu-faction-color-group.acu-faction-color-scrollable{max-height:200px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--acu-border) rgba(0,0,0,0)}.acu-faction-color-group.acu-faction-color-scrollable::-webkit-scrollbar{width:6px}.acu-faction-color-group.acu-faction-color-scrollable::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-faction-color-group.acu-faction-color-scrollable::-webkit-scrollbar-thumb{background:var(--acu-border);border-radius:3px}.acu-faction-color-group.acu-faction-color-scrollable::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub)}.acu-faction-color-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0}.acu-faction-color-row:not(:last-child){border-bottom:1px solid var(--acu-border)}.acu-faction-color-row .acu-settings-label{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px;font-weight:500;color:var(--acu-text-main)}.acu-faction-color-control{display:flex;align-items:center;gap:8px;flex-shrink:0}.acu-faction-color-control input[type=color]{width:28px !important;height:28px !important}.acu-faction-color-control .acu-opacity-slider{width:60px !important;height:14px !important}.acu-faction-color-control .acu-opacity-value{font-size:11px;color:var(--acu-text-sub);width:32px;text-align:right}.acu-legend-items-section{margin-top:12px}.acu-legend-items-header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;font-size:12px;font-weight:500;color:var(--acu-text-sub)}.acu-legend-items-list{max-height:200px;overflow-y:auto;padding:8px 16px;background:var(--acu-table-head);border-radius:12px;margin:0 16px;scrollbar-width:thin;scrollbar-color:var(--acu-border) rgba(0,0,0,0)}.acu-legend-items-list::-webkit-scrollbar{width:6px}.acu-legend-items-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.acu-legend-items-list::-webkit-scrollbar-thumb{background:var(--acu-border);border-radius:3px}.acu-legend-items-list::-webkit-scrollbar-thumb:hover{background:var(--acu-text-sub)}.acu-legend-item-row{padding:10px 0;display:flex;align-items:center;justify-content:space-between;gap:8px}.acu-legend-item-row:not(:last-child){border-bottom:1px solid var(--acu-border)}.acu-legend-item-display{display:flex;align-items:center;gap:8px;flex:1;min-width:0}.acu-legend-color-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.15)}.acu-legend-emoji{font-size:14px;flex-shrink:0}.acu-legend-label{font-size:13px;font-weight:500;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-legend-keywords{display:flex;align-items:center;gap:4px;flex-wrap:wrap;margin-left:auto}.acu-legend-keyword-tag{font-size:10px;padding:2px 6px;background:var(--acu-btn-bg);color:var(--acu-text-sub);border-radius:4px;white-space:nowrap}.acu-legend-keyword-more{font-size:10px;color:var(--acu-text-sub)}.acu-legend-item-actions{display:flex;align-items:center;gap:4px;flex-shrink:0}.acu-legend-action-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);border-radius:6px;cursor:pointer;transition:all .2s ease}.acu-legend-action-btn:hover{background:var(--acu-btn-bg);color:var(--acu-text-main)}.acu-legend-action-btn.acu-legend-action-btn-danger:hover{background:rgba(231,76,60,.15);color:#e74c3c}.acu-legend-action-btn i{font-size:12px}.acu-legend-item-edit{flex:1;display:flex;flex-direction:column;gap:8px}.acu-legend-edit-row{display:flex;align-items:center;gap:8px}.acu-legend-input{flex:1;min-width:80px;padding:6px 10px !important;font-size:12px !important}.acu-legend-color-input{width:32px !important;height:32px !important;padding:2px !important;flex-shrink:0}.acu-legend-emoji-input{width:48px !important;padding:6px 8px !important;font-size:14px !important;text-align:center;flex-shrink:0}.acu-legend-keywords-input{flex:1;padding:6px 10px !important;font-size:12px !important}.acu-legend-edit-actions{display:flex;align-items:center;gap:6px;justify-content:flex-end}.acu-legend-empty{padding:16px;text-align:center;color:var(--acu-text-sub);font-size:12px}.acu-legend-reset-wrapper{margin-top:12px;padding:0 16px;display:flex;justify-content:center}.acu-action-btn-small{padding:6px 12px !important;font-size:12px !important}.acu-action-btn-small i{font-size:11px !important}.acu-action-btn-primary{background:var(--acu-title-color) !important;color:#fff !important}.acu-action-btn-primary:hover{filter:brightness(1.1)}.acu-faction-settings-modal{max-width:400px}.acu-faction-settings-modal .acu-modal-body{padding:0;padding-bottom:var(--acu-safe-area-bottom,20px)}.acu-faction-settings-modal .acu-action-row{display:flex;justify-content:space-between;gap:12px}.acu-faction-settings-modal .acu-action-row .acu-action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s ease}.acu-faction-settings-modal .acu-action-row .acu-action-btn i{font-size:12px}.acu-faction-settings-modal .acu-action-row .acu-action-btn-primary{background:var(--acu-title-color);color:#fff}.acu-faction-settings-modal .acu-action-row .acu-action-btn-primary:hover{filter:brightness(1.1)}.acu-faction-settings-modal .acu-action-row .acu-action-btn-secondary{background:var(--acu-btn-bg);color:var(--acu-text-main)}.acu-faction-settings-modal .acu-action-row .acu-action-btn-secondary:hover{background:var(--acu-btn-hover)}.acu-node-config-modal{max-width:420px}.acu-node-config-modal .acu-modal-body{padding:0;padding-bottom:var(--acu-safe-area-bottom,20px)}.acu-node-config-modal .acu-node-hint{font-size:12px;color:var(--acu-text-sub);margin-bottom:12px}.acu-node-config-modal .acu-char-selector{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}.acu-node-config-modal .acu-char-btn{min-width:36px;height:36px;padding:0 12px;border:2px solid var(--acu-border);border-radius:8px;background:var(--acu-btn-bg);color:var(--acu-text-main);font-size:14px;font-weight:500;cursor:pointer;transition:all .2s ease}.acu-node-config-modal .acu-char-btn:hover{border-color:var(--acu-title-color);background:var(--acu-btn-hover)}.acu-node-config-modal .acu-char-btn.active{border-color:var(--acu-title-color);background:var(--acu-title-color);color:#fff}.acu-node-config-modal .acu-node-preview{font-size:13px;color:var(--acu-text-main);padding:8px 12px;background:var(--acu-card-bg);border-radius:6px;margin-bottom:12px}.acu-node-config-modal .acu-node-config-actions{display:flex;justify-content:flex-end;gap:8px}.acu-node-config-modal .acu-node-config-actions .acu-action-btn{padding:8px 16px;border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s ease}.acu-node-config-modal .acu-node-config-actions .acu-action-btn.secondary{background:var(--acu-btn-bg);color:var(--acu-text-main)}.acu-node-config-modal .acu-node-config-actions .acu-action-btn.secondary:hover{background:var(--acu-btn-hover)}.acu-node-config-modal .acu-node-config-actions .acu-action-btn.primary{background:var(--acu-title-color);color:#fff}.acu-node-config-modal .acu-node-config-actions .acu-action-btn.primary:hover{filter:brightness(1.1)}.acu-node-config-modal .acu-action-row{display:flex;justify-content:space-between;gap:12px}.acu-node-config-modal .acu-action-row .acu-action-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s ease}.acu-node-config-modal .acu-action-row .acu-action-btn i{font-size:12px}.acu-node-config-modal .acu-action-row .acu-action-btn-primary{background:var(--acu-title-color);color:#fff}.acu-node-config-modal .acu-action-row .acu-action-btn-primary:hover{filter:brightness(1.1)}.acu-node-config-modal .acu-action-row .acu-action-btn-secondary{background:var(--acu-btn-bg);color:var(--acu-text-main)}.acu-node-config-modal .acu-action-row .acu-action-btn-secondary:hover{background:var(--acu-btn-hover)}.acu-input-floor-modal{max-width:400px}.floor-input-group{display:flex;flex-direction:column;gap:12px}.floor-input{width:100%;padding:12px 16px;font-size:16px;text-align:center;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main)}.floor-input:focus{outline:none;border-color:var(--acu-title-color)}.floor-hint{font-size:12px;color:var(--acu-text-sub);text-align:center}.floor-info{display:flex;align-items:center;gap:8px;padding:12px;background:var(--acu-table-head);border-radius:8px;font-size:13px;color:var(--acu-text-sub)}.floor-info i{color:var(--acu-title-color)}.floor-error{display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:8px;font-size:13px;color:#e74c3c}.acu-purge-overlay{display:flex !important;align-items:center !important;justify-content:center !important;padding-top:0 !important}.acu-purge-range-modal{width:85%;max-width:360px;height:auto;margin:0;box-shadow:0 25px 50px rgba(0,0,0,.5);overflow:visible;border-radius:16px;background:var(--acu-bg-panel)}.acu-purge-title{text-align:center;border-bottom:none;padding:25px 20px 0 20px;font-size:18px;font-weight:600;color:var(--acu-text-main)}.acu-purge-content{padding:20px 30px;display:flex;flex-direction:column;align-items:center;gap:15px}.acu-purge-icon{width:50px;height:50px;background:rgba(231,76,60,.15);color:#e74c3c;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:5px}.acu-purge-hint{font-size:13px;color:var(--acu-text-sub);margin:0;text-align:center;line-height:1.4}.acu-purge-hint-sub{opacity:.7;font-size:12px}.acu-purge-inputs{display:flex;gap:10px;align-items:center;justify-content:center;width:100%}.acu-purge-input{text-align:center;font-size:20px;font-weight:bold;height:50px;width:100px;border-radius:12px;background:var(--acu-input-bg,var(--acu-btn-bg));border:2px solid var(--acu-border);color:var(--acu-text-main);transition:border-color .2s ease}.acu-purge-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-purge-input::placeholder{color:var(--acu-text-sub);opacity:.5;font-weight:normal;font-size:14px}.acu-purge-input::-webkit-outer-spin-button,.acu-purge-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.acu-purge-input[type=number]{-moz-appearance:textfield}.acu-purge-separator{font-weight:bold;color:var(--acu-text-main);font-size:18px}.acu-purge-btns{padding:0 20px 25px 20px;border-top:none;display:flex;justify-content:space-between;gap:10px}.acu-purge-btn{flex:1;display:flex;justify-content:center;align-items:center;padding:10px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;border:none;transition:all .2s ease}.acu-purge-btn-cancel{background:var(--acu-btn-bg);color:var(--acu-text-main)}.acu-purge-btn-cancel:hover{background:var(--acu-btn-hover)}.acu-purge-btn-confirm{background:#e74c3c;color:#fff}.acu-purge-btn-confirm:hover:not(:disabled){background:#c0392b}.acu-purge-btn-confirm:disabled{opacity:.5;cursor:not-allowed}.acu-purge-btn-advanced{flex:0 0 auto;background:rgba(0,0,0,0);color:var(--acu-text-sub);border:1px solid var(--acu-border);gap:6px}.acu-purge-btn-advanced:hover{background:var(--acu-btn-bg);color:var(--acu-title-color);border-color:var(--acu-title-color)}.acu-purge-btn-advanced i{font-size:12px}.acu-purge-btns-right{display:flex;gap:10px;flex:1}.acu-advanced-purge-modal{max-width:520px;max-height:85vh}.acu-advanced-purge-modal .acu-modal-body{padding:16px;overflow-y:auto;max-height:calc(85vh - 120px)}.acu-purge-range-row{display:flex;align-items:center;justify-content:center;gap:12px;padding:8px 0}.acu-purge-range-row .acu-purge-input{width:100px;height:44px;font-size:18px}.acu-purge-range-row .acu-purge-separator{font-size:20px;color:var(--acu-text-sub)}.acu-purge-range-hint{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:8px;font-size:12px;color:var(--acu-text-sub)}.acu-purge-range-hint i{font-size:11px}.acu-purge-quick-actions{display:flex;justify-content:center;gap:8px;margin-top:8px}.acu-purge-warning{display:flex;align-items:center;gap:10px;margin-top:12px;padding:12px 16px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:10px;color:#e74c3c;font-size:13px}.acu-purge-warning i{font-size:16px;flex-shrink:0}.acu-purge-warning span{line-height:1.4}@media (max-width:768px){.acu-advanced-purge-modal{max-width:none;max-height:70vh}.acu-advanced-purge-modal .acu-modal-body{max-height:calc(70vh - 120px)}.acu-purge-range-row .acu-purge-input{width:80px;height:40px;font-size:16px}}.acu-add-table-modal{max-width:520px;max-height:85vh}.acu-add-table-modal .acu-modal-body{padding:16px;overflow-y:auto;max-height:calc(85vh - 120px);display:flex;flex-direction:column;gap:16px}.acu-add-table-tabs{display:flex;gap:8px;border-bottom:1px solid var(--acu-border);padding-bottom:8px;margin-bottom:8px}.acu-add-table-paste{display:flex;flex-direction:column;gap:12px}.acu-add-table-paste .acu-textarea-scrollable{min-height:150px;font-family:monospace;font-size:12px}.acu-add-table-file{display:flex;justify-content:center;padding:20px 0}.acu-add-table-file .acu-file-label{display:flex;flex-direction:column;align-items:center;gap:12px;padding:30px;border:2px dashed var(--acu-border);border-radius:12px;cursor:pointer;transition:all .2s ease;width:100%;max-width:300px;background:var(--acu-bg-panel)}.acu-add-table-file .acu-file-label:hover{border-color:var(--acu-title-color);background:var(--acu-btn-hover)}.acu-add-table-file .acu-file-label i{font-size:32px;color:var(--acu-text-sub)}.acu-add-table-file .acu-file-label span{font-size:14px;color:var(--acu-text-main)}.acu-add-table-error{display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.3);border-radius:8px;font-size:13px;color:#e74c3c;word-break:break-all}.acu-add-table-error i{flex-shrink:0}.acu-add-table-list{display:flex;flex-direction:column;gap:12px;border-top:1px solid var(--acu-border);padding-top:16px}@media (max-width:768px){.acu-add-table-modal{max-width:none;max-height:70vh}.acu-add-table-modal .acu-modal-body{max-height:calc(70vh - 120px)}}.acu-manual-update-modal{max-width:95%;max-height:80vh}@media (min-width:601px){.acu-manual-update-modal{max-width:800px;max-height:85vh}}.acu-manual-update-modal .acu-modal-body{padding:0;overflow-y:auto;max-height:calc(80vh - 60px)}@media (min-width:601px){.acu-manual-update-modal .acu-modal-body{max-height:calc(85vh - 60px);padding:20px}}.acu-manual-update-modal .acu-settings-group{padding:12px 16px}.acu-manual-update-modal .acu-settings-row{padding:8px 0}.acu-loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:48px 20px;color:var(--acu-text-sub)}.acu-loading-state i{font-size:24px;color:var(--acu-title-color)}.acu-loading-state span{font-size:14px}.acu-config-input{width:80px;padding:8px 12px;font-size:14px;text-align:center;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);transition:all .2s ease}.acu-config-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-config-input:hover:not(:focus){border-color:var(--acu-text-sub)}.acu-config-input::-webkit-inner-spin-button,.acu-config-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.acu-config-input{-moz-appearance:textfield}.acu-update-action-group{padding:12px 16px 16px;display:flex;flex-direction:column;align-items:center}.acu-update-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 24px;font-size:15px;font-weight:600;color:var(--acu-text-main);background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:12px;cursor:pointer;transition:all .2s ease}.acu-update-btn i{font-size:18px;color:var(--acu-title-color)}.acu-update-btn:hover:not(:disabled){background:var(--acu-btn-hover);transform:translateY(-1px)}.acu-update-btn:active:not(:disabled){transform:translateY(0)}.acu-update-btn:disabled{opacity:.7;cursor:not-allowed}.acu-update-btn.is-updating{opacity:.7}@media (max-width:768px){.acu-manual-update-modal{max-width:none;max-height:70vh}.acu-manual-update-modal .acu-modal-body{max-height:calc(70vh - 60px)}.acu-manual-update-modal .acu-config-input{width:100px}.acu-update-btn{padding:16px 24px;font-size:16px}}.acu-preset-control{display:flex;align-items:center;gap:6px;margin-left:auto}.acu-config-select{min-width:120px;padding:8px 12px;font-size:13px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);cursor:pointer;transition:all .2s ease}.acu-config-select:focus{outline:none;border-color:var(--acu-title-color)}.acu-config-select:hover:not(:focus){border-color:var(--acu-text-sub)}.acu-tool-btn.acu-btn-danger:hover{background:rgba(231,76,60,.1);border-color:#e74c3c;color:#e74c3c}.acu-issue-alert{display:flex;align-items:center;gap:10px;margin:0 16px 12px;padding:12px 16px;background:rgba(245,108,108,.1);border:1px solid rgba(245,108,108,.3);border-radius:10px;color:#f56c6c;font-size:13px}.acu-issue-alert i{font-size:16px;flex-shrink:0}.acu-issue-alert span{line-height:1.4}.acu-preset-save-modal{max-width:360px}@media (max-width:768px){.acu-preset-save-modal{width:90vw;max-width:340px;margin:auto;border-radius:16px}}.acu-preset-warning{display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px 14px;background:rgba(243,156,18,.1);border:1px solid rgba(243,156,18,.3);border-radius:8px;color:#f39c12;font-size:12px}.acu-preset-warning i{font-size:14px;flex-shrink:0}.acu-preset-summary{margin-top:12px;padding:12px 14px;background:var(--acu-table-head);border-radius:8px;font-size:12px}.acu-preset-summary .acu-preset-summary-title{font-weight:600;color:var(--acu-text-main);margin-bottom:8px}.acu-preset-summary .acu-preset-summary-list{margin:0;padding-left:16px;color:var(--acu-text-sub);line-height:1.6}.acu-preset-summary .acu-preset-summary-list li{margin:2px 0}.acu-history-modal{min-width:800px;max-width:1200px;max-height:90vh}.acu-history-modal .acu-pc-only{display:block}.acu-history-modal .acu-mobile-only{display:none}.acu-history-modal .acu-modal-body{padding:0;overflow:hidden}.acu-history-layout.acu-pc-layout{display:flex;height:calc(90vh - 60px);overflow:hidden}.acu-history-layout.acu-pc-layout .acu-history-sidebar{flex:1;min-width:320px;max-width:480px;overflow-y:auto;border-right:1px solid var(--acu-border);padding:20px 24px;background:var(--acu-table-head)}.acu-history-layout.acu-pc-layout .acu-history-main{flex:1;min-width:320px;display:flex;flex-direction:column;padding:20px 24px;overflow:hidden}.acu-history-list{display:flex;flex-direction:column;gap:8px}.acu-history-item{border:1px solid var(--acu-border);border-radius:8px;background:var(--acu-card-bg);overflow:hidden}.acu-history-item[open] .acu-history-summary{border-bottom:1px solid var(--acu-border)}.acu-history-summary{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;transition:background .2s;list-style:none}.acu-history-summary::-webkit-details-marker{display:none}.acu-history-summary::before{content:"▶";font-size:10px;transition:transform .2s}.acu-history-summary:hover{background:var(--acu-table-hover)}details[open]>.acu-history-summary::before{transform:rotate(90deg)}.acu-history-badge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold}.acu-history-badge.manual{background:var(--acu-highlight-manual-bg,rgba(211,84,0,0.15));color:var(--acu-highlight-manual,#d35400)}.acu-history-badge.ai{background:var(--acu-highlight-ai-bg,rgba(52,152,219,0.15));color:var(--acu-highlight-ai,#3498db)}.acu-history-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-history-time{font-size:11px;color:var(--acu-text-sub);font-weight:normal;flex-shrink:0}.acu-history-card-wrapper{padding:8px}.acu-history-card-wrapper .acu-data-card{width:100% !important;flex:none !important}.acu-current-card .acu-data-card,.acu-current-scroll .acu-data-card{width:100% !important;flex:none !important}.acu-current-card-label{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:13px;font-weight:600;color:var(--acu-text-main);background:var(--acu-table-head);border-radius:8px 8px 0 0;border:1px solid var(--acu-border);border-bottom:none}.acu-current-card-label i{color:var(--acu-title-color)}.acu-current-card-label .acu-changes-count{font-weight:normal;color:var(--acu-title-color)}.acu-current-card{flex:1;overflow-y:auto;border:1px solid var(--acu-border);border-top:none;border-radius:0 0 8px 8px;padding:8px;margin-bottom:12px}.acu-history-actions{display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--acu-border);flex-wrap:wrap}.acu-history-actions .acu-btn-start-edit{flex:1}@media (max-width:768px){.acu-modal-container{align-items:flex-end;justify-content:stretch}.acu-modal{width:100%;max-width:none;max-height:85vh;border-radius:20px 20px 0 0;margin:0}.acu-settings-modal{max-width:none;max-height:85vh}.acu-settings-modal .acu-drag-handle{display:none}.acu-settings-modal .acu-modal-header{padding:10px 16px}.modal-enter-from .acu-modal,.modal-leave-to .acu-modal{transform:translateY(100%)}.acu-modal-header{position:relative;padding-top:24px}.acu-drag-handle{position:absolute;top:0;left:50%;transform:translateX(-50%);width:80px;height:20px;cursor:grab;touch-action:none;z-index:10}.acu-drag-handle::after{content:"";position:absolute;top:8px;left:50%;transform:translateX(-50%);width:36px;height:4px;background:var(--acu-border);border-radius:2px;transition:background .2s}.acu-drag-handle:active::after{background:var(--acu-title-color)}.acu-modal-header.dragging .acu-drag-handle::after{background:var(--acu-title-color)}.acu-modal-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}.acu-modal-container.acu-center-modal{align-items:center !important;justify-content:center !important;padding:20px}.acu-modal-container.acu-center-modal .acu-modal{width:90%;max-width:400px;max-height:80vh;border-radius:16px;margin:0}.acu-modal-container.acu-center-modal .acu-modal-header{padding-top:16px}.acu-modal-container.acu-center-modal .acu-modal-header::before{display:none}}.acu-history-layout.acu-mobile-layout{display:none;flex-direction:column;height:calc(100vh - 60px);overflow:hidden}.acu-history-layout.acu-mobile-layout .acu-history-mobile-list{flex:1;min-height:0;overflow-y:auto;padding:12px}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section{flex:1;display:flex;flex-direction:column;min-height:0;border-bottom:1px solid var(--acu-border)}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-section-label{padding:8px 12px;font-size:12px;font-weight:600;color:var(--acu-text-sub);background:var(--acu-table-head);display:flex;align-items:center;gap:6px;flex-shrink:0}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-section-label i{color:var(--acu-title-color)}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-history-scroll{flex:1;overflow-y:auto;padding:8px}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section{flex:1.5;display:flex;flex-direction:column;min-height:0}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label{padding:8px 12px;font-size:12px;font-weight:600;color:var(--acu-text-sub);background:var(--acu-table-head);display:flex;align-items:center;gap:6px;flex-shrink:0}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label i{color:var(--acu-title-color)}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label .acu-changes-count{color:var(--acu-title-color);font-weight:normal}.acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-current-scroll{flex:1;min-height:0;overflow-y:auto;padding:8px}.acu-history-layout.acu-mobile-layout .acu-mobile-actions{flex-shrink:0;padding:10px 12px;padding-bottom:calc(24px + var(--acu-safe-area-bottom,50px));background:var(--acu-bg-panel);border-top:1px solid var(--acu-border);display:flex;flex-wrap:wrap;gap:8px;box-shadow:0 -4px 12px rgba(0,0,0,.15)}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button{flex:1;min-width:80px;min-height:42px;padding:8px 10px;border-radius:8px;border:1px solid var(--acu-border);background:var(--acu-btn-bg);color:var(--acu-text-main);font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:4px;white-space:nowrap}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button:disabled{opacity:.5;cursor:not-allowed}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button.acu-btn-primary{background:var(--acu-title-color);color:#fff;border:none}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button.acu-btn-preview{background:var(--acu-table-head)}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button.acu-btn-done{flex-basis:100%;background:var(--acu-title-color);color:#fff;border:none}.acu-history-layout.acu-mobile-layout .acu-mobile-actions button i{font-size:12px}.acu-history-layout.acu-mobile-layout .acu-preview-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:2147483641;display:flex;align-items:center;justify-content:center;padding:20px;pointer-events:none}.acu-history-layout.acu-mobile-layout .acu-preview-overlay :deep(.acu-data-card){width:100%;max-height:80vh;overflow-y:auto;background:var(--acu-bg-panel);border-radius:12px;pointer-events:auto}@media (max-width:768px){.acu-history-modal{min-width:unset;max-width:none;width:100%;max-height:100vh;height:100vh;border-radius:0}.acu-history-modal .acu-pc-only{display:none !important}.acu-history-modal .acu-mobile-only{display:block !important}.acu-history-modal .acu-modal-header{border-radius:0}.acu-history-modal .acu-modal-body{flex:1;overflow:hidden}.acu-history-modal .acu-history-layout.acu-pc-layout{display:none !important}.acu-history-modal .acu-history-layout.acu-mobile-layout{display:flex !important;flex-direction:column !important;height:calc(100vh - 60px) !important}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode{display:flex !important;flex-direction:column !important}.acu-history-modal .acu-history-layout.acu-mobile-layout .acu-history-mobile-list{flex:1;overflow-y:auto;padding:12px;padding-bottom:calc(120px + env(safe-area-inset-bottom,20px))}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode{display:flex !important;flex-direction:column !important}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section{flex:1;display:flex !important;flex-direction:column !important;min-height:0;border-bottom:1px solid var(--acu-border)}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-section-label{padding:8px 12px;font-size:12px;font-weight:600;color:var(--acu-text-sub);background:var(--acu-table-head);display:flex;align-items:center;gap:6px;flex-shrink:0}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-section-label i{color:var(--acu-title-color)}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-history-section .acu-history-scroll{flex:1;overflow-y:auto;padding:8px}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section{flex:1.5;display:flex !important;flex-direction:column !important;min-height:0}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label{padding:8px 12px;font-size:12px;font-weight:600;color:var(--acu-text-sub);background:var(--acu-table-head);display:flex;align-items:center;gap:6px;flex-shrink:0}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label i{color:var(--acu-title-color)}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-section-label .acu-changes-count{color:var(--acu-title-color);font-weight:normal}.acu-history-modal .acu-history-layout.acu-mobile-layout.acu-mobile-edit-mode .acu-mobile-current-section .acu-current-scroll{flex:1;min-height:0;overflow-y:auto;padding:8px}}.acu-ball-preview-fixed{position:sticky;top:-20px;margin:-20px -20px 16px;padding:28px 36px 12px 36px;z-index:10;display:flex;justify-content:center;align-items:center;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border)}.acu-reset-btn{position:absolute;top:24px;right:24px}.acu-settings-title-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}.acu-settings-title-row .acu-settings-title{margin-bottom:0}.acu-preview-buttons{display:flex;gap:6px;flex-shrink:0}.acu-ball-preview{position:relative;display:flex;justify-content:center;align-items:center;width:var(--ball-size,48px);height:var(--ball-size,48px);border-radius:50%;background:var(--ball-bg-color,rgba(0,0,0,0.5));border:2px solid var(--ball-border-color-rgba,rgba(255,255,255,0.3));box-shadow:0 4px 16px rgba(0,0,0,.3);transition:transform .2s ease}.acu-ball-preview i{font-size:calc(var(--ball-size,48px)*.4);color:#fff}.acu-ball-preview img{width:70%;height:70%;border-radius:50%;object-fit:cover}.acu-anim-grid{display:flex;gap:8px;width:100%}.acu-anim-option{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:10px;cursor:pointer;transition:all .2s ease}.acu-anim-option:hover{background:var(--acu-btn-hover);border-color:var(--acu-text-sub)}.acu-anim-option.active{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-anim-option .acu-anim-icon{font-size:18px;line-height:1}.acu-anim-option .acu-anim-name{font-size:12px;color:var(--acu-text-main)}.acu-color-picker-inline{display:flex;align-items:center;gap:8px}.acu-color-input{width:auto;min-width:75px;max-width:90px;padding:6px 10px;font-size:12px;font-family:monospace;text-transform:uppercase;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main)}.acu-color-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-icon-type-row{display:flex;gap:8px;width:100%}.acu-type-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 8px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:10px;cursor:pointer;transition:all .2s ease}.acu-type-btn input[type=radio]{display:none}.acu-type-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-text-sub)}.acu-type-btn.active{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-type-btn i{font-size:16px;color:var(--acu-text-main)}.acu-type-btn .emoji-icon{font-size:16px;line-height:1}.acu-type-btn>span:last-child{font-size:12px;color:var(--acu-text-main);white-space:nowrap}.acu-image-preview-row{display:flex;align-items:center;gap:12px;margin-top:10px}.acu-preview-thumb{width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--acu-border)}.acu-preview-thumb-wrapper{width:48px;height:48px;border-radius:50%;border:2px solid var(--acu-border);background-size:cover;background-position:center;cursor:pointer;position:relative;overflow:hidden;transition:all .2s ease}.acu-preview-thumb-wrapper:hover{border-color:var(--acu-title-color)}.acu-preview-thumb-wrapper:hover .acu-edit-hint{opacity:1}.acu-preview-thumb-wrapper .acu-edit-hint{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);color:#fff;font-size:14px;opacity:0;transition:opacity .2s ease}.acu-image-actions{display:flex;gap:8px}.acu-adjust-btn{display:flex;align-items:center;gap:4px;padding:6px 12px;background:var(--acu-title-color-bg);border:1px solid var(--acu-title-color);border-radius:6px;color:var(--acu-title-color);font-size:12px;cursor:pointer;transition:all .2s ease}.acu-adjust-btn:hover{background:var(--acu-title-color);color:#fff}.acu-adjust-btn i{font-size:10px}.acu-ball-appearance-panel{padding:0}.acu-preview-buttons{display:flex;gap:8px;margin-top:8px}.acu-anim-icon{font-size:20px;line-height:1}.acu-anim-name{font-size:11px;color:var(--acu-text-sub);margin-top:4px}.acu-theme-section{margin-bottom:24px}.acu-theme-section:last-child{margin-bottom:0}.acu-theme-section-title{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;color:var(--acu-text-main);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--acu-border)}.acu-theme-section-title i{font-size:14px;color:var(--acu-title-color)}.acu-highlight-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}.acu-var-group{margin-bottom:16px}.acu-var-group:last-child{margin-bottom:0}.acu-var-group-header{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--acu-table-head);border:1px solid var(--acu-border);border-radius:8px;cursor:pointer;transition:all .2s ease;-webkit-user-select:none;user-select:none}.acu-var-group-header:hover{background:var(--acu-btn-hover)}.acu-var-group-header .acu-var-group-icon{font-size:12px;color:var(--acu-text-sub);transition:transform .2s ease}.acu-var-group-header.expanded .acu-var-group-icon{transform:rotate(90deg)}.acu-css-editor{width:100%;min-height:150px;max-height:300px;padding:12px;font-family:"Consolas","Monaco",monospace;font-size:12px;line-height:1.5;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);resize:vertical}.acu-css-editor:focus{outline:none;border-color:var(--acu-title-color)}.acu-css-editor::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-css-hint{margin-top:8px;padding:10px 12px;background:var(--acu-title-color-bg);border-radius:6px;font-size:11px;color:var(--acu-text-sub);line-height:1.5}.acu-css-hint p{margin:0 0 6px 0;font-weight:500;color:var(--acu-text-main)}.acu-css-hint code{display:inline-block;background:var(--acu-btn-bg);border:1px solid var(--acu-border);padding:3px 8px;border-radius:4px;font-size:11px;font-family:"Consolas","Monaco",monospace;color:var(--acu-title-color);margin:2px 4px 2px 0}.acu-theme-actions{display:flex;gap:10px;margin-top:16px;padding-top:16px;border-top:1px solid var(--acu-border)}.acu-theme-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;font-size:12px;border-radius:8px;cursor:pointer;transition:all .2s ease}.acu-theme-btn i{font-size:11px}.acu-theme-btn.btn-primary{background:var(--acu-title-color);border:1px solid var(--acu-title-color);color:#fff}.acu-theme-btn.btn-primary:hover{filter:brightness(1.1)}.acu-theme-btn.btn-secondary{background:rgba(0,0,0,0);border:1px solid var(--acu-border);color:var(--acu-text-main)}.acu-theme-btn.btn-secondary:hover{background:var(--acu-btn-hover);border-color:var(--acu-text-sub)}.acu-theme-btn.btn-danger{background:rgba(0,0,0,0);border:1px solid var(--acu-border);color:var(--acu-text-sub)}.acu-theme-btn.btn-danger:hover{background:rgba(231,76,60,.1);border-color:#e74c3c;color:#e74c3c}.acu-var-groups-container{border:1px solid var(--acu-border);border-radius:8px;overflow:hidden}.acu-var-group{margin-bottom:0;border-bottom:1px solid var(--acu-border)}.acu-var-group:last-child,.acu-var-group.last{border-bottom:none}.acu-var-group.first .acu-var-group-header{border-radius:7px 7px 0 0}.acu-var-group.last .acu-var-group-header{border-radius:0 0 7px 7px}.acu-var-group .acu-var-group-header{border-radius:0;border:none;background:var(--acu-btn-bg)}.acu-var-group .acu-var-group-header:hover{background:var(--acu-btn-hover)}.acu-var-group-body{padding:8px 12px;background:var(--acu-table-head)}.acu-var-row{display:flex;align-items:center;gap:10px;padding:10px 0}.acu-var-row:not(:last-child){border-bottom:1px solid var(--acu-border)}.acu-var-row .acu-var-label{flex:1;font-size:13px;font-weight:600;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-var-row .acu-var-control{display:flex;align-items:center;gap:6px}.acu-var-row-tall{flex-direction:column;align-items:stretch;padding:10px 12px;gap:8px}.acu-var-line-primary{display:flex;align-items:center;justify-content:space-between;gap:10px}.acu-var-line-primary .acu-var-label{font-size:13px;font-weight:600;color:var(--acu-text-main);flex-shrink:0}.acu-var-line-secondary{display:flex;align-items:center;justify-content:space-between;gap:10px}.acu-var-name{font-size:10px;font-family:"Consolas","Monaco",monospace;color:var(--acu-text-sub);background:var(--acu-table-head);padding:2px 6px;border-radius:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;max-width:-moz-fit-content;max-width:fit-content}.acu-var-color-row{display:flex;align-items:center;gap:6px;flex:1;justify-content:flex-end;min-width:0}.acu-var-color-row .acu-color-input{width:90px;padding:4px 8px;background:var(--acu-input-bg);border:1px solid var(--acu-border);border-radius:4px;color:var(--acu-text-main);font-size:12px;text-align:center;font-family:"Consolas",monospace}.acu-var-color-row .acu-color-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-var-opacity-row{display:flex;align-items:center;gap:8px}.acu-var-opacity-row .acu-range-input{-webkit-appearance:none;appearance:none;width:80px;height:6px;background:var(--acu-border);border-radius:3px;outline:none;cursor:pointer}.acu-var-opacity-row .acu-range-input::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;cursor:pointer;-webkit-transition:transform .2s;transition:transform .2s;filter:none !important}.acu-var-opacity-row .acu-range-input::-webkit-slider-thumb:hover{transform:scale(1.2)}.acu-var-opacity-row .acu-range-input::-moz-range-thumb{width:16px;height:16px;background:var(--acu-title-color);border-radius:50%;border:none;cursor:pointer;filter:none !important}.acu-var-opacity-row .acu-range-input::-moz-range-track{height:6px;background:var(--acu-border);border-radius:3px}.acu-opacity-value{min-width:28px;font-size:11px;color:var(--acu-text-sub);text-align:right}.acu-var-count{font-size:11px;color:var(--acu-text-sub);padding:2px 8px;background:var(--acu-btn-bg);border-radius:10px;margin-left:auto;margin-right:8px}.acu-var-reset{width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:var(--acu-table-head);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-sub);cursor:pointer;transition:all .15s ease}.acu-var-reset:hover{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-var-reset i{font-size:10px}.acu-preset-save{display:flex;gap:10px;margin-top:12px}.acu-input{flex:1;padding:10px 12px;font-size:13px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);transition:border-color .2s ease}.acu-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-input::placeholder{color:var(--acu-text-sub);opacity:.7}.acu-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 16px;font-size:13px;border-radius:8px;cursor:pointer;transition:all .2s ease;white-space:nowrap}.acu-btn i{font-size:12px}.acu-btn.acu-btn-primary{background:var(--acu-title-color);border:1px solid var(--acu-title-color);color:#fff}.acu-btn.acu-btn-primary:hover{filter:brightness(1.1)}.acu-btn.acu-btn-primary:disabled{opacity:.5;cursor:not-allowed}.acu-css-actions{display:flex;gap:8px;margin-bottom:10px}.acu-btn-danger:hover{background:rgba(231,76,60,.1) !important;border-color:#e74c3c !important;color:#e74c3c !important}@media (max-width:768px){.acu-highlight-grid{grid-template-columns:repeat(2,1fr)}.acu-var-row{flex-wrap:wrap}.acu-var-row .acu-var-label{width:100%;flex:none;margin-bottom:6px}.acu-var-row .acu-var-control{flex:1}.acu-var-row-tall{flex-direction:column;align-items:stretch;gap:8px}.acu-var-color-row,.acu-var-opacity-row{justify-content:flex-end}.acu-opacity-slider{flex:1;min-width:60px}.acu-preset-save{flex-direction:column}.acu-preset-save .acu-btn{width:100%}}.acu-color-input{flex:1;padding:8px 12px;font-size:13px;font-family:monospace;text-transform:uppercase;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main)}.acu-color-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-icon-option{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:10px;cursor:pointer;transition:all .2s ease}.acu-icon-option input[type=radio]{display:none}.acu-icon-option:hover{background:var(--acu-btn-hover);border-color:var(--acu-text-sub)}.acu-icon-option.active{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-icon-option i{font-size:22px;color:var(--acu-text-main)}.acu-icon-option .emoji-icon{font-size:22px;line-height:1}.acu-icon-option>span:last-child{font-size:11px;color:var(--acu-text-sub)}.acu-icon-input-area{margin-top:12px}.acu-icon-input input,.acu-emoji-input input{width:100%;padding:10px 14px;font-size:14px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);transition:border-color .2s ease}.acu-icon-input input:focus,.acu-emoji-input input:focus{outline:none;border-color:var(--acu-title-color)}.acu-icon-input input::placeholder,.acu-emoji-input input::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-emoji-input input{font-size:18px;text-align:center}.acu-input-hint{display:block;margin-top:6px;font-size:11px;color:var(--acu-text-sub);opacity:.7}.acu-image-preview{position:relative;display:inline-flex;align-items:center;justify-content:center;width:60px;height:60px;border-radius:50%;border:2px solid var(--acu-border);overflow:hidden;background:var(--acu-table-head)}.acu-image-preview img{width:100%;height:100%;object-fit:cover}@media (max-width:768px){.acu-anim-grid{grid-template-columns:repeat(2,1fr);gap:6px}.acu-anim-option,.acu-icon-option{padding:10px 6px}.acu-anim-option i,.acu-icon-option i{font-size:16px}.acu-anim-option span,.acu-icon-option span{font-size:10px}.acu-preview-buttons{flex-wrap:wrap;justify-content:center}}.acu-font-control{display:flex;align-items:center;gap:6px}.acu-font-control select{text-align:center;text-align-last:center}.acu-font-dialog-overlay{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw !important;height:100vh !important;z-index:2147483647;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);padding:20px;box-sizing:border-box}@media (max-width:768px){.acu-font-dialog-overlay{padding:16px}.acu-font-dialog-overlay .acu-mini-dialog{width:100%;max-width:340px;max-height:calc(100vh - 100px);overflow-y:auto}}.acu-add-font-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-sub);cursor:pointer;transition:all .2s ease;flex-shrink:0}.acu-add-font-btn:hover{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-add-font-btn i{font-size:12px}.acu-add-font-dialog{max-width:380px}.acu-font-form{display:flex;flex-direction:column;gap:14px}.acu-form-row{display:flex;flex-direction:column;gap:6px}.acu-form-row label{font-size:13px;font-weight:500;color:var(--acu-text-main)}.acu-form-row label .optional{font-weight:normal;font-size:11px;color:var(--acu-text-sub);opacity:.7}.acu-form-row input{width:100%;padding:10px 12px;font-size:13px;background:var(--acu-btn-bg);border:2px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);transition:border-color .2s ease}.acu-form-row input:focus{outline:none;border-color:var(--acu-title-color)}.acu-form-row input::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-tag-toolbar{display:flex;align-items:center;gap:8px;padding:8px;margin-bottom:8px;background:var(--acu-input-bg);border-radius:6px}.acu-displayed-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:var(--acu-title-color-bg);border:1px solid var(--acu-title-color);border-radius:4px;font-size:12px}.acu-wildcard-shortcuts{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}.acu-wildcard-shortcuts .hint{font-size:11px;color:var(--acu-text-sub)}.acu-wildcard-btn{padding:4px 8px;background:var(--acu-badge-bg);border:1px solid var(--acu-border);border-radius:4px;font-family:monospace;font-size:11px;cursor:pointer;transition:all .2s}.acu-wildcard-btn:hover{background:var(--acu-btn-hover)}.acu-mini-dialog{background:var(--acu-bg-panel);border-radius:12px;padding:16px;min-width:280px;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,.3)}.acu-mini-dialog-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--acu-border)}.acu-mini-dialog-header span{font-size:15px;font-weight:600;color:var(--acu-text-main)}.acu-mini-dialog-body{margin-bottom:16px}.acu-mini-dialog-footer{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding-top:12px;border-top:1px solid var(--acu-border)}.acu-input-hint{display:block;margin-top:4px;font-size:10px;color:var(--acu-text-sub);opacity:.8}.acu-cell-menu{position:fixed;z-index:2147483647;min-width:160px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:6px;animation:acu-scaleIn .15s ease;transform-origin:top left}.acu-menu-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;font-size:13px;color:var(--acu-text-main);cursor:pointer;transition:all .15s ease;white-space:nowrap}.acu-menu-item i{width:16px;text-align:center;font-size:14px;color:var(--acu-text-sub);transition:color .15s ease}.acu-menu-item:hover{background:var(--acu-btn-hover)}.acu-menu-item:hover i{color:var(--acu-title-color)}.acu-menu-item:active{transform:scale(0.98)}.acu-menu-item.danger{color:#e74c3c}.acu-menu-item.danger i{color:#e74c3c}.acu-menu-item.danger:hover{background:rgba(231,76,60,.15)}.acu-menu-item.success{color:#27ae60}.acu-menu-item.success i{color:#27ae60}.acu-menu-item.success:hover{background:rgba(46,204,113,.15)}.acu-menu-item.disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.acu-menu-divider{height:1px;background:var(--acu-border);margin:6px 8px}.acu-cell-menu.compact{padding:4px}.acu-cell-menu.compact .acu-menu-item{padding:8px 12px;font-size:12px}.acu-cell-menu.compact .acu-menu-item i{font-size:12px}.acu-context-menu{position:fixed;z-index:var(--acu-z-menu,2147483648);min-width:160px;max-width:220px;background:var(--acu-menu-bg,#fff);border:1px solid var(--acu-border,#dcd0c0);border-radius:var(--acu-radius-md,12px);box-shadow:0 4px 16px rgba(0,0,0,.15),0 0 1px rgba(0,0,0,.1);padding:6px 0;outline:none;overflow:hidden;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);pointer-events:auto !important}.acu-context-menu .acu-menu-item{display:flex;align-items:center;gap:12px;padding:10px 16px;cursor:pointer;color:var(--acu-menu-text,#333);font-size:var(--acu-font-size,13px);transition:background var(--acu-transition-fast,0.15s),color var(--acu-transition-fast,0.15s);-webkit-user-select:none;user-select:none}.acu-context-menu .acu-menu-item i{width:16px;text-align:center;color:var(--acu-text-sub,#999);font-size:14px;transition:color var(--acu-transition-fast,0.15s)}.acu-context-menu .acu-menu-item span{flex:1}.acu-context-menu .acu-menu-item:hover{background:var(--acu-table-hover,#f0ebe0)}.acu-context-menu .acu-menu-item:active{background:var(--acu-btn-hover,#cbbba8)}.acu-context-menu .acu-menu-item.acu-menu-danger{color:var(--acu-danger,#e74c3c)}.acu-context-menu .acu-menu-item.acu-menu-danger i{color:var(--acu-danger,#e74c3c)}.acu-context-menu .acu-menu-item.acu-menu-danger:hover{background:rgba(231,76,60,.1)}.acu-context-menu .acu-menu-item.acu-menu-warning{color:var(--acu-warning,#f39c12)}.acu-context-menu .acu-menu-item.acu-menu-warning i{color:var(--acu-warning,#f39c12)}.acu-context-menu .acu-menu-item.acu-menu-warning:hover{background:rgba(243,156,18,.1)}.acu-context-menu .acu-menu-divider{height:1px;background:var(--acu-border,#dcd0c0);margin:6px 12px;opacity:.6}.acu-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:2147483640;background:rgba(0,0,0,.4);animation:acu-fadeIn .15s ease}.acu-overlay.transparent{background:rgba(0,0,0,0)}.acu-overlay.blur{backdrop-filter:blur(4px)}.acu-hidden-buttons-popup{position:absolute;bottom:calc(100% + 8px);left:0;right:0;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:8px;padding:8px;box-shadow:0 -4px 16px rgba(0,0,0,.3);z-index:100;pointer-events:auto}.acu-hidden-buttons-popup .popup-buttons-grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}.acu-hidden-buttons-popup .popup-button{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);cursor:pointer;transition:all .2s ease}.acu-hidden-buttons-popup .popup-button:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-hidden-buttons-popup .popup-button.btn-danger{color:#e74c3c}.acu-tabs-popup{position:absolute;bottom:calc(100% + 8px);left:0;right:0;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;padding:12px;box-shadow:0 -8px 24px rgba(0,0,0,.35);z-index:100;pointer-events:auto;max-height:60vh;overflow-y:auto}.acu-tabs-popup .popup-tabs-grid{display:grid;grid-template-columns:var(--acu-nav-cols,repeat(auto-fill,minmax(90px,1fr)));gap:6px}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main);font-size:12px;cursor:pointer;transition:all .2s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn i{font-size:14px;flex-shrink:0}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn span{overflow:hidden;text-overflow:ellipsis}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn.active{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color);font-weight:500}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn.has-issues{border-color:#e74c3c;box-shadow:0 0 0 2px rgba(231,76,60,.2)}.acu-tabs-popup .popup-tabs-grid .acu-nav-btn.has-ai-changes{border-color:var(--acu-highlight-ai-color,#3498db);box-shadow:0 0 0 2px rgba(52,152,219,.2)}.acu-hidden-buttons-popup{position:absolute;bottom:calc(100% + 8px);left:0;right:0;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:8px;padding:8px;box-shadow:0 -4px 16px rgba(0,0,0,.3);z-index:100;pointer-events:auto}.acu-hidden-buttons-popup .popup-buttons-grid{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}.acu-hidden-buttons-popup .popup-button{display:flex;align-items:center;justify-content:center;width:36px;height:36px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;transition:all .2s}.acu-hidden-buttons-popup .popup-button:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color);color:var(--acu-title-color);transform:translateY(-2px)}.acu-hidden-buttons-popup .popup-button:active{transform:scale(0.95)}.acu-hidden-buttons-popup .popup-button i{font-size:14px}.acu-hidden-buttons-popup .popup-button.btn-danger{color:#e74c3c}.acu-hidden-buttons-popup .popup-button.btn-danger:hover{border-color:#e74c3c;background:rgba(231,76,60,.1)}.acu-hidden-buttons-popup .popup-button.btn-toggle.active{background:var(--acu-title-color-bg,rgba(52,152,219,0.2));color:var(--acu-title-color,#3498db);border-color:var(--acu-title-color,#3498db)}.acu-more-btn.active{color:var(--acu-title-color);background:var(--acu-btn-hover)}.acu-more-btn.active i{transform:rotate(180deg)}.acu-more-btn i{transition:transform .2s ease}.acu-avatar-manager-dialog{width:90%;max-width:800px;max-height:85vh;display:flex;flex-direction:column}.acu-avatar-manager-dialog .acu-modal-body{flex:1;overflow-y:auto;padding:0;padding-bottom:var(--acu-safe-area-bottom,20px)}.acu-avatar-tab-bar{display:flex;gap:0;padding:0 12px;background:var(--acu-bg-panel);border-bottom:1px solid var(--acu-border)}.acu-avatar-tab-btn{display:flex;align-items:center;gap:6px;padding:12px 16px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);font-size:13px;font-weight:500;cursor:pointer;position:relative;transition:all .2s ease}.acu-avatar-tab-btn i{font-size:14px}.acu-avatar-tab-btn:hover{color:var(--acu-text-main);background:var(--acu-btn-hover)}.acu-avatar-tab-btn.active{color:var(--acu-title-color);font-weight:600}.acu-avatar-tab-btn.active::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:60%;height:3px;background:var(--acu-title-color);border-radius:3px 3px 0 0}.acu-avatar-search-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--acu-bg-panel);border-bottom:1px solid var(--acu-border)}.acu-avatar-search-bar>i{color:var(--acu-text-sub);font-size:14px}.acu-avatar-search-input{flex:1;padding:8px 12px;font-size:13px;background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:8px;color:var(--acu-text-main)}.acu-avatar-search-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-avatar-search-input::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-search-clear{background:none;border:none;padding:4px 8px;color:var(--acu-text-sub);cursor:pointer;font-size:12px}.acu-search-clear:hover{color:var(--acu-title-color)}.acu-avatar-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:12px;color:var(--acu-text-sub)}.acu-avatar-loading i{font-size:24px}.acu-avatar-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:12px;color:var(--acu-text-sub)}.acu-avatar-empty i{font-size:32px;opacity:.5}.acu-avatar-empty p{margin:0}.acu-avatar-items{padding:8px}.acu-avatar-item{display:flex;align-items:flex-start;gap:12px;padding:12px;margin-bottom:8px;background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:12px;position:relative;transition:all .2s ease}.acu-avatar-item:last-child{margin-bottom:0}.acu-avatar-item:hover{background:var(--acu-table-hover)}.acu-avatar-item.selected{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-avatar-checkbox{display:flex;align-items:center;justify-content:center;width:24px;height:48px;cursor:pointer;color:var(--acu-text-sub)}.acu-avatar-checkbox:hover{color:var(--acu-title-color)}.acu-avatar-checkbox i{font-size:18px}.acu-avatar-column{display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0}.acu-avatar-preview{width:48px;height:48px;min-width:48px;border-radius:50%;background:var(--acu-btn-bg);border:2px solid var(--acu-border);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;background-size:cover;background-position:center;background-repeat:no-repeat;transition:all .2s ease}.acu-avatar-preview:hover{border-color:var(--acu-title-color);transform:scale(1.05)}.acu-avatar-preview.has-image{border-color:var(--acu-title-color)}.acu-avatar-initial{font-size:18px;font-weight:bold;color:var(--acu-text-sub)}.acu-avatar-camera-hint{position:absolute;bottom:2px;right:2px;font-size:10px;color:var(--acu-text-sub);opacity:0;transition:opacity .2s}.acu-avatar-preview:hover .acu-avatar-camera-hint{opacity:.8}.acu-avatar-source{font-size:9px;padding:1px 4px;border-radius:3px;font-weight:500;white-space:nowrap}.acu-avatar-source.acu-source-local{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-avatar-source.acu-source-url{background:var(--acu-btn-bg);color:var(--acu-text-sub)}.acu-avatar-source.acu-source-auto{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-avatar-info{flex:1;min-width:0;display:flex;flex-direction:column;gap:8px}.acu-avatar-name-row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}.acu-avatar-name-left{display:flex;align-items:center;gap:4px;flex:1;min-width:0}.acu-avatar-name{font-size:14px;font-weight:600;color:var(--acu-text-main);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.acu-avatar-label-preview{font-size:12px;color:var(--acu-text-sub);flex-shrink:0}.acu-avatar-name-right{display:flex;align-items:center;gap:6px;flex-shrink:0}.acu-avatar-name-btn{padding:4px 10px;font-size:12px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;transition:all .15s}.acu-avatar-name-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-import-dropdown{position:relative}.acu-avatar-import-btn{padding:4px 10px;font-size:12px;background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s}.acu-avatar-import-btn:hover{background:var(--acu-btn-hover);border-color:var(--acu-title-color)}.acu-avatar-import-btn i{font-size:10px}.acu-dropdown-menu{position:absolute;top:100%;right:0;margin-top:4px;background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:10;min-width:120px;overflow:hidden}.acu-dropdown-item{padding:10px 14px;font-size:13px;color:var(--acu-text-main);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s}.acu-dropdown-item:hover{background:var(--acu-table-hover)}.acu-dropdown-item.disabled{opacity:.5;cursor:not-allowed}.acu-dropdown-item.disabled:hover{background:rgba(0,0,0,0)}.acu-dropdown-item i{width:16px;text-align:center;color:var(--acu-text-sub)}.acu-avatar-url-row{display:flex;align-items:center;gap:8px}.acu-url-label{font-size:12px;color:var(--acu-text-sub);white-space:nowrap;min-width:35px}.acu-avatar-url-input{flex:1;padding:6px 10px;font-size:12px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);min-width:0}.acu-avatar-url-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-avatar-url-input::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-avatar-alias-row{display:flex;align-items:center;gap:8px}.acu-alias-label{font-size:12px;color:var(--acu-text-sub);white-space:nowrap;min-width:35px}.acu-avatar-alias-input{flex:1;padding:6px 10px;font-size:12px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);min-width:0}.acu-avatar-alias-input:focus{outline:none;border-color:var(--acu-title-color)}.acu-avatar-alias-input::placeholder{color:var(--acu-text-sub);opacity:.6}.acu-avatar-footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--acu-border);background:var(--acu-bg-panel);gap:12px}.acu-footer-left,.acu-footer-right{display:flex;gap:8px}.acu-crop-dialog{width:90%;max-width:400px}.acu-crop-body{display:flex;flex-direction:column;gap:20px;padding:20px !important}.acu-crop-preview-wrapper{display:flex;justify-content:center}.acu-crop-preview{width:120px;height:120px;border-radius:50%;background:var(--acu-btn-bg);border:3px solid var(--acu-border);background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;align-items:center;justify-content:center;position:relative;-webkit-user-select:none;user-select:none;touch-action:none}.acu-crop-preview.is-dragging{border-color:var(--acu-title-color)}.acu-crop-preview:hover:not(.is-dragging){border-color:var(--acu-title-color)}.acu-crop-placeholder{display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--acu-text-sub)}.acu-crop-placeholder i{font-size:32px;opacity:.5}.acu-crop-placeholder span{font-size:12px}.acu-crop-controls{display:flex;flex-direction:column;gap:16px}.acu-crop-control-row{display:flex;align-items:center;gap:12px}.acu-crop-label{width:70px;font-size:13px;color:var(--acu-text-main);display:flex;align-items:center;gap:6px}.acu-crop-label i{width:16px;text-align:center;color:var(--acu-text-sub)}.acu-crop-slider{flex:1;height:6px;-webkit-appearance:none;background:var(--acu-border);border-radius:3px;outline:none}.acu-crop-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--acu-title-color);cursor:pointer;border:2px solid var(--acu-card-bg);box-shadow:0 2px 4px rgba(0,0,0,.2)}.acu-crop-slider::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--acu-title-color);cursor:pointer;border:2px solid var(--acu-card-bg);box-shadow:0 2px 4px rgba(0,0,0,.2)}.acu-crop-value{width:45px;text-align:right;font-size:12px !important;color:var(--acu-text-sub) !important;font-family:monospace !important;background:rgba(0,0,0,0) !important;border:none !important;padding:0 !important;margin:0 !important}.acu-crop-invert-section{padding:12px 0;border-top:1px solid var(--acu-border)}.acu-crop-invert-section .acu-settings-row{padding:0;border:none}.acu-crop-upload-section{display:flex;justify-content:center;padding-top:8px;border-top:1px solid var(--acu-border)}.acu-modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--acu-border)}@media (max-width:768px){.acu-avatar-manager-overlay.acu-modal-container{align-items:center;justify-content:center;padding:16px}.acu-avatar-manager-dialog{width:95%;max-height:70vh;margin:0}.acu-avatar-item{flex-wrap:wrap}.acu-avatar-name-row{flex-wrap:wrap}.acu-avatar-url-row{flex-wrap:wrap}.acu-crop-modal-overlay.acu-modal-container{align-items:center;justify-content:center;padding:16px}.acu-crop-dialog{width:95%;max-height:80vh;margin:0;display:flex;flex-direction:column}.acu-crop-body{flex:1;overflow-y:auto;padding:10px !important;gap:10px}.acu-crop-preview{width:90px;height:90px}.acu-crop-controls{gap:10px}.acu-crop-control-row{gap:8px}.acu-crop-label{width:55px;font-size:12px}.acu-crop-upload-section{padding-top:8px}}@media (max-width:768px){.acu-modal-container:has(.acu-actions-config-modal){align-items:flex-start !important;justify-content:center !important;padding-top:10vh;padding-left:16px;padding-right:16px}.acu-actions-config-modal{width:95%;max-width:400px;max-height:55vh;border-radius:16px;margin:0;display:flex;flex-direction:column}.acu-actions-config-modal .acu-modal-body{flex:1;max-height:calc(55vh - 100px);overflow-y:auto}.acu-actions-config-modal .acu-drag-handle{display:none}.acu-actions-config-modal .acu-modal-header{padding-top:16px}}.acu-tag-manager-modal{width:90vw;max-width:1400px;height:85vh;max-height:900px;display:flex;flex-direction:column}@media (max-width:768px){.acu-tag-manager-modal{width:100vw;height:100vh;max-width:none;max-height:none;border-radius:0}}.acu-tag-manager-modal .acu-modal-body{flex:1;display:flex;flex-direction:column;min-height:0;padding:0}.acu-tag-manager-body{display:flex;flex-direction:column;flex:1;min-height:0}.acu-displayed-area{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--acu-border);min-height:50px;background:var(--acu-table-head)}.acu-displayed-area .acu-displayed-label{font-weight:500;color:var(--acu-text-sub);font-size:13px;margin-right:4px}.acu-displayed-area .acu-displayed-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:16px;background:var(--acu-badge-bg);font-size:12px;cursor:pointer;transition:all .2s}.acu-displayed-area .acu-displayed-tag:hover{background:var(--acu-btn-hover)}.acu-displayed-area .acu-displayed-tag:hover .acu-remove-icon{opacity:1}.acu-displayed-area .acu-displayed-tag .acu-tag-icon{font-size:14px}.acu-displayed-area .acu-displayed-tag .acu-remove-icon{font-size:10px;opacity:.5;transition:opacity .2s}.acu-displayed-area .acu-empty-hint{color:var(--acu-text-sub);font-size:12px;font-style:italic}.acu-tag-search{display:flex;align-items:center;gap:8px;padding:8px 16px;border-bottom:1px solid var(--acu-border);background:var(--acu-card-bg)}.acu-tag-search i{color:var(--acu-text-sub)}.acu-tag-search input{flex:1;border:none;background:rgba(0,0,0,0);outline:none;font-size:13px;color:var(--acu-text-main)}.acu-tag-search input::placeholder{color:var(--acu-text-sub)}.acu-tag-search .acu-clear-search{padding:4px;border:none;background:rgba(0,0,0,0);cursor:pointer;color:var(--acu-text-sub);transition:color .2s}.acu-tag-search .acu-clear-search:hover{color:var(--acu-text-main)}.acu-tag-toolbar{display:flex;align-items:center;gap:6px;padding:8px 16px;border-bottom:1px solid var(--acu-border);flex-wrap:wrap;background:var(--acu-bg-panel)}.acu-tag-toolbar .acu-mode-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:6px;border:1px solid var(--acu-border);background:var(--acu-btn-bg);cursor:pointer;font-size:12px;color:var(--acu-text-main);transition:all .2s}.acu-tag-toolbar .acu-mode-btn:hover:not(:disabled){background:var(--acu-btn-hover)}.acu-tag-toolbar .acu-mode-btn:disabled{opacity:.5;cursor:not-allowed}.acu-tag-toolbar .acu-mode-btn.active{background:var(--acu-title-color);color:#fff;border-color:var(--acu-title-color)}.acu-tag-toolbar .acu-mode-btn i{font-size:12px}@media (max-width:768px){.acu-tag-toolbar .acu-mode-btn .btn-label{display:none}}.acu-tag-manager{display:flex;flex:1;min-height:0;gap:0}.acu-tag-tree{width:240px;min-width:200px;overflow-y:auto;border-right:1px solid var(--acu-border);background:var(--acu-card-bg)}@media (max-width:768px){.acu-tag-tree{width:140px;min-width:120px}}.acu-tag-tree .acu-root-icon-editor{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--acu-card-bg);border-bottom:1px solid var(--acu-border)}.acu-tag-tree .acu-root-icon-editor .acu-icon-input{width:40px;text-align:center;font-size:16px;padding:4px;border:1px solid var(--acu-border);border-radius:4px;background:var(--acu-bg-panel);color:var(--acu-text-main)}.acu-tag-tree .acu-root-icon-editor .acu-btn-small{padding:4px 8px;border:none;border-radius:4px;background:var(--acu-btn-bg);color:var(--acu-text-main);cursor:pointer}.acu-tag-tree .acu-root-icon-editor .acu-btn-small:hover{background:var(--acu-btn-hover)}.acu-tag-tree .acu-root-item{font-weight:500}.acu-tag-tree .acu-root-item .acu-edit-icon-btn{opacity:0;padding:2px 6px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);cursor:pointer;transition:opacity .2s}.acu-tag-tree .acu-root-item .acu-edit-icon-btn:hover{color:var(--acu-title-color)}.acu-tag-tree .acu-root-item:hover .acu-edit-icon-btn{opacity:1}.acu-tag-tree .acu-tag-tree-item{display:flex;align-items:center;gap:6px;padding:10px 12px;cursor:pointer;transition:background .2s;border-left:3px solid rgba(0,0,0,0)}.acu-tag-tree .acu-tag-tree-item:hover{background:var(--acu-table-hover)}.acu-tag-tree .acu-tag-tree-item.active{background:var(--acu-title-color-bg);border-left-color:var(--acu-title-color)}.acu-tag-tree .acu-tag-tree-item.selected{outline:2px solid var(--acu-title-color);outline-offset:-2px}.acu-tag-tree .acu-tag-tree-item.sticky{position:sticky;top:0;z-index:1;background:var(--acu-bg-panel);border-bottom:1px solid var(--acu-border)}.acu-tag-tree .acu-tag-tree-item .acu-tree-toggle{width:16px;text-align:center;font-size:10px;color:var(--acu-text-sub);cursor:pointer;transition:transform .2s}.acu-tag-tree .acu-tag-tree-item .acu-tree-toggle-placeholder{width:0px}.acu-tag-tree .acu-tag-tree-item .acu-tree-icon{font-size:14px}.acu-tag-tree .acu-tag-tree-item .acu-tree-label{flex:1;font-size:13px;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-tag-tree .acu-tag-tree-item .acu-tree-count{font-size:11px;color:var(--acu-text-sub)}.acu-tag-tree .acu-tag-tree-item .acu-add-btn,.acu-tag-tree .acu-tag-tree-item .acu-select-btn,.acu-tag-tree .acu-tag-tree-item .acu-migrate-btn,.acu-tag-tree .acu-tag-tree-item .acu-delete-btn{padding:4px 2px;border-radius:4px;border:none;background:rgba(0,0,0,0);color:var(--acu-text-sub);cursor:pointer;opacity:.7;transition:all .2s;font-size:11px}.acu-tag-tree .acu-tag-tree-item .acu-add-btn:hover,.acu-tag-tree .acu-tag-tree-item .acu-select-btn:hover,.acu-tag-tree .acu-tag-tree-item .acu-migrate-btn:hover,.acu-tag-tree .acu-tag-tree-item .acu-delete-btn:hover{opacity:1;background:var(--acu-btn-hover)}.acu-tag-tree .acu-tag-tree-item .acu-add-btn.active,.acu-tag-tree .acu-tag-tree-item .acu-select-btn.active,.acu-tag-tree .acu-tag-tree-item .acu-migrate-btn.active,.acu-tag-tree .acu-tag-tree-item .acu-delete-btn.active{color:var(--acu-title-color);opacity:1}.acu-tag-tree .acu-tag-tree-item .acu-add-btn:hover{color:var(--acu-success,#28a745)}.acu-tag-tree .acu-tag-tree-item .acu-select-btn.active{color:var(--acu-title-color)}.acu-tag-tree .acu-tag-tree-item .acu-migrate-btn:hover{color:var(--acu-warning,#ffc107)}.acu-tag-tree .acu-tag-tree-item .acu-delete-btn:hover{color:var(--acu-danger,#dc3545)}.acu-tag-tree .acu-tag-tree-item:hover .acu-add-btn,.acu-tag-tree .acu-tag-tree-item:hover .acu-select-btn,.acu-tag-tree .acu-tag-tree-item:hover .acu-migrate-btn,.acu-tag-tree .acu-tag-tree-item:hover .acu-delete-btn,.acu-tag-tree .acu-tag-tree-item.migrate-target .acu-migrate-btn{opacity:1}.acu-tag-tree .acu-tree-divider{height:1px;margin:8px 12px;background:var(--acu-border)}.acu-tag-tree .acu-tree-empty{display:flex;flex-direction:column;align-items:center;gap:8px;padding:24px;color:var(--acu-text-sub);font-size:12px}.acu-tag-tree .acu-tree-empty i{font-size:24px;opacity:.5}.acu-tag-grid{flex:1;display:flex;flex-wrap:wrap;align-content:flex-start;gap:8px;padding:16px;overflow-y:auto;background:var(--acu-bg-panel)}.acu-tag-grid .acu-tag-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;background:var(--acu-badge-bg);font-size:13px;cursor:pointer;transition:all .2s;border:2px solid rgba(0,0,0,0)}.acu-tag-grid .acu-tag-badge:hover{transform:scale(1.05);background:var(--acu-btn-hover)}.acu-tag-grid .acu-tag-badge.selected{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-tag-grid .acu-tag-badge.added .added-icon{color:#27ae60}.acu-tag-grid .acu-tag-badge.mode-add .add-icon{color:var(--acu-text-sub);font-size:10px;transition:color .2s}.acu-tag-grid .acu-tag-badge.mode-add:hover .add-icon{color:var(--acu-title-color)}.acu-tag-grid .acu-tag-badge.mode-add.added{background-color:var(--acu-table-head);opacity:.8;cursor:default}.acu-tag-grid .acu-tag-badge.mode-add.added:hover{transform:none;background-color:var(--acu-table-head)}.acu-tag-grid .acu-tag-badge.mode-migrate,.acu-tag-grid .acu-tag-badge.mode-delete:hover{background:rgba(231,76,60,.1);border-color:#e74c3c}.acu-tag-grid .acu-tag-badge .acu-badge-icon{font-size:12px;display:flex;align-items:center}.acu-tag-grid .acu-tag-badge .acu-badge-label{color:var(--acu-text-main)}.acu-tag-grid .acu-tag-badge .acu-badge-delete{color:#e74c3c;font-size:11px}.acu-tag-grid .acu-tag-badge .acu-badge-action{font-size:11px;color:var(--acu-text-sub);transition:color .2s}.acu-tag-grid .acu-tag-badge .acu-badge-action.added{color:#27ae60}.acu-tag-grid .acu-tag-badge.mode-add:hover .acu-badge-action:not(.added){color:#27ae60}.acu-tag-grid .acu-grid-empty,.acu-tag-grid .acu-grid-create-hint{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;width:100%;padding:48px;color:var(--acu-text-sub)}.acu-tag-grid .acu-grid-empty i,.acu-tag-grid .acu-grid-create-hint i{font-size:36px;opacity:.5}.acu-tag-grid .acu-grid-empty span,.acu-tag-grid .acu-grid-create-hint span{font-size:14px}.acu-tag-grid .acu-grid-create-hint{cursor:pointer;border:2px dashed var(--acu-border);border-radius:12px;transition:all .2s}.acu-tag-grid .acu-grid-create-hint:hover{border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-tag-edit-modal{max-width:480px;width:90vw}@media (max-width:768px){.acu-tag-edit-modal{width:100vw;max-width:none;height:auto;max-height:90vh;margin:auto 0 0;border-radius:16px 16px 0 0}}.acu-tag-edit-modal .acu-header-actions{display:flex;align-items:center;gap:8px}.acu-tag-edit-modal .acu-modal-body{padding:0}.acu-tag-edit-modal .acu-modal-body input[type=text]{min-width:0;flex:1;width:100%}.acu-tag-edit-modal .acu-category-control{display:flex;gap:6px}@media (max-width:400px){.acu-tag-edit-modal .acu-category-control{flex-wrap:wrap;justify-content:flex-end;width:100%}.acu-tag-edit-modal .acu-category-control .acu-custom-select{flex:1;min-width:140px}}.acu-tag-edit-modal .acu-category-control select{flex:1;min-width:0}.acu-tag-edit-modal .acu-category-control .acu-add-btn{flex-shrink:0;padding:8px 10px;border:1px solid var(--acu-border);border-radius:6px;background:var(--acu-btn-bg);color:var(--acu-text-main);cursor:pointer;transition:all .2s}.acu-tag-edit-modal .acu-category-control .acu-add-btn:hover{background:var(--acu-btn-hover);color:var(--acu-title-color)}@media (max-width:400px){.acu-tag-edit-modal .acu-settings-row{flex-wrap:wrap}.acu-tag-edit-modal .acu-settings-row .acu-settings-label{width:100%;margin-bottom:4px}.acu-tag-edit-modal .acu-settings-row .acu-settings-control{width:100%;justify-content:flex-start}.acu-tag-edit-modal .acu-settings-row .acu-settings-control input{width:100%}.acu-tag-edit-modal .acu-settings-row.acu-category-row .acu-settings-control{justify-content:flex-end}}.acu-tag-edit-modal .acu-new-category-row{flex-direction:column !important;align-items:stretch !important;justify-content:flex-start !important;gap:8px !important;background:var(--acu-table-head);margin:-10px -16px;padding:10px 16px}.acu-tag-edit-modal .acu-new-category-row .acu-settings-label{flex:none !important;width:100% !important;flex-direction:row !important;align-items:center !important;gap:8px !important}.acu-tag-edit-modal .acu-new-category-row .acu-settings-label .hint{white-space:nowrap !important;display:inline !important}.acu-tag-edit-modal .acu-new-category-row .acu-settings-control{width:100% !important;margin-left:0}.acu-tag-edit-modal .acu-new-category-control{display:flex;gap:6px;flex-wrap:nowrap}.acu-tag-edit-modal .acu-new-category-control input[type=text]{flex:1;min-width:80px}.acu-tag-edit-modal .acu-new-category-control .acu-icon-input{width:50px !important;flex:none !important;text-align:center}.acu-tag-edit-modal .acu-textarea{width:100% !important;padding:10px 12px !important;border:1px solid var(--acu-border) !important;border-radius:6px !important;background:var(--acu-btn-bg) !important;color:var(--acu-text-main) !important;font-size:13px !important;font-family:inherit !important;resize:vertical !important;min-height:80px !important;outline:none !important;box-sizing:border-box !important;transition:border-color .2s}.acu-tag-edit-modal .acu-textarea:focus{border-color:var(--acu-title-color) !important;box-shadow:0 0 0 2px var(--acu-title-color-bg) !important}.acu-tag-edit-modal .acu-textarea::placeholder{color:var(--acu-text-sub) !important;opacity:.7 !important}.acu-tag-edit-modal .acu-wildcard-shortcuts{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 0}.acu-tag-edit-modal .acu-wildcard-shortcuts .hint{color:var(--acu-text-sub);font-size:12px}.acu-tag-edit-modal .acu-wildcard-shortcuts .acu-wildcard-btn{padding:4px 10px;border-radius:4px;background:rgba(0,0,0,0) !important;border:none !important;cursor:pointer;font-family:monospace;font-size:12px;color:var(--acu-text-sub) !important;transition:all .2s;opacity:.6}.acu-tag-edit-modal .acu-wildcard-shortcuts .acu-wildcard-btn:hover{opacity:1;color:var(--acu-title-color) !important}.acu-tag-edit-modal .acu-wildcard-shortcuts .acu-wildcard-btn code{font-family:inherit;background:rgba(0,0,0,0) !important;color:inherit !important;padding:0 !important;border:none !important}.acu-tag-edit-modal .acu-wildcard-help{background:var(--acu-table-head);border-radius:8px;overflow:hidden;margin-top:8px}.acu-tag-edit-modal .acu-wildcard-help .acu-help-header{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;transition:background .2s}.acu-tag-edit-modal .acu-wildcard-help .acu-help-header:hover{background:var(--acu-table-hover)}.acu-tag-edit-modal .acu-wildcard-help .acu-help-header i:first-child{color:#f39c12}.acu-tag-edit-modal .acu-wildcard-help .acu-help-header i:last-child{margin-left:auto;font-size:10px;color:var(--acu-text-sub)}.acu-tag-edit-modal .acu-wildcard-help ul{margin:0;padding:0 12px 12px 36px;font-size:12px;color:var(--acu-text-sub)}.acu-tag-edit-modal .acu-wildcard-help ul li{margin:6px 0}.acu-tag-edit-modal .acu-wildcard-help ul code{background:var(--acu-card-bg) !important;padding:2px 6px !important;border-radius:3px !important;font-family:monospace !important;font-size:11px !important;color:var(--acu-text-main) !important;border:none !important}.acu-import-modal{max-width:500px;width:90vw}.acu-import-upload .acu-upload-area{display:flex;flex-direction:column;align-items:center;gap:12px;padding:48px 24px;border:2px dashed var(--acu-border);border-radius:12px;cursor:pointer;transition:all .2s}.acu-import-upload .acu-upload-area:hover{border-color:var(--acu-title-color);background:var(--acu-title-color-bg)}.acu-import-upload .acu-upload-area i{font-size:48px;color:var(--acu-text-sub)}.acu-import-upload .acu-upload-area p{margin:0;font-size:14px;color:var(--acu-text-main)}.acu-import-upload .acu-upload-area .hint{font-size:12px;color:var(--acu-text-sub)}.acu-import-preview{display:flex;flex-direction:column;gap:16px;padding:16px}.acu-import-stats{display:flex;justify-content:center;gap:24px}.acu-import-stats .acu-stat-item{display:flex;flex-direction:column;align-items:center;gap:4px}.acu-import-stats .acu-stat-item i{font-size:24px;color:var(--acu-title-color)}.acu-import-stats .acu-stat-item .acu-stat-value{font-size:24px;font-weight:bold;color:var(--acu-text-main)}.acu-import-stats .acu-stat-item .acu-stat-label{font-size:12px;color:var(--acu-text-sub)}.acu-import-stats .acu-stat-item.acu-stat-conflict i{color:#f39c12}.acu-conflict-options{background:var(--acu-table-head);border-radius:8px;padding:12px}.acu-conflict-options .acu-radio-option{display:flex;align-items:flex-start;gap:8px;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s}.acu-conflict-options .acu-radio-option:hover{background:var(--acu-table-hover)}.acu-conflict-options .acu-radio-option input{margin-top:2px}.acu-conflict-options .acu-radio-option span{display:block;font-size:13px}.acu-conflict-options .acu-radio-option span.hint{font-size:11px;color:var(--acu-text-sub);margin-top:2px}.acu-import-list .acu-preview-scroll{max-height:200px;overflow-y:auto}.acu-import-list .acu-preview-section{margin-bottom:12px}.acu-import-list .acu-preview-section .acu-preview-header{font-size:12px;font-weight:500;color:var(--acu-text-sub);margin-bottom:8px}.acu-import-list .acu-preview-section .acu-preview-items{display:flex;flex-wrap:wrap;gap:6px}.acu-import-list .acu-preview-section .acu-preview-items .acu-preview-item{padding:4px 10px;border-radius:12px;background:var(--acu-badge-bg);font-size:12px}.acu-import-list .acu-preview-section .acu-preview-items .acu-preview-item.conflict{background:rgba(243,156,18,.2);color:#f39c12}.acu-import-list .acu-preview-section .acu-preview-items .acu-preview-more{font-size:12px;color:var(--acu-text-sub);padding:4px}.acu-import-actions{display:flex;justify-content:flex-end;gap:12px}.acu-import-error{display:flex;align-items:center;gap:8px;padding:12px;border-radius:8px;background:rgba(231,76,60,.1);color:#e74c3c;font-size:13px}.acu-category-select-modal{max-width:600px;width:90vw;max-height:70vh;display:flex;flex-direction:column}.acu-category-select-modal.has-subcategories{max-width:800px}@media (max-width:768px){.acu-category-select-modal{width:100vw;max-width:none;max-height:80vh;margin:auto 0 0;border-radius:16px 16px 0 0}}.acu-category-select-modal .acu-modal-body{flex:1;min-height:0;padding:0}.acu-category-select-dual{display:flex;height:100%;min-height:300px}@media (max-width:768px){.acu-category-select-dual{flex-direction:column}}.acu-category-tree{width:180px;min-width:150px;border-right:1px solid var(--acu-border);overflow-y:auto;background:var(--acu-card-bg)}@media (max-width:768px){.acu-category-tree{width:100%;min-width:auto;border-right:none;border-bottom:1px solid var(--acu-border);max-height:120px;display:flex;flex-wrap:wrap;padding:8px;gap:6px}}.acu-category-tree .acu-tree-item{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;transition:background .2s;border-left:3px solid rgba(0,0,0,0)}@media (max-width:768px){.acu-category-tree .acu-tree-item{padding:6px 10px;border-left:none;border-radius:16px;background:var(--acu-badge-bg)}}.acu-category-tree .acu-tree-item:hover{background:var(--acu-table-hover)}.acu-category-tree .acu-tree-item.active{background:var(--acu-title-color-bg);border-left-color:var(--acu-title-color)}@media (max-width:768px){.acu-category-tree .acu-tree-item.active{border-left:none;background:var(--acu-title-color);color:#fff}.acu-category-tree .acu-tree-item.active .acu-tree-count{color:hsla(0,0%,100%,.8)}}.acu-category-tree .acu-tree-item .acu-tree-icon{font-size:14px}.acu-category-tree .acu-tree-item .acu-tree-icon i{color:var(--acu-text-sub)}.acu-category-tree .acu-tree-item .acu-tree-label{flex:1;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-category-tree .acu-tree-item .acu-tree-count{font-size:11px;color:var(--acu-text-sub)}.acu-category-tags-grid{flex:1;display:flex;flex-wrap:wrap;align-content:flex-start;gap:8px;padding:16px;overflow-y:auto;background:var(--acu-bg-panel)}@media (max-width:768px){.acu-category-tags-grid{min-height:200px}}.acu-category-tags-only{padding:16px;overflow-y:auto;max-height:400px}.acu-category-tags-only .acu-tags-scroll{display:flex;flex-wrap:wrap;gap:8px}.acu-tag-btn{padding:10px 16px;border:none;border-radius:20px;background:var(--acu-badge-bg);cursor:pointer;font-size:13px;color:var(--acu-text-main);transition:all .2s}.acu-tag-btn:hover{background:var(--acu-btn-hover);transform:scale(1.05)}.acu-tag-btn:active{transform:scale(0.98)}.acu-tags-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;width:100%;padding:32px;color:var(--acu-text-sub)}.acu-tags-empty i{font-size:32px;opacity:.5}.acu-tags-empty span{font-size:13px}.acu-pre-edit-modal{max-width:500px;width:90vw}@media (max-width:768px){.acu-pre-edit-modal{width:100vw;max-width:none;margin:auto 0 0;border-radius:16px 16px 0 0}}.acu-pre-edit-content{display:flex;flex-direction:column;gap:16px;padding:16px}.acu-pre-edit-content .acu-pre-edit-label{font-size:13px;font-weight:500;color:var(--acu-text-main)}.acu-pre-edit-content .acu-pre-edit-textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--acu-border);border-radius:8px;background:var(--acu-input-bg);color:var(--acu-text-main);font-size:14px;font-family:inherit;line-height:1.5;resize:vertical;outline:none;transition:border-color .2s}.acu-pre-edit-content .acu-pre-edit-textarea:focus{border-color:var(--acu-title-color)}.acu-pre-edit-content .acu-pre-edit-textarea::placeholder{color:var(--acu-text-sub)}.acu-pre-edit-content .acu-pre-edit-hint{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--acu-table-head);border-radius:8px;font-size:12px;color:var(--acu-text-sub)}.acu-pre-edit-content .acu-pre-edit-hint i{color:#f39c12}.acu-companion-selector{display:flex;flex-direction:column;gap:8px;padding:12px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:8px}.acu-companion-selector .acu-companion-header{font-size:12px;font-weight:500;color:var(--acu-text-sub);display:flex;align-items:center;gap:6px}.acu-companion-selector .acu-avatar-list{display:flex;gap:8px;flex-wrap:wrap;max-height:200px;overflow-y:auto;padding-right:4px}@media (max-width:768px){.acu-companion-selector .acu-avatar-list{flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;max-height:none;padding-bottom:8px}}.acu-companion-selector .acu-avatar-list .acu-avatar-item{display:flex;flex-direction:column;align-items:center;gap:4px;width:60px;cursor:pointer;transition:transform .2s}.acu-companion-selector .acu-avatar-list .acu-avatar-item:hover{transform:scale(1.05)}.acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid rgba(0,0,0,0);transition:border-color .2s;background:var(--acu-table-head);display:flex;align-items:center;justify-content:center}.acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper img{width:100%;height:100%;object-fit:cover}.acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper.no-img{background:var(--acu-badge-bg)}.acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper .acu-avatar-text-icon{font-size:20px;font-weight:bold;color:var(--acu-text-sub);text-transform:uppercase}.acu-companion-selector .acu-avatar-list .acu-avatar-item:hover .acu-avatar-img-wrapper{border-color:var(--acu-title-color)}.acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-name{font-size:11px;color:var(--acu-text-main);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}.acu-companion-selector .acu-avatar-list .acu-avatar-empty{width:100%;text-align:center;padding:20px;color:var(--acu-text-sub);font-size:12px}.acu-custom-select{position:relative;min-width:120px;max-width:100%;height:32px;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:6px;display:flex;align-items:center;padding:0 10px;cursor:pointer;transition:all .2s;min-width:0}.acu-custom-select:hover{border-color:var(--acu-text-sub)}.acu-custom-select.active{border-color:var(--acu-title-color)}.acu-custom-select.active .arrow{transform:rotate(180deg)}.acu-custom-select .selected-value{flex:1;display:flex;align-items:center;gap:8px;overflow:hidden}.acu-custom-select .selected-value i,.acu-custom-select .selected-value span:not(.text):not(.placeholder){font-size:14px;width:16px;text-align:center;flex-shrink:0}.acu-custom-select .selected-value .text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;color:var(--acu-text-main)}.acu-custom-select .selected-value .placeholder{color:var(--acu-text-sub);font-size:13px}.acu-custom-select .arrow{font-size:12px;color:var(--acu-text-sub);margin-left:8px;transition:transform .2s}.acu-custom-select .acu-custom-dropdown-menu{position:absolute;top:100%;left:0;min-width:100%;width:max-content;max-height:200px;overflow-y:auto;background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:6px;margin-top:4px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.15)}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;transition:background .2s}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item:hover{background:var(--acu-table-hover)}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item.selected{background:var(--acu-title-color-bg);color:var(--acu-title-color)}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item.selected .text{color:var(--acu-title-color);font-weight:500}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item i,.acu-custom-select .acu-custom-dropdown-menu .dropdown-item span:not(.text){font-size:14px;width:16px;text-align:center;flex-shrink:0}.acu-custom-select .acu-custom-dropdown-menu .dropdown-item .text{font-size:13px;color:var(--acu-text-main);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.card-back{width:100%;height:100%;border-radius:12px;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);border:6px solid #4a3222;position:relative}.card-back__image{width:100%;height:100%;object-fit:cover}.card-back__overlay{position:absolute;inset:0;border:2px solid rgba(139,94,60,.5);border-radius:8px;pointer-events:none}.card-front{width:100%;height:100%;background-color:#f9f2e6;border-radius:12px;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:24px;border:6px solid #4a3728;position:relative}.card-front__texture{position:absolute;inset:0;background-image:url("https://grainy-gradients.vercel.app/noise.svg");opacity:.2;pointer-events:none;mix-blend-mode:multiply;z-index:0}.card-front__border-outer{position:absolute;inset:12px;border:1px solid #c6a664;border-radius:8px;pointer-events:none;z-index:10}.card-front__border-inner{position:absolute;inset:16px;border:1px solid rgba(139,94,60,.3);border-radius:6px;pointer-events:none;z-index:10}.card-front__content{position:relative;z-index:20;display:flex;flex-direction:column;align-items:center;height:100%;width:100%}.card-front__top-icon{margin-top:32px;margin-bottom:16px;color:#8b5e3c;animation:divination-pulse 2s ease-in-out infinite}.card-front__luck-name{font-family:"ZCOOL XiaoWei","Cinzel",serif;font-size:24px;color:#4a3728;font-weight:bold;text-align:center;letter-spacing:.2em;text-transform:uppercase;border-bottom:2px solid #c6a664;padding-bottom:8px;margin-bottom:8px;width:85%}@media (min-width:768px){.card-front__luck-name{font-size:28px}}.card-front__dimensions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:8px;width:85%}.card-front__dimension-item{font-family:"Noto Serif SC","Cormorant Garamond",serif;font-size:13px;color:#4a3728;background-color:rgba(198,166,100,.15);padding:4px 12px;border-radius:12px;border:1px solid rgba(198,166,100,.3)}@media (min-width:768px){.card-front__dimension-item{font-size:14px}}.card-front__keywords{display:flex;flex-direction:column;gap:12px;width:100%;padding:0 16px;flex-grow:1;justify-content:center;padding-top:0;overflow-y:auto}.card-front__keywords::-webkit-scrollbar{display:none}.card-front__keywords{scrollbar-width:none;-ms-overflow-style:none}.card-front__keyword{display:flex;align-items:center;justify-content:center}.card-front__keyword-text{font-family:"ZCOOL XiaoWei","Cinzel",serif;color:#8b5e3c;font-size:18px;letter-spacing:.1em;text-transform:uppercase;font-weight:bold;white-space:normal;text-align:center;line-height:1.4}.card-front__corner{position:absolute;width:48px;height:48px;color:#c6a664;z-index:10}.card-front__corner--tl{top:12px;left:12px}.card-front__corner--tr{top:12px;right:12px;transform:scaleX(-1)}.card-front__corner--bl{bottom:12px;left:12px;transform:scaleY(-1)}.card-front__corner--br{bottom:12px;right:12px;transform:scale(-1)}.mystic-card-back{width:100%;height:100%;border-radius:12px;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);position:relative}.mystic-card-back__image{width:100%;height:100%;object-fit:cover}.mystic-card-back__sheen{position:absolute;inset:0;background:linear-gradient(to top right,rgba(0,0,0,0.2),transparent,rgba(255,255,255,0.1));pointer-events:none}.mystic-card-front{width:100%;height:100%;background-color:#0b1026;border-radius:12px;overflow:hidden;box-shadow:0 0 30px rgba(199,210,254,.3);position:relative}.mystic-card-front__texture{position:absolute;inset:0;background:radial-gradient(circle at center,#1e293b 0%,#0f172a 40%,#020617 100%)}.mystic-card-front__border-outer{position:absolute;inset:12px;border:1px solid rgba(245,158,11,.3);border-radius:8px;pointer-events:none;z-index:10}.mystic-card-front__border-inner{position:absolute;inset:16px;border:2px solid rgba(252,211,77,.6);border-radius:8px;box-shadow:0 0 15px rgba(251,191,36,.2);pointer-events:none;z-index:10}.mystic-card-front__corner{position:absolute;width:64px;height:64px;border-style:solid;border-width:0;border-color:rgba(199,210,254,.8);z-index:10}.mystic-card-front__corner--tl{top:16px;left:16px;border-top-width:2px;border-left-width:2px;border-top-left-radius:16px}.mystic-card-front__corner--tr{top:16px;right:16px;border-top-width:2px;border-right-width:2px;border-top-right-radius:16px}.mystic-card-front__corner--bl{bottom:16px;left:16px;border-bottom-width:2px;border-left-width:2px;border-bottom-left-radius:16px}.mystic-card-front__corner--br{bottom:16px;right:16px;border-bottom-width:2px;border-right-width:2px;border-bottom-right-radius:16px}.mystic-card-front__glow{position:absolute;top:32px;left:50%;transform:translateX(-50%);width:128px;height:128px;opacity:.2;background:radial-gradient(circle,rgba(251,191,36,0.4) 0%,transparent 70%);filter:blur(40px);pointer-events:none;z-index:5}.mystic-card-front__content{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:36px 24px;text-align:center;z-index:20;font-family:"Noto Serif SC","Cormorant Garamond",serif}.mystic-card-front__top-icon{color:rgba(252,211,77,.8);margin-bottom:8px;filter:drop-shadow(0 0 5px rgba(251,191,36,0.8))}.mystic-card-front__top-icon svg{opacity:.8}.mystic-card-front__loading{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;height:100%}.mystic-card-front__spinner{width:32px;height:32px;border:2px solid #f59e0b;border-top-color:rgba(0,0,0,0);border-radius:50%;animation:mystic-spin 1s linear infinite}.mystic-card-front__loading-text{color:#c7d2fe;font-size:14px;letter-spacing:.2em;animation:mystic-pulse 2s ease-in-out infinite}.mystic-card-front__title{position:relative}.mystic-card-front__luck-name{font-family:"Cinzel","ZCOOL XiaoWei",serif;font-size:32px;font-weight:bold;letter-spacing:.2em;background:linear-gradient(to bottom,#fef3c7,#f59e0b);-webkit-background-clip:text;-webkit-text-fill-color:rgba(0,0,0,0);background-clip:text;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));margin:0}@media (max-width:768px){.mystic-card-front__luck-name{font-size:28px}}.mystic-card-front__divider{width:64px;height:1px;background:linear-gradient(to right,transparent,#818cf8,transparent);margin:8px auto 0}.mystic-card-front__dimensions{display:flex;flex-direction:column;gap:8px;margin:12px 0}.mystic-card-front__dimension-tag{color:#c7d2fe;font-size:14px;letter-spacing:.2em;text-transform:uppercase;border:1px solid rgba(99,102,241,.3);padding:4px 12px;border-radius:9999px;background:rgba(30,27,75,.3);backdrop-filter:blur(4px)}.mystic-card-front__message-box{position:relative;padding:24px 16px;background:radial-gradient(circle at center,rgba(255,255,255,0.03) 0%,transparent 70%);flex-grow:1;display:flex;flex-direction:column;width:110%;margin:8px -5%;overflow:hidden}.mystic-card-front__message-box::before,.mystic-card-front__message-box::after{content:"";position:absolute;left:20%;right:20%;height:1px;background:linear-gradient(90deg,transparent,rgba(245,158,11,0.3),transparent)}.mystic-card-front__message-box::before{top:0}.mystic-card-front__message-box::after{bottom:0}.mystic-card-front__word-list{display:flex;flex-direction:column;gap:12px;align-items:center;width:100%;height:100%;overflow-y:auto;padding:0 8px}.mystic-card-front__word-list::before,.mystic-card-front__word-list::after{content:"";flex-shrink:0;margin:auto}.mystic-card-front__word-list::-webkit-scrollbar{width:4px}.mystic-card-front__word-list::-webkit-scrollbar-track{background:rgba(0,0,0,0)}.mystic-card-front__word-list::-webkit-scrollbar-thumb{background:rgba(245,158,11,.2);border-radius:4px}.mystic-card-front__word-list::-webkit-scrollbar-thumb:hover{background:rgba(245,158,11,.4)}.mystic-card-front__word-list{scrollbar-width:thin;scrollbar-color:rgba(245,158,11,.2) rgba(0,0,0,0)}.mystic-card-front__word-item{font-family:"Cinzel","ZCOOL XiaoWei",serif;font-size:16px;color:#fef3c7;text-shadow:0 0 10px rgba(253,224,71,.2);letter-spacing:.05em;line-height:1.4;position:relative;white-space:normal;text-align:center}.mystic-card-front__word-item:only-child{font-size:20px;color:#fcd34d;text-shadow:0 0 15px rgba(245,158,11,.3)}.mystic-card-front__bottom-icon{color:rgba(252,211,77,.5);margin-top:16px;transform:rotate(180deg)}@keyframes mystic-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes mystic-pulse{0%,100%{opacity:1}50%{opacity:.5}}@keyframes mystic-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}@keyframes mystic-glow{0%,100%{box-shadow:0 0 20px rgba(199,210,254,.3)}50%{box-shadow:0 0 40px rgba(199,210,254,.5)}}.divination-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;z-index:200000;display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(circle at center,#2a1b15 0%,#1a0f0e 40%,#050505 100%);overflow:hidden;font-family:"Noto Serif SC","Cormorant Garamond",serif;color:#f9f2e6}.divination-overlay::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-image:url("https://www.transparenttextures.com/patterns/stardust.png");opacity:.3;pointer-events:none;z-index:0}.divination-grain{position:absolute;inset:0;background-image:url("https://grainy-gradients.vercel.app/noise.svg");opacity:.15;mix-blend-mode:overlay;pointer-events:none;z-index:1}.divination-starfield{position:absolute;inset:0;pointer-events:none;z-index:0}.divination-star{position:absolute;border-radius:50%;background-color:#f5e6d3;opacity:.6;animation:divination-twinkle var(--duration,3s) ease-in-out infinite;animation-delay:var(--delay,0s)}@keyframes divination-twinkle{0%,100%{opacity:.2;transform:scale(0.8)}50%{opacity:.8;transform:scale(1.2)}}.divination-nebula{position:absolute;border-radius:50%;pointer-events:none;z-index:0}.divination-nebula--purple{top:-10%;left:-10%;width:60%;height:60%;background:#3d2b4a;filter:blur(100px);opacity:.3;mix-blend-mode:screen;animation:divination-nebula-pulse 15s ease-in-out infinite}.divination-nebula--golden{bottom:-10%;right:-10%;width:70%;height:70%;background:#4a3728;filter:blur(120px);opacity:.2;mix-blend-mode:screen;animation:divination-nebula-drift 20s ease-in-out infinite}@keyframes divination-nebula-pulse{0%,100%{transform:scale(1);opacity:.2}50%{transform:scale(1.2);opacity:.4}}@keyframes divination-nebula-drift{0%,100%{transform:translateX(0) scale(1);opacity:.1}50%{transform:translateX(50px) scale(1.1);opacity:.3}}.divination-central-glow{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80vw;height:80vw;max-width:800px;max-height:800px;background:radial-gradient(circle,rgba(198,166,100,0.1) 0%,transparent 70%);filter:blur(48px);pointer-events:none;z-index:0}.divination-geometry{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:0}.divination-geometry--outer{width:140vmin;height:140vmin;opacity:.15;animation:divination-spin-slow 60s linear infinite}.divination-geometry--inner{width:90vmin;height:90vmin;opacity:.1;animation:divination-spin-reverse 80s linear infinite}.divination-geometry svg{width:100%;height:100%}@keyframes divination-spin-slow{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(360deg)}}@keyframes divination-spin-reverse{from{transform:translate(-50%,-50%) rotate(0deg)}to{transform:translate(-50%,-50%) rotate(-360deg)}}.divination-frame{position:absolute;top:8px;left:8px;right:8px;bottom:8px;width:auto;height:auto;pointer-events:none;z-index:50;border:1px solid rgba(212,175,55,.2);border-radius:12px;box-sizing:border-box}@media (min-width:768px){.divination-frame{top:16px;left:16px;right:16px;bottom:16px}}.divination-frame__corner{position:absolute;width:128px;height:128px;border-color:rgba(212,175,55,.6);border-style:solid;border-width:0}.divination-frame__corner--tl{top:0;left:0;border-top-width:2px;border-left-width:2px;border-top-left-radius:24px}.divination-frame__corner--tr{top:0;right:0;border-top-width:2px;border-right-width:2px;border-top-right-radius:24px}.divination-frame__corner--bl{bottom:0;left:0;border-bottom-width:2px;border-left-width:2px;border-bottom-left-radius:24px}.divination-frame__corner--br{bottom:0;right:0;border-bottom-width:2px;border-right-width:2px;border-bottom-right-radius:24px}.divination-frame__top-line{position:absolute;top:0;left:50%;transform:translateX(-50%);width:160px;height:1px;background:linear-gradient(to right,transparent,#d4af37,transparent);opacity:.8}.divination-frame__bottom-line{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:160px;height:1px;background:linear-gradient(to right,transparent,#d4af37,transparent);opacity:.8}.divination-content{position:relative;z-index:20;width:100%;display:flex;flex-direction:column;align-items:center;max-width:1280px;margin:0 auto;height:100%;justify-content:center;padding:16px 24px;gap:16px;box-sizing:border-box}.divination-header{text-align:center;animation:divination-fade-in-down 1s ease-out;flex-shrink:0}.divination-header__title{display:inline-flex;flex-direction:column;align-items:center}.divination-header__sparkle--static{position:relative;display:block;color:#d4af37;opacity:.8;animation:divination-twinkle 4s ease-in-out infinite;filter:drop-shadow(0 0 10px rgba(212,175,55,0.5))}.divination-header__divider{height:2px;width:120px;background:linear-gradient(to right,transparent,#d4af37,transparent);margin-top:8px;opacity:.5}@keyframes divination-fade-in-down{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}.divination-stage{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;position:relative;flex-shrink:0}.tarot-card{position:relative;cursor:pointer;perspective:1000px;width:90vw;height:auto;max-height:80vh}@media (min-width:768px){.tarot-card{width:auto;height:80vh;max-width:90vw}}.tarot-card__inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .8s ease-in-out}.tarot-card--flipped .tarot-card__inner{transform:rotateY(180deg)}.tarot-card__face{position:absolute;inset:0;width:100%;height:100%;backface-visibility:hidden;border-radius:12px;overflow:hidden}.tarot-card__back{z-index:2}.tarot-card__front{transform:rotateY(180deg);z-index:1}.tarot-card:not(.tarot-card--flipped) .tarot-card__back{animation:divination-float 4s ease-in-out infinite}@keyframes divination-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}.divination-hint{position:absolute;bottom:-64px;left:0;right:0;text-align:center;animation:divination-fade-in .8s ease-out}.divination-hint__text{font-family:"ZCOOL XiaoWei","Cinzel",serif;color:#f5e6d3;font-size:18px;letter-spacing:.2em;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));animation:divination-bounce 2s ease-in-out infinite}@keyframes divination-fade-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes divination-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}.divination-btn{padding:12px 32px;font-family:"ZCOOL XiaoWei","Cinzel",serif;font-size:14px;letter-spacing:.2em;text-transform:uppercase;border:1px solid;border-radius:0;cursor:pointer;transition:all .3s ease;backdrop-filter:blur(4px);position:relative;overflow:hidden}.divination-btn::before{content:"";position:absolute;inset:0;transform:skewX(-10deg);z-index:-1}.divination-btn--primary{color:#d4af37;border-color:#d4af37;background:rgba(26,15,14,.6)}.divination-btn--primary::before{background:rgba(0,0,0,0)}.divination-btn--primary:hover{color:#f9f2e6;background:rgba(212,175,55,.2)}.divination-btn--secondary{color:rgba(212,175,55,.7);border-color:rgba(212,175,55,.4);background:rgba(0,0,0,0)}.divination-btn--secondary:hover{color:#d4af37;border-color:#d4af37}.divination-btn--retry{font-family:"ZCOOL XiaoWei","Cinzel",serif;color:#f5e6d3;font-size:18px;letter-spacing:.2em;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));animation:divination-bounce 2s ease-in-out infinite;border:1px solid hsla(0,0%,100%,.8);border-radius:24px;background:rgba(0,0,0,.3);padding:10px 32px}.divination-btn--retry::before{display:none}.divination-btn--retry:hover{background:hsla(0,0%,100%,.1);border-color:#fff}.divination-footer{height:auto;min-height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.divination-close{position:absolute;top:24px;right:24px;z-index:100;width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:rgba(212,175,55,.6);border:1px solid rgba(212,175,55,.3);border-radius:50%;background:rgba(15,10,8,.5);backdrop-filter:blur(4px);cursor:pointer;transition:all .3s ease}.divination-close:hover{color:#d4af37;border-color:#d4af37;background:rgba(212,175,55,.1)}.divination-overlay-enter-active{animation:divination-overlay-in .5s ease-out}.divination-overlay-leave-active{animation:divination-overlay-out .3s ease-in forwards}@keyframes divination-overlay-in{from{opacity:0}to{opacity:1}}@keyframes divination-overlay-out{from{opacity:1}to{opacity:0}}.acu-prompt-editor-modal{max-width:600px}@media (max-width:768px){.acu-prompt-editor-modal{max-width:90vw}}.acu-prompt-editor-modal .acu-textarea-scrollable{background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:var(--acu-radius-md);padding:12px;font-size:14px;transition:border-color .2s}.acu-prompt-editor-modal .acu-textarea-scrollable:focus{border-color:var(--acu-title-color);box-shadow:none}.acu-prompt-editor-modal .acu-textarea-scrollable::placeholder{color:var(--acu-text-sub);opacity:.7}:root{--acu-neutral-50:#fafafa;--acu-neutral-100:#f5f5f5;--acu-neutral-200:#eeeeee;--acu-neutral-300:#e0e0e0;--acu-neutral-400:#bdbdbd;--acu-neutral-500:#9e9e9e;--acu-neutral-600:#757575;--acu-neutral-700:#616161;--acu-neutral-800:#424242;--acu-neutral-900:#212121;--acu-success:#27ae60;--acu-warning:#f39c12;--acu-danger:#e74c3c;--acu-info:#3498db;--acu-z-ball:2147483646;--acu-z-overlay:2147483647;--acu-z-menu:2147483648;--acu-radius-sm:6px;--acu-radius-md:12px;--acu-radius-lg:16px;--acu-shadow-sm:0 2px 8px rgba(0,0,0,0.1);--acu-shadow-md:0 4px 16px rgba(0,0,0,0.15);--acu-shadow-lg:0 15px 50px rgba(0,0,0,0.3);--acu-transition-fast:0.15s;--acu-transition-normal:0.3s;--acu-transition-slow:0.5s}.acu-wrapper,.acu-theme-retro{--acu-bg-nav:#e6e2d3;--acu-bg-panel:#e6e2d3;--acu-card-bg:#fffef9;--acu-table-head:#efebe4;--acu-table-hover:#f0ebe0;--acu-badge-bg:#efebe4;--acu-input-bg:rgba(255,255,255,0.5);--acu-menu-bg:#fff;--acu-overlay-bg:rgba(94,75,53,0.4);--acu-text-main:#5e4b35;--acu-text-sub:#999;--acu-menu-text:#333;--acu-border:#dcd0c0;--acu-btn-bg:#dcd0c0;--acu-btn-hover:#cbbba8;--acu-btn-active-bg:#8d7b6f;--acu-btn-active-text:#fdfaf5;--acu-shadow:rgba(0,0,0,0.1);--acu-card-width:280px;--acu-font-size:13px;--acu-highlight:#d35400;--acu-title-color-bg:rgba(211,84,0,0.08);--acu-title-color:#d35400;--acu-accent:#d35400;--acu-nav-cols:repeat(auto-fill,minmax(90px,1fr));--acu-text-max-height:80px;--acu-text-overflow:auto;--acu-win-width:400px;--acu-win-left:100px;--acu-win-bottom:100px}.acu-theme-dark{--acu-bg-nav:rgba(43,43,43,0.95);--acu-bg-panel:rgba(37,37,37,0.95);--acu-border:#444;--acu-text-main:#eee;--acu-text-sub:#aaa;--acu-btn-bg:rgba(58,58,58,0.5);--acu-btn-hover:#4a4a4a;--acu-btn-active-bg:#6a5acd;--acu-btn-active-text:#fff;--acu-table-head:rgba(51,51,51,0.8);--acu-table-hover:rgba(58,58,58,0.5);--acu-shadow:rgba(0,0,0,0.6);--acu-card-bg:rgba(45,48,53,0.8);--acu-badge-bg:#3a3f4b;--acu-menu-bg:#333;--acu-menu-text:#eee;--acu-input-bg:rgba(0,0,0,0.3);--acu-overlay-bg:rgba(0,0,0,0.75)}.acu-theme-modern{--acu-bg-nav:#ffffff;--acu-bg-panel:#f8f9fa;--acu-border:#e0e0e0;--acu-text-main:#333;--acu-text-sub:#888;--acu-btn-bg:#f1f3f5;--acu-btn-hover:#e9ecef;--acu-btn-active-bg:#007bff;--acu-btn-active-text:#fff;--acu-table-head:#f8f9fa;--acu-table-hover:#f1f3f5;--acu-shadow:rgba(0,0,0,0.08);--acu-card-bg:#ffffff;--acu-badge-bg:#f1f3f5;--acu-menu-bg:#fff;--acu-menu-text:#333;--acu-input-bg:#ffffff;--acu-overlay-bg:rgba(0,0,0,0.3)}.acu-theme-forest{--acu-bg-nav:#e8f5e9;--acu-bg-panel:#e8f5e9;--acu-border:#c8e6c9;--acu-text-main:#2e7d32;--acu-text-sub:#81c784;--acu-btn-bg:#c8e6c9;--acu-btn-hover:#a5d6a7;--acu-btn-active-bg:#43a047;--acu-btn-active-text:#fff;--acu-table-head:#dcedc8;--acu-table-hover:#f1f8e9;--acu-shadow:rgba(0,0,0,0.1);--acu-card-bg:#ffffff;--acu-badge-bg:#dcedc8;--acu-menu-bg:#fff;--acu-menu-text:#2e7d32;--acu-input-bg:rgba(255,255,255,0.7);--acu-overlay-bg:rgba(46,125,50,0.2)}.acu-theme-ocean{--acu-bg-nav:#e3f2fd;--acu-bg-panel:#e3f2fd;--acu-border:#bbdefb;--acu-text-main:#1565c0;--acu-text-sub:#64b5f6;--acu-btn-bg:#bbdefb;--acu-btn-hover:#90caf9;--acu-btn-active-bg:#1976d2;--acu-btn-active-text:#fff;--acu-table-head:#bbdefb;--acu-table-hover:#e1f5fe;--acu-shadow:rgba(0,0,0,0.15);--acu-card-bg:#ffffff;--acu-badge-bg:#e3f2fd;--acu-menu-bg:#fff;--acu-menu-text:#1565c0;--acu-input-bg:rgba(255,255,255,0.7);--acu-overlay-bg:rgba(21,101,192,0.2)}.acu-theme-cyber{--acu-bg-nav:#000000;--acu-bg-panel:#0a0a0a;--acu-border:#333;--acu-text-main:#00ffcc;--acu-text-sub:#ff00ff;--acu-btn-bg:#1a1a1a;--acu-btn-hover:#333;--acu-btn-active-bg:#ff00ff;--acu-btn-active-text:#fff;--acu-table-head:#111;--acu-table-hover:#1a1a1a;--acu-shadow:0 0 10px rgba(0,255,204,0.3);--acu-card-bg:#050505;--acu-badge-bg:#222;--acu-menu-bg:#111;--acu-menu-text:#00ffcc;--acu-input-bg:#111;--acu-overlay-bg:rgba(0,0,0,0.85)}.acu-theme-purple{--acu-bg-nav:#ede7f6;--acu-bg-panel:#ede7f6;--acu-border:#d1c4e9;--acu-text-main:#4a148c;--acu-text-sub:#7b1fa2;--acu-btn-bg:#d1c4e9;--acu-btn-hover:#b39ddb;--acu-btn-active-bg:#7b1fa2;--acu-btn-active-text:#fff;--acu-table-head:#f5f0fa;--acu-table-hover:#f3e5f5;--acu-shadow:rgba(74,20,140,0.1);--acu-card-bg:#faf8fc;--acu-badge-bg:#f5f0fa;--acu-menu-bg:#faf8fc;--acu-menu-text:#4a148c;--acu-input-bg:rgba(255,255,255,0.8);--acu-overlay-bg:rgba(74,20,140,0.3)}.acu-icon-select-modal{width:500px;max-width:90vw;height:600px;max-height:80vh;display:flex;flex-direction:column}.acu-icon-select-modal .acu-modal-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0}.acu-icon-select-modal .acu-icon-tabs{display:flex;border-bottom:1px solid var(--acu-border);background:var(--acu-bg-panel);padding:0 16px;flex-shrink:0}.acu-icon-select-modal .acu-icon-tabs .acu-icon-tab{padding:12px 16px;cursor:pointer;color:var(--acu-text-sub);font-size:14px;font-weight:500;border-bottom:2px solid rgba(0,0,0,0);transition:all .2s}.acu-icon-select-modal .acu-icon-tabs .acu-icon-tab:hover{color:var(--acu-text-main)}.acu-icon-select-modal .acu-icon-tabs .acu-icon-tab.active{color:var(--acu-title-color);border-bottom-color:var(--acu-title-color)}.acu-icon-select-modal .acu-icon-search-bar{padding:12px 16px;border-bottom:1px solid var(--acu-border);background:var(--acu-bg-panel);flex-shrink:0}.acu-icon-select-modal .acu-icon-search-bar .acu-search-input-wrapper{position:relative}.acu-icon-select-modal .acu-icon-search-bar .acu-search-input-wrapper i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--acu-text-sub)}.acu-icon-select-modal .acu-icon-search-bar .acu-search-input-wrapper input{width:100%;padding:8px 12px 8px 32px;border:1px solid var(--acu-border);border-radius:var(--acu-radius-md);background:var(--acu-card-bg);color:var(--acu-text-main);font-size:13px}.acu-icon-select-modal .acu-icon-search-bar .acu-search-input-wrapper input:focus{border-color:var(--acu-title-color);outline:none}.acu-icon-select-modal .acu-icon-grid-container{flex:1;overflow-y:auto;padding:16px;background:var(--acu-card-bg)}.acu-icon-select-modal .acu-icon-grid-container .acu-icon-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px}.acu-icon-select-modal .acu-icon-grid-container .acu-icon-item{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:var(--acu-radius-sm);cursor:pointer;font-size:20px;color:var(--acu-text-main);transition:all .2s;border:1px solid rgba(0,0,0,0)}.acu-icon-select-modal .acu-icon-grid-container .acu-icon-item:hover{background:var(--acu-table-hover);border-color:var(--acu-border)}.acu-icon-select-modal .acu-icon-grid-container .acu-icon-item.selected{background:var(--acu-title-color-bg);border-color:var(--acu-title-color);color:var(--acu-title-color)}.acu-icon-select-modal .acu-icon-grid-container .acu-no-icons{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--acu-text-sub);gap:8px}.acu-icon-select-modal .acu-icon-grid-container .acu-no-icons i{font-size:24px;opacity:.5}.acu-icon-select-modal .acu-icon-manual-input{padding:12px 16px;border-top:1px solid var(--acu-border);background:var(--acu-bg-panel);flex-shrink:0;display:flex;align-items:center;gap:12px}.acu-icon-select-modal .acu-icon-manual-input .acu-manual-label{font-size:13px;color:var(--acu-text-sub);white-space:nowrap}.acu-icon-select-modal .acu-icon-manual-input .acu-manual-field{flex:1;display:flex;align-items:center;gap:8px;background:var(--acu-card-bg);border:1px solid var(--acu-border);border-radius:var(--acu-radius-md);padding:6px 10px}.acu-icon-select-modal .acu-icon-manual-input .acu-manual-field .acu-preview-icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--acu-text-main)}.acu-icon-select-modal .acu-icon-manual-input .acu-manual-field input{flex:1;border:none;background:rgba(0,0,0,0);color:var(--acu-text-main);font-size:13px;min-width:0}.acu-icon-select-modal .acu-icon-manual-input .acu-manual-field input:focus{outline:none}.acu-pre-edit-modal{max-width:600px}.acu-pre-edit-modal .acu-modal-header .acu-header-actions{display:flex;gap:8px;margin-left:auto}.acu-pre-edit-modal .acu-pre-edit-content{display:flex;flex-direction:column;gap:12px}.acu-pre-edit-modal .acu-pre-edit-info-row{display:flex;align-items:center;justify-content:space-between;gap:12px}.acu-pre-edit-modal .acu-pre-edit-info-row .acu-pre-edit-label{font-size:14px;color:var(--acu-text-sub);font-weight:500}.acu-pre-edit-modal .acu-pre-edit-textarea{width:100%;min-height:120px;padding:12px;border:1px solid var(--acu-border);border-radius:8px;background:var(--acu-input-bg);color:var(--acu-text-main);font-size:14px;line-height:1.5;resize:vertical;outline:none;transition:border-color .2s}.acu-pre-edit-modal .acu-pre-edit-textarea:focus{border-color:var(--acu-title-color)}.acu-pre-edit-modal .acu-companion-selector{border:1px solid var(--acu-border);border-radius:8px;background:var(--acu-card-bg);overflow:hidden}.acu-pre-edit-modal .acu-companion-selector .acu-companion-header{padding:8px 12px;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border);font-size:12px;color:var(--acu-text-sub);display:flex;align-items:center;gap:6px}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list{display:flex;flex-wrap:wrap;gap:8px;padding:12px;max-height:200px;overflow-y:auto;justify-content:center}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item{display:flex;flex-direction:column;align-items:center;gap:4px;width:60px;cursor:pointer;transition:transform .2s}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item:hover{transform:translateY(-2px)}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item:hover .acu-avatar-name{color:var(--acu-title-color)}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper{width:48px;height:48px;border-radius:50%;overflow:hidden;border:2px solid rgba(0,0,0,0);background:var(--acu-bg-panel);display:flex;align-items:center;justify-content:center}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper img{width:100%;height:100%;object-fit:cover}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper.no-img{background:var(--acu-table-head);border:1px solid var(--acu-border)}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-img-wrapper.no-img .acu-avatar-text-icon{font-size:20px;font-weight:bold;color:var(--acu-text-sub)}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-item .acu-avatar-name{font-size:11px;color:var(--acu-text-main);text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.acu-pre-edit-modal .acu-companion-selector .acu-avatar-list .acu-avatar-empty{width:100%;text-align:center;padding:20px;color:var(--acu-text-sub);font-size:12px}.acu-pre-edit-modal .acu-pre-edit-hint{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--acu-text-sub)}.acu-pre-edit-modal .acu-pre-edit-hint i{color:var(--acu-warning,#f39c12)}',e.head.appendChild(r),n.value=r,console.info('[ACU Styles] Base styles injected')})(),s(),(()=>{const e=a(),t=`${kt}-dynamic-${o.value}`;e.getElementById(t)?.remove();const n=e.createElement('style');n.id=t,n.setAttribute('data-source','acu-visualizer'),e.head.appendChild(n),r.value=n,console.info('[ACU Styles] Dynamic styles element created')})(),(()=>{const e=a(),t=`${Nt}-${o.value}`;e.getElementById(t)?.remove();const n=e.createElement('style');n.id=t,n.setAttribute('data-source','acu-visualizer-theme'),e.head.appendChild(n),i.value=n,console.info('[ACU Styles] Theme custom styles element created')})(),t.loadFromStorage(),u(),d(),c.value=!0,console.info('[ACU Styles] Style system initialized'))};return(0,p.watch)(()=>e.config,e=>{c.value&&(u(),m(e.theme),f(e.layout))},{deep:!0}),(0,p.watch)(()=>e.config.fontFamily,e=>{c.value&&g(e)}),(0,p.watch)([()=>t.currentThemeVars,()=>t.currentHighlight,()=>t.customCSS,()=>t.backgroundConfig],()=>{c.value&&d()},{deep:!0}),(0,p.onMounted)(()=>{b()}),(0,p.onUnmounted)(()=>{v()}),{isInitialized:c,init:b,cleanup:v,updateDynamicVariables:u,updateThemeCustomStyles:d,applyTheme:m,applyLayout:f,applyFont:g,applyAllStyles:()=>{u(),d(),m(),f(),g()},baseStyleEl:n,dynamicStyleEl:r,fontStyleEl:l,themeCustomStyleEl:i}}const Et='acu_locked_fields_v2_',Bt={全局数据表:null,世界地图点:'详细地点',地图元素表:'元素名称',主角信息:'姓名',重要人物表:'姓名',技能表:'技能名称',物品表:'物品名称',装备表:'装备名称',任务表:'名称',总结表:'编码索引',总体大纲:'编码索引',重要情报:'情报名称',势力:'名称'};function St(){try{const e=window.SillyTavern?.getContext?.();if(e?.chatId)return e.chatId;if(e?.characterId&&e?.chat?.length>0)return`${e.characterId}_${e.chat.length}`}catch{}return'default'}function Tt(e){return Et+(e||St())}const Dt=(0,p.ref)({}),At=(0,p.ref)({});let zt=null;function It(){function e(){const e=St();if(zt!==e){zt=e;try{const t=localStorage.getItem(Tt(e));if(t){const e=JSON.parse(t);delete e._lastAccess,Dt.value=e}else Dt.value={}}catch{Dt.value={}}}return Dt.value}function t(){try{const e={...Dt.value,_lastAccess:Date.now()};localStorage.setItem(Tt(),JSON.stringify(e)),function(){try{const e=[];for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);a?.startsWith(Et)&&e.push(a)}if(e.length<=20)return;const t=e.map(e=>{try{const t=JSON.parse(localStorage.getItem(e)||'{}');return{key:e,time:t?._lastAccess||0}}catch{return{key:e,time:0}}});t.sort((e,t)=>t.time-e.time);const a=t.slice(20);a.forEach(e=>localStorage.removeItem(e.key)),a.length>0&&console.log(`[CellLock] 清理了 ${a.length} 个过期的锁定数据`)}catch(e){console.warn('[CellLock] 清理失败',e)}}()}catch(e){console.warn('[CellLock] 保存失败',e)}}function a(e,t,a,o){const n=Bt[e];if(null===n)return'_row_0';let r=1;if(n){const e=a.indexOf(n);-1!==e&&(r=e)}const l=t[r];if(l)return`${n||a[r]}=${l}`;if(void 0!==o)return`_row_${o}`;for(let e=0;e<t.length;e++)if(t[e]&&0!==e)return`${a[e]||`col${e}`}=${t[e]}`;return null}function o(e,t){const a=t._fullRow?t._snapshot:t._fields;if(!a||0===Object.keys(a).length)return null;const o=new Array(e.length).fill(null);for(const[t,n]of Object.entries(a)){const a=e.indexOf(t);-1!==a&&(o[a]=n)}return o}const n=(0,p.computed)(()=>{let e=0;for(const t of Object.values(At.value))if('object'==typeof t)for(const a of Object.values(t))a._fullRow?e+=Object.keys(a._snapshot||{}).length:e+=Object.keys(a._fields||{}).length;return e});return{loadLocks:e,initPendingLocks:function(){e(),At.value=JSON.parse(JSON.stringify(Dt.value))},getRowKey:a,pendingLocks:At,toggleCellLock:function(e,t,a,o){const n=JSON.parse(JSON.stringify(At.value));n[e]||(n[e]={}),n[e][t]||(n[e][t]={_fullRow:!1,_fields:{},_snapshot:null});const r=n[e][t];let l;return r._fullRow&&r._snapshot?void 0!==r._snapshot[a]?(delete r._snapshot[a],0===Object.keys(r._snapshot).length&&(r._fullRow=!1,r._snapshot=null),l=!1):(r._fields[a]=o,l=!0):void 0!==r._fields[a]?(delete r._fields[a],l=!1):(r._fields[a]=o,l=!0),r._fullRow||0!==Object.keys(r._fields).length||(delete n[e][t],0===Object.keys(n[e]).length&&delete n[e]),At.value=n,console.log('[CellLock] toggleCellLock:',e,t,a,'->',l,'count:',function(e){let t=0;for(const a of Object.values(e))if('object'==typeof a)for(const e of Object.values(a))e._fullRow?t+=Object.keys(e._snapshot||{}).length:t+=Object.keys(e._fields||{}).length;return t}(n)),l},toggleRowLock:function(e,t,a,o){const n=JSON.parse(JSON.stringify(At.value));n[e]||(n[e]={});const r=n[e]?.[t];if(r?._fullRow)return delete n[e][t],0===Object.keys(n[e]).length&&delete n[e],At.value=n,console.log('[CellLock] toggleRowLock: 解锁整行',e,t),!1;const l={};return a.forEach((e,t)=>{e&&null!=o[t]&&''!==o[t]&&(l[e]=o[t])}),n[e][t]={_fullRow:!0,_fields:{},_snapshot:l},At.value=n,console.log('[CellLock] toggleRowLock: 锁定整行',e,t,'fields:',Object.keys(l).length),!0},savePendingLocks:function(){Dt.value=JSON.parse(JSON.stringify(At.value)),t()},discardPendingLocks:function(){At.value={}},isCellLockedPending:function(e,t,a){const o=At.value[e]?.[t];return!!o&&(o._fullRow?void 0!==o._snapshot?.[a]:void 0!==o._fields?.[a])},isRowLockedPending:function(e,t){return!0===At.value[e]?.[t]?._fullRow},getLockedFieldsPending:function(e,t){const a=At.value[e]?.[t];return a?a._fullRow?Object.keys(a._snapshot||{}):Object.keys(a._fields||{}):[]},hasRowAnyLockPending:function(e,t){const a=At.value[e]?.[t];return!!a&&(!!a._fullRow||Object.keys(a._fields||{}).length>0)},isCellLocked:function(t,a,o){e();const n=Dt.value[t]?.[a];return!!n&&(n._fullRow?void 0!==n._snapshot?.[o]:void 0!==n._fields?.[o])},isRowLocked:function(t,a){return e(),!0===Dt.value[t]?.[a]?._fullRow},applyLocks:function(t,n){e();const r=Dt.value[t];if(!r||!n||n.length<2)return{modified:!1,restored:[]};const l=n[0],i=[];let c=!1;const s={};for(let e=1;e<n.length;e++){const o=a(t,n[e],l,e-1);o&&(s[o]=e)}for(const[e,a]of Object.entries(r)){const r=s[e];if(void 0===r){const t=o(l,a);t&&(n.push(t),i.push(e),c=!0,console.info(`[CellLock] 恢复被删除的锁定行: ${e}`));continue}const u=n[r],d=a._fullRow?a._snapshot:a._fields;if(d)for(const[a,o]of Object.entries(d)){const n=l.indexOf(a);-1!==n&&u[n]!==o&&(console.info(`[CellLock] 恢复锁定值: ${t}[${e}].${a} = "${o}" (原值: "${u[n]}")`),u[n]=o,c=!0)}}return{modified:c,restored:i}},updateLockedValue:function(a,o,n,r){e();const l=Dt.value[a]?.[o];if(!l)return!1;let i=!1;return l._fullRow&&l._snapshot&&void 0!==l._snapshot[n]&&(l._snapshot[n]=r,i=!0),l._fields&&void 0!==l._fields[n]&&(l._fields[n]=r,i=!0),i&&(t(),console.log('[CellLock] updateLockedValue:',a,o,n,'->',r)),i},pendingLockCount:n}}const _t='row_snapshots';let Ut=null;async function Mt(){return Ut||new Promise((e,t)=>{const a=indexedDB.open('acu_history_db',1);a.onerror=()=>{console.error('[ACU IndexedDB] 打开数据库失败:',a.error),t(a.error)},a.onsuccess=()=>{Ut=a.result,console.info('[ACU IndexedDB] 数据库连接成功'),e(Ut)},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(_t)){const e=t.createObjectStore(_t,{keyPath:'id',autoIncrement:!0});e.createIndex('by_chat_row',['chatId','rowKey'],{unique:!1}),e.createIndex('by_chat','chatId',{unique:!1}),e.createIndex('by_timestamp','timestamp',{unique:!1}),console.info('[ACU IndexedDB] 创建数据库表和索引成功')}}})}async function Lt(e){const t=await Mt();return new Promise((a,o)=>{const n=t.transaction(_t,'readwrite').objectStore(_t).add(e);n.onsuccess=()=>{console.info('[ACU IndexedDB] 添加快照成功, ID:',n.result),a(n.result)},n.onerror=()=>{console.error('[ACU IndexedDB] 添加快照失败:',n.error),o(n.error)}})}async function $t(e,t){const a=await Mt();return new Promise((o,n)=>{const r=a.transaction(_t,'readonly').objectStore(_t).index('by_chat_row').getAll([e,t]);r.onsuccess=()=>{o(r.result||[])},r.onerror=()=>{console.error('[ACU IndexedDB] 查询快照失败:',r.error),n(r.error)}})}async function Pt(e){const t=await Mt();return new Promise((a,o)=>{const n=t.transaction(_t,'readwrite').objectStore(_t).delete(e);n.onsuccess=()=>{console.info('[ACU IndexedDB] 删除快照成功, ID:',e),a()},n.onerror=()=>{console.error('[ACU IndexedDB] 删除快照失败:',n.error),o(n.error)}})}function Ft(){try{const e=window.SillyTavern||window.parent?.SillyTavern||window.top?.SillyTavern;if(e?.getCurrentChatId){const t=e.getCurrentChatId();if(t)return t}if(e?.chat?.length>0){const t=e.chat[0];if(t?.chat_id)return t.chat_id}}catch(e){console.warn('[ACU History] 获取 chatId 失败:',e)}return'default'}function jt(e,t){return`${e}-row-${t}`}function Rt(e,t){const a=Object.keys(e).map(Number),o=Object.keys(t).map(Number);if(a.length!==o.length)return!1;for(const o of a)if(e[o]!==t[o])return!1;return!0}function Ot(){const e=(0,p.ref)(!1);return{isLoading:e,saveSnapshot:async function(t,a,o,n){try{e.value=!0;const r=Ft(),l=jt(t,a),i=(await $t(r,l)).sort((e,t)=>t.timestamp-e.timestamp);if(i.length>0){if(Rt(o,i[0].cells))return void console.info('[ACU History] 内容未变化，跳过记录')}if(await Lt({chatId:r,rowKey:l,timestamp:Date.now(),source:n,cells:o}),console.info(`[ACU History] 已记录 ${l} 的快照 (${n})`),i.length>=5){const e=i.slice(4);for(const t of e)void 0!==t.id&&await Pt(t.id);console.info(`[ACU History] 清理旧快照 ${e.length} 条`)}}catch(e){console.error('[ACU History] 保存快照失败:',e)}finally{e.value=!1}},getSnapshots:async function(t,a){try{e.value=!0;const o=Ft(),n=jt(t,a);console.info('[ACU History] 查询快照, 参数:',{chatId:o,rowKey:n,tableName:t,rowIndex:a});const r=await $t(o,n);return console.info('[ACU History] 查询结果:',r.length,'条'),r.sort((e,t)=>t.timestamp-e.timestamp).slice(0,5)}catch(e){return console.error('[ACU History] 获取快照失败:',e),[]}finally{e.value=!1}},snapshotToTableRow:function(e,t){return{index:t.index,key:t.key,cells:t.cells.map((t,a)=>({...t,value:void 0!==e.cells[a]?e.cells[a]:t.value}))}},tableRowToCells:function(e){const t={};return e.cells.forEach((e,a)=>{t[a]=e.value}),t},getDiff:function(e,t){const a=new Set;for(const[o,n]of Object.entries(t)){const t=Number(o);e.cells[t]!==n&&a.add(t)}for(const o of Object.keys(e.cells)){const e=Number(o);void 0===t[e]&&a.add(e)}return a},formatRelativeTime:function(e){const t=Date.now()-e;return t<6e4?'刚刚':t<36e5?`${Math.floor(t/6e4)}分钟前`:t<864e5?`${Math.floor(t/36e5)}小时前`:t<1728e5?'昨天':new Date(e).toLocaleDateString('zh-CN',{month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})},clearCurrentChatHistory:async function(){try{const e=Ft();await async function(e){const t=await Mt();return new Promise((a,o)=>{const n=t.transaction(_t,'readwrite'),r=n.objectStore(_t).index('by_chat').openCursor(IDBKeyRange.only(e));let l=0;r.onsuccess=e=>{const t=e.target.result;t&&(t.delete(),l++,t.continue())},n.oncomplete=()=>{console.info(`[ACU IndexedDB] 按聊天删除完成, 共删除 ${l} 条`),a()},n.onerror=()=>{console.error('[ACU IndexedDB] 按聊天删除失败:',n.error),o(n.error)}})}(e),console.info('[ACU History] 已清除当前聊天的历史记录')}catch(e){console.error('[ACU History] 清除历史失败:',e)}},getCurrentChatId:Ft}}async function Ht(e,t,a,o){try{const n=jt(t,a.index),r={};a.cells.forEach((e,t)=>{r[t]=String(e.value)});const l=(await $t(e,n)).sort((e,t)=>t.timestamp-e.timestamp);if(l.length>0){const e=l[0];if(Rt(r,e.cells))return void console.info('[ACU History] 内容未变化，跳过记录')}if(await Lt({chatId:e,rowKey:n,timestamp:Date.now(),source:o,cells:r}),console.info(`[ACU History] 已记录 ${n} 的快照 (${o})`),l.length>=5){const e=l.slice(4);for(const t of e)void 0!==t.id&&await Pt(t.id);console.info(`[ACU History] 清理旧快照 ${e.length} 条`)}}catch(e){console.error('[ACU History] 保存快照失败:',e)}}const Wt={indexColumnName:'编码索引',checkEmptyCell:!0,checkIndexGap:!0,emptyCheckColumns:[]};function Gt(e){if(!e||'string'!=typeof e)return!1;const t=e.toLowerCase();return t.includes('总结')||t.includes('大纲')||t.includes('summary')||t.includes('outline')}function Yt(e){if(null==e)return null;const t=String(e).trim();if(''===t)return null;const a=t.match(/(\d+)/);return a?parseInt(a[1],10):null}function Xt(e){const t=e.match(/^(.+)-row-\d+$/);if(t)return t[1];const a=e.match(/^(.+)-\d+-\d+$/);return a?a[1]:null}function Kt(e){const t=e.match(/-row-(\d+)$/);if(t)return parseInt(t[1],10);const a=e.match(/-(\d+)-\d+$/);return a?parseInt(a[1],10):null}function qt(e,t,a,o,n){const r=t.name||e,l=[];if(!Gt(r))return{sheetId:e,tableName:r,hasIssues:!1,issues:[]};if(!t.content||!Array.isArray(t.content)||t.content.length<2)return{sheetId:e,tableName:r,hasIssues:!1,issues:[]};const i=a?.content?.length||1,c=t.content.length;if(c<=i)return{sheetId:e,tableName:r,hasIssues:!1,issues:[]};const s=i,u=c-1;console.info(`[ACU IntegrityCheck] 表格 "${r}" 检测到新增行: 快照${i-1}行 → 当前${c-1}行, 新增行范围: 第${s}~${u}行(content索引)`);const d=t.content[0],p=d.findIndex(e=>String(e).trim()===n.indexColumnName);if(-1===p)return console.info(`[ACU IntegrityCheck] 表格 "${r}" 没有编码索引列，跳过检测`),{sheetId:e,tableName:r,hasIssues:!1,issues:[]};let m=null;if(a?.content&&a.content.length>1){m=Yt(a.content[a.content.length-1][p])}for(let a=s;a<=u;a++){const o=t.content[a],i=a-1;if(n.checkEmptyCell)for(let t=0;t<d.length;t++){const c=String(d[t]||'').trim();if(n.emptyCheckColumns&&n.emptyCheckColumns.length>0&&!n.emptyCheckColumns.includes(c))continue;const s=o[t];''===(null!=s?String(s).trim():'')&&l.push({sheetId:e,tableName:r,rowIndex:i,colIndex:t,issueType:'empty_cell',description:`AI新增的第 ${a} 行，"${d[t]}" 列为空`,currentValue:''})}if(n.checkIndexGap){const n=Yt(o[p]);if(a===s&&null!==m&&null!==n)n!==m+1&&l.push({sheetId:e,tableName:r,rowIndex:i,colIndex:p,issueType:'index_gap',description:`AI新增行索引从 ${m} 跳到 ${n}`,currentValue:String(o[p]??''),expectedValue:String(m+1)});else if(a>s){const c=a-1,s=Yt(t.content[c][p]);null!==s&&null!==n&&n!==s+1&&l.push({sheetId:e,tableName:r,rowIndex:i,colIndex:p,issueType:'index_gap',description:`AI新增行之间索引从 ${s} 跳到 ${n}`,currentValue:String(o[p]??''),expectedValue:String(s+1)})}}}return{sheetId:e,tableName:r,hasIssues:l.length>0,issues:l}}const Jt='acu_data_snapshot_v18_5',Zt='shujuku_v34_allSettings_v2';function Qt(e){if(null==e)return'';const t=String(e).trim();return'null'===t||'undefined'===t?'':t}const ea=t('acu-data',()=>{const e=(0,p.ref)(null),t=(0,p.ref)({}),a=(0,p.ref)(null),n=(0,p.ref)(null),r=(0,p.reactive)(new Set),l=(0,p.reactive)(new Set),i=(0,p.computed)(()=>{const e=new Set;return r.forEach(t=>e.add(t)),l.forEach(t=>e.add(t)),e}),c=(0,p.reactive)(new Set),s=(0,p.ref)(!1),u=(0,p.ref)(!1),d=(0,p.ref)(null),m=function(e={}){const t={...Wt,...e},a=(0,p.ref)(new Map),o=(0,p.computed)(()=>{const e=[];return a.value.forEach(t=>{e.push(...t)}),e}),n=(0,p.computed)(()=>o.value.length>0),r=(0,p.computed)(()=>{const e=[];return a.value.forEach((t,a)=>{t.length>0&&e.push(a)}),e}),l=(0,p.computed)(()=>{let e=0,t=0;return o.value.forEach(a=>{'empty_cell'===a.issueType&&e++,'index_gap'===a.issueType&&t++}),{total:o.value.length,emptyCell:e,indexGap:t}});return{issuesByTable:a,allIssues:o,hasIssues:n,problematicTables:r,issueStats:l,checkIntegrity:function(e,r,l){const i=new Map;if(!e||!l||0===l.size)return void(a.value=i);const c=new Map;for(const e of l){const t=Xt(e),a=Kt(e);t&&null!==a&&(c.has(t)||c.set(t,new Set),c.get(t).add(a))}for(const a in e){if('mate'===a||'updated'===a||'created'===a||a.startsWith('_'))continue;const o=e[a];if(!o||!o.name)continue;const n=o.name,l=c.get(n);if(!l||0===l.size)continue;let s=null;if(r)for(const e in r)if(r[e]?.name===n){s=r[e];break}const u=qt(a,o,s,0,t);u.hasIssues&&(i.set(u.tableName,u.issues),console.warn(`[ACU IntegrityCheck] 表格 "${u.tableName}" 发现 ${u.issues.length} 个问题`))}a.value=i,n.value?console.warn(`[ACU IntegrityCheck] 共发现 ${o.value.length} 个完整性问题`):console.info('[ACU IntegrityCheck] AI填表完整性检测通过')},hasTableIssues:function(e){const t=a.value.get(e);return!!t&&t.length>0},getTableIssues:function(e){return a.value.get(e)||[]},clearIssues:function(){a.value=new Map},getSummaryText:function(){if(!n.value)return'所有表格完整性检测通过';const e=l.value,t=[];return e.emptyCell>0&&t.push(`${e.emptyCell} 个空值`),e.indexGap>0&&t.push(`${e.indexGap} 个索引断裂`),`发现 ${t.join('、')}，共 ${e.total} 个问题`},isSummaryOrOutlineTable:Gt}}(),f=It(),g=m.issuesByTable,v=m.hasIssues,b=m.problematicTables,h=m.issueStats,x=(0,p.computed)(()=>c.size>0),y=(0,p.computed)(()=>r.size>0||l.size>0||c.size>0),w=y,k=(0,p.computed)(()=>null!==n.value);function C(){try{const e=localStorage.getItem(Jt);return e?JSON.parse(e):null}catch{return null}}function N(e){try{a.value=o(e),localStorage.setItem(Jt,JSON.stringify(e))}catch(e){console.error('[ACU] Save snapshot failed:',e)}}function V(){try{localStorage.removeItem(Jt)}catch{}}function E(e,t){return`${e}-row-${t}`}function B(e,t,a){return`${e}-${t}-${a}`}function S(){let e=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);return!e&&window.top&&window.top.SillyTavern&&(e=window.top.SillyTavern),e}function T(e,t,o){if(!a.value)return'';for(const n in a.value){const r=a.value[n];if(r&&r.name===e&&r.content){const e=r.content[t+1];if(e&&void 0!==e[o])return String(e[o])}}return''}function D(){if(!e.value)return;const a=o(e.value);for(const e in a){const o=a[e];if(!o||!o.name||!o.content)continue;const n=t.value[o.name];if(!n)continue;const r=o.content[0]||[],l=[r];for(const e of n){const t=[];for(let a=0;a<r.length;a++){const o=e.cells[a];t.push(o?o.value:'')}l.push(t)}o.content=l}e.value=a}function A(e=!1){r.clear(),l.clear(),e&&c.clear()}function I(e){const t={};for(const a in e){const o=e[a];if(!o?.name)continue;if(!o.content||!Array.isArray(o.content))continue;const n=o.name,r=o.content[0]||[],l=[];for(let e=1;e<o.content.length;e++){const t=o.content[e],a=[];for(let e=0;e<r.length;e++)a.push({key:String(r[e]||`col_${e}`),value:String(t[e]??'')});l.push({index:e-1,cells:a})}t[n]=l}return t}function U(e){if(0===c.size)return e;const t=o(e);for(const e in t){if('mate'===e)continue;const a=t[e];if(!a||!a.name||!a.content)continue;const o=[a.content[0]];for(let e=1;e<a.content.length;e++){const t=e-1,n=E(a.name,t);c.has(n)||o.push(a.content[e])}a.content=o}return t}async function M(e,t){const a=S();if(!a||!a.chat||!a.chat[e])throw new Error(`楼层 ${e} 不存在`);const n=a.chat[e];let r=function(){let e='';try{let t=window.localStorage;if(!t.getItem(Zt)&&window.parent)try{t=window.parent.localStorage}catch{}const a=t.getItem(Zt);if(a){const t=JSON.parse(a);t.dataIsolationEnabled&&t.dataIsolationCode&&(e=t.dataIsolationCode)}}catch{}return e}();if(n.TavernDB_ACU_IsolatedData){const e=Object.keys(n.TavernDB_ACU_IsolatedData);e.length>0&&(r=e[0])}else n.TavernDB_ACU_IsolatedData={};n.TavernDB_ACU_IsolatedData[r]||(n.TavernDB_ACU_IsolatedData[r]={independentData:{},modifiedKeys:[],updateGroupKeys:[]});const l=n.TavernDB_ACU_IsolatedData[r];l.independentData||(l.independentData={});const i=Object.keys(t).filter(e=>e.startsWith('sheet_'));i.forEach(e=>{l.independentData[e]=o(t[e])});const c=l.modifiedKeys||[];l.modifiedKeys=[...new Set([...c,...i])]}async function L(){const e=xt().getDB();if(e&&e.syncWorldbookEntries)try{await e.syncWorldbookEntries({createIfNeeded:!0})}catch(e){console.warn('[ACU] Worldbook sync failed:',e)}}async function P(){const e=S();e?.saveChatDebounced?await e.saveChatDebounced():e?.saveChat&&await e.saveChat()}function F(e){c.has(e)?(c.delete(e),console.info(`[ACU] 取消删除标记: ${e}`)):(c.add(e),console.info(`[ACU] 添加删除标记: ${e}`))}function j(e){const t=e.split('-');if(t.length>=2){const e=[];for(let a=0;a<t.length&&('row'!==t[a]&&!/^\d+$/.test(t[a]));a++)e.push(t[a]);if(e.length>0)return e.join('-')}return null}function R(t){if(!e.value)return null;for(const a in e.value)if(e.value[a]?.name===t)return a;return null}function O(e){return l.has(e)?'manual':r.has(e)?'ai':null}function H(e,a,o){const n=E(e,a);if(l.has(n))return'manual';if(r.has(n))return'ai';if(c.has(n))return'manual';const i=t.value[e],s=o??(i?.[a]?.cells.length||0);let u=!1,d=!1;for(let t=0;t<s;t++){const o=B(e,a,t);l.has(o)&&(u=!0),r.has(o)&&(d=!0)}return u?'manual':d?'ai':null}return{stagedData:e,tables:t,snapshot:a,aiDiffMap:r,manualDiffMap:l,diffMap:i,pendingDeletes:c,isSaving:s,isLoading:u,targetFloorInfo:d,lastSavedData:n,hasPendingDeletes:x,hasUnsavedChanges:y,hasChanges:w,getModifiedTableIds:function(){const t=new Set;for(const e of l){const a=j(e);a&&t.add(a)}for(const e of r){const a=j(e);a&&t.add(a)}for(const e of c){const a=j(e);a&&t.add(a)}const a=new Set;for(const o of t){const t=R(o);t?a.add(t):e.value&&e.value[o]&&a.add(o)}return Array.from(a)},hasUndoData:k,getStagedData:function(){return e.value},loadFromDatabase:async function(){if(u.value)console.warn('[ACU] 加载进行中，跳过重复请求');else try{u.value=!0,console.info('[ACU] 开始加载数据...');const n=yt();if(!n)return void console.warn('[ACU] 未获取到表格数据');const i=o(n);let s=0;for(const e in i){const t=i[e];if(!t?.name||!t.content||!Array.isArray(t.content))continue;const a=f.applyLocks(t.name,t.content);a.modified&&(s+=a.restored.length,console.info(`[ACU] 表 "${t.name}" 应用了锁定保护，恢复了 ${a.restored.length} 项`))}s>0&&console.info(`[ACU] 共恢复 ${s} 个被 AI 修改的锁定值`),e.value=i;const d=I(i);Object.entries(d).reduce((e,[t,a])=>(e[t]=a,e),{});t.value=d,a.value=o(i),r.clear(),l.clear(),c.clear(),N(i),m.checkIntegrity(i,null,new Set),console.info('[ACU] 数据加载完成，表格数量:',Object.keys(d).length)}catch(e){throw console.error('[ACU] 加载数据失败:',e),e}finally{u.value=!1}},processToTableData:I,setStagedData:function(a){const n=o(a);let r=0;for(const e in n){const t=n[e];if(!t?.name||!t.content||!Array.isArray(t.content))continue;const a=f.applyLocks(t.name,t.content);a.modified&&(r+=a.restored.length,console.info(`[ACU] 表 "${t.name}" 应用了锁定保护`))}r>0&&console.info(`[ACU] 共恢复 ${r} 个被 AI 修改的锁定值`),e.value=n;const l=I(n);return t.value=l,console.info('[ACU] 暂存数据已设置'),n},generateDiffMap:function(e){if(r.clear(),!a.value)return;const t=a.value;for(const a in e){if('mate'===a||'updated'===a||'created'===a||a.startsWith('_'))continue;const o=e[a],n=t[a];if(!o||!o.content)continue;const i=o.name||a.replace('sheet_','');if(!n||!n.content){for(let e=1;e<o.content.length;e++){const t=E(i,e-1);l.has(t)||r.add(t)}continue}const c=Math.max(o.content.length,n.content.length);for(let e=1;e<c;e++){const t=o.content[e],a=n.content[e],c=e-1;if(!t||!a){const e=E(i,c);if(l.has(e)||r.add(e),t&&!a)for(let e=0;e<t.length;e++){const t=B(i,c,e);l.has(t)||r.add(t)}continue}const s=Math.max(t.length,a.length);for(let e=0;e<s;e++){if(Qt(t[e])!==Qt(a[e])){const t=B(i,c,e);l.has(t)||r.add(t)}}}}console.info(`[ACU] AI差异映射已生成，AI变更: ${r.size}, 手动变更: ${l.size}`)},saveToDatabase:async function(){if(s.value)return console.warn('[ACU] 保存进行中，跳过重复请求'),{success:!1,savedToFloor:-1,error:'保存进行中'};try{s.value=!0,console.info('[ACU] 开始保存数据...');let t=e.value;if(t||(t=yt()),!t)throw new Error('无数据可保存');const n=U(o(t)),r=function(){const e=S();if(!e||!e.chat||0===e.chat.length)return-1;for(let t=e.chat.length-1;t>=0;t--){const a=e.chat[t];if(!a.is_user&&a.TavernDB_ACU_IsolatedData)return d.value={index:t,isAuto:!0,reason:'已存在数据'},t}for(let t=e.chat.length-1;t>=0;t--)if(!e.chat[t].is_user)return d.value={index:t,isAuto:!0,reason:'新建数据位置'},t;return-1}();if(-1===r)throw new Error('未找到合适的目标楼层');return await M(r,n),await L(),await P(),a.value=o(n),e.value=o(n),A(!0),N(n),console.info(`[ACU] 数据保存完成，目标楼层: ${r}`),{success:!0,savedToFloor:r}}catch(e){const t=e.message;return console.error('[ACU] 保存数据失败:',e),{success:!1,savedToFloor:-1,error:t}}finally{s.value=!1}},saveToFloor:async function(t){if(s.value)return console.warn('[ACU] 保存进行中，跳过重复请求'),{success:!1,savedToFloor:-1,error:'保存进行中'};try{s.value=!0,console.info(`[ACU] 保存到第 ${t} 楼...`);let n=e.value;if(n||(n=yt()),!n)throw new Error('无数据可保存');const r=U(o(n));return await M(t,r),await L(),await P(),a.value=o(r),e.value=o(r),A(!0),N(r),console.info(`[ACU] 已保存到第 ${t} 楼`),{success:!0,savedToFloor:t}}catch(e){const t=e.message;return console.error('[ACU] 保存到指定楼层失败:',e),{success:!1,savedToFloor:-1,error:t}}finally{s.value=!1}},purgeFloorRange:async function(e,t){if(s.value)console.warn('[ACU] 操作进行中，跳过重复请求');else try{s.value=!0,console.info(`[ACU] 清除第 ${e} 到 ${t} 楼的数据...`);const a=S();if(!a||!a.chat)throw new Error('无法访问聊天记录');const o=a.chat.length-1,n=Math.max(0,e),r=Math.min(o,t);if(isNaN(n)||isNaN(r)||n>r)throw new Error('无效的楼层范围');const l=['TavernDB_ACU_Data','TavernDB_ACU_SummaryData','TavernDB_ACU_IndependentData','TavernDB_ACU_Identity','TavernDB_ACU_IsolatedData','TavernDB_ACU_ModifiedKeys','TavernDB_ACU_UpdateGroupKeys'];let i=0;for(let e=n;e<=r;e++){const t=a.chat[e];if(!t)continue;let o=!1;for(const e of l)Object.prototype.hasOwnProperty.call(t,e)&&(delete t[e],o=!0);o&&i++}i>0&&(await P(),V(),A(!0),await L()),console.info(`[ACU] 已清除 ${i} 个楼层的数据`)}catch(e){throw console.error('[ACU] 清除楼层数据失败:',e),e}finally{s.value=!1}},insertRow:function(e,a){const o=t.value[e];if(!o||0===o.length)return void console.warn(`[ACU] 表格 ${e} 不存在或为空`);const n=o[0],r={index:o.length,cells:n.cells.map(e=>({key:e.key,value:''}))};o.splice(a+1,0,r),o.forEach((e,t)=>{e.index=t});const i=E(e,a+1);l.add(i),D(),console.info(`[ACU] 在 ${e} 第 ${a} 行后插入新行`)},updateCell:function(e,a,o,n,i){const c=t.value[e];if(!c||!c[a])return void console.warn(`[ACU] 无效的单元格位置: ${e}[${a}][${o}]`);const s=c[a];if(s.cells[o]){const t=s.cells[o].value;s.cells[o].value=n;const c=B(e,a,o);if(n!==T(e,a,o)){if(l.add(c),r.delete(c),!i?.skipHistory){const r=function(){const e=S();if(e?.getCurrentChatId){const t=e.getCurrentChatId();if(t)return t}return e?.chat_metadata?.chat_id?String(e.chat_metadata.chat_id):e?.chat?.length>0&&e.chat[0]?.chat_id?e.chat[0].chat_id:'default'}();if(console.info('[ACU] 保存历史记录, 参数:',{chatId:r,tableId:e,rowIndex:a,colIndex:o,oldValue:t.substring(0,50)+(t.length>50?'...':''),newValue:n.substring(0,50)+(n.length>50?'...':'')}),r){const n={index:a,key:E(e,a),cells:s.cells.map((e,a)=>({colIndex:a,key:e.key,value:a===o?t:e.value}))};Ht(r,e,n,'manual').then(()=>{console.info('[ACU] 历史记录保存成功')}).catch(e=>{console.warn('[ACU] 历史记录保存失败:',e)})}else console.warn('[ACU] 无法获取 chatId，跳过历史记录保存')}}else{l.delete(c),r.delete(c);s.cells.every((t,o)=>t.value===T(e,a,o))&&s.cells.forEach((_,t)=>{const o=B(e,a,t);l.delete(o),r.delete(o)})}D(),console.info(`[ACU] 更新 ${e}[${a}][${o}]: "${t}" -> "${n}"`)}},toggleDelete:F,toggleDeleteRow:function(e,t){F(E(e,t))},markForDelete:function(e,t){const a=E(e,t);c.add(a)},unmarkForDelete:function(e,t){const a=E(e,t);c.delete(a)},getCellChangeType:O,getRowChangeType:H,hasTableAiChanges:function(e){for(const t of r)if(t.startsWith(`${e}-`))return!0;return!1},getTablesWithAiChanges:function(){const e=new Set;for(const t of r){const a=j(t);a&&e.add(a)}return Array.from(e)},isRowChanged:function(e,t,a){return null!==H(e,t,a)},isRowPendingDelete:function(e,t){return c.has(E(e,t))},isPendingDelete:function(e){return c.has(e)},isCellChanged:function(e){return null!==O(e)},getRowKey:E,getCellKey:B,clearChanges:A,syncToStagedData:D,loadSnapshot:C,saveSnapshot:N,clearSnapshot:V,saveLastState:function(){const e=a.value||C();e?(n.value=o(e),console.info('[ACU] 已保存当前快照到撤回缓存')):console.warn('[ACU] 无快照数据可保存到撤回缓存')},undoToLastSave:function(){if(!n.value)return console.warn('[ACU] 无可撤回的数据'),!1;const i=o(n.value);e.value=i;const s=I(i);t.value=s,r.clear(),c.clear();const u=[];if(a.value)for(const e in i){if('mate'===e||'updated'===e||'created'===e||e.startsWith('_'))continue;const t=i[e],o=a.value[e];if(!t?.content)continue;const n=t.name||e.replace('sheet_','');if(!o?.content){for(let e=1;e<t.content.length;e++){const t=E(n,e-1);u.push(t)}continue}const r=Math.max(t.content.length,o.content.length);for(let e=1;e<r;e++){const a=t.content[e],r=o.content[e],l=e-1;if(!a||!r){const e=E(n,l);u.push(e);continue}const i=Math.max(a.length,r.length);for(let e=0;e<i;e++){if(String(a[e]??'')!==String(r[e]??'')){const t=B(n,l,e);u.push(t)}}}}return l.clear(),u.forEach(e=>l.add(e)),l.add('__undo_pending__'),console.info(`[ACU] 撤回后差异: 手动变更 ${l.size} 项`),console.info('[ACU] 已撤回到上次保存前的状态（需手动保存）'),!0},clearUndoCache:function(){n.value=null,console.info('[ACU] 已清除撤回缓存')},getUndoData:function(){return n.value?o(n.value):null},integrityIssues:g,hasIntegrityIssues:v,problematicTables:b,integrityStats:h,checkIntegrity:e=>{m.checkIntegrity(e,a.value,r)},hasTableIssues:m.hasTableIssues,getTableIssues:m.getTableIssues,getIntegritySummary:m.getSummaryText,clearIntegrityIssues:m.clearIssues,isSummaryOrOutlineTable:Gt}}),ta=[{id:'superLucky',name:'中！',weight:5,color:'#ffd700',prompt:'如有神助，无往不利。甚至有意想不到的收获。'},{id:'lucky',name:'大吉',weight:15,color:'#fbc02d',prompt:'合心合意，顺风顺水。再大的阻碍也能以奇怪的方式丝滑解决。'},{id:'slightlyLucky',name:'末吉',weight:20,color:'#e6b000',prompt:'有惊无险。尽管一波三折，结果也勉强让人满意。'},{id:'neutral',name:'平',weight:20,color:'#808080',prompt:'客观中立。严格遵循世界观下的现实逻辑，成败完全取决于操作的可行性。'},{id:'slightlyUnlucky',name:'小凶',weight:20,color:'#ffa07a',prompt:'事倍功半。虽然没有彻底失败，但必须付出额外的代价才能勉强维持现状。'},{id:'unlucky',name:'大凶',weight:15,color:'#ff6347',prompt:'墨菲定律生效：如果事情可能变糟，它就必须变糟。'},{id:'superUnlucky',name:'不中嘞...',weight:5,color:'#8b0000',prompt:'灾难性的连锁反应。最坏的情况不仅发生了，还会引发更多的灾难。'}];function aa(e){const t=xt().getDB(),a=t?.exportTableAsJson?.();if(!a)return e;const o=a[`sheet_${e}`];return o?.name||e}function oa(){const e=xt().getDB(),t=e?.exportTableAsJson?e.exportTableAsJson():null;if(!t)return console.info('[useWordPool] ACU API 不可用或返回空，无法检测词库表'),[];const a=[];for(const[e,o]of Object.entries(t)){if(!e.startsWith('sheet_'))continue;const t=e.replace('sheet_',''),n=o.name||'',r=['随机','随机词','random','dict','chaos'].some(e=>n.toLowerCase().includes(e.toLowerCase())),l=['随机','随机词','random','dict','chaos'].some(e=>t.toLowerCase().includes(e.toLowerCase()));(r||l)&&a.push(t)}return console.info(`[useWordPool] 扫描了 ${Object.keys(t).length} 个表，检测到 ${a.length} 个词库表:`,a),a}function na(e){const t=xt().getDB(),a=t?.exportTableAsJson?t.exportTableAsJson():null;if(!a)return[];const o=a[`sheet_${e}`];let n=[];if(Array.isArray(o))n=o;else if(o&&'object'==typeof o&&Array.isArray(o.content)){const e=o.content;if(e.length>1){const t=e[0];for(let a=1;a<e.length;a++){const o=e[a],r={};t.forEach((e,t)=>{e&&(r[e]=o[t]||'')}),n.push(r)}}}return console.log(`[useWordPool] 表 "${e}" 解析后的数据行数: ${n.length}`),n.length>0?console.log(`[useWordPool] 表 "${e}" 第一行示例:`,n[0]):console.warn(`[useWordPool] 表 "${e}" 解析后为空，无法提取词库`),n}function ra(e){const t=[...e];for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t}const la='ACU_Divination',ia={id:'luck',name:'运势',enabled:!0,tiers:ta},ca={id:'sanity',name:'扭曲度',enabled:!0,tiers:[{id:'normal',name:'正常逻辑',weight:50,prompt:''},{id:'absurd',name:'“天然合理”',weight:50,prompt:'特别要求：若需要融合非日常要素，场景中的所有角色必须将其视为日常生活中理所当然的一部分，绝不要有特殊反应。'}]},sa={enabled:!0,drawCount:4,enableBias:!0,autoSync:!0,cardBackImage:'',themeColor:'#6b4c9a',themeId:'wafuku',flipMode:'auto',peepMode:!1,dimensions:[ia,ca],customTemplate:'',enableWordDrawing:!0,enableTableWords:!0,enableWordPool:!1,wordDrawMode:'perItem',wordsPerItem:1,tableColumnConfig:void 0,tablePoolConfig:{},categoryConfig:{}},ua=t('acu-divination',()=>{const e=(0,p.ref)({...sa}),t=(0,p.ref)([]),a=(0,p.ref)(!1),o=(0,p.ref)([]),n=(0,p.ref)(null);function r(){try{if('function'!=typeof getVariables||'function'!=typeof replaceVariables)return;const t={...getVariables({type:'global'}),divinationConfig:e.value,divinationPresets:o.value,activeDivinationPresetId:n.value};replaceVariables(t,{type:'global'}),console.info('[Divination] Config saved to global variables')}catch(e){console.error('[Divination] Failed to save config:',e)}}function l(t){const a={id:`preset_${Date.now()}`,name:t,createdAt:(new Date).toISOString(),dimensions:JSON.parse(JSON.stringify(e.value.dimensions))};return o.value.push(a),n.value=a.id,a}function i(e){const t=e.split('|'),a=t[0];let o='neutral',n=0;if(t.length>1){const e=t[1];o='正'===e||'positive'===e?'positive':'负'===e||'negative'===e?'negative':'neutral'}return t.length>2&&(n=parseInt(t[2],10)||0),{name:a,bias:o,limit:n}}async function c(){try{if('function'!=typeof getWorldbook)return void console.warn('[Divination] getWorldbook API unavailable');await(getWorldbookNames?.());const e=await getWorldbook(la);t.value=e.map(e=>{const{name:t,bias:a,limit:o}=i(e.name),n=e.content.split(/[,，、\n]/).map(e=>e.trim()).filter(e=>e);return{id:e.uid,name:t,bias:a,limit:o,path:[...e.strategy.keys,t],words:n,enabled:e.enabled,rawEntry:e}}),console.info(`[Divination] Loaded ${t.value.length} categories from worldbook`)}catch(e){console.warn('[Divination] Failed to load worldbook (it might not exist yet):',e),t.value=[]}}function s(e,t){if(0===e.length||e.length!==t.length)return null;const a=t.reduce((e,t)=>e+t,0);let o=Math.random()*a;for(let a=0;a<e.length;a++)if(o-=t[a],o<=0)return e[a];return e[e.length-1]}return(0,p.watch)([e,o,n],()=>{a.value&&r()},{deep:!0}),{config:e,categories:t,isLoaded:a,loadConfig:function(){try{if('function'!=typeof getVariables)return console.warn('[Divination] getVariables API unavailable'),void(a.value=!0);const t=getVariables({type:'global'});t&&(t.divinationPresets&&(o.value=t.divinationPresets),t.activeDivinationPresetId&&(n.value=t.activeDivinationPresetId),t.divinationConfig&&(e.value={...sa,...t.divinationConfig,dimensions:t.divinationConfig.dimensions||sa.dimensions,tablePoolConfig:t.divinationConfig.tablePoolConfig||{}},t.divinationConfig.tableColumnConfig&&Object.keys(t.divinationConfig.tableColumnConfig).length>0&&0===Object.keys(e.value.tablePoolConfig).length&&(e.value.tablePoolConfig={...t.divinationConfig.tableColumnConfig},e.value.tableColumnConfig=void 0,console.info('[Divination] Migrated tableColumnConfig → tablePoolConfig')),console.info('[Divination] Config loaded from global variables'))),a.value=!0}catch(e){console.error('[Divination] Failed to load config:',e),a.value=!0}},saveConfig:r,loadFromWorldbook:c,syncFromACU:async function(){console.info('[Divination] Starting sync from ACU...');try{const e=yt();if(!e)return void console.warn('[Divination] No ACU table data found');const t=[];for(const a in e){const o=e[a];o.name&&(o.name.includes('Random')||o.name.includes('随机'))&&t.push(o)}if(0===t.length)return void console.info('[Divination] No "Random" tables found to sync');const a=new Map;for(const e of t){const t=e.content?.[0]||[],o=e.content?.slice(1)||[];t.forEach((t,n)=>{const r=String(t).trim();if(!r)return;let{name:l,bias:c,limit:s}=i(r);-1===r.indexOf('|')&&(l.includes('吉')||l.includes('好')||l.includes('正')||l.includes('赏')?c='positive':(l.includes('凶')||l.includes('坏')||l.includes('负')||l.includes('罚'))&&(c='negative'));const u=`${l}|${c}|${s}`;a.has(u)||a.set(u,{name:l,bias:c,limit:s,words:new Set,keys:[e.name||'Random']}),o.forEach(e=>{const t=e[n];if(t){const e=String(t).trim();e&&a.get(u).words.add(e)}})})}let o=[];try{o=await getWorldbook(la)}catch{}const n=[];for(const[e,t]of a){const e=`${t.name}|${t.bias}|${t.limit}`,a=o.find(t=>t.name===e),r=a?a.content.split(/[,，、\n]/).map(e=>e.trim()).filter(e=>e):[],l=new Set([...r,...t.words]),i=Array.from(l).join('\n');a?n.push({...a,content:i,strategy:{...a.strategy}}):n.push({name:e,enabled:!0,strategy:{type:'constant',keys:t.keys,keys_secondary:{logic:'not_all',keys:[]},scan_depth:'same_as_global'},position:{type:'before_character_definition',role:'system',depth:0,order:0},content:i,probability:100,recursion:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:{sticky:null,cooldown:null,delay:null}})}const r=new Set(n.map(e=>e.name)),l=o.filter(e=>!r.has(e.name));n.push(...l),'function'==typeof createOrReplaceWorldbook?(await createOrReplaceWorldbook(la,n,{render:'debounced'}),console.info('[Divination] Synced to worldbook successfully'),await c()):console.warn('[Divination] createOrReplaceWorldbook API unavailable')}catch(e){console.error('[Divination] Sync failed:',e)}},performDivination:function(){const a=[];let o=null;for(const t of e.value.dimensions)if(t.enabled&&t.tiers.length>0){const e=t.tiers.map(e=>e.weight),n=s(t.tiers,e);n&&(a.push({dimension:t,tier:n}),'luck'===t.id&&(o=n))}let n=[];if(e.value.enableTableWords){const t=function(e,t,a,o){const n=oa(),r=[],l=new Map;for(const e of n){const t=o[e];if(t&&!t.enabled)continue;const a=na(e);if(0===a.length)continue;const n=a[a.length-1],r=[];for(const e of Object.values(n))if(e&&'string'==typeof e){const t=e.trim();t&&r.push(t)}r.length>0&&l.set(e,r)}if('perItem'===e){for(const[e,a]of l){const e=Math.min(t,a.length),o=ra([...a]);r.push(...o.slice(0,e))}console.info(`[useWordPool] perItem 模式从表格抽取 ${r.length} 个词:`,r)}else if('custom'===e){let e=a;for(const[a,n]of l){if(e<=0)break;const l=o[a],i=l?.limit||0,c=i>0?Math.min(i,e):Math.min(t,e),s=Math.min(c,n.length),u=ra([...n]);r.push(...u.slice(0,s)),e-=s}console.info(`[useWordPool] custom 模式从表格抽取 ${r.length} 个词:`,r)}else{const e=[];for(const t of l.values())e.push(...t);const t=ra(e),o=Math.min(a,t.length);r.push(...t.slice(0,o)),console.info(`[useWordPool] mixed 模式从表格抽取 ${r.length} 个词:`,r)}return r}(e.value.wordDrawMode,e.value.wordsPerItem,e.value.drawCount,e.value.tablePoolConfig);n.push(...t),console.info(`[Divination] 从表格抽词，模式: ${e.value.wordDrawMode}，结果:`,t)}if(e.value.enableWordPool){const a='perItem'===e.value.wordDrawMode?e.value.wordsPerItem:Math.max(0,e.value.drawCount-n.length),r=function(t,a,o,n,r,l){const i=[],c=n.filter(e=>{const t=r[e.id];return(t?t.enabled:e.enabled)&&e.words.length>0});if(0===c.length)return i;if('perItem'===t){for(const e of c){const t=Math.min(a,e.words.length),o=ra([...e.words]);i.push(...o.slice(0,t))}console.info(`[Divination] perItem 模式从世界书抽取 ${i.length} 个词:`,i)}else if('custom'===t){let e=o;for(const t of c){if(e<=0)break;const o=r[t.id],n=o?.limit??t.limit??0,l=n>0?Math.min(n,e):Math.min(a,e),c=Math.min(l,t.words.length),s=ra([...t.words]);i.push(...s.slice(0,c)),e-=c}console.info(`[Divination] custom 模式从世界书抽取 ${i.length} 个词:`,i)}else{const t=c.map(t=>e.value.enableBias&&l?function(e,t){const a=e.id;return'superLucky'===a||'lucky'===a?'positive'===t?3:1:'slightlyLucky'===a?'positive'===t?2:1:'neutral'===a?1:'slightlyUnlucky'===a?'negative'===t||'neutral'===t?2:1:'unlucky'===a||'superUnlucky'===a?'negative'===t?3:'neutral'===t?2:1:1}(l,t.bias):1);let a=o;for(;a>0;){const e=s(c,t);if(!e)break;const o=e.words[Math.floor(Math.random()*e.words.length)];i.push(o),a--}console.info(`[Divination] mixed 模式从世界书抽取 ${i.length} 个词:`,i)}return i}(e.value.wordDrawMode,e.value.wordsPerItem,a,t.value,e.value.categoryConfig,o);n.push(...r),console.info(`[Divination] 从世界书抽词，模式: ${e.value.wordDrawMode}，结果:`,r)}e.value.enableTableWords&&e.value.enableWordPool&&n.length>0&&(n=ra(n),console.info('[Divination] 混合抽词后打乱顺序:',n));const r=a.find(e=>'luck'===e.dimension.id),l=a.filter(e=>'luck'!==e.dimension.id).map(e=>({name:e.dimension.name,value:e.tier.name,prompt:e.tier.prompt}));return{luck:r?{name:r.tier.name,color:r.tier.color||'#808080',prompt:r.tier.prompt}:{name:'未知',color:'#808080',prompt:''},dimensions:l,words:n,timestamp:Date.now()}},addDimension:function(t){e.value.dimensions.push(t)},updateDimension:function(t,a){t>=0&&t<e.value.dimensions.length&&(e.value.dimensions[t]=a)},removeDimension:function(t){if(t>=0&&t<e.value.dimensions.length){if('luck'===e.value.dimensions[t].id)return void console.warn('[Divination] Cannot remove luck dimension');e.value.dimensions.splice(t,1)}},uploadCardBack:async function(t){try{const a=await vt(t),o=await bt(a,1024,.9);e.value.cardBackImage=o,console.info('[Divination] Card back image uploaded')}catch(e){throw console.error('[Divination] Failed to upload card back:',e),e}},updateCategory:async function(e){try{const a=t.value.findIndex(t=>t.id===e.id);-1!==a&&(t.value[a]=e);let o=[];try{o=await getWorldbook(la)}catch{console.warn('[Divination] Worldbook not found, creating new...')}const n=o.findIndex(t=>t.uid===e.id),r=e.words.join('\n');if(-1===n)return void console.warn(`[Divination] Entry with uid ${e.id} not found in worldbook`);o[n]={...o[n],content:r,enabled:e.enabled},'function'==typeof createOrReplaceWorldbook&&(await createOrReplaceWorldbook(la,o,{render:'debounced'}),console.info('[Divination] Category updated in worldbook'))}catch(e){console.error('[Divination] Failed to update category:',e)}},presets:o,activePresetId:n,createPreset:l,saveCurrentToPreset:function(t){const a=o.value.findIndex(e=>e.name===t);if(a>-1){const t=o.value[a],r={...t,dimensions:JSON.parse(JSON.stringify(e.value.dimensions))};return o.value[a]=r,n.value=t.id,r}return l(t)},deletePreset:function(e){const t=o.value.findIndex(t=>t.id===e);t>-1&&(o.value.splice(t,1),n.value===e&&(n.value=null))},applyPreset:function(t){const a=o.value.find(e=>e.id===t);a&&(e.value.dimensions=JSON.parse(JSON.stringify(a.dimensions)),n.value=t)},restoreDefaultDimensions:function(){e.value.dimensions=[JSON.parse(JSON.stringify(ia)),JSON.parse(JSON.stringify(ca))],n.value=null}}}),da='acu_ui_collapse_state',pa='acu_pin_state',ma='acu_active_tab',fa='acu_table_order',ga='acu_table_heights',va='acu_table_styles',ba='acu_reverse_tables',ha='acu_float_ball_pos',xa='acu_layout',ya='acu_visible_tabs',wa='acu_tab_order',ka='acu_tab_dashboard_home',Ca='acu_tab_options_panel',Na='acu_tab_relationship_graph';function Va(e){return/势力|组织|阵营/.test(e)?'fas fa-fist-raised':/技能/.test(e)?'fas fa-magic':/人物|角色|npc/i.test(e)?'fas fa-users':/交互|行动/.test(e)?'fas fa-hand-pointer':/随机/.test(e)?'fas fa-dice':/全局/.test(e)?'fas fa-globe':/地点|地图/.test(e)?'fas fa-map-marked-alt':/大纲/.test(e)?'fas fa-book':'fas fa-table'}const Ea=t('acu-ui',()=>{const e=te(da,!1),t=te(pa,!1),a=te(ma,null),o=te(fa,[]),n=te(ga,{}),r=te(va,{}),l=te(ba,[]),i=te(ha,{x:20,y:'undefined'!=typeof window?window.innerHeight-150:500}),c=te(xa,'horizontal'),s=te(ya,[]),u=te(wa,[]),d=(0,p.ref)(1),m=(0,p.ref)(''),f=(0,p.ref)(0),g=(0,p.ref)(!1),v=(0,p.ref)(!1),b=(0,p.ref)(!1),h=(0,p.ref)(!1),x=(0,p.ref)(!1),y=(0,p.ref)(!1),w=(0,p.ref)(null),k=(0,p.reactive)({visible:!1,props:{tableName:'',tableId:'',rowIndex:0,currentRowData:null}}),C=(0,p.reactive)({visible:!1,props:{widgetId:'',widgetConfig:null,tableHeaders:[]}}),N=(0,p.reactive)({visible:!1,props:{tableName:'',tableId:'',rowIndex:0,currentRowData:null,titleColIndex:0}}),V=(0,p.reactive)({visible:!1,props:{imageUrl:'',name:'',initialOffsetX:50,initialOffsetY:50,initialScale:150,initialInvert:!1,showInvertOption:!1}}),E=(0,p.shallowRef)(null),B=(0,p.shallowRef)(null),S=(0,p.reactive)({visible:!1,props:{widgetId:'',currentActions:[]}}),T=(0,p.reactive)({visible:!1,props:{nodes:[],factions:[]}}),D=(0,p.shallowRef)(null),A=(0,p.shallowRef)(null),I=(0,p.reactive)({visible:!1,props:{nodeId:'',fullName:'',currentLabel:'',selectedIndices:[]}}),U=(0,p.shallowRef)(null),M=(0,p.shallowRef)(null),L=(0,p.shallowRef)(null),P=(0,p.reactive)({visible:!1,props:{fullName:'',initialIndices:[]}}),F=(0,p.shallowRef)(null),j=(0,p.shallowRef)(null);function R(){P.visible=!1,F.value=null,j.value=null}const O=(0,p.reactive)({visible:!1,props:{factions:[]}}),H=(0,p.reactive)({visible:!1,props:{factionId:'',factionName:''}}),W=(0,p.ref)(!1),G=(0,p.ref)(!1),Y=(0,p.reactive)({visible:!1,props:{currentFloor:0}}),X=(0,p.reactive)({visible:!1,props:{maxFloor:0}}),K=(0,p.reactive)({visible:!1,props:{initialStartFloor:void 0,initialEndFloor:void 0}}),q=(0,p.shallowRef)(null),J=(0,p.ref)(!1),Z=(0,p.reactive)({visible:!1,props:{tableName:'',tableId:'',rowIndex:0,currentRowData:null,titleColIndex:1}}),Q=(0,p.ref)(!1),ee=(0,p.reactive)({visible:!1,props:{presetType:'manual-update',summaryItems:[],initialName:''}}),ae=(0,p.shallowRef)(null),oe=(0,p.reactive)({visible:!1,props:{categoryId:'',rowContext:{title:'',value:''},widgetId:''}}),ne=(0,p.reactive)({visible:!1,props:{tagLabel:'',resolvedPrompt:'',showCompanions:!1,widgetId:''}}),re=(0,p.reactive)({visible:!1,props:{widgetId:'',displayedTagIds:[],displayedCategoryIds:[]}}),le=(0,p.shallowRef)(null),ie=(0,p.reactive)({visible:!1,props:{currentIcon:''}}),ce=(0,p.shallowRef)(null);function se(){ie.visible=!1,ce.value=null}const ue=(0,p.reactive)({visible:!1,result:null}),de=(0,p.reactive)({visible:!1,props:{prompt:''}}),pe=(0,p.computed)(()=>!e.value&&null!==a.value),me=(0,p.computed)(()=>a.value===ka),fe=(0,p.computed)(()=>a.value===Ca);const ge=(0,p.computed)(()=>m.value);const ve=(0,p.computed)(()=>'horizontal'===c.value);function be(e){if(!u.value||0===u.value.length)return e;return[...u.value.filter(t=>e.includes(t)),...e.filter(e=>!u.value.includes(e))]}function he(){V.visible=!1,E.value=null,B.value=null}function xe(){I.visible=!1,U.value=null,M.value=null,L.value=null}function ye(e='main'){'main'!==e&&(w.value=e),W.value=!0}function we(){K.visible=!1,q.value=null}function ke(){ee.visible=!1,ae.value=null}function Ce(){re.visible=!1,le.value=null}return{isCollapsed:e,isPinned:t,activeTab:a,tableOrder:o,tableHeights:n,tableStyles:r,reverseTables:l,ballPosition:i,layout:c,visibleTabs:s,currentPage:d,searchTerm:m,currentSearchTerm:ge,scrollTop:f,isEditingOrder:g,isInitialized:v,isContentHidden:b,isMobile:h,isLockEditMode:x,showLockedOnly:y,initialSettingsPanel:w,isPanelVisible:pe,isDashboardActive:me,isOptionsActive:fe,reverseOrderTables:l,isHorizontalLayout:ve,toggleCollapse:function(){e.value=!e.value},togglePin:function(){t.value=!t.value},setActiveTab:function(e){a.value=e,d.value=1,m.value=''},setTableOrder:function(e){o.value=e},setTableHeight:function(e,t){n.value={...n.value,[e]:t}},resetTableHeight:function(e){const t={...n.value};delete t[e],n.value=t},getTableHeight:function(e){return n.value[e]},setTableStyle:function(e,t){r.value={...r.value,[e]:t}},getTableStyle:function(e){return r.value[e]||'list'},toggleTableReverse:function(e){const t=[...l.value],a=t.indexOf(e);a>-1?t.splice(a,1):t.push(e),l.value=t},isTableReversed:function(e){return l.value.includes(e)},setCurrentPage:function(e){d.value=Math.max(1,e)},setSearchTerm:function(e){m.value=e.toLowerCase(),d.value=1},saveScrollTop:function(e){f.value=e},enterEditingOrder:function(){g.value=!0},exitEditingOrder:function(){g.value=!1},setEditingOrder:function(e){g.value=e},setMobile:function(e){h.value=e},setLayout:function(e){c.value=e},toggleLayout:function(){c.value='horizontal'===c.value?'vertical':'horizontal'},closePanel:function(){e.value=!0,b.value=!1},openPanel:function(){b.value=!1,e.value=!1,null===a.value&&(a.value=ka)},setInitialized:function(e){v.value=e},updateSaveBtnState:function(){const{$}=window.jQuery?{$:window.jQuery}:{$:window.parent.$};if(!$)return;const e=ea().hasUnsavedChanges,t=$(window.parent.document).find('#acu-btn-save-global');t.length&&(e?(t.addClass('acu-has-changes'),t.find('i').addClass('fa-beat-fade'),t.css('color','#e67e22')):(t.removeClass('acu-has-changes'),t.find('i').removeClass('fa-beat-fade'),t.css('color','')))},autoFitPanelHeight:function(e=!1){const{$}=window.jQuery?{$:window.jQuery}:{$:window.parent.$};if(!$)return;const t=$(window.parent.document).find('#acu-data-area');if(!t.length)return;const o=a.value;!e&&o&&n.value[o]||setTimeout(()=>{const e=t[0].scrollHeight,a=($(window.parent).height()||800)-200;let o=Math.min(e+20,a);o<200&&(o=200),t.css('height',o+'px')},100)},saveBallPosition:function(e){i.value=e},getBallPosition:function(){return i.value},resetBallPosition:function(){const e='undefined'!=typeof window?window.parent?.innerHeight??window.innerHeight:500;i.value={x:20,y:Math.max(100,e-150)}},setVisibleTabs:function(e){s.value=e},isTabVisible:function(e){return 0===s.value.length||s.value.includes(e)},toggleTabVisibility:function(e){const t=[...s.value],a=t.indexOf(e);a>-1?t.splice(a,1):t.push(e),s.value=t},resetVisibleTabs:function(){s.value=[]},tabOrder:u,setTabOrder:function(e){u.value=e},getSortedTabIds:be,moveTab:function(e,t,a){const o=be(a),n=o.indexOf(e);if(-1===n)return;const r=[...o];r.splice(n,1),r.splice(t,0,e),u.value=r},showTab:function(e){s.value.includes(e)||(s.value=[...s.value,e])},hideTab:function(e){s.value=s.value.filter(t=>t!==e)},resetTabConfig:function(){s.value=[],u.value=[]},syncNewTablesToVisibleTabs:function(e){if(0===s.value.length)return[];const t=e.filter(e=>!s.value.includes(e));return t.length>0&&(s.value=[...s.value,...t],console.info(`[ACU] 检测到 ${t.length} 个新表格，已自动添加到可见列表:`,t)),t},rowEditDialog:k,widgetSettingsDialog:C,dashboardHistoryDialog:N,avatarCropDialog:V,widgetActionsDialog:S,avatarManagerDialog:T,nodeConfigDialog:I,nodeLabelDialog:P,graphSettingsDialog:O,factionSettingsDialog:H,settingsDialog:W,directorDialog:G,inputFloorDialog:Y,purgeRangeDialog:X,advancedPurgeDialog:K,manualUpdateDialog:J,historyDialog:Z,tabsPopup:Q,presetSaveDialog:ee,openRowEditDialog:function(e){k.props={...e},k.visible=!0},closeRowEditDialog:function(){k.visible=!1},openWidgetSettingsDialog:function(e){C.props={...e},C.visible=!0},closeWidgetSettingsDialog:function(){C.visible=!1},openDashboardHistoryDialog:function(e){N.props={...e},N.visible=!0},closeDashboardHistoryDialog:function(){N.visible=!1},switchFromRowEditToHistory:function(){N.props={tableName:k.props.tableName,tableId:k.props.tableId,rowIndex:k.props.rowIndex,currentRowData:k.props.currentRowData,titleColIndex:0},k.visible=!1,N.visible=!0},openAvatarCropDialog:function(e,t){V.props={imageUrl:e.imageUrl,name:e.name,initialOffsetX:e.initialOffsetX??50,initialOffsetY:e.initialOffsetY??50,initialScale:e.initialScale??150,initialInvert:e.initialInvert??!1,showInvertOption:e.showInvertOption??!1},E.value=t.onApply,B.value=t.onUpload??null,V.visible=!0},closeAvatarCropDialog:he,handleAvatarCropApply:function(e){E.value&&E.value(e),he()},handleAvatarCropUpload:function(e){B.value&&B.value(e)},openWidgetActionsDialog:function(e){S.props={...e},S.visible=!0},closeWidgetActionsDialog:function(){S.visible=!1},openAvatarManagerDialog:function(e,t){T.props={...e},D.value=t.onUpdate??null,A.value=t.onLabelChange??null,T.visible=!0},closeAvatarManagerDialog:function(){T.visible=!1,D.value=null,A.value=null},handleAvatarManagerUpdate:function(){D.value&&D.value()},handleAvatarManagerLabelChange:function(){A.value&&A.value()},openNodeConfigDialog:function(e,t){I.props={...e},U.value=t.onConfirm,M.value=t.onResetToFullName,L.value=t.onStyleUpdate??null,I.visible=!0},closeNodeConfigDialog:xe,handleNodeConfigConfirm:function(e,t,a){U.value&&U.value(e,t,a),xe()},handleNodeConfigResetToFullName:function(e,t){M.value&&M.value(e,t),xe()},handleNodeConfigStyleUpdate:function(e){L.value&&L.value(e)},openNodeLabelDialog:function(e,t){P.props={...e},F.value=t.onApply,j.value=t.onReset,P.visible=!0},closeNodeLabelDialog:R,handleNodeLabelApply:function(e){F.value&&F.value(e),R()},handleNodeLabelReset:function(){j.value&&j.value(),R()},openGraphSettingsDialog:function(e=[]){O.props.factions=e,O.visible=!0},closeGraphSettingsDialog:function(){O.visible=!1},openFactionSettingsDialog:function(e,t){H.props={factionId:e,factionName:t},H.visible=!0},closeFactionSettingsDialog:function(){H.visible=!1},openSettingsDialog:ye,closeSettingsDialog:function(){W.value=!1},openDirectorDialog:function(){G.value=!0},closeDirectorDialog:function(){G.value=!1},openInputFloorDialog:function(e=0){Y.props.currentFloor=e,Y.visible=!0},closeInputFloorDialog:function(){Y.visible=!1},openPurgeRangeDialog:function(e=0){X.props.maxFloor=e,X.visible=!0},closePurgeRangeDialog:function(){X.visible=!1},openAdvancedPurgeDialog:function(e,t){K.props={...e},q.value=t.onConfirm,K.visible=!0},closeAdvancedPurgeDialog:we,handleAdvancedPurgeConfirm:function(e){q.value&&q.value(e),we()},openManualUpdateDialog:function(){J.value=!0},closeManualUpdateDialog:function(){J.value=!1},openHistoryDialog:function(e){Z.props={...e},Z.visible=!0},closeHistoryDialog:function(){Z.visible=!1},openTabsPopup:function(){Q.value=!0},closeTabsPopup:function(){Q.value=!1},toggleTabsPopup:function(){Q.value=!Q.value},openPresetSaveDialog:function(e,t){ee.props={...e},ae.value=t.onSave,ee.visible=!0},closePresetSaveDialog:ke,handlePresetSave:function(e){ae.value&&ae.value(e),ke()},categorySelectDialog:oe,tagPreEditDialog:ne,tagManagerDialog:re,openCategorySelectDialog:function(e){oe.props={...e},oe.visible=!0},closeCategorySelectDialog:function(){oe.visible=!1},openTagPreEditDialog:function(e){ne.props={...e},ne.visible=!0},closeTagPreEditDialog:function(){ne.visible=!1},openTagManagerDialog:function(e,t){re.props={...e},le.value=t??null,re.visible=!0},closeTagManagerDialog:Ce,handleTagManagerSave:function(e,t){le.value&&le.value(e,t),Ce()},iconSelectDialog:ie,openIconSelectDialog:function(e,t){ie.props={...e},ce.value=t.onSelect,ie.visible=!0},closeIconSelectDialog:se,handleIconSelect:function(e){ce.value&&ce.value(e),se()},divinationOverlay:ue,openDivinationOverlay:function(e){ue.result=e,ue.visible=!0},closeDivinationOverlay:function(){ue.visible=!1},promptEditorDialog:de,openPromptEditorDialog:function(e){de.props.prompt=e,de.visible=!0},closePromptEditorDialog:function(){de.visible=!1},initDivinationSystem:async function(){const e=ua();e.isLoaded||(e.loadConfig(),await e.loadFromWorldbook())},openDivinationSettingsDialog:()=>{ye('divination')}}});function Ba(){const e='shujuku_v80_allSettings_v2';if(localStorage.getItem(e))return e;const t='shujuku_v70_allSettings_v2';if(localStorage.getItem(t))return t;return Object.keys(localStorage||{}).find(e=>/^shujuku_.*_allSettings_v2$/.test(e))||e}function Sa(){try{const e=Ba(),t=localStorage.getItem(e);return t?JSON.parse(t):{}}catch(e){return console.warn('[ACU] 读取 localStorage 设置失败:',e),{}}}function Ta(e){try{const t=Ba(),a=Sa();localStorage.setItem(t,JSON.stringify({...a,...e}))}catch(e){console.warn('[ACU] 写入 localStorage 设置失败:',e)}}function Da(){const e=(0,p.ref)({}),t=(0,p.ref)(!1),a=(0,p.ref)(!1);async function o(t){try{const a=xt().getDB(),o={...e.value,...t};return a&&'function'==typeof a.updateSettings?(await a.updateSettings(o),e.value=o,console.info('[ACU] 通过 API 保存设置成功'),!0):(Ta(o),e.value=o,console.info('[ACU] 通过 localStorage 保存设置'),!0)}catch(a){console.error('[ACU] 保存设置失败:',a);try{return Ta({...e.value,...t}),e.value={...e.value,...t},!0}catch{return!1}}}async function n(){try{const e=xt().getDB();if(!e)return console.warn('[ACU] 数据库 API 不可用'),!1;if('function'==typeof e.manualUpdate)return await e.manualUpdate(),console.info('[ACU] 手动更新执行成功 (manualUpdate)'),!0;if('function'==typeof e.triggerUpdate){const t=await e.triggerUpdate();return console.info('[ACU] 手动更新执行成功 (triggerUpdate):',t),!!t}return console.warn('[ACU] 没有可用的更新方法'),!1}catch(e){return console.error('[ACU] 手动更新失败:',e),!1}}return{settings:e,isLoading:t,isInitialized:a,loadSettings:async function(){t.value=!0;try{const t=xt().getDB();if(t&&'function'==typeof t.getSettings){const a=await t.getSettings();if(a&&'object'==typeof a)return e.value=a,console.info('[ACU] 从 API 读取设置成功'),a}const a=Sa();return e.value=a,console.info('[ACU] 从 localStorage 读取设置'),a}catch(t){console.error('[ACU] 读取设置失败:',t);const a=Sa();return e.value=a,a}finally{t.value=!1,a.value=!0}},saveSettings:o,updateSetting:async function(e,t){await o({[e]:t})},executeManualUpdate:n,getTableList:function(){try{const e=xt().getDB();if(!e)return console.warn('[ACU] 数据库 API 不可用'),[];if('function'==typeof e.getTableList){const t=e.getTableList();return console.info('[ACU] 获取表格列表成功:',t?.length||0),t||[]}if('function'==typeof e.exportTableAsJson){const t=e.exportTableAsJson();if(t&&'object'==typeof t){const e=[];return Object.keys(t).forEach(a=>{if(!a.startsWith('sheet_'))return;const o=t[a],n=o?.name||a,r=n.includes('总结')||n.includes('大纲')||n.toLowerCase().includes('summary')||n.toLowerCase().includes('outline');e.push({key:a,name:n,isSummaryOrOutline:r})}),console.info('[ACU] 从 exportTableAsJson 解析表格列表:',e.length),e}}return console.warn('[ACU] 无法获取表格列表'),[]}catch(e){return console.error('[ACU] 获取表格列表失败:',e),[]}},executeWithPreset:async function(e,t=[],a=!1){try{const r=xt().getDB();if(!r)return{success:!1,message:'数据库 API 不可用'};if('function'==typeof r.executeWithPreset){const o=await r.executeWithPreset({settings:{autoUpdateThreshold:e.autoUpdateThreshold,updateBatchSize:e.updateBatchSize,skipUpdateFloors:e.skipUpdateFloors,autoUpdateFrequency:e.autoUpdateFrequency},targetTableNames:t.length>0?t:null,silent:a});return console.info('[ACU] executeWithPreset 结果:',o),o}console.info('[ACU] 回退到旧方式: saveSettings + executeManualUpdate'),await o(e);const l=await n();return{success:l,message:l?'更新成功':'更新失败'}}catch(e){return console.error('[ACU] 预设执行失败:',e),{success:!1,message:String(e)}}},findDatabaseSettingsKey:Ba}}var Aa=d(162);const za=z,Ia=za.z.object({autoUpdateThreshold:za.z.number().min(1).max(500).default(3),updateBatchSize:za.z.number().min(1).max(50).default(3),skipUpdateFloors:za.z.number().min(0).max(20).default(0),autoUpdateFrequency:za.z.number().min(1).max(100).default(1)}),_a=za.z.object({enabled:za.z.boolean().default(!1),onEmptyCell:za.z.boolean().default(!0),onIndexGap:za.z.boolean().default(!0),targetTables:za.z.array(za.z.string()).default(['总结表','大纲表']),updateTargetTables:za.z.array(za.z.string()).default([]),emptyCheckColumns:za.z.array(za.z.string()).default([])}),Ua=za.z.object({id:za.z.string(),name:za.z.string().min(1).max(50),createdAt:za.z.number(),settings:Ia,autoTrigger:_a.optional().transform(e=>_a.parse(e??{}))}),Ma=za.z.object({presets:za.z.array(Ua).default([]),activePresetId:za.z.string().nullable().default(null),autoFixPresetId:za.z.string().nullable().default(null),globalAutoTriggerEnabled:za.z.boolean().default(!1),globalAutoExecuteEnabled:za.z.boolean().default(!1)}),La='acu-visualizer',$a='updatePresets',Pa={autoUpdateThreshold:3,updateBatchSize:3,skipUpdateFloors:0,autoUpdateFrequency:1},Fa={enabled:!1,onEmptyCell:!0,onIndexGap:!0,targetTables:['总结表','大纲表'],updateTargetTables:[]};function ja(){try{if('function'==typeof getVariables)return getVariables({type:'script',script_id:La})||{}}catch(e){console.warn('[ACU Presets] getVariables 不可用，使用 localStorage 回退')}try{const e=localStorage.getItem(`acu_${$a}`);return e?JSON.parse(e):{}}catch{return{}}}function Ra(){const e=(0,p.ref)({presets:[],activePresetId:null,autoFixPresetId:null,globalAutoTriggerEnabled:!1,globalAutoExecuteEnabled:!1}),t=(0,p.ref)(!1),a=(0,p.computed)(()=>e.value.presets),n=(0,p.computed)(()=>{const t=e.value.activePresetId;return t&&e.value.presets.find(e=>e.id===t)||null}),r=(0,p.computed)(()=>{const t=e.value.autoFixPresetId;return t&&e.value.presets.find(e=>e.id===t)||null}),l=(0,p.computed)(()=>e.value.presets.length>0);function i(){try{const a=ja()[$a];if(a){const t=Ma.safeParse(a);t.success?(e.value=t.data,console.info('[ACU Presets] 加载预设成功，数量:',t.data.presets.length)):(console.warn('[ACU Presets] 预设数据格式无效，使用默认值'),e.value=Ma.parse({}))}else e.value=Ma.parse({});t.value=!0}catch(a){console.error('[ACU Presets] 加载预设失败:',a),e.value=Ma.parse({}),t.value=!0}}function c(){try{const t=ja();t[$a]=o(e.value),function(e){try{if('function'==typeof replaceVariables)return void replaceVariables(o(e),{type:'script',script_id:La})}catch(e){console.warn('[ACU Presets] replaceVariables 不可用，使用 localStorage 回退')}try{localStorage.setItem(`acu_${$a}`,JSON.stringify(e))}catch(e){console.error('[ACU Presets] 保存到 localStorage 失败:',e)}}(t),console.info('[ACU Presets] 保存预设成功')}catch(e){console.error('[ACU Presets] 保存预设失败:',e)}}function s(t){const a=t.trim();return e.value.presets.find(e=>e.name.trim()===a)||null}function u(t,a={},o={}){const n={id:`preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t,createdAt:Date.now(),settings:Ia.parse({...Pa,...a}),autoTrigger:_a.parse({...Fa,...o})};return e.value.presets.push(n),c(),console.info('[ACU Presets] 创建预设:',n.name),n}function d(t,a){const o=e.value.presets.findIndex(e=>e.id===t);if(-1===o)return console.warn('[ACU Presets] 预设不存在:',t),!1;const n=e.value.presets[o];return void 0!==a.name&&(n.name=a.name),void 0!==a.settings&&(n.settings=Ia.parse({...n.settings,...a.settings})),void 0!==a.autoTrigger&&(n.autoTrigger=_a.parse({...n.autoTrigger,...a.autoTrigger})),c(),console.info('[ACU Presets] 更新预设:',n.name),!0}const m=(0,p.computed)(()=>e.value.globalAutoTriggerEnabled),f=(0,p.computed)(()=>e.value.globalAutoExecuteEnabled);return t.value||i(),{storage:e,presets:a,activePreset:n,autoFixPreset:r,hasPresets:l,isLoaded:t,globalAutoTriggerEnabled:m,globalAutoExecuteEnabled:f,loadPresets:i,savePresets:c,createPreset:u,createOrUpdatePreset:function(e,t={},a={}){const o=s(e);return o?(d(o.id,{settings:Ia.parse({...Pa,...t}),autoTrigger:_a.parse({...Fa,...a})}),console.info('[ACU Presets] 更新预设:',e),{preset:o,isNew:!1}):{preset:u(e,t,a),isNew:!0}},findPresetByName:s,updatePreset:d,deletePreset:function(t){const a=e.value.presets.findIndex(e=>e.id===t);if(-1===a)return console.warn('[ACU Presets] 预设不存在:',t),!1;const o=e.value.presets[a];return e.value.presets.splice(a,1),e.value.activePresetId===t&&(e.value.activePresetId=null),e.value.autoFixPresetId===t&&(e.value.autoFixPresetId=null),c(),console.info('[ACU Presets] 删除预设:',o.name),!0},setActivePreset:function(t){e.value.activePresetId=t,c()},setAutoFixPreset:function(t){e.value.autoFixPresetId=t,c()},duplicatePreset:function(t,a){const n=e.value.presets.find(e=>e.id===t);return n?u(a||`${n.name} (副本)`,o(n.settings),o(n.autoTrigger)):(console.warn('[ACU Presets] 源预设不存在:',t),null)},createFromCurrent:function(e,t){return u(e,t)},getPresetSettings:function(t){const a=e.value.presets.find(e=>e.id===t);return a?o(a.settings):null},setGlobalAutoTrigger:function(t){e.value.globalAutoTriggerEnabled=t,t||(e.value.globalAutoExecuteEnabled=!1),c(),console.info('[ACU Presets] 全局问题检测提示:',t)},setGlobalAutoExecute:function(t){e.value.globalAutoExecuteEnabled=t,c(),console.info('[ACU Presets] 全局自动执行修复:',t)},UpdateSettingsSchema:Ia,AutoTriggerConfigSchema:_a,UpdatePresetSchema:Ua}}let Oa=null,Ha=null,Wa=!1;function Ga(){const e=ea(),t=Ea(),a=Ra(),o=Da();let n=0;let r=!1;function l(e,t){if(!e&&!t)return!1;if(!e||!t)return!0;if(e.length!==t.length)return!0;for(let a=0;a<e.length;a++){const o=String(e[a]??'').trim(),n=String(t[a]??'').trim();if(('null'===o||'undefined'===o?'':o)!==('null'===n||'undefined'===n?'':n))return!0}return!1}async function i(e,t){const a=function(){try{const e=window.SillyTavern||window.parent?.SillyTavern||window.top?.SillyTavern;if(e?.getCurrentChatId){const t=e.getCurrentChatId();if(t)return t}if(e?.chat_metadata?.chat_id)return String(e.chat_metadata.chat_id)}catch(e){console.warn('[ACU] 获取 chatId 失败:',e)}return'default'}();if(!a)return void console.warn('[ACU] 无法获取 chatId，跳过 AI 变更历史保存');let o=0;for(const n in t){if(!n.startsWith('sheet_'))continue;const r=t[n],i=e[n];if(!r?.content||!Array.isArray(r.content))continue;const c=r.name||n.replace('sheet_',''),s=r.content[0]||[];for(let e=1;e<r.content.length;e++){const t=e-1,n=r.content[e],u=i?.content?.[e];if(l(u,n)&&u&&Array.isArray(u)){const e={index:t,key:`${c}-row-${t}`,cells:u.map((e,t)=>({colIndex:t,key:String(s[t]||`col_${t}`),value:String(e??'')}))};try{await Ht(a,c,e,'ai'),o++}catch(e){console.warn('[ACU] 保存 AI 变更历史失败:',e)}}}}o>0&&console.info(`[ACU] 已保存 ${o} 行 AI 变更历史记录`)}function c(){const{getDB:o}=xt(),n=o();n?(Wa=!1,n.registerTableUpdateCallback&&(Oa=async()=>{if(Wa)return;if(t.isEditingOrder||e.isSaving)return;const o=e.snapshot,n=yt();if(n){o&&await i(o,n),e.setStagedData(n);const r=Object.keys(n).filter(e=>e.startsWith('sheet_'));t.syncNewTablesToVisibleTabs(r),e.generateDiffMap(n),a.globalAutoTriggerEnabled.value?(e.checkIntegrity(n),u()):e.clearIntegrityIssues()}},n.registerTableUpdateCallback(Oa),console.info('[ACU] 已注册表格更新回调')),n.registerTableFillStartCallback&&(Ha=()=>{if(Wa)return;if(e.saveLastState(),e.diffMap&&e.diffMap.size>0)return void console.info('[ACU] 累积高亮：保留旧快照');const t=yt();t&&Object.keys(t).length>0&&(e.saveSnapshot(t),console.info('[ACU] 快照已更新'))},n.registerTableFillStartCallback(Ha),console.info('[ACU] 已注册表格填充回调 (高亮逻辑)'))):console.warn('[ACU] 数据库 API 未就绪，跳过回调注册')}function s(){Wa=!0;const{getDB:e}=xt(),t=e();if(t)try{t.registerTableUpdateCallback&&Oa&&('function'==typeof t.unregisterTableUpdateCallback&&t.unregisterTableUpdateCallback(Oa),Oa=null,console.info('[ACU] 已注销表格更新回调')),t.registerTableFillStartCallback&&Ha&&('function'==typeof t.unregisterTableFillStartCallback&&t.unregisterTableFillStartCallback(Ha),Ha=null,console.info('[ACU] 已注销表格填充回调'))}catch(e){console.warn('[ACU] 注销回调时出错:',e)}}async function u(){if(!a.globalAutoTriggerEnabled.value)return;if(!e.hasIntegrityIssues)return;const t=Date.now();if(t-n<3e4)return;if(r)return;const l=a.autoFixPreset.value;if(l&&l.autoTrigger.enabled){let a=!1;const i=e.problematicTables;if(i&&i.length>0&&(a=!0),a){n=t;const a=e.getIntegritySummary();r=!0,Aa.toast.info(`🔧 检测到问题：${a}，正在自动修复...`),console.info('[ACU] 自动触发修复:',a);try{const e=l.autoTrigger.updateTargetTables||[],t=await o.executeWithPreset({autoUpdateThreshold:l.settings.autoUpdateThreshold,autoUpdateFrequency:l.settings.autoUpdateFrequency,updateBatchSize:l.settings.updateBatchSize,skipUpdateFloors:l.settings.skipUpdateFloors},e);t.success?Aa.toast.success('✅ 自动修复已完成'):Aa.toast.warning('⚠️ 自动修复失败：'+(t.message||'请手动更新'))}catch(e){console.error('[ACU] 自动修复失败:',e),Aa.toast.error('❌ 自动修复出错')}finally{r=!1}}}}return(0,p.onMounted)(()=>{c()}),(0,p.onUnmounted)(()=>{s()}),{registerCallbacks:c,unregisterCallbacks:s,checkAndNotifyIssues:u}}function Ya(e){const t=Object.keys(e),a=t.find(e=>e.match(/^shujuku_v\d+_allSettings_v2$/)&&parseInt(e.match(/v(\d+)/)?.[1]||'0')>=100);if(a)return a;const o=t.find(e=>e.match(/^shujuku_v\d+_allSettings_v2$/));return o||null}function Xa(e){const t=e.match(/shujuku_v?(\d+)/i);return t?parseInt(t[1],10):0}function Ka(){const e=window.parent||window;try{const t=e.SillyTavern?.getContext?.(),a=t?.extensionSettings?.__userscripts;if(a){const e=function(e,t){const a=e.filter(e=>t.test(e));return 0===a.length?null:(a.sort((e,t)=>Xa(t)-Xa(e)),a[0])}(Object.keys(a),/shujuku_v\d+__userscript_settings_v1/i);if(e&&a[e]){const t=a[e],o='string'==typeof t?JSON.parse(t):t,n=`${e.replace(/__userscript_settings_v1$/i,'')}_globalMeta_v1`;if(o[n]){const e=o[n],t='string'==typeof e?JSON.parse(e):e,a=String(t.activeIsolationCode||'');return a&&console.info(`[ACU] 使用隔离标签: "${a}" (from extensionSettings)`),a}}}let o=window.localStorage,n=Ya(o);if(!n&&window.parent)try{o=window.parent.localStorage,n=Ya(o)}catch{}if(n){const e=o.getItem(n);if(e){const t=JSON.parse(e);if(t.dataIsolationEnabled&&t.dataIsolationCode)return console.info(`[ACU] 使用隔离标签: "${t.dataIsolationCode}" (from localStorage: ${n})`),t.dataIsolationCode}}}catch(e){console.warn('[ACU] 读取隔离配置失败:',e)}return''}const qa='TavernDB_ACU_InternalSheetGuide',Ja='orderNo';const Za=['acu_table_order','acu_reverse_tables','acu_table_heights','acu_active_tab','acu_ui_collapse','acu_pin','acu_table_styles','acu_win_config'];function Qa(){const e=ea(),t=Ve();async function a(t,a,n=-1){const l=o(t);if(a&&e.pendingDeletes.size>0)for(const t in l){if('mate'===t)continue;const a=l[t];if(!a||!a.name||!a.content)continue;const o=[a.content[0]];for(let t=1;t<a.content.length;t++){const n=t-1;e.pendingDeletes.has(`${a.name}-row-${n}`)||o.push(a.content[t])}a.content=o}try{let e=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);!e&&window.top&&window.top.SillyTavern&&(e=window.top.SillyTavern);const t=Ka();if(e&&e.chat&&e.chat.length>0){let a=null,i=-1;if(n>=0&&n<e.chat.length)i=n,a=e.chat[i];else{for(let t=e.chat.length-1;t>=0;t--)if(!e.chat[t].is_user&&e.chat[t].TavernDB_ACU_IsolatedData){i=t,a=e.chat[t];break}if(!a)for(let t=e.chat.length-1;t>=0;t--)if(!e.chat[t].is_user){i=t,a=e.chat[t];break}}if(a){let n=t;if(a.TavernDB_ACU_IsolatedData){const e=Object.keys(a.TavernDB_ACU_IsolatedData);e.length>0&&(n=e[0])}else a.TavernDB_ACU_IsolatedData={};a.TavernDB_ACU_IsolatedData[n]||(a.TavernDB_ACU_IsolatedData[n]={independentData:{},modifiedKeys:[],updateGroupKeys:[]});const c=a.TavernDB_ACU_IsolatedData[n];c.independentData||(c.independentData={});const s=Object.keys(l).filter(e=>e.startsWith('sheet_'));s.forEach(e=>{c.independentData[e]=o(l[e])});const u=c.modifiedKeys||[];if(c.modifiedKeys=[...new Set([...u,...s])],s.length>0){const t=function(e){const t={mate:{type:'chatSheets',version:1}};return Object.keys(e).forEach(a=>{if(!a.startsWith('sheet_'))return;const o=e[a];if(!o||'object'!=typeof o)return;const n=o.content,r=Array.isArray(n)&&Array.isArray(n[0])?n[0]:[null];t[a]={uid:o.uid||a,name:o.name||a,sourceData:o.sourceData||{note:'',initNode:'',insertNode:'',updateNode:'',deleteNode:''},content:[r],updateConfig:o.updateConfig||{uiSentinel:-1,contextDepth:-1,updateFrequency:-1,batchSize:-1,skipFloors:-1},exportConfig:o.exportConfig||{enabled:!1,splitByRow:!1,entryName:o.name||a,entryType:'constant',keywords:'',preventRecursion:!0,injectionTemplate:''},[Ja]:o[Ja]??void 0}}),t}(l);Object.keys(t).some(e=>e.startsWith('sheet_'))&&function(e,t,a){if(!e?.chat||0===e.chat.length)return console.info('[ACU] 无法更新指导表：聊天记录为空'),!1;const o=e.chat[0];if(!o)return console.info('[ACU] 无法更新指导表：chat[0] 不存在'),!1;try{let e=null;const n=o[qa];if(n)if('string'==typeof n)try{e=JSON.parse(n)}catch{e=null}else'object'==typeof n&&(e=n);return e&&'object'==typeof e||(e={version:1,tags:{}}),e.tags&&'object'==typeof e.tags||(e.tags={}),e.version=1,e.tags[t]={data:a,updatedAt:Date.now(),reason:'vue_visualizer_save'},o[qa]=e,console.info(`[ACU] 已更新 chat[0] 指导表 (tag=${t||'无标签'}, tables=${Object.keys(a).filter(e=>e.startsWith('sheet_')).length})`),!0}catch(e){return console.warn('[ACU] 更新指导表失败:',e),!1}}(e,n,t)}if(e.saveChat)return await e.saveChat(),await r(),{...l,_savedToFloor:i}}}}catch(e){throw console.error('[ACU] Core save error:',e),e}return await r(),l}function n(e,t,a){if(!e||!e.chat)return-1;for(let o=e.chat.length-1;o>=0;o--){const n=e.chat[o];if(!n.is_user){if(n.TavernDB_ACU_IsolatedData&&'object'==typeof n.TavernDB_ACU_IsolatedData){const e=n.TavernDB_ACU_IsolatedData[a];if(e&&e.independentData&&e.independentData[t])return o;if(!a&&n.TavernDB_ACU_IsolatedData['']&&n.TavernDB_ACU_IsolatedData[''].independentData&&n.TavernDB_ACU_IsolatedData[''].independentData[t])return o}if(n.TavernDB_ACU_IndependentData&&n.TavernDB_ACU_IndependentData[t]){if(a&&n.TavernDB_ACU_Identity&&n.TavernDB_ACU_Identity!==a)continue;return o}}}return-1}async function r(){const e=xt().getDB();if(e&&e.syncWorldbookEntries)try{await e.syncWorldbookEntries({createIfNeeded:!0})}catch(e){console.warn('[ACU] Worldbook sync failed after save:',e)}else console.warn('[ACU] syncWorldbookEntries API not found, skipping sync.')}let l=null;function i(a=5e3){l&&(l(),l=null),l=function(e,t,a={}){const{debounce:o=0,maxWait:n,...r}=a;return D(e,t,{...r,eventFilter:C(o,{maxWait:n})})}(()=>e.tables,async()=>{if(e.hasChanges&&t.config.autoSave)try{console.info('[ACU] 自动保存触发...'),await e.saveToDatabase(),console.info('[ACU] 自动保存完成')}catch(e){console.error('[ACU] 自动保存失败:',e)}},{debounce:a,deep:!0}),console.info(`[ACU] 自动保存已启用，防抖延迟: ${a}ms`)}function c(){console.info('[ACU] 检查旧版本数据...');let e=!1;Za.forEach(t=>{try{const a=localStorage.getItem(t);if(a){console.info(`[ACU] 发现旧版本数据: ${t}`),e=!0;try{const e=JSON.parse(a),t=Array.isArray(e)?'array':typeof e;console.info(`[ACU]   - 数据类型: ${t}`)}catch{console.info('[ACU]   - 数据类型: string')}}}catch(e){console.warn(`[ACU] 读取 ${t} 失败:`,e)}});try{localStorage.getItem('acu_v5_isolation_settings')&&(console.info('[ACU] 发现 V5 隔离设置数据'),e=!0)}catch{}e||console.info('[ACU] 未发现旧版本数据')}return{saveToDatabase:async function(t=null,l=!1,i=!1,c=-1){if(e.isSaving)return console.warn('[ACU] Save already in progress'),!1;let s=e.getStagedData();if(s||(s=t||yt()),!s)return console.warn('[ACU] 无数据可保存'),!1;const{$}=xt(),u=$?.('#acu-btn-save-global, #acu-parent-container #acu-btn-save-global');let d='';try{e.isSaving=!0,!l&&u?.length&&(d=u.html(),u.html('<i class="fa-solid fa-spinner fa-spin"></i>').prop('disabled',!0));let t=null;if(c>=0)console.info('[ACU] 执行全量保存 (另存为模式)...'),t=await a(s,i,c);else{console.info('[ACU] 执行增量保存 (默认模式)...');const a=e.getModifiedTableIds();if(0===a.length)return console.info('[ACU] 无变更，跳过保存'),!0;t=await async function(t,a,l){if(0===l.length)return null;console.info('[ACU] 开始增量保存，涉及表格:',l);const i=o(t);if(a&&e.pendingDeletes.size>0)for(const t of l){if('mate'===t)continue;const a=i[t];if(!a||!a.name||!a.content)continue;const o=[a.content[0]];let n=!1;for(let t=1;t<a.content.length;t++){const r=t-1;e.pendingDeletes.has(`${a.name}-row-${r}`)?n=!0:o.push(a.content[t])}n&&(a.content=o)}try{let e=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);!e&&window.top&&window.top.SillyTavern&&(e=window.top.SillyTavern);const t=Ka(),a=new Map,c=new Set;for(const o of l){const r=n(e,o,t);-1!==r?(a.has(r)||a.set(r,new Set),a.get(r).add(o)):c.add(o)}if(c.size>0){let t=-1;for(let a=e.chat.length-1;a>=0;a--)if(!e.chat[a].is_user&&e.chat[a].TavernDB_ACU_IsolatedData){t=a;break}if(-1===t)for(let a=e.chat.length-1;a>=0;a--)if(!e.chat[a].is_user){t=a;break}-1!==t?(a.has(t)||a.set(t,new Set),c.forEach(e=>a.get(t).add(e)),console.info(`[ACU] 新增表格 ${Array.from(c).join(', ')} 将存入楼层 ${t}`)):console.warn('[ACU] 无法找到任何 AI 楼层来存放新表格')}let s=!1;for(const[n,r]of a.entries()){const a=e.chat[n];if(!a)continue;let l=a.TavernDB_ACU_IsolatedData;if('string'==typeof l)try{l=JSON.parse(l)}catch{l={}}l&&'object'==typeof l||(l={});const c=t||'';l[c]||(l[c]={independentData:{},modifiedKeys:[],updateGroupKeys:[]});const u=l[c];u.independentData||(u.independentData={});const d=Array.from(r);d.forEach(e=>{i[e]&&(u.independentData[e]=o(i[e]))});const p=u.modifiedKeys||[];u.modifiedKeys=[...new Set([...p,...d])],a.TavernDB_ACU_IsolatedData=l,t&&(a.TavernDB_ACU_Identity=t),a.TavernDB_ACU_IndependentData=u.independentData,a.TavernDB_ACU_ModifiedKeys=u.modifiedKeys,a.TavernDB_ACU_UpdateGroupKeys=u.updateGroupKeys,s=!0,console.info(`[ACU] 已更新楼层 ${n}，涉及表格: ${d.join(', ')}`)}if(s&&e.saveChat)return await e.saveChat(),await r(),i}catch(e){throw console.error('[ACU] Incremental save error:',e),e}return await r(),i}(s,i,a)}if(!l){const a=t?._savedToFloor;void 0!==a?Aa.toast.success(`已更新至第 ${a} 层 (覆盖旧数据)`):t&&Aa.toast.success('保存成功');$(window.parent?.document||document).find('.acu-highlight-changed').removeClass('acu-highlight-changed'),u?.removeClass('acu-save-alert'),e.clearChanges(i),e.stagedData=null,t&&e.saveSnapshot(t)}return await r(),!0}catch(e){return console.error('[ACU] Save failed:',e),l||Aa.toast.error('保存失败: '+e.message),!1}finally{setTimeout(()=>{e.isSaving=!1,!l&&u?.length&&u.html(d||'<i class="fa-solid fa-save"></i>').prop('disabled',!1)},100)}},syncWorldbook:r,saveSnapshot:function(t){e.saveSnapshot(t)},loadSnapshot:function(){return e.loadSnapshot()},clearSnapshot:function(){e.clearSnapshot()},purgeFloorRange:async function(t,a){if(e.isSaving)return;let o=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);if(!o&&window.top&&window.top.SillyTavern&&(o=window.top.SillyTavern),!o||!o.chat)return void Aa.toast.error('无法连接到 SillyTavern 核心数据');const n=o.chat.length-1;if(t=Math.max(0,t),a=Math.min(n,a),isNaN(t)||isNaN(a)||t>a)Aa.toast.warning('无效的楼层范围');else{e.isSaving=!0;try{console.log(`[ACU-Purge] 开始强力清洗楼层范围: ${t} - ${a}`);let n=0;const l=['TavernDB_ACU_Data','TavernDB_ACU_SummaryData','TavernDB_ACU_IndependentData','TavernDB_ACU_Identity','TavernDB_ACU_IsolatedData','TavernDB_ACU_ModifiedKeys','TavernDB_ACU_UpdateGroupKeys'];for(let e=t;e<=a;e++){const t=o.chat[e];if(!t)continue;let a=!1;for(const e of l)Object.prototype.hasOwnProperty.call(t,e)&&(delete t[e],a=!0);a&&n++}if(n>0){o.saveChat&&await o.saveChat(),await r();const t=yt();t?e.saveSnapshot(t):e.clearSnapshot(),e.clearChanges(!0),Aa.toast.success(`已强力清除 ${n} 个楼层的数据`)}else Aa.toast.info('指定范围内没有可清除的数据')}catch(e){console.error('[ACU] Purge Error:',e),Aa.toast.error('清除失败: '+e.message)}finally{e.isSaving=!1}}},purgeTableDataByRange:async function(t,a,o){const n=Array.isArray(t)?[...new Set(t.filter(e=>'string'==typeof e&&e.startsWith('sheet_')))]:[];if(0===n.length)return{changed:!1,changedCount:0};let l=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);if(!l&&window.top&&window.top.SillyTavern&&(l=window.top.SillyTavern),!l?.chat||0===l.chat.length)return Aa.toast.error('无法连接到 SillyTavern 核心数据'),{changed:!1,changedCount:0};const i=l.chat.length-1;if(a=Math.max(0,a),o=Math.min(i,o),isNaN(a)||isNaN(o)||a>o)return Aa.toast.warning('无效的楼层范围'),{changed:!1,changedCount:0};if(e.isSaving)return Aa.toast.warning('保存操作进行中，请稍后再试'),{changed:!1,changedCount:0};e.isSaving=!0;const c=(e,t)=>{if(!Array.isArray(e)||0===e.length)return{arr:e,changed:!1};const a=e.filter(e=>e!==t);return{arr:a,changed:a.length!==e.length}};try{console.info(`[ACU-AdvancedPurge] 开始清除表格 [${n.join(', ')}] 在楼层 ${a}-${o} 的数据`);let t=!1,i=0;for(let e=a;e<=o;e++){const a=l.chat[e];if(!a||a.is_user)continue;let o=!1;a.TavernDB_ACU_IsolatedData&&'object'==typeof a.TavernDB_ACU_IsolatedData&&(Object.keys(a.TavernDB_ACU_IsolatedData).forEach(e=>{const t=a.TavernDB_ACU_IsolatedData[e];t&&'object'==typeof t&&(t.independentData&&'object'==typeof t.independentData&&n.forEach(e=>{t.independentData[e]&&(delete t.independentData[e],o=!0)}),Array.isArray(t.modifiedKeys)&&n.forEach(e=>{const a=c(t.modifiedKeys,e);a.changed&&(t.modifiedKeys=a.arr,o=!0)}),Array.isArray(t.updateGroupKeys)&&n.forEach(e=>{const a=c(t.updateGroupKeys,e);a.changed&&(t.updateGroupKeys=a.arr,o=!0)}),!t.independentData||0!==Object.keys(t.independentData).length||t.modifiedKeys&&0!==t.modifiedKeys.length||t.updateGroupKeys&&0!==t.updateGroupKeys.length||(delete a.TavernDB_ACU_IsolatedData[e],o=!0))}),0===Object.keys(a.TavernDB_ACU_IsolatedData).length&&(delete a.TavernDB_ACU_IsolatedData,o=!0)),a.TavernDB_ACU_IndependentData&&'object'==typeof a.TavernDB_ACU_IndependentData&&n.forEach(e=>{a.TavernDB_ACU_IndependentData[e]&&(delete a.TavernDB_ACU_IndependentData[e],o=!0)}),Array.isArray(a.TavernDB_ACU_ModifiedKeys)&&n.forEach(e=>{const t=c(a.TavernDB_ACU_ModifiedKeys,e);t.changed&&(a.TavernDB_ACU_ModifiedKeys=t.arr,o=!0)}),Array.isArray(a.TavernDB_ACU_UpdateGroupKeys)&&n.forEach(e=>{const t=c(a.TavernDB_ACU_UpdateGroupKeys,e);t.changed&&(a.TavernDB_ACU_UpdateGroupKeys=t.arr,o=!0)}),a.TavernDB_ACU_Data&&'object'==typeof a.TavernDB_ACU_Data&&n.forEach(e=>{a.TavernDB_ACU_Data[e]&&(delete a.TavernDB_ACU_Data[e],o=!0)}),a.TavernDB_ACU_SummaryData&&'object'==typeof a.TavernDB_ACU_SummaryData&&n.forEach(e=>{a.TavernDB_ACU_SummaryData[e]&&(delete a.TavernDB_ACU_SummaryData[e],o=!0)}),o&&(t=!0,i++)}if(t){l.saveChat&&await l.saveChat(),await r();const t=yt();t?e.saveSnapshot(t):e.clearSnapshot(),e.clearChanges(!0),console.info(`[ACU-AdvancedPurge] 清除完成，影响 ${i} 个楼层`)}return{changed:t,changedCount:i}}catch(e){throw console.error('[ACU-AdvancedPurge] 清除失败:',e),e}finally{e.isSaving=!1}},setupAutoSave:i,stopAutoSave:function(){l&&(l(),l=null,console.info('[ACU] 自动保存已停止'))},migrateLegacyData:c,initDataPersistence:async function(){console.info('[ACU] 初始化数据持久化...'),c(),await e.loadFromDatabase(),t.config.autoSave&&i(t.config.autoSaveDelay||5e3),console.info('[ACU] 数据持久化初始化完成')},getTableData:yt,dataStore:e}}void 0===window.__acu_hidden_prompt&&(window.__acu_hidden_prompt='');const eo=[];let to=!1;function ao(e){window.__acu_hidden_prompt=e,console.info('[ACU] 隐藏提示词已设置:',e.substring(0,50))}function oo(){return window.__acu_hidden_prompt||''}function no(){ro();const e=window.parent.document,t=e.getElementById('send_textarea'),a=e.getElementById('send_but');if(!t||!a)return console.warn('[ACU] 未找到输入框或发送按钮，1秒后重试'),void setTimeout(no,1e3);const o=e=>{(async e=>{if(to)return;const o=oo();if(o.trim()){e.preventDefault(),e.stopImmediatePropagation(),to=!0;try{const e=t.value.trim(),n=`${o}`,r=e?`${n}\n${e}`:n;console.info('[ACU] 拼接消息:',r.substring(0,80));const l=window.parent;if(!l.TavernHelper||!l.TavernHelper.triggerSlash)throw console.error('[ACU] TavernHelper.triggerSlash 不可用'),new Error('TavernHelper API unavailable');await l.TavernHelper.triggerSlash(`/send as=user ${r}`),console.info('[ACU] ✓ 用户消息已创建'),t.value='',t.dispatchEvent(new Event('input',{bubbles:!0})),await new Promise(e=>setTimeout(e,50)),a.click(),console.info('[ACU] ✓ 已触发生成')}catch(e){console.error('[ACU] 发送失败:',e),Aa.toast.error('隐藏提示词发送失败')}finally{setTimeout(()=>{to=!1},100)}}})(e)};a.addEventListener('click',o,{capture:!0}),eo.push(()=>a.removeEventListener('click',o,{capture:!0}));const n=e=>{if('Enter'===e.key&&!e.shiftKey){if(!oo().trim())return;e.preventDefault(),e.stopImmediatePropagation(),a.click()}};t.addEventListener('keydown',n,{capture:!0}),eo.push(()=>t.removeEventListener('keydown',n,{capture:!0})),console.info('[ACU] 发送拦截已设置')}function ro(){eo.forEach(e=>e()),eo.length=0}function lo(e,t='\n'){const a=window.parent.document.getElementById('send_textarea'),o=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(a){const n=a.value||'',r=n?n+t+e:e;a.value=r,a.dispatchEvent(new Event('input',{bubbles:!0})),o||(a.focus(),a.setSelectionRange(r.length,r.length)),console.info('[ACU] 提示词已追加到输入框')}else console.warn('[ACU] 未找到输入框 #send_textarea')}function io(){return{setHiddenPrompt:ao,getHiddenPrompt:oo,setupSendIntercept:no,cleanupSendIntercept:ro,appendPromptToInput:lo}}function co(){const{saveToDatabase:e,getTableData:t,saveSnapshot:a,loadSnapshot:o}=Qa(),n=ea();return{insertRow:async(a,o)=>{let r=n.getStagedData();if(r||(r=t()),!r)return console.warn('[ACU insertRow] 无法获取数据'),void Aa.toast.error('无法获取数据');const l=r[a];if(!l?.content)return console.warn('[ACU insertRow] 未找到表格:',a,'可用表格:',Object.keys(r)),void Aa.toast.error('未找到目标表格');const i=l.content,c=i[0]?i[0].length:2,s=new Array(c).fill('');c>0&&(s[0]=String(i.length)),i.splice(o+2,0,s),Aa.toast.info('正在插入新行...'),n.setStagedData(r),n.saveLastState();await e(r,!1,!0)&&Aa.toast.success('新行已插入')},copyContent:e=>{const t=window.parent||window;if(t.TavernHelper&&t.TavernHelper.triggerSlash)try{const a=e.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n');return t.TavernHelper.triggerSlash(`/clipboard-set "${a}"`),void Aa.toast.success('已复制')}catch(e){console.warn('酒馆复制接口失败',e)}const a=document.createElement('textarea');a.value=e,a.style.position='fixed',a.style.left='-9999px',document.body.appendChild(a),a.select();try{document.execCommand('copy'),Aa.toast.success('已复制')}catch(t){prompt('请手动复制:',e)}document.body.removeChild(a)},toggleDelete:(e,t,a)=>{if(!a||!a.length){const{$}=xt();if($){const o=$(window.parent.document).find(`.acu-editable-title[data-tname="${e}"][data-row="${t}"]`);o.length&&(a=o.closest('.acu-data-card'))}}if(!a||!a.find)return void console.warn('[ACU] toggleDelete failed: card element not found',{tableName:e,rowIdx:t});const o=`${e}-row-${t}`;n.isPendingDelete(o)?(n.toggleDelete(o),a.find('.acu-badge-pending').remove(),Aa.toast.success('已取消删除')):(n.toggleDelete(o),0===a.find('.acu-badge-pending').length&&a.append('<div class="acu-badge-pending">待删除</div>'),Aa.toast.warning('整行已标记为删除'))},setInput:e=>{lo(e,' ')},editCell:(e,r,l)=>{const{tableKey:i,rowIdx:c,colIdx:s,$cell:u}=e,{$}=xt(),d=l||document;let p=n.getStagedData();if(p||(p=t()),p||(p=o()),p){const e=p[i];e?.content&&e.content[c+1]&&(e.content[c+1][s]=r,n.setStagedData(p),a(p))}u.attr('data-val',encodeURIComponent(r)),u.data('val',encodeURIComponent(r));let m=u;u.hasClass('acu-grid-item')?m=u.find('.acu-grid-value'):u.hasClass('acu-full-item')&&(m=u.find('.acu-full-value'));const f=function(e){if(!e)return'';const t=String(e);return'True'===t||'Yes'===t||'完成'===t||'已完成'===t?'acu-badge-success':'False'===t||'No'===t||'失败'===t||'未完成'===t?'acu-badge-danger':'进行中'===t||'Doing'===t?'acu-badge-warning':/^\d+%$/.test(t)?'acu-badge-info':/^Lv\.?\d+$/i.test(t)?'acu-badge-primary':''}(r);f&&!u.hasClass('acu-editable-title')?m.html(`<span class="acu-badge ${f}">${r}</span>`):m.text(r),m.addClass('acu-highlight-changed'),u.hasClass('acu-editable-title')&&u.addClass('acu-highlight-changed'),n.updateCell(i,c,s,r);$(d).find('#acu-btn-save-global').addClass('acu-save-alert'),Aa.toast.info('修改已暂存')}}}const so=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;function uo(){if('undefined'!=typeof window){if(window.innerWidth<=768)return!0;if(window.innerWidth>1024)return!1}return so.test(navigator.userAgent)}function po(){const e=(0,p.ref)(uo());if('undefined'!=typeof window){const t=()=>{e.value=uo()};window.addEventListener('resize',t),(0,p.onUnmounted)(()=>{window.removeEventListener('resize',t)})}return{isMobile:e,isTouchDevice:(0,p.computed)(()=>'ontouchstart'in window||navigator.maxTouchPoints>0)}}function mo(e,t={}){const{initialX:a=100,initialY:o=100,edgePadding:n=10,elementWidth:r=50,onPositionChange:l,useParentWindow:i=!1}=t,c=()=>i&&window.parent&&window.parent!==window?window.parent:window,s=()=>{const e=c();return{width:e.innerWidth,height:e.innerHeight}},u=(0,p.ref)(!1);let d=0,m=0;const g=(0,p.computed)(()=>{if(i)try{return c().document}catch{return document}return document}),{x:v,y:b,isDragging:h}=function(e,t={}){var a;const{pointerTypes:o,preventDefault:n,stopPropagation:r,exact:l,onMove:i,onEnd:c,onStart:s,initialValue:u,axis:d='both',draggingElement:m=L,containerElement:g,handle:v=e,buttons:b=[0]}=t,h=(0,p.ref)(null!=(a=(0,p.toValue)(u))?a:{x:0,y:0}),x=(0,p.ref)(),y=e=>!o||o.includes(e.pointerType),w=e=>{(0,p.toValue)(n)&&e.preventDefault(),(0,p.toValue)(r)&&e.stopPropagation()},k=a=>{if((0,p.toValue)(t.disabled)||!y(a))return;if(!x.value)return;const o=(0,p.toValue)(g),n=(0,p.toValue)(e).getBoundingClientRect();let{x:r,y:l}=h.value;'x'!==d&&'both'!==d||(r=a.clientX-x.value.x,o&&(r=Math.min(Math.max(0,r),o.scrollWidth-n.width))),'y'!==d&&'both'!==d||(l=a.clientY-x.value.y,o&&(l=Math.min(Math.max(0,l),o.scrollHeight-n.height))),h.value={x:r,y:l},null==i||i(h.value,a),w(a)},C=e=>{!(0,p.toValue)(t.disabled)&&y(e)&&x.value&&(x.value=void 0,null==c||c(h.value,e),w(e))};if(f){const a=()=>{var e;return{capture:null==(e=t.capture)||e,passive:!(0,p.toValue)(n)}};j(v,'pointerdown',a=>{var o;if(!(0,p.toValue)(b).includes(a.button))return;if((0,p.toValue)(t.disabled)||!y(a))return;if((0,p.toValue)(l)&&a.target!==(0,p.toValue)(e))return;const n=(0,p.toValue)(g),r=null==(o=null==n?void 0:n.getBoundingClientRect)?void 0:o.call(n),i=(0,p.toValue)(e).getBoundingClientRect(),c={x:a.clientX-(n?i.left-r.left+n.scrollLeft:i.left),y:a.clientY-(n?i.top-r.top+n.scrollTop:i.top)};!1!==(null==s?void 0:s(c,a))&&(x.value=c,w(a))},a),j(m,'pointermove',k,a),j(m,'pointerup',C,a)}return{...I(h),position:h,isDragging:(0,p.computed)(()=>!!x.value),style:(0,p.computed)(()=>`left:${h.value.x}px;top:${h.value.y}px;`)}}(e,{initialValue:{x:a,y:o},draggingElement:g,onStart(e,t){u.value=!1,d=t.clientX,m=t.clientY},onMove(e,t){const a=t.clientX,o=t.clientY,n=Math.abs(a-d),r=Math.abs(o-m);(n>5||r>5)&&(u.value=!0)},onEnd(){if(u.value){const{width:e,height:t}=s();v.value<n&&(v.value=n),v.value>e-r-n&&(v.value=e-r-n),b.value<n&&(b.value=n),b.value>t-r-n&&(b.value=t-r-n),l?.(v.value,b.value)}}}),x=(0,p.computed)(()=>({left:`${v.value}px`,top:`${b.value}px`,cursor:h.value?'grabbing':'grab'}));return{x:v,y:b,isDragging:h,wasDragging:u,style:x,reset:()=>{v.value=a,b.value=o,l?.(v.value,b.value)}}}const fo={clearTableOnSwipe:!0};function go(){const e=ea(),t=Ve(),a=(0,p.ref)(!1),o=(0,p.ref)({...fo}),n=[];let r=0,l=0,i=!1;async function c(t){try{return await e.purgeFloorRange(t,t),console.info(`[ACU Swipe] 已清除第 ${t} 楼的表格数据`),!0}catch(e){return console.error('[ACU Swipe] 清除楼层数据失败:',e),!1}}function s(e){if(e.is_user)return!1;return(e.swipe_id??0)>=(e.swipes?.length??1)-1}async function u(){if(console.info('[ACU Swipe] handleSwipeClearOnly 开始执行'),a.value)return void console.info('[ACU Swipe] 正在处理中，跳过');const e=function(){const e=window.parent||window,t=e.SillyTavern||e.top?.SillyTavern;return t&&'function'==typeof t.getContext?t.getContext():null}();if(!e?.chat?.length)return void console.warn('[ACU Swipe] SillyTavern context.chat 不可用');const t=e.chat.length-1,o=e.chat[t];if(console.info('[ACU Swipe] 检查最后一楼:',{index:t,is_user:o.is_user,swipe_id:o.swipe_id,swipes_length:o.swipes?.length}),!s(o))return void console.info('[ACU Swipe] 查看历史 swipe，跳过清除');const n=function(e){const t=e.TavernDB_ACU_IsolatedData;return!(!t||'object'!=typeof t)&&Object.keys(t).length>0}(o);if(console.info('[ACU Swipe] 最后一楼是否有 ACU 数据:',n),n){a.value=!0;try{console.info('[ACU Swipe] 开始清除第',t,'楼的表格数据');await c(t)&&Aa.toast.info('Swipe: 已清除最后一楼表格数据')}finally{a.value=!1}}else console.info('[ACU Swipe] 最后一楼无 ACU 数据，跳过清除')}async function d(e){const a=t.config.clearTableOnSwipe??o.value.clearTableOnSwipe;console.info('[ACU Swipe] handleSwipe 调用',{clearEnabled:a}),a?(console.info('[ACU Swipe] 执行清除表格'),await u()):console.info('[ACU Swipe] 功能未启用，跳过')}function m(){const e=window.parent.document.getElementById('chat');if(!e)return void console.warn('[ACU Swipe] 未找到 #chat 容器，无法初始化移动端监听');const t=e=>{const t=e.touches[0];r=t.clientX,l=t.clientY,i=!1},a=e=>{if(i)return;const t=e.touches[0],a=t.clientX-r,o=t.clientY-l;Math.abs(a)>Math.abs(o)&&a<-50&&(i=!0,function(e){if(!e)return!1;const t=window.parent.document.querySelectorAll('#chat .mes');return 0!==t.length&&t[t.length-1].contains(e)}(e.target)&&(console.log('[ACU Swipe] 移动端：检测到左滑手势'),d()))};e.addEventListener('touchstart',t,{passive:!0}),e.addEventListener('touchmove',a,{passive:!0}),n.push(()=>{e.removeEventListener('touchstart',t),e.removeEventListener('touchmove',a),console.info('[ACU Swipe] 移动端监听已清理')}),console.info('[ACU Swipe] 移动端监听已初始化')}function f(){n.forEach(e=>e()),n.length=0,console.info('[ACU Swipe] Swipe 增强功能已清理')}return(0,p.onUnmounted)(()=>{f()}),{isProcessing:a,config:o,updateConfig:function(e){o.value={...o.value,...e},console.info('[ACU Swipe] 配置已更新:',o.value)},getConfig:function(){return{...o.value}},clearFloorData:c,handleSwipe:d,handleSwipeClearOnly:u,willTriggerNewGeneration:s,init:function(){!function(){const{$}=xt();if(!$)return void console.warn('[ACU Swipe] jQuery 不可用，无法初始化桌面端监听');const e=window.parent.document,t=e=>{e.target.closest('.swipe_right')&&(console.info('[ACU Swipe] 检测到 swipe_right 点击'),d())};e.addEventListener('click',t,{capture:!0}),n.push(()=>{e.removeEventListener('click',t,{capture:!0}),console.info('[ACU Swipe] 桌面端监听已清理')}),console.info('[ACU Swipe] 桌面端监听已初始化 (捕获模式)')}(),m(),console.info('[ACU Swipe] Swipe 增强功能已初始化')},cleanup:f}}const vo='avatars';let bo=null;const ho=new Map;function xo(){const e=(0,p.ref)(!1),t=(0,p.ref)(null);async function a(){return bo||new Promise((a,o)=>{const n=indexedDB.open('acu_avatars',1);n.onerror=()=>{const e=`[AvatarManager] 打开数据库失败: ${n.error?.message}`;console.error(e),t.value=e,o(n.error)},n.onsuccess=()=>{bo=n.result,bo.onclose=()=>{console.warn('[AvatarManager] 数据库连接已关闭，重置实例'),bo=null,e.value=!1},bo.onerror=e=>{console.error('[AvatarManager] 数据库错误:',e.target.error)},e.value=!0,console.info('[AvatarManager] 数据库连接成功'),a(bo)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(vo)||(t.createObjectStore(vo,{keyPath:'name'}),console.info('[AvatarManager] 创建数据库表成功'))}})}async function o(e){const t=await a();return new Promise((a,o)=>{const n=t.transaction(vo,'readwrite').objectStore(vo);ho.has(e.name)&&(URL.revokeObjectURL(ho.get(e.name)),ho.delete(e.name));const r={...e,updatedAt:e.updatedAt||Date.now()},l=n.put(r);l.onsuccess=()=>{console.info(`[AvatarManager] 保存头像成功: ${e.name}`),a()},l.onerror=()=>{console.error(`[AvatarManager] 保存头像失败: ${l.error}`),o(l.error)}})}async function n(e){if(!e)return null;const t=await a();return new Promise(a=>{const o=t.transaction(vo,'readonly').objectStore(vo).get(e);o.onsuccess=()=>{a(o.result||null)},o.onerror=()=>{console.error(`[AvatarManager] 获取头像失败: ${o.error}`),a(null)}})}async function r(){const e=await a();return new Promise(t=>{const a=e.transaction(vo,'readonly').objectStore(vo).getAll();a.onsuccess=()=>{t(a.result||[])},a.onerror=()=>{console.error(`[AvatarManager] 获取所有头像失败: ${a.error}`),t([])}})}function l(){try{const e=window.parent||window,$=e.jQuery||window.jQuery;if($){const e=$('.mes[is_user="true"]').last().find('.avatar img');if(e.length&&e.attr('src')){const t=e.attr('src');if(t&&!t.includes('default')&&!t.includes('placeholder'))return t}const t=$('#user_avatar_block img').first();if(t.length&&t.attr('src'))return t.attr('src')}const t=e.SillyTavern||window.SillyTavern;if(t?.getContext){const e=t.getContext();if(e?.userAvatar)return e.userAvatar}}catch(e){console.warn('[AvatarManager] getSillyTavernUserAvatar error:',e)}return null}function i(){try{const e=(window.parent||window).AutoCardUpdaterAPI;if(e?.exportTableAsJson){const t=e.exportTableAsJson();for(const e in t){const a=t[e];if(a?.name?.includes('主角')&&a.content?.[1]?.[1])return a.content[1][1]}}}catch(e){console.warn('[AvatarManager] getPlayerNameFromTable error:',e)}return null}function c(e){if(!e)return!1;const t=['<user>','{{user}}','主角','player','protagonist'],a=e.toLowerCase();for(const e of t)if(a===e.toLowerCase())return!0;const o=i();return!(!o||e!==o)}async function s(e){if(!e)return e;const t=await r();for(const a of t)if(a.aliases?.includes(e))return a.name;return e}return{isReady:e,error:t,initDB:a,saveAvatar:o,getAvatar:n,deleteAvatar:async function(e){if(!e)return;ho.has(e)&&(URL.revokeObjectURL(ho.get(e)),ho.delete(e));const t=await a();return new Promise(a=>{const o=t.transaction(vo,'readwrite').objectStore(vo).delete(e);o.onsuccess=()=>{console.info(`[AvatarManager] 删除头像成功: ${e}`),a()},o.onerror=()=>{console.error(`[AvatarManager] 删除头像失败: ${o.error}`),a()}})},deleteAvatars:async function(e){if(!e.length)return;for(const t of e)ho.has(t)&&(URL.revokeObjectURL(ho.get(t)),ho.delete(t));const t=await a();return new Promise((a,o)=>{const n=t.transaction(vo,'readwrite'),r=n.objectStore(vo);let l=0;const i=e.length;for(const t of e){const e=r.delete(t);e.onsuccess=()=>{l++,l===i&&(console.info(`[AvatarManager] 批量删除完成: ${i} 个`),a())},e.onerror=()=>{console.error(`[AvatarManager] 删除失败: ${t}`),l++,l===i&&a()}}n.onerror=()=>o(n.error)})},getAllAvatars:r,hasAvatar:async function(e){if(!e)return!1;const t=await a();return new Promise(a=>{const o=t.transaction(vo,'readonly').objectStore(vo).getKey(e);o.onsuccess=()=>a(void 0!==o.result),o.onerror=()=>a(!1)})},getStats:async function(){const e=await a();return new Promise(t=>{const a=e.transaction(vo,'readonly').objectStore(vo).getAll();a.onsuccess=()=>{const e=a.result||[],o=e.reduce((e,t)=>e+(t.blob?.size||0),0);t({count:e.length,totalSizeBytes:o,totalSizeMB:(o/1024/1024).toFixed(2)})},a.onerror=()=>{t({count:0,totalSizeBytes:0,totalSizeMB:'0.00'})}})},clearAll:async function(){ho.forEach(e=>URL.revokeObjectURL(e)),ho.clear();const e=await a();return new Promise(t=>{const a=e.transaction(vo,'readwrite').objectStore(vo).clear();a.onsuccess=()=>{console.info('[AvatarManager] 清空所有头像成功'),t()},a.onerror=()=>{console.error(`[AvatarManager] 清空失败: ${a.error}`),t()}})},getAvatarUrl:async function e(t){if(!t)return null;if(ho.has(t))return ho.get(t);const a=await n(t);if(a){if(a.blob){const e=URL.createObjectURL(a.blob);return ho.set(t,e),e}if(a.url)return a.url}const o=await s(t);if(o!==t)return e(o);if(c(t)){const e=l();if(e)return e}return null},getAvatarDisplayConfig:async function(e){const t=await n(e);return t?{offsetX:t.offsetX??50,offsetY:t.offsetY??50,scale:t.scale??150}:{offsetX:50,offsetY:50,scale:150}},getSillyTavernUserAvatar:l,getSillyTavernCharacterAvatar:function(){try{const e=window.parent||window,$=e.jQuery||window.jQuery;if($){const e=$('#avatar_img_holder img').first();if(e.length&&e.attr('src'))return e.attr('src');const t=$('.mes:not([is_user="true"])').last().find('.avatar img');if(t.length&&t.attr('src'))return t.attr('src')}const t=e.SillyTavern||window.SillyTavern;if(t?.getContext){const e=t.getContext();if(e?.characterAvatar)return e.characterAvatar}}catch(e){console.warn('[AvatarManager] getSillyTavernCharacterAvatar error:',e)}return null},getPlayerNameFromTable:i,isPlayerNode:c,resolvePrimaryName:s,addAlias:async function(e,t){const a=await n(e);if(!a)return;const r=a.aliases||[];r.includes(t)||(r.push(t),await o({...a,aliases:r,updatedAt:Date.now()}))},removeAlias:async function(e,t){const a=await n(e);if(!a)return;const r=(a.aliases||[]).filter(e=>e!==t);await o({...a,aliases:r,updatedAt:Date.now()})},getAliasMap:async function(){const e=await r(),t=new Map;for(const a of e)if(a.aliases?.length)for(const e of a.aliases)t.set(e,a.name);return t},getAliases:async function(e){const t=await n(e);return t?.aliases||[]},setAliases:async function(e,t){let a=await n(e);a=a?{...a,aliases:t,updatedAt:Date.now()}:{name:e,offsetX:50,offsetY:50,scale:150,aliases:t,updatedAt:Date.now()},await o(a)},getDisplayLabel:async function(e){return e},setDisplayLabel:async function(e,t){console.warn('[AvatarManager] setDisplayLabel 已废弃，请使用聊天变量保存标签配置')},getDisplayChars:function(e){if(!e)return[];if('undefined'!=typeof Intl&&Intl.Segmenter){const t=new Intl.Segmenter('zh',{granularity:'grapheme'});return Array.from(t.segment(e),e=>e.segment)}return[...e]},cleanup:function(){ho.forEach(e=>URL.revokeObjectURL(e)),ho.clear(),console.info('[AvatarManager] 已清理 ObjectURL 缓存')}}}function yo(e){const t=e.match(/shujuku_v?(\d+)/i);return t?parseInt(t[1],10):0}function wo(e,t){const a=e.filter(e=>t.test(e));return 0===a.length?null:(a.sort((e,t)=>yo(t)-yo(e)),a[0])}let ko=null;function Co(e){const t=e.toLowerCase();return e.includes('总结')||e.includes('大纲')||t.includes('summary')||t.includes('outline')}function No(e,t,a,o){const n=a.dataIsolationEnabled?a.dataIsolationCode:'';for(let r=t.length-1;r>=0;r--){const l=t[r];if(l.is_user)continue;let i=!1;const c=l.TavernDB_ACU_IsolatedData;if(c&&c[n]){const t=c[n],a=t.updateGroupKeys||[],o=t.modifiedKeys||[],r=t.independentData||{};a.length>0&&o.length>0?i=a.includes(e):(o.includes(e)||r[e])&&(i=!0)}if(!i){const t=l.TavernDB_ACU_Identity;let n=!1;if(n=a.dataIsolationEnabled?t===a.dataIsolationCode:!t,n){const t=l.TavernDB_ACU_ModifiedKeys||[],a=l.TavernDB_ACU_UpdateGroupKeys||[];a.length>0&&t.length>0?i=a.includes(e):(t.includes(e)||l.TavernDB_ACU_IndependentData&&l.TavernDB_ACU_IndependentData[e]||o&&l.TavernDB_ACU_SummaryData&&l.TavernDB_ACU_SummaryData[e]||!o&&l.TavernDB_ACU_Data&&l.TavernDB_ACU_Data[e])&&(i=!0)}}if(i){return{aiFloor:t.slice(0,r+1).filter(e=>!e.is_user).length,chatIndex:r,hasHistory:!0}}}return{aiFloor:0,chatIndex:-1,hasHistory:!1}}const Vo=(0,p.ref)([]),Eo=(0,p.ref)(!1),Bo=(0,p.ref)(null),So=(0,p.ref)(0),To=(0,p.ref)(0);function Do(){return{statusList:(0,p.computed)(()=>Vo.value),isLoading:(0,p.computed)(()=>Eo.value),lastRefreshTime:(0,p.computed)(()=>Bo.value),currentTotalAiFloors:(0,p.computed)(()=>So.value),currentTotalFloors:(0,p.computed)(()=>To.value),refresh:async function(){if(Eo.value)return console.info('[ACU] 表格更新状态刷新进行中，跳过重复请求'),Vo.value;Eo.value=!0;const e=Date.now();try{const e=xt().getDB(),t=e?.exportTableAsJson?.();if(!t)return console.warn('[ACU] 无法获取表格数据'),Vo.value=[],[];const a=function(){const e=window.parent||window;try{const t=e.SillyTavern?.getContext?.(),a=t?.extensionSettings?.__userscripts;if(a){const e=wo(Object.keys(a),/shujuku_v\d+__userscript_settings_v1/i);if(e&&a[e]){const t=a[e],o='string'==typeof t?JSON.parse(t):t,n=e.replace(/__userscript_settings_v1$/i,''),r=`${n}_globalMeta_v1`;let l='';if(o[r]){const e=o[r],t='string'==typeof e?JSON.parse(e):e;l=String(t.activeIsolationCode||'')}const i=`${n}_profile_v1__${encodeURIComponent(l)||'__default__'}__settings`;let c={};if(o[i]){const e=o[i];c='string'==typeof e?JSON.parse(e):e}return ko={versionPrefix:n,isolationCode:l,userscripts:o},{dataIsolationEnabled:''!==l,dataIsolationCode:l,autoUpdateFrequency:Number(c.autoUpdateFrequency)||2,skipUpdateFloors:Number(c.skipUpdateFloors)||0}}}const o=e.localStorage;if(o){const e=wo(Object.keys(o),/shujuku.*settings/i);if(e){const t=JSON.parse(o.getItem(e)||'{}');return{dataIsolationEnabled:!!t.dataIsolationEnabled,dataIsolationCode:String(t.dataIsolationCode||''),autoUpdateFrequency:Number(t.autoUpdateFrequency)||2,skipUpdateFloors:Number(t.skipUpdateFloors)||0}}}}catch(e){console.warn('[ACU] 读取全局设置失败:',e)}return ko=null,{dataIsolationEnabled:!1,dataIsolationCode:'',autoUpdateFrequency:2,skipUpdateFloors:0}}();let o=null;o='function'==typeof e?.getTableTemplate?e.getTableTemplate():function(){if(!ko)return null;try{const{versionPrefix:e,isolationCode:t,userscripts:a}=ko,o=`${e}_profile_v1__${encodeURIComponent(t)||'__default__'}__template`;if(a[o]){const e=a[o];return'string'==typeof e?JSON.parse(e):e}}catch(e){console.warn('[ACU] 读取模板配置失败:',e)}return null}();const n=window.parent||window,r=n.SillyTavern?.getContext?.()?.chat||[],l=r.length,i=r.filter(e=>!e.is_user).length;To.value=l,So.value=i;const c=[],s=Object.keys(t).filter(e=>e.startsWith('sheet_')).sort((e,a)=>(o?.[e]?.orderNo??t[e]?._acu_orderNo??1/0)-(o?.[a]?.orderNo??t[a]?._acu_orderNo??1/0));for(const e of s){const n=t[e],s=o?.[e],u=s?.name||n?.name;if(!u)continue;const d=(s?.updateConfig||{}).updateFrequency??-1,p=-1===d?a.autoUpdateFrequency:d,m=Co(u),{aiFloor:f,chatIndex:g,hasHistory:v}=No(e,r,a,m),b=v?i-f:i;c.push({sheetKey:e,name:u,updateFrequency:d,effectiveFrequency:p,lastUpdatedAiFloor:f,lastUpdatedChatIndex:g,unrecordedFloors:b,totalAiFloors:i,totalFloors:l,hasHistory:v,isSummaryOrOutline:m,orderNo:s?.orderNo??n?._acu_orderNo??999})}return Vo.value=c,Bo.value=new Date,console.info(`[ACU] 表格更新状态刷新完成，共 ${c.length} 个表格，全局频率: ${a.autoUpdateFrequency}`),c}catch(e){return console.error('[ACU] 获取表格更新状态失败:',e),Vo.value=[],[]}finally{const t=Date.now()-e;t<500&&await new Promise(e=>setTimeout(e,500-t)),Eo.value=!1}},formatLastUpdate:function(e){return e.hasHistory?`${e.lastUpdatedAiFloor}/${e.lastUpdatedChatIndex}`:'未初始'},getUnrecordedClass:function(e){if(!e.hasHistory)return'';if(0===e.effectiveFrequency)return'';const t=e.unrecordedFloors/e.effectiveFrequency;return t>=2?'danger':t>=1?'warning':'success'}}}const Ao={HEADER:'<user>行动顺利度：',LUCK:'{{luck}}',WORDS:'在接下来的描写中，请自然地融入以下要素：[ {{words}} ]',DIMENSIONS:'{{dimensions}}'},zo=`${Ao.HEADER}\n${Ao.LUCK}\n${Ao.WORDS}\n${Ao.DIMENSIONS}`;function Io(e){const{luck:t,words:a,dimensions:o}=e,n=[Ao.HEADER];if(t.prompt&&n.push(t.prompt),a&&a.length>0){const e=Ao.WORDS.replace('{{words}}',a.join('、'));n.push(e)}if(o&&o.length>0){const e=o.filter(e=>e.prompt&&e.prompt.trim()).map(e=>e.prompt).join('\n');e&&n.push(e)}return n.join('\n')}const _o={widgets:[],layout:'grid',columns:2,showStats:!0};const Uo=t('acu-dashboard',()=>{const e=(0,p.ref)({..._o}),t=(0,p.ref)(!1),a=(0,p.computed)(()=>e.value.widgets.filter(e=>e.enabled).sort((e,t)=>e.order-t.order)),o=(0,p.computed)(()=>[...e.value.widgets].sort((e,t)=>e.order-t.order)),n=(0,p.computed)(()=>e.value.showStats),r=(0,p.computed)(()=>e.value.columns),l=(0,p.computed)(()=>e.value.layout);async function i(){try{const t=getVariables({type:'chat'})||{};replaceVariables({...t,acu_dashboard_config:e.value},{type:'chat'}),console.log('[ACU Dashboard] 配置保存成功 (聊天变量)')}catch(e){console.error('[ACU Dashboard] 保存配置失败:',e)}}function c(t,a,o){let n=o?Pe[o]:void 0;const r=a||t;if(!n)for(const[e,t]of Object.entries(Fe))if(t.some(e=>r.toLowerCase().includes(e.toLowerCase()))){n=Pe[e];break}let l=n?.actions||['goToTable'];const c=r.toLowerCase();(c.includes('人物')||c.includes('npc'))&&(l.includes('relationshipGraph')||(l=[...l,'relationshipGraph']));let s=n?.displayStyle||'list';n||!a?.includes('交互')&&!a?.includes('互动')&&'sheet_Interaction_CN'!==t||(s='interaction');const u={id:`widget_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:'table',tableId:t,title:n?.title||a||t,icon:n?.icon||'fa-table',displayColumns:n?.displayColumns||[],maxRows:n?.maxRows||8,actions:l,order:e.value.widgets.length,enabled:!0,colSpan:n?.colSpan||1,displayStyle:s};return e.value.widgets.push(u),i(),u}function s(t,a){const o=e.value.widgets.find(e=>e.id===t);o&&(Object.assign(o,a),i())}function u(t){const a={updateStatus:{type:'updateStatus',title:'表格状态',icon:'fa-sync-alt',colSpan:2,actions:['nativeEdit']},optionsPanel:{type:'optionsPanel',title:'选项聚合面板',icon:'fa-list-check',colSpan:2},randomWordPool:{type:'randomWordPool',title:'随机词表',icon:'fa-dice',colSpan:1,actions:['settings']}}[t],o={id:`special_${t}_${Date.now()}`,type:t,title:a.title||t,icon:a.icon||'fa-cog',displayColumns:[],maxRows:10,actions:[],order:e.value.widgets.length,enabled:!0,colSpan:a.colSpan||2,displayStyle:'list'};return e.value.widgets.push(o),i(),o}return{config:e,isInitialized:t,enabledWidgets:a,allWidgets:o,showStats:n,columns:r,layout:l,loadConfig:async function(){try{const a=getVariables({type:'chat'});a&&a.acu_dashboard_config&&(e.value={..._o,...a.acu_dashboard_config}),0===e.value.widgets.length&&await async function(){console.log('[ACU Dashboard] 初始化默认组件...'),u('updateStatus'),function(){const t=oa();if(t.length>0){e.value.widgets.some(e=>'randomWordPool'===e.type)||(u('randomWordPool'),console.log(`[ACU Dashboard] 检测到 ${t.length} 个随机表，已自动添加随机词表组件`))}}();const t=yt();if(!t)return console.log('[ACU Dashboard] 无法获取表格数据，仅添加更新状态组件'),void i();const a=wt(t);if(!a)return console.log('[ACU Dashboard] 无有效表格，仅添加更新状态组件'),void i();const o=[{keywords:['任务','task','Task','quest','Quest','日程'],templateKey:'task'},{keywords:['物品','道具','item','Item','背包','库存','装备'],templateKey:'item'},{keywords:['全局','Global'],templateKey:'global'},{keywords:['交互','互动'],templateKey:'interaction'}];for(const[t,n]of Object.entries(a)){const a=n.key,r=t.toLowerCase();for(const n of o)if(n.keywords.some(e=>r.includes(e.toLowerCase()))){e.value.widgets.some(e=>e.tableId===a)||(c(a,t,n.templateKey),console.log(`[ACU Dashboard] 自动添加表格: ${t} (模板: ${n.templateKey})`));break}}i(),console.log('[ACU Dashboard] 默认组件初始化完成')}();const o=['人物','npc','NPC','角色','关系','好感','重要人物'],n=Fe.global||[];let r=!1;e.value.widgets.forEach(e=>{const t=e.title||e.tableId||'';'grid'===e.displayStyle&&'table'===e.type&&o.some(e=>t.includes(e))&&(console.log(`[ACU Dashboard] 迁移表格样式为普通列表: ${t}`),e.displayStyle='list',e.displayColumns=[],r=!0),'table'===e.type&&'global'!==e.displayStyle&&n.some(e=>t.toLowerCase().includes(e.toLowerCase()))&&(console.log(`[ACU Dashboard] 迁移表格样式为全局状态视图: ${t}`),e.displayStyle='global',e.displayColumns=[],e.maxRows=1,e.colSpan=2,r=!0)}),r||e.value.widgets.forEach(e=>{if('table'===e.type&&'global'!==e.displayStyle){const t=e.title||e.tableId||'';['全局','状态','Global','Status','Environment','环境'].some(e=>t.toLowerCase().includes(e.toLowerCase()))&&(console.log(`[ACU Dashboard] 强制迁移表格样式为全局状态视图 (Backup): ${t}`),e.displayStyle='global',e.maxRows=1,e.colSpan=2,r=!0)}}),r&&i(),t.value=!0,console.log('[ACU Dashboard] 配置加载成功 (聊天变量):',e.value)}catch(a){console.warn('[ACU Dashboard] 加载配置失败，使用默认配置:',a),e.value={..._o},t.value=!0}},saveConfig:i,updateConfig:function(t){e.value={...e.value,...t},i()},addWidget:c,removeWidget:function(t){const a=e.value.widgets.findIndex(e=>e.id===t);-1!==a&&(e.value.widgets.splice(a,1),e.value.widgets.forEach((e,t)=>{e.order=t}),i())},updateWidget:s,toggleWidget:function(t){const a=e.value.widgets.find(e=>e.id===t);a&&(a.enabled=!a.enabled,i())},moveWidget:function(t,a){const o=[...e.value.widgets],n=o.findIndex(e=>e.id===t);if(-1===n)return;const[r]=o.splice(n,1);o.splice(a,0,r),o.forEach((e,t)=>{e.order=t}),e.value.widgets=o,i()},setWidgetActions:function(e,t){s(e,{actions:t})},resetConfig:function(){e.value={..._o},i()},findWidgetByTableId:function(t){return e.value.widgets.find(e=>e.tableId===t)},hasWidget:function(t){return e.value.widgets.some(e=>e.tableId===t)},hasSpecialWidget:function(t){return e.value.widgets.some(e=>e.type===t)},addSpecialWidget:u,removeSpecialWidget:function(t){const a=e.value.widgets.findIndex(e=>e.type===t);-1!==a&&(e.value.widgets.splice(a,1),e.value.widgets.forEach((e,t)=>{e.order=t}),i())},getWidgetById:function(t){return e.value.widgets.find(e=>e.id===t)}}}),Mo=[{border:'#E91E63',background:'rgba(233, 30, 99, 0.1)',opacity:10},{border:'#2196F3',background:'rgba(33, 150, 243, 0.1)',opacity:10},{border:'#4CAF50',background:'rgba(76, 175, 80, 0.1)',opacity:10},{border:'#FF9800',background:'rgba(255, 152, 0, 0.1)',opacity:10},{border:'#9C27B0',background:'rgba(156, 39, 176, 0.1)',opacity:10},{border:'#00BCD4',background:'rgba(0, 188, 212, 0.1)',opacity:10},{border:'#795548',background:'rgba(121, 85, 72, 0.1)',opacity:10},{border:'#607D8B',background:'rgba(96, 125, 139, 0.1)',opacity:10}],Lo={border:'#666666',background:'rgba(128, 128, 128, 0.1)',opacity:10},$o=60,Po=2,Fo='ellipse',jo={enabled:!1,position:'top-right',items:[{id:'legend-love',label:'恋爱/暧昧',color:'#E91E63',emoji:'❤️',keywords:['恋','爱','暧昧','情人','伴侣']},{id:'legend-family',label:'亲属',color:'#2196F3',emoji:'💙',keywords:['父','母','兄','弟','姐','妹','亲']},{id:'legend-friend',label:'友好/同伴',color:'#4CAF50',emoji:'💚',keywords:['友','朋','伙伴','同伴','盟']},{id:'legend-neutral',label:'中立/一般',color:'#9E9E9E',emoji:'⚪',keywords:['同事','邻居','认识']},{id:'legend-interest',label:'利益关系',color:'#FF9800',emoji:'🟡',keywords:['合作','雇佣','交易','利用']},{id:'legend-enemy',label:'敌对/仇恨',color:'#F44336',emoji:'🔴',keywords:['敌','仇','对手','竞争']},{id:'legend-complex',label:'复杂/未知',color:'#9C27B0',emoji:'🟣',keywords:[]}]},Ro={nodeSize:50,edgeWidth:2.5,relationLabelFontSize:10,nameLabelFontSize:12,factionLabelFontSize:14,showLegend:!0,showBackground:!0,factionColors:{},factionAvatars:{},nodeOverrides:{},legendConfig:{...jo}},Oo='acu_graph_style_config',Ho=t('graphConfig',()=>{const e=(0,p.ref)(t());function t(){try{const e=getVariables({type:'chat'})[Oo];if(e&&'object'==typeof e)return{...Ro,...e}}catch(e){console.warn('[GraphConfigStore] 加载配置失败:',e)}return{...Ro}}function a(){try{insertOrAssignVariables({[Oo]:o(e.value)},{type:'chat'})}catch(e){console.warn('[GraphConfigStore] 保存配置失败:',e)}}return(0,p.watchEffect)(()=>{JSON.stringify(e.value);void 0!==e.value&&a()}),{config:e,saveConfig:a,resetToDefault:function(){e.value={...Ro,factionColors:{}},a()},refresh:function(){e.value=t()},setFactionColor:function(t,a){e.value.factionColors={...e.value.factionColors,[t]:a}},getFactionColor:function(t,a=[],o=!1){if(e.value.factionColors[t])return e.value.factionColors[t];if(o)return Lo;const n=(Object.keys(e.value.factionColors).length+a.indexOf(t))%Mo.length;return Mo[Math.max(0,n)]},hasFactionColor:function(t){return!!e.value.factionColors[t]},initFactionColors:function(t){const a={...e.value.factionColors};let o=Object.keys(a).length;for(const e of t)a[e]||(a[e]=Mo[o%Mo.length],o++);e.value.factionColors=a},setFactionAvatar:function(t,a){e.value.factionAvatars||(e.value.factionAvatars={}),e.value.factionAvatars={...e.value.factionAvatars,[t]:a}},getFactionAvatar:function(t){return e.value.factionAvatars?.[t]},removeFactionAvatar:function(t){if(e.value.factionAvatars?.[t]){const a={...e.value.factionAvatars};delete a[t],e.value.factionAvatars=a}},hasFactionAvatar:function(t){return!!e.value.factionAvatars?.[t]},getAllFactionAvatars:function(){return e.value.factionAvatars||{}},setFactionOverride:function(t,a){const o=t.replace('faction-container-',''),n=e.value.factionColors[o]||{...Lo};e.value.factionColors={...e.value.factionColors,[o]:{...n,...a}}},getFactionOverride:function(t){const a=t.replace('faction-container-','');return e.value.factionColors[a]},removeFactionOverride:function(t){const a=t.replace('faction-container-','');if(e.value.factionColors[a]){const t={...e.value.factionColors};delete t[a],e.value.factionColors=t}},setNodeStyleOverride:function(t,a){e.value.nodeOverrides||(e.value.nodeOverrides={});const o=e.value.nodeOverrides[t]||{};e.value.nodeOverrides={...e.value.nodeOverrides,[t]:{...o,...a}}},getNodeStyleOverride:function(t){return e.value.nodeOverrides?.[t]},removeNodeStyleOverride:function(t){if(e.value.nodeOverrides?.[t]){const a={...e.value.nodeOverrides};delete a[t],e.value.nodeOverrides=a}},hasNodeStyleOverride:function(t){return!!e.value.nodeOverrides?.[t]},setLegendEnabled:function(t){e.value.legendConfig||(e.value.legendConfig={...jo}),e.value.legendConfig.enabled=t},setLegendPosition:function(t){e.value.legendConfig||(e.value.legendConfig={...jo}),e.value.legendConfig.position=t},addLegendItem:function(t){e.value.legendConfig||(e.value.legendConfig={...jo});const a={...t,id:`legend-${Date.now()}`};e.value.legendConfig.items=[...e.value.legendConfig.items,a]},updateLegendItem:function(t,a){e.value.legendConfig?.items&&(e.value.legendConfig.items=e.value.legendConfig.items.map(e=>e.id===t?{...e,...a}:e))},removeLegendItem:function(t){e.value.legendConfig?.items&&(e.value.legendConfig.items=e.value.legendConfig.items.filter(e=>e.id!==t))},getLegendConfig:function(){return e.value.legendConfig||jo},resetLegendConfig:function(){e.value.legendConfig={...jo}},matchLegendColor:function(t){const a=e.value.legendConfig;if(!a?.enabled||!a.items?.length)return null;for(const e of a.items)if(e.keywords.some(e=>t.includes(e)))return e.color;return null},setShowBackground:function(t){e.value.showBackground=t,a()}}}),Wo='acu_global_tag_library',Go={categories:[],tags:[]},Yo=[{name:'全部',icon:'',hasChildren:!1},{name:'未分类',icon:'📦',hasChildren:!1}];function Xo(e){return`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Ko=t('acu-tag-library',()=>{const e=(0,p.ref)({...Go}),t=(0,p.ref)(''),a=(0,p.ref)(''),n=(0,p.ref)(''),r=(0,p.ref)(!1);let l=null;const i=(0,p.ref)('normal'),c=(0,p.ref)(new Set),s=(0,p.ref)(new Set),u=(0,p.ref)(null);async function d(){l&&clearTimeout(l),l=setTimeout(()=>{try{if('function'!=typeof getVariables||'function'!=typeof replaceVariables)return void console.warn('[ACU TagLibrary] 脚本变量 API 不可用');const t=getVariables({type:'global'})||{},a=o(e.value);replaceVariables({...t,[Wo]:a},{type:'global'}),console.info('[ACU TagLibrary] 已保存标签库到全局变量')}catch(e){console.error('[ACU TagLibrary] 保存标签库失败:',e)}},300)}function m(e){const t=e.path.split('/');return{category:e,level1:t[0]||'',level2:t[1]||'',rest:t.slice(2).join('/')}}(0,p.watch)(e,()=>{r.value&&d()},{deep:!0});const f=(0,p.computed)(()=>{const t=new Map;e.value.categories.forEach(e=>{const a=m(e);if(a.level1){const o=t.get(a.level1),n=''!==a.level2;o?o.hasChildren=o.hasChildren||n:t.set(a.level1,{icon:e.icon,hasChildren:n})}});const a=[];return t.forEach((e,t)=>{a.push({name:t,icon:e.icon,hasChildren:e.hasChildren})}),a.sort((e,t)=>e.name.localeCompare(t.name,'zh-CN')),[...Yo,...a]}),g=(0,p.computed)(()=>{if(!t.value||'全部'===t.value||'未分类'===t.value)return[];const a=[],o=new Set;return e.value.categories.forEach(e=>{const n=m(e);n.level1===t.value&&n.level2&&!o.has(n.level2)&&(o.add(n.level2),a.push({name:n.level2,fullPath:`${n.level1}/${n.level2}`}))}),a.sort((e,t)=>e.name.localeCompare(t.name,'zh-CN')),a});function v(t,a){const o=t.split('/');for(let t=1;t<o.length;t++){const a=o.slice(0,t).join('/');if(!e.value.categories.find(e=>e.path===a)){const t={id:Xo('cat'),path:a,createdAt:(new Date).toISOString()};e.value.categories.push(t),console.info('[ACU TagLibrary] 自动创建父级分类:',a)}}const n=e.value.categories.find(e=>e.path===t);if(n)return void 0!==a&&a!==n.icon&&(n.icon=a,console.info('[ACU TagLibrary] 更新分类图标:',t)),n;const r={id:Xo('cat'),path:t,icon:a,createdAt:(new Date).toISOString()};return e.value.categories.push(r),console.info('[ACU TagLibrary] 创建分类:',t),r}function b(t,a){const o=e.value.categories.find(e=>e.id===t);o&&(void 0!==a.path&&(o.path=a.path),void 0!==a.icon&&(o.icon=a.icon))}function h(t){return e.value.categories.find(e=>e.id===t)}const x=(0,p.computed)(()=>{let o=[...e.value.tags];if(n.value.trim()){const e=n.value.toLowerCase();o=o.filter(t=>t.label.toLowerCase().includes(e)||t.promptTemplate.toLowerCase().includes(e))}if('未分类'===t.value)o=o.filter(t=>!t.categoryId||!e.value.categories.find(e=>e.id===t.categoryId));else if(t.value&&'全部'!==t.value){const n=new Set;e.value.categories.forEach(e=>{const o=m(e);o.level1===t.value&&(a.value?o.level2===a.value&&n.add(e.id):n.add(e.id))}),o=o.filter(e=>n.has(e.categoryId))}return o.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),o});function y(t,a='',o=''){const n={id:Xo('tag'),label:t,categoryId:a,promptTemplate:o,createdAt:(new Date).toISOString()};return e.value.tags.push(n),n}function w(t,a){const o=new Set(t);e.value.tags.forEach(e=>{o.has(e.id)&&(e.categoryId=a)})}function k(){c.value=new Set,s.value=new Set,u.value=null}const C=(0,p.computed)(()=>e.value.tags.length),N=(0,p.computed)(()=>e.value.categories.length),V=(0,p.computed)(()=>e.value.tags.filter(t=>!t.categoryId||!e.value.categories.find(e=>e.id===t.categoryId)).length);return{library:e,selectedLevel1:t,selectedLevel2:a,searchKeyword:n,isLoaded:r,currentMode:i,selectedTagIds:c,selectedCategoryIds:s,selectionType:u,loadLibrary:async function(){try{if('function'!=typeof getVariables)return console.warn('[ACU TagLibrary] getVariables 不可用，使用默认配置'),void(r.value=!0);const t=getVariables({type:'global'});if(t&&t[Wo]){const a=t[Wo];e.value={categories:a.categories||[],tags:a.tags||[]},console.info('[ACU TagLibrary] 已从全局变量加载标签库:',{categories:e.value.categories.length,tags:e.value.tags.length})}else await async function(){try{console.info('[ACU TagLibrary] 首次使用，初始化空标签库'),e.value={...Go}}catch(e){console.warn('[ACU TagLibrary] 迁移旧配置失败:',e)}}();r.value=!0}catch(t){console.error('[ACU TagLibrary] 加载标签库失败:',t),e.value={...Go},r.value=!0}},saveLibrary:d,parseCategoryPath:m,level1Categories:f,level2Categories:g,addCategory:v,deleteCategory:function(t){const a=e.value.categories.find(e=>e.id===t);if(!a)return void console.warn('[ACU TagLibrary] 分类不存在:',t);const o=new Set;e.value.categories.forEach(e=>{(e.path===a.path||e.path.startsWith(a.path+'/'))&&o.add(e.id)}),e.value.tags=e.value.tags.filter(e=>!o.has(e.categoryId)),e.value.categories=e.value.categories.filter(e=>!o.has(e.id)),console.info('[ACU TagLibrary] 已删除分类及其内容:',a.path,'(子分类数:',o.size-1,')')},updateCategory:b,getCategoryById:h,getCategoryByPath:function(t){return e.value.categories.find(e=>e.path===t)},getChildCategories:function(t){return e.value.categories.filter(e=>{if(''===t)return!e.path.includes('/');if(!e.path.startsWith(t+'/'))return!1;return!e.path.slice(t.length+1).includes('/')})},getCategoryTagCount:function(t){const a=h(t);if(!a)return 0;const o=new Set;return e.value.categories.forEach(e=>{(e.path===a.path||e.path.startsWith(a.path+'/'))&&o.add(e.id)}),e.value.tags.filter(e=>o.has(e.categoryId)).length},getLevel1TagCount:function(t){if('全部'===t)return e.value.tags.length;if('未分类'===t)return V.value;const a=new Set;return e.value.categories.forEach(e=>{m(e).level1===t&&a.add(e.id)}),e.value.tags.filter(e=>a.has(e.categoryId)).length},filteredTags:x,upsertTag:function(t){const a=e.value.tags.findIndex(e=>e.id===t.id);a>=0?e.value.tags[a]={...t}:e.value.tags.push({...t,createdAt:t.createdAt||(new Date).toISOString()})},createTag:y,deleteTag:function(t){e.value.tags=e.value.tags.filter(e=>e.id!==t)},deleteTags:function(t){const a=new Set(t);e.value.tags=e.value.tags.filter(e=>!a.has(e.id))},getTagById:function(t){return e.value.tags.find(e=>e.id===t)},getTagsByCategory:function(t){return e.value.tags.filter(e=>e.categoryId===t)},moveTagToCategory:function(t,a){const o=e.value.tags.find(e=>e.id===t);o&&(o.categoryId=a)},moveTagsToCategory:w,setMode:function(e){'migrate'!==e&&'export'!==e&&k(),i.value=e},toggleTagSelection:function(e){'category'===u.value&&s.value.clear(),u.value='tag',c.value.has(e)?c.value.delete(e):c.value.add(e),c.value=new Set(c.value)},toggleCategorySelection:function(e){'tag'===u.value&&c.value.clear(),u.value='category',s.value.has(e)?s.value.delete(e):s.value.add(e),s.value=new Set(s.value)},clearSelection:k,migrateSelectedTags:function(e){'tag'===u.value&&c.value.size>0&&(w(Array.from(c.value),e),k())},migrateSelectedCategories:function(e){'category'===u.value&&s.value.size>0&&(s.value.forEach(t=>{const a=h(t);if(a){const o=a.path.split('/'),n=o[o.length-1];b(t,{path:e?`${e}/${n}`:n})}}),k())},migrateSelectedItems:function(t){const a=t?h(t):null,o=a?.path||'';'tag'===u.value&&c.value.size>0?(w(Array.from(c.value),t),k()):'category'===u.value&&s.value.size>0&&(s.value.forEach(a=>{const n=h(a);if(n&&a!==t){const t=n.path,r=t.split('/'),l=r[r.length-1],i=o?`${o}/${l}`:l;b(a,{path:i}),e.value.categories.forEach(e=>{if(e.path.startsWith(t+'/')){const a=i+e.path.slice(t.length);b(e.id,{path:a})}})}}),k())},exportLibrary:function(t,a){let o=[],n=[];if('all'===t)o=[...e.value.categories],n=[...e.value.tags];else if('category'===t&&a){const t=h(a);if(t){o=e.value.categories.filter(e=>e.path===t.path||e.path.startsWith(t.path+'/'));const a=new Set(o.map(e=>e.id));n=e.value.tags.filter(e=>a.has(e.categoryId))}}else if('selected'===t){n=e.value.tags.filter(e=>c.value.has(e.id));const t=new Set(n.map(e=>e.categoryId).filter(Boolean));o=e.value.categories.filter(e=>t.has(e.id))}return{version:'1.0',exportedAt:(new Date).toISOString(),categories:o.map(e=>({id:e.id,path:e.path,icon:e.icon})),tags:n.map(e=>{const t=h(e.categoryId);return{id:e.id,label:e.label,category:t?.path||'',prompt:e.promptTemplate,allowPreEdit:e.allowPreEdit}})}},importLibrary:function(t,a){try{let o=0,n=0,r=0,l=0;const i=new Map;return e.value.categories.forEach(e=>{i.set(e.path,e.id)}),t.categories.forEach(e=>{if(!i.has(e.path)){const t=v(e.path,e.icon);i.set(e.path,t.id),o++}}),t.tags.forEach(t=>{const o=i.get(t.category)||'',c=e.value.tags.find(e=>e.label===t.label&&e.categoryId===o);if(c)if('overwrite'===a.conflictStrategy)c.promptTemplate=t.prompt,c.allowPreEdit=t.allowPreEdit,r++;else{let a=t.label,n=1;for(;e.value.tags.some(e=>e.label===a&&e.categoryId===o);)a=`${t.label}_${n}`,n++;y(a,o,t.prompt);const r=e.value.tags[e.value.tags.length-1];r&&t.allowPreEdit&&(r.allowPreEdit=t.allowPreEdit),l++}else{y(t.label,o,t.prompt);const a=e.value.tags[e.value.tags.length-1];a&&t.allowPreEdit&&(a.allowPreEdit=t.allowPreEdit),n++}}),{success:!0,addedCategories:o,addedTags:n,updatedTags:r,renamedTags:l}}catch(e){return console.error('[ACU TagLibrary] 导入失败:',e),{success:!1,addedCategories:0,addedTags:0,updatedTags:0,renamedTags:0,error:e instanceof Error?e.message:'未知错误'}}},clearAll:function(){e.value.tags=[],e.value.categories=[],console.info('[ACU TagLibrary] 已清空所有标签和分类')},selectLevel1:function(e){t.value=e,a.value=''},selectLevel2:function(e){a.value=e},resetSelection:function(){t.value='',a.value='',n.value=''},totalTags:C,totalCategories:N,uncategorizedCount:V}}),qo=['title'],Jo={class:'ball-emoji'},Zo={key:1,class:'acu-issue-badge'},Qo=(0,p.defineComponent)({__name:'FloatingBall',setup(e,{expose:t}){const a=Ea(),o=ea(),n=Ee(),r=(0,p.computed)(()=>o.hasIntegrityIssues),l=(0,p.computed)(()=>r.value?o.getIntegritySummary():''),i=(0,p.computed)(()=>n.appearance),c=(0,p.computed)(()=>{const e=i.value;return'image'===e.type&&e.content?{backgroundImage:`url('${e.content}')`,backgroundPosition:`${e.imageOffsetX??50}% ${e.imageOffsetY??50}%`,backgroundSize:`${e.imageScale??150}%`,backgroundRepeat:'no-repeat'}:{}}),s=(0,p.ref)(!1);let u=null;const d=(0,p.computed)(()=>({docked:v.value,'has-issues':r.value,'ai-notify':s.value,'anim-ripple':s.value&&'ripple'===i.value.notifyAnimation,'anim-arc':s.value&&'arc'===i.value.notifyAnimation})),m=(0,p.computed)(()=>{const e=i.value;return{'--ball-size':`${e.size}px`,'--ball-border-color':e.borderColor,'--ball-border-color-rgba':ht(e.borderColor,e.borderOpacity),'--ball-bg-color':ht(e.bgColor,e.bgOpacity),...w.value}});function f(){const e=window.parent&&window.parent!==window?window.parent:window;return{width:e.innerWidth,height:e.innerHeight}}const g=(0,p.ref)(),v=(0,p.ref)(!1);let b=null;const h=function(){const{height:e}=f();return{x:20,y:e-150}}(),{x,y,style:w,isDragging:k,wasDragging:C}=mo(g,{initialX:h.x,initialY:h.y,edgePadding:10,elementWidth:(0,p.computed)(()=>i.value.size).value,useParentWindow:!0,onPositionChange:(e,t)=>{console.info('[ACU FloatingBall] 位置已保存:',e,t)}});function N(e){return console.log('[ACU FloatingBall] handleClick, wasDragging:',C.value,'isDragging:',k.value),C.value?(C.value=!1,e.stopPropagation(),void console.log('[ACU FloatingBall] 忽略拖拽后的点击')):v.value?(v.value=!1,void e.stopPropagation()):void(b?(clearTimeout(b),b=null,v.value=!0,console.info('[ACU FloatingBall] 双击 - 进入停靠模式')):b=setTimeout(()=>{b=null,a.openPanel(),console.info('[ACU FloatingBall] 单击 - 打开面板')},250))}var V,E,B;return V='resize',E=()=>{const{width:e,height:t}=f(),a=i.value.size,o=10;let n=!1;x.value>e-a-o&&(x.value=e-a-o,n=!0),y.value>t-a-o&&(y.value=t-a-o,n=!0),x.value<o&&(x.value=o,n=!0),y.value<o&&(y.value=o,n=!0),n&&console.info('[ACU FloatingBall] 窗口大小变化，位置已调整')},j(window.parent&&window.parent!==window?window.parent:window,V,E,B),(0,p.onMounted)(()=>{n.loadFromGlobalVariables()}),(0,p.onUnmounted)(()=>{b&&clearTimeout(b),u&&clearTimeout(u)}),t({resetPosition:()=>{const e=(window.parent?.innerHeight??window.innerHeight)-150;x.value=20,y.value=e},setDocked:e=>{v.value=e},triggerAiNotify:function(e=3e3){u&&clearTimeout(u),s.value=!0,u=setTimeout(()=>{s.value=!1,u=null},e)},getAppearance:()=>i.value}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{ref_key:'ballRef',ref:g,class:(0,p.normalizeClass)(['acu-floating-ball-vue',d.value]),style:(0,p.normalizeStyle)(m.value),title:r.value?l.value:'点击打开面板',onClick:N},[(0,p.createCommentVNode)(' 图标内容 - 根据类型动态渲染 '),v.value?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createCommentVNode)(' FontAwesome 图标 '),'icon'===i.value.type?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(['fa-solid',i.value.content])},null,2)):'emoji'===i.value.type?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' Emoji '),(0,p.createElementVNode)('span',Jo,(0,p.toDisplayString)(i.value.content),1)],2112)):'image'===i.value.type&&i.value.content?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 图片 - 使用 div + background-image 支持裁剪参数 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['ball-image',{'ball-image-invert':i.value.imageInvert}]),style:(0,p.normalizeStyle)(c.value)},null,6)],2112)):(0,p.createCommentVNode)('v-if',!0)],64)),(0,p.createCommentVNode)(' 问题徽章 '),r.value&&!v.value?((0,p.openBlock)(),(0,p.createElementBlock)('span',Zo,'!')):(0,p.createCommentVNode)('v-if',!0)],14,qo))}}),en={class:'popup-buttons-grid'},tn=['title','onClick'],an=(0,p.defineComponent)({__name:'HiddenButtonsPopup',props:{visible:{type:Boolean},buttons:{},isPinned:{type:Boolean,default:!1}},emits:['close','button-click'],setup(e,{emit:t}){const a=e,o=t,n=e=>{const t=[];return'purge'===e&&t.push('btn-danger'),'pin'===e&&(t.push('btn-toggle'),a.isPinned&&t.push('active')),t};return(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'hidden-popup'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-hidden-buttons-popup',onClick:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('div',en,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.buttons,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:(0,p.normalizeClass)(['popup-button',n(e.id)]),title:e.label,onClick:(0,p.withModifiers)(t=>{return a=e.id,o('button-click',a),void o('close');var a},['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fa-solid',e.icon])},null,2)],10,tn))),128))])])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}});d(186);var on=d(946);const nn=(0,on.A)(an,[['__scopeId','data-v-5d2fcd0e']]),rn={class:'acu-panel-content'},ln={class:'acu-nav-actions-area'},cn=['title','onClick','onMousedown','onTouchstartPassive'],sn={key:0,class:'secondary-indicator'},un=['title','onClick'],dn={key:0,class:'acu-action-btn-wrapper'},pn='acu_win_config',mn=(0,p.defineComponent)({__name:'MainPanel',props:{title:{default:'ACU 可视化表格'},theme:{default:'retro'},layout:{default:'vertical'},isCollapsed:{type:Boolean,default:!1},isPinned:{type:Boolean,default:!1},isContentHidden:{type:Boolean,default:!1},lockPanel:{type:Boolean,default:!1},hasChanges:{type:Boolean,default:!1},panelType:{default:'normal'}},emits:['refresh','save','save-as','undo','manual-update','purge','settings','open-native','toggle-pin','toggle','close','hide-content','height-change','width-change','collapse-tab'],setup(e,{expose:t,emit:a}){const o=e,n=a,r=Ea(),l=(It(),Ve()),i=['save','refresh','settings','pin','toggle'],c=(0,p.computed)(()=>{let e=l.config.buttonOrder||be.map(e=>e.id);const t=l.config.visibleButtons?.length>0?[...l.config.visibleButtons]:[...i];if(l.config.collapseTabBar){if(t.includes('collapseTab')||t.push('collapseTab'),!e.includes('collapseTab')){const t=e.indexOf('settings');e=t>=0?[...e.slice(0,t),'collapseTab',...e.slice(t)]:[...e,'collapseTab']}}else{const e=t.indexOf('collapseTab');e>-1&&t.splice(e,1)}return console.info('[ACU MainPanel] 计算可见按钮:',{order:e,visibleIds:t,collapseTabBar:l.config.collapseTabBar}),e.map(e=>be.find(t=>t.id===e)).filter(e=>!!e&&t.includes(e.id))}),s=(0,p.computed)(()=>l.hiddenButtons),u=(0,p.computed)(()=>l.hasHiddenButtons),d=(0,p.ref)(!1),m=()=>{d.value=!d.value},f=e=>{d.value=!1,B(e)},g=(0,p.ref)(!1),v=e=>{const t=[];return'purge'===e&&t.push('acu-btn-danger'),'pin'===e&&(t.push('acu-btn-toggle'),o.isPinned&&t.push('active')),'save'===e&&o.hasChanges&&t.push('has-changes'),'refresh'===e&&g.value&&t.push('refreshing'),t},b=e=>{const t={};return'purge'===e&&(t.color='#e74c3c'),'pin'===e&&o.isPinned&&(t.color='var(--acu-title-color)',t.borderColor='var(--acu-title-color)',t.background='var(--acu-btn-hover)'),t};let h=null;const x=(0,p.ref)(!1),y=(0,p.ref)(null),w=e=>l.getSecondaryButtonId(e),k=e=>{const t=be.find(t=>t.id===e);return t?.icon||'fa-circle'},C=e=>{const t=be.find(t=>t.id===e);return t?.label||e},N=e=>{const t=C(e),a=w(e);if(a){return`${t} (长按: ${C(a)})`}return t},V=e=>{const t=w(e);console.log('[ACU MainPanel] startLongPress:',e,'secondaryId:',t,'groups:',l.buttonGroups),t?(x.value=!1,h=setTimeout(()=>{x.value=!0,console.log('[ACU MainPanel] Long press triggered for:',e,'directExec:',l.longPressDirectExec),l.longPressDirectExec?(console.log('[ACU MainPanel] Direct exec:',t),B(t)):(console.log('[ACU MainPanel] Popup button:',t),y.value=e,setTimeout(()=>{y.value===e&&(y.value=null)},3e3))},600)):console.log('[ACU MainPanel] No secondary button for:',e)},E=()=>{h&&(clearTimeout(h),h=null)},B=e=>{switch(e){case'save':n('save');break;case'saveAs':n('save-as');break;case'undo':n('undo');break;case'refresh':n('refresh');break;case'manualUpdate':n('manual-update');break;case'purge':n('purge');break;case'pin':n('toggle-pin');break;case'toggle':n('toggle');break;case'director':r.directorDialog=!0;break;case'settings':n('settings');break;case'openNative':n('open-native');break;case'collapseTab':n('collapse-tab');break;default:console.warn(`[MainPanel] 未知的动作 ID: ${e}`)}},S=(0,p.ref)(),T=(0,p.ref)(),D=(0,p.ref)(),A=(0,p.ref)(),I={width:400,left:'50%',bottom:'50%',isCentered:!0};let U=null,M=!1;try{const e=localStorage.getItem(pn);U=e?JSON.parse(e):null}catch(e){U=null}U?!U.isCentered&&'number'==typeof U.bottom&&U.bottom<100&&(M=!0,console.warn('[ACU MainPanel] 检测到无效位置配置 (bottom='+U.bottom+')，重置为居中')):(M=!0,console.info('[ACU MainPanel] 首次加载，设置默认居中配置')),M&&(localStorage.setItem(pn,JSON.stringify(I)),localStorage.removeItem('acu_active_tab'),console.info('[ACU MainPanel] 居中模式：清除 activeTab，只显示导航栏'));const L=te(pn,I);function P(){return function(){const e='ontouchstart'in window||navigator.maxTouchPoints>0,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),a=window.innerWidth<768;return e&&(t||a)}()?l.config.mobileSafeAreaBottom??50:0}function F(){const e=L.value,{width:t,height:a}={width:window.parent?.innerWidth??window.innerWidth,height:window.parent?.innerHeight??window.innerHeight};if(console.info('[ACU MainPanel] 验证面板位置:',JSON.stringify(e),'parentHeight:',a),!e||void 0===e.left||void 0===e.bottom)return console.warn('[ACU MainPanel] 配置不完整，重置为居中模式'),void(L.value={width:e?.width||400,left:'50%',bottom:'50%',isCentered:!0});if(e.isCentered)return void('50%'===e.left&&'50%'===e.bottom||(console.warn('[ACU MainPanel] 居中模式下位置异常，修正为 50%'),L.value={...e,left:'50%',bottom:'50%'}));let o=!1,n=!1,r=e.left;const l=e.bottom,i=P(),c=Math.max(i,50);if('number'==typeof e.bottom?e.bottom<c?(console.warn(`[ACU MainPanel] 底部位置异常 (${e.bottom}px < ${c}px)，重置为居中模式`),n=!0):e.bottom>a-50&&(console.warn(`[ACU MainPanel] 顶部位置异常 (${e.bottom}px > ${a-50}px)，重置为居中模式`),n=!0):'50%'!==e.bottom&&(console.warn('[ACU MainPanel] 非居中模式下 bottom 格式无效，重置为居中模式'),n=!0),'number'==typeof e.left){const a=t-50;e.left<-200?(r=-200,o=!0):e.left>a&&(r=Math.max(0,a),o=!0)}else'50%'!==e.left&&(console.warn('[ACU MainPanel] 非居中模式下 left 格式无效，重置为居中模式'),n=!0);if(n)return L.value={width:e.width||400,left:'50%',bottom:'50%',isCentered:!0},void console.info('[ACU MainPanel] 面板已重置为居中模式');o&&(console.info('[ACU MainPanel] 面板位置越界，已自动修正'),L.value={...e,left:r,bottom:l})}function R(e){if(o.lockPanel)return;if(e.target.closest('.acu-resize-handle, .acu-slider, input'))return;if(0!==e.button)return;const t=D.value;if(!t||!S.value)return;const a=e.clientX,n=e.clientY,r=S.value.getBoundingClientRect(),l=r.left,i=window.parent?.innerHeight??window.innerHeight,c=i-r.bottom;let s=!1,u=!1;const d=e=>{const t=e.originalEvent,o=t.clientX-a,r=t.clientY-n;if(!s&&(Math.abs(o)>5||Math.abs(r)>5)&&(s=!0,u=!0,L.value.isCentered=!1),s){e.preventDefault();let t=l+o,a=c-r;const n=window.parent?.innerWidth??window.innerWidth,s=P(),u=n-50,d=i-50;t<-200&&(t=-200),t>u&&(t=u),a<s&&(a=s),a>d&&(a=d),L.value.left=t,L.value.bottom=a}},p=()=>{if($('body').off('pointermove',d),$('body').off('pointerup',p),u){const e=a=>{a.stopPropagation(),a.preventDefault(),t.removeEventListener('click',e,!0)};t.addEventListener('click',e,!0),console.info('[ACU MainPanel] 面板位置已更新')}};$('body').on('pointermove',d),$('body').on('pointerup',p)}(0,p.watchEffect)(()=>{if(!S.value)return;let e=L.value;e||(e={width:400,left:'50%',bottom:'50%',isCentered:!0});const t=S.value;if(e.width&&t.style.setProperty('--acu-win-width',`${e.width}px`),void 0!==e.left){const a='number'==typeof e.left?`${e.left}px`:e.left;t.style.setProperty('--acu-win-left',a)}if(void 0!==e.bottom){const a='number'==typeof e.bottom?`${e.bottom}px`:e.bottom;t.style.setProperty('--acu-win-bottom',a)}e.isCentered?(t.style.setProperty('--acu-win-left','50%'),t.style.removeProperty('--acu-win-bottom'),t.style.transform='translate(-50%, -50%)'):t.style.transform='none'});const O=(0,p.ref)(),H=(0,p.ref)(!1),W=(0,p.ref)(0),G=(0,p.computed)(()=>o.panelType),Y=(0,p.computed)(()=>l.config.showPagination);(0,p.onMounted)(()=>{F();const e=D.value;e&&(e.addEventListener('pointerdown',R),console.info('[ACU MainPanel] 导航栏拖拽事件已绑定'));const t=A.value;t&&(t.addEventListener('pointerdown',q),console.info('[ACU MainPanel] 宽度调节事件已绑定'))}),(0,p.onUnmounted)(()=>{const e=D.value;e&&e.removeEventListener('pointerdown',R);const t=A.value;t&&t.removeEventListener('pointerdown',q)}),j(window.parent??window,'resize',()=>{F()});const{height:X,recalculate:K}=function(e,t,a,o={}){const{minHeight:n=200,maxHeightRatio:r=.8,headerHeight:l=42,paginationHeight:i=56,contentPadding:c=25,onHeightChange:s}=o,u=(0,p.ref)(n),d=()=>window.parent&&window.parent!==window?window.parent.innerHeight:window.innerHeight,m=()=>d()*r,f=()=>'string'==typeof t?t:t.value,g=()=>'boolean'==typeof a?a:a.value;ae(e,e=>{const t=e[0];if(!t)return;if('dashboard'===f()){const e=m();return console.info('[ACU useSmartHeight] 仪表盘高度计算:',{maxH:e,parentHeight:d(),ratio:r}),u.value=e,void s?.(e)}const a=t.contentRect.height,o=g()?i:0,p=l+a+c+o,v=m(),b=Math.max(n,Math.min(p,v));u.value=b,s?.(b)}),'string'!=typeof t&&(0,p.watch)(t,e=>{if('dashboard'===e){const e=m();console.info('[ACU useSmartHeight] 切换到仪表盘，设置高度:',e),u.value=e,s?.(e)}}),'boolean'!=typeof a&&(0,p.watch)(a,()=>{if(e.value){const t=e.value.scrollHeight;if('dashboard'!==f()){const e=g()?i:0,a=l+t+c+e,o=m(),r=Math.max(n,Math.min(a,o));u.value=r,s?.(r)}}});const v=(0,p.computed)(()=>({height:`${u.value}px`,maxHeight:`${m()}px`}));return{height:u,heightStyle:v,maxHeight:(0,p.computed)(()=>m()),reset:()=>{u.value=n,s?.(n)},maximize:()=>{const e=m();u.value=e,s?.(e)},recalculate:()=>{if(e.value)if('dashboard'===f()){const e=m();u.value=e,s?.(e)}else{const t=e.value.scrollHeight,a=g()?i:0,o=l+t+c+a,r=m(),d=Math.max(n,Math.min(o,r));u.value=d,s?.(d)}}}}(O,G,Y,{minHeight:200,maxHeightRatio:.8,headerHeight:42,paginationHeight:56,contentPadding:25,onHeightChange:e=>{!H.value&&T.value&&(W.value=e,n('height-change',e))}});function q(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();if(!A.value||!S.value)return;const t=e.clientX,a=S.value.getBoundingClientRect().width,o=e=>{const o=e.originalEvent.clientX-t;let r=a+o;const l=(window.parent?.innerWidth??window.innerWidth)-10;r<300&&(r=300),r>l&&(r=l),L.value.width=r,n('width-change',r)},r=()=>{$('body').off('pointermove',o),$('body').off('pointerup',r),console.info('[ACU MainPanel] 宽度已更新:',L.value.width)};$('body').on('pointermove',o),$('body').on('pointerup',r)}return t({getPanelElement:()=>S.value,getDataAreaElement:()=>T.value,getCurrentHeight:()=>W.value,resetPosition:()=>{L.value={width:400,left:'50%',bottom:'50%',isCentered:!0}},exitCenteredMode:()=>{if(!L.value.isCentered)return;const e=window.parent?.innerWidth??window.innerWidth;L.value={...L.value,isCentered:!1,bottom:'number'==typeof L.value.bottom&&L.value.bottom>=50?L.value.bottom:100,left:'number'==typeof L.value.left?L.value.left:e/2-200},console.info('[ACU MainPanel] 退出居中模式，切换到底部定位')},resetHeight:()=>{T.value&&(H.value=!1,T.value.style.height='',T.value.style.minHeight='',T.value.style.maxHeight='',setTimeout(()=>{requestAnimationFrame(()=>{if(!T.value)return;const e=window.parent?.innerHeight??window.innerHeight,t=D.value,a=e-(t?t.offsetHeight:0)-20,o=T.value.querySelector('.acu-relationship-graph');if(o){const e=a;return T.value.style.height=`${e}px`,W.value=e,console.info(`[ACU] 关系图高度重置: 强制最大高度 ${e}`),void n('height-change',e)}const r='horizontal'===l.config.layout;let i;if(r){const e=T.value.querySelector('.acu-cards-container');if(e){const t=e.querySelectorAll('.acu-data-card');let a=0;t.forEach(e=>{const t=e.scrollHeight;t>a&&(a=t)});const o=T.value.querySelector('.acu-table-toolbar'),n=T.value.querySelector('.acu-pagination-container'),r=o?o.offsetHeight:0,l=n?n.offsetHeight:0,c=window.getComputedStyle(e),s=parseFloat(c.paddingTop)+parseFloat(c.paddingBottom);i=a+r+l+s,console.info(`[ACU] 横向布局高度计算: maxCard=${a}, toolbar=${r}, pagination=${l}, padding=${s}`)}else i=T.value.scrollHeight}else{const e=T.value.querySelector('.acu-panel-content');if(e){const t=e.firstElementChild;i=t?t.offsetHeight+20:e.scrollHeight}else i=T.value.scrollHeight}const c=Math.min(a,Math.max(200,i)),s=r&&T.value.querySelector('.acu-cards-container');if(o||s)T.value.style.height=`${c}px`,W.value=c,console.info(`[ACU] 高度已重置(Fixed): natural=${i}, max=${a}, final=${c}, horizontal=${r}`),n('height-change',c);else{T.value.style.height='';const e=T.value.offsetHeight;W.value=e,console.info(`[ACU] 高度已重置(Auto): actual=${e}, horizontal=${r}`),n('height-change',e)}})},50))},recalculateHeight:K}),(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{ref_key:'panelRef',ref:S,class:(0,p.normalizeClass)(['acu-wrapper',[`acu-theme-${e.theme}`,`acu-layout-${e.layout}`,{collapsed:e.isCollapsed,pinned:e.isPinned,'acu-centered-mode':(0,p.unref)(L).isCentered}]])},[(0,p.createCommentVNode)(' 1. 数据显示区（放在最前面） '),(0,p.createElementVNode)('div',{ref_key:'dataAreaRef',ref:T,class:(0,p.normalizeClass)(['acu-data-display',{visible:!e.isContentHidden,'acu-layout-horizontal':'horizontal'===e.layout,'acu-layout-vertical':'vertical'===e.layout}])},[(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',rn,[(0,p.renderSlot)(t.$slots,'default')])],2),(0,p.createCommentVNode)(' 2. 宽度调节把手 '),(0,p.createCommentVNode)(' 注意：事件绑定在 onMounted 中手动进行，避免跨 iframe 生产构建事件绑定失效 '),e.lockPanel?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,ref_key:'resizeHandleRef',ref:A,class:'acu-resize-handle'},null,512)),(0,p.createCommentVNode)(' 3. 导航容器（放在最后，显示在底部） '),(0,p.createCommentVNode)(' 注意：拖拽事件绑定在 onMounted 中手动进行 '),(0,p.createElementVNode)('div',{ref_key:'navContainerRef',ref:D,class:(0,p.normalizeClass)(['acu-nav-container',{'acu-locked':e.lockPanel}])},[(0,p.createCommentVNode)(' Tab 区域 (由 slot 提供，TabBar 自带 .acu-nav-tabs-area) '),(0,p.renderSlot)(t.$slots,'tabs'),(0,p.createCommentVNode)(' 分隔线 '),a[2]||(a[2]=(0,p.createElementVNode)('div',{class:'acu-nav-separator'},null,-1)),(0,p.createCommentVNode)(' 动作按钮区（横排） '),(0,p.createElementVNode)('div',ln,[(0,p.createCommentVNode)(' 常规按钮（始终显示） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(c.value,e=>{return(0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-action-btn-wrapper'},[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-action-btn',v(e.id)]),title:N(e.id),style:(0,p.normalizeStyle)(b(e.id)),onClick:(0,p.withModifiers)(t=>{return a=e.id,void(x.value?x.value=!1:('refresh'===a&&(g.value=!0,setTimeout(()=>{g.value=!1},1e3)),B(a)));var a},['stop']),onMousedown:(0,p.withModifiers)(t=>V(e.id),['stop']),onMouseup:(0,p.withModifiers)(E,['stop']),onMouseleave:E,onTouchstartPassive:(0,p.withModifiers)(t=>V(e.id),['stop']),onTouchend:(0,p.withModifiers)(E,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fa-solid',e.icon])},null,2),(0,p.createCommentVNode)(' 附属按钮指示点 '),(t=e.id,null!==w(t)?((0,p.openBlock)(),(0,p.createElementBlock)('span',sn)):(0,p.createCommentVNode)('v-if',!0))],46,cn),(0,p.createCommentVNode)(' 长按弹出的附属按钮 '),(0,p.createVNode)(p.Transition,{name:'popup'},{default:(0,p.withCtx)(()=>[y.value===e.id&&w(e.id)?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-action-btn acu-popup-btn',title:C(w(e.id)),onClick:(0,p.withModifiers)(t=>(e=>{const t=w(e);t&&B(t),y.value=null})(e.id),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fa-solid',k(w(e.id))])},null,2)],8,un)):(0,p.createCommentVNode)('v-if',!0)]),_:2},1024)]);var t}),128)),(0,p.createCommentVNode)(' 更多按钮（仅当有隐藏按钮时显示） '),u.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',dn,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-action-btn acu-more-btn',{active:d.value}]),title:'更多按钮',onClick:(0,p.withModifiers)(m,['stop'])},[...a[1]||(a[1]=[(0,p.createElementVNode)('i',{class:'fa-solid fa-chevron-up'},null,-1)])],2)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 隐藏按钮浮窗（放在 actions-area 内，贴着 action 按钮显示） '),(0,p.createVNode)(nn,{visible:d.value,buttons:s.value,'is-pinned':e.isPinned,onClose:a[0]||(a[0]=e=>d.value=!1),onButtonClick:f},null,8,['visible','buttons','is-pinned']),(0,p.createCommentVNode)(' Tab浮窗（放在 actions-area 内，贴着 action 按钮显示） '),(0,p.renderSlot)(t.$slots,'tabs-popup')])],2)],2))}}),fn=mn,gn={class:'acu-tab-bar'},vn=['title','draggable','onClick','onDragstart','onDragover','onDrop'],bn=(0,p.defineComponent)({__name:'TabBar',props:{tabs:{},activeTab:{},showDashboard:{type:Boolean,default:!0},hasOptionsTabs:{type:Boolean,default:!1},hasRelationshipGraph:{type:Boolean,default:!1},isEditingOrder:{type:Boolean,default:!1},gridColumns:{default:'repeat(auto-fill, minmax(90px, 1fr))'}},emits:['tab-change','order-change','exit-editing'],setup(e,{expose:t,emit:a}){const o=e,n=a,r=Ea(),l=ea(),i=(0,p.ref)([]);function c(e){return e===ka||e===Ca||e===Na}const s=(0,p.computed)(()=>{const e=r.visibleTabs;if(!e||0===e.length){const e=[];return o.showDashboard&&e.push({id:ka,name:'仪表盘',icon:'fas fa-home'}),e.push(...i.value),o.hasRelationshipGraph&&e.push({id:Na,name:'关系图',icon:'fas fa-project-diagram'}),o.hasOptionsTabs&&e.push({id:Ca,name:'选项',icon:'fas fa-sliders-h'}),e}return e.map(e=>function(e){return e===ka?{id:ka,name:'仪表盘',icon:'fas fa-home'}:e===Na?{id:Na,name:'关系图',icon:'fas fa-project-diagram'}:e===Ca?{id:Ca,name:'选项',icon:'fas fa-sliders-h'}:i.value.find(t=>t.id===e)}(e)).filter(e=>!!e&&(!(e.id===ka&&!o.showDashboard)&&(!(e.id===Na&&!o.hasRelationshipGraph)&&!(e.id===Ca&&!o.hasOptionsTabs))))});function u(e){return l.hasTableIssues(e)}function d(e){if(u(e.name)){return`⚠️ 发现 ${l.getTableIssues(e.name).length} 个问题`}return e.name}let m=null,f=null;(0,p.watch)(()=>o.tabs,e=>{i.value=[...e]},{immediate:!0,deep:!0});const g=()=>{n('exit-editing')},v=e=>{e.target.classList.remove('dragging'),m=null,f=null};return t({getCurrentOrder:()=>i.value.map(e=>e.id),getVisibleTabs:()=>s.value.map(e=>e.id)}),(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',gn,[(0,p.createCommentVNode)(' 排序提示 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-order-controls',{visible:e.isEditingOrder}])},[(0,p.createElementVNode)('span',null,[a[1]||(a[1]=(0,p.createElementVNode)('i',{class:'fas fa-info-circle'},null,-1)),a[2]||(a[2]=(0,p.createTextVNode)(' 拖拽调整顺序，完成后点击 ',-1)),(0,p.createElementVNode)('button',{class:'acu-order-done-btn',onClick:g},[...a[0]||(a[0]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1),(0,p.createTextVNode)(' 完成',-1)])])])],2),(0,p.createCommentVNode)(' Tab 网格区域 '),(0,p.createElementVNode)('div',{class:'acu-nav-tabs-area',style:(0,p.normalizeStyle)({'--acu-nav-cols':e.gridColumns})},[(0,p.createCommentVNode)(' 统一 Tab 列表（包含仪表盘、普通表格、选项面板） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(s.value,t=>{return(0,p.openBlock)(),(0,p.createElementBlock)('button',{key:t.id,class:(0,p.normalizeClass)(['acu-nav-btn',{active:e.activeTab===t.id,'drag-handle':e.isEditingOrder,'has-issues':!c(t.id)&&u(t.name),'has-ai-changes':!c(t.id)&&!u(t.name)&&(a=t.name,l.hasTableAiChanges(a))}]),title:d(t),draggable:e.isEditingOrder,onClick:(0,p.withModifiers)(e=>{return a=t.id,void(o.isEditingOrder||n('tab-change',a));var a},['stop']),onDragstart:e=>((e,t)=>{o.isEditingOrder?(m=t,e.dataTransfer&&(e.dataTransfer.effectAllowed='move',e.dataTransfer.setData('text/plain',t.id)),e.target.classList.add('dragging')):e.preventDefault()})(e,t),onDragover:(0,p.withModifiers)(e=>((e,t)=>{o.isEditingOrder&&m&&(e.preventDefault(),f=t)})(e,t),['prevent']),onDrop:e=>((e,t)=>{if(!o.isEditingOrder||!m)return;e.preventDefault();const a=i.value.findIndex(e=>e.id===m.id),r=i.value.findIndex(e=>e.id===t.id);if(-1!==a&&-1!==r&&a!==r){const[e]=i.value.splice(a,1);i.value.splice(r,0,e),n('order-change',i.value.map(e=>e.id))}m=null,f=null})(e,t),onDragend:v},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(t.icon||(0,p.unref)(Va)(t.name))},null,2),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(t.name),1)],42,vn);var a}),128))],4)]))}}),hn=(0,p.defineComponent)({__name:'Badge',props:{value:{},type:{default:'default'}},setup(e){const t=e,a=(0,p.computed)(()=>{if('default'!==t.type)return t.type;const e=String(t.value);return/Lv\.?\s*\d+/i.test(e)?'level':/\d+(\.\d+)?%/.test(e)?'percent':'男'===e?'male':'女'===e?'female':/^[+-]?\d+(\.\d+)?$/.test(e.trim())?'number':'default'}),o=(0,p.computed)(()=>{const e=a.value;return['primary','secondary','outline','outline-primary'].includes(e),`acu-badge-${e}`}),n=(0,p.computed)(()=>{const e=t.value;return null==e||''===e?'-':String(e)});return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{class:(0,p.normalizeClass)(['acu-badge',o.value])},(0,p.toDisplayString)(n.value),3))}}),xn=(0,p.defineComponent)({__name:'InlineEditor',props:{value:{},minHeight:{default:24}},emits:['save','cancel'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(String(a.value)),l=(0,p.ref)(!1),i=(0,p.ref)(!1),c=()=>{const e=window.getSelection();i.value=null!==e&&e.toString().length>0},s=()=>{const e=n.value;if(!e)return;const t=e.offsetHeight,o=e.style.visibility;e.style.visibility='hidden',e.style.height='0px';const r=e.scrollHeight,l=Math.max(r,a.minHeight);e.style.visibility=o,e.style.height=l===t&&t>0?`${t}px`:`${l}px`};(0,p.watch)(r,()=>{(0,p.nextTick)(s)});const u=()=>{if(l.value)return;l.value=!0;const e=String(a.value);r.value!==e?o('save',r.value):o('cancel')},d=e=>{'Escape'===e.key?(e.preventDefault(),e.stopPropagation(),l.value=!0,o('cancel')):'Enter'!==e.key||e.shiftKey||(e.preventDefault(),e.stopPropagation(),u())},m=e=>{e.stopPropagation()},f=e=>{c(),i.value,e.stopPropagation()};return(0,p.onMounted)(()=>{(0,p.nextTick)(()=>{const e=n.value;if(!e)return;const t=e.scrollHeight,o=Math.max(t,a.minHeight);e.style.height=`${o}px`,e.focus();const r=e.value.length;e.setSelectionRange(r,r)}),document.addEventListener('selectionchange',c)}),(0,p.onBeforeUnmount)(()=>{document.removeEventListener('selectionchange',c)}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:'acu-inline-editor',onClick:t[5]||(t[5]=(0,p.withModifiers)(()=>{},['stop'])),onMousedown:t[6]||(t[6]=(0,p.withModifiers)(()=>{},['stop'])),onPointerdown:t[7]||(t[7]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{ref_key:'textareaRef',ref:n,'onUpdate:modelValue':t[0]||(t[0]=e=>r.value=e),class:'acu-edit-textarea',onBlur:u,onKeydown:d,onClick:t[1]||(t[1]=(0,p.withModifiers)(()=>{},['stop'])),onMousedown:t[2]||(t[2]=(0,p.withModifiers)(()=>{},['stop'])),onPointerdown:t[3]||(t[3]=(0,p.withModifiers)(()=>{},['stop'])),onTouchstart:m,onTouchmove:f,onTouchend:t[4]||(t[4]=(0,p.withModifiers)(()=>{},['stop']))},null,544),[[p.vModelText,r.value]])],32))}}),yn={key:0,class:'acu-card-header'},wn={key:0,class:'acu-card-index'},kn={key:0,class:'fas fa-lock acu-title-lock-icon'},Cn={key:4,class:'acu-history-btns'},Nn=['disabled'],Vn={class:'acu-card-main-grid'},En=['onClick'],Bn={class:'acu-grid-label'},Sn={class:'acu-grid-value'},Tn={key:0,class:'fas fa-lock acu-lock-icon'},Dn={key:0,class:'acu-card-full-area'},An=['onClick'],zn={class:'acu-full-label'},In={class:'acu-full-value'},_n={key:1},Un={key:0,class:'fas fa-lock acu-lock-icon'},Mn={class:'acu-card-body'},Ln=['onClick'],$n={class:'acu-card-label'},Pn={class:'acu-card-value'},Fn={key:0,class:'fas fa-lock acu-lock-icon'},jn={class:'acu-pull-icon'},Rn={class:'acu-pull-text'},On={key:3,class:'acu-stamp-delete'},Hn=(0,p.defineComponent)({__name:'DataCard',props:{data:{},tableId:{},tableName:{},isChanged:{type:Boolean,default:!1},layout:{default:'vertical'},viewMode:{default:'card'},showIndex:{type:Boolean,default:!0},showHeader:{type:Boolean,default:!0},titleColIndex:{default:1},showHistoryButton:{type:Boolean,default:!0},customHighlights:{default:void 0},allowEdit:{type:Boolean,default:!0}},emits:['cellClick','insertRow','toggleDelete','contextMenu','showHistory'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(null),l=(0,p.ref)(!1),i=ea(),c=Ea(),s=It(),u=Ot(),d=(0,p.ref)(),m=(0,p.ref)(),f=(0,p.ref)(),g=(0,p.ref)(),{isMobile:v}=po(),b=(0,p.ref)(!1),h=(0,p.ref)(null),x=(0,p.computed)(()=>`${a.tableName}-row-${a.data.index}`),y=(0,p.computed)(()=>i.pendingDeletes.has(x.value)),w=(0,p.computed)(()=>a.titleColIndex>=0&&a.data.cells.length>a.titleColIndex?a.data.cells[a.titleColIndex]:null),k=(0,p.computed)(()=>{let e=a.data.cells.filter((_,e)=>e>0);return a.showHeader&&w.value&&a.titleColIndex>0&&(e=e.filter((_,e)=>e+1!==a.titleColIndex)),e}),C=e=>{const t=String(e.value),a=e.key.toLowerCase();return t.length>50||a.includes('描述')||a.includes('说明')||a.includes('备注')||a.includes('内容')||a.includes('detail')||a.includes('description')},N=(0,p.computed)(()=>k.value.filter(e=>!C(e))),V=(0,p.computed)(()=>k.value.filter(e=>C(e))),E=(0,p.computed)(()=>{const e=a.data.cells.map(e=>e.key),t=a.data.cells.map(e=>String(e.value??''));return s.getRowKey(a.tableName,t,e,a.data.index)}),B=(0,p.computed)(()=>{if(!c.isLockEditMode)return!1;const e=E.value;return!!e&&s.isRowLockedPending(a.tableName,e)}),S=(0,p.computed)(()=>{if(!c.isLockEditMode||!w.value)return!1;const e=E.value;return!!e&&s.isCellLockedPending(a.tableName,e,w.value.key)});function T(e){if(a.customHighlights?.has(e))return{'acu-cell-changed':!0,'acu-cell-changed-manual':!0};const t=`${a.tableName}-${a.data.index}-${e}`,o=i.getCellChangeType(t);return{'acu-cell-changed':null!==o,'acu-cell-changed-manual':'manual'===o,'acu-cell-changed-ai':'ai'===o}}const D=(0,p.computed)(()=>{const e=i.getRowChangeType(a.tableName,a.data.index,a.data.cells.length);return'manual'===e?'acu-highlight-changed acu-highlight-manual':'ai'===e?'acu-highlight-changed acu-highlight-ai':''}),{isSelecting:A,shouldBlockInteraction:I,wasSelecting:U}=function(){const{text:e}=oe(),t=(0,p.computed)(()=>e.value.length>0),a=(0,p.ref)(!1),o=(0,p.ref)(null);return(0,p.watch)(t,e=>{!e&&a.value?o.value=setTimeout(()=>{a.value=!1},100):e&&(a.value=!0,o.value&&(clearTimeout(o.value),o.value=null))}),{selectedText:e,isSelecting:t,wasSelecting:(0,p.computed)(()=>a.value),shouldBlockInteraction:()=>t.value||a.value,clearSelection:()=>{const e=window.getSelection();e&&e.removeAllRanges()}}}(),{isSwiping:M,gestureType:L,atStart:P,atEnd:F,checkScrollEdge:j,lengthX:R,lengthY:O}=function(e,t){const{layout:a,onInsertRow:o,onToggleDelete:n,horizontalThreshold:r=50,verticalThreshold:l=40,edgeThreshold:i=5,longPressDelay:c=400,longPressCancelThreshold:s=5}=t,u='horizontal'===a?r:l,{text:d}=oe(),m=(0,p.computed)(()=>d.value.length>0),f=(0,p.ref)(!1),g=(0,p.ref)(!1),v=(0,p.ref)(!1),b=(0,p.ref)(null),h=(0,p.ref)(!1),x=(0,p.ref)(0),y=(0,p.ref)(0),w=(0,p.ref)(0),k=(0,p.ref)(0),C=(0,p.ref)(null),N=(0,p.ref)(!1),V=(0,p.ref)(0),E=(0,p.ref)(0),B=(0,p.ref)(!1),S=(0,p.ref)(0),T=(0,p.ref)(null),D=(0,p.ref)(!1),A=(0,p.ref)(null),I=(0,p.ref)(!1),U=t=>{const o=t?.currentTarget,n=o||e.value;n&&('horizontal'===a?(g.value=n.scrollTop<=i,v.value=n.scrollTop+n.clientHeight>=n.scrollHeight-i):(g.value=n.scrollLeft<=i,v.value=n.scrollLeft+n.clientWidth>=n.scrollWidth-i),f.value=g.value||v.value)},M=()=>{const e=window.getSelection();return!!e&&e.toString().length>0},L=(0,p.computed)(()=>m.value||M()),P=t=>{const o=e.value;if(!o)return;D.value=!1,I.value=!1,b.value=null,C.value=null,N.value=!1,A.value&&(clearTimeout(A.value),A.value=null),M()&&(D.value=!0);const n=t.touches[0];if(x.value=n.clientX,y.value=n.clientY,w.value=0,k.value=0,h.value=!0,'horizontal'===a){const e=o.closest('.acu-data-display');T.value=e,S.value=e?.scrollLeft??0}U(),V.value=o.scrollHeight,E.value=o.clientHeight,B.value=o.scrollHeight<=o.clientHeight+2,A.value=setTimeout(()=>{I.value=!0,D.value=!0},c)},F=t=>{const o=e.value;if(!o||!h.value)return;const n=t.touches[0],r=n.clientX-x.value,l=n.clientY-y.value;w.value=r,k.value=l,(Math.abs(r)>s||Math.abs(l)>s)&&A.value&&(clearTimeout(A.value),A.value=null);const i=M();if(D.value||I.value||i)D.value=!0;else if(U(),!C.value&&(Math.abs(r)>10||Math.abs(l)>10)&&(C.value=Math.abs(r)>Math.abs(l)?'horizontal':'vertical',console.info('[ACU Card] 方向锁定为:',C.value)),'horizontal'===a){const e=o.scrollTop;if(B.value){if(!C.value&&(Math.abs(r)>10||Math.abs(l)>10)&&(C.value=Math.abs(r)>Math.abs(l)?'horizontal':'vertical',console.info('[ACU Card] 短卡片方向锁定为:',C.value)),'horizontal'===C.value)return N.value||(b.value=null),void(T.value&&(T.value.scrollLeft=S.value-r));if('vertical'===C.value||null===C.value&&Math.abs(l)>5){t.cancelable&&t.preventDefault(),t.stopPropagation();const e=l>0?'insert':'delete';.6*Math.abs(l)>30?(b.value=e,N.value=!0):N.value||(b.value=null)}return}if('horizontal'===C.value)return N.value||(b.value=null),void(T.value&&(T.value.scrollLeft=S.value-r));if('vertical'===C.value){const a=o.scrollHeight,n=o.clientHeight,r=l>0&&e<=0;if(r||l<0&&e+n>=a-2){t.cancelable&&t.preventDefault(),t.stopPropagation();const e=r?'insert':'delete';.6*Math.abs(l)>30?(b.value=e,N.value=!0):N.value||(b.value=null)}else N.value||(b.value=null)}}else if('vertical'===a&&Math.abs(r)>Math.abs(l)&&Math.abs(r)>10){t.cancelable&&t.preventDefault(),t.stopPropagation();const e=.7*Math.abs(r);b.value=r>0&&e>28?'delete':r<0&&e>28?'insert':null}},j=t=>{const r=e.value;if(!r)return;A.value&&(clearTimeout(A.value),A.value=null);const l=w.value,i=k.value;if('horizontal'===a&&'horizontal'===C.value)return console.info('[ACU Card TouchEnd] 方向锁定为横向，跳过纵向手势'),h.value=!1,b.value=null,void(N.value=!1);if(console.info('[ACU Card TouchEnd] 开始处理',{layout:a,deltaX:l.toFixed(1),deltaY:i.toFixed(1),threshold:u,isSelectionMode:I.value,hasNativeSelection:M(),shouldBlockClick:D.value,gestureType:b.value}),I.value||M())return console.info('[ACU Card TouchEnd] 选词模式，跳过手势'),D.value=!0,h.value=!1,void(b.value=null);if(D.value)return console.info('[ACU Card TouchEnd] shouldBlockClick 锁定，跳过手势'),h.value=!1,void(b.value=null);if('horizontal'===a){const e=r.scrollTop,t=r.scrollHeight,a=r.clientHeight,l=B.value,c=i>0&&(e<=0||l),s=i<0&&(e+a>=t-2||l);console.info('[ACU Card TouchEnd] 横向布局判定',{scrollTop:e,scrollHeight:t,clientHeight:a,isShortCard:l,isPullDown:c,isPullUp:s,deltaY:i.toFixed(1),threshold:u,应触发新增:c&&i>u,应触发删除:s&&Math.abs(i)>u}),c&&i>u?(console.info('[ACU Card] 下拉触发新增行 (deltaY:',i,')'),o()):s&&Math.abs(i)>u?(console.info('[ACU Card] 上划触发删除切换 (deltaY:',i,')'),n()):console.info('[ACU Card TouchEnd] 横向布局未触发任何操作')}else'vertical'===a&&(console.info('[ACU Card TouchEnd] 纵向布局判定',{deltaX:l.toFixed(1),threshold:u,'应触发删除(右滑)':l>u,'应触发新增(左滑)':l<-u}),l>u?(console.info('[ACU Card] 右滑触发删除切换 (deltaX:',l,')'),n()):l<-u?(console.info('[ACU Card] 左滑触发新增行 (deltaX:',l,')'),o()):console.info('[ACU Card TouchEnd] 纵向布局未触发任何操作'));setTimeout(()=>{b.value=null,N.value=!1},300),h.value=!1};return(0,p.watch)(e,(e,t)=>{t&&(t.removeEventListener('touchstart',P),t.removeEventListener('touchmove',F),t.removeEventListener('touchend',j)),e&&(e.addEventListener('touchstart',P,{passive:!0}),e.addEventListener('touchmove',F,{passive:!1}),e.addEventListener('touchend',j,{passive:!0}),U())},{immediate:!0}),(0,p.onUnmounted)(()=>{const t=e.value;t&&(t.removeEventListener('touchstart',P),t.removeEventListener('touchmove',F),t.removeEventListener('touchend',j)),A.value&&(clearTimeout(A.value),A.value=null)}),{isSelecting:L,scrolledToEdge:f,atStart:g,atEnd:v,isSwiping:h,gestureType:b,checkScrollEdge:U,lengthX:w,lengthY:k,shouldBlockClick:D,isSelectionMode:I}}(n,{layout:a.layout,horizontalThreshold:50,verticalThreshold:40,edgeThreshold:10,onInsertRow:()=>{console.info('[ACU DataCard] 手势触发新增行'),o('insertRow')},onToggleDelete:()=>{console.info('[ACU DataCard] 手势触发切换删除',{isDeleting:y.value}),o('toggleDelete')}}),H=(0,p.computed)(()=>{if('horizontal'!==a.layout)return 0;const e=Math.abs(O?.value||0);return Math.min(.6*e,120)}),W=(0,p.computed)(()=>Math.min(H.value/80,1)),G=(0,p.computed)(()=>{if('vertical'!==a.layout)return 0;const e=Math.abs(R?.value||0);return Math.min(.7*e,120)}),Y=(0,p.computed)(()=>Math.min(G.value/60,1));(0,p.watchEffect)(()=>{d.value&&(d.value.style.height=`${H.value}px`,d.value.style.opacity=String(W.value)),m.value&&(m.value.style.height=`${H.value}px`,m.value.style.opacity=String(W.value))}),(0,p.watchEffect)(()=>{f.value&&(f.value.style.width=`${G.value}px`,f.value.style.opacity=String(Y.value)),g.value&&(g.value.style.width=`${G.value}px`,g.value.style.opacity=String(Y.value))}),(0,p.watch)([P,F],([e,t])=>{v.value&&(e||t)&&(h.value&&clearTimeout(h.value),b.value=!0,h.value=setTimeout(()=>{b.value=!1},2e3))});const X=e=>{j(e)};function K(e){if(!c.isLockEditMode)return{};const t=a.data.cells[e];if(!t)return{};const o=E.value;if(!o)return{};const n=s.isCellLockedPending(a.tableName,o,t.key),r=s.isRowLockedPending(a.tableName,o);return{'acu-cell-locked':n||r,'acu-cell-row-locked':r}}const q=()=>{const e=E.value;if(!e)return void console.warn('[ACU] 无法生成行键，跳过整行锁定');const t=a.data.cells.map(e=>e.key),o=a.data.cells.map(e=>String(e.value??'')),n=s.toggleRowLock(a.tableName,e,t,o);console.info(`[ACU] 整行锁定状态切换: ${e} -> ${n?'锁定':'解锁'}`)},J=e=>{if(I()||U.value)console.info('[ACU] 检测到选词操作或刚结束选词，阻止点击事件');else if(M.value)console.info('[ACU] 滑动中，阻止点击事件');else if(y.value)console.info('[ACU] 待删除行不能编辑');else if(a.allowEdit){if(c.isLockEditMode){const t=a.data.cells[e];if(!t)return;const o=E.value;if(!o)return void console.warn('[ACU] 无法生成行键，跳过锁定操作');const n=String(t.value??''),r=s.toggleCellLock(a.tableName,o,t.key,n);return void console.info(`[ACU] 单元格锁定状态切换: ${t.key} -> ${r?'锁定':'解锁'}`)}r.value=e,o('cellClick',a.data.index,e)}else o('cellClick',a.data.index,e)},Z=()=>{if(!(a.titleColIndex<0)&&w.value)if(y.value)console.info('[ACU] 待删除行不能操作标题');else if(a.allowEdit){if(c.isLockEditMode){const e=E.value;if(!e)return void console.warn('[ACU] 无法生成行键，跳过标题锁定操作');const t=String(w.value.value??''),o=s.toggleCellLock(a.tableName,e,w.value.key,t);return void console.info(`[ACU] 标题锁定状态切换: ${w.value.key} -> ${o?'锁定':'解锁'}`)}console.info('[ACU DataCard] 标题点击，触发编辑 colIndex:',a.titleColIndex),r.value=a.titleColIndex,o('cellClick',a.data.index,a.titleColIndex)}else o('cellClick',a.data.index,a.titleColIndex)},Q=(e,t)=>{i.updateCell(a.tableName,a.data.index,e,t);const o=a.data.cells[e],n=E.value;o&&n&&s.isCellLocked(a.tableName,n,o.key)&&(s.updateLockedValue(a.tableName,n,o.key,t),console.info('[ACU] 同步更新锁定值:',o.key,'->',t)),r.value=null},ee=async()=>{if(!l.value){l.value=!0;try{const e=await u.getSnapshots(a.tableName,a.data.index);if(0===e.length)return void Aa.toast.warning('该行没有历史记录');const t=e[0];let o=0;for(const[e,n]of Object.entries(t.cells)){const t=Number(e),r=a.data.cells[t]?.value;r!==n&&(i.updateCell(a.tableName,a.data.index,t,n,{skipHistory:!0}),o++)}o>0?Aa.toast.success(`已撤回 ${o} 个单元格到上一版本`):Aa.toast.info('当前数据与历史版本相同')}catch(e){console.error('[ACU] 撤回失败:',e),Aa.toast.error('撤回失败')}finally{l.value=!1}}},te=e=>{/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?console.info('[ACU] 移动端不触发右键菜单'):o('contextMenu',e,a.data.index)};return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{ref_key:'cardRef',ref:n,class:(0,p.normalizeClass)(['acu-data-card',[D.value,{'acu-editing-lock':null!==r.value,'acu-style-list':'list'===e.viewMode,'acu-style-card':'card'===e.viewMode,'acu-swiping':(0,p.unref)(M)}]]),onContextmenu:(0,p.withModifiers)(te,['prevent']),onScroll:X},[(0,p.createCommentVNode)(' 横向布局：顶部下拉新增提示（必须在最前面，与原版 prepend 一致） '),(0,p.createCommentVNode)(' 注意：使用 v-show 替代 v-if 保持 DOM 存在，配合 watchEffect 直接操作样式 '),(0,p.withDirectives)((0,p.createElementVNode)('div',{ref_key:'pullTopRef',ref:d,class:'acu-pull-overlay acu-pull-top'},[...a[6]||(a[6]=[(0,p.createElementVNode)('div',{class:'acu-pull-icon'},[(0,p.createElementVNode)('i',{class:'fa-solid fa-plus'}),(0,p.createElementVNode)('span',{class:'acu-pull-text'},'新增一行')],-1)])],512),[[p.vShow,'horizontal'===e.layout&&(0,p.unref)(v)&&'insert'===(0,p.unref)(L)]]),(0,p.createCommentVNode)(' 卡片头部（可选显示索引和标题） '),e.showHeader?((0,p.openBlock)(),(0,p.createElementBlock)('div',yn,[e.showIndex?((0,p.openBlock)(),(0,p.createElementBlock)('span',wn,'#'+(0,p.toDisplayString)(e.data.index+1),1)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 标题编辑模式 '),w.value&&r.value===e.titleColIndex&&!(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createBlock)(xn,{key:1,class:'acu-title-editor',value:w.value.value,onSave:a[0]||(a[0]=t=>Q(e.titleColIndex,t)),onCancel:a[1]||(a[1]=e=>r.value=null)},null,8,['value'])):w.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 标题显示模式 '),(0,p.createElementVNode)('span',{class:(0,p.normalizeClass)(['acu-editable-title',{'acu-title-locked':S.value}]),onClick:Z},[(0,p.createTextVNode)((0,p.toDisplayString)(w.value.value||'未命名')+' ',1),S.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',kn)):(0,p.createCommentVNode)('v-if',!0)],2)],2112)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 行锁定按钮（仅锁定编辑模式显示） '),(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:3,class:(0,p.normalizeClass)(['acu-row-lock-btn',{'acu-row-locked':B.value}]),title:'锁定/解锁整行',onClick:(0,p.withModifiers)(q,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(B.value?'fas fa-lock':'fas fa-lock-open')},null,2)],2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 历史记录按钮组 '),e.showHistoryButton&&!(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createElementBlock)('div',Cn,[(0,p.createCommentVNode)(' 撤回按钮 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-undo-trigger',{'acu-loading':l.value}]),disabled:l.value,title:'撤回到上一版本',onClick:(0,p.withModifiers)(ee,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(l.value?'fas fa-spinner fa-spin':'fas fa-undo')},null,2)],10,Nn),(0,p.createCommentVNode)(' 查看历史按钮 '),(0,p.createElementVNode)('button',{class:'acu-history-trigger',title:'查看历史记录',onClick:a[2]||(a[2]=(0,p.withModifiers)(e=>o('showHistory'),['stop']))},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)])])])):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 卡片内容区 - Card 布局 '),'card'===e.viewMode?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' Card 单元格区域 '),(0,p.createElementVNode)('div',Vn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(N.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.colIndex,class:(0,p.normalizeClass)(['acu-grid-item',[T(e.colIndex),K(e.colIndex)]]),onClick:t=>J(e.colIndex)},[(0,p.createElementVNode)('label',Bn,(0,p.toDisplayString)(e.key),1),(0,p.createElementVNode)('div',Sn,[r.value!==e.colIndex||(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createBlock)(hn,{key:1,value:e.value},null,8,['value'])):((0,p.openBlock)(),(0,p.createBlock)(xn,{key:0,value:e.value,onSave:t=>Q(e.colIndex,t),onCancel:a[3]||(a[3]=e=>r.value=null)},null,8,['value','onSave']))]),(0,p.createCommentVNode)(' 锁定图标（仅锁定编辑模式下显示） '),(0,p.unref)(c).isLockEditMode&&K(e.colIndex)['acu-cell-locked']?((0,p.openBlock)(),(0,p.createElementBlock)('i',Tn)):(0,p.createCommentVNode)('v-if',!0)],10,En))),128))]),(0,p.createCommentVNode)(' Full-Width 单元格区域（长文本） '),V.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Dn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(V.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.colIndex,class:(0,p.normalizeClass)(['acu-full-item',[T(e.colIndex),K(e.colIndex)]]),onClick:t=>J(e.colIndex)},[(0,p.createElementVNode)('label',zn,(0,p.toDisplayString)(e.key),1),(0,p.createElementVNode)('div',In,[r.value!==e.colIndex||(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createElementBlock)('span',_n,(0,p.toDisplayString)(e.value||'-'),1)):((0,p.openBlock)(),(0,p.createBlock)(xn,{key:0,value:e.value,'max-height':300,onSave:t=>Q(e.colIndex,t),onCancel:a[4]||(a[4]=e=>r.value=null)},null,8,['value','onSave']))]),(0,p.createCommentVNode)(' 锁定图标（仅锁定编辑模式下显示） '),(0,p.unref)(c).isLockEditMode&&K(e.colIndex)['acu-cell-locked']?((0,p.openBlock)(),(0,p.createElementBlock)('i',Un)):(0,p.createCommentVNode)('v-if',!0)],10,An))),128))])):(0,p.createCommentVNode)('v-if',!0)],64)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 卡片内容区 - List 布局 '),(0,p.createElementVNode)('div',Mn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(k.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.colIndex,class:(0,p.normalizeClass)(['acu-card-row',[T(e.colIndex),K(e.colIndex)]]),onClick:t=>J(e.colIndex)},[(0,p.createElementVNode)('label',$n,(0,p.toDisplayString)(e.key)+':',1),(0,p.createElementVNode)('div',Pn,[r.value!==e.colIndex||(0,p.unref)(c).isLockEditMode?((0,p.openBlock)(),(0,p.createBlock)(hn,{key:1,value:e.value},null,8,['value'])):((0,p.openBlock)(),(0,p.createBlock)(xn,{key:0,value:e.value,onSave:t=>Q(e.colIndex,t),onCancel:a[5]||(a[5]=e=>r.value=null)},null,8,['value','onSave']))]),(0,p.createCommentVNode)(' 锁定图标（仅锁定编辑模式下显示） '),(0,p.unref)(c).isLockEditMode&&K(e.colIndex)['acu-cell-locked']?((0,p.openBlock)(),(0,p.createElementBlock)('i',Fn)):(0,p.createCommentVNode)('v-if',!0)],10,Ln))),128))])],64)),(0,p.createCommentVNode)(' 横向布局：底部上划删除提示（在内容区域之后，与原版 append 一致） '),(0,p.createCommentVNode)(' 注意：使用 v-show 替代 v-if 保持 DOM 存在，配合 watchEffect 直接操作样式 '),(0,p.withDirectives)((0,p.createElementVNode)('div',{ref_key:'pullBottomRef',ref:m,class:(0,p.normalizeClass)(['acu-pull-overlay acu-pull-bottom',{'acu-pull-restore':y.value}])},[(0,p.createElementVNode)('div',jn,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(y.value?'fa-solid fa-undo':'fa-solid fa-trash')},null,2),(0,p.createElementVNode)('span',Rn,(0,p.toDisplayString)(y.value?'撤销删除':'删除本行'),1)])],2),[[p.vShow,'horizontal'===e.layout&&(0,p.unref)(v)&&'delete'===(0,p.unref)(L)]]),(0,p.createCommentVNode)(' 待删除印章 (圆形印章样式) '),y.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',On,'待删除')):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 竖向布局：左右滑动反馈（与原版 .acu-swipe-overlay 一致） '),(0,p.createCommentVNode)(' 注意：使用 v-show 替代 v-if 保持 DOM 存在，配合 watchEffect 直接操作样式 '),'vertical'===e.layout&&(0,p.unref)(v)?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:4},[(0,p.createCommentVNode)(' 左侧右滑删除提示 '),(0,p.withDirectives)((0,p.createElementVNode)('div',{ref_key:'swipeLeftRef',ref:f,class:(0,p.normalizeClass)(['acu-swipe-overlay acu-swipe-left',{'acu-swipe-restore':y.value}])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(y.value?'fa-solid fa-undo':'fa-solid fa-trash')},null,2)],2),[[p.vShow,'delete'===(0,p.unref)(L)]]),(0,p.createCommentVNode)(' 右侧左滑新增提示 '),(0,p.withDirectives)((0,p.createElementVNode)('div',{ref_key:'swipeRightRef',ref:g,class:'acu-swipe-overlay acu-swipe-right'},[...a[8]||(a[8]=[(0,p.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])],512),[[p.vShow,'insert'===(0,p.unref)(L)]])],64)):(0,p.createCommentVNode)('v-if',!0)],34))}});function Wn(){const e=ua(),t=Ea(),{setHiddenPrompt:a,setupSendIntercept:o,appendPromptToInput:n}=io();function r(t){const a=t.dimensions.map(e=>({dimensionName:e.name,tierName:e.value,prompt:e.prompt})),o=e.config,n=o&&'object'==typeof o&&'value'in o?o.value?.customTemplate:o?.customTemplate;if(n&&n.trim()){let e=n;const a=t.luck.prompt||'',o=t.words.join('、'),r=new Map;t.dimensions.forEach(e=>{e.prompt&&e.prompt.trim()&&r.set(e.name,e.prompt)});const l=new Set;e=e.replace(/\{\{luck\}\}/gi,a),e=e.replace(/\{\{words\}\}/gi,o);for(const[t,a]of r.entries()){const o=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),n=new RegExp(`\\{\\{${o}\\}\\}`,'gi');n.test(e)&&(e=e.replace(n,a),l.add(t))}const i=[];for(const[e,t]of r.entries())l.has(e)||i.push(t);const c=i.join('\n');return e=e.replace(/\{\{dimensions\}\}/gi,c),e}return Io({luck:t.luck,words:t.words,dimensions:a})}return{performDivination:async function(){e.isLoaded||e.loadConfig(),await t.initDivinationSystem(),0===e.categories.length?(console.info('[ACU] 首次抽签，尝试加载词库...'),await e.loadFromWorldbook(),0===e.categories.length&&(console.info('[ACU] 词库为空，尝试从 ACU 表格同步...'),await e.syncFromACU(),await e.loadFromWorldbook())):e.loadFromWorldbook(),0===e.categories.length&&Aa.toast.warning('未找到随机词库。请确保存在名为 "Random" 或 "随机" 的表格。');const n=e.performDivination();if(n){const l=e.config;if('skip'===(l&&'object'==typeof l&&'value'in l?l.value?.flipMode:l?.flipMode)){const e=r(n);a(e),o(),Aa.toast.success('提示词已注入隐藏编辑框')}else t.openDivinationOverlay(n)}else Aa.toast.error('抽签失败，请检查配置')},confirmDivination:function(e,l='reveal'){const i=r(e);'hide'===l?(a(i),o(),Aa.toast.success('提示词已注入隐藏编辑框')):n(i),t.closeDivinationOverlay()}}}const Gn={class:'acu-embedded-options'},Yn={key:0,class:'acu-empty-hint'},Xn={class:'acu-embedded-options-list'},Kn={class:'acu-embedded-option-rows'},qn=['onClick'],Jn={key:0,class:'acu-embedded-option-tags'},Zn={class:'acu-embedded-option-text'},Qn=(0,p.defineComponent)({__name:'EmbeddedOptionsPanel',props:{tables:{}},setup(e){const t=e,{setInput:a}=co(),o=(0,p.computed)(()=>t.tables.filter(e=>e.name.includes('选项')||e.name.toLowerCase().includes('option')));function n(e){return e&&e.rows?e.rows.map(e=>{const t=e.cells;if(0===t.length)return{tags:[],text:''};if(1===t.length)return{tags:[],text:String(t[0].value)};{const e=t.filter(e=>''!==String(e.value).trim());if(0===e.length)return{tags:[],text:''};if(1===e.length)return{tags:[],text:String(e[0].value)};return{tags:e.slice(0,-1).map(e=>String(e.value)),text:String(e[e.length-1].value)}}}):[]}return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Gn,[(0,p.createCommentVNode)(' 空状态 '),0===o.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Yn,[...t[0]||(t[0]=[(0,p.createElementVNode)('i',{class:'fas fa-inbox'},null,-1),(0,p.createTextVNode)(' 未找到名称包含"选项"的表格 ',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 选项表格列表 '),(0,p.createElementVNode)('div',Xn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(o.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-embedded-option-group'},[(0,p.createCommentVNode)(' 选项行列表 '),(0,p.createElementVNode)('div',Kn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n(e),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'acu-embedded-option-row',title:'点击追加',onClick:(0,p.withModifiers)(t=>{var o;(o=e.text).trim()&&a(o.trim())},['stop'])},[(0,p.createCommentVNode)(' 标签区域 (Tag 在上) '),e.tags.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Jn,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.tags,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:t,class:'acu-badge acu-option-tag'},(0,p.toDisplayString)(e),1))),128))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 选项文本 (内容在下) '),(0,p.createElementVNode)('div',Zn,(0,p.toDisplayString)(e.text),1)],8,qn))),128))])]))),128))])],2112))]))}}),er={class:'acu-global-header'},tr={key:0,class:'acu-global-location'},ar={class:'location-path'},or={class:'location-part'},nr={key:0,class:'location-sep'},rr={key:1,class:'acu-global-time-group'},lr={key:0,class:'acu-global-time-primary'},ir={class:'acu-global-time-secondary'},cr={key:0,class:'acu-badge-outline is-highlight'},sr={key:1,class:'acu-badge-outline',title:'上轮时间'},ur={class:'acu-global-body'},dr={key:0,class:'acu-global-item layout-inline'},pr={class:'item-icon'},mr={class:'item-content'},fr={class:'item-label'},gr={class:'item-value'},vr={class:'item-icon'},br={class:'item-content'},hr={class:'item-label'},xr={class:'item-value'},yr={key:1,class:'acu-global-item layout-inline people-group'},wr={class:'item-content'},kr={class:'item-label'},Cr={class:'acu-global-person-list'},Nr={key:0,class:'acu-global-footer'},Vr={class:'acu-global-item layout-block system-notice'},Er={class:'item-icon'},Br={class:'item-content'},Sr={class:'item-label'},Tr={class:'item-value'},Dr=(0,p.defineComponent)({__name:'GlobalStatusWidget',props:{tableData:{},isEditing:{type:Boolean}},setup(e){const t=e,a=(0,p.computed)(()=>t.tableData&&0!==t.tableData.rows.length?t.tableData.rows[0]:null),o=(0,p.computed)(()=>{const e=a.value;if(!e)return null;const t={locationCols:[],timeCols:{current:null,passed:null,last:null},weatherCol:null,peopleCol:null,attributes:[],footer:null};e.cells.forEach(e=>{const a=e.key.toLowerCase();String(e.value||'')&&(['时','time','date','clock'].some(e=>a.includes(e))?['流逝','经过','passed','elapse'].some(e=>a.includes(e))?t.timeCols.passed=e:['上轮','last','prev'].some(e=>a.includes(e))?t.timeCols.last=e:!t.timeCols.current||a.length<t.timeCols.current.key.length?(t.timeCols.current&&t.attributes.push(t.timeCols.current),t.timeCols.current=e):t.attributes.push(e):!['场','地','位置','loc','place','area','zone'].some(e=>a.includes(e))||a.includes('在场')?['天','气','weather','climate'].some(e=>a.includes(e))?t.weatherCol=e:['人','npc','chara','在场','role'].some(e=>a.includes(e))?t.peopleCol=e:t.attributes.push(e):t.locationCols.push(e))});let o=0,n=-1;return t.attributes.forEach((e,t)=>{const a=String(e.value).length;(['系','统','知','sys','info'].some(t=>e.key.toLowerCase().includes(t))||a>30&&a>o)&&(o=a,n=t)}),-1!==n&&(t.footer=t.attributes[n],t.attributes.splice(n,1)),t}),n=(0,p.computed)(()=>{const e=o.value?.locationCols;return e&&0!==e.length?e.sort((e,t)=>e.colIndex-t.colIndex).map(e=>e.value).join(' › '):''}),r=(0,p.computed)(()=>{const e=o.value?.locationCols;return e&&0!==e.length?e.sort((e,t)=>e.colIndex-t.colIndex).map(e=>e.value):[]}),l=(0,p.computed)(()=>({current:o.value?.timeCols.current?.value,passed:o.value?.timeCols.passed?.value,last:o.value?.timeCols.last?.value})),i=(0,p.computed)(()=>{const e=o.value?.weatherCol;return e?{label:e.key,value:String(e.value)}:null});function c(e){const t=e.toLowerCase();return t.includes('晴')||t.includes('sun')||t.includes('clear')?'fa-sun':t.includes('阴')||t.includes('cloud')||t.includes('overcast')?'fa-cloud':t.includes('雨')||t.includes('rain')?'fa-cloud-showers-heavy':t.includes('雪')||t.includes('snow')?'fa-snowflake':t.includes('雷')||t.includes('thunder')||t.includes('storm')?'fa-bolt':t.includes('雾')||t.includes('fog')||t.includes('mist')?'fa-smog':t.includes('风')||t.includes('wind')?'fa-wind':t.includes('台风')||t.includes('hurricane')?'fa-hurricane':'fa-cloud-sun'}const s=(0,p.computed)(()=>o.value?.peopleCol),u=(0,p.computed)(()=>{const e=s.value;return e&&e.value?String(e.value).split(/[,，、/&]/).map(e=>e.trim()).filter(e=>e):[]}),d=(0,p.computed)(()=>o.value?o.value.attributes.map(e=>({key:e.key,value:String(e.value),isLong:String(e.value).length>15})):[]),m=(0,p.computed)(()=>{const e=o.value?.footer;return e?{key:e.key,value:String(e.value)}:null});function f(e){const t=e.toLowerCase();return['金','钱','币','money','gold','coin'].some(e=>t.includes(e))?'fa-coins':['系','统','知','sys','info','notice'].some(e=>t.includes(e))?'fa-bell':['态','state','status','hp','mp'].some(e=>t.includes(e))?'fa-heart-pulse':['级','level','lv','rank'].some(e=>t.includes(e))?'fa-layer-group':'fa-info-circle'}return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-global-widget',{'is-editing':e.isEditing}])},[(0,p.createCommentVNode)(' 头部区域 (Location + Time) '),(0,p.createElementVNode)('div',er,[(0,p.createCommentVNode)(' Location (H1) '),n.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',tr,[a[0]||(a[0]=(0,p.createElementVNode)('i',{class:'fas fa-map-marker-alt'},null,-1)),(0,p.createElementVNode)('div',ar,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:t},[(0,p.createElementVNode)('span',or,(0,p.toDisplayString)(e),1),t<r.value.length-1?((0,p.openBlock)(),(0,p.createElementBlock)('span',nr,'›')):(0,p.createCommentVNode)('v-if',!0)],64))),128))])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' Time Group '),l.value.current||l.value.passed||l.value.last?((0,p.openBlock)(),(0,p.createElementBlock)('div',rr,[(0,p.createCommentVNode)(' Current Time '),l.value.current?((0,p.openBlock)(),(0,p.createElementBlock)('div',lr,[a[1]||(a[1]=(0,p.createElementVNode)('i',{class:'fas fa-clock'},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(l.value.current),1)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' Secondary Times '),(0,p.createElementVNode)('div',ir,[(0,p.createCommentVNode)(' Passed Time Badge '),l.value.passed?((0,p.openBlock)(),(0,p.createElementBlock)('span',cr,[a[2]||(a[2]=(0,p.createElementVNode)('i',{class:'fas fa-hourglass-half'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(l.value.passed),1)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' Last Time '),l.value.last?((0,p.openBlock)(),(0,p.createElementBlock)('span',sr,[a[3]||(a[3]=(0,p.createElementVNode)('i',{class:'fas fa-history'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(l.value.last),1)])):(0,p.createCommentVNode)('v-if',!0)])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 内容区域 (Body) '),(0,p.createElementVNode)('div',ur,[(0,p.createCommentVNode)(' 天气模块 '),i.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',dr,[(0,p.createElementVNode)('div',pr,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',c(i.value.value)])},null,2)]),(0,p.createElementVNode)('div',mr,[(0,p.createElementVNode)('div',fr,(0,p.toDisplayString)(i.value.label),1),(0,p.createElementVNode)('div',gr,(0,p.toDisplayString)(i.value.value),1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 其他属性 (流式排版) '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(d.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.key,class:(0,p.normalizeClass)(['acu-global-item',e.isLong?'layout-block':'layout-inline'])},[(0,p.createElementVNode)('div',vr,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',f(e.key)])},null,2)]),(0,p.createElementVNode)('div',br,[(0,p.createElementVNode)('div',hr,(0,p.toDisplayString)(e.key),1),(0,p.createElementVNode)('div',xr,(0,p.toDisplayString)(e.value),1)])],2))),128)),(0,p.createCommentVNode)(' 人物列表 (Tag Group) '),s.value&&u.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',yr,[a[4]||(a[4]=(0,p.createElementVNode)('div',{class:'item-icon'},[(0,p.createElementVNode)('i',{class:'fas fa-users'})],-1)),(0,p.createElementVNode)('div',wr,[(0,p.createElementVNode)('div',kr,(0,p.toDisplayString)(s.value.key),1),(0,p.createElementVNode)('div',Cr,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(u.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'person-tag'},(0,p.toDisplayString)(e),1))),128))])])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 底部区域 (Footer: System Notice / Long Text) '),m.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Nr,[(0,p.createElementVNode)('div',Vr,[(0,p.createElementVNode)('div',Er,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',f(m.value.key)])},null,2)]),(0,p.createElementVNode)('div',Br,[(0,p.createElementVNode)('div',Sr,(0,p.toDisplayString)(m.value.key),1),(0,p.createElementVNode)('div',Tr,(0,p.toDisplayString)(m.value.value),1)])])])):(0,p.createCommentVNode)('v-if',!0)],2))}}),Ar={class:'acu-switch-list'},zr={class:'acu-switch-list-header'},Ir=['onClick'],_r={class:'item-label'},Ur={key:0,class:'item-badge'},Mr=['checked','onChange'],Lr={key:0,class:'acu-switch-list-empty'},$r={class:'acu-switch-list-footer'},Pr={key:0,class:'empty-hint'},Fr=(0,p.defineComponent)({__name:'SwitchList',props:{modelValue:{},items:{},maxHeight:{default:'280px'},emptyText:{default:'暂无数据'},footerTemplate:{default:'已选择: {selected}/{total}'},emptyHint:{default:''}},emits:['update:modelValue'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.computed)(()=>0!==a.items.length&&a.modelValue.length===a.items.length),r=(0,p.computed)(()=>a.footerTemplate.replace('{selected}',String(a.modelValue.length)).replace('{total}',String(a.items.length)));function l(e){return a.modelValue.includes(e)}function i(e){const t=[...a.modelValue],n=t.indexOf(e);-1===n?t.push(e):t.splice(n,1),o('update:modelValue',t)}function c(){n.value?o('update:modelValue',[]):o('update:modelValue',a.items.map(e=>e.key))}function s(){o('update:modelValue',[])}return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Ar,[(0,p.createCommentVNode)(' 头部按钮区 '),(0,p.createElementVNode)('div',zr,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-quick-select-btn',{active:n.value}]),onClick:(0,p.withModifiers)(c,['stop'])},[...a[1]||(a[1]=[(0,p.createElementVNode)('i',{class:'fas fa-check-double'},null,-1),(0,p.createTextVNode)(' 全选 ',-1)])],2),(0,p.createElementVNode)('button',{class:'acu-quick-select-btn',onClick:(0,p.withModifiers)(s,['stop'])},[...a[2]||(a[2]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1),(0,p.createTextVNode)(' 清空 ',-1)])])]),(0,p.createCommentVNode)(' 滚动列表区 '),(0,p.createElementVNode)('div',{class:'acu-switch-list-body',style:(0,p.normalizeStyle)({maxHeight:e.maxHeight})},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.items,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.key,class:(0,p.normalizeClass)(['acu-switch-list-item',[e.class,{'is-selected':l(e.key)}]]),onClick:t=>i(e.key)},[(0,p.createElementVNode)('span',_r,[(0,p.createTextVNode)((0,p.toDisplayString)(e.label)+' ',1),e.badge?((0,p.openBlock)(),(0,p.createElementBlock)('span',Ur,(0,p.toDisplayString)(e.badge),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('label',{class:'acu-switch small',onClick:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('input',{type:'checkbox',checked:l(e.key),onChange:t=>i(e.key)},null,40,Mr),a[3]||(a[3]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])],10,Ir))),128)),0===e.items.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Lr,[a[4]||(a[4]=(0,p.createElementVNode)('i',{class:'fas fa-inbox'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(e.emptyText),1)])):(0,p.createCommentVNode)('v-if',!0)],4),(0,p.createCommentVNode)(' 底部统计区 '),(0,p.createElementVNode)('div',$r,[(0,p.createTextVNode)((0,p.toDisplayString)(r.value)+' ',1),0===e.modelValue.length&&e.emptyHint?((0,p.openBlock)(),(0,p.createElementBlock)('span',Pr,(0,p.toDisplayString)(e.emptyHint),1)):(0,p.createCommentVNode)('v-if',!0)])]))}}),jr={class:'acu-modal-header'},Rr={class:'acu-modal-body'},Or={class:'acu-add-table-tabs'},Hr={key:0,class:'acu-add-table-paste'},Wr={class:'acu-add-table-file'},Gr={class:'acu-file-label'},Yr={key:2,class:'acu-add-table-error'},Xr={key:3,class:'acu-add-table-list'},Kr={class:'acu-modal-footer'},qr=['disabled'],Jr=(0,p.defineComponent)({__name:'AddTableDialog',props:{visible:{type:Boolean}},emits:['update:visible','confirm'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)('paste'),r=(0,p.ref)(''),l=(0,p.ref)(''),i=(0,p.ref)(''),c=(0,p.ref)([]),s=(0,p.ref)([]),u=(0,p.ref)(),d=(0,p.computed)(()=>c.value.map(e=>({key:e.key,label:e.template.name})));function m(){if(i.value='',c.value=[],s.value=[],r.value.trim())try{g(JSON.parse(r.value))}catch(e){i.value=`JSON 解析失败: ${e instanceof Error?e.message:String(e)}`}else i.value='请输入 JSON 内容'}function f(e){const t=e.target,a=t.files?.[0];if(!a)return;l.value=a.name,i.value='',c.value=[],s.value=[];const o=new FileReader;o.onload=e=>{try{const t=e.target?.result;g(JSON.parse(t))}catch(e){i.value=`文件解析失败: ${e instanceof Error?e.message:String(e)}`}},o.onerror=()=>{i.value='文件读取失败'},o.readAsText(a)}function g(e){if(!e||'object'!=typeof e)return void(i.value='无效的 JSON 格式');const t=[];for(const a of Object.keys(e)){if(!a.startsWith('sheet_'))continue;const o=e[a];o&&'object'==typeof o&&(o.name&&Array.isArray(o.content)?t.push({key:a,template:o}):console.warn(`[ACU] 跳过无效表格: ${a}`))}0!==t.length?(c.value=t,1===t.length&&(s.value=[t[0].key]),Aa.toast.success(`解析成功，找到 ${t.length} 个表格`)):i.value='未找到有效的表格定义 (需要 sheet_xxx 格式的键)'}function v(){o('update:visible',!1)}function b(){if(0===s.value.length)return;const e=c.value.filter(e=>s.value.includes(e.key)).map(e=>e.template);o('confirm',e),v()}return(0,p.watch)(()=>a.visible,e=>{e&&(r.value='',l.value='',i.value='',c.value=[],s.value=[],n.value='paste')}),O(u,()=>{v()}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(v,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:u,class:'acu-modal acu-add-table-modal'},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',jr,[(0,p.createElementVNode)('button',{class:'acu-modal-back',onClick:(0,p.withModifiers)(v,['stop'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-arrow-left'},null,-1)])]),a[5]||(a[5]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'添加表格',-1)),a[6]||(a[6]=(0,p.createElementVNode)('span',null,null,-1))]),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',Rr,[(0,p.createCommentVNode)(' Tab 切换：粘贴 JSON / 导入文件 '),(0,p.createElementVNode)('div',Or,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-tab-btn',{active:'paste'===n.value}]),onClick:a[0]||(a[0]=(0,p.withModifiers)(e=>n.value='paste',['stop']))},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-paste'},null,-1),(0,p.createTextVNode)(' 粘贴 JSON ',-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-tab-btn',{active:'file'===n.value}]),onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>n.value='file',['stop']))},[...a[8]||(a[8]=[(0,p.createElementVNode)('i',{class:'fas fa-file-import'},null,-1),(0,p.createTextVNode)(' 导入文件 ',-1)])],2)]),(0,p.createCommentVNode)(' 粘贴模式 '),'paste'===n.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Hr,[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':a[2]||(a[2]=e=>r.value=e),placeholder:'粘贴表格模板 JSON...',class:'acu-textarea-scrollable',rows:'8'},null,512),[[p.vModelText,r.value]]),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',onClick:(0,p.withModifiers)(m,['stop'])},[...a[9]||(a[9]=[(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1),(0,p.createTextVNode)(' 解析',-1)])])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 文件导入模式 '),(0,p.createElementVNode)('div',Wr,[(0,p.createElementVNode)('label',Gr,[(0,p.createElementVNode)('input',{type:'file',accept:'.json',onChange:f,style:{display:'none'}},null,32),a[10]||(a[10]=(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(l.value||'点击选择 JSON 文件'),1)])])],2112)),(0,p.createCommentVNode)(' 错误提示 '),i.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Yr,[a[11]||(a[11]=(0,p.createElementVNode)('i',{class:'fas fa-exclamation-circle'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(i.value),1)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 解析结果：表格选择列表 '),c.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Xr,[a[12]||(a[12]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-table'}),(0,p.createTextVNode)(' 选择要添加的表格 ')],-1)),(0,p.createVNode)(Fr,{modelValue:s.value,'onUpdate:modelValue':a[3]||(a[3]=e=>s.value=e),items:d.value,'empty-text':'暂无可添加的表格','footer-template':'已选择: {selected}/{total} 个表格'},null,8,['modelValue','items'])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 底部按钮 '),(0,p.createElementVNode)('div',Kr,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(v,['stop'])},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:0===s.value.length,onClick:(0,p.withModifiers)(b,['stop'])},[a[13]||(a[13]=(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)),(0,p.createTextVNode)(' 添加 ('+(0,p.toDisplayString)(s.value.length)+') ',1)],8,qr)])],512)])):(0,p.createCommentVNode)('v-if',!0)}}),Zr={class:'acu-status-board'},Qr={class:'acu-status-board-header'},el={class:'acu-status-board-summary'},tl={class:'acu-status-board-actions'},al={key:0,class:'acu-status-toolbar'},ol=['disabled'],nl=['disabled'],rl=['disabled'],ll=['disabled','title'],il=['disabled'],cl=['title'],sl={class:'acu-status-table-wrapper'},ul={class:'acu-status-table'},dl=['onClick'],pl=['onClick'],ml={class:'acu-status-freq'},fl=['value','onInput'],gl={key:0,class:'acu-status-disabled'},vl={key:1},bl={key:2,class:'acu-status-global-hint'},hl={class:'acu-status-last-update'},xl={key:0},yl={key:1},wl=(0,p.defineComponent)({__name:'TableStatusBoard',emits:['tableClick'],setup(e,{emit:t}){const a=t,o=ea(),n=Ea(),{statusList:r,isLoading:l,currentTotalAiFloors:i,refresh:c,formatLastUpdate:s,getUnrecordedClass:u}=Do(),{purgeTableDataByRange:d}=Qa(),m=(0,p.ref)(!1),f=(0,p.ref)(new Set),g=(0,p.ref)(new Map),v=(0,p.ref)([]),b=(0,p.ref)(!1),h=(0,p.computed)(()=>{if(0===f.value.size)return'disabled';const e=r.value.filter(e=>f.value.has(e.sheetKey)).map(e=>g.value.has(e.sheetKey)?g.value.get(e.sheetKey):e.effectiveFrequency),t=e.every(e=>0===e),a=e.every(e=>0!==e);return t?'enable':a?'disable':'mixed'}),x=(0,p.computed)(()=>g.value.size>0||v.value.length>0);function y(e){const t=o.aiDiffMap;if(!t||0===t.size)return!1;for(const a of t)if(a.startsWith(`${e}-`))return!0;return!1}const w=(0,p.computed)(()=>[...r.value].sort((e,t)=>{const a=y(e.name),o=y(t.name);return a!==o?o?1:-1:e.orderNo-t.orderNo}));function k(){m.value=!1,f.value.clear(),g.value.clear(),v.value=[]}function C(){f.value.size===r.value.length?f.value.clear():r.value.forEach(e=>f.value.add(e.sheetKey))}function N(e){return g.value.has(e.sheetKey)?g.value.get(e.sheetKey):e.updateFrequency}async function V(){await c()}function E(){if(0===f.value.size)return;const e=xt().getDB();if(e?.getTableTemplate)try{const t=e.getTableTemplate();if(!t)return void Aa.toast.error('无法获取当前模板');const a={mate:t.mate||{type:'chatSheets',version:1,updateConfigUiSentinel:-1}};f.value.forEach(e=>{t[e]&&(a[e]=t[e])});const o=JSON.stringify(a,null,2),n=new Blob([o],{type:'application/json'}),r=URL.createObjectURL(n),l=document.createElement('a');l.href=r,l.download=`tables_export_${Date.now()}.json`,l.click(),URL.revokeObjectURL(r),Aa.toast.success(`已导出 ${f.value.size} 个表格`)}catch(e){console.error('[ACU] 导出失败:',e),Aa.toast.error(`导出失败: ${e instanceof Error?e.message:String(e)}`)}else Aa.toast.error('数据库 API 不可用')}async function B(){if(0===f.value.size)return;if(!confirm(`确定要删除选中的 ${f.value.size} 个表格吗？\n\n此操作将：\n1. 从所有聊天记录中清除这些表格的数据\n2. 从模板中移除这些表格的定义\n\n操作不可撤销！`))return;const e=xt().getDB();if(e?.getTableTemplate&&e?.importTemplateFromData)try{Aa.toast.info('正在清除历史数据...');const t=Array.from(f.value),a=await d(t,0,9999999);a.changed&&Aa.toast.success(`已清除 ${a.changedCount} 层历史数据`);const o=e.getTableTemplate();if(!o)return void Aa.toast.error('无法获取当前模板');f.value.forEach(e=>{delete o[e]});const n=await e.importTemplateFromData(o);n.success?(Aa.toast.success(`已删除 ${f.value.size} 个表格定义`),f.value.clear(),await c()):Aa.toast.error(`删除失败: ${n.message}`)}catch(e){console.error('[ACU] 删除表格失败:',e),Aa.toast.error(`删除失败: ${e instanceof Error?e.message:String(e)}`)}else Aa.toast.error('数据库 API 不可用')}function S(){n.openAdvancedPurgeDialog({initialStartFloor:void 0,initialEndFloor:void 0},{onConfirm:async()=>{await c(),f.value.clear()}})}function T(e){v.value.push(...e),Aa.toast.success(`已添加 ${e.length} 个表格到待保存列表`)}function D(){if(0===f.value.size)return;const e=h.value;if('mixed'===e)return;const t='enable'===e?-1:0;f.value.forEach(e=>{g.value.set(e,t)}),Aa.toast.success('enable'===e?'已设置为启用':'已设置为禁用')}function A(e){a('tableClick',e.sheetKey,e.name)}function I(e){var t;m.value?(t=e.sheetKey,f.value.has(t)?f.value.delete(t):f.value.add(t)):A(e)}return(0,p.onMounted)(()=>{c()}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Zr,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Qr,[(0,p.createElementVNode)('span',el,' 共 '+(0,p.toDisplayString)((0,p.unref)(r).length)+' 个表格 · AI楼层 '+(0,p.toDisplayString)((0,p.unref)(i)),1),(0,p.createElementVNode)('div',tl,[(0,p.createCommentVNode)(' 编辑模式工具栏 '),m.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',al,[(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'全选',onClick:(0,p.withModifiers)(C,['stop'])},[...t[4]||(t[4]=[(0,p.createElementVNode)('i',{class:'fas fa-check-double'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',disabled:0===f.value.size,title:'导出',onClick:(0,p.withModifiers)(E,['stop'])},[...t[5]||(t[5]=[(0,p.createElementVNode)('i',{class:'fas fa-file-export'},null,-1)])],8,ol),(0,p.createElementVNode)('button',{class:'acu-tool-btn',disabled:0===f.value.size,title:'删除',onClick:(0,p.withModifiers)(B,['stop'])},[...t[6]||(t[6]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1)])],8,nl),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'添加',onClick:t[0]||(t[0]=(0,p.withModifiers)(e=>b.value=!0,['stop']))},[...t[7]||(t[7]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',disabled:0===f.value.size,title:'清除',onClick:(0,p.withModifiers)(S,['stop'])},[...t[8]||(t[8]=[(0,p.createElementVNode)('i',{class:'fas fa-eraser'},null,-1)])],8,rl),(0,p.createElementVNode)('button',{class:'acu-tool-btn',disabled:'mixed'===h.value||0===f.value.size,title:'enable'===h.value?'启用':'禁用',onClick:(0,p.withModifiers)(D,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas','enable'===h.value?'fa-play':'fa-ban'])},null,2)],8,ll)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 刷新按钮 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',disabled:(0,p.unref)(l),title:'刷新状态',onClick:(0,p.withModifiers)(V,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas fa-redo',{'acu-animate-spin':(0,p.unref)(l)}])},null,2)],8,il),(0,p.createCommentVNode)(' 编辑/保存按钮 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:m.value?'保存':'编辑',onClick:t[1]||(t[1]=(0,p.withModifiers)(e=>m.value?async function(){if(!x.value&&0===g.value.size)return void k();const e=xt().getDB();if(e?.getTableTemplate&&e?.importTemplateFromData)try{const t=e.getTableTemplate();if(!t)return void Aa.toast.error('无法获取当前模板');let a=0;for(const[e,o]of g.value)t[e]?.updateConfig&&(t[e].updateConfig.updateFrequency=o,a++);for(const e of v.value)t[`sheet_${e.uid||Date.now()}_${Math.random().toString(36).slice(2,8)}`]=e,a++;const o=await e.importTemplateFromData(t);o.success?(Aa.toast.success(`保存成功，共 ${a} 项变更`),k(),await c()):Aa.toast.error(`保存失败: ${o.message}`)}catch(e){console.error('[ACU] 保存失败:',e),Aa.toast.error(`保存失败: ${e instanceof Error?e.message:String(e)}`)}else Aa.toast.error('数据库 API 不可用')}():(m.value=!0,void Aa.toast.info('可多选操作')),['stop']))},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',m.value?'fa-check':'fa-edit'])},null,2)],8,cl)])]),(0,p.createCommentVNode)(' 添加表格弹窗 '),(0,p.createVNode)(Jr,{visible:b.value,'onUpdate:visible':t[2]||(t[2]=e=>b.value=e),onConfirm:T},null,8,['visible']),(0,p.createCommentVNode)(' 表格 '),(0,p.createElementVNode)('div',sl,[(0,p.createElementVNode)('table',ul,[t[11]||(t[11]=(0,p.createElementVNode)('thead',null,[(0,p.createElementVNode)('tr',null,[(0,p.createElementVNode)('th',{class:'acu-status-col-name'},'表格名称'),(0,p.createElementVNode)('th',{class:'acu-status-col-freq'},'更新频率'),(0,p.createElementVNode)('th',{class:'acu-status-col-unrecorded'},'未记录楼层'),(0,p.createElementVNode)('th',{class:'acu-status-col-last'},'上次更新')])],-1)),(0,p.createElementVNode)('tbody',null,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(w.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('tr',{key:e.sheetKey,class:(0,p.normalizeClass)({'acu-row-selected':m.value&&f.value.has(e.sheetKey),'acu-highlight-ai':y(e.name)&&!m.value}),onClick:t=>I(e)},[(0,p.createElementVNode)('td',{class:(0,p.normalizeClass)(['acu-status-name',{'acu-highlight-ai':y(e.name)&&!m.value}])},[(0,p.createElementVNode)('span',{style:(0,p.normalizeStyle)({cursor:m.value?'default':'pointer'}),onClick:(0,p.withModifiers)(t=>m.value?null:A(e),['stop'])},(0,p.toDisplayString)(e.name),13,pl)],2),(0,p.createElementVNode)('td',ml,[(0,p.createCommentVNode)(' 编辑模式：显示输入框 '),m.value?((0,p.openBlock)(),(0,p.createElementBlock)('input',{key:0,type:'number',value:N(e),min:'-1',class:'acu-freq-input',onInput:t=>function(e,t){const a=t.target,o=parseInt(a.value,10);isNaN(o)||g.value.set(e,o)}(e.sheetKey,t),onClick:t[3]||(t[3]=(0,p.withModifiers)(()=>{},['stop']))},null,40,fl)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 普通模式：显示文本 '),0===e.effectiveFrequency?((0,p.openBlock)(),(0,p.createElementBlock)('span',gl,'禁用')):((0,p.openBlock)(),(0,p.createElementBlock)('span',vl,(0,p.toDisplayString)(e.effectiveFrequency),1)),-1===e.updateFrequency?((0,p.openBlock)(),(0,p.createElementBlock)('span',bl,'(全局)')):(0,p.createCommentVNode)('v-if',!0)],64))]),(0,p.createElementVNode)('td',{class:(0,p.normalizeClass)(['acu-status-unrecorded',(0,p.unref)(u)(e)])},(0,p.toDisplayString)(e.hasHistory?e.unrecordedFloors:'—'),3),(0,p.createElementVNode)('td',hl,[(0,p.createCommentVNode)(' 显示格式: AI楼层号/实际楼层号 '),(0,p.createTextVNode)(' '+(0,p.toDisplayString)((0,p.unref)(s)(e)),1)])],10,dl))),128)),(0,p.createCommentVNode)(' 空状态 '),0!==(0,p.unref)(r).length||(0,p.unref)(l)?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('tr',xl,[...t[9]||(t[9]=[(0,p.createElementVNode)('td',{colspan:'4',class:'acu-status-empty'},[(0,p.createElementVNode)('i',{class:'fas fa-inbox'}),(0,p.createTextVNode)(' 暂无表格数据 ')],-1)])])),(0,p.createCommentVNode)(' 加载中 '),(0,p.unref)(l)&&0===(0,p.unref)(r).length?((0,p.openBlock)(),(0,p.createElementBlock)('tr',yl,[...t[10]||(t[10]=[(0,p.createElementVNode)('td',{colspan:'4',class:'acu-status-loading'},[(0,p.createElementVNode)('i',{class:'fas fa-spinner fa-spin'}),(0,p.createTextVNode)(' 加载中... ')],-1)])])):(0,p.createCommentVNode)('v-if',!0)])])])]))}}),kl=wl,Cl=['draggable'],Nl={key:0,class:'acu-dash-count'},Vl={class:'acu-dash-actions'},El=['title'],Bl=['title','onClick'],Sl=['onClick'],Tl={class:'acu-dash-npc-text'},Dl=['title','onClick'],Al=['title','onClick'],zl=['title','onClick'],Il={key:1},_l={class:'acu-dash-npc-grid'},Ul=['onClick'],Ml={class:'acu-dash-npc-text'},Ll=['title','onClick'],$l=['title','onClick'],Pl=['title','onClick'],Fl={key:1},jl=['onClick'],Rl={class:'acu-dash-list-text'},Ol=['title','onClick'],Hl=['title','onClick'],Wl=['title','onClick'],Gl={key:1},Yl={class:'acu-dash-list'},Xl=['onClick'],Kl={class:'acu-dash-list-text'},ql=['title','onClick'],Jl=['title','onClick'],Zl=['title','onClick'],Ql={key:1},ei={class:'acu-dash-empty'},ti=(0,p.defineComponent)({__name:'DashboardWidget',props:{config:{},tableData:{},isEditing:{type:Boolean},diffMap:{},aiDiffMap:{},searchTerm:{},allTables:{}},emits:['navigate','row-click','row-edit','action','remove','resize','config-actions','drag-start','drag-end','drop'],setup(e,{emit:t}){const a=Ea(),o=Ko(),{setInput:n}=co(),{performDivination:r}=Wn();(0,p.onMounted)(async()=>{await o.loadLibrary()});const l=e,i=(0,p.ref)(!1);let c=!1;(0,p.watch)(()=>l.isEditing,e=>{e?(c=i.value,i.value=!0):i.value=c},{immediate:!0});const s=t,u=((0,p.computed)(()=>l.tableData?.rows.length??0),(0,p.computed)(()=>v.value.length)),d=(0,p.computed)(()=>l.tableData?.name?l.tableData.name:l.config.title),m=(0,p.computed)(()=>{if(l.config.icon&&'fa-table'!==l.config.icon)return l.config.icon;const e=l.tableData?.name||l.config.title;if(e){return Va(e).replace('fas ','')}return'fa-table'});function f(e){if(!l.tableData||!l.aiDiffMap)return!1;const t=l.tableData.name,a=`${t}-row-${e.index}`;if(l.aiDiffMap.has(a))return!0;for(let a=0;a<e.cells.length;a++){const o=`${t}-${e.index}-${a}`;if(l.aiDiffMap.has(o))return!0}return!1}const g=(0,p.computed)(()=>!(!l.tableData||!l.aiDiffMap)&&l.tableData.rows.some(e=>f(e)));const v=(0,p.computed)(()=>{if(!l.tableData)return[];let e=[...l.tableData.rows];return l.searchTerm&&(e=e.filter(e=>function(e){if(!l.searchTerm)return!1;const t=l.searchTerm.toLowerCase().trim();return!!t&&e.cells.some(e=>String(e.value).toLowerCase().includes(t))}(e))),e.sort((e,t)=>{const a=f(e),o=f(t);return a!==o?o?1:-1:e.index-t.index})}),b=(0,p.computed)(()=>v.value.length>30),{list:h,containerProps:x,wrapperProps:y}=re(v,{itemHeight:32,overscan:5});const{list:w,containerProps:k,wrapperProps:C}=function(e,t=3){const a=(0,p.computed)(()=>function(e,t){const a=[];for(let o=0;o<e.length;o+=t)a.push(e.slice(o,o+t));return a}(e.value,t));return{...re(a,{itemHeight:48,overscan:5}),rowGroups:a}}(v),N=(0,p.computed)(()=>({'acu-dash-body-scrollable':!0})),V=(0,p.computed)(()=>{const e=l.config;return(e?.widgetTagConfig?.displayedTagIds||[]).map(e=>o.getTagById(e)).filter(e=>void 0!==e)}),E=(0,p.computed)(()=>{const e=l.config;return(e?.widgetTagConfig?.displayedCategoryIds||[]).map(e=>o.getCategoryById(e)).filter(e=>void 0!==e)});function B(e){const t=e.path.split('/');return t[t.length-1]}function S(e){return e.icon?e.icon:B(e)}function T(e){return e.startsWith('fa')||e.includes(' fa-')}(0,p.computed)(()=>l.config.actions.filter(e=>'goToTable'!==e));const D=(0,p.computed)(()=>l.config.actions.filter(e=>'goToTable'!==e&&'settings'!==e));function A(e){const{titleColumn:t,displayColumns:a}=l.config;if(t){const a=e.cells.find(e=>e.key.toLowerCase()===t.toLowerCase()||e.key.toLowerCase().includes(t.toLowerCase()));if(a&&a.value)return String(a.value)}if(a.length>0)for(const t of a){const a=e.cells.find(e=>e.key.toLowerCase().includes(t.toLowerCase()));if(a&&a.value)return String(a.value)}const o=e.cells.find(e=>e.value&&String(e.value).trim());return o?String(o.value):`行 ${e.index+1}`}function I(e){if(!l.tableData)return!1;const t=l.tableData.name,a=`${t}-row-${e.index}`;if(l.diffMap.has(a))return!0;for(let a=0;a<e.cells.length;a++){const o=`${t}-${e.index}-${a}`;if(l.diffMap.has(o))return!0}return!1}function U(e){const t=l.config.displayTagColumns;if(!t||0===t.length)return[];const a=[];for(const o of t){const t=e.cells.find(e=>e.key.toLowerCase()===o.toLowerCase()||e.key.toLowerCase().includes(o.toLowerCase()));if(t&&t.value){const e=String(t.value).trim();e&&a.push({column:o,value:e})}}return a}const M=/[,，；;|/]/;function L(e){const t=l.config.interactiveTagConfig;if(!t||0===t.sourceColumns.length)return[];const a=[],o=t.tagDefinitions||[];for(const n of t.sourceColumns){const t=e.cells.find(e=>e.key.toLowerCase()===n.toLowerCase()||e.key.toLowerCase().includes(n.toLowerCase()));if(t&&t.value){const e=String(t.value).trim();if(!e)continue;const n=e.split(M).map(e=>e.trim()).filter(Boolean);for(const e of n){const t=o.find(t=>t.label.toLowerCase()===e.toLowerCase());if(t)a.push({tag:t,value:e,matchedDefinition:!0});else{const t={id:`dynamic_${e}`,label:e,promptTemplate:'{{value}}',isFixed:!1};a.push({tag:t,value:e,matchedDefinition:!1})}}}}return a}function P(e){if(!e.promptTemplate)return e.label;let t=e.promptTemplate;return t=t.replace(/\{\{value\}\}/gi,`[${e.label}]`),t=t.replace(/\{\{rowTitle\}\}/gi,'[行标题]'),t=t.replace(/\{\{playerName\}\}/gi,'[主角名]'),t.length>50?t.substring(0,50)+'...':t}function F(e,t){let a=e.promptTemplate;a=a.replace(/\{\{value\}\}/gi,e.label);const o=A(t);a=a.replace(/\{\{rowTitle\}\}/gi,o);const r=H();a=a.replace(/\{\{playerName\}\}/gi,r);const i=l.tableData?.name||l.config.title||'';a=a.replace(/\{\{tableName\}\}/gi,i),a&&n(a)}function j(e,t){const r=function(e,t){let a=e.promptTemplate;a=a.replace(/\{\{value\}\}/gi,e.label),a=t?.title?a.replace(/\{\{rowTitle\}\}/gi,t.title):a.replace(/\{\{rowTitle\}\}/gi,'');const o=H();a=a.replace(/\{\{playerName\}\}/gi,o);const n=l.tableData?.name||l.config.title||'';return a=a.replace(/\{\{tableName\}\}/gi,n),a.trim()}(e,t),i=o.getCategoryById(e.categoryId),c=!!i&&(i.path.includes('地点')||i.path.includes('Location'));e.allowPreEdit||c?a.openTagPreEditDialog({tagLabel:e.label,resolvedPrompt:r,showCompanions:c,widgetId:l.config.id}):r&&n(r)}function R(e,t){a.openCategorySelectDialog({categoryId:e.id,rowContext:t,widgetId:l.config.id})}function O(e){if(!e.promptTemplate)return e.label;let t=e.promptTemplate;return t=t.replace(/\{\{value\}\}/gi,`[${e.label}]`),t=t.replace(/\{\{rowTitle\}\}/gi,'[行标题]'),t=t.replace(/\{\{playerName\}\}/gi,'[主角名]'),t=t.replace(/\{\{tableName\}\}/gi,'[表格名]'),t.length>50?t.substring(0,50)+'...':t}function H(){const e=window.parent||window;try{const t=e.SillyTavern?.getContext?.();if(t?.name1)return t.name1}catch(e){console.warn('[ACU] 获取主角名失败',e)}return'{{user}}'}function W(){a.openWidgetActionsDialog({widgetId:l.config.id,currentActions:l.config.actions})}function G(e){return $e[e]?.icon??'fa-question'}function Y(e){return $e[e]?.tooltip??e}function X(e){if('settings'===e){const e=l.tableData?.headers??[];return void a.openWidgetSettingsDialog({widgetId:l.config.id,widgetConfig:l.config,tableHeaders:e})}'nativeEdit'!==e?'divination'!==e?s('action',e,l.config.tableId||''):r():function(e){try{const t=(window.parent||window).AutoCardUpdaterAPI;e&&t?.openTableEditor?t.openTableEditor(e):t?.openVisualizer?(t.openVisualizer(),console.info('[ACU] 已打开原生编辑器'),a.isCollapsed=!0):t?.openModal?t.openModal():console.warn('[ACU] 无法打开原生编辑器：API 不可用')}catch(e){console.error('[ACU] 打开原生编辑器失败',e)}}(l.config.tableId)}function K(){l.config.tableId&&s('navigate',l.config.tableId)}function q(e){s('navigate',e)}function J(){!l.isEditing&&l.config.tableId&&s('navigate',l.config.tableId)}function Z(){l.isEditing||(i.value=!i.value)}function Q(e){l.config.tableId&&s('row-edit',l.config.tableId,e)}function ee(e){e.preventDefault();const t=1===l.config.colSpan?2:1;s('resize',l.config.id,t)}function te(e){l.isEditing?(e.dataTransfer?.setData('text/plain',l.config.id),s('drag-start',l.config.id)):e.preventDefault()}function ae(){s('drag-end')}function oe(e){e.preventDefault(),s('drop',l.config.id)}return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-dash-widget',{'acu-dash-widget-wide':2===e.config.colSpan,'acu-dash-widget-editing':e.isEditing,'acu-highlight-ai-table':g.value&&!e.searchTerm}]),draggable:e.isEditing,onDragstart:te,onDragend:ae,onDragover:a[2]||(a[2]=(0,p.withModifiers)(()=>{},['prevent'])),onDrop:oe},[(0,p.createCommentVNode)(' 编辑控件 (仅编辑态显示) '),e.isEditing?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('button',{class:'acu-widget-remove',title:'移除组件',onClick:a[0]||(a[0]=(0,p.withModifiers)(t=>s('remove',e.config.id),['stop']))},[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-widget-config',title:'配置快捷按钮',onClick:(0,p.withModifiers)(W,['stop'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),(0,p.createElementVNode)('div',{class:'acu-widget-resize',title:'拖动改变大小',onMousedown:(0,p.withModifiers)(ee,['stop']),onTouchstart:(0,p.withModifiers)(ee,['stop'])},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-expand-alt'},null,-1)])],32)],64)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 头部 - 点击标题跳转，点击其他区域折叠/展开 '),(0,p.createCommentVNode)(' 全局状态组件在展示态隐藏表头 '),'global'!==e.config.displayStyle||e.isEditing?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:1,class:(0,p.normalizeClass)(['acu-dash-title',{'acu-dash-title-clickable':!e.isEditing}]),style:{'font-size':'1.2em !important'},onClick:Z},[(0,p.createElementVNode)('span',{class:'acu-dash-title-text',onClick:(0,p.withModifiers)(J,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',m.value])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(d.value)+' ',1),u.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',Nl,(0,p.toDisplayString)(u.value),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 按钮区（包含折叠指示器） '),(0,p.createElementVNode)('div',Vl,[(0,p.createCommentVNode)(' 设置按钮常驻 (updateStatus 类型不显示) '),'updateStatus'!==e.config.type?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-icon-btn',title:Y('settings'),onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>X('settings'),['stop']))},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-cog'},null,-1)])],8,El)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 其他配置的快捷按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(D.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e,class:'acu-icon-btn',title:Y(e),onClick:(0,p.withModifiers)(t=>X(e),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',G(e)])},null,2)],8,Bl))),128)),(0,p.createCommentVNode)(' 折叠指示器放在按钮区最右边 '),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas acu-dash-collapse-icon',i.value?'fa-chevron-down':'fa-chevron-up'])},null,2)])],2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 内容区 (可滚动, 可折叠) '),(0,p.withDirectives)((0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-dash-body',N.value])},[(0,p.createCommentVNode)(' 特殊组件: 表格更新状态 '),'updateStatus'===e.config.type?((0,p.openBlock)(),(0,p.createBlock)(kl,{key:0,onTableClick:q})):'optionsPanel'===e.config.type?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 特殊组件: 选项聚合面板 '),(0,p.createVNode)(Qn,{tables:e.allTables??[],onNavigate:K},null,8,['tables'])],64)):'global'===e.config.displayStyle?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 全局状态组件 (无表头，沉浸式) '),(0,p.createVNode)(Dr,{'table-data':e.tableData,'is-editing':e.isEditing},null,8,['table-data','is-editing'])],64)):e.tableData&&v.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:3},[(0,p.createCommentVNode)(' 普通表格组件 '),(0,p.createCommentVNode)(' ============================================================ '),(0,p.createCommentVNode)(' 网格式展示 (NPC风格) - 虚拟滚动版 '),(0,p.createCommentVNode)(' ============================================================ '),'grid'===e.config.displayStyle?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createCommentVNode)(' 虚拟滚动模式 '),b.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',(0,p.mergeProps)({key:0},(0,p.unref)(k),{class:'acu-dash-virtual-container'}),[(0,p.createElementVNode)('div',(0,p.normalizeProps)((0,p.guardReactiveProps)((0,p.unref)(C))),[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(w),({data:t,index:a})=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:a,class:'acu-dash-npc-grid'},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(t,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.key,class:(0,p.normalizeClass)(['acu-dash-npc-item acu-dash-interactive',{'acu-highlight-changed':I(t),'acu-highlight-ai':f(t)&&!e.searchTerm}]),onClick:(0,p.withModifiers)(e=>Q(t),['stop'])},[(0,p.createElementVNode)('span',Tl,(0,p.toDisplayString)(A(t)),1),(0,p.createCommentVNode)(' 展示标签 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(U(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.column,class:'acu-dash-display-tag'},(0,p.toDisplayString)(e.value),1))),128)),(0,p.createCommentVNode)(' 互动标签（旧系统） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(L(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.tag.id,class:(0,p.normalizeClass)(['acu-dash-interactive-tag',{fixed:e.tag.isFixed}]),title:P(e.tag),onClick:(0,p.withModifiers)(a=>F(e.tag,t),['stop'])},(0,p.toDisplayString)(e.value),11,Dl))),128)),(0,p.createCommentVNode)(' 互动标签（新系统 - 从全局标签库） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(V.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:O(e),onClick:(0,p.withModifiers)(a=>j(e,{title:A(t),value:A(t)}),['stop'])},(0,p.toDisplayString)(e.label),9,Al))),128)),(0,p.createCommentVNode)(' 分类按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(E.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-category-btn',title:`点击选择 ${B(e)} 下的标签`,onClick:(0,p.withModifiers)(a=>R(e,{title:A(t),value:A(t)}),['stop'])},[T(S(e))?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(S(e))},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Il,(0,p.toDisplayString)(S(e)),1))],8,zl))),128))],10,Sl))),128))]))),128))],16)],16)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 普通模式（数据量小时不使用虚拟滚动） '),(0,p.createElementVNode)('div',_l,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(v.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.key,class:(0,p.normalizeClass)(['acu-dash-npc-item acu-dash-interactive',{'acu-highlight-changed':I(t),'acu-highlight-ai':f(t)&&!e.searchTerm}]),onClick:(0,p.withModifiers)(e=>Q(t),['stop'])},[(0,p.createElementVNode)('span',Ml,(0,p.toDisplayString)(A(t)),1),(0,p.createCommentVNode)(' 展示标签 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(U(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.column,class:'acu-dash-display-tag'},(0,p.toDisplayString)(e.value),1))),128)),(0,p.createCommentVNode)(' 互动标签（旧系统） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(L(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.tag.id,class:(0,p.normalizeClass)(['acu-dash-interactive-tag',{fixed:e.tag.isFixed}]),title:P(e.tag),onClick:(0,p.withModifiers)(a=>F(e.tag,t),['stop'])},(0,p.toDisplayString)(e.value),11,Ll))),128)),(0,p.createCommentVNode)(' 互动标签（新系统 - 从全局标签库） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(V.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:O(e),onClick:(0,p.withModifiers)(a=>j(e,{title:A(t),value:A(t)}),['stop'])},(0,p.toDisplayString)(e.label),9,$l))),128)),(0,p.createCommentVNode)(' 分类按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(E.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-category-btn',title:`点击选择 ${B(e)} 下的标签`,onClick:(0,p.withModifiers)(a=>R(e,{title:A(t),value:A(t)}),['stop'])},[T(S(e))?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(S(e))},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Fl,(0,p.toDisplayString)(S(e)),1))],8,Pl))),128))],10,Ul))),128))])],2112))],64)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' ============================================================ '),(0,p.createCommentVNode)(' 列表式展示 (任务风格) - 虚拟滚动版 '),(0,p.createCommentVNode)(' ============================================================ '),(0,p.createCommentVNode)(' 虚拟滚动模式 '),b.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',(0,p.mergeProps)({key:0},(0,p.unref)(x),{class:'acu-dash-virtual-container'}),[(0,p.createElementVNode)('div',(0,p.mergeProps)((0,p.unref)(y),{class:'acu-dash-list'}),[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(h),({data:t,index:o})=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.key,class:(0,p.normalizeClass)(['acu-dash-list-item acu-dash-interactive',{'acu-highlight-changed':I(t),'acu-highlight-ai':f(t)&&!e.searchTerm}]),style:(0,p.normalizeStyle)({height:(0,p.unref)(32)+'px'}),onClick:(0,p.withModifiers)(e=>Q(t),['stop'])},[a[7]||(a[7]=(0,p.createElementVNode)('i',{class:'fas fa-circle',style:{'font-size':'6px'}},null,-1)),(0,p.createElementVNode)('span',Rl,(0,p.toDisplayString)(A(t)),1),(0,p.createCommentVNode)(' 展示标签 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(U(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.column,class:'acu-dash-display-tag'},(0,p.toDisplayString)(e.value),1))),128)),(0,p.createCommentVNode)(' 互动标签（旧系统） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(L(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.tag.id,class:(0,p.normalizeClass)(['acu-dash-interactive-tag',{fixed:e.tag.isFixed}]),title:P(e.tag),onClick:(0,p.withModifiers)(a=>F(e.tag,t),['stop'])},(0,p.toDisplayString)(e.value),11,Ol))),128)),(0,p.createCommentVNode)(' 互动标签（新系统 - 从全局标签库） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(V.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:O(e),onClick:(0,p.withModifiers)(a=>j(e,{title:A(t),value:A(t)}),['stop'])},(0,p.toDisplayString)(e.label),9,Hl))),128)),(0,p.createCommentVNode)(' 分类按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(E.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:`点击选择 ${B(e)} 下的标签`,onClick:(0,p.withModifiers)(a=>R(e,{title:A(t),value:A(t)}),['stop'])},[T(S(e))?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(S(e))},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Gl,(0,p.toDisplayString)(S(e)),1))],8,Wl))),128))],14,jl))),128))],16)],16)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 普通模式（数据量小时不使用虚拟滚动） '),(0,p.createElementVNode)('div',Yl,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(v.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.key,class:(0,p.normalizeClass)(['acu-dash-list-item acu-dash-interactive',{'acu-highlight-changed':I(t),'acu-highlight-ai':f(t)&&!e.searchTerm}]),onClick:(0,p.withModifiers)(e=>Q(t),['stop'])},[a[8]||(a[8]=(0,p.createElementVNode)('i',{class:'fas fa-circle',style:{'font-size':'6px'}},null,-1)),(0,p.createElementVNode)('span',Kl,(0,p.toDisplayString)(A(t)),1),(0,p.createCommentVNode)(' 展示标签 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(U(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.column,class:'acu-dash-display-tag'},(0,p.toDisplayString)(e.value),1))),128)),(0,p.createCommentVNode)(' 互动标签（旧系统） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(L(t),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.tag.id,class:(0,p.normalizeClass)(['acu-dash-interactive-tag',{fixed:e.tag.isFixed}]),title:P(e.tag),onClick:(0,p.withModifiers)(a=>F(e.tag,t),['stop'])},(0,p.toDisplayString)(e.value),11,ql))),128)),(0,p.createCommentVNode)(' 互动标签（新系统 - 从全局标签库） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(V.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:O(e),onClick:(0,p.withModifiers)(a=>j(e,{title:A(t),value:A(t)}),['stop'])},(0,p.toDisplayString)(e.label),9,Jl))),128)),(0,p.createCommentVNode)(' 分类按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(E.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-dash-interactive-tag acu-dash-global-tag',title:`点击选择 ${B(e)} 下的标签`,onClick:(0,p.withModifiers)(a=>R(e,{title:A(t),value:A(t)}),['stop'])},[T(S(e))?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(S(e))},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Ql,(0,p.toDisplayString)(S(e)),1))],8,Zl))),128))],10,Xl))),128))])],2112))],64))],64)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:4},[(0,p.createCommentVNode)(' 空状态 '),(0,p.createElementVNode)('div',ei,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.config.icon])},null,2),a[9]||(a[9]=(0,p.createElementVNode)('span',null,'暂无数据',-1))])],2112))],2),[[p.vShow,!i.value]])],42,Cl))}});function ai(){const e=Ko(),t=Ve(),{success:a}=(0,Aa.d)();function o(t){try{if(!t||t.length<5)return!1;const a=String(t[1]||'').trim(),o=String(t[2]||'').trim(),n=String(t[3]||'').trim(),r=String(t[4]||'').trim(),l=t[5]?String(t[5]).trim():'';if(!o||!r)return!1;let i=l||r;const c=function(){const e=window.parent||window;try{const t=e.SillyTavern?.getContext?.();if(t?.name1)return t.name1}catch(e){console.warn('[InteractionImporter] 获取主角名失败',e)}return''}();c&&(i=i.split(c).join('{{user}}')),a&&(i=i.split(a).join('{{rowTitle}}'));const s=i,u=function(t){if(!t)return'';const a=e.getCategoryByPath(t);if(a)return a.id;const o=1===t.split('/').length?'fa-star':void 0;return e.addCategory(t,o).id}(n),d=e.library.tags.find(e=>e.label===o&&e.categoryId===u);return d?e.upsertTag({...d,promptTemplate:s}):e.createTag(o,u,s),!0}catch(e){return console.error('[InteractionImporter] Import row failed:',e),!1}}return{importFromRow:o,importAll:function(e,n=!1){if(n&&!t.config.autoImportInteractions)return 0;let r=0;return e&&Array.isArray(e)?(e.forEach(e=>{o(e)&&r++}),r>0&&a(`成功导入 ${r} 个交互动作`),r):0}}}const oi=['draggable'],ni={key:0,class:'acu-dash-count'},ri={key:0,class:'acu-dash-actions'},li=['title'],ii={class:'acu-dash-body acu-dash-body-scrollable'},ci={key:0,class:'acu-interaction-list'},si=['onClick'],ui={class:'acu-interaction-header'},di={class:'acu-interaction-target'},pi={class:'acu-interaction-actions'},mi=['onClick'],fi=['title','disabled','onClick'],gi={class:'acu-interaction-meta'},vi={class:'acu-badge acu-badge-primary'},bi={class:'acu-badge acu-badge-secondary'},hi={key:0,class:'acu-badge acu-badge-secondary'},xi={class:'acu-interaction-text'},yi={class:'acu-dash-empty'},wi=(0,p.defineComponent)({__name:'InteractionTableWidget',props:{config:{},tableData:{},isEditing:{type:Boolean},diffMap:{},aiDiffMap:{},searchTerm:{}},emits:['navigate','row-edit','action','remove','resize','drag-start','drag-end','drop'],setup(e,{emit:t}){const{setInput:a}=co(),{importFromRow:o,importAll:n}=ai(),{success:r,error:l}=(0,Aa.d)(),i=Ea(),c=e,s=t,u=(0,p.ref)(!1),d=(0,p.ref)(new Set),m=((0,p.computed)(()=>c.tableData?.rows.length??0),(0,p.computed)(()=>b.value.length)),f=(0,p.computed)(()=>c.tableData?.name||c.config.title),g=(0,p.computed)(()=>{if(c.config.icon&&'fa-table'!==c.config.icon)return c.config.icon;const e=c.tableData?.name||c.config.title;if(e){return Va(e).replace('fas ','')}return'fa-table'}),v=(0,p.computed)(()=>!(!c.tableData||!c.aiDiffMap)&&c.tableData.rows.some(e=>y(e))),b=(0,p.computed)(()=>{if(!c.tableData)return[];let e=[...c.tableData.rows];if(c.searchTerm){const t=c.searchTerm.toLowerCase().trim();e=e.filter(e=>e.cells.some(e=>String(e.value).toLowerCase().includes(t)))}return e});function h(e,t){const a=e.cells.find(e=>e.key===t);return a?String(a.value):''}function x(e){if(!c.tableData)return!1;const t=`${c.tableData.name}-row-${e.index}`;return c.diffMap.has(t)}function y(e){if(!c.tableData||!c.aiDiffMap)return!1;const t=`${c.tableData.name}-row-${e.index}`;return c.aiDiffMap.has(t)}function w(e){return d.value.has(e.key)}function k(e){c.isEditing||e.target.closest('.acu-dash-actions')||(u.value=!u.value)}function C(){c.isEditing||c.config.tableId&&s('navigate',c.config.tableId)}function N(){s('drag-start',c.config.id)}function V(){s('drag-end')}function E(){s('drop',c.config.id)}function B(){i.openWidgetActionsDialog({widgetId:c.config.id,currentActions:c.config.actions})}function S(e){e.preventDefault();const t=1===c.config.colSpan?2:1;s('resize',c.config.id,t)}function T(){if(!c.tableData)return;const e=c.tableData.rows.map(e=>[null,h(e,'交互对象'),h(e,'交互名称'),h(e,'交互类型'),h(e,'交互内容'),h(e,'交互简介')]);n(e)>0&&c.tableData.rows.forEach(e=>d.value.add(e.key))}(0,p.watch)(()=>c.aiDiffMap,e=>{if(!e||!c.tableData)return;if(c.tableData.rows.some(t=>{const a=`${c.tableData.name}-row-${t.index}`;return e.has(a)})){const e=c.tableData.rows.map(e=>[null,h(e,'交互对象'),h(e,'交互名称'),h(e,'交互类型'),h(e,'交互内容'),h(e,'交互简介')]);n(e,!0)>0&&c.tableData.rows.forEach(e=>d.value.add(e.key))}},{deep:!0});let D=!1;return(0,p.watch)(()=>c.isEditing,e=>{e?(D=u.value,u.value=!0):u.value=D},{immediate:!0}),(t,n)=>{return(0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-dash-widget',{'acu-dash-widget-wide':2===e.config.colSpan,'acu-dash-widget-editing':e.isEditing,'acu-highlight-ai-table':v.value&&!e.searchTerm}]),draggable:e.isEditing,onDragstart:N,onDragend:V,onDragover:n[2]||(n[2]=(0,p.withModifiers)(()=>{},['prevent'])),onDrop:E},[(0,p.createCommentVNode)(' 编辑控件 (仅编辑态显示) '),e.isEditing?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('button',{class:'acu-widget-remove',title:'移除组件',onClick:n[0]||(n[0]=(0,p.withModifiers)(t=>s('remove',e.config.id),['stop']))},[...n[3]||(n[3]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-widget-config',title:'配置快捷按钮',onClick:(0,p.withModifiers)(B,['stop'])},[...n[4]||(n[4]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),(0,p.createElementVNode)('div',{class:'acu-widget-resize',title:'拖动改变大小',onMousedown:(0,p.withModifiers)(S,['stop']),onTouchstart:(0,p.withModifiers)(S,['stop'])},[...n[5]||(n[5]=[(0,p.createElementVNode)('i',{class:'fas fa-expand-alt'},null,-1)])],32)],64)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-dash-title',{'acu-dash-title-clickable':!e.isEditing}]),onClick:k},[(0,p.createElementVNode)('span',{class:'acu-dash-title-text',onClick:(0,p.withModifiers)(C,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',g.value])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(f.value)+' ',1),m.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',ni,(0,p.toDisplayString)(m.value),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 按钮区 '),e.isEditing?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',ri,[(0,p.createCommentVNode)(' 全部存入按钮 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:'将所有交互存入标签库',onClick:(0,p.withModifiers)(T,['stop'])},[...n[6]||(n[6]=[(0,p.createElementVNode)('i',{class:'fas fa-save'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:(D='settings',$e[D]?.tooltip||''),onClick:n[1]||(n[1]=(0,p.withModifiers)(e=>function(e){if('settings'===e){const e=c.tableData?.headers??[];return void i.openWidgetSettingsDialog({widgetId:c.config.id,widgetConfig:c.config,tableHeaders:e})}c.config.tableId&&s('action',e,c.config.tableId)}('settings'),['stop']))},[...n[7]||(n[7]=[(0,p.createElementVNode)('i',{class:'fas fa-cog'},null,-1)])],8,li),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas acu-dash-collapse-icon',u.value?'fa-chevron-down':'fa-chevron-up'])},null,2)]))],2),(0,p.createCommentVNode)(' 内容区 '),(0,p.withDirectives)((0,p.createElementVNode)('div',ii,[b.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',ci,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(b.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.key,class:(0,p.normalizeClass)(['acu-interaction-item',{'acu-highlight-changed':x(t),'acu-highlight-ai':y(t)&&!e.searchTerm}]),onClick:e=>function(e){c.isEditing||c.config.tableId&&s('row-edit',c.config.tableId,e)}(t)},[(0,p.createCommentVNode)(' 第一行：交互对象 + 按钮 '),(0,p.createElementVNode)('div',ui,[(0,p.createElementVNode)('span',di,(0,p.toDisplayString)(h(t,'交互对象')),1),(0,p.createElementVNode)('div',pi,[(0,p.createCommentVNode)(' 追加到输入框 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:'追加到输入框',onClick:(0,p.withModifiers)(e=>async function(e){const t=h(e,'交互内容');t&&(a(t),r('已追加到输入框'))}(t),['stop'])},[...n[8]||(n[8]=[(0,p.createElementVNode)('i',{class:'fas fa-reply'},null,-1)])],8,mi),(0,p.createCommentVNode)(' 单条存入 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-icon-btn',{'acu-btn-success':w(t)}]),title:w(t)?'已存入':'存入标签库',disabled:w(t),onClick:(0,p.withModifiers)(e=>function(e){const t=h(e,'交互对象'),a=h(e,'交互名称'),n=h(e,'交互类型'),i=h(e,'交互内容'),c=h(e,'交互简介');o([null,t,a,n,i,c])?(d.value.add(e.key),r('已存入标签库')):l('存入失败，数据不完整')}(t),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',w(t)?'fa-check':'fa-download'])},null,2)],10,fi)])]),(0,p.createCommentVNode)(' 第二行：Badge '),(0,p.createElementVNode)('div',gi,[(0,p.createElementVNode)('span',vi,(0,p.toDisplayString)(h(t,'交互名称')),1),(0,p.createElementVNode)('span',bi,(0,p.toDisplayString)(h(t,'交互类型')),1),h(t,'交互简介')?((0,p.openBlock)(),(0,p.createElementBlock)('span',hi,(0,p.toDisplayString)(h(t,'交互简介')),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 第三行：内容 '),(0,p.createElementVNode)('div',xi,(0,p.toDisplayString)(h(t,'交互内容')),1)],10,si))),128))])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 空状态 '),(0,p.createElementVNode)('div',yi,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.config.icon])},null,2),n[9]||(n[9]=(0,p.createElementVNode)('span',null,'暂无交互数据',-1))])],2112))],512),[[p.vShow,!u.value]])],42,oi);var D}}});d(311);const ki=wi,Ci=ki,Ni=['draggable'],Vi={class:'acu-dash-title-text'},Ei={key:0,class:'acu-dash-count'},Bi={class:'acu-dash-actions'},Si=['title'],Ti=['title','onClick'],Di={class:'acu-dash-body rwp-body'},Ai={key:0,class:'acu-dash-empty'},zi=['onClick'],Ii={class:'rwp-header-left'},_i={class:'rwp-column-name'},Ui={class:'rwp-word-count'},Mi={class:'rwp-limit-wrapper'},Li=['onClick'],$i={class:'popover-body'},Pi={class:'limit-control'},Fi=['value','onInput'],ji={class:'limit-value'},Ri={class:'popover-actions'},Oi=['onClick'],Hi={class:'acu-switch small'},Wi=['checked','onChange'],Gi={class:'rwp-group-content'},Yi={key:0,class:'rwp-empty-hint'},Xi=(0,p.defineComponent)({__name:'RandomWordPoolWidget',props:{isEditing:{type:Boolean},widgetId:{default:'random-word-pool'},colSpan:{default:1},config:{default:()=>({})}},emits:['remove','resize','action','drag-start','drag-end','drop'],setup(e,{emit:t}){const a=e,o=t,n=ua(),r=Ea(),l=ea(),i=(0,p.ref)(!1),c=(0,p.ref)(!1),s=(0,p.reactive)({}),u=(0,p.ref)(null),d=(0,p.ref)([]),m=(0,p.computed)(()=>d.value.length),f=(0,p.computed)(()=>(a.config?.actions||[]).filter(e=>'settings'!==e)),g=(0,p.computed)(()=>0!==d.value.length&&d.value.every(e=>s[e.id]));function v(){const e=oa(),t=[];for(const a of e){const e=na(a);if(0===e.length)continue;const o=e[e.length-1],n=[];for(const e of Object.values(o))if(e&&'string'==typeof e){const t=e.trim();t&&n.push(t)}t.push({id:a,name:aa(a),words:n})}d.value=t;for(const e of d.value)void 0===s[e.id]&&(s[e.id]=!1);console.info(`[RandomWordPoolWidget] 加载了 ${d.value.length} 个表数据`)}function b(e){const t=n.config.tablePoolConfig[e];return!t||t.enabled}function h(e){return n.config.tablePoolConfig[e]?.limit||0}function x(e){const t=h(e);return t>0?`限 ${t}`:'不限'}function y(e,t){const a=n.config.tablePoolConfig[e]||{enabled:!0,limit:0};n.config.tablePoolConfig[e]={...a,limit:t}}function w(){u.value=null}function k(){const e=!g.value;for(const t of d.value)s[t.id]=e}function C(){a.isEditing||(i.value=!i.value)}function N(){r.openDivinationSettingsDialog()}function V(e){return $e[e]?.icon??'fa-question'}function E(e){return $e[e]?.tooltip??e}function B(){r.openWidgetActionsDialog({widgetId:a.config.id||a.widgetId,currentActions:a.config.actions||[]})}function S(e){e.preventDefault();const t=1===a.colSpan?2:1;o('resize',a.widgetId,t)}function T(e){a.isEditing?(e.dataTransfer?.setData('text/plain',a.widgetId),o('drag-start',a.widgetId)):e.preventDefault()}function D(){o('drag-end')}function A(e){e.preventDefault(),o('drop',a.widgetId)}return(0,p.onMounted)(()=>{v(),window.addEventListener('click',w)}),(0,p.onUnmounted)(()=>{window.removeEventListener('click',w)}),(0,p.watch)(()=>n.config.tablePoolConfig,()=>{},{deep:!0}),(0,p.watch)(()=>a.isEditing,e=>{e?(c.value=i.value,i.value=!0):i.value=c.value}),(0,p.watch)(()=>l.tables,()=>{console.log('[RandomWordPoolWidget] 检测到数据变更，刷新词库...'),v()},{deep:!1}),(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-dash-widget rwp-widget',{'acu-dash-widget-wide':2===e.colSpan,'acu-dash-widget-editing':e.isEditing}]),draggable:e.isEditing,onDragstart:T,onDragend:D,onDragover:a[3]||(a[3]=(0,p.withModifiers)(()=>{},['prevent'])),onDrop:A},[(0,p.createCommentVNode)(' 编辑控件 (仅编辑态显示) '),e.isEditing?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('button',{class:'acu-widget-remove',title:'移除组件',onClick:a[0]||(a[0]=(0,p.withModifiers)(t=>o('remove',e.widgetId),['stop']))},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-widget-config',title:'配置快捷按钮',onClick:(0,p.withModifiers)(B,['stop'])},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),(0,p.createElementVNode)('div',{class:'acu-widget-resize',title:'点击切换单/双栏',onMousedown:(0,p.withModifiers)(S,['stop']),onTouchstart:(0,p.withModifiers)(S,['stop'])},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-expand-alt'},null,-1)])],32)],64)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',{class:'acu-dash-title rwp-header',onClick:C},[(0,p.createElementVNode)('span',Vi,[a[7]||(a[7]=(0,p.createElementVNode)('i',{class:'fas fa-dice'},null,-1)),a[8]||(a[8]=(0,p.createTextVNode)(' 随机词表 ',-1)),m.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',Ei,(0,p.toDisplayString)(m.value),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.withDirectives)((0,p.createElementVNode)('div',Bi,[(0,p.createCommentVNode)(' 一键展开/折叠 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:g.value?'全部折叠':'全部展开',onClick:(0,p.withModifiers)(k,['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',g.value?'fa-compress-alt':'fa-expand-alt'])},null,2)],8,Si),(0,p.createCommentVNode)(' 设置按钮 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:'抽词设置',onClick:(0,p.withModifiers)(N,['stop'])},[...a[9]||(a[9]=[(0,p.createElementVNode)('i',{class:'fas fa-cog'},null,-1)])]),(0,p.createCommentVNode)(' 自定义快捷按钮 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(f.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e,class:'acu-icon-btn',title:E(e),onClick:(0,p.withModifiers)(t=>function(e){o('action',e,'')}(e),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',V(e)])},null,2)],8,Ti))),128)),(0,p.createCommentVNode)(' 折叠指示器 '),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas acu-dash-collapse-icon',i.value?'fa-chevron-down':'fa-chevron-up'])},null,2)],512),[[p.vShow,!e.isEditing]])]),(0,p.createCommentVNode)(' 内容区 '),(0,p.withDirectives)((0,p.createElementVNode)('div',Di,[(0,p.createCommentVNode)(' 空状态 '),0===m.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ai,[...a[10]||(a[10]=[(0,p.createElementVNode)('i',{class:'fas fa-dice'},null,-1),(0,p.createElementVNode)('span',null,'未检测到随机表',-1),(0,p.createElementVNode)('span',{class:'hint'},'表名需包含"随机"、"Random"等关键词',-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 表分组 (V2: 按表名分组) '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(d.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['rwp-column-group',{collapsed:!s[e.id]}])},[(0,p.createCommentVNode)(' 表头 '),(0,p.createElementVNode)('div',{class:'rwp-group-header',onClick:t=>{return a=e.id,void(s[a]=!s[a]);var a}},[(0,p.createElementVNode)('div',Ii,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',s[e.id]?'fa-chevron-down':'fa-chevron-right'])},null,2),(0,p.createElementVNode)('span',_i,(0,p.toDisplayString)(e.name),1),(0,p.createElementVNode)('span',Ui,'('+(0,p.toDisplayString)(e.words.length)+')',1)]),(0,p.createElementVNode)('div',{class:'rwp-header-right',onClick:a[2]||(a[2]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createCommentVNode)(' Limit 设置 Badge '),(0,p.createElementVNode)('div',Mi,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-badge-pill acu-badge-interactive',u.value===e.id?'acu-badge-primary':'acu-badge-secondary']),title:'点击设置抽取数量限制',onClick:(0,p.withModifiers)(t=>{return a=e.id,void(u.value===a?u.value=null:u.value=a);var a},['stop'])},[a[11]||(a[11]=(0,p.createElementVNode)('i',{class:'fas fa-filter',style:{'margin-right':'4px','font-size':'11px'}},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(x(e.id)),1)],10,Li),(0,p.createCommentVNode)(' Limit 设置 Popover '),u.value===e.id?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'rwp-limit-popover',onClick:a[1]||(a[1]=(0,p.withModifiers)(()=>{},['stop']))},[a[12]||(a[12]=(0,p.createElementVNode)('div',{class:'popover-header'},'抽取数量限制 (0=不限)',-1)),(0,p.createElementVNode)('div',$i,[(0,p.createElementVNode)('div',Pi,[(0,p.createElementVNode)('input',{type:'range',class:'acu-range-input',min:'0',max:'10',step:'1',value:h(e.id),onInput:t=>y(e.id,+t.target.value)},null,40,Fi),(0,p.createElementVNode)('span',ji,(0,p.toDisplayString)(h(e.id)||'不限'),1)]),(0,p.createElementVNode)('div',Ri,[(0,p.createElementVNode)('button',{class:'acu-tool-btn small',onClick:t=>y(e.id,0)},'重置为不限',8,Oi)])])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('label',Hi,[(0,p.createElementVNode)('input',{type:'checkbox',checked:b(e.id),onChange:(0,p.withModifiers)(t=>function(e){const t=n.config.tablePoolConfig[e]||{enabled:!0,limit:0};n.config.tablePoolConfig[e]={...t,enabled:!t.enabled}}(e.id),['stop'])},null,40,Wi),a[13]||(a[13]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])],8,zi),(0,p.createCommentVNode)(' 词列表 '),(0,p.withDirectives)((0,p.createElementVNode)('div',Gi,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.words,(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:a,class:(0,p.normalizeClass)(['rwp-word-badge',{disabled:!b(e.id)}])},(0,p.toDisplayString)(t),3))),128)),0===e.words.length?((0,p.openBlock)(),(0,p.createElementBlock)('span',Yi,' 暂无词条 ')):(0,p.createCommentVNode)('v-if',!0)],512),[[p.vShow,s[e.id]]])],2))),128))],512),[[p.vShow,!i.value]])],42,Ni))}}),Ki=Xi,qi=Ki,Ji={class:'acu-dash-container-new'},Zi={class:'acu-dash-header'},Qi={class:'acu-dash-header-actions'},ec={key:0,class:'acu-dash-add-section'},tc={key:0,class:'acu-switch-list acu-dash-add-list'},ac={class:'acu-switch-list-body'},oc=['onClick'],nc={class:'item-label'},rc=['onChange'],lc=['onClick'],ic={class:'item-label'},cc=['onChange'],sc=['onClick'],uc={class:'item-label'},dc=['onChange'],pc={key:1,class:'acu-dash-empty-state'},mc=(0,p.defineComponent)({__name:'Dashboard',props:{tables:{}},emits:['navigate','rowClick','showRelationshipGraph','action','heightDragStart','heightReset'],setup(e,{emit:t}){const a=(0,Aa.d)(),o=e,n=t,r=ea(),l=Uo(),i=Ea(),c=(0,p.ref)(!1),s=(0,p.ref)(!1),u=(0,p.ref)(''),d=(0,p.ref)(null),m=(0,p.ref)(null),f=(0,p.ref)(null),g=(0,p.ref)(null);let v=null;const b=(0,p.computed)(()=>l.enabledWidgets),h=(0,p.computed)(()=>o.tables.filter(e=>!l.hasWidget(e.id))),x=(0,p.computed)(()=>{const e=l.config.widgets,t=[];return e.some(e=>'updateStatus'===e.type)||t.push({type:'updateStatus',name:'表格更新状态',icon:'fa-sync-alt'}),e.some(e=>'optionsPanel'===e.type)||t.push({type:'optionsPanel',name:'选项聚合面板',icon:'fa-list-check'}),e.some(e=>'randomWordPool'===e.type)||t.push({type:'randomWordPool',name:'随机词表',icon:'fa-dice'}),t}),y=(0,p.computed)(()=>r.diffMap),w=(0,p.computed)(()=>r.aiDiffMap),k=(0,p.computed)(()=>{const e=new Set;for(const t of l.enabledWidgets){if(!t.tableId)continue;const a=V(t.tableId);if(!a)continue;a.rows.some(e=>{const a=`${t.tableId}:${e.key}`;return r.aiDiffMap.has(a)})&&e.add(t.tableId)}return e});const C=(0,p.computed)(()=>{let e=[...l.enabledWidgets];return u.value?e=e.filter(e=>function(e){if(!u.value)return!0;const t=u.value.toLowerCase().trim();if(!t)return!0;if('updateStatus'===e.type||'optionsPanel'===e.type||'randomWordPool'===e.type)return!1;const a=V(e.tableId);return!!a&&(!!a.name.toLowerCase().includes(t)||a.rows.some(e=>e.cells.some(e=>String(e.value).toLowerCase().includes(t))))}(e)):e.sort((e,t)=>{const a=k.value.has(e.tableId||''),o=k.value.has(t.tableId||'');return a!==o?o?1:-1:e.order-t.order}),e}),N=(0,p.computed)(()=>o.tables);function V(e){return e?o.tables.find(t=>t.id===e)??null:null}function E(e){if('updateStatus'===e.type)return'表格更新状态';if('optionsPanel'===e.type)return'选项聚合面板';const t=o.tables.find(t=>t.id===e.tableId);return t?.name||e.title||e.tableId||'未知表格'}function B(e){const t=V(e),a=t?.name||e;for(const[t,o]of Object.entries(Fe))if(o.some(e=>a.toLowerCase().includes(e.toLowerCase()))){const a=l.config.widgets.find(t=>t.tableId===e);if(a?.icon)return a.icon;if('global'===t)return'fa-globe';if('task'===t)return'fa-tasks';if('item'===t)return'fa-box-open';if('character'===t)return'fa-user';if('location'===t)return'fa-map-marker-alt'}return'fa-table'}function S(){c.value=!0,a.info('拖动组件顶栏可排序')}function T(){c.value=!1,s.value=!1,d.value=null,m.value=null}function D(e){if(function(e){return l.hasWidget(e)}(e)){const t=l.findWidgetByTableId(e);t&&l.removeWidget(t.id)}else{const t=o.tables.find(t=>t.id===e);l.addWidget(e,t?.name)}}function A(e){!function(e){return l.hasSpecialWidget(e)}(e)?l.addSpecialWidget(e):l.removeSpecialWidget(e)}function I(e){l.removeWidget(e)}function U(e,t){l.updateWidget(e,{colSpan:t})}function M(e){d.value=e}function L(){d.value=null,m.value=null}function P(e){if(!d.value||d.value===e)return;const t=l.config.widgets.find(t=>t.id===e);t&&l.moveWidget(d.value,t.order),d.value=null,m.value=null}function F(e){g.value&&n('heightDragStart',e,g.value)}function j(){n('heightReset')}function R(){v&&(clearTimeout(v),v=null)}function O(e){n('navigate',e)}function H(e,t){n('rowClick',e,t)}function W(e,t){const a=V(e);i.openRowEditDialog({tableId:e,tableName:a?.name??e,rowIndex:t.index,currentRowData:t})}function G(e,t){switch(e){case'goToTable':n('navigate',t);break;case'relationshipGraph':n('showRelationshipGraph');break;default:n('action',e,t)}}return(0,p.onMounted)(async()=>{await l.loadConfig(),0===l.config.widgets.length&&function(){for(const e of o.tables)for(const[t,a]of Object.entries(Fe))if(a.some(t=>e.id.toLowerCase().includes(t.toLowerCase())||e.name.includes(t))){l.addWidget(e.id,e.name,t);break}}()}),(0,p.watch)(()=>o.tables,()=>{}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Ji,[(0,p.createCommentVNode)(' 顶栏 - 布局：标题 / (空) / 编辑按钮 / 高度拖手 / 搜索框 '),(0,p.createElementVNode)('div',Zi,[(0,p.createCommentVNode)(' 左侧：标题 '),t[11]||(t[11]=(0,p.createElementVNode)('div',{class:'acu-dash-header-left'},[(0,p.createElementVNode)('span',{class:'acu-dash-header-title'},[(0,p.createElementVNode)('i',{class:'fas fa-th-large'}),(0,p.createTextVNode)(' 仪表盘 ')])],-1)),(0,p.createCommentVNode)(' 中间：弹性空间 '),t[12]||(t[12]=(0,p.createElementVNode)('div',{class:'acu-dash-header-spacer'},null,-1)),(0,p.createCommentVNode)(' 右侧：按钮区 '),(0,p.createElementVNode)('div',Qi,[(0,p.createCommentVNode)(' 编辑模式按钮组 '),c.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-icon-btn acu-btn-primary',title:'完成编辑',onClick:(0,p.withModifiers)(T,['stop'])},[...t[8]||(t[8]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:1,class:'acu-icon-btn',title:'编辑仪表盘',onClick:(0,p.withModifiers)(S,['stop'])},[...t[9]||(t[9]=[(0,p.createElementVNode)('i',{class:'fas fa-edit'},null,-1)])])),(0,p.createCommentVNode)(' 高度拖手 '),(0,p.createElementVNode)('button',{ref_key:'heightHandleRef',ref:g,class:'acu-icon-btn acu-height-handle',title:'拖动调整高度 / 双击重置',onPointerdown:F,onDblclick:j,onTouchend:(0,p.withModifiers)(R,['stop'])},[...t[10]||(t[10]=[(0,p.createElementVNode)('i',{class:'fas fa-grip-lines'},null,-1)])],544),(0,p.createCommentVNode)(' 搜索框 '),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[0]||(t[0]=e=>u.value=e),type:'text',class:'acu-search-input acu-search-inline',placeholder:'搜索...'},null,512),[[p.vModelText,u.value]]),u.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:2,class:'fas fa-times acu-search-clear',onClick:t[1]||(t[1]=e=>u.value='')})):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 组件网格 '),(0,p.createElementVNode)('div',{ref_key:'gridRef',ref:f,class:'acu-dash-grid'},[(0,p.createCommentVNode)(' 编辑模式：添加面板 '),c.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',ec,[(0,p.createCommentVNode)(' 使用通用按钮样式 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-action-btn',{active:s.value}]),onClick:t[2]||(t[2]=(0,p.withModifiers)(e=>s.value=!s.value,['stop']))},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',s.value?'fa-chevron-up':'fa-plus'])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(s.value?'收起':'添加表格'),1)],2),(0,p.createCommentVNode)(' 展开的添加面板：复用 switch-list '),s.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',tc,[(0,p.createElementVNode)('div',ac,[(0,p.createCommentVNode)(' 已添加的表格（排前面，switch 开启） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(b.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-switch-list-item is-selected',onClick:(0,p.withModifiers)(t=>I(e.id),['stop'])},[(0,p.createElementVNode)('span',nc,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(E(e)),1)]),(0,p.createElementVNode)('label',{class:'acu-switch small',onClick:t[3]||(t[3]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('input',{type:'checkbox',checked:'',onChange:(0,p.withModifiers)(t=>I(e.id),['stop'])},null,40,rc),t[13]||(t[13]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])],8,oc))),128)),(0,p.createCommentVNode)(' 未添加的特殊组件 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(x.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.type,class:'acu-switch-list-item',onClick:(0,p.withModifiers)(t=>A(e.type),['stop'])},[(0,p.createElementVNode)('span',ic,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(e.name),1)]),(0,p.createElementVNode)('label',{class:'acu-switch small',onClick:t[4]||(t[4]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('input',{type:'checkbox',checked:!1,onChange:(0,p.withModifiers)(t=>A(e.type),['stop'])},null,40,cc),t[14]||(t[14]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])],8,lc))),128)),(0,p.createCommentVNode)(' 未添加的表格（排后面，switch 关闭） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(h.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-switch-list-item',onClick:(0,p.withModifiers)(t=>D(e.id),['stop'])},[(0,p.createElementVNode)('span',uc,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',B(e.id)])},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(e.name),1)]),(0,p.createElementVNode)('label',{class:'acu-switch small',onClick:t[5]||(t[5]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('input',{type:'checkbox',onChange:(0,p.withModifiers)(t=>D(e.id),['stop'])},null,40,dc),t[15]||(t[15]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])],8,sc))),128))])])):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 动态配置的看板 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(C.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:e.id},[(0,p.createCommentVNode)(' 随机词表组件 '),'randomWordPool'===e.type?((0,p.openBlock)(),(0,p.createBlock)((0,p.unref)(qi),{key:0,'is-editing':c.value,'widget-id':e.id,'col-span':e.colSpan,config:e,class:(0,p.normalizeClass)({'acu-dash-widget-dragging':d.value===e.id,'acu-dash-widget-drop-target':m.value===e.id}),onRemove:I,onResize:U,onAction:G,onDragStart:M,onDragEnd:L,onDrop:P},null,8,['is-editing','widget-id','col-span','config','class'])):'interaction'===e.displayStyle?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 交互表格专用组件 '),(0,p.createVNode)((0,p.unref)(Ci),{config:e,'table-data':V(e.tableId),'is-editing':c.value,'diff-map':y.value,'ai-diff-map':w.value,'search-term':u.value,class:(0,p.normalizeClass)({'acu-dash-widget-dragging':d.value===e.id,'acu-dash-widget-drop-target':m.value===e.id}),onNavigate:O,onRowEdit:W,onAction:G,onRemove:I,onResize:U,onDragStart:M,onDragEnd:L,onDrop:P},null,8,['config','table-data','is-editing','diff-map','ai-diff-map','search-term','class'])],2112)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 普通看板组件 '),(0,p.createVNode)((0,p.unref)(ti),{config:e,'table-data':V(e.tableId),'is-editing':c.value,'diff-map':y.value,'ai-diff-map':w.value,'search-term':u.value,'all-tables':N.value,class:(0,p.normalizeClass)({'acu-dash-widget-dragging':d.value===e.id,'acu-dash-widget-drop-target':m.value===e.id}),onNavigate:O,onRowClick:H,onRowEdit:W,onAction:G,onRemove:I,onResize:U,onDragStart:M,onDragEnd:L,onDrop:P},null,8,['config','table-data','is-editing','diff-map','ai-diff-map','search-term','all-tables','class'])],2112))],64))),128)),(0,p.createCommentVNode)(' 空状态 '),0===C.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',pc,[u.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[t[17]||(t[17]=(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)),(0,p.createElementVNode)('p',null,'没有找到匹配 "'+(0,p.toDisplayString)(u.value)+'" 的内容',1),(0,p.createElementVNode)('button',{class:'acu-dash-add-first-btn',onClick:t[6]||(t[6]=(0,p.withModifiers)(e=>u.value='',['stop']))},[...t[16]||(t[16]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1),(0,p.createTextVNode)(' 清除搜索 ',-1)])])],64)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[t[19]||(t[19]=(0,p.createElementVNode)('i',{class:'fas fa-layer-group'},null,-1)),t[20]||(t[20]=(0,p.createElementVNode)('p',null,'还没有配置任何看板',-1)),(0,p.createElementVNode)('button',{class:'acu-dash-add-first-btn',onClick:t[7]||(t[7]=(0,p.withModifiers)(e=>{S(),s.value=!0},['stop']))},[...t[18]||(t[18]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1),(0,p.createTextVNode)(' 添加第一个看板 ',-1)])])],64))])):(0,p.createCommentVNode)('v-if',!0)],512)]))}}),fc=mc,gc=fc,vc={class:'acu-table-toolbar'},bc={class:'acu-toolbar-left'},hc={class:'acu-table-title'},xc={class:'acu-table-count'},yc={key:0,class:'acu-table-badge acu-badge-changed'},wc={key:1,class:'acu-table-badge acu-badge-deleting'},kc={class:'acu-toolbar-right'},Cc=['title'],Nc={key:0,class:'acu-empty-state'},Vc={key:0,class:'acu-pagination-container'},Ec={class:'acu-pagination-numbers'},Bc={key:0,class:'acu-page-dots'},Sc=['onClick'],Tc=(0,p.defineComponent)({__name:'DataTable',props:{tableId:{},tableName:{},rows:{},headers:{default:()=>[]},searchTerm:{default:''},showIndex:{type:Boolean,default:!0},showHeader:{type:Boolean,default:!0},showPagination:{type:Boolean,default:!0},emptyText:{default:'暂无数据'},isLoading:{type:Boolean,default:!1}},emits:['cellClick','insertRow','toggleDelete','contextMenu','searchChange','pageChange','close','heightDragStart','heightReset','showHistory'],setup(e,{emit:t}){const a=e,o=t,n=ea(),r=Ve(),l=Ea(),i=(0,p.ref)(),c=(0,p.ref)(),s=(0,p.ref)(l.getTableStyle(a.tableName)),u=(0,p.ref)(a.searchTerm),d=(0,p.ref)(1),m=(0,p.computed)(()=>{if(a.tableName.includes('总结')||a.tableName.includes('大纲')){const e=a.headers.findIndex(e=>e&&(e.includes('索引')||e.includes('编号')||e.includes('代码')));if(e>0)return e}return 1}),f=(0,p.computed)(()=>l.isTableReversed(a.tableName)),g=(0,p.ref)(new Map);(0,p.onMounted)(()=>{!function(){const e=new Map;for(const t of a.rows){const o=n.getRowChangeType(a.tableName,t.index,t.cells.length);o&&e.set(t.index,o)}g.value=e}()});const v=(0,p.computed)(()=>{let e=a.rows;if(l.showLockedOnly&&l.isLockEditMode){const t=It();e=e.filter(e=>{const o=e.cells.map(e=>e.key),n=e.cells.map(e=>String(e.value??'')),r=t.getRowKey(a.tableName,n,o,e.index);return!!r&&t.hasRowAnyLockPending(a.tableName,r)})}const t=u.value.toLowerCase().trim();return t?e.filter(e=>e.cells.some(e=>String(e.value).toLowerCase().includes(t))):e});function b(e){return g.value.get(e.index)??null}function h(e){return'manual'===e?2:'ai'===e?1:0}const x=(0,p.computed)(()=>[...v.value].sort((e,t)=>{const a=b(e),o=b(t),n=h(a),r=h(o);return n!==r?r-n:f.value?t.index-e.index:e.index-t.index})),y=(0,p.computed)(()=>r.config.itemsPerPage||20),w=(0,p.computed)(()=>Math.max(1,Math.ceil(x.value.length/y.value))),k=(0,p.computed)(()=>{const e=(d.value-1)*y.value;return x.value.slice(e,e+y.value)}),C=(0,p.computed)(()=>a.rows.length),N=(0,p.computed)(()=>a.rows.filter(e=>S(e)).length),V=(0,p.computed)(()=>a.rows.filter(e=>{const t=`${a.tableName}-row-${e.index}`;return n.pendingDeletes.has(t)}).length),E=(0,p.computed)(()=>a.showPagination&&!1!==r.config.showPagination),B=(0,p.computed)(()=>{const e=[],t=w.value,a=d.value;if(t<=7)for(let a=1;a<=t;a++)e.push(a);else{e.push(1),a>3&&e.push('...');const o=Math.max(2,a-1),n=Math.min(t-1,a+1);for(let t=o;t<=n;t++)e.push(t);a<t-2&&e.push('...'),e.push(t)}return e});function S(e){return n.isRowChanged(a.tableName,e.index,e.cells.length)}function T(){l.toggleTableReverse(a.tableName)}function D(){const e=It();if(l.isLockEditMode){const t=e.pendingLockCount.value;e.savePendingLocks(),l.isLockEditMode=!1,Aa.toast.success(`已保存 ${t} 个单元格锁定`)}else e.initPendingLocks(),l.isLockEditMode=!0,Aa.toast.info('已进入批量锁定模式，请点击单元格进行锁定')}function A(){l.showLockedOnly=!l.showLockedOnly}function I(){o('close')}function U(){d.value=1,o('searchChange',u.value)}function M(){u.value='',d.value=1,o('searchChange','')}function L(e){e<1||e>w.value||(d.value=e,o('pageChange',e),(0,p.nextTick)(()=>{i.value?.scrollTo({top:0,behavior:'smooth'})}))}function P(e,t){o('cellClick',a.tableId,e,t)}function F(e,t){o('contextMenu',e,a.tableId,t)}function j(e){c.value&&o('heightDragStart',e,c.value)}function R(){o('heightReset')}let O=0;function H(){const e=Date.now();e-O<300?(R(),O=0):O=e}return(0,p.watch)(()=>a.searchTerm,e=>{u.value=e}),(0,p.watch)(s,e=>{l.setTableStyle(a.tableName,e)}),(0,p.watch)(w,e=>{d.value>e&&(d.value=Math.max(1,e))}),(t,n)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-data-table',{'acu-table-loading':e.isLoading}])},[(0,p.createCommentVNode)(' 固定工具栏 '),(0,p.createElementVNode)('div',vc,[(0,p.createCommentVNode)(' 左侧：表名 + (条数) '),(0,p.createElementVNode)('div',bc,[(0,p.createElementVNode)('span',hc,(0,p.toDisplayString)(e.tableName),1),(0,p.createElementVNode)('span',xc,'('+(0,p.toDisplayString)(C.value)+')',1),N.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',yc,(0,p.toDisplayString)(N.value),1)):(0,p.createCommentVNode)('v-if',!0),V.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',wc,(0,p.toDisplayString)(V.value),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 右侧：从右到左 - 关闭、搜索、高度拖手、倒序、锁定 '),(0,p.createElementVNode)('div',kc,[(0,p.createCommentVNode)(' 锁定模式筛选按钮 '),(0,p.unref)(l).isLockEditMode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:(0,p.normalizeClass)(['acu-icon-btn',{active:(0,p.unref)(l).showLockedOnly}]),title:'只显示锁定的卡片',onClick:(0,p.withModifiers)(A,['stop'])},[...n[3]||(n[3]=[(0,p.createElementVNode)('i',{class:'fas fa-filter'},null,-1)])],2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 锁定单元格按钮 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-icon-btn',{active:(0,p.unref)(l).isLockEditMode}]),title:(0,p.unref)(l).isLockEditMode?'保存并退出锁定模式':'进入批量锁定模式',onClick:(0,p.withModifiers)(D,['stop'])},[...n[4]||(n[4]=[(0,p.createElementVNode)('i',{class:'fas fa-lock'},null,-1)])],10,Cc),(0,p.createCommentVNode)(' 倒序按钮 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-icon-btn',{active:f.value}]),title:'倒序显示',onClick:T},[...n[5]||(n[5]=[(0,p.createElementVNode)('i',{class:'fas fa-sort-amount-down-alt'},null,-1)])],2),(0,p.createCommentVNode)(' 高度拖手 '),(0,p.createElementVNode)('button',{ref_key:'heightHandleRef',ref:c,class:'acu-icon-btn acu-height-handle',title:'拖动调整高度 / 双击重置',onPointerdown:j,onDblclick:R,onTouchend:(0,p.withModifiers)(H,['stop'])},[...n[6]||(n[6]=[(0,p.createElementVNode)('i',{class:'fas fa-grip-lines'},null,-1)])],544),(0,p.createCommentVNode)(' 搜索框 '),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>u.value=e),type:'text',class:'acu-search-input acu-search-inline',placeholder:'搜索...',onInput:U},null,544),[[p.vModelText,u.value]]),u.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:1,class:'fas fa-times acu-search-clear',onClick:M})):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 关闭按钮 '),(0,p.createElementVNode)('button',{class:'acu-icon-btn acu-close-btn',title:'关闭数据区',onClick:(0,p.withModifiers)(I,['stop'])},[...n[7]||(n[7]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])]),(0,p.createCommentVNode)(' 数据卡片列表 '),(0,p.createElementVNode)('div',{ref_key:'containerRef',ref:i,class:(0,p.normalizeClass)(['acu-cards-container',[`acu-view-${s.value}`]])},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(k.value,t=>((0,p.openBlock)(),(0,p.createBlock)(Hn,{key:`${e.tableId}-${t.index}`,data:t,'table-id':e.tableId,'table-name':e.tableName,'is-changed':S(t),layout:(0,p.unref)(r).config.layout,'view-mode':s.value,'show-index':e.showIndex,'show-header':e.showHeader,'title-col-index':m.value,'show-history-button':!0,onCellClick:P,onInsertRow:e=>{return n=t.index,void o('insertRow',a.tableId,n);var n},onToggleDelete:e=>{return n=t.index,void o('toggleDelete',a.tableId,n);var n},onContextMenu:F,onShowHistory:e=>function(e){o('showHistory',a.tableId,a.tableName,e.index,e)}(t)},null,8,['data','table-id','table-name','is-changed','layout','view-mode','show-index','show-header','title-col-index','onInsertRow','onToggleDelete','onShowHistory']))),128)),(0,p.createCommentVNode)(' 空状态 '),0===v.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Nc,[n[8]||(n[8]=(0,p.createElementVNode)('i',{class:'fas fa-inbox'},null,-1)),(0,p.createElementVNode)('p',null,(0,p.toDisplayString)(e.emptyText),1)])):(0,p.createCommentVNode)('v-if',!0)],2),(0,p.createCommentVNode)(' 分页器 (读取全局配置) '),(0,p.renderSlot)(t.$slots,'pagination',{},()=>[E.value&&w.value>1?((0,p.openBlock)(),(0,p.createElementBlock)('div',Vc,[(0,p.createCommentVNode)(' 上一页 (固定在最左) '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-page-btn acu-page-arrow',{disabled:1===d.value}]),title:'上一页',onClick:n[1]||(n[1]=e=>d.value>1&&L(d.value-1))},[...n[9]||(n[9]=[(0,p.createElementVNode)('i',{class:'fa-solid fa-chevron-left'},null,-1)])],2),(0,p.createCommentVNode)(' 中间数字区 (居中) '),(0,p.createElementVNode)('div',Ec,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(B.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:e},['...'===e?((0,p.openBlock)(),(0,p.createElementBlock)('div',Bc,'...')):((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:1,class:(0,p.normalizeClass)(['acu-page-btn',{active:e===d.value}]),onClick:t=>L(e)},(0,p.toDisplayString)(e),11,Sc))],64))),128))]),(0,p.createCommentVNode)(' 下一页 (固定在最右) '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-page-btn acu-page-arrow',{disabled:d.value===w.value}]),title:'下一页',onClick:n[2]||(n[2]=e=>d.value<w.value&&L(d.value+1))},[...n[10]||(n[10]=[(0,p.createElementVNode)('i',{class:'fa-solid fa-chevron-right'},null,-1)])],2)])):(0,p.createCommentVNode)('v-if',!0)])],2))}}),Dc=Tc,Ac={class:'acu-options-panel'},zc={class:'acu-panel-header acu-options-header'},Ic={class:'acu-header-actions'},_c={class:'acu-options-count'},Uc={class:'acu-panel-content acu-options-content'},Mc={key:0,class:'acu-empty-state'},Lc={class:'acu-options-list'},$c={class:'acu-dash-title'},Pc={class:'acu-option-rows'},Fc=['onClick'],jc={class:'acu-embedded-option-tags'},Rc={class:'acu-embedded-option-text'},Oc=(0,p.defineComponent)({__name:'OptionsPanel',props:{tables:{}},emits:['navigate','optionClick'],setup(e,{emit:t}){const a=e,o=t,{setInput:n}=co(),r=Ea(),l=(0,p.computed)(()=>a.tables.filter(e=>e.name.includes('选项')));function i(e){const t=[],{isMatrix:a,optionColIndices:o}=function(e){const t=e.headers||[],a=[];return t.forEach((e,t)=>{e&&/(选项|Option|分支)/i.test(String(e))&&a.push(t)}),{isMatrix:a.length>=2,optionColIndices:a}}(e),n=e.headers||[];return e.rows.forEach(e=>{const r=e.cells.map(e=>String(e.value||'').trim());if(a){const e=[];r.forEach((t,a)=>{!o.includes(a)&&t&&e.push(t)}),o.forEach(a=>{const o=r[a];if(o){const r=n[a]||'',l=[...e];r&&l.push(r),t.push({text:o,tags:l})}})}else{const e=r.filter(e=>''!==e);if(0===e.length)return;const a=e[e.length-1],o=e.slice(0,e.length-1);t.push({text:a,tags:o})}}),t}function c(e,t){const a=e.currentTarget;t?(a.style.background='var(--acu-table-hover)',a.style.borderColor='var(--acu-title-color)'):(a.style.background='rgba(255,255,255,0.05)',a.style.borderColor='var(--acu-border)')}function s(){r.setActiveTab(ka)}return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Ac,[(0,p.createCommentVNode)(' 面板头部 '),(0,p.createElementVNode)('div',zc,[t[5]||(t[5]=(0,p.createElementVNode)('div',{class:'acu-panel-title acu-options-title'},[(0,p.createElementVNode)('i',{class:'fa-solid fa-list-check'}),(0,p.createTextVNode)(' 选项聚合 ')],-1)),(0,p.createElementVNode)('div',Ic,[(0,p.createElementVNode)('span',_c,(0,p.toDisplayString)(l.value.length)+' 个选项表',1),(0,p.createElementVNode)('button',{class:'acu-icon-btn acu-close-btn',title:'返回仪表盘',onClick:(0,p.withModifiers)(s,['stop'])},[...t[4]||(t[4]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])]),(0,p.createCommentVNode)(' 内容滚动区域 '),(0,p.createElementVNode)('div',Uc,[(0,p.createCommentVNode)(' 空状态 '),0===l.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Mc,'未找到名称包含"选项"的表格')):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 选项表格列表 '),(0,p.createElementVNode)('div',Lc,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-dash-card'},[(0,p.createCommentVNode)(' 表格标题 '),(0,p.createElementVNode)('div',$c,(0,p.toDisplayString)(e.name),1),(0,p.createCommentVNode)(' 选项行列表 '),(0,p.createElementVNode)('div',Pc,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(i(e),(e,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:a,class:'acu-embedded-option-row',title:'点击追加',onClick:t=>{return a=e.text,n(a),o('optionClick',a),void Aa.toast.success('已追加到输入框');var a},onMouseover:t[0]||(t[0]=e=>c(e,!0)),onMouseout:t[1]||(t[1]=e=>c(e,!1)),onMousedown:t[2]||(t[2]=e=>{e.currentTarget.style.transform='translateY(1px)'}),onMouseup:t[3]||(t[3]=e=>{e.currentTarget.style.transform='translateY(0)'})},[(0,p.createCommentVNode)(' 标签区域 '),(0,p.createElementVNode)('div',jc,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.tags,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:t,class:'acu-badge acu-option-tag'},(0,p.toDisplayString)(e),1))),128))]),(0,p.createCommentVNode)(' 选项文本 '),(0,p.createElementVNode)('div',Rc,(0,p.toDisplayString)(e.text),1)],40,Fc))),128))])]))),128))])],2112))])]))}}),Hc=(0,p.defineComponent)({__name:'ContextMenu',props:{visible:{type:Boolean},x:{},y:{},tableId:{},tableName:{},rowIndex:{},cellValue:{}},emits:['update:visible','insertRow','delete','undoDelete','copied'],setup(e,{expose:t,emit:a}){const o=e,n=a,r=(0,p.ref)(),l=ea(),{copy:i,copied:c}=G(),s=(0,p.computed)(()=>{const e=`${o.tableName||o.tableId}-row-${o.rowIndex}`;return l.pendingDeletes.has(e)}),u=(0,p.computed)(()=>{const e=window.parent||window,t=e.innerWidth,a=e.innerHeight;let n=o.x,r=o.y;return n+180>t&&(n=t-180-10),r+200>a&&(r=a-200-10),n=Math.max(10,n),r=Math.max(10,r),{left:`${n}px`,top:`${r}px`}});let d=null,m=null;(0,p.onMounted)(()=>{const e=window.parent?.document||document;d=e=>{if(!o.visible||!r.value)return;const t=e.target;r.value.contains(t)||(console.info('[ACU] 点击外部关闭右键菜单'),f())},m=e=>{if(!o.visible||!r.value)return;const t=e.target;r.value.contains(t)||(console.info('[ACU] 右键点击外部关闭右键菜单'),f())},e.addEventListener('click',d,!0),e.addEventListener('contextmenu',m,!0),e.addEventListener('touchstart',d,!0)}),(0,p.onUnmounted)(()=>{const e=window.parent?.document||document;d&&(e.removeEventListener('click',d,!0),e.removeEventListener('touchstart',d,!0),d=null),m&&(e.removeEventListener('contextmenu',m,!0),m=null)}),(0,p.watch)(()=>o.visible,e=>{e&&(0,p.nextTick)(()=>{r.value?.focus()})});const f=()=>{n('update:visible',!1)},g=()=>{n('insertRow',o.tableId,o.rowIndex),f()},v=async()=>{if(o.cellValue)try{await i(o.cellValue),n('copied')}catch(e){console.error('[ACU] Copy failed:',e)}f()},b=()=>{n('delete',o.tableId,o.rowIndex),f()},h=()=>{n('undoDelete',o.tableId,o.rowIndex),f()};return t({close:f,copied:c}),(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'acu-menu-fade'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,ref_key:'menuRef',ref:r,class:'acu-context-menu',style:(0,p.normalizeStyle)(u.value),tabindex:'-1',onKeydown:(0,p.withKeys)(f,['escape']),onClick:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['stop'])),onMousedown:a[1]||(a[1]=(0,p.withModifiers)(()=>{},['stop'])),onTouchstart:a[2]||(a[2]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createCommentVNode)(' 插入行 '),(0,p.createElementVNode)('div',{class:'acu-menu-item',onClick:(0,p.withModifiers)(g,['stop'])},[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1),(0,p.createElementVNode)('span',null,'插入行',-1)])]),(0,p.createCommentVNode)(' 复制内容 '),(0,p.createElementVNode)('div',{class:'acu-menu-item',onClick:(0,p.withModifiers)(v,['stop'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-copy'},null,-1),(0,p.createElementVNode)('span',null,'复制内容',-1)])]),(0,p.createCommentVNode)(' 分隔线 '),a[7]||(a[7]=(0,p.createElementVNode)('div',{class:'acu-menu-divider'},null,-1)),(0,p.createCommentVNode)(' 删除行（未标记删除时显示） '),s.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 撤销删除（已标记删除时显示） '),(0,p.createElementVNode)('div',{class:'acu-menu-item acu-menu-warning',onClick:(0,p.withModifiers)(h,['stop'])},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createElementVNode)('span',null,'撤销删除',-1)])])],2112)):((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-menu-item acu-menu-danger',onClick:(0,p.withModifiers)(b,['stop'])},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createElementVNode)('span',null,'删除整行',-1)])]))],36)):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}}),Wc={class:'acu-pagination'},Gc={class:'acu-pagination-info'},Yc={class:'acu-pagination-current'},Xc={key:0,class:'acu-pagination-total'},Kc={class:'acu-pagination-controls'},qc=['disabled'],Jc=['disabled'],Zc={class:'acu-page-list'},Qc={key:0,class:'acu-page-ellipsis'},es=['onClick'],ts=['disabled'],as=['disabled'],os={key:0,class:'acu-pagination-jump'},ns=['max'],rs=(Boolean,Boolean,{class:'acu-search-input-wrapper'}),ls=['placeholder'],is={key:0,class:'acu-search-result'},cs={key:1,class:'no-result'},ss=(0,p.defineComponent)({__name:'SearchBox',props:{modelValue:{},resultCount:{},debounce:{default:300},autofocus:{type:Boolean,default:!1},placeholder:{default:'搜索...'},showResultCount:{type:Boolean,default:!0}},emits:['update:modelValue','search','clear','searchImmediate'],setup(e,{expose:t,emit:a}){const o=e,n=a,r=(0,p.ref)(),l=(0,p.ref)(o.modelValue),i=(0,p.ref)(!1);o.autofocus&&(0,p.onMounted)(()=>{r.value?.focus()});const c=T(e=>{n('update:modelValue',e),n('search',e)},o.debounce);(0,p.watch)(l,e=>{c(e)}),(0,p.watch)(()=>o.modelValue,e=>{e!==l.value&&(l.value=e)});const s=()=>{l.value='',n('update:modelValue',''),n('search',''),n('clear'),r.value?.focus()},u=()=>{n('update:modelValue',l.value),n('search',l.value),n('searchImmediate',l.value)};return t({focus:()=>{r.value?.focus()},blur:()=>{r.value?.blur()},clear:s,selectAll:()=>{r.value?.select()},inputRef:r}),(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-search-box',{focused:i.value,'has-value':l.value}])},[(0,p.createElementVNode)('div',rs,[(0,p.createCommentVNode)(' 搜索图标 '),a[4]||(a[4]=(0,p.createElementVNode)('i',{class:'fas fa-search acu-search-icon'},null,-1)),(0,p.createCommentVNode)(' 搜索输入框 '),(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'inputRef',ref:r,'onUpdate:modelValue':a[0]||(a[0]=e=>l.value=e),type:'text',class:'acu-search-input',placeholder:e.placeholder,onFocus:a[1]||(a[1]=e=>i.value=!0),onBlur:a[2]||(a[2]=e=>i.value=!1),onKeydown:[(0,p.withKeys)(s,['escape']),(0,p.withKeys)(u,['enter'])]},null,40,ls),[[p.vModelText,l.value]]),(0,p.createCommentVNode)(' 清空按钮 '),(0,p.createVNode)(p.Transition,{name:'acu-fade'},{default:(0,p.withCtx)(()=>[l.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-search-clear',title:'清空搜索',onClick:s},[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)]),_:1})]),(0,p.createCommentVNode)(' 搜索结果计数（可选） '),(0,p.createVNode)(p.Transition,{name:'acu-fade'},{default:(0,p.withCtx)(()=>[e.showResultCount&&void 0!==e.resultCount?((0,p.openBlock)(),(0,p.createElementBlock)('div',is,[e.resultCount>0?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[a[5]||(a[5]=(0,p.createTextVNode)(' 找到 ',-1)),(0,p.createElementVNode)('strong',null,(0,p.toDisplayString)(e.resultCount),1),a[6]||(a[6]=(0,p.createTextVNode)(' 条结果 ',-1))],64)):l.value?((0,p.openBlock)(),(0,p.createElementBlock)('span',cs,'无匹配结果')):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0)]),_:1})],2))}}),us={class:'acu-modal-body'},ds={class:'acu-settings-section'},ps={class:'acu-settings-group'},ms={class:'acu-purge-range-row'},fs={class:'acu-settings-section'},gs={class:'acu-modal-footer'},vs=['disabled'],bs={key:0,class:'fas fa-spinner fa-spin'},hs={key:1,class:'fas fa-trash-alt'},xs=(0,p.defineComponent)({__name:'AdvancedPurgeDialog',props:{visible:{type:Boolean},initialStartFloor:{default:void 0},initialEndFloor:{default:void 0}},emits:['update:visible','confirm'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(),l=(0,p.ref)(),i=(0,p.ref)(null),c=(0,p.ref)(null),s=(0,p.ref)([]),u=(0,p.ref)([]),d=(0,p.ref)(!1),{purgeTableDataByRange:m}=Qa(),f=(0,p.computed)(()=>u.value.map(e=>({key:e.key,label:e.name}))),g=(0,p.computed)(()=>null!==i.value&&null!==c.value&&(!isNaN(i.value)&&!isNaN(c.value)&&(!(i.value<0||c.value<0)&&(!(i.value>c.value)&&0!==s.value.length))));function v(){i.value=0,c.value=9999999}function b(){l.value?.focus()}function h(){o('update:visible',!1)}async function x(){if(g.value&&!d.value){d.value=!0;try{const e=await m(s.value,i.value,c.value);if(e.changed){const t=s.value.map(e=>u.value.find(t=>t.key===e)?.name||e).join(', ');Aa.toast.success(`已清除 ${e.changedCount} 层数据 (${t})`),o('confirm',{changedCount:e.changedCount,tables:s.value}),h()}else Aa.toast.info('未找到需要清除的数据')}catch(e){console.error('[ACU] 高级清除失败:',e),Aa.toast.error('清除失败: '+(e instanceof Error?e.message:String(e)))}finally{d.value=!1}}}return(0,p.watch)(()=>a.visible,e=>{if(e){if(void 0!==a.initialStartFloor&&void 0!==a.initialEndFloor)i.value=a.initialStartFloor,c.value=a.initialEndFloor;else{const e=function(){let e=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);!e&&window.top&&window.top.SillyTavern&&(e=window.top.SillyTavern);let t=-1,a=0;if(e&&e.chat){a=Math.max(0,e.chat.length-1);for(let a=e.chat.length-1;a>=0;a--){const o=e.chat[a];if(!o.is_user&&o.TavernDB_ACU_IsolatedData){const e=Object.keys(o.TavernDB_ACU_IsolatedData);let n=!1;for(const t of e){const e=o.TavernDB_ACU_IsolatedData[t];if(e&&e.independentData&&Object.keys(e.independentData).length>0){n=!0;break}}if(n){t=a;break}}}}return{start:-1!==t?t:a,end:-1!==t?t:a}}();i.value=e.start,c.value=e.end}s.value=[],d.value=!1,function(){try{const e=yt();if(!e)return void(u.value=[]);const t=[];Object.keys(e).forEach(a=>{if(!a.startsWith('sheet_'))return;const o=e[a];o&&'object'==typeof o&&o.name&&t.push({key:a,name:o.name})}),u.value=t}catch(e){console.warn('[ACU] 加载表格列表失败:',e),u.value=[]}}()}}),O(n,()=>{d.value||h()}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(h,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:n,class:'acu-modal acu-advanced-purge-modal'},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',{class:'acu-modal-header'},[(0,p.createElementVNode)('button',{class:'acu-modal-back',onClick:h},[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-arrow-left'},null,-1)])]),a[4]||(a[4]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'高级清除',-1)),a[5]||(a[5]=(0,p.createElementVNode)('span',null,null,-1))]),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',us,[(0,p.createCommentVNode)(' 楼层范围设置 '),(0,p.createElementVNode)('div',ds,[a[8]||(a[8]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-layer-group'}),(0,p.createTextVNode)(' 楼层范围 ')],-1)),(0,p.createElementVNode)('div',ps,[(0,p.createElementVNode)('div',ms,[(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'startInputRef',ref:r,'onUpdate:modelValue':a[0]||(a[0]=e=>i.value=e),type:'number',class:'acu-purge-input',placeholder:'起始',min:'0',onKeydown:(0,p.withKeys)(b,['enter'])},null,544),[[p.vModelText,i.value,void 0,{number:!0}]]),a[6]||(a[6]=(0,p.createElementVNode)('span',{class:'acu-purge-separator'},'—',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'endInputRef',ref:l,'onUpdate:modelValue':a[1]||(a[1]=e=>c.value=e),type:'number',class:'acu-purge-input',placeholder:'结束',min:'0'},null,512),[[p.vModelText,c.value,void 0,{number:!0}]])]),a[7]||(a[7]=(0,p.createElementVNode)('div',{class:'acu-purge-range-hint'},[(0,p.createElementVNode)('i',{class:'fas fa-info-circle'}),(0,p.createTextVNode)(' 输入 Chat 索引（从 0 开始） ')],-1)),(0,p.createElementVNode)('div',{class:'acu-purge-quick-actions'},[(0,p.createElementVNode)('button',{class:'acu-tool-btn small',onClick:v},'所有楼层')])])]),(0,p.createCommentVNode)(' 表格选择 '),(0,p.createElementVNode)('div',fs,[a[9]||(a[9]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-table'}),(0,p.createTextVNode)(' 选择要清除的表格 ')],-1)),(0,p.createVNode)(Fr,{modelValue:s.value,'onUpdate:modelValue':a[2]||(a[2]=e=>s.value=e),items:f.value,'empty-text':'暂无可用表格','footer-template':'已选择: {selected}/{total} 个表格'},null,8,['modelValue','items'])]),(0,p.createCommentVNode)(' 警告提示 '),a[10]||(a[10]=(0,p.createElementVNode)('div',{class:'acu-purge-warning'},[(0,p.createElementVNode)('i',{class:'fas fa-exclamation-triangle'}),(0,p.createElementVNode)('span',null,'此操作将从指定楼层范围内删除选中表格的数据，操作不可撤销！')],-1))]),(0,p.createCommentVNode)(' 底部按钮 '),(0,p.createElementVNode)('div',gs,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:h},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn danger',disabled:!g.value||d.value,onClick:x},[d.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',bs)):((0,p.openBlock)(),(0,p.createElementBlock)('i',hs)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(d.value?'执行中...':'确认清除'),1)],8,vs)])],512)])):(0,p.createCommentVNode)('v-if',!0)}}),ys={class:'acu-modal',style:{'max-width':'500px'}},ws={class:'acu-modal-header'},ks={class:'acu-modal-body'},Cs={class:'acu-settings-row'},Ns={class:'acu-settings-control',style:{display:'flex',gap:'8px','align-items':'center'}},Vs=['value'],Es=['value'],Bs={class:'acu-settings-row'},Ss={class:'acu-settings-control',style:{display:'flex',gap:'8px','align-items':'center'}},Ts=['value'],Ds=['value'],As=(0,p.defineComponent)({__name:'DirectorDialog',props:{visible:{type:Boolean}},emits:['update:visible','close'],setup(e,{emit:t}){Ea();const a=e,o=t,n=(0,p.ref)([]),r=(0,p.ref)([]),l=(0,p.ref)(''),i=(0,p.ref)(''),c=()=>{o('update:visible',!1),o('close')},s=async(e=0)=>{console.log('[DirectorDialog] loadData called, attempt:',e+1);const t=window.AutoCardUpdaterAPI||window.parent.AutoCardUpdaterAPI;if(!t)return console.warn('[DirectorDialog] AutoCardUpdaterAPI not found.'),void(e<5?setTimeout(()=>s(e+1),200):Aa.toast.error('API 初始化失败，无法加载数据。'));try{const e=t.getTemplatePresetNames()||[];n.value=e,console.log('[DirectorDialog] Templates loaded:',e)}catch(e){console.error('[DirectorDialog] Failed to load template presets:',e)}try{const e=t.getPlotPresetNames()||[];r.value=e;const a=t.getCurrentPlotPreset()||'';i.value=a,console.log('[DirectorDialog] Plots loaded:',e,'Current:',a)}catch(e){console.error('[DirectorDialog] Failed to load plot presets:',e)}};(0,p.watch)(()=>a.visible,e=>{e&&s()});const u=async e=>{const t=e.target,a=t.value,o=window.AutoCardUpdaterAPI||window.parent.AutoCardUpdaterAPI;if(a&&o)try{const e=await o.switchTemplatePreset(a);e.success?(l.value=a,Aa.toast.success(e.message)):(Aa.toast.error(e.message),t.value=l.value)}catch(e){Aa.toast.error('切换模板失败: '+e.message)}},d=e=>{const t=e.target,a=t.value,o=window.AutoCardUpdaterAPI||window.parent.AutoCardUpdaterAPI;if(a&&o)try{o.switchPlotPreset(a)?(i.value=a,Aa.toast.success(`已切换剧情风格: ${a}`)):(Aa.toast.error('切换剧情风格失败'),t.value=i.value)}catch(e){Aa.toast.error('切换剧情风格失败: '+e.message)}},m=async()=>{const e=prompt('请粘贴表格模板配置 (JSON):');if(!e||!e.trim())return;const t=window.AutoCardUpdaterAPI||window.parent.AutoCardUpdaterAPI;if(t)try{const a=await t.importTemplateFromData(e);a.success?(Aa.toast.success(a.message),s()):Aa.toast.error(a.message)}catch(e){Aa.toast.error('导入失败: '+e.message)}},f=async()=>{const e=prompt('请粘贴剧情推进预设 (JSON):');if(!e||!e.trim())return;const t=window.AutoCardUpdaterAPI||window.parent.AutoCardUpdaterAPI;if(t)try{const a=await t.importPlotPresetFromData(e,{switchTo:!0});a.success?(Aa.toast.success(a.message),s(),a.presetName&&(i.value=a.presetName)):Aa.toast.error(a.message)}catch(e){Aa.toast.error('导入失败: '+e.message)}};return(0,p.onMounted)(()=>{a.visible&&s()}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(c,['self'])},[(0,p.createElementVNode)('div',ys,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',ws,[a[0]||(a[0]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'导演控制台',-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(c,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',ks,[(0,p.createCommentVNode)(' 表格模板设置 '),(0,p.createElementVNode)('div',Cs,[a[3]||(a[3]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 表格模板 '),(0,p.createElementVNode)('span',{class:'hint'},'切换游戏数据结构')],-1)),(0,p.createElementVNode)('div',Ns,[(0,p.createElementVNode)('select',{class:'acu-select',value:l.value,style:{flex:'1'},onChange:u},[a[1]||(a[1]=(0,p.createElementVNode)('option',{value:'',disabled:''},'选择模板...',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,Es))),128))],40,Vs),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'粘贴导入模板配置',onClick:(0,p.withModifiers)(m,['stop'])},[...a[2]||(a[2]=[(0,p.createElementVNode)('i',{class:'fas fa-file-import'},null,-1)])])])]),(0,p.createCommentVNode)(' 剧情推进设置 '),(0,p.createElementVNode)('div',Bs,[a[6]||(a[6]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 剧情推进 '),(0,p.createElementVNode)('span',{class:'hint'},'切换 AI 叙事风格')],-1)),(0,p.createElementVNode)('div',Ss,[(0,p.createElementVNode)('select',{class:'acu-select',value:i.value,style:{flex:'1'},onChange:d},[a[4]||(a[4]=(0,p.createElementVNode)('option',{value:'',disabled:''},'选择预设...',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,Ds))),128))],40,Ts),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'粘贴导入剧情预设',onClick:(0,p.withModifiers)(f,['stop'])},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-file-import'},null,-1)])])])])])])])):(0,p.createCommentVNode)('v-if',!0)}}),zs={class:'acu-modal-header'},Is={class:'acu-modal-title'},_s={class:'acu-history-layout acu-pc-layout'},Us={key:0,class:'acu-loading-state'},Ms={key:1,class:'acu-empty-hint'},Ls={key:2,class:'acu-history-list'},$s=['open','onToggle'],Ps={class:'acu-history-summary'},Fs={class:'acu-history-title'},js={class:'acu-history-time'},Rs={class:'acu-history-card-wrapper'},Os={class:'acu-current-card-label'},Hs={key:0,class:'acu-changes-count'},Ws={class:'acu-current-card'},Gs={class:'acu-history-actions'},Ys=['disabled'],Xs=['disabled'],Ks={class:'acu-config-hint'},qs={key:0},Js={key:1},Zs={class:'acu-history-mobile-list'},Qs={key:0,class:'acu-loading-state'},eu={key:1,class:'acu-empty-hint'},tu={key:2,class:'acu-history-list'},au=['open','onToggle'],ou={class:'acu-history-summary'},nu={class:'acu-history-title'},ru={class:'acu-history-time'},lu={class:'acu-history-card-wrapper'},iu={class:'acu-mobile-actions'},cu={class:'acu-mobile-history-section'},su={class:'acu-history-scroll'},uu={key:0,class:'acu-empty-hint'},du={key:1,class:'acu-history-list'},pu=['open','onToggle'],mu={class:'acu-history-summary'},fu={class:'acu-history-title'},gu={class:'acu-history-time'},vu={class:'acu-history-card-wrapper'},bu={class:'acu-mobile-current-section'},hu={class:'acu-section-label'},xu={key:0,class:'acu-changes-count'},yu={class:'acu-current-scroll'},wu={class:'acu-mobile-actions'},ku=['disabled'],Cu=['disabled'],Nu={key:0,class:'acu-preview-overlay'},Vu=(0,p.defineComponent)({__name:'HistoryDialog',props:{visible:{type:Boolean,default:!1},tableName:{},tableId:{},rowIndex:{},currentRowData:{default:null},titleColIndex:{default:-1},headers:{default:()=>[]}},emits:['update:visible','close','apply'],setup(e,{emit:t}){const a=e,o=t,n=Ve(),{getSnapshots:r,snapshotToTableRow:l,tableRowToCells:i,formatRelativeTime:c,getDiff:s,getCurrentChatId:u}=(ea(),Ot()),{isMobile:d}=po(),m=(0,p.ref)([]),f=(0,p.ref)(!1),g=(0,p.ref)(!1),v=(0,p.ref)(new Map),b=(0,p.ref)([]),h=(0,p.ref)(null),x=(0,p.ref)(!1),y=(0,p.ref)(''),w=(0,p.ref)(-1),k=(0,p.computed)(()=>n.config.cardWidth||280),C=(0,p.computed)(()=>{if(a.titleColIndex>=0)return a.titleColIndex;if(a.tableName.includes('总结')||a.tableName.includes('大纲')){if(a.headers.length>0){const e=a.headers.findIndex(e=>e&&(e.includes('索引')||e.includes('编号')||e.includes('代码')));if(e>0)return e}if(a.currentRowData){const e=a.currentRowData.cells.findIndex(e=>e.key&&(e.key.includes('索引')||e.key.includes('编号')||e.key.includes('代码')));if(e>0)return e}}return 1}),N=(0,p.computed)(()=>{const e=function(e){if(!e)return'';const t=C.value;if(t>=0&&e.cells.length>t){const a=e.cells[t]?.value;return void 0!==a?String(a):''}return''}(a.currentRowData);return e?`${a.tableName} - ${e}`:a.tableName}),V=(0,p.computed)(()=>new Set(v.value.keys())),E=(0,p.computed)(()=>[...v.value.entries()].map(([e,t])=>`${e}:${t.substring(0,10)}`).join(',')),B=(0,p.computed)(()=>a.currentRowData?0===v.value.size?a.currentRowData:{index:a.currentRowData.index,key:a.currentRowData.key,cells:a.currentRowData.cells.map((e,t)=>v.value.has(t)?{...e,value:v.value.get(t)}:e)}:{index:0,key:'',cells:[]});function S(e){const t=C.value;return t>=0&&e.cells[t]?e.cells[t]:''}function T(e){return a.currentRowData?l(e,a.currentRowData):{index:0,key:'',cells:[]}}function D(e){const t=i(B.value);return s(e,t)}function A(e,t){t.target.open&&g.value&&(h.value=e)}function I(){g.value=!0,v.value=new Map,b.value=[],h.value=m.value.length>0?m.value[0]:null}function U(){g.value=!1,v.value=new Map,b.value=[],h.value=null}function M(e,t){if(!g.value)return;h.value=e,b.value.push(new Map(v.value));const a=e.cells[t];if(void 0!==a){const e=new Map(v.value);e.set(t,a),v.value=e}}function L(){if(!h.value)return;b.value.push(new Map(v.value));const e=new Map;for(const[t,a]of Object.entries(h.value.cells))e.set(Number(t),a);v.value=e}function P(){0!==b.value.length&&(v.value=new Map(b.value.pop()))}function F(){x.value=!0}function j(){x.value=!1}function R(){v.value.size>0&&o('apply',new Map(v.value)),o('update:visible',!1),o('close')}function O(){m.value=[],g.value=!1,v.value=new Map,b.value=[],h.value=null,x.value=!1}async function H(){f.value=!0;try{console.info('[HistoryDialog] 加载历史快照, 参数:',{tableName:a.tableName,tableId:a.tableId,rowIndex:a.rowIndex}),m.value=await r(a.tableName,a.rowIndex),console.info('[HistoryDialog] 加载到快照数量:',m.value.length),m.value.length>0&&console.info('[HistoryDialog] 快照示例:',m.value[0])}catch(e){console.error('[HistoryDialog] 加载历史快照失败:',e),m.value=[]}finally{f.value=!1}}return(0,p.watch)(()=>a.visible,e=>{e?(console.info('[HistoryDialog] visible 变为 true，开始加载数据'),y.value=a.tableName,w.value=a.rowIndex,O(),H()):O()},{immediate:!0}),(0,p.watch)(()=>[a.tableName,a.rowIndex],([e,t])=>{a.visible&&(e===y.value&&t===w.value||(console.info('[HistoryDialog] 行参数变化，重新加载数据'),y.value=e,w.value=t,O(),H()))}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(R,['self'])},[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-modal acu-history-modal',{'acu-mobile-edit-mode':g.value}])},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',zs,[(0,p.createCommentVNode)(' 移动端拖动把手 '),a[1]||(a[1]=(0,p.createElementVNode)('div',{class:'acu-drag-handle acu-mobile-only'},null,-1)),(0,p.createElementVNode)('span',Is,[a[0]||(a[0]=(0,p.createElementVNode)('i',{class:'fas fa-history'},null,-1)),(0,p.createTextVNode)(' 历史记录 - '+(0,p.toDisplayString)(N.value),1)]),(0,p.createCommentVNode)(' PC端在头部显示完成按钮 '),(0,p.createElementVNode)('button',{class:'acu-close-pill acu-pc-only',onClick:R},'完成')]),(0,p.createCommentVNode)(' PC 端布局：左右分栏（使用 CSS 媒体查询控制显示） '),(0,p.createElementVNode)('div',_s,[(0,p.createCommentVNode)(' 左侧：历史记录列表 '),(0,p.createElementVNode)('div',{class:'acu-history-sidebar',style:(0,p.normalizeStyle)({width:`${k.value+64}px`})},[f.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Us,[...a[2]||(a[2]=[(0,p.createElementVNode)('i',{class:'fas fa-spinner fa-spin'},null,-1),(0,p.createElementVNode)('span',null,'加载历史记录...',-1)])])):0===m.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ms,[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-history'},null,-1),(0,p.createElementVNode)('span',null,'暂无历史记录',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)('div',Ls,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(m.value,(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('details',{key:t.id||t.timestamp,open:0===a,class:'acu-history-item',onToggle:e=>A(t,e)},[(0,p.createElementVNode)('summary',Ps,[(0,p.createElementVNode)('span',{class:(0,p.normalizeClass)(['acu-history-badge',t.source])},(0,p.toDisplayString)('manual'===t.source?'手动':'AI'),3),(0,p.createElementVNode)('span',Fs,' #'+(0,p.toDisplayString)(a+1)+' '+(0,p.toDisplayString)(S(t)),1),(0,p.createElementVNode)('span',js,(0,p.toDisplayString)((0,p.unref)(c)(t.timestamp)),1)]),(0,p.createElementVNode)('div',Rs,[(0,p.createVNode)(Hn,{data:T(t),'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!1,'show-index':!1,'show-history-button':!1,'title-col-index':C.value,'custom-highlights':g.value?D(t):void 0,'allow-edit':!1,onCellClick:(e,a)=>M(t,a)},null,8,['data','table-name','table-id','title-col-index','custom-highlights','onCellClick'])])],40,$s))),128))]))],4),(0,p.createCommentVNode)(' 右侧：当前卡片 + 操作区 '),(0,p.createElementVNode)('div',{class:'acu-history-main',style:(0,p.normalizeStyle)({width:`${k.value+64}px`})},[(0,p.createElementVNode)('div',Os,[a[4]||(a[4]=(0,p.createElementVNode)('i',{class:'fas fa-file-alt'},null,-1)),a[5]||(a[5]=(0,p.createTextVNode)(' 当前版本 ',-1)),v.value.size>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',Hs,' (已修改 '+(0,p.toDisplayString)(v.value.size)+' 处) ',1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('div',Ws,[((0,p.openBlock)(),(0,p.createBlock)(Hn,{key:`current-pc-${E.value}`,data:B.value,'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!0,'show-index':!0,'show-history-button':!1,'title-col-index':C.value,'custom-highlights':V.value},null,8,['data','table-name','table-id','title-col-index','custom-highlights']))]),(0,p.createCommentVNode)(' 操作按钮 '),(0,p.createElementVNode)('div',Gs,[g.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:!h.value,onClick:L},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-layer-group'},null,-1),(0,p.createTextVNode)(' 整卡覆盖 ',-1)])],8,Ys),(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',disabled:0===b.value.length,onClick:P},[...a[8]||(a[8]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 撤销 ',-1)])],8,Xs),(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:U},[...a[9]||(a[9]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1),(0,p.createTextVNode)(' 退出编辑',-1)])])],64)):((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-modal-btn primary acu-btn-start-edit',onClick:I},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-edit'},null,-1),(0,p.createTextVNode)(' 启动编辑 ',-1)])]))]),(0,p.createCommentVNode)(' 提示信息 '),(0,p.createElementVNode)('div',Ks,[a[10]||(a[10]=(0,p.createElementVNode)('i',{class:'fas fa-info-circle'},null,-1)),g.value?((0,p.openBlock)(),(0,p.createElementBlock)('span',Js,'点击左侧历史卡片的单元格进行覆盖')):((0,p.openBlock)(),(0,p.createElementBlock)('span',qs,'点击"启动编辑"开始修改'))])],4)]),(0,p.createCommentVNode)(' 移动端布局：全屏分区（使用 CSS 媒体查询控制显示） '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-history-layout acu-mobile-layout',{'acu-mobile-edit-mode':g.value}])},[(0,p.createCommentVNode)(' 非编辑模式：只显示历史列表 '),g.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 编辑模式：上下分屏 '),(0,p.createCommentVNode)(' 上半部分：历史记录滚动区 '),(0,p.createElementVNode)('div',cu,[a[17]||(a[17]=(0,p.createElementVNode)('div',{class:'acu-section-label'},[(0,p.createElementVNode)('i',{class:'fas fa-history'}),(0,p.createTextVNode)(' 历史记录（点击单元格覆盖）')],-1)),(0,p.createElementVNode)('div',su,[0===m.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',uu,[...a[16]||(a[16]=[(0,p.createElementVNode)('i',{class:'fas fa-history'},null,-1),(0,p.createElementVNode)('span',null,'暂无历史记录',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)('div',du,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(m.value,(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('details',{key:t.id||t.timestamp,open:0===a,class:'acu-history-item',onToggle:e=>A(t,e)},[(0,p.createElementVNode)('summary',mu,[(0,p.createElementVNode)('span',{class:(0,p.normalizeClass)(['acu-history-badge',t.source])},(0,p.toDisplayString)('manual'===t.source?'手动':'AI'),3),(0,p.createElementVNode)('span',fu,' #'+(0,p.toDisplayString)(a+1)+' '+(0,p.toDisplayString)(S(t)),1),(0,p.createElementVNode)('span',gu,(0,p.toDisplayString)((0,p.unref)(c)(t.timestamp)),1)]),(0,p.createElementVNode)('div',vu,[(0,p.createVNode)(Hn,{data:T(t),'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!1,'show-index':!1,'show-history-button':!1,'title-col-index':C.value,'custom-highlights':D(t),'allow-edit':!1,onCellClick:(e,a)=>M(t,a)},null,8,['data','table-name','table-id','title-col-index','custom-highlights','onCellClick'])])],40,pu))),128))]))])]),(0,p.createCommentVNode)(' 下半部分：当前版本滚动区 '),(0,p.createElementVNode)('div',bu,[(0,p.createElementVNode)('div',hu,[a[18]||(a[18]=(0,p.createElementVNode)('i',{class:'fas fa-file-alt'},null,-1)),a[19]||(a[19]=(0,p.createTextVNode)(' 当前版本 ',-1)),v.value.size>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',xu,'(已修改 '+(0,p.toDisplayString)(v.value.size)+' 处)',1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('div',yu,[((0,p.openBlock)(),(0,p.createBlock)(Hn,{key:`current-mobile-${E.value}`,data:B.value,'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!0,'show-index':!0,'show-history-button':!1,'title-col-index':C.value,'custom-highlights':V.value},null,8,['data','table-name','table-id','title-col-index','custom-highlights']))])]),(0,p.createCommentVNode)(' 编辑模式底部按钮 '),(0,p.createElementVNode)('div',wu,[(0,p.createElementVNode)('button',{disabled:0===b.value.length,onClick:P},[...a[20]||(a[20]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 撤销',-1)])],8,ku),(0,p.createElementVNode)('button',{class:'acu-btn-primary',disabled:!h.value,onClick:L},[...a[21]||(a[21]=[(0,p.createElementVNode)('i',{class:'fas fa-layer-group'},null,-1),(0,p.createTextVNode)(' 整卡覆盖 ',-1)])],8,Cu),(0,p.createElementVNode)('button',{onClick:U},[...a[22]||(a[22]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1),(0,p.createTextVNode)(' 退出编辑',-1)])]),(0,p.createElementVNode)('button',{class:'acu-btn-done',onClick:R},[...a[23]||(a[23]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1),(0,p.createTextVNode)(' 完成',-1)])])])],64)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('div',Zs,[f.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Qs,[...a[11]||(a[11]=[(0,p.createElementVNode)('i',{class:'fas fa-spinner fa-spin'},null,-1),(0,p.createElementVNode)('span',null,'加载历史记录...',-1)])])):0===m.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',eu,[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-history'},null,-1),(0,p.createElementVNode)('span',null,'暂无历史记录',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)('div',tu,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(m.value,(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('details',{key:t.id||t.timestamp,open:0===a,class:'acu-history-item',onToggle:e=>A(t,e)},[(0,p.createElementVNode)('summary',ou,[(0,p.createElementVNode)('span',{class:(0,p.normalizeClass)(['acu-history-badge',t.source])},(0,p.toDisplayString)('manual'===t.source?'手动':'AI'),3),(0,p.createElementVNode)('span',nu,' #'+(0,p.toDisplayString)(a+1)+' '+(0,p.toDisplayString)(S(t)),1),(0,p.createElementVNode)('span',ru,(0,p.toDisplayString)((0,p.unref)(c)(t.timestamp)),1)]),(0,p.createElementVNode)('div',lu,[(0,p.createVNode)(Hn,{data:T(t),'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!1,'show-index':!1,'show-history-button':!1,'title-col-index':C.value,'allow-edit':!1},null,8,['data','table-name','table-id','title-col-index'])])],40,au))),128))]))]),(0,p.createCommentVNode)(' 非编辑模式底部按钮 '),(0,p.createElementVNode)('div',iu,[(0,p.createElementVNode)('button',{class:'acu-btn-preview',onTouchstart:(0,p.withModifiers)(F,['prevent']),onTouchend:(0,p.withModifiers)(j,['prevent']),onMousedown:F,onMouseup:j,onMouseleave:j},[...a[13]||(a[13]=[(0,p.createElementVNode)('i',{class:'fas fa-eye'},null,-1),(0,p.createTextVNode)(' 预览最新 ',-1)])],32),(0,p.createElementVNode)('button',{class:'acu-btn-primary',onClick:I},[...a[14]||(a[14]=[(0,p.createElementVNode)('i',{class:'fas fa-edit'},null,-1),(0,p.createTextVNode)(' 启动编辑',-1)])]),(0,p.createElementVNode)('button',{class:'acu-btn-done',onClick:R},[...a[15]||(a[15]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1),(0,p.createTextVNode)(' 完成',-1)])])])],64)),(0,p.createCommentVNode)(' 预览悬浮层 '),(0,p.createVNode)(p.Transition,{name:'preview-fade'},{default:(0,p.withCtx)(()=>[x.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Nu,[(0,p.createVNode)(Hn,{data:B.value,'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!0,'show-index':!0,'show-history-button':!1,'title-col-index':C.value},null,8,['data','table-name','table-id','title-col-index'])])):(0,p.createCommentVNode)('v-if',!0)]),_:1})],2)],2)])):(0,p.createCommentVNode)('v-if',!0)}}),Eu=Vu,Bu=['📦','🏷️','📁','📂','📄','📝','📌','📍','📎','🔒','🔓','🔑','⚙️','🔧','🔨','🛠️','⚖️','🛒','💰','💎','❤️','🧡','💛','💚','💙','💜','🖤','🤍','🤎','💔','⭐','🌟','✨','⚡','🔥','💧','❄️','🌈','☀️','🌙','😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🤩','🥳','😏','😒','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺','😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','😱','😨','😰','😥','😓','🤗','🤔','🤭','🤫','🤥','😶','😐','😑','😬','🙄','😯','😦','😧','😮','😲','🥱','😴','🤤','😪','😵','🤐','🥴','🤢','🤮','🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','👺','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾','👋','🤚','🖐️','✋','🖖','👌','🤏','✌️','🤞','🤟','🤘','🤙','👈','👉','👆','🖕','👇','☝️','👍','👎','✊','👊','🤛','🤜','👏','🙌','👐','🤲','🤝','🙏','✍️','💅','🤳','💪','🦾','🦿','🦵','🦶','👂','🦻','👃','🧠','🦷','🦴','👀','👁️','👅','👄','💋','👶','🧒','👦','👧','🧑','👱','👨','🧔','👨‍🦰','👨‍🦱','👨‍🦳','👨‍🦲','👩','👩‍🦰','👩‍🦱','👩‍🦳','👩‍🦲','👱‍♀️','👱‍♂️','🧓','👴','👵','🙍','🙍‍♂️','🙍‍♀️','🙎','🙎‍♂️','🙎‍♀️','🙅','🙅‍♂️','🙅‍♀️','🙆','🙆‍♂️','🙆‍♀️','💁','💁‍♂️','💁‍♀️','🙋','🙋‍♂️','🙋‍♀️','🙇','🙇‍♂️','🙇‍♀️','🤦','🤦‍♂️','🤦‍♀️','🤷','🤷‍♂️','🤷‍♀️','👨‍⚕️','👩‍⚕️','👨‍🎓','👩‍🎓','👨‍🏫','👩‍🏫','👨‍⚖️','👩‍⚖️','👨‍🌾','👩‍🌾','👨‍🍳','👩‍🍳','👨‍🔧','👩‍🔧','👨‍🏭','👩‍🏭','👨‍💼','👩‍💼','👨‍🔬','👩‍🔬','👨‍💻','👩‍💻','👨‍🎤','👩‍🎤','👨‍🎨','👩‍🎨','👨‍✈️','👩‍✈️','👨‍🚀','👩‍🚀','👨‍🚒','👩‍🚒','👮','👮‍♂️','👮‍♀️','🕵️','🕵️‍♂️','🕵️‍♀️','💂','💂‍♂️','💂‍♀️','👷','👷‍♂️','👷‍♀️','🤴','👸','👳','👳‍♂️','👳‍♀️','👲','🧕','🤵','👰','🤰','🤱','👼','🎅','🤶','🦸','🦸‍♂️','🦸‍♀️','🦹','🦹‍♂️','🦹‍♀️','🧙','🧙‍♂️','🧙‍♀️','🧚','🧚‍♂️','🧚‍♀️','🧛','🧛‍♂️','🧛‍♀️','🧜','🧜‍♂️','🧜‍♀️','🧝','🧝‍♂️','🧝‍♀️','🧞','🧞‍♂️','🧞‍♀️','🧟','🧟‍♂️','🧟‍♀️','💆','💆‍♂️','💆‍♀️','💇','💇‍♂️','💇‍♀️','🚶','🚶‍♂️','🚶‍♀️','🏃','🏃‍♂️','🏃‍♀️','💃','🕺','🕴️','👯','👯‍♂️','👯‍♀️','🧖','🧖‍♂️','🧖‍♀️','🧘','🧘‍♂️','🧘‍♀️','⚔️','🛡️','🏹','🔮','🧿','📿','🏺','📜','🩸','💊','🩹','🦠'],Su=['fas fa-star','far fa-star','fas fa-heart','far fa-heart','fas fa-user','far fa-user','fas fa-check','fas fa-times','fas fa-plus','fas fa-minus','fas fa-cog','fas fa-home','fas fa-search','fas fa-envelope','far fa-envelope','fas fa-bell','far fa-bell','fas fa-calendar','far fa-calendar','fas fa-clock','far fa-clock','fas fa-camera','fas fa-image','far fa-image','fas fa-video','fas fa-music','fas fa-microphone','fas fa-headphones','fas fa-book','fas fa-bookmark','far fa-bookmark','fas fa-folder','far fa-folder','fas fa-folder-open','far fa-folder-open','fas fa-file','far fa-file','fas fa-file-alt','far fa-file-alt','fas fa-download','fas fa-upload','fas fa-cloud','fas fa-comment','far fa-comment','fas fa-comments','far fa-comments','fas fa-quote-left','fas fa-quote-right','fas fa-pen','fas fa-edit','far fa-edit','fas fa-trash','far fa-trash-alt','fas fa-save','far fa-save','fas fa-share','fas fa-share-alt','fas fa-reply','fas fa-history','fas fa-list','fas fa-list-ul','fas fa-list-ol','fas fa-th','fas fa-th-list','fas fa-bars','fas fa-ellipsis-h','fas fa-ellipsis-v','fas fa-arrow-right','fas fa-arrow-left','fas fa-arrow-up','fas fa-arrow-down','fas fa-chevron-right','fas fa-chevron-left','fas fa-chevron-up','fas fa-chevron-down','fas fa-caret-right','fas fa-caret-left','fas fa-caret-up','fas fa-caret-down','fas fa-angle-right','fas fa-angle-left','fas fa-angle-up','fas fa-angle-down','fas fa-play','fas fa-pause','fas fa-stop','fas fa-forward','fas fa-backward','fas fa-fast-forward','fas fa-fast-backward','fas fa-step-forward','fas fa-step-backward','fas fa-info-circle','fas fa-question-circle','fas fa-exclamation-circle','fas fa-exclamation-triangle','fas fa-lock','fas fa-unlock','fas fa-key','fas fa-shield-alt','fas fa-bug','fas fa-code','fas fa-terminal','fas fa-database','fas fa-server','fas fa-network-wired','fas fa-wifi','fas fa-signal','fas fa-battery-full','fas fa-power-off','fas fa-desktop','fas fa-laptop','fas fa-mobile-alt','fas fa-tablet-alt','fas fa-gamepad','fas fa-keyboard','fas fa-mouse','fas fa-print','fas fa-cube','fas fa-cubes','fas fa-puzzle-piece','fas fa-lightbulb','far fa-lightbulb','fas fa-magic','fas fa-crown','fas fa-gem','far fa-gem','fas fa-gift','fas fa-trophy','fas fa-medal','fas fa-certificate','fas fa-map-marker-alt','fas fa-map','far fa-map','fas fa-location-arrow','fas fa-compass','far fa-compass','fas fa-globe','fas fa-globe-americas','fas fa-flag','far fa-flag','fas fa-plane','fas fa-car','fas fa-bus','fas fa-train','fas fa-bicycle','fas fa-walking','fas fa-running','fas fa-wheelchair','fas fa-shopping-cart','fas fa-shopping-bag','fas fa-credit-card','far fa-credit-card','fas fa-money-bill-wave','fas fa-tag','fas fa-tags','fas fa-ticket-alt','fas fa-users','fas fa-user-friends','fas fa-user-plus','fas fa-user-minus','fas fa-user-check','fas fa-user-times','fas fa-user-circle','far fa-user-circle','fas fa-id-card','far fa-id-card','fas fa-address-book','far fa-address-book','fas fa-address-card','far fa-address-card','fas fa-smile','far fa-smile','fas fa-frown','far fa-frown','fas fa-meh','far fa-meh','fas fa-hand-paper','far fa-hand-paper','fas fa-thumbs-up','far fa-thumbs-up','fas fa-thumbs-down','far fa-thumbs-down','fas fa-sun','far fa-sun','fas fa-moon','far fa-moon','fas fa-cloud-sun','fas fa-cloud-moon','fas fa-umbrella','fas fa-snowflake','far fa-snowflake','fas fa-fire','fas fa-water','fas fa-leaf','fas fa-seedling','fas fa-tree','fas fa-paw','fas fa-dog','fas fa-cat','fas fa-fish','fas fa-dragon','fas fa-feather','fas fa-feather-alt'],Tu={class:'acu-modal acu-icon-select-modal'},Du={class:'acu-modal-header'},Au={class:'acu-header-actions'},zu={class:'acu-icon-tabs'},Iu={class:'acu-icon-search-bar'},_u={class:'acu-search-input-wrapper'},Uu={class:'acu-modal-body'},Mu={class:'acu-icon-grid-container'},Lu={key:0,class:'acu-icon-grid'},$u=['title','onClick'],Pu={key:1},Fu={key:1,class:'acu-no-icons'},ju={class:'acu-icon-manual-input'},Ru={class:'acu-manual-field'},Ou={class:'acu-preview-icon'},Hu={key:1},Wu=(0,p.defineComponent)({__name:'IconSelectDialog',props:{visible:{type:Boolean},currentIcon:{default:''}},emits:['update:visible','select','close'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)('emoji'),r=(0,p.ref)(''),l=(0,p.ref)('');function i(e){return e.startsWith('fa')||e.includes(' fa-')}(0,p.watch)(()=>a.visible,e=>{e&&(l.value=a.currentIcon,r.value='',a.currentIcon&&i(a.currentIcon)?n.value='fa':n.value='emoji')});const c=(0,p.computed)(()=>{const e=r.value.toLowerCase().trim(),t='emoji'===n.value?Bu:Su;return e?t.filter(t=>t.toLowerCase().includes(e)):t});function s(){o('update:visible',!1),o('close')}function u(e){o('select',e),s()}function d(){}function m(){const e=l.value.trim();e&&u(e)}return(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(s,['self'])},[(0,p.createElementVNode)('div',Tu,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Du,[a[4]||(a[4]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'选择图标',-1)),(0,p.createElementVNode)('div',Au,[(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(s,['stop'])},'取消')])]),(0,p.createCommentVNode)(' 顶部 Tab 栏 '),(0,p.createElementVNode)('div',zu,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-icon-tab',{active:'emoji'===n.value}]),onClick:a[0]||(a[0]=e=>n.value='emoji')},' Emoji 表情 ',2),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-icon-tab',{active:'fa'===n.value}]),onClick:a[1]||(a[1]=e=>n.value='fa')},'FontAwesome',2)]),(0,p.createCommentVNode)(' 搜索栏 '),(0,p.createElementVNode)('div',Iu,[(0,p.createElementVNode)('div',_u,[a[5]||(a[5]=(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>r.value=e),type:'text',placeholder:'搜索图标...',onInput:d},null,544),[[p.vModelText,r.value]])])]),(0,p.createCommentVNode)(' 内容区域 '),(0,p.createElementVNode)('div',Uu,[(0,p.createElementVNode)('div',Mu,[c.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Lu,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(c.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:(0,p.normalizeClass)(['acu-icon-item',{selected:e.currentIcon===t}]),title:t,onClick:(0,p.withModifiers)(e=>u(t),['stop'])},['fa'===n.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(t)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Pu,(0,p.toDisplayString)(t),1))],10,$u))),128))])):((0,p.openBlock)(),(0,p.createElementBlock)('div',Fu,[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1),(0,p.createElementVNode)('span',null,'未找到相关图标',-1)])]))]),(0,p.createCommentVNode)(' 底部手动输入 '),(0,p.createElementVNode)('div',ju,[a[8]||(a[8]=(0,p.createElementVNode)('span',{class:'acu-manual-label'},'手动输入:',-1)),(0,p.createElementVNode)('div',Ru,[(0,p.createElementVNode)('div',Ou,[i(l.value)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(l.value)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',Hu,(0,p.toDisplayString)(l.value),1))]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>l.value=e),type:'text',placeholder:'输入 Emoji 或 fa-class',onKeyup:(0,p.withKeys)(m,['enter'])},null,544),[[p.vModelText,l.value]])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',onClick:(0,p.withModifiers)(m,['stop'])},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)])])])])])])):(0,p.createCommentVNode)('v-if',!0)}}),Gu={class:'acu-modal-body'},Yu={class:'floor-input-group'},Xu={key:0,class:'floor-info'},Ku={key:1,class:'floor-error'},qu={class:'acu-modal-footer'},Ju=['disabled'],Zu=(0,p.defineComponent)({__name:'InputFloorDialog',props:{visible:{type:Boolean},currentFloorInfo:{default:''},maxFloor:{default:999}},emits:['update:visible','confirm'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(),l=(0,p.ref)(null),i=(0,p.computed)(()=>{if(null===l.value||void 0===l.value)return!1;const e=l.value;return Number.isInteger(e)&&0!==e}),c=(0,p.computed)(()=>null===l.value||void 0===l.value?'':0===l.value?'楼层索引不能为 0':Number.isInteger(l.value)?Math.abs(l.value)>a.maxFloor?`楼层索引超出范围 (±${a.maxFloor})`:'':'请输入整数');(0,p.watch)(()=>a.visible,e=>{e&&(l.value=null,(0,p.nextTick)(()=>{r.value?.focus()}))}),O(n,()=>{u()});const s=()=>{i.value&&null!==l.value&&(o('confirm',l.value),o('update:visible',!1))},u=()=>{o('update:visible',!1)};return(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(u,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:n,class:'acu-modal acu-input-floor-modal'},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',{class:'acu-modal-header'},[a[2]||(a[2]=(0,p.createElementVNode)('h3',null,[(0,p.createElementVNode)('i',{class:'fas fa-layer-group'}),(0,p.createTextVNode)(' 指定保存楼层 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-modal-close',onClick:u},[...a[1]||(a[1]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',Gu,[(0,p.createElementVNode)('div',Yu,[a[5]||(a[5]=(0,p.createElementVNode)('p',{class:'floor-hint'},'输入目标楼层索引。正数为从头开始计数，负数为倒数计数（-1 表示最后一楼）。',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'inputRef',ref:r,'onUpdate:modelValue':a[0]||(a[0]=e=>l.value=e),type:'number',class:'floor-input',placeholder:'例如: 5 或 -1',onKeydown:[(0,p.withKeys)(s,['enter']),(0,p.withKeys)(u,['escape'])]},null,544),[[p.vModelText,l.value,void 0,{number:!0}]]),e.currentFloorInfo?((0,p.openBlock)(),(0,p.createElementBlock)('div',Xu,[a[3]||(a[3]=(0,p.createElementVNode)('i',{class:'fas fa-info-circle'},null,-1)),(0,p.createElementVNode)('span',null,'当前自动目标楼层: '+(0,p.toDisplayString)(e.currentFloorInfo),1)])):(0,p.createCommentVNode)('v-if',!0),c.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ku,[a[4]||(a[4]=(0,p.createElementVNode)('i',{class:'fas fa-exclamation-circle'},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(c.value),1)])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 底部 '),(0,p.createElementVNode)('div',qu,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:u},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:!i.value,onClick:s},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-save'},null,-1),(0,p.createTextVNode)(' 保存到此楼层 ',-1)])],8,Ju)])],512)])):(0,p.createCommentVNode)('v-if',!0)}}),Qu={class:'acu-modal-body'},ed={key:0,class:'acu-loading-state'},td={class:'acu-update-layout'},ad={class:'acu-update-left'},od={class:'acu-settings-section'},nd={class:'acu-settings-row'},rd={class:'acu-settings-control acu-preset-control'},ld=['value'],id={class:'acu-settings-row'},cd={class:'acu-settings-control'},sd=['value'],ud={class:'acu-settings-section'},dd={class:'acu-settings-row'},pd={class:'acu-settings-control'},md={class:'acu-settings-row'},fd={class:'acu-settings-control'},gd={class:'acu-settings-row'},vd={class:'acu-settings-control'},bd={class:'acu-settings-row'},hd={class:'acu-settings-control'},xd={class:'acu-settings-section acu-show-mobile-only'},yd={class:'acu-collapse-indicator'},wd={class:'acu-table-selector-mobile'},kd={class:'acu-settings-section'},Cd={class:'acu-settings-row'},Nd={class:'acu-settings-control'},Vd={class:'acu-switch'},Ed={key:0,class:'acu-settings-row'},Bd={class:'acu-settings-control'},Sd={class:'acu-switch'},Td={key:0,class:'acu-settings-section'},Dd={class:'acu-update-right acu-hide-mobile'},Ad={key:0,class:'acu-issue-alert'},zd={class:'acu-update-action-group'},Id=['disabled'],_d={key:0,class:'fas fa-spinner fa-spin'},Ud={key:1,class:'fas fa-hand-sparkles'},Md=(0,p.defineComponent)({__name:'ManualUpdateDialog',props:{visible:{type:Boolean}},emits:['update:visible'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(!0),l=(0,p.ref)(!1),i=(0,p.reactive)({autoUpdateThreshold:void 0,autoUpdateFrequency:void 0,updateBatchSize:void 0,skipUpdateFloors:void 0}),c=(0,p.ref)(''),s=(0,p.ref)(''),u=Ea(),d=(0,p.ref)(!1),m=(0,p.ref)(!1),f=(0,p.ref)([]),g=(0,p.ref)([]),v=(0,p.ref)(!1),b=(0,p.ref)([]),h=(0,p.ref)([]),{settings:x,loadSettings:y,saveSettings:w,executeManualUpdate:k,getTableList:C,executeWithPreset:N}=Da(),V=Ra(),E=ea(),B=(0,p.computed)(()=>V.presets.value),S=(0,p.computed)(()=>E.hasIntegrityIssues),T=(0,p.computed)(()=>E.getIntegritySummary()),D=((0,p.computed)(()=>0!==f.value.length&&g.value.length===f.value.length),(0,p.computed)(()=>{const e=f.value.filter(e=>e.isSummaryOrOutline);return 0!==e.length&&(g.value.length===e.length&&e.every(e=>g.value.includes(e.name)))}),(0,p.computed)(()=>b.value.map(e=>({key:e,label:e})))),A=(0,p.computed)(()=>f.value.map(e=>({key:e.name,label:e.name,badge:e.isSummaryOrOutline?'★':void 0})));(0,p.computed)(()=>0!==b.value.length&&h.value.length===b.value.length);function I(){o('update:visible',!1)}async function U(e,t){if(void 0!==t&&!isNaN(t))try{await w({[e]:t}),console.info(`[ACU] 配置项 ${e} 已更新为:`,t)}catch(t){console.error(`[ACU] 保存配置项 ${e} 失败:`,t),Aa.toast.error('保存配置失败')}}async function M(){if(!c.value)return;const e=B.value.find(e=>e.id===c.value);e&&(Object.assign(i,e.settings),g.value=e.autoTrigger.updateTargetTables||[],await w(e.settings),V.setActivePreset(c.value),Aa.toast.success('已应用预设配置'))}function L(){V.setAutoFixPreset(s.value||null),Aa.toast.info(s.value?'已设置自动修复预设':'已禁用自动修复')}function P(){const e=[`上下文层数: ${i.autoUpdateThreshold}`,`更新频率: 每 ${i.autoUpdateFrequency} 层`,`批次大小: ${i.updateBatchSize}`,`跳过层数: ${i.skipUpdateFloors}`,`表格选择: ${g.value.length?g.value.join(', '):'全部表格'}`];u.openPresetSaveDialog({presetType:'manual-update',summaryItems:e,initialName:'',checkDuplicate:e=>null!==V.findPresetByName(e)},{onSave:e=>{const{preset:t,isNew:a}=V.createOrUpdatePreset(e,{autoUpdateThreshold:i.autoUpdateThreshold,updateBatchSize:i.updateBatchSize,skipUpdateFloors:i.skipUpdateFloors,autoUpdateFrequency:i.autoUpdateFrequency},{enabled:d.value,onEmptyCell:!0,onIndexGap:!0,targetTables:['总结表','大纲表'],updateTargetTables:g.value,emptyCheckColumns:h.value});a?Aa.toast.success(`预设"${e}"已创建`):Aa.toast.success(`预设"${e}"已更新`)}})}function F(){if(!c.value)return;const e=c.value,t=B.value.find(t=>t.id===e);t&&confirm(`确定删除预设"${t.name}"吗？`)&&(V.deletePreset(c.value),c.value='',Aa.toast.success('预设已删除'))}function j(){V.setGlobalAutoTrigger(d.value),c.value&&V.updatePreset(c.value,{autoTrigger:{enabled:d.value,onEmptyCell:!0,onIndexGap:!0,targetTables:['总结表','大纲表'],updateTargetTables:g.value,emptyCheckColumns:h.value}}),d.value||(m.value=!1,V.setAutoFixPreset(null),E.clearIntegrityIssues())}function R(){if(V.setGlobalAutoExecute(m.value),m.value)if(!s.value&&B.value.length>0)s.value=B.value[0].id,V.setAutoFixPreset(s.value),Aa.toast.info(`已自动选择预设"${B.value[0].name}"用于自动修复`);else{if(0===B.value.length)return Aa.toast.warning('请先保存一个预设再启用自动执行'),m.value=!1,void V.setGlobalAutoExecute(!1);V.setAutoFixPreset(s.value)}else V.setAutoFixPreset(null),s.value=''}function H(e){c.value&&V.updatePreset(c.value,{autoTrigger:{enabled:d.value,onEmptyCell:!0,onIndexGap:!0,targetTables:['总结表','大纲表'],updateTargetTables:e,emptyCheckColumns:h.value}})}function W(){c.value&&V.updatePreset(c.value,{autoTrigger:{enabled:d.value,onEmptyCell:!0,onIndexGap:!0,targetTables:['总结表','大纲表'],updateTargetTables:g.value,emptyCheckColumns:h.value}})}async function G(){if(!l.value){l.value=!0;try{const e=await N({autoUpdateThreshold:i.autoUpdateThreshold,updateBatchSize:i.updateBatchSize,skipUpdateFloors:i.skipUpdateFloors,autoUpdateFrequency:i.autoUpdateFrequency},g.value);e.success?Aa.toast.success('✅ 手动更新已执行'):Aa.toast.warning('⚠️ '+(e.message||'更新执行完成，请检查结果'))}catch(e){console.error('[ACU] 手动更新执行失败:',e),Aa.toast.error('手动更新执行失败')}finally{l.value=!1}}}return(0,p.watch)(()=>a.visible,async e=>{if(e){r.value=!0;try{await y(),Object.assign(i,{autoUpdateThreshold:x.value.autoUpdateThreshold,autoUpdateFrequency:x.value.autoUpdateFrequency,updateBatchSize:x.value.updateBatchSize,skipUpdateFloors:x.value.skipUpdateFloors}),V.loadPresets();const e=V.autoFixPreset.value?.id;s.value=e||'',d.value=V.globalAutoTriggerEnabled.value,m.value=V.globalAutoExecuteEnabled.value;const t=V.activePreset.value;t&&(g.value=t.autoTrigger.updateTargetTables||[],h.value=t.autoTrigger.emptyCheckColumns||[]),f.value=C(),function(){const e=f.value.filter(e=>e.isSummaryOrOutline);if(0===e.length)return void(b.value=[]);try{const t=window.parent?.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI;if(!t?.exportTableAsJson)return void(b.value=[]);const a=t.exportTableAsJson(),o=new Set;for(const t of e){const e=a[t.key];e?.content?.[0]&&e.content[0].forEach(e=>{const t=String(e).trim();t&&o.add(t)})}b.value=Array.from(o)}catch(e){console.warn('[ACU] 加载可用列失败:',e),b.value=[]}}()}catch(e){console.error('[ACU] 加载配置失败:',e),Aa.toast.error('加载配置失败')}finally{r.value=!1}}},{immediate:!0}),O(n,()=>{I()}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(I,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:n,class:'acu-modal acu-manual-update-modal'},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',{class:'acu-modal-header'},[(0,p.createCommentVNode)(' 返回按钮 '),(0,p.createElementVNode)('button',{class:'acu-modal-back',onClick:I},[...a[16]||(a[16]=[(0,p.createElementVNode)('i',{class:'fas fa-arrow-left'},null,-1)])]),a[17]||(a[17]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'手动更新配置',-1)),(0,p.createCommentVNode)(' 胶囊式完成按钮 '),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:I},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',Qu,[(0,p.createCommentVNode)(' 加载状态 '),r.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',ed,[...a[18]||(a[18]=[(0,p.createElementVNode)('i',{class:'fas fa-spinner fa-spin'},null,-1),(0,p.createElementVNode)('span',null,'加载配置中...',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 配置项 '),(0,p.createCommentVNode)(' PC端并排布局 '),(0,p.createElementVNode)('div',td,[(0,p.createCommentVNode)(' 左侧：参数设置 '),(0,p.createElementVNode)('div',ad,[(0,p.createCommentVNode)(' 预设管理区域 '),(0,p.createElementVNode)('div',od,[a[25]||(a[25]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-bookmark'}),(0,p.createTextVNode)(' 预设管理 ')],-1)),(0,p.createCommentVNode)(' 预设选择 '),(0,p.createElementVNode)('div',nd,[a[22]||(a[22]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 选择预设 '),(0,p.createElementVNode)('span',{class:'hint'},'快速应用保存的配置')],-1)),(0,p.createElementVNode)('div',rd,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[0]||(a[0]=e=>c.value=e),class:'acu-config-select',onChange:M},[a[19]||(a[19]=(0,p.createElementVNode)('option',{value:''},'-- 当前配置 --',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(B.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.id,value:e.id},(0,p.toDisplayString)(e.name),9,ld))),128))],544),[[p.vModelSelect,c.value]]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'保存为新预设',onClick:P},[...a[20]||(a[20]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),c.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-tool-btn acu-btn-danger',title:'删除预设',onClick:F},[...a[21]||(a[21]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 自动修复预设 '),(0,p.createElementVNode)('div',id,[a[24]||(a[24]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 检测问题时使用 '),(0,p.createElementVNode)('span',{class:'hint'},'检测到问题时自动应用此预设')],-1)),(0,p.createElementVNode)('div',cd,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[1]||(a[1]=e=>s.value=e),class:'acu-config-select',onChange:L},[a[23]||(a[23]=(0,p.createElementVNode)('option',{value:''},'-- 禁用 --',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(B.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.id,value:e.id},(0,p.toDisplayString)(e.name),9,sd))),128))],544),[[p.vModelSelect,s.value]])])])]),(0,p.createCommentVNode)(' 参数设置区域 '),(0,p.createElementVNode)('div',ud,[a[30]||(a[30]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-sliders-h'}),(0,p.createTextVNode)(' 更新参数设置 ')],-1)),(0,p.createCommentVNode)(' AI读取上下文层数 '),(0,p.createElementVNode)('div',dd,[a[26]||(a[26]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' AI读取上下文层数 '),(0,p.createElementVNode)('span',{class:'hint'},'AI阅读最近多少层来理解剧情')],-1)),(0,p.createElementVNode)('div',pd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>i.autoUpdateThreshold=e),type:'number',class:'acu-config-input',min:'1',max:'500',onChange:a[3]||(a[3]=e=>U('autoUpdateThreshold',i.autoUpdateThreshold))},null,544),[[p.vModelText,i.autoUpdateThreshold,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 每N层自动更新一次 '),(0,p.createElementVNode)('div',md,[a[27]||(a[27]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 每N层自动更新一次 '),(0,p.createElementVNode)('span',{class:'hint'},'设置自动触发更新的楼层间隔')],-1)),(0,p.createElementVNode)('div',fd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>i.autoUpdateFrequency=e),type:'number',class:'acu-config-input',min:'1',max:'100',onChange:a[5]||(a[5]=e=>U('autoUpdateFrequency',i.autoUpdateFrequency))},null,544),[[p.vModelText,i.autoUpdateFrequency,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 每批次更新楼层数 '),(0,p.createElementVNode)('div',gd,[a[28]||(a[28]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 每批次更新楼层数 '),(0,p.createElementVNode)('span',{class:'hint'},'单次更新处理的最大楼层数')],-1)),(0,p.createElementVNode)('div',vd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>i.updateBatchSize=e),type:'number',class:'acu-config-input',min:'1',max:'50',onChange:a[7]||(a[7]=e=>U('updateBatchSize',i.updateBatchSize))},null,544),[[p.vModelText,i.updateBatchSize,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 保留X层楼不更新 '),(0,p.createElementVNode)('div',bd,[a[29]||(a[29]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 保留X层楼不更新 '),(0,p.createElementVNode)('span',{class:'hint'},'最近的几层楼跳过更新')],-1)),(0,p.createElementVNode)('div',hd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[8]||(a[8]=e=>i.skipUpdateFloors=e),type:'number',class:'acu-config-input',min:'0',max:'20',onChange:a[9]||(a[9]=e=>U('skipUpdateFloors',i.skipUpdateFloors))},null,544),[[p.vModelText,i.skipUpdateFloors,void 0,{number:!0}]])])])]),(0,p.createCommentVNode)(' 移动端：折叠式表格选择（放在智能检测之前） '),(0,p.createElementVNode)('div',xd,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-settings-title acu-collapsible',{'is-expanded':v.value}]),onClick:a[10]||(a[10]=e=>v.value=!v.value)},[a[31]||(a[31]=(0,p.createElementVNode)('i',{class:'fas fa-table'},null,-1)),a[32]||(a[32]=(0,p.createTextVNode)(' 更新表格选择 ',-1)),(0,p.createElementVNode)('span',yd,(0,p.toDisplayString)(v.value?'▲':'▼'),1)],2),(0,p.withDirectives)((0,p.createElementVNode)('div',wd,[(0,p.createVNode)((0,p.unref)(Fr),{modelValue:g.value,'onUpdate:modelValue':[a[11]||(a[11]=e=>g.value=e),H],items:A.value,'empty-text':'暂无可用表格','footer-template':'已选择: {selected}/{total} 个表格','empty-hint':'(更新全部)'},null,8,['modelValue','items'])],512),[[p.vShow,v.value]])]),(0,p.createCommentVNode)(' 智能检测设置 '),(0,p.createElementVNode)('div',kd,[a[37]||(a[37]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-magic'}),(0,p.createTextVNode)(' 智能检测 ')],-1)),(0,p.createCommentVNode)(' 启用智能检测 '),(0,p.createElementVNode)('div',Cd,[a[34]||(a[34]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 启用问题检测提示 '),(0,p.createElementVNode)('span',{class:'hint'},'检测编码索引断裂或空单元格时显示警告')],-1)),(0,p.createElementVNode)('div',Nd,[(0,p.createElementVNode)('label',Vd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[12]||(a[12]=e=>d.value=e),type:'checkbox',onChange:j},null,544),[[p.vModelCheckbox,d.value]]),a[33]||(a[33]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])]),(0,p.createCommentVNode)(' 自动执行修复 '),d.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ed,[a[36]||(a[36]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 检测到问题时自动执行 '),(0,p.createElementVNode)('span',{class:'hint'},'自动按选定预设触发手动更新')],-1)),(0,p.createElementVNode)('div',Bd,[(0,p.createElementVNode)('label',Sd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[13]||(a[13]=e=>m.value=e),type:'checkbox',onChange:R},null,544),[[p.vModelCheckbox,m.value]]),a[35]||(a[35]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 空值检测列设置（仅当启用智能检测时显示） '),d.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Td,[a[38]||(a[38]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-columns'}),(0,p.createTextVNode)(' 空值检测列 ')],-1)),(0,p.createVNode)((0,p.unref)(Fr),{modelValue:h.value,'onUpdate:modelValue':[a[14]||(a[14]=e=>h.value=e),W],items:D.value,'empty-text':'暂无可用列（请先选择总结表/大纲表）','footer-template':'已选择: {selected}/{total} 列','empty-hint':'(检测全部)'},null,8,['modelValue','items'])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 右侧：表格选择 (PC端显示) '),(0,p.createElementVNode)('div',Dd,[(0,p.createVNode)((0,p.unref)(Fr),{modelValue:g.value,'onUpdate:modelValue':[a[15]||(a[15]=e=>g.value=e),H],items:A.value,'empty-text':'暂无可用表格','footer-template':'已选择: {selected}/{total} 个表格','empty-hint':'(更新全部)'},null,8,['modelValue','items'])])]),(0,p.createCommentVNode)(' 问题提示 '),S.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ad,[a[39]||(a[39]=(0,p.createElementVNode)('i',{class:'fas fa-exclamation-triangle'},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(T.value),1)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 执行按钮 '),(0,p.createElementVNode)('div',zd,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-update-btn',{'is-updating':l.value}]),disabled:l.value,onClick:G},[l.value?((0,p.openBlock)(),(0,p.createElementBlock)('i',_d)):((0,p.openBlock)(),(0,p.createElementBlock)('i',Ud)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(l.value?'正在更新...':'立即执行手动更新'),1)],10,Id)])],64))])],512),(0,p.createCommentVNode)(' 预设保存弹窗已迁移到全局 App.vue 中 ')])):(0,p.createCommentVNode)('v-if',!0)}});d(778);const Ld=(0,on.A)(Md,[['__scopeId','data-v-5df49713']]),$d={class:'acu-modal acu-preset-save-modal'},Pd={class:'acu-modal-header'},Fd={class:'acu-modal-body'},jd={class:'acu-settings-group'},Rd={key:0,class:'acu-preset-warning'},Od={key:1,class:'acu-preset-summary'},Hd={class:'acu-preset-summary-list'},Wd={class:'acu-modal-footer'},Gd=['disabled'],Yd=(0,p.defineComponent)({__name:'PresetSaveDialog',props:{visible:{type:Boolean},presetType:{default:'manual-update'},summaryItems:{default:()=>[]},initialName:{default:''},checkDuplicate:{type:Function,default:()=>!1}},emits:['update:visible','save'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(null),r=(0,p.ref)(''),l=(0,p.computed)(()=>r.value.trim().length>0),i=(0,p.computed)(()=>{const e=r.value.trim();return!!e&&(a.checkDuplicate?.(e)??!1)});function c(){o('update:visible',!1)}function s(){const e=r.value.trim();e&&(o('save',e),o('update:visible',!1))}return(0,p.watch)(()=>a.visible,e=>{e&&(r.value=a.initialName||'',(0,p.nextTick)(()=>{n.value?.focus()}))},{immediate:!0}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(c,['self'])},[(0,p.createElementVNode)('div',$d,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Pd,[a[1]||(a[1]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'保存为预设',-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(c,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',Fd,[(0,p.createCommentVNode)(' 预设名称输入 '),(0,p.createElementVNode)('div',jd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'inputRef',ref:n,'onUpdate:modelValue':a[0]||(a[0]=e=>r.value=e),type:'text',class:'acu-settings-input',placeholder:'输入预设名称',onKeyup:(0,p.withKeys)(s,['enter'])},null,544),[[p.vModelText,r.value]])]),(0,p.createCommentVNode)(' 重名警告 '),i.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Rd,[...a[2]||(a[2]=[(0,p.createElementVNode)('i',{class:'fas fa-exclamation-circle'},null,-1),(0,p.createTextVNode)(' 已存在同名预设，保存将覆盖原有配置 ',-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 保存内容摘要 '),e.summaryItems.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Od,[a[3]||(a[3]=(0,p.createElementVNode)('div',{class:'acu-preset-summary-title'},'将保存以下配置：',-1)),(0,p.createElementVNode)('ul',Hd,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.summaryItems,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('li',{key:t},(0,p.toDisplayString)(e),1))),128))])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 底部按钮 '),(0,p.createElementVNode)('div',Wd,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(c,['stop'])},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:!l.value,onClick:(0,p.withModifiers)(s,['stop'])},(0,p.toDisplayString)(i.value?'覆盖保存':'保存'),9,Gd)])])])):(0,p.createCommentVNode)('v-if',!0)}});d(833);const Xd=(0,on.A)(Yd,[['__scopeId','data-v-77000456']]),Kd={class:'acu-purge-content'},qd={class:'acu-purge-inputs'},Jd={class:'acu-purge-btns'},Zd={class:'acu-purge-btns-right'},Qd=['disabled'],ep=(0,p.defineComponent)({__name:'PurgeRangeDialog',props:{visible:{type:Boolean},maxFloor:{default:999}},emits:['update:visible','confirm','advanced-confirm'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=(0,p.ref)(),l=(0,p.ref)(),i=(0,p.ref)(null),c=(0,p.ref)(null),s=(0,p.ref)(!1),u=(0,p.ref)(!1);const d=(0,p.computed)(()=>null!==i.value&&null!==c.value&&(!isNaN(i.value)&&!isNaN(c.value)&&(!(i.value<0||c.value<0)&&!(i.value>c.value))));(0,p.watch)(()=>a.visible,e=>{if(e){const e=function(){let e=window.SillyTavern||(window.parent?window.parent.SillyTavern:null);!e&&window.top&&window.top.SillyTavern&&(e=window.top.SillyTavern);let t=-1,a=0;if(e&&e.chat){a=Math.max(0,e.chat.length-1);for(let a=e.chat.length-1;a>=0;a--){const o=e.chat[a];if(!o.is_user&&o.TavernDB_ACU_IsolatedData){const e=Object.keys(o.TavernDB_ACU_IsolatedData);let n=!1;for(const t of e){const e=o.TavernDB_ACU_IsolatedData[t];if(e&&e.independentData&&Object.keys(e.independentData).length>0){n=!0;break}}if(n){t=a;break}}}}return{start:-1!==t?t:a,end:-1!==t?t:a}}();i.value=e.start,c.value=e.end,s.value=!1}}),O(n,()=>{g()});const m=()=>{l.value?.focus()},f=()=>{d.value&&null!==i.value&&null!==c.value?(o('confirm',i.value,c.value),o('update:visible',!1)):(s.value=!0,setTimeout(()=>{s.value=!1},500),Aa.toast.warning('请输入有效的楼层范围 (Start <= End)'))},g=()=>{o('update:visible',!1)},v=()=>{u.value=!0},b=e=>{o('advanced-confirm',e),o('update:visible',!1)};return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,null,[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-purge-overlay',onClick:(0,p.withModifiers)(g,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:n,class:'acu-modal acu-purge-range-modal'},[(0,p.createCommentVNode)(' 标题区 '),a[7]||(a[7]=(0,p.createElementVNode)('div',{class:'acu-purge-title'},'清除数据范围',-1)),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',Kd,[(0,p.createCommentVNode)(' 装饰图标 '),a[4]||(a[4]=(0,p.createElementVNode)('div',{class:'acu-purge-icon'},[(0,p.createElementVNode)('i',{class:'fa-solid fa-eraser'})],-1)),(0,p.createCommentVNode)(' 提示文字 '),a[5]||(a[5]=(0,p.createElementVNode)('p',{class:'acu-purge-hint'},[(0,p.createTextVNode)(' 请输入要清除数据的楼层范围'),(0,p.createElementVNode)('br'),(0,p.createElementVNode)('span',{class:'acu-purge-hint-sub'},'(起始楼层 - 结束楼层)')],-1)),(0,p.createCommentVNode)(' 范围输入 '),(0,p.createElementVNode)('div',qd,[(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'startInputRef',ref:r,'onUpdate:modelValue':a[0]||(a[0]=e=>i.value=e),type:'number',class:'acu-purge-input',placeholder:'Start',min:'0',onKeydown:(0,p.withKeys)(m,['enter'])},null,544),[[p.vModelText,i.value,void 0,{number:!0}]]),a[3]||(a[3]=(0,p.createElementVNode)('span',{class:'acu-purge-separator'},'-',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'endInputRef',ref:l,'onUpdate:modelValue':a[1]||(a[1]=e=>c.value=e),type:'number',class:'acu-purge-input',placeholder:'End',min:'0',onKeydown:(0,p.withKeys)(f,['enter'])},null,544),[[p.vModelText,c.value,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 按钮区 '),(0,p.createElementVNode)('div',Jd,[(0,p.createElementVNode)('button',{class:'acu-purge-btn acu-purge-btn-advanced',onClick:v},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-cogs'},null,-1),(0,p.createTextVNode)(' 高级 ',-1)])]),(0,p.createElementVNode)('div',Zd,[(0,p.createElementVNode)('button',{class:'acu-purge-btn acu-purge-btn-cancel',onClick:g},'取消'),(0,p.createElementVNode)('button',{class:'acu-purge-btn acu-purge-btn-confirm',disabled:!d.value,onClick:f},' 确认清除 ',8,Qd)])])],512)])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 高级清除弹窗 '),(0,p.createVNode)(xs,{visible:u.value,'onUpdate:visible':a[2]||(a[2]=e=>u.value=e),'initial-start-floor':i.value??void 0,'initial-end-floor':c.value??void 0,onConfirm:b},null,8,['visible','initial-start-floor','initial-end-floor'])],64))}}),tp={class:'acu-ball-appearance-panel'},ap={class:'acu-ball-preview-fixed'},op=['src'],np={key:3,class:'fa-solid fa-image'},rp={class:'acu-ball-scroll-content'},lp={class:'acu-settings-section'},ip={class:'acu-settings-title-row'},cp={class:'acu-preview-buttons'},sp={class:'acu-anim-grid'},up={class:'acu-settings-section'},dp={class:'acu-settings-group'},pp={class:'acu-settings-row'},mp={class:'acu-settings-control acu-color-picker-inline'},fp={class:'acu-settings-row'},gp={class:'acu-settings-label'},vp={class:'hint'},bp={class:'acu-settings-control'},hp={class:'acu-settings-section'},xp={class:'acu-settings-group'},yp={class:'acu-settings-row'},wp={class:'acu-settings-control acu-color-picker-inline'},kp={class:'acu-settings-row'},Cp={class:'acu-settings-label'},Np={class:'hint'},Vp={class:'acu-settings-control'},Ep={class:'acu-settings-section'},Bp={class:'acu-settings-group'},Sp={class:'acu-settings-row'},Tp={class:'acu-settings-label'},Dp={class:'hint'},Ap={class:'acu-settings-control'},zp={class:'acu-settings-section'},Ip={class:'acu-icon-type-row'},_p={key:0,class:'acu-icon-input-area'},Up={class:'acu-icon-input'},Mp={key:1,class:'acu-icon-input-area'},Lp={class:'acu-emoji-input'},$p={class:'acu-icon-input-area'},Pp={class:'acu-url-input'},Fp={key:0,class:'acu-image-preview-row',style:{'margin-top':'10px'}},jp={class:'acu-image-actions'},Rp={class:'acu-icon-input-area'},Op={class:'acu-image-preview-row'},Hp={class:'acu-image-actions'},Wp=(0,p.defineComponent)({__name:'BallAppearancePanel',setup(e){const t=Ee(),a=Ea(),o=(0,p.reactive)({...t.appearance}),n=(0,p.ref)(!1),r=(0,p.ref)(!1),l=(0,p.ref)(),i=(0,p.ref)('local'),c=(0,p.ref)(''),s=(0,p.computed)(()=>'image'===o.type&&'url'===i.value);'image'===o.type&&o.content?.startsWith('http')&&(i.value='url',c.value=o.content),(0,p.watch)(o,e=>{t.updateAppearance(e)},{deep:!0});const u=(0,p.computed)(()=>({'p-anim-ripple':n.value&&'ripple'===o.notifyAnimation,'p-anim-arc':n.value&&'arc'===o.notifyAnimation,'p-notify':r.value})),d=(0,p.computed)(()=>({'--ball-size':`${o.size}px`,'--ball-border-color':o.borderColor,'--ball-border-color-rgba':ht(o.borderColor,o.borderOpacity),'--ball-bg-color':ht(o.bgColor,o.bgOpacity)})),m=(0,p.computed)(()=>o.content?{backgroundImage:`url('${o.content}')`,backgroundPosition:`${o.imageOffsetX??50}% ${o.imageOffsetY??50}%`,backgroundSize:`${o.imageScale??150}%`,backgroundRepeat:'no-repeat'}:{});function f(){n.value=!0,r.value=!1,setTimeout(()=>{n.value=!1},3e3)}function g(){r.value=!0,n.value=!1,setTimeout(()=>{r.value=!1},3e3)}function v(){o.type='image',i.value='local',l.value?.click()}function b(){o.type='image',i.value='url',o.content&&!o.content.startsWith('http')&&(o.content=''),o.content?.startsWith('http')&&(c.value=o.content)}function h(){const e=c.value.trim();e&&e.startsWith('http')&&(o.content=e,o.imageOffsetX=50,o.imageOffsetY=50,o.imageScale=150)}async function x(e){const t=e.target,a=t.files?.[0];if(a){try{let e=await vt(a);e=await bt(e,100,.8),o.content=e,o.imageOffsetX=50,o.imageOffsetY=50,o.imageScale=150,y()}catch(e){console.error('[ACU] 图片上传失败:',e)}t.value=''}}function y(){o.content&&a.openAvatarCropDialog({imageUrl:o.content,name:'悬浮球图片',initialOffsetX:o.imageOffsetX??50,initialOffsetY:o.imageOffsetY??50,initialScale:o.imageScale??150,initialInvert:o.imageInvert??!1,showInvertOption:!0},{onApply:e=>{o.imageOffsetX=e.offsetX,o.imageOffsetY=e.offsetY,o.imageScale=e.scale,void 0!==e.invert&&(o.imageInvert=e.invert)},onUpload:async e=>{try{let t=await vt(e);t=await bt(t,100,.8),o.content=t,o.imageOffsetX=50,o.imageOffsetY=50,o.imageScale=150}catch(e){console.error('[ACU] 图片上传失败:',e)}}})}function w(){o.content='',o.imageOffsetX=50,o.imageOffsetY=50,o.imageScale=150}function k(){Object.assign(o,ve)}return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',tp,[(0,p.createCommentVNode)(' 预览区域 - 固定在顶部（使用 position: absolute） '),(0,p.createElementVNode)('div',ap,[(0,p.createElementVNode)('button',{class:'acu-icon-btn acu-reset-btn',title:'重置为默认',onClick:(0,p.withModifiers)(k,['stop'])},[...t[15]||(t[15]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1)])]),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-ball-preview',u.value]),style:(0,p.normalizeStyle)(d.value)},['icon'===o.type?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(['fa-solid',o.content])},null,2)):'emoji'===o.type?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createTextVNode)((0,p.toDisplayString)(o.content),1)],64)):'image'===o.type&&o.content?((0,p.openBlock)(),(0,p.createElementBlock)('img',{key:2,src:o.content,alt:''},null,8,op)):((0,p.openBlock)(),(0,p.createElementBlock)('i',np))],6)]),(0,p.createCommentVNode)(' 可滚动内容区 '),(0,p.createElementVNode)('div',rp,[(0,p.createCommentVNode)(' 通知动画类型 - 标题与按钮同行 '),(0,p.createElementVNode)('div',lp,[(0,p.createElementVNode)('div',ip,[t[16]||(t[16]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-bell'}),(0,p.createTextVNode)(' AI 填表通知动画 ')],-1)),(0,p.createElementVNode)('div',cp,[(0,p.createElementVNode)('button',{class:'acu-tool-btn',onClick:(0,p.withModifiers)(f,['stop'])},'▶️ 播放'),(0,p.createElementVNode)('button',{class:'acu-tool-btn',onClick:(0,p.withModifiers)(g,['stop'])},'🔔 通知')])]),(0,p.createElementVNode)('div',sp,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-anim-option',{active:'ripple'===o.notifyAnimation}]),onClick:t[0]||(t[0]=(0,p.withModifiers)(e=>o.notifyAnimation='ripple',['stop']))},[...t[17]||(t[17]=[(0,p.createElementVNode)('span',{class:'acu-anim-icon'},'🌊',-1),(0,p.createElementVNode)('span',{class:'acu-anim-name'},'脉冲波纹',-1)])],2),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-anim-option',{active:'arc'===o.notifyAnimation}]),onClick:t[1]||(t[1]=(0,p.withModifiers)(e=>o.notifyAnimation='arc',['stop']))},[...t[18]||(t[18]=[(0,p.createElementVNode)('span',{class:'acu-anim-icon'},'⚡',-1),(0,p.createElementVNode)('span',{class:'acu-anim-name'},'电磁闪烁',-1)])],2)])]),(0,p.createCommentVNode)(' 边框颜色 '),(0,p.createElementVNode)('div',up,[t[21]||(t[21]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 边框颜色 ')],-1)),(0,p.createElementVNode)('div',dp,[(0,p.createElementVNode)('div',pp,[t[19]||(t[19]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},'颜色',-1)),(0,p.createElementVNode)('div',mp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[2]||(t[2]=e=>o.borderColor=e),type:'text',class:'acu-color-input',placeholder:'#RRGGBB'},null,512),[[p.vModelText,o.borderColor]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[3]||(t[3]=e=>o.borderColor=e),type:'color',class:'acu-color-swatch acu-dashed'},null,512),[[p.vModelText,o.borderColor]])])]),(0,p.createElementVNode)('div',fp,[(0,p.createElementVNode)('div',gp,[t[20]||(t[20]=(0,p.createTextVNode)(' 透明度 ',-1)),(0,p.createElementVNode)('span',vp,(0,p.toDisplayString)(o.borderOpacity)+'%',1)]),(0,p.createElementVNode)('div',bp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[4]||(t[4]=e=>o.borderOpacity=e),type:'range',min:'0',max:'100',step:'5'},null,512),[[p.vModelText,o.borderOpacity,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 背景颜色 '),(0,p.createElementVNode)('div',hp,[t[24]||(t[24]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-fill-drip'}),(0,p.createTextVNode)(' 背景颜色 ')],-1)),(0,p.createElementVNode)('div',xp,[(0,p.createElementVNode)('div',yp,[t[22]||(t[22]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},'颜色',-1)),(0,p.createElementVNode)('div',wp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[5]||(t[5]=e=>o.bgColor=e),type:'text',class:'acu-color-input',placeholder:'#RRGGBB'},null,512),[[p.vModelText,o.bgColor]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[6]||(t[6]=e=>o.bgColor=e),type:'color',class:'acu-color-swatch'},null,512),[[p.vModelText,o.bgColor]])])]),(0,p.createElementVNode)('div',kp,[(0,p.createElementVNode)('div',Cp,[t[23]||(t[23]=(0,p.createTextVNode)(' 透明度 ',-1)),(0,p.createElementVNode)('span',Np,(0,p.toDisplayString)(o.bgOpacity)+'%',1)]),(0,p.createElementVNode)('div',Vp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[7]||(t[7]=e=>o.bgOpacity=e),type:'range',min:'0',max:'100',step:'5'},null,512),[[p.vModelText,o.bgOpacity,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 尺寸 '),(0,p.createElementVNode)('div',Ep,[t[26]||(t[26]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-expand-arrows-alt'}),(0,p.createTextVNode)(' 尺寸 ')],-1)),(0,p.createElementVNode)('div',Bp,[(0,p.createElementVNode)('div',Sp,[(0,p.createElementVNode)('div',Tp,[t[25]||(t[25]=(0,p.createTextVNode)(' 球体大小 ',-1)),(0,p.createElementVNode)('span',Dp,(0,p.toDisplayString)(o.size)+'px',1)]),(0,p.createElementVNode)('div',Ap,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[8]||(t[8]=e=>o.size=e),type:'range',min:'40',max:'100',step:'2'},null,512),[[p.vModelText,o.size,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 图标类型 '),(0,p.createElementVNode)('div',zp,[t[44]||(t[44]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-icons'}),(0,p.createTextVNode)(' 图标 ')],-1)),(0,p.createCommentVNode)(' 图标类型按钮 - 图标和文字同行 '),(0,p.createElementVNode)('div',Ip,[(0,p.createElementVNode)('label',{class:(0,p.normalizeClass)(['acu-type-btn',{active:'icon'===o.type}])},[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[9]||(t[9]=e=>o.type=e),type:'radio',value:'icon'},null,512),[[p.vModelRadio,o.type]]),t[27]||(t[27]=(0,p.createElementVNode)('i',{class:'fa-solid fa-icons'},null,-1)),t[28]||(t[28]=(0,p.createElementVNode)('span',null,'FA图标',-1))],2),(0,p.createElementVNode)('label',{class:(0,p.normalizeClass)(['acu-type-btn',{active:'emoji'===o.type}])},[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[10]||(t[10]=e=>o.type=e),type:'radio',value:'emoji'},null,512),[[p.vModelRadio,o.type]]),t[29]||(t[29]=(0,p.createElementVNode)('span',{class:'emoji-icon'},'😀',-1)),t[30]||(t[30]=(0,p.createElementVNode)('span',null,'Emoji',-1))],2),(0,p.createCommentVNode)(' 本地图片按钮 - 点击直接上传 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-type-btn',{active:'image'===o.type&&!s.value}]),onClick:(0,p.withModifiers)(v,['stop'])},[(0,p.createElementVNode)('input',{ref_key:'imageInputRef',ref:l,type:'file',accept:'image/*',hidden:'',onChange:x},null,544),t[31]||(t[31]=(0,p.createElementVNode)('i',{class:'fa-solid fa-image'},null,-1)),t[32]||(t[32]=(0,p.createElementVNode)('span',null,'图片',-1))],2),(0,p.createCommentVNode)(' URL 图片按钮 '),(0,p.createElementVNode)('label',{class:(0,p.normalizeClass)(['acu-type-btn',{active:'image'===o.type&&s.value}])},[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[11]||(t[11]=e=>i.value=e),type:'radio',value:'url',onChange:b},null,544),[[p.vModelRadio,i.value]]),t[33]||(t[33]=(0,p.createElementVNode)('i',{class:'fa-solid fa-link'},null,-1)),t[34]||(t[34]=(0,p.createElementVNode)('span',null,'URL',-1))],2)]),(0,p.createCommentVNode)(' 根据类型显示不同输入（仅图标/Emoji需要输入，图片无需额外输入） '),'icon'===o.type?((0,p.openBlock)(),(0,p.createElementBlock)('div',_p,[(0,p.createElementVNode)('div',Up,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[12]||(t[12]=e=>o.content=e),placeholder:'fa-layer-group'},null,512),[[p.vModelText,o.content]]),t[35]||(t[35]=(0,p.createElementVNode)('span',{class:'acu-input-hint'},'输入 FontAwesome 图标类名',-1))])])):'emoji'===o.type?((0,p.openBlock)(),(0,p.createElementBlock)('div',Mp,[(0,p.createElementVNode)('div',Lp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[13]||(t[13]=e=>o.content=e),placeholder:'🎭'},null,512),[[p.vModelText,o.content]]),t[36]||(t[36]=(0,p.createElementVNode)('span',{class:'acu-input-hint'},'输入 Emoji 表情',-1))])])):'image'===o.type&&s.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' URL 图片模式：显示 URL 输入框 '),(0,p.createElementVNode)('div',$p,[(0,p.createElementVNode)('div',Pp,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[14]||(t[14]=e=>c.value=e),placeholder:'https://example.com/image.png',onBlur:h,onKeyup:(0,p.withKeys)(h,['enter'])},null,544),[[p.vModelText,c.value]]),t[37]||(t[37]=(0,p.createElementVNode)('span',{class:'acu-input-hint'},'输入图片 URL（支持 catbox、imgur 等外链）',-1))]),(0,p.createCommentVNode)(' 如果有图片，显示预览和调整按钮 '),o.content&&o.content.startsWith('http')?((0,p.openBlock)(),(0,p.createElementBlock)('div',Fp,[(0,p.createElementVNode)('div',{class:'acu-preview-thumb-wrapper',style:(0,p.normalizeStyle)(m.value),onClick:(0,p.withModifiers)(y,['stop'])},[...t[38]||(t[38]=[(0,p.createElementVNode)('span',{class:'acu-edit-hint'},[(0,p.createElementVNode)('i',{class:'fas fa-crop-simple'})],-1)])],4),(0,p.createElementVNode)('div',jp,[(0,p.createElementVNode)('button',{class:'acu-adjust-btn',onClick:(0,p.withModifiers)(y,['stop'])},[...t[39]||(t[39]=[(0,p.createElementVNode)('i',{class:'fas fa-crop-simple'},null,-1),(0,p.createTextVNode)(' 调整 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-adjust-btn',style:{'margin-left':'8px'},onClick:(0,p.withModifiers)(w,['stop'])},[...t[40]||(t[40]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createTextVNode)(' 清除 ',-1)])])])])):(0,p.createCommentVNode)('v-if',!0)])],2112)):'image'===o.type&&o.content?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:3},[(0,p.createCommentVNode)(' 本地图片模式：已上传时显示调整和清除按钮 '),(0,p.createElementVNode)('div',Rp,[(0,p.createElementVNode)('div',Op,[(0,p.createElementVNode)('div',{class:'acu-preview-thumb-wrapper',style:(0,p.normalizeStyle)(m.value),onClick:(0,p.withModifiers)(y,['stop'])},[...t[41]||(t[41]=[(0,p.createElementVNode)('span',{class:'acu-edit-hint'},[(0,p.createElementVNode)('i',{class:'fas fa-crop-simple'})],-1)])],4),(0,p.createElementVNode)('div',Hp,[(0,p.createElementVNode)('button',{class:'acu-adjust-btn',onClick:(0,p.withModifiers)(y,['stop'])},[...t[42]||(t[42]=[(0,p.createElementVNode)('i',{class:'fas fa-crop-simple'},null,-1),(0,p.createTextVNode)(' 调整 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-adjust-btn',style:{'margin-left':'8px'},onClick:(0,p.withModifiers)(w,['stop'])},[...t[43]||(t[43]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createTextVNode)(' 清除 ',-1)])])])])])],2112)):(0,p.createCommentVNode)('v-if',!0)])])]))}}),Gp={class:'acu-button-config-panel'},Yp={class:'acu-settings-row'},Xp={class:'acu-settings-control'},Kp={class:'acu-config-section acu-visible-area'},qp={key:0,class:'acu-btn-visible-grid'},Jp=['title','onClick','onDragstart','onDragover','onDrop'],Zp={key:0,class:'required-dot'},Qp=['title','onClick'],em=['onClick'],tm={key:1,class:'acu-empty-hint'},am={class:'acu-config-section acu-hidden-area'},om={key:0,class:'acu-btn-hidden-grid'},nm=['title','onClick'],rm={key:1,class:'acu-empty-hint'},lm={class:'picker-header'},im={class:'picker-content'},cm={class:'picker-hint'},sm={class:'picker-options'},um=['onClick'],dm=(0,p.defineComponent)({__name:'NavButtonConfigPanel',setup(e){const t=Ve(),a=e=>{const t=be.find(t=>t.id===e);return t?.icon||'fa-circle'},o=e=>{const t=be.find(t=>t.id===e);return t?.label||e},n=(0,p.computed)(()=>{const e=t.config.buttonOrder,a=t.config.visibleButtons,o=t.config.buttonGroups||[];return e.filter(e=>a.includes(e)).map(e=>{const t=be.find(t=>t.id===e),a=o.find(t=>t.primaryId===e);return{id:e,icon:t?.icon||'fa-circle',label:t?.label||e,secondaryId:a?.secondaryId||null}})}),r=(0,p.computed)(()=>{const e=t.config.visibleButtons,a=(t.config.buttonGroups||[]).map(e=>e.secondaryId).filter(Boolean);return be.filter(t=>!t.hidden&&!e.includes(t.id)&&!a.includes(t.id))}),l=(0,p.computed)(()=>{const e=(t.config.buttonGroups||[]).map(e=>e.secondaryId).filter(Boolean);return be.filter(t=>t.id!==u.value&&!e.includes(t.id))}),i=(0,p.ref)(null),c=e=>{e.target.classList.remove('dragging');document.querySelectorAll('.acu-button-card').forEach(e=>e.classList.remove('drop-target')),i.value=null},s=(0,p.ref)(!1),u=(0,p.ref)(''),d=()=>{s.value=!1,u.value=''},m=()=>{t.resetButtonConfig()};return(e,f)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Gp,[(0,p.createCommentVNode)(' 长按直接执行开关 - 使用设置面板的行开关样式 '),(0,p.createElementVNode)('div',Yp,[f[2]||(f[2]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 长按直接执行 '),(0,p.createElementVNode)('span',{class:'hint'},'开启后，长按将跳过弹出按钮，直接执行附属功能')],-1)),(0,p.createElementVNode)('div',Xp,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(t).longPressDirectExec}]),onClick:f[0]||(f[0]=(0,p.withModifiers)(e=>(0,p.unref)(t).toggleLongPressDirectExec(),['stop']))},null,2)])]),(0,p.createCommentVNode)(' 展示区：网格布局，只显示图标 '),(0,p.createElementVNode)('div',Kp,[(0,p.createElementVNode)('h4',null,[f[4]||(f[4]=(0,p.createElementVNode)('i',{class:'fas fa-th-large'},null,-1)),(0,p.createTextVNode)(' 展示中 ('+(0,p.toDisplayString)(n.value.length)+') ',1),(0,p.createElementVNode)('button',{class:'acu-btn-text acu-btn-reset',onClick:(0,p.withModifiers)(m,['stop'])},[...f[3]||(f[3]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 重置',-1)])])]),n.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',qp,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n.value,(e,n)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['acu-btn-config-item',{'is-required':'settings'===e.id}]),title:e.label+('settings'===e.id?' (必选)':' (点击移除)'),draggable:'true',onClick:(0,p.withModifiers)(a=>(e=>{if('settings'===e)return;const a=[...t.config.visibleButtons],o=a.indexOf(e);o>-1&&(a.splice(o,1),t.setVisibleButtons(a))})(e.id),['stop']),onDragstart:e=>((e,t)=>{i.value=t,e.dataTransfer&&(e.dataTransfer.effectAllowed='move',e.dataTransfer.setData('text/plain',String(t))),e.target.classList.add('dragging')})(e,n),onDragover:(0,p.withModifiers)(e=>((e,t)=>{if(e.preventDefault(),null===i.value||i.value===t)return;document.querySelectorAll('.acu-button-card').forEach(e=>e.classList.remove('drop-target')),e.currentTarget.classList.add('drop-target')})(e,n),['prevent']),onDrop:e=>((e,a)=>{if(e.preventDefault(),null===i.value||i.value===a)return;const o=[...t.config.buttonOrder],n=t.config.visibleButtons,r=o.filter(e=>n.includes(e)),[l]=r.splice(i.value,1);r.splice(a,0,l);const c=o.filter(e=>!n.includes(e));t.setButtonOrder([...r,...c]),document.querySelectorAll('.acu-button-card').forEach(e=>e.classList.remove('drop-target')),i.value=null})(e,n),onDragend:c},[(0,p.createCommentVNode)(' 主按钮图标 '),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)([['fas',e.icon],'btn-icon'])},null,2),(0,p.createCommentVNode)(' 必选标记 '),'settings'===e.id?((0,p.openBlock)(),(0,p.createElementBlock)('span',Zp)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 附属按钮指示器/添加按钮 '),e.secondaryId?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:1,class:'attachment-indicator',title:'长按附属: '+o(e.secondaryId)+' (点击移除)',onClick:(0,p.withModifiers)(a=>{return o=e.id,void t.removeButtonGroupSecondary(o);var o},['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',a(e.secondaryId)])},null,2)],8,Qp)):((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:2,class:'attachment-add-btn',title:'添加长按附属',onClick:(0,p.withModifiers)(t=>{return a=e.id,u.value=a,void(s.value=!0);var a},['stop'])},[...f[5]||(f[5]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])],8,em))],42,Jp))),128))])):((0,p.openBlock)(),(0,p.createElementBlock)('div',tm,[...f[6]||(f[6]=[(0,p.createElementVNode)('i',{class:'fas fa-exclamation-triangle'},null,-1),(0,p.createElementVNode)('span',null,'请至少保留一个按钮',-1)])]))]),(0,p.createCommentVNode)(' 隐藏区：可用按钮 '),(0,p.createElementVNode)('div',am,[(0,p.createElementVNode)('h4',null,[f[7]||(f[7]=(0,p.createElementVNode)('i',{class:'fas fa-eye-slash'},null,-1)),(0,p.createTextVNode)(' 未展示 ('+(0,p.toDisplayString)(r.value.length)+') ',1)]),r.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',om,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:'acu-btn-hidden-item',title:e.label+' (点击添加)',onClick:(0,p.withModifiers)(a=>(e=>{const a=[...t.config.visibleButtons],o=[...t.config.buttonOrder];if(a.includes(e)||(a.push(e),t.setVisibleButtons(a)),!o.includes(e)){const a=o.indexOf('settings');a>=0?o.splice(a,0,e):o.push(e),t.setButtonOrder(o)}})(e.id),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon])},null,2)],8,nm))),128))])):((0,p.openBlock)(),(0,p.createElementBlock)('div',rm,[...f[8]||(f[8]=[(0,p.createElementVNode)('i',{class:'fas fa-check-circle'},null,-1),(0,p.createElementVNode)('span',null,'所有按钮都已展示',-1)])]))]),(0,p.createCommentVNode)(' 附属按钮选择弹窗 '),s.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-attachment-picker-overlay',onClick:(0,p.withModifiers)(d,['self'])},[(0,p.createElementVNode)('div',{class:'acu-attachment-picker',onClick:f[1]||(f[1]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('div',lm,[f[10]||(f[10]=(0,p.createElementVNode)('h4',null,'选择长按附属按钮',-1)),(0,p.createElementVNode)('button',{class:'btn-close',onClick:(0,p.withModifiers)(d,['stop'])},[...f[9]||(f[9]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])]),(0,p.createElementVNode)('div',im,[(0,p.createElementVNode)('p',cm,'选择一个按钮作为 "'+(0,p.toDisplayString)(o(u.value))+'" 的长按附属功能：',1),(0,p.createElementVNode)('div',sm,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:'picker-option',onClick:(0,p.withModifiers)(a=>{return o=e.id,t.addButtonGroup(u.value,o),void d();var o},['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon])},null,2),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(e.label),1)],8,um))),128))])])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 提示信息（固定在底部） '),f[11]||(f[11]=(0,p.createElementVNode)('div',{class:'acu-config-hint acu-config-hint-fixed'},[(0,p.createElementVNode)('i',{class:'fas fa-info-circle'}),(0,p.createElementVNode)('span',null,'拖动排序 · 点击移除 · +号添加长按附属')],-1))]))}});d(503);const pm=(0,on.A)(dm,[['__scopeId','data-v-5b5624ec']]),mm={class:'acu-tab-config-panel'},fm={class:'acu-config-section acu-visible-area'},gm=['onClick','onDragstart','onDragover','onDrop'],vm={key:1,class:'tab-type-badge-mini'},bm={key:1,class:'acu-empty-hint'},hm={class:'acu-config-section acu-hidden-area'},xm={key:0,class:'acu-tab-hidden-list'},ym=['title','onClick'],wm={class:'tab-name'},km={key:1,class:'tab-type-badge'},Cm={key:1,class:'acu-empty-hint'},Nm=(0,p.defineComponent)({__name:'TabConfigPanel',setup(e){const t=Ve(),a=(0,p.computed)(()=>{const e=t.config.gridColumns;return 0===e?{gridTemplateColumns:'repeat(auto-fill, minmax(90px, 1fr))'}:{gridTemplateColumns:`repeat(${e}, 1fr)`}}),o=Ea(),n=ea(),r=(0,p.computed)(()=>{const e=[];t.config.showDashboard&&e.push({id:ka,name:'仪表盘',icon:'fas fa-home',type:'dashboard'});const a=n.stagedData;if(a){const t=wt(a);if(t)for(const[a,o]of Object.entries(t)){const t=o.key,n=a.includes('选项');e.push({id:t,name:a,icon:n?'fas fa-sliders-h':void 0,type:n?'special':'normal'})}}e.some(e=>'normal'===e.type&&st(e.name,e.id))&&e.push({id:Na,name:'关系图',icon:'fas fa-project-diagram',type:'graph'});return e.some(e=>'special'===e.type)&&e.push({id:Ca,name:'选项面板',icon:'fas fa-sliders-h',type:'options'}),e}),l=(0,p.computed)(()=>{const e=o.visibleTabs;return e&&0!==e.length?e.map(e=>r.value.find(t=>t.id===e)).filter(e=>void 0!==e):[]}),i=(0,p.computed)(()=>{const e=o.visibleTabs;return e&&0!==e.length?r.value.filter(t=>!e.includes(t.id)):r.value}),c=e=>'dashboard'===e||'graph'===e||'options'===e,s=e=>{switch(e){case'dashboard':return'首页';case'graph':return'关系';case'options':return'聚合';default:return''}},u=(0,p.ref)(null),d=()=>{u.value=null},m=()=>{const e=r.value.map(e=>e.id);o.setVisibleTabs(e)},f=()=>{o.setVisibleTabs([])};return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',mm,[(0,p.createCommentVNode)(' 展示区：当前显示的 Tab（网格布局，复用导航栏样式） '),(0,p.createElementVNode)('div',fm,[(0,p.createElementVNode)('h4',null,[t[1]||(t[1]=(0,p.createElementVNode)('i',{class:'fas fa-eye'},null,-1)),(0,p.createTextVNode)(' 展示中 ('+(0,p.toDisplayString)(l.value.length)+') ',1),(0,p.createElementVNode)('button',{class:'acu-btn-text acu-btn-reset',onClick:(0,p.withModifiers)(m,['stop'])},[...t[0]||(t[0]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 重置',-1)])])]),l.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-tab-visible-grid',style:(0,p.normalizeStyle)(a.value)},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:(0,p.normalizeClass)(['acu-nav-btn acu-tab-config-btn',{dragging:u.value===t}]),draggable:'true',title:'点击移除，拖拽排序',onClick:(0,p.withModifiers)(t=>(e=>{const t=[...o.visibleTabs];if(0===t.length){const t=r.value.map(e=>e.id).filter(t=>t!==e);return void(t.length>0&&o.setVisibleTabs(t))}const a=t.indexOf(e);a>-1&&t.length>1&&(t.splice(a,1),o.setVisibleTabs(t))})(e.id),['stop']),onDragstart:e=>((e,t)=>{u.value=t,e.dataTransfer&&(e.dataTransfer.effectAllowed='move',e.dataTransfer.setData('text/plain',String(t)))})(e,t),onDragover:(0,p.withModifiers)(e=>(e.preventDefault(),void(null!==u.value&&u.value)),['prevent']),onDrop:e=>((e,t)=>{if(e.preventDefault(),null===u.value||u.value===t)return;let a=[...o.visibleTabs];0===a.length&&(a=r.value.map(e=>e.id));const[n]=a.splice(u.value,1);a.splice(t,0,n),o.setVisibleTabs(a),document.querySelectorAll('.acu-tab-config-btn').forEach(e=>e.classList.remove('drop-target')),u.value=null})(e,t),onDragend:d},[e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(e.icon)},null,2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(e.name),1),c(e.type)?((0,p.openBlock)(),(0,p.createElementBlock)('span',vm,(0,p.toDisplayString)(s(e.type)),1)):(0,p.createCommentVNode)('v-if',!0)],42,gm))),128))],4)):((0,p.openBlock)(),(0,p.createElementBlock)('div',bm,[...t[2]||(t[2]=[(0,p.createElementVNode)('i',{class:'fas fa-info-circle'},null,-1),(0,p.createElementVNode)('span',null,'展示区为空时显示全部Tab，从下方添加需要的',-1)])]))]),(0,p.createCommentVNode)(' 不展示区：隐藏的 Tab '),(0,p.createElementVNode)('div',hm,[(0,p.createElementVNode)('h4',null,[t[4]||(t[4]=(0,p.createElementVNode)('i',{class:'fas fa-eye-slash'},null,-1)),(0,p.createTextVNode)(' 未展示 ('+(0,p.toDisplayString)(i.value.length)+') ',1),(0,p.createElementVNode)('button',{class:'acu-btn-text acu-btn-clear',title:'将展示区所有Tab移到未展示区',onClick:(0,p.withModifiers)(f,['stop'])},[...t[3]||(t[3]=[(0,p.createElementVNode)('i',{class:'fas fa-angle-double-down'},null,-1),(0,p.createTextVNode)(' 全部下移 ',-1)])])]),i.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',xm,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(i.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:(0,p.normalizeClass)(['acu-tab-hidden-item',{'is-special':c(e.type)}]),title:'添加 '+e.name,onClick:(0,p.withModifiers)(t=>(e=>{const t=[...o.visibleTabs];t.includes(e)||(t.push(e),o.setVisibleTabs(t))})(e.id),['stop'])},[e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)([e.icon,'tab-icon'])},null,2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',wm,(0,p.toDisplayString)(e.name),1),c(e.type)?((0,p.openBlock)(),(0,p.createElementBlock)('span',km,(0,p.toDisplayString)(s(e.type)),1)):(0,p.createCommentVNode)('v-if',!0),t[5]||(t[5]=(0,p.createElementVNode)('i',{class:'fas fa-plus add-icon'},null,-1))],10,ym))),128))])):((0,p.openBlock)(),(0,p.createElementBlock)('div',Cm,[...t[6]||(t[6]=[(0,p.createElementVNode)('i',{class:'fas fa-check-circle'},null,-1),(0,p.createElementVNode)('span',null,'所有表格都已展示',-1)])]))]),(0,p.createCommentVNode)(' 提示信息（固定在底部） '),t[7]||(t[7]=(0,p.createElementVNode)('div',{class:'acu-config-hint acu-config-hint-fixed'},[(0,p.createElementVNode)('i',{class:'fas fa-info-circle'}),(0,p.createElementVNode)('span',null,'点击移除/添加，拖拽排序 | 展示区为空时主界面显示全部')],-1))]))}});d(523);const Vm=(0,on.A)(Nm,[['__scopeId','data-v-2b134c50']]),Em={class:'acu-settings-section'},Bm={class:'acu-settings-group'},Sm={class:'acu-settings-row'},Tm={class:'acu-settings-control'},Dm={class:'acu-switch'},Am={key:0,class:'acu-background-config-section'},zm={class:'acu-background-preview-container'},Im={class:'acu-background-actions'},_m={key:0,class:'acu-settings-row acu-url-input-row'},Um={class:'acu-settings-row'},Mm={class:'acu-settings-label'},Lm={class:'hint'},$m={class:'acu-settings-control'},Pm={class:'acu-settings-row'},Fm={class:'acu-settings-label'},jm={class:'hint'},Rm={class:'acu-settings-control'},Om={class:'acu-settings-row'},Hm={class:'acu-settings-control'},Wm={class:'acu-settings-row'},Gm={class:'acu-settings-label'},Ym={class:'hint'},Xm={class:'acu-settings-control'},Km=2097152,qm=(0,p.defineComponent)({__name:'BackgroundConfigPanel',props:{storageKey:{},modelValue:{}},emits:['update:modelValue'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.reactive)({...a.modelValue}),r=(0,p.ref)(n.imageUrl||''),l=(0,p.ref)(null),i=(0,p.ref)(!1),c=(0,p.ref)(null),s=(0,p.ref)(!1),u={x:0,y:0},d={x:0,y:0},m=(0,p.ref)(null),f=(0,p.computed)(()=>{if(!n.imageUrl)return{};const e=n.offsetX||0,t=n.offsetY||0,a=(n.scale||100)/100;return{backgroundImage:`url(${n.imageUrl})`,backgroundPosition:'center center',backgroundSize:'auto'===n.size?'100%':n.size,transform:`translate(${e}%, ${t}%) scale(${a})`,transformOrigin:'center center',backgroundRepeat:'no-repeat'}});function g(){o('update:modelValue',{...n})}function v(){g()}function b(e){return'touches'in e?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}function h(e){if(!n.imageUrl)return;s.value=!0;const t=b(e);u.x=t.x,u.y=t.y,d.x=n.offsetX||0,d.y=n.offsetY||0;const a=window.parent.document;a.addEventListener('mousemove',x),a.addEventListener('mouseup',y),a.addEventListener('touchmove',x,{passive:!1}),a.addEventListener('touchend',y)}function x(e){if(!s.value)return;e.preventDefault();const t=b(e),a=c.value;if(!a)return;const o=a.getBoundingClientRect(),r=(t.x-u.x)/o.width*100,l=(t.y-u.y)/o.height*100;n.offsetX=Math.max(-50,Math.min(50,d.x+r)),n.offsetY=Math.max(-50,Math.min(50,d.y+l))}function y(){if(!s.value)return;s.value=!1;const e=window.parent.document;e.removeEventListener('mousemove',x),e.removeEventListener('mouseup',y),e.removeEventListener('touchmove',x),e.removeEventListener('touchend',y),v()}function w(){l.value?.click()}function k(e){const t=e.target,o=t.files?.[0];o&&async function(e){if(!['image/jpeg','image/png','image/gif','image/webp'].includes(e.type))return void alert('不支持的图片格式，请使用 jpg/png/gif/webp 格式');if(e.size>Km)return void alert('图片大小超过限制（最大 2MB）');try{const{blob:t,mimeType:o}=await async function(e){return{blob:e,mimeType:e.type||'image/png'}}(e);await Ae(a.storageKey,t,o),m.value&&Ie(m.value);const l=await ze(a.storageKey);l&&(m.value=l,n.imageUrl=l),n.hasIndexedDBImage=!0,n.externalUrl=void 0,r.value='',g(),console.info('[BackgroundConfigPanel] 背景图片已保存到 IndexedDB')}catch(e){console.error('[BackgroundConfigPanel] 保存背景图片失败:',e),alert('保存背景图片失败')}}(o),t.value=''}async function C(){const e=r.value.trim();if(e&&e!==n.imageUrl){if(e.startsWith('http://')||e.startsWith('https://'))return m.value&&(Ie(m.value),m.value=null),n.imageUrl=e,n.externalUrl=e,n.hasIndexedDBImage=!1,g(),void console.info('[BackgroundConfigPanel] 使用外部 URL:',e);if(e.startsWith('data:'))try{const{blob:t,mimeType:o}=await async function(e){if(e.startsWith('data:')){const t=await fetch(e),a=await t.blob();return{blob:a,mimeType:a.type}}try{const t=await fetch(e,{mode:'cors'});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.blob();return{blob:a,mimeType:a.type}}catch{throw new Error('无法加载外部图片，可能是跨域限制')}}(e);await Ae(a.storageKey,t,o),m.value&&Ie(m.value);const r=await ze(a.storageKey);r&&(m.value=r,n.imageUrl=r),n.hasIndexedDBImage=!0,n.externalUrl=void 0,g(),console.info('[BackgroundConfigPanel] data URL 已保存到 IndexedDB')}catch(e){console.error('[BackgroundConfigPanel] 保存 data URL 失败:',e),alert('保存图片失败')}}}async function N(){m.value&&(Ie(m.value),m.value=null);try{await async function(e){const t=await De();return new Promise((a,o)=>{const n=t.transaction(Be,'readwrite').objectStore(Be).delete(e);n.onsuccess=()=>{console.info('[ACU Background] 删除背景图片成功, chatId:',e),a()},n.onerror=()=>{console.error('[ACU Background] 删除背景图片失败:',n.error),o(n.error)}})}(a.storageKey)}catch(e){console.warn('[BackgroundConfigPanel] 删除背景图片失败:',e)}n.imageUrl='',n.hasIndexedDBImage=!1,n.externalUrl=void 0,r.value='',g()}return(0,p.watch)(()=>a.modelValue,e=>{Object.assign(n,e),e.externalUrl&&(r.value=e.externalUrl)},{deep:!0}),(0,p.onMounted)(async()=>{if(n.externalUrl)n.imageUrl=n.externalUrl,r.value=n.externalUrl;else if(n.hasIndexedDBImage)try{const e=await ze(a.storageKey);e&&(m.value=e,n.imageUrl=e,g())}catch(e){console.warn('[BackgroundConfigPanel] 加载背景图片失败:',e)}}),(0,p.onBeforeUnmount)(()=>{m.value&&(Ie(m.value),m.value=null)}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Em,[t[18]||(t[18]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-image'}),(0,p.createTextVNode)(' 背景配置 '),(0,p.createElementVNode)('span',{style:{'font-weight':'400','font-size':'11px',color:'var(--acu-text-sub)','margin-left':'auto'}},' 自定义背景图片 ')],-1)),(0,p.createElementVNode)('div',Bm,[(0,p.createCommentVNode)(' 启用背景 '),(0,p.createElementVNode)('div',Sm,[t[8]||(t[8]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 启用背景 '),(0,p.createElementVNode)('span',{class:'hint'},'显示自定义背景图片')],-1)),(0,p.createElementVNode)('div',Tm,[(0,p.createElementVNode)('label',Dm,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[0]||(t[0]=e=>n.enabled=e),type:'checkbox',onChange:v},null,544),[[p.vModelCheckbox,n.enabled]]),t[7]||(t[7]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])])]),(0,p.createCommentVNode)(' 背景详细设置 '),n.enabled?((0,p.openBlock)(),(0,p.createElementBlock)('div',Am,[(0,p.createCommentVNode)(' 图片预览区域 - 可拖动定位 '),(0,p.createElementVNode)('div',zm,[(0,p.createElementVNode)('div',{ref_key:'previewRef',ref:c,class:(0,p.normalizeClass)(['acu-background-preview',{dragging:s.value,'has-image':!!n.imageUrl}]),onMousedown:(0,p.withModifiers)(h,['prevent']),onTouchstart:(0,p.withModifiers)(h,['prevent'])},[(0,p.createCommentVNode)(' 有图片时显示预览 '),n.imageUrl?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-preview-image',style:(0,p.normalizeStyle)(f.value)},null,4)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 无图片时显示提示 '),t[9]||(t[9]=(0,p.createElementVNode)('div',{class:'acu-no-image-hint'},[(0,p.createElementVNode)('i',{class:'fas fa-image'}),(0,p.createElementVNode)('span',null,'暂无背景图片')],-1))],64))],34)]),(0,p.createCommentVNode)(' 操作按钮行 '),(0,p.createElementVNode)('div',Im,[(0,p.createElementVNode)('button',{class:'acu-action-btn',onClick:(0,p.withModifiers)(w,['stop'])},[...t[10]||(t[10]=[(0,p.createElementVNode)('i',{class:'fas fa-camera'},null,-1),(0,p.createTextVNode)(' 上传图片 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-action-btn',onClick:t[1]||(t[1]=(0,p.withModifiers)(e=>i.value=!i.value,['stop']))},[...t[11]||(t[11]=[(0,p.createElementVNode)('i',{class:'fas fa-link'},null,-1),(0,p.createTextVNode)(' 使用URL ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-danger',onClick:(0,p.withModifiers)(N,['stop'])},[...t[12]||(t[12]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createTextVNode)(' 清除 ',-1)])]),(0,p.createCommentVNode)(' 隐藏的文件输入 '),(0,p.createElementVNode)('input',{ref_key:'fileInputRef',ref:l,type:'file',accept:'image/jpeg,image/png,image/gif,image/webp',style:{display:'none'},onChange:k},null,544)]),(0,p.createCommentVNode)(' URL 输入框（可折叠） '),i.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',_m,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[2]||(t[2]=e=>r.value=e),type:'text',placeholder:'输入图片 URL（https://...）',class:'acu-background-url-input',onBlur:C,onKeyup:(0,p.withKeys)(C,['enter'])},null,544),[[p.vModelText,r.value]])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 缩放 '),(0,p.createElementVNode)('div',Um,[(0,p.createElementVNode)('div',Mm,[t[13]||(t[13]=(0,p.createTextVNode)(' 缩放 ',-1)),(0,p.createElementVNode)('span',Lm,(0,p.toDisplayString)(n.scale)+'%',1)]),(0,p.createElementVNode)('div',$m,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[3]||(t[3]=e=>n.scale=e),type:'range',min:'50',max:'200',step:'5',onChange:v},null,544),[[p.vModelText,n.scale,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 透明度 '),(0,p.createElementVNode)('div',Pm,[(0,p.createElementVNode)('div',Fm,[t[14]||(t[14]=(0,p.createTextVNode)(' 透明度 ',-1)),(0,p.createElementVNode)('span',jm,(0,p.toDisplayString)(n.opacity)+'%',1)]),(0,p.createElementVNode)('div',Rm,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[4]||(t[4]=e=>n.opacity=e),type:'range',min:'0',max:'100',step:'5',onChange:v},null,544),[[p.vModelText,n.opacity,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 填充方式 '),(0,p.createElementVNode)('div',Om,[t[16]||(t[16]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 填充方式 '),(0,p.createElementVNode)('span',{class:'hint'},'图片如何填充容器')],-1)),(0,p.createElementVNode)('div',Hm,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':t[5]||(t[5]=e=>n.size=e),class:'acu-select',onChange:v},[...t[15]||(t[15]=[(0,p.createElementVNode)('option',{value:'cover'},'覆盖',-1),(0,p.createElementVNode)('option',{value:'auto'},'自动',-1)])],544),[[p.vModelSelect,n.size]])])]),(0,p.createCommentVNode)(' 模糊度 '),(0,p.createElementVNode)('div',Wm,[(0,p.createElementVNode)('div',Gm,[t[17]||(t[17]=(0,p.createTextVNode)(' 模糊度 ',-1)),(0,p.createElementVNode)('span',Ym,(0,p.toDisplayString)(n.blur)+'px',1)]),(0,p.createElementVNode)('div',Xm,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t[6]||(t[6]=e=>n.blur=e),type:'range',min:'0',max:'20',step:'1',onChange:v},null,544),[[p.vModelText,n.blur,void 0,{number:!0}]])])])])):(0,p.createCommentVNode)('v-if',!0)]))}});d(315);const Jm=(0,on.A)(qm,[['__scopeId','data-v-a2534d7e']]),Zm={class:'acu-preset-header'},Qm={class:'acu-settings-row'},ef={class:'acu-settings-label'},tf={class:'hint'},af={class:'acu-settings-control acu-preset-control'},of={class:'acu-preset-selected-name'},nf={class:'acu-preset-dropdown-menu'},rf=['onClick'],lf={class:'acu-preset-option-name'},cf=['onClick'],sf={class:'acu-preset-actions'},uf=(0,p.defineComponent)({__name:'PresetManagerHeader',props:{presets:{},activePresetId:{},title:{},hint:{}},emits:['select','restore-default','delete','save','save-as'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(!1),r=(0,p.computed)(()=>{if(!a.activePresetId)return'默认配置';const e=a.presets.find(e=>e.id===a.activePresetId);return e?e.name:'默认配置'});function l(){n.value=!n.value}function i(){o('restore-default'),n.value=!1}function c(e){e.target.closest('.acu-preset-dropdown')||(n.value=!1)}return(0,p.onMounted)(()=>{document.addEventListener('click',c)}),(0,p.onUnmounted)(()=>{document.removeEventListener('click',c)}),(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Zm,[(0,p.createElementVNode)('div',Qm,[(0,p.createElementVNode)('div',ef,[(0,p.createTextVNode)((0,p.toDisplayString)(e.title||'预设管理')+' ',1),(0,p.createElementVNode)('span',tf,(0,p.toDisplayString)(e.hint||'保存和加载配置'),1)]),(0,p.createElementVNode)('div',af,[(0,p.createCommentVNode)(' 下拉选择框 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-preset-dropdown',{open:n.value}])},[(0,p.createElementVNode)('button',{class:'acu-preset-dropdown-btn',onClick:(0,p.withModifiers)(l,['stop'])},[(0,p.createElementVNode)('span',of,(0,p.toDisplayString)(r.value),1),a[2]||(a[2]=(0,p.createElementVNode)('i',{class:'fas fa-chevron-down'},null,-1))]),(0,p.withDirectives)((0,p.createElementVNode)('div',nf,[(0,p.createCommentVNode)(' 默认配置 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-preset-option',{active:!e.activePresetId}]),onClick:(0,p.withModifiers)(i,['stop'])},[...a[3]||(a[3]=[(0,p.createElementVNode)('span',{class:'acu-preset-option-name'},'默认配置',-1)])],2),(0,p.createCommentVNode)(' 用户预设 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.presets,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.id,class:(0,p.normalizeClass)(['acu-preset-option',{active:e.activePresetId===t.id}]),onClick:(0,p.withModifiers)(e=>{return a=t.id,o('select',a),void(n.value=!1);var a},['stop'])},[(0,p.createElementVNode)('span',lf,(0,p.toDisplayString)(t.name),1),t.isBuiltin?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-preset-delete-btn',title:'删除',onClick:(0,p.withModifiers)(e=>{return a=t.id,void o('delete',a);var a},['stop'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])],8,cf))],10,rf))),128))],512),[[p.vShow,n.value]])],2),(0,p.createCommentVNode)(' 操作按钮组 '),(0,p.createElementVNode)('div',sf,[(0,p.createCommentVNode)(' 另存为 '),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'另存为新预设',onClick:a[0]||(a[0]=(0,p.withModifiers)(e=>t.$emit('save-as'),['stop']))},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])]),(0,p.createCommentVNode)(' 保存 '),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'保存当前预设',onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>t.$emit('save'),['stop']))},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-save'},null,-1)])]),(0,p.createCommentVNode)(' 插槽：允许父组件添加额外按钮 '),(0,p.renderSlot)(t.$slots,'actions')])])])]))}}),df={class:'acu-theme-panel'},pf={class:'acu-theme-scroll-content'},mf={class:'acu-settings-section'},ff={class:'acu-settings-group'},gf={class:'acu-settings-row'},vf={class:'acu-settings-control'},bf=['value'],hf={class:'acu-settings-section'},xf={class:'acu-settings-group'},yf={class:'acu-settings-row'},wf={class:'acu-settings-control acu-color-picker-inline'},kf={class:'acu-settings-row'},Cf={class:'acu-settings-control acu-color-picker-inline'},Nf={class:'acu-settings-row'},Vf={class:'acu-settings-control acu-color-picker-inline'},Ef={class:'acu-settings-section'},Bf={class:'acu-var-groups-container'},Sf=['onClick'],Tf={class:'acu-var-count'},Df={class:'acu-var-group-body'},Af={class:'acu-var-line-primary'},zf={class:'acu-var-label'},If={class:'acu-var-color-row'},_f=['onClick'],Uf=['value','onChange'],Mf=['value','onChange'],Lf={class:'acu-var-line-secondary'},$f={class:'acu-var-name'},Pf={class:'acu-var-opacity-row'},Ff=['value','onInput'],jf={class:'acu-opacity-value'},Rf={class:'acu-settings-section'},Of={class:'acu-settings-group'},Hf={class:'acu-settings-row'},Wf={class:'acu-settings-label'},Gf={class:'hint'},Yf={class:'acu-settings-control acu-css-actions'},Xf=(0,p.defineComponent)({__name:'ThemePanel',setup(e){const t=Xe(),a=Ve(),o=Ea(),n=(0,Aa.d)();function r(){return t.presets||[]}function l(){return t.activePresetId}function i(){return t.currentThemeVars||{}}function c(){return t.currentHighlight}function s(){return t.customCSS||''}function u(){return t.currentThemeVarOpacities||{}}function d(){return t.getBackgroundConfig()}const m=(0,p.ref)('#d35400'),f=(0,p.ref)('#3498db'),g=(0,p.ref)('#d35400'),v=(0,p.ref)('retro'),b=(0,p.ref)([]),h=(0,p.ref)(''),x=(0,p.ref)();(0,p.computed)(()=>{const e=l();if(!e)return'默认配置';const t=r().find(t=>t.id===e);return t?.name||'默认配置'});function y(){m.value=t.manualHighlightColor,f.value=t.aiHighlightColor,g.value=t.titleColor}function w(){var e;e=null,t.activePresetId=e,t.clearThemeVars(),t.clearThemeVarOpacities(),y(),h.value='',t.clearCustomCSS(),n.success('已恢复默认配置')}function k(e){t.applyPreset(e),y(),h.value=s(),v.value=a.config.theme||'retro',n.success('预设已应用')}function C(e){const a=r().find(t=>t.id===e);a&&confirm(`确定要删除预设「${a.name}」吗？`)&&(t.deletePreset(e),n.info('预设已删除'))}function N(){try{const e=l();if(e){const a=r().find(t=>t.id===e);if(a)return t.saveCurrentToPreset(a.name),void n.success(`预设「${a.name}」已更新`)}V()}catch(e){console.error('保存失败:',e),n.error('保存失败，请查看控制台')}}function V(){o.openPresetSaveDialog({presetType:'theme',summaryItems:[],initialName:'',checkDuplicate:e=>r().some(t=>t.name===e)},{onSave:e=>{t.saveCurrentToPreset(e),n.success(`预设「${e}」已保存`)}})}function E(){a.setTheme(v.value)}function B(){t.setManualHighlightColor('custom',m.value)}function S(){t.setAiHighlightColor('custom',f.value)}function T(){t.setTitleColor('custom',g.value)}function D(e){const t=i();return e.vars.filter(e=>t[e.key]).length}function A(e){return i()[e]||''}function I(e){const t=A(e);return t&&t.startsWith('#')&&(4===t.length||7===t.length)?t:'#888888'}function U(e,a){a.trim()?t.setThemeVar(e,a.trim()):t.removeThemeVar(e)}function M(e){const t=u();return void 0!==t[e]&&100!==t[e]}function L(e){return u()[e]??100}function P(){t.setCustomCSS(h.value)}function F(){confirm('确定要清空自定义 CSS 吗？')&&(h.value='',t.clearCustomCSS())}function j(){const e={type:'acu_theme_config',version:'1.1',timestamp:(new Date).toISOString(),theme:v.value,highlight:c(),themeVars:i(),themeVarOpacities:u(),backgroundConfig:d(),customCSS:s()},t=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),a=URL.createObjectURL(t),o=document.createElement('a');o.href=a,o.download=`acu-theme-${Date.now()}.json`,o.click(),URL.revokeObjectURL(a),n.success('配置已导出')}function R(){x.value?.click()}function O(e){const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);if(t){const e=parseInt(t[1]),a=parseInt(t[2]),o=parseInt(t[3]),n=t[4]?parseFloat(t[4]):1,r=e=>{const t=e.toString(16);return 1===t.length?'0'+t:t};return{hex:`#${r(e)}${r(a)}${r(o)}`,opacity:Math.round(100*n)}}if(e.startsWith('#')&&9===e.length){const t=e.slice(0,7),a=e.slice(7,9),o=parseInt(a,16)/255;return{hex:t,opacity:Math.round(100*o)}}return null}function H(){if(!h.value.trim())return void n.info('CSS 内容为空');const e={};for(const[t,a]of Object.entries(Ue))e[a]=t;const a=h.value.split('\n'),o=[];let r=0;for(const n of a){const a=n.match(/^\s*(--acu-[a-z0-9-]+)\s*:\s*([^;]+);/);if(a){const o=a[1],n=a[2].trim(),l=e[o];if(l){const e=n.replace(/\s*!important\s*$/,'').trim(),a=O(e);a?(t.setThemeVar(l,a.hex),t.setThemeVarOpacity(l,a.opacity)):(t.setThemeVar(l,e),t.setThemeVarOpacity(l,100)),r++;continue}}o.push(n)}if(r>0){let e=o.join('\n');e=e.replace(/\n\s*\n\s*\n/g,'\n\n').trim(),h.value=e,t.setCustomCSS(e),y(),n.success(`成功提取 ${r} 个变量到滑块设置`)}else n.info('未找到可同步的主题变量 (格式需为 --acu-xxx: val;)')}function W(e){const o=e.target.files?.[0];if(!o)return;const r=new FileReader;r.onload=e=>{try{const r=e.target?.result;if(o.name.endsWith('.json')){const e=JSON.parse(r);if('acu_theme_config'!==e.type)throw new Error('无效的配置文件格式');if(e.theme&&(v.value=e.theme,a.setTheme(e.theme)),e.highlight){const t=c();t.manualColor=e.highlight.manualColor||'custom',t.manualHex=e.highlight.manualHex,t.aiColor=e.highlight.aiColor||'custom',t.aiHex=e.highlight.aiHex,t.titleColor=e.highlight.titleColor||'custom',t.titleHex=e.highlight.titleHex}if(e.themeVars){const t=i();Object.assign(t,e.themeVars)}if(e.themeVarOpacities){const t=u();Object.assign(t,e.themeVarOpacities)}e.backgroundConfig&&t.setBackgroundConfig(e.backgroundConfig),e.customCSS&&(h.value=e.customCSS,t.setCustomCSS(e.customCSS)),y(),n.success('主题配置已导入')}else h.value=r,t.setCustomCSS(r),n.success('CSS 已导入')}catch(e){console.error('[ThemePanel] 导入失败:',e),n.error('导入失败：无效的文件格式')}},r.readAsText(o),e.target.value=''}return(0,p.onMounted)(()=>{t.loadFromStorage(),y(),v.value=a.config.theme||'retro',h.value=s()}),(0,p.watch)(()=>c(),()=>y(),{deep:!0}),(0,p.watch)(()=>a.config.theme,e=>{v.value=e||'retro'}),(e,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',df,[(0,p.createCommentVNode)(' 固定区域：预设管理 '),(0,p.createVNode)(uf,{presets:r(),'active-preset-id':l(),title:'预设管理',hint:'保存和加载主题配置',onSelect:k,onRestoreDefault:w,onDelete:C,onSave:N,onSaveAs:V},null,8,['presets','active-preset-id']),(0,p.createCommentVNode)(' 可滚动区域 '),(0,p.createElementVNode)('div',pf,[(0,p.createCommentVNode)(' 主题风格选择 '),(0,p.createElementVNode)('div',mf,[a[10]||(a[10]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 主题风格 ')],-1)),(0,p.createElementVNode)('div',ff,[(0,p.createElementVNode)('div',gf,[a[9]||(a[9]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 界面配色 '),(0,p.createElementVNode)('span',{class:'hint'},'选择界面配色方案')],-1)),(0,p.createElementVNode)('div',vf,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[0]||(a[0]=e=>v.value=e),class:'acu-select',onChange:E},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(ke),e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.id,value:e.id},(0,p.toDisplayString)(e.name),9,bf))),128))],544),[[p.vModelSelect,v.value]])])])])]),(0,p.createCommentVNode)(' 背景配置 '),(0,p.createVNode)(Jm,{'storage-key':(0,p.unref)(Se),'model-value':d(),'onUpdate:modelValue':a[1]||(a[1]=e=>(0,p.unref)(t).setBackgroundConfig(e))},null,8,['storage-key','model-value']),(0,p.createCommentVNode)(' 高亮颜色配置 '),(0,p.createElementVNode)('div',hf,[a[14]||(a[14]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-highlighter'}),(0,p.createTextVNode)(' 高亮颜色 ')],-1)),(0,p.createElementVNode)('div',xf,[(0,p.createCommentVNode)(' 手动修改高亮颜色 '),(0,p.createElementVNode)('div',yf,[a[11]||(a[11]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 手动修改高亮 '),(0,p.createElementVNode)('span',{class:'hint'},'手动编辑内容的标记颜色')],-1)),(0,p.createElementVNode)('div',wf,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>m.value=e),type:'text',class:'acu-color-input',placeholder:'#RRGGBB',onChange:B},null,544),[[p.vModelText,m.value]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>m.value=e),type:'color',class:'acu-color-swatch',onChange:B},null,544),[[p.vModelText,m.value]])])]),(0,p.createCommentVNode)(' AI 填表高亮颜色 '),(0,p.createElementVNode)('div',kf,[a[12]||(a[12]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' AI 填表高亮 '),(0,p.createElementVNode)('span',{class:'hint'},'AI 自动填写内容的标记颜色')],-1)),(0,p.createElementVNode)('div',Cf,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>f.value=e),type:'text',class:'acu-color-input',placeholder:'#RRGGBB',onChange:S},null,544),[[p.vModelText,f.value]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>f.value=e),type:'color',class:'acu-color-swatch',onChange:S},null,544),[[p.vModelText,f.value]])])]),(0,p.createCommentVNode)(' 标题颜色 '),(0,p.createElementVNode)('div',Nf,[a[13]||(a[13]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 标题颜色 '),(0,p.createElementVNode)('span',{class:'hint'},'表格标题的颜色')],-1)),(0,p.createElementVNode)('div',Vf,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>g.value=e),type:'text',class:'acu-color-input',placeholder:'#RRGGBB',onChange:T},null,544),[[p.vModelText,g.value]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[7]||(a[7]=e=>g.value=e),type:'color',class:'acu-color-swatch',onChange:T},null,544),[[p.vModelText,g.value]])])])])]),(0,p.createCommentVNode)(' 主题变量自定义 '),(0,p.createElementVNode)('div',Ef,[a[16]||(a[16]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-paint-brush'}),(0,p.createTextVNode)(' 主题变量自定义 '),(0,p.createElementVNode)('span',{class:'hint',style:{'margin-left':'auto','font-weight':'normal'}},'覆盖当前主题的 CSS 变量')],-1)),(0,p.createCommentVNode)(' 连续的可折叠组 '),(0,p.createElementVNode)('div',Bf,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(Me),(e,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['acu-var-group',{first:0===o,last:o===(0,p.unref)(Me).length-1}])},[(0,p.createElementVNode)('div',{class:'acu-var-group-header',onClick:(0,p.withModifiers)(t=>function(e){const t=b.value.indexOf(e);t>-1?b.value.splice(t,1):b.value.push(e)}(e.id),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon])},null,2),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(e.name),1),(0,p.createElementVNode)('span',Tf,(0,p.toDisplayString)(D(e))+'/'+(0,p.toDisplayString)(e.vars.length),1),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',b.value.includes(e.id)?'fa-chevron-up':'fa-chevron-down'])},null,2)],8,Sf),(0,p.withDirectives)((0,p.createElementVNode)('div',Df,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.vars,e=>{return(0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.key,class:'acu-var-row acu-var-row-tall'},[(0,p.createCommentVNode)(' 第一行：标签 + 颜色控件 '),(0,p.createElementVNode)('div',Af,[(0,p.createElementVNode)('div',zf,(0,p.toDisplayString)(e.label),1),(0,p.createElementVNode)('div',If,[(o=e.key,i()[o]||M(e.key)?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-var-reset',title:'恢复默认',onClick:(0,p.withModifiers)(a=>function(e){t.removeThemeVar(e),t.removeThemeVarOpacity(e)}(e.key),['stop'])},[...a[15]||(a[15]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1)])],8,_f)):(0,p.createCommentVNode)('v-if',!0)),(0,p.createElementVNode)('input',{value:A(e.key),type:'text',class:'acu-color-input',placeholder:'使用主题默认值',onChange:t=>U(e.key,t.target.value)},null,40,Uf),(0,p.createElementVNode)('input',{value:I(e.key),type:'color',class:'acu-color-swatch',onChange:t=>U(e.key,t.target.value)},null,40,Mf)])]),(0,p.createCommentVNode)(' 第二行：变量名 + 透明度滑块 '),(0,p.createElementVNode)('div',Lf,[(0,p.createElementVNode)('code',$f,(0,p.toDisplayString)((0,p.unref)(Ue)[e.key]),1),(0,p.createElementVNode)('div',Pf,[(0,p.createElementVNode)('input',{type:'range',class:'acu-range-input',min:'0',max:'100',value:L(e.key),onInput:a=>function(e,a){t.setThemeVarOpacity(e,a)}(e.key,Number(a.target.value))},null,40,Ff),(0,p.createElementVNode)('span',jf,(0,p.toDisplayString)(L(e.key)),1)])])]);var o}),128))],512),[[p.vShow,b.value.includes(e.id)]])],2))),128))])]),(0,p.createCommentVNode)(' 自定义 CSS '),(0,p.createElementVNode)('div',Rf,[a[23]||(a[23]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-code'}),(0,p.createTextVNode)(' 自定义 CSS ')],-1)),(0,p.createElementVNode)('div',Of,[(0,p.createElementVNode)('div',Hf,[(0,p.createElementVNode)('div',Wf,[a[17]||(a[17]=(0,p.createTextVNode)(' CSS 代码 ',-1)),(0,p.createElementVNode)('span',Gf,(0,p.toDisplayString)(h.value.length)+' 字符',1)]),(0,p.createElementVNode)('div',Yf,[(0,p.createElementVNode)('button',{class:'acu-tool-btn',onClick:(0,p.withModifiers)(j,['stop'])},[...a[18]||(a[18]=[(0,p.createElementVNode)('i',{class:'fas fa-download'},null,-1),(0,p.createTextVNode)(' 导出 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',onClick:(0,p.withModifiers)(R,['stop'])},[...a[19]||(a[19]=[(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1),(0,p.createTextVNode)(' 导入 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'将 CSS 中的变量提取到滑块设置中，并从 CSS 中移除',onClick:(0,p.withModifiers)(H,['stop'])},[...a[20]||(a[20]=[(0,p.createElementVNode)('i',{class:'fas fa-magic'},null,-1),(0,p.createTextVNode)(' 转为滑块 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn acu-btn-danger',onClick:(0,p.withModifiers)(F,['stop'])},[...a[21]||(a[21]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createTextVNode)(' 清空 ',-1)])])])]),a[22]||(a[22]=(0,p.createElementVNode)('div',{class:'acu-css-hint'},[(0,p.createElementVNode)('p',null,'常用选择器：'),(0,p.createElementVNode)('code',null,'.acu-app, .acu-wrapper'),(0,p.createTextVNode)(),(0,p.createElementVNode)('code',null,'.acu-floating-ball'),(0,p.createElementVNode)('code',null,'.acu-data-card')],-1)),(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':a[8]||(a[8]=e=>h.value=e),class:'acu-css-editor',placeholder:'/* 在此输入自定义 CSS */',rows:'8',onChange:P},null,544),[[p.vModelText,h.value]])])])]),(0,p.createCommentVNode)(' 预设保存弹窗已迁移到全局 App.vue 中 '),(0,p.createCommentVNode)(' 隐藏的文件输入 '),(0,p.createElementVNode)('input',{ref_key:'fileInputRef',ref:x,type:'file',accept:'.json,.css,.txt',style:{display:'none'},onChange:W},null,544)]))}}),Kf={class:'acu-dimension-manager'},qf=['onClick'],Jf={class:'header-left'},Zf=['onUpdate:modelValue'],Qf={class:'header-right'},eg=['onUpdate:modelValue'],tg=['disabled','title','onClick'],ag={class:'dimension-content'},og={class:'tier-list'},ng={class:'tier-row basic-info'},rg={class:'tier-name-wrapper'},lg=['onUpdate:modelValue'],ig=['onUpdate:modelValue'],cg=['onClick'],sg={class:'tier-row weight-control'},ug=['onUpdate:modelValue'],dg={class:'acu-badge'},pg={class:'tier-row prompt-editor'},mg=['onUpdate:modelValue'],fg=['onClick'],gg={class:'acu-settings-section advanced-settings'},vg={class:'acu-settings-group template-settings-group'},bg={class:'template-shortcuts-row'},hg={class:'template-editor-row'},xg={class:'template-help-row'},yg={class:'acu-wildcard-help'},wg={class:'acu-settings-section'},kg={class:'acu-settings-group'},Cg={class:'acu-settings-row column'},Ng={class:'acu-settings-control',style:{'justify-content':'flex-end','flex-wrap':'wrap'}},Vg=(0,p.defineComponent)({__name:'DimensionManagerPanel',setup(e){const t=ua(),a=Ea(),o=(0,Aa.d)(),r=(0,p.ref)({}),l=(0,p.ref)(null),i=(0,p.ref)(null),c=(0,p.ref)(!0),s=(0,p.toRef)(t.config,'customTemplate');ne({element:i,input:s});const u=()=>{c.value=!c.value};function d(e){t.applyPreset(e),o.success('已应用维度预设')}function m(){confirm('确定要恢复默认维度配置吗？当前未保存的修改将丢失。')&&(t.restoreDefaultDimensions(),o.success('已恢复默认维度配置'))}function f(e){const a=t.presets.find(t=>t.id===e);a&&confirm(`确定要删除预设「${a.name}」吗？`)&&(t.deletePreset(e),o.info('预设已删除'))}function g(){const e=t.activePresetId;if(e){const a=t.presets.find(t=>t.id===e);if(a)return t.saveCurrentToPreset(a.name),void o.success(`预设「${a.name}」已更新`)}v()}function v(){a.openPresetSaveDialog({presetType:'divination',summaryItems:[],initialName:'',checkDuplicate:e=>t.presets.some(t=>t.name===e)},{onSave:e=>{t.saveCurrentToPreset(e),o.success(`预设「${e}」已保存`)}})}function b(){const e=t.activePresetId;if(!e)return void o.warning('请先选择一个预设');const a=t.presets.find(t=>t.id===e);if(!a)return;x({type:'acu_divination_presets',version:'1.0',timestamp:(new Date).toISOString(),presets:[a]},`acu-preset-${a.name}-${Date.now()}.json`),o.success(`预设「${a.name}」已导出`)}function h(){x({type:'acu_divination_presets',version:'1.0',timestamp:(new Date).toISOString(),presets:t.presets},`acu-divination-backup-${Date.now()}.json`),o.success('所有预设已备份')}function x(e,t){const a=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),o=URL.createObjectURL(a),n=document.createElement('a');n.href=o,n.download=t,n.click(),URL.revokeObjectURL(o)}function y(){l.value?.click()}function w(e){const a=e.target.files?.[0];if(!a)return;const n=new FileReader;n.onload=e=>{try{const a=e.target?.result,n=JSON.parse(a);if('acu_divination_presets'===n.type&&Array.isArray(n.presets)){let e=0;n.presets.forEach(a=>{if(t.presets.find(e=>e.id===a.id)){const e=t.presets.findIndex(e=>e.id===a.id);t.presets[e]=a}else t.presets.push(a);e++}),t.saveConfig(),o.success(`成功导入 ${e} 个预设`)}else o.error('无效的预设文件格式')}catch(e){console.error('导入失败:',e),o.error('导入失败：文件格式错误')}},n.readAsText(a),e.target.value=''}(0,p.onMounted)(()=>{t.config.customTemplate||(t.config.customTemplate=zo)});const k=()=>{const e={id:n(),name:'新维度',enabled:!0,tiers:[{id:n(),name:'默认档位',weight:50,prompt:''}]};t.addDimension(e),r.value[e.id]=!1},C=e=>{const a=t.config.customTemplate||'';t.config.customTemplate=a+e;const o=i.value;o&&setTimeout(()=>{o.focus(),o.scrollTop=o.scrollHeight;const e=t.config.customTemplate.length;o.setSelectionRange(e,e)},0)};return(e,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Kf,[(0,p.createCommentVNode)(' 预设管理头部 '),(0,p.createVNode)(uf,{presets:(0,p.unref)(t).presets,'active-preset-id':(0,p.unref)(t).activePresetId,title:'维度预设',hint:'保存和加载维度配置',onSelect:d,onRestoreDefault:m,onDelete:f,onSave:g,onSaveAs:v},null,8,['presets','active-preset-id']),(0,p.createCommentVNode)(' 维度列表 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(t).config.dimensions,(e,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['acu-settings-section dimension-container',{'is-collapsed':r.value[e.id]}])},[(0,p.createCommentVNode)(' 维度标题行 '),(0,p.createElementVNode)('div',{class:'acu-settings-title dimension-header',onClick:t=>{return a=e.id,void(r.value[a]=!r.value[a]);var a}},[(0,p.createElementVNode)('div',Jf,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas fa-chevron-right collapse-icon',{'is-expanded':!r.value[e.id]}])},null,2),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t=>e.name=t,class:'acu-input-minimal dimension-name-input',placeholder:'维度名称',onClick:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['stop']))},null,8,Zf),[[p.vModelText,e.name]])]),(0,p.createElementVNode)('div',Qf,[(0,p.createElementVNode)('label',{class:'acu-switch',onClick:a[1]||(a[1]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':t=>e.enabled=t,type:'checkbox'},null,8,eg),[[p.vModelCheckbox,e.enabled]]),a[6]||(a[6]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))]),(0,p.createElementVNode)('button',{class:'acu-icon-btn danger',disabled:'luck'===e.id,title:'luck'===e.id?'运势维度不可删除':'删除维度',onClick:(0,p.withModifiers)(e=>{return a=o,void(confirm('确定要删除这个维度吗？此操作不可撤销。')&&t.removeDimension(a));var a},['stop'])},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1)])],8,tg)])],8,qf),(0,p.createCommentVNode)(' 档位列表 (展开区域) '),(0,p.withDirectives)((0,p.createElementVNode)('div',ag,[(0,p.createElementVNode)('div',og,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.tiers,(n,r)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:n.id,class:'tier-item'},[(0,p.createCommentVNode)(' 第一行: 基本信息 '),(0,p.createElementVNode)('div',ng,[(0,p.createElementVNode)('div',rg,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':e=>n.name=e,class:'acu-input-minimal tier-name-input',placeholder:'档位名称'},null,8,lg),[[p.vModelText,n.name]]),(0,p.createCommentVNode)(' 颜色选择器 (仅运势维度显示) '),'luck'===e.id?(0,p.withDirectives)(((0,p.openBlock)(),(0,p.createElementBlock)('input',{key:0,'onUpdate:modelValue':e=>n.color=e,type:'color',class:'acu-color-picker-mini',title:'档位颜色'},null,8,ig)),[[p.vModelText,n.color]]):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('button',{class:'acu-icon-btn small danger',title:'删除档位',onClick:e=>((e,a)=>{t.config.dimensions[e].tiers.splice(a,1)})(o,r)},[...a[8]||(a[8]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])],8,cg)]),(0,p.createCommentVNode)(' 第二行: 权重调节 '),(0,p.createElementVNode)('div',sg,[a[9]||(a[9]=(0,p.createElementVNode)('span',{class:'label'},'权重',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':e=>n.weight=e,type:'range',min:'0',max:'100',step:'1',class:'acu-range-input'},null,8,ug),[[p.vModelText,n.weight,void 0,{number:!0}]]),(0,p.createElementVNode)('span',dg,(0,p.toDisplayString)(n.weight),1)]),(0,p.createCommentVNode)(' 第三行: 提示词 '),(0,p.createElementVNode)('div',pg,[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':e=>n.prompt=e,class:'acu-edit-textarea compact',placeholder:'在此输入该档位的提示词...',rows:'2'},null,8,mg),[[p.vModelText,n.prompt]])])]))),128))]),(0,p.createCommentVNode)(' 添加档位按钮 '),(0,p.createElementVNode)('button',{class:'acu-btn-dashed full-width',onClick:e=>(e=>{const a={id:n(),name:'新档位',weight:10,prompt:'',color:'#808080'};t.config.dimensions[e].tiers.push(a)})(o)},[...a[10]||(a[10]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1),(0,p.createTextVNode)(' 添加新档位 ',-1)])],8,fg)],512),[[p.vShow,!r.value[e.id]]])],2))),128)),(0,p.createCommentVNode)(' 新建维度按钮 '),(0,p.createElementVNode)('button',{class:'acu-btn-dashed full-width add-dimension-btn',onClick:k},[...a[11]||(a[11]=[(0,p.createElementVNode)('i',{class:'fas fa-layer-group'},null,-1),(0,p.createTextVNode)(' 新建维度 ',-1)])]),(0,p.createCommentVNode)(' 高级设置：自定义模板 '),(0,p.createElementVNode)('div',gg,[a[19]||(a[19]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('div',{class:'header-left'},[(0,p.createElementVNode)('i',{class:'fas fa-file-alt'}),(0,p.createTextVNode)(' 提示词模板 ')])],-1)),(0,p.createElementVNode)('div',vg,[(0,p.createCommentVNode)(' 1. 快捷按钮行 '),(0,p.createElementVNode)('div',bg,[a[15]||(a[15]=(0,p.createElementVNode)('span',{class:'hint'},'快捷插入:',-1)),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[2]||(a[2]=e=>C('{{luck}}'))},[...a[12]||(a[12]=[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{luck}}'),-1)])]),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[3]||(a[3]=e=>C('{{words}}'))},[...a[13]||(a[13]=[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{words}}'),-1)])]),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[4]||(a[4]=e=>C('{{dimensions}}'))},[...a[14]||(a[14]=[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{dimensions}}'),-1)])])]),(0,p.createCommentVNode)(' 2. 文本框行 '),(0,p.createElementVNode)('div',hg,[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{ref_key:'templateInputRef',ref:i,'onUpdate:modelValue':a[5]||(a[5]=e=>(0,p.unref)(t).config.customTemplate=e),class:'acu-edit-textarea template-textarea',placeholder:'在此输入自定义模板...',rows:'6'},null,512),[[p.vModelText,(0,p.unref)(t).config.customTemplate]])]),(0,p.createCommentVNode)(' 3. 说明行 '),(0,p.createElementVNode)('div',xg,[(0,p.createElementVNode)('div',yg,[(0,p.createElementVNode)('div',{class:'acu-help-header',onClick:u},[a[16]||(a[16]=(0,p.createElementVNode)('i',{class:'fas fa-lightbulb'},null,-1)),a[17]||(a[17]=(0,p.createElementVNode)('strong',null,'通配符说明',-1)),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',c.value?'fa-chevron-up':'fa-chevron-down'])},null,2)]),(0,p.withDirectives)((0,p.createElementVNode)('ul',null,[...a[18]||(a[18]=[(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{luck}}')),(0,p.createTextVNode)(' - 运势结果（如：大吉...） ')],-1),(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{words}}')),(0,p.createTextVNode)(' - 随机词列表（如：苹果、香蕉） ')],-1),(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',null,(0,p.toDisplayString)('{{dimensions}}')),(0,p.createTextVNode)(' - 其他维度结果拼接 ')],-1)])],512),[[p.vShow,c.value]])])])])]),(0,p.createCommentVNode)(' 导入/导出操作 (移至底部以适应移动端布局) '),(0,p.createElementVNode)('div',wg,[a[24]||(a[24]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-exchange-alt'}),(0,p.createTextVNode)(' 数据管理 ')],-1)),(0,p.createElementVNode)('div',kg,[(0,p.createElementVNode)('div',Cg,[a[23]||(a[23]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 预设数据 '),(0,p.createElementVNode)('span',{class:'hint'},'导入或导出维度预设')],-1)),(0,p.createElementVNode)('div',Ng,[(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'导出当前预设',onClick:(0,p.withModifiers)(b,['stop'])},[...a[20]||(a[20]=[(0,p.createElementVNode)('i',{class:'fas fa-file-export'},null,-1),(0,p.createTextVNode)(' 导出当前 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'备份所有预设',onClick:(0,p.withModifiers)(h,['stop'])},[...a[21]||(a[21]=[(0,p.createElementVNode)('i',{class:'fas fa-archive'},null,-1),(0,p.createTextVNode)(' 备份所有 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'导入预设',onClick:(0,p.withModifiers)(y,['stop'])},[...a[22]||(a[22]=[(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1),(0,p.createTextVNode)(' 导入 ',-1)])])])])])]),(0,p.createCommentVNode)(' 隐藏的文件输入 '),(0,p.createElementVNode)('input',{ref_key:'fileInputRef',ref:l,type:'file',accept:'.json',style:{display:'none'},onChange:w},null,544)]))}});d(977);const Eg=(0,on.A)(Vg,[['__scopeId','data-v-5337b804']]),Bg={class:'mystic-card-back'},Sg=['src'],Tg='https://i.postimg.cc/rmY9D1fL/wei-xin-tu-pian-20260121220508-79-297.jpg',Dg=(0,p.defineComponent)({__name:'CardBack',props:{imageUrl:{default:''}},emits:['load'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.computed)(()=>a.imageUrl&&''!==a.imageUrl.trim()?a.imageUrl:Tg);function r(e){const t=e.target;if(t.naturalWidth&&t.naturalHeight){const e=t.naturalWidth/t.naturalHeight;o('load',e)}}function l(e){const t=e.target;t.src!==Tg&&(t.src=Tg)}return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Bg,[(0,p.createElementVNode)('img',{src:n.value,alt:'Mystic Tarot Card Back',class:'mystic-card-back__image',onLoad:r,onError:l},null,40,Sg),(0,p.createCommentVNode)(' 光泽遮罩 '),t[0]||(t[0]=(0,p.createElementVNode)('div',{class:'mystic-card-back__sheen'},null,-1))]))}}),Ag={class:'mystic-card-front'},zg={class:'mystic-card-front__content'},Ig={key:0,class:'mystic-card-front__loading'},_g={class:'mystic-card-front__title'},Ug={class:'mystic-card-front__luck-name'},Mg={key:0,class:'mystic-card-front__dimensions'},Lg={key:1,class:'mystic-card-front__dimensions'},$g={class:'mystic-card-front__message-box'},Pg={key:0,class:'mystic-card-front__word-list'},Fg=(0,p.defineComponent)({__name:'CardFront',props:{luckName:{},luckColor:{default:'#ffd700'},dimensions:{default:()=>[]},words:{},loading:{type:Boolean,default:!1},peepMode:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,p.computed)(()=>t.peepMode?'???':t.luckName);function o(e){return e?e.split('').map(e=>/[\p{P}\s]/u.test(e)?e:Math.random()<.6?'...':e).join(''):''}const n=(0,p.computed)(()=>t.peepMode?t.words.map(o):t.words);return(t,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Ag,[(0,p.createCommentVNode)(' 基础纹理/渐变 '),o[4]||(o[4]=(0,p.createElementVNode)('div',{class:'mystic-card-front__texture'},null,-1)),(0,p.createCommentVNode)(' 双层金边 '),o[5]||(o[5]=(0,p.createElementVNode)('div',{class:'mystic-card-front__border-outer'},null,-1)),o[6]||(o[6]=(0,p.createElementVNode)('div',{class:'mystic-card-front__border-inner'},null,-1)),(0,p.createCommentVNode)(' Art Nouveau 风格四角装饰 '),o[7]||(o[7]=(0,p.createElementVNode)('div',{class:'mystic-card-front__corner mystic-card-front__corner--tl'},null,-1)),o[8]||(o[8]=(0,p.createElementVNode)('div',{class:'mystic-card-front__corner mystic-card-front__corner--tr'},null,-1)),o[9]||(o[9]=(0,p.createElementVNode)('div',{class:'mystic-card-front__corner mystic-card-front__corner--bl'},null,-1)),o[10]||(o[10]=(0,p.createElementVNode)('div',{class:'mystic-card-front__corner mystic-card-front__corner--br'},null,-1)),(0,p.createCommentVNode)(' 中心光晕 '),o[11]||(o[11]=(0,p.createElementVNode)('div',{class:'mystic-card-front__glow'},null,-1)),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',zg,[(0,p.createCommentVNode)(' 顶部星星装饰 '),o[2]||(o[2]=(0,p.createElementVNode)('div',{class:'mystic-card-front__top-icon'},[(0,p.createElementVNode)('svg',{width:'40',height:'40',viewBox:'0 0 24 24',fill:'currentColor'},[(0,p.createElementVNode)('path',{d:'M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z'})])],-1)),(0,p.createCommentVNode)(' 加载状态 '),e.loading?((0,p.openBlock)(),(0,p.createElementBlock)('div',Ig,[...o[0]||(o[0]=[(0,p.createElementVNode)('div',{class:'mystic-card-front__spinner'},null,-1),(0,p.createElementVNode)('p',{class:'mystic-card-front__loading-text'},'命运显现中...',-1)])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 内容 '),(0,p.createCommentVNode)(' 运势标题 '),(0,p.createElementVNode)('div',_g,[(0,p.createElementVNode)('h2',Ug,(0,p.toDisplayString)(a.value),1),o[1]||(o[1]=(0,p.createElementVNode)('div',{class:'mystic-card-front__divider'},null,-1))]),(0,p.createCommentVNode)(' 维度标签 '),!e.peepMode&&e.dimensions.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Mg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.dimensions,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:t,class:'mystic-card-front__dimension-tag'},(0,p.toDisplayString)(e),1))),128))])):e.peepMode&&e.dimensions.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Lg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.dimensions,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:t,class:'mystic-card-front__dimension-tag'},' ??? '))),128))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 主信息区 '),(0,p.createElementVNode)('div',$g,[n.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Pg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'mystic-card-front__word-item'},(0,p.toDisplayString)(e),1))),128))])):(0,p.createCommentVNode)('v-if',!0)])],64)),(0,p.createCommentVNode)(' 底部装饰 '),o[3]||(o[3]=(0,p.createElementVNode)('div',{class:'mystic-card-front__bottom-icon'},[(0,p.createElementVNode)('svg',{width:'24',height:'24',viewBox:'0 0 24 24',fill:'currentColor'},[(0,p.createElementVNode)('path',{d:'M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z'})])],-1))])]))}}),jg={class:'card-back'},Rg=['src'],Og='https://i.postimg.cc/j2MPbGv3/IMG-1590.jpg',Hg=(0,p.defineComponent)({__name:'CardBack',props:{imageUrl:{default:''}},emits:['load'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.computed)(()=>a.imageUrl&&''!==a.imageUrl.trim()?a.imageUrl:Og);function r(e){const t=e.target;if(t.naturalWidth&&t.naturalHeight){const e=t.naturalWidth/t.naturalHeight;o('load',e)}}function l(e){const t=e.target;t.src!==Og&&(t.src=Og)}return(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',jg,[(0,p.createElementVNode)('img',{src:n.value,alt:'Tarot Card Back',class:'card-back__image',onLoad:r,onError:l},null,40,Rg),t[0]||(t[0]=(0,p.createElementVNode)('div',{class:'card-back__overlay'},null,-1))]))}}),Wg={viewBox:'0 0 100 100',fill:'currentColor'},Gg=(0,p.defineComponent)({__name:'CornerOrnament',setup:e=>(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('svg',Wg,[...t[0]||(t[0]=[(0,p.createElementVNode)('path',{d:'M0,0 L40,0 C20,0 10,10 10,30 L10,0 Z',opacity:'0.5'},null,-1),(0,p.createElementVNode)('path',{d:'M5,5 L95,5 L95,20 C70,20 20,70 20,95 L5,95 Z'},null,-1),(0,p.createElementVNode)('circle',{cx:'15',cy:'15',r:'3',fill:'#8B5E3C'},null,-1)])]))}),Yg={class:'card-front'},Xg={class:'card-front__content'},Kg={key:0,class:'card-front__dimensions'},qg={key:1,class:'card-front__dimensions'},Jg={class:'card-front__keywords'},Zg={class:'card-front__keyword-text'},Qg={wafuku:{id:'wafuku',name:'白塔罗',description:'传统日式御札风格，素雅淡黄纸质',defaultBackImage:'https://i.postimg.cc/j2MPbGv3/IMG-1590.jpg',CardFront:(0,p.defineComponent)({__name:'CardFront',props:{luckName:{},luckColor:{default:'#4A3728'},dimensions:{default:()=>[]},words:{},peepMode:{type:Boolean,default:!1}},setup(e){const t=e,a=(0,p.computed)(()=>t.peepMode?'???':t.luckName);function o(e){return e?e.split('').map(e=>/[\p{P}\s]/u.test(e)?e:Math.random()<.6?'...':e).join(''):''}const n=(0,p.computed)(()=>t.peepMode?t.words.map(o):t.words);return(t,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',Yg,[(0,p.createCommentVNode)(' 纹理层 '),o[1]||(o[1]=(0,p.createElementVNode)('div',{class:'card-front__texture'},null,-1)),(0,p.createCommentVNode)(' 内边框 '),o[2]||(o[2]=(0,p.createElementVNode)('div',{class:'card-front__border-outer'},null,-1)),o[3]||(o[3]=(0,p.createElementVNode)('div',{class:'card-front__border-inner'},null,-1)),(0,p.createCommentVNode)(' 四角装饰 '),(0,p.createVNode)(Gg,{class:'card-front__corner card-front__corner--tl'}),(0,p.createVNode)(Gg,{class:'card-front__corner card-front__corner--tr'}),(0,p.createVNode)(Gg,{class:'card-front__corner card-front__corner--bl'}),(0,p.createVNode)(Gg,{class:'card-front__corner card-front__corner--br'}),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',Xg,[(0,p.createCommentVNode)(' 顶部图标 '),o[0]||(o[0]=(0,p.createStaticVNode)('<div class="card-front__top-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg></div>',1)),(0,p.createCommentVNode)(' 运势名称 '),(0,p.createElementVNode)('h2',{class:'card-front__luck-name',style:(0,p.normalizeStyle)({color:e.luckColor})},(0,p.toDisplayString)(a.value),5),(0,p.createCommentVNode)(' 维度展示区域 '),!e.peepMode&&e.dimensions.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Kg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.dimensions,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'card-front__dimension-item'},(0,p.toDisplayString)(e),1))),128))])):e.peepMode&&e.dimensions.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',qg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.dimensions,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'card-front__dimension-item'},'???'))),128))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 关键词区域 '),(0,p.createElementVNode)('div',Jg,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(n.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t,class:'card-front__keyword'},[(0,p.createElementVNode)('span',Zg,(0,p.toDisplayString)(e),1)]))),128))])])]))}}),CardBack:Hg},mystic:{id:'mystic',name:'神秘塔罗',description:'西方塔罗风格，深蓝底金装饰',defaultBackImage:'https://i.postimg.cc/rmY9D1fL/wei-xin-tu-pian-20260121220508-79-297.jpg',CardFront:Fg,CardBack:Dg}};const ev={class:'acu-settings-section'},tv={class:'acu-settings-group'},av={class:'acu-settings-row'},ov={class:'acu-settings-control'},nv={class:'acu-settings-group'},rv={class:'acu-settings-row'},lv={class:'acu-settings-control'},iv=['value'],cv={class:'acu-settings-row'},sv={class:'acu-settings-control'},uv={class:'acu-settings-row'},dv={class:'acu-settings-control'},pv={class:'acu-settings-row'},mv={class:'acu-settings-control'},fv={class:'acu-image-upload-container'},gv={class:'acu-settings-section','data-section':'word-drawing'},vv={class:'acu-settings-group'},bv={class:'acu-settings-row'},hv={class:'acu-settings-control'},xv={class:'acu-settings-row'},yv={class:'acu-settings-control'},wv={class:'acu-settings-row'},kv={class:'acu-settings-label'},Cv={class:'hint'},Nv={class:'acu-settings-control acu-mode-control'},Vv={key:0,class:'acu-range-wrapper'},Ev={class:'acu-range-value'},Bv={key:0,class:'acu-settings-row'},Sv={class:'acu-settings-label'},Tv={class:'hint'},Dv={class:'acu-settings-control'},Av={key:1,class:'acu-settings-row'},zv={class:'acu-settings-control'},Iv=(0,p.defineComponent)({__name:'DivinationPanel',setup(e){const t=(0,p.inject)('settingsNavigation'),o=ua(),{config:n}=a(o),{show:r}=(0,Aa.d)(),l=(0,p.computed)(()=>Object.values(Qg)),i=(0,p.computed)(()=>{switch(n.value.wordDrawMode){case'perItem':return'每项固定抽取，不受总数限制';case'custom':return'按 limit 控制，受总数限制';case'mixed':return'所有开启项混合抽取';default:return''}}),c=(0,p.ref)(null),s=()=>{c.value?.click()},u=async e=>{const t=e.target;if(t.files&&t.files[0])try{await o.uploadCardBack(t.files[0]),r('卡背图片上传成功','success')}catch(e){r('上传失败','error')}finally{t.value=''}};return(e,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',ev,[a[29]||(a[29]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-star'}),(0,p.createTextVNode)(' 抽签系统设置 ')],-1)),(0,p.createCommentVNode)(' 基础设置 '),(0,p.createElementVNode)('div',tv,[(0,p.createCommentVNode)(' 启用/禁用 '),(0,p.createElementVNode)('div',av,[a[13]||(a[13]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 启用抽签系统 '),(0,p.createElementVNode)('span',{class:'hint'},'开启后将在界面显示抽签入口')],-1)),(0,p.createElementVNode)('div',ov,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).enabled}]),onClick:a[0]||(a[0]=e=>(0,p.unref)(n).enabled=!(0,p.unref)(n).enabled)},null,2)])]),(0,p.createCommentVNode)(' 维度管理入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[1]||(a[1]=e=>(0,p.unref)(t).navigateTo('divinationDimensions'))},[...a[14]||(a[14]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 维度管理 '),(0,p.createElementVNode)('span',{class:'hint'},'配置运势、扭曲度等维度')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])])]),(0,p.createCommentVNode)(' 外观设置 '),a[30]||(a[30]=(0,p.createElementVNode)('div',{class:'acu-settings-title',style:{'margin-top':'16px'}},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 外观与行为 ')],-1)),(0,p.createElementVNode)('div',nv,[(0,p.createCommentVNode)(' 卡面主题 '),(0,p.createElementVNode)('div',rv,[a[15]||(a[15]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 卡面主题 '),(0,p.createElementVNode)('span',{class:'hint'},'选择塔罗牌的视觉风格')],-1)),(0,p.createElementVNode)('div',lv,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[2]||(a[2]=e=>(0,p.unref)(n).themeId=e),class:'acu-select'},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.id,value:e.id},(0,p.toDisplayString)(e.name),9,iv))),128))],512),[[p.vModelSelect,(0,p.unref)(n).themeId]])])]),(0,p.createCommentVNode)(' 翻牌模式 '),(0,p.createElementVNode)('div',cv,[a[17]||(a[17]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 翻牌模式 '),(0,p.createElementVNode)('span',{class:'hint'},'控制抽签时的动画表现')],-1)),(0,p.createElementVNode)('div',sv,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[3]||(a[3]=e=>(0,p.unref)(n).flipMode=e),class:'acu-select'},[...a[16]||(a[16]=[(0,p.createElementVNode)('option',{value:'auto'},'自动翻牌',-1),(0,p.createElementVNode)('option',{value:'manual'},'手动点击',-1),(0,p.createElementVNode)('option',{value:'skip'},'跳过动画',-1)])],512),[[p.vModelSelect,(0,p.unref)(n).flipMode]])])]),(0,p.createCommentVNode)(' 偷看模式 '),(0,p.createElementVNode)('div',uv,[a[18]||(a[18]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 偷看模式 '),(0,p.createElementVNode)('span',{class:'hint'},'模糊显示运势和内容')],-1)),(0,p.createElementVNode)('div',dv,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).peepMode}]),onClick:a[4]||(a[4]=e=>(0,p.unref)(n).peepMode=!(0,p.unref)(n).peepMode)},null,2)])]),(0,p.createCommentVNode)(' 卡背图片 '),(0,p.createElementVNode)('div',pv,[a[20]||(a[20]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 卡背图片 '),(0,p.createElementVNode)('span',{class:'hint'},'自定义塔罗牌背面图案')],-1)),(0,p.createElementVNode)('div',mv,[(0,p.createElementVNode)('div',fv,[(0,p.createCommentVNode)(' URL 输入 '),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>(0,p.unref)(n).cardBackImage=e),type:'text',class:'acu-settings-input',placeholder:'输入图片 URL'},null,512),[[p.vModelText,(0,p.unref)(n).cardBackImage]]),(0,p.createCommentVNode)(' 上传按钮 '),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'上传图片',onClick:s},[...a[19]||(a[19]=[(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1)])]),(0,p.createCommentVNode)(' 隐藏的文件输入 '),(0,p.createElementVNode)('input',{ref_key:'fileInput',ref:c,type:'file',accept:'image/*',class:'acu-hidden-input',onChange:u},null,544)])])])]),(0,p.createCommentVNode)(' 抽词设置 '),(0,p.createElementVNode)('div',gv,[a[28]||(a[28]=(0,p.createElementVNode)('div',{class:'acu-settings-title',style:{'margin-top':'16px'}},[(0,p.createElementVNode)('i',{class:'fas fa-font'}),(0,p.createTextVNode)(' 抽词设置 ')],-1)),(0,p.createElementVNode)('div',vv,[(0,p.createCommentVNode)(' 表格随机词 '),(0,p.createElementVNode)('div',bv,[a[21]||(a[21]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 表格随机词 '),(0,p.createElementVNode)('span',{class:'hint'},'从含"随机"的表格抽词')],-1)),(0,p.createElementVNode)('div',hv,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).enableTableWords}]),onClick:a[6]||(a[6]=e=>(0,p.unref)(n).enableTableWords=!(0,p.unref)(n).enableTableWords)},null,2)])]),(0,p.createCommentVNode)(' 世界书词库 '),(0,p.createElementVNode)('div',xv,[a[22]||(a[22]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 世界书词库 '),(0,p.createElementVNode)('span',{class:'hint'},'从同步的世界书抽词')],-1)),(0,p.createElementVNode)('div',yv,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).enableWordPool}]),onClick:a[7]||(a[7]=e=>(0,p.unref)(n).enableWordPool=!(0,p.unref)(n).enableWordPool)},null,2)])]),(0,p.createCommentVNode)(' 抽词模式（任一开启时显示） '),(0,p.unref)(n).enableTableWords||(0,p.unref)(n).enableWordPool?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('div',wv,[(0,p.createElementVNode)('div',kv,[a[23]||(a[23]=(0,p.createTextVNode)(' 抽词模式 ',-1)),(0,p.createElementVNode)('span',Cv,(0,p.toDisplayString)(i.value),1)]),(0,p.createElementVNode)('div',Nv,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[8]||(a[8]=e=>(0,p.unref)(n).wordDrawMode=e),class:'acu-select'},[...a[24]||(a[24]=[(0,p.createElementVNode)('option',{value:'perItem'},'每项抽 x 个',-1),(0,p.createElementVNode)('option',{value:'custom'},'自定义',-1),(0,p.createElementVNode)('option',{value:'mixed'},'混抽',-1)])],512),[[p.vModelSelect,(0,p.unref)(n).wordDrawMode]]),(0,p.createCommentVNode)(' perItem 模式：拖动条在同一行 '),'perItem'===(0,p.unref)(n).wordDrawMode?((0,p.openBlock)(),(0,p.createElementBlock)('div',Vv,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[9]||(a[9]=e=>(0,p.unref)(n).wordsPerItem=e),type:'range',min:'1',max:'10',step:'1',class:'acu-inline-range'},null,512),[[p.vModelText,(0,p.unref)(n).wordsPerItem,void 0,{number:!0}]]),(0,p.createElementVNode)('span',Ev,(0,p.toDisplayString)((0,p.unref)(n).wordsPerItem),1)])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' custom/mixed 模式：抽词总数（单独一行拖动条 1-20） '),'perItem'!==(0,p.unref)(n).wordDrawMode?((0,p.openBlock)(),(0,p.createElementBlock)('div',Bv,[(0,p.createElementVNode)('div',Sv,[a[25]||(a[25]=(0,p.createTextVNode)(' 抽词总数 ',-1)),(0,p.createElementVNode)('span',Tv,'最多抽取 '+(0,p.toDisplayString)((0,p.unref)(n).drawCount)+' 个词',1)]),(0,p.createElementVNode)('div',Dv,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[10]||(a[10]=e=>(0,p.unref)(n).drawCount=e),type:'range',min:'1',max:'20',step:'1'},null,512),[[p.vModelText,(0,p.unref)(n).drawCount,void 0,{number:!0}]])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 自动同步（仅当世界书词库开启时显示） '),(0,p.unref)(n).enableWordPool?((0,p.openBlock)(),(0,p.createElementBlock)('div',Av,[a[26]||(a[26]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 自动同步 '),(0,p.createElementVNode)('span',{class:'hint'},'表格变动时自动更新世界书')],-1)),(0,p.createElementVNode)('div',zv,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).autoSync}]),onClick:a[11]||(a[11]=e=>(0,p.unref)(n).autoSync=!(0,p.unref)(n).autoSync)},null,2)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 词库管理入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[12]||(a[12]=e=>(0,p.unref)(t).navigateTo('divinationWordPool'))},[...a[27]||(a[27]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 词库管理 '),(0,p.createElementVNode)('span',{class:'hint'},'配置每项的 limit 和开关')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])])],64)):(0,p.createCommentVNode)('v-if',!0)])])]))}}),_v={class:'acu-settings-section'},Uv={class:'acu-settings-group'},Mv={class:'acu-settings-row'},Lv={class:'acu-settings-control',style:{width:'100%',display:'flex'}},$v={key:0,class:'acu-empty-hint',style:{padding:'20px','text-align':'center'}},Pv={key:1,class:'acu-settings-group'},Fv={class:'acu-settings-row'},jv={class:'acu-settings-label'},Rv={style:{display:'flex','align-items':'center',gap:'8px'}},Ov={key:0,class:'acu-badge acu-badge-success'},Hv={key:1,class:'acu-badge acu-badge-danger'},Wv={key:2,class:'acu-badge acu-badge-secondary'},Gv={class:'hint'},Yv={class:'acu-settings-control'},Xv=['onClick'],Kv=['onClick'],qv={key:0,style:{padding:'0 16px 16px'}},Jv=['onUpdate:modelValue','onInput'],Zv={style:{display:'flex','justify-content':'space-between','margin-top':'8px','font-size':'12px',color:'var(--acu-text-sub)'}},Qv=(0,p.defineComponent)({__name:'WordPoolPanel',setup(e){const t=ua(),a=(0,p.ref)(''),o=(0,p.ref)(null),n=(0,p.ref)({}),r=(0,p.ref)({}),l=(0,p.computed)(()=>{const e=a.value.toLowerCase().trim();return e?t.categories.filter(t=>t.name.toLowerCase().includes(e)||t.words.some(t=>t.toLowerCase().includes(e))):t.categories}),i=T(e=>{(async e=>{const a=n.value[e],o=t.categories.find(t=>t.id===e);if(o&&void 0!==a){r.value[e]=!0;try{const e=a.split(/[,，、\n]/).map(e=>e.trim()).filter(e=>e),n={...o,words:e};await t.updateCategory(n)}finally{setTimeout(()=>{r.value[e]=!1},500)}}})(e)},1e3);return(e,c)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',_v,[c[1]||(c[1]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-book'}),(0,p.createTextVNode)(' 随机词库管理 ')],-1)),(0,p.createCommentVNode)(' 搜索/过滤 '),(0,p.createElementVNode)('div',Uv,[(0,p.createElementVNode)('div',Mv,[(0,p.createElementVNode)('div',Lv,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':c[0]||(c[0]=e=>a.value=e),type:'text',class:'acu-word-pool-search',placeholder:'搜索词库名称...',style:{flex:'1',width:'100%'}},null,512),[[p.vModelText,a.value]])])])]),(0,p.createCommentVNode)(' 词库列表 '),0===l.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',$v,' 暂无词库数据 ')):((0,p.openBlock)(),(0,p.createElementBlock)('div',Pv,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>{return(0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-word-pool-item',style:{'border-bottom':'1px solid var(--acu-border)',padding:'12px 0'}},[(0,p.createCommentVNode)(' 头部：名称与开关 '),(0,p.createElementVNode)('div',Fv,[(0,p.createElementVNode)('div',jv,[(0,p.createElementVNode)('div',Rv,[(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(e.name),1),(0,p.createCommentVNode)(' 倾向徽章 '),'positive'===e.bias?((0,p.openBlock)(),(0,p.createElementBlock)('span',Ov,'吉')):'negative'===e.bias?((0,p.openBlock)(),(0,p.createElementBlock)('span',Hv,'凶')):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 强制抽取数量 '),e.limit>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',Wv,' 强抽: '+(0,p.toDisplayString)(e.limit),1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createElementVNode)('span',Gv,(0,p.toDisplayString)(e.words.length)+' 个词条',1)]),(0,p.createElementVNode)('div',Yv,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:e.enabled}]),onClick:a=>(e=>{const a={...e,enabled:!e.enabled};t.updateCategory(a)})(e)},null,10,Xv),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-icon-btn',{active:o.value===e.id}]),style:{'margin-left':'8px'},onClick:a=>(e=>{if(o.value===e)o.value=null;else{o.value=e;const a=t.categories.find(t=>t.id===e);a&&(n.value[e]=a.words.join('\n'))}})(e.id)},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',o.value===e.id?'fa-chevron-up':'fa-chevron-down'])},null,2)],10,Kv)])]),(0,p.createCommentVNode)(' 展开内容：编辑区域 '),o.value===e.id?((0,p.openBlock)(),(0,p.createElementBlock)('div',qv,[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':t=>n.value[e.id]=t,class:'acu-edit-textarea',rows:'5',placeholder:'输入词条，用逗号或换行分隔',onInput:t=>{return a=e.id,void i(a);var a}},null,40,Jv),[[p.vModelText,n.value[e.id]]]),(0,p.createElementVNode)('div',Zv,[(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(r.value[e.id]?'保存中...':'自动保存'),1),(0,p.createElementVNode)('span',null,'当前词数: '+(0,p.toDisplayString)((a=n.value[e.id],a?a.split(/[,，、\n]/).map(e=>e.trim()).filter(e=>e).length:0)),1)])])):(0,p.createCommentVNode)('v-if',!0)]);var a}),128))]))]))}});d(961);const eb=(0,on.A)(Qv,[['__scopeId','data-v-385b48d1']]),tb={class:'acu-modal-header'},ab={class:'acu-modal-title'},ob={class:'acu-modal-body'},nb={class:'acu-settings-section'},rb={class:'acu-settings-group'},lb={class:'acu-settings-row'},ib={class:'acu-settings-control acu-font-control'},cb=['value'],sb={class:'acu-settings-row'},ub={class:'acu-settings-control'},db={class:'acu-settings-row'},pb={class:'acu-settings-label'},mb={class:'hint'},fb={class:'acu-settings-control'},gb={class:'acu-settings-row'},vb={class:'acu-settings-label'},bb={class:'hint'},hb={class:'acu-settings-control'},xb={class:'acu-settings-row'},yb={class:'acu-settings-label'},wb={class:'hint'},kb={class:'acu-settings-control'},Cb={class:'acu-settings-row'},Nb={class:'acu-settings-label'},Vb={class:'hint'},Eb={class:'acu-settings-control'},Bb={class:'acu-settings-section'},Sb={class:'acu-settings-group'},Tb={class:'acu-settings-section'},Db={class:'acu-settings-group'},Ab={class:'acu-settings-row'},zb={class:'acu-settings-control'},Ib={class:'acu-settings-row'},_b={class:'acu-settings-control'},Ub={class:'acu-settings-row'},Mb={class:'acu-settings-control'},Lb={class:'acu-settings-row'},$b={class:'acu-settings-control'},Pb={key:0,class:'acu-settings-row'},Fb={class:'acu-settings-label'},jb={class:'hint'},Rb={class:'acu-settings-control'},Ob={class:'acu-settings-row'},Hb={class:'acu-settings-control'},Wb={class:'acu-mini-dialog-header'},Gb={class:'acu-mini-dialog-body'},Yb={class:'acu-font-form'},Xb={class:'acu-form-row'},Kb={class:'acu-form-row'},qb={class:'acu-mini-dialog-footer'},Jb=['disabled'],Zb=(0,p.defineComponent)({__name:'SettingsDialog',props:{visible:{type:Boolean}},emits:['update:visible'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(),r=Ve(),l=Ee(),i=Ea(),c=(It(),(0,p.ref)(!1)),s=(0,p.ref)(''),u=(0,p.ref)(''),d=(0,p.ref)('main'),m=(0,p.ref)([]),f=(0,p.ref)({}),g=(0,p.reactive)({...r.config});(0,p.watch)(g,e=>{r.updateConfig(e)},{deep:!0});const v=(0,p.computed)(()=>{if(f.value[d.value])return f.value[d.value];switch(d.value){case'tabConfig':return'表格展示选择';case'buttonConfig':return'导航栏按钮配置';case'ballAppearance':return'悬浮球外观';case'themeConfig':return'主题美化与高亮配置';case'divination':return'抽签系统配置';case'divinationDimensions':return'维度管理';case'divinationWordPool':return'随机词库管理';default:return'设置'}}),b=(e,t)=>{t&&(f.value[e]=t),m.value.push(d.value),d.value=e},h=()=>{const e=m.value.pop();d.value=e||'main'},x=()=>{m.value=[],d.value='main',f.value={}},y=e=>{b(e)};(0,p.provide)('settingsNavigation',{navigateTo:b,goBack:h});(0,p.watch)(()=>a.visible,e=>{e&&(Object.assign(g,r.config),i.initialSettingsPanel?(x(),b(i.initialSettingsPanel),i.initialSettingsPanel=null):x())}),O(n,()=>{k()});const w=()=>{o('update:visible',!1)},k=()=>{o('update:visible',!1)},C=(0,p.computed)(()=>l.allFonts),N=(0,p.computed)(()=>s.value.trim()&&u.value.trim()),V=()=>{if(!N.value)return;const e=s.value.trim(),t=`'${e}', sans-serif`;l.addFont({name:e,fontFamily:t,importUrl:u.value.trim()}),s.value='',u.value='',c.value=!1};return(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(k,['self'])},[(0,p.createElementVNode)('div',{ref_key:'dialogRef',ref:n,class:'acu-modal acu-settings-modal'},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',tb,[(0,p.createCommentVNode)(' 返回按钮（仅在子面板时显示） '),m.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-modal-back',onClick:(0,p.withModifiers)(h,['stop'])},[...a[24]||(a[24]=[(0,p.createElementVNode)('i',{class:'fas fa-arrow-left'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',ab,(0,p.toDisplayString)(v.value),1),(0,p.createCommentVNode)(' 胶囊式完成按钮 '),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(w,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',ob,[(0,p.createCommentVNode)(' ============ 主设置面板 ============ '),'main'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createCommentVNode)(' 外观与布局（合并）'),(0,p.createElementVNode)('div',nb,[a[33]||(a[33]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 外观与布局 ')],-1)),(0,p.createElementVNode)('div',rb,[(0,p.createCommentVNode)(' 字体选择 '),(0,p.createElementVNode)('div',lb,[a[26]||(a[26]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 显示字体 '),(0,p.createElementVNode)('span',{class:'hint'},'选择界面字体')],-1)),(0,p.createElementVNode)('div',ib,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[0]||(a[0]=e=>g.fontFamily=e)},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(C.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.id,value:e.id},(0,p.toDisplayString)(e.name),9,cb))),128))],512),[[p.vModelSelect,g.fontFamily]]),(0,p.createElementVNode)('button',{class:'acu-add-font-btn',title:'添加自定义字体',onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>c.value=!0,['stop']))},[...a[25]||(a[25]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])])])]),(0,p.createCommentVNode)(' 布局模式 '),(0,p.createElementVNode)('div',sb,[a[28]||(a[28]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 布局模式 '),(0,p.createElementVNode)('span',{class:'hint'},'卡片排列方向')],-1)),(0,p.createElementVNode)('div',ub,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[2]||(a[2]=e=>g.layout=e)},[...a[27]||(a[27]=[(0,p.createElementVNode)('option',{value:'vertical'},'纵向布局',-1),(0,p.createElementVNode)('option',{value:'horizontal'},'横向布局',-1)])],512),[[p.vModelSelect,g.layout]])])]),(0,p.createCommentVNode)(' 字体大小 '),(0,p.createElementVNode)('div',db,[(0,p.createElementVNode)('div',pb,[a[29]||(a[29]=(0,p.createTextVNode)(' 字体大小 ',-1)),(0,p.createElementVNode)('span',mb,(0,p.toDisplayString)(g.fontSize)+'px',1)]),(0,p.createElementVNode)('div',fb,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>g.fontSize=e),type:'range',min:'12',max:'18',step:'1'},null,512),[[p.vModelText,g.fontSize,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 卡片宽度 '),(0,p.createElementVNode)('div',gb,[(0,p.createElementVNode)('div',vb,[a[30]||(a[30]=(0,p.createTextVNode)(' 卡片宽度 ',-1)),(0,p.createElementVNode)('span',bb,(0,p.toDisplayString)(g.cardWidth)+'px',1)]),(0,p.createElementVNode)('div',hb,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>g.cardWidth=e),type:'range',min:'200',max:'400',step:'10'},null,512),[[p.vModelText,g.cardWidth,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 表格按钮列数 '),(0,p.createElementVNode)('div',xb,[(0,p.createElementVNode)('div',yb,[a[31]||(a[31]=(0,p.createTextVNode)(' 表格按钮列数 ',-1)),(0,p.createElementVNode)('span',wb,(0,p.toDisplayString)(0===g.gridColumns?'自适应':`${g.gridColumns} 列`),1)]),(0,p.createElementVNode)('div',kb,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>g.gridColumns=e),type:'range',min:'0',max:'6',step:'1'},null,512),[[p.vModelText,g.gridColumns,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 每页显示数 '),(0,p.createElementVNode)('div',Cb,[(0,p.createElementVNode)('div',Nb,[a[32]||(a[32]=(0,p.createTextVNode)(' 每页显示条数 ',-1)),(0,p.createElementVNode)('span',Vb,(0,p.toDisplayString)(g.itemsPerPage)+' 条',1)]),(0,p.createElementVNode)('div',Eb,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>g.itemsPerPage=e),type:'range',min:'10',max:'100',step:'10'},null,512),[[p.vModelText,g.itemsPerPage,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 界面配置入口（使用圆角容器）'),(0,p.createElementVNode)('div',Bb,[a[39]||(a[39]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-columns'}),(0,p.createTextVNode)(' 界面配置 ')],-1)),(0,p.createElementVNode)('div',Sb,[(0,p.createCommentVNode)(' 主题美化与高亮配置入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[7]||(a[7]=e=>y('themeConfig'))},[...a[34]||(a[34]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 主题美化与高亮配置 '),(0,p.createElementVNode)('span',{class:'hint'},'自定义主题变量、高亮颜色、CSS')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])]),(0,p.createCommentVNode)(' 悬浮球外观配置入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[8]||(a[8]=e=>y('ballAppearance'))},[...a[35]||(a[35]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 悬浮球外观 '),(0,p.createElementVNode)('span',{class:'hint'},'自定义悬浮球样式和AI填表通知动画')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])]),(0,p.createCommentVNode)(' 表格展示选择入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[9]||(a[9]=e=>y('tabConfig'))},[...a[36]||(a[36]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 表格自定义配置 '),(0,p.createElementVNode)('span',{class:'hint'},'选择要显示的表格及排序')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])]),(0,p.createCommentVNode)(' 导航栏按钮配置入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[10]||(a[10]=e=>y('buttonConfig'))},[...a[37]||(a[37]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 导航栏按钮自定义配置 '),(0,p.createElementVNode)('span',{class:'hint'},'自定义导航栏显示的按钮')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])]),(0,p.createCommentVNode)(' 抽签系统配置入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:a[11]||(a[11]=e=>y('divination'))},[...a[38]||(a[38]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 抽签系统配置 '),(0,p.createElementVNode)('span',{class:'hint'},'配置运势、维度和随机词库')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])])])]),(0,p.createCommentVNode)(' 行为设置 '),(0,p.createElementVNode)('div',Tb,[a[46]||(a[46]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-sliders-h'}),(0,p.createTextVNode)(' 行为 ')],-1)),(0,p.createElementVNode)('div',Db,[(0,p.createCommentVNode)(' 显示分页 (移除了仪表盘开关) '),(0,p.createElementVNode)('div',Ab,[a[40]||(a[40]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 显示分页器 '),(0,p.createElementVNode)('span',{class:'hint'},'表格底部分页控件')],-1)),(0,p.createElementVNode)('div',zb,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:g.showPagination}]),onClick:a[12]||(a[12]=e=>g.showPagination=!g.showPagination)},null,2)])]),(0,p.createCommentVNode)(' 限制长文本 '),(0,p.createElementVNode)('div',Ib,[a[41]||(a[41]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 限制长文本 '),(0,p.createElementVNode)('span',{class:'hint'},'超长内容自动截断')],-1)),(0,p.createElementVNode)('div',_b,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:g.limitLongText}]),onClick:a[13]||(a[13]=e=>g.limitLongText=!g.limitLongText)},null,2)])]),(0,p.createCommentVNode)(' 锁定面板位置 '),(0,p.createElementVNode)('div',Ub,[a[42]||(a[42]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 锁定面板位置 '),(0,p.createElementVNode)('span',{class:'hint'},'禁止拖动面板')],-1)),(0,p.createElementVNode)('div',Mb,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:g.lockPanel}]),onClick:a[14]||(a[14]=e=>g.lockPanel=!g.lockPanel)},null,2)])]),(0,p.createCommentVNode)(' 收纳Tab栏 '),(0,p.createElementVNode)('div',Lb,[a[43]||(a[43]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 收纳Tab栏 '),(0,p.createElementVNode)('span',{class:'hint'},'将Tab栏收纳到导航按钮中')],-1)),(0,p.createElementVNode)('div',$b,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:g.collapseTabBar}]),onClick:a[15]||(a[15]=e=>g.collapseTabBar=!g.collapseTabBar)},null,2)])]),(0,p.createCommentVNode)(' 移动端底部安全区（仅移动端显示） '),(0,p.unref)(i).isMobile?((0,p.openBlock)(),(0,p.createElementBlock)('div',Pb,[(0,p.createElementVNode)('div',Fb,[a[44]||(a[44]=(0,p.createTextVNode)(' 移动端底部安全区 ',-1)),(0,p.createElementVNode)('span',jb,(0,p.toDisplayString)(g.mobileSafeAreaBottom??50)+'px',1)]),(0,p.createElementVNode)('div',Rb,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[16]||(a[16]=e=>g.mobileSafeAreaBottom=e),type:'range',min:'0',max:'150',step:'10'},null,512),[[p.vModelText,g.mobileSafeAreaBottom,void 0,{number:!0}]])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' Swipe 时清除表格 '),(0,p.createElementVNode)('div',Ob,[a[45]||(a[45]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' Swipe 清除表格 '),(0,p.createElementVNode)('span',{class:'hint'},'重 roll 时若最后一楼有表格数据则自动清除')],-1)),(0,p.createElementVNode)('div',Hb,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:g.clearTableOnSwipe}]),onClick:a[17]||(a[17]=e=>g.clearTableOnSwipe=!g.clearTableOnSwipe)},null,2)])])])])],64)):'tabConfig'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' ============ Tab 配置面板 ============ '),(0,p.createVNode)(Vm)],2112)):'buttonConfig'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' ============ 导航栏按钮配置面板 ============ '),(0,p.createVNode)(pm)],2112)):'ballAppearance'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:3},[(0,p.createCommentVNode)(' ============ 悬浮球外观配置面板 ============ '),(0,p.createVNode)(Wp)],2112)):'themeConfig'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:4},[(0,p.createCommentVNode)(' ============ 主题美化与高亮配置面板 ============ '),(0,p.createVNode)(Xf)],2112)):'divination'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:5},[(0,p.createCommentVNode)(' ============ 抽签系统配置面板 ============ '),(0,p.createVNode)(Iv)],2112)):'divinationDimensions'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:6},[(0,p.createCommentVNode)(' ============ 维度管理面板 ============ '),(0,p.createVNode)(Eg)],2112)):'divinationWordPool'===d.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:7},[(0,p.createCommentVNode)(' ============ 词库管理面板 ============ '),(0,p.createVNode)(eb)],2112)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' ============ 添加自定义字体弹窗（直接渲染，不使用 Teleport） ============ '),(0,p.createVNode)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[c.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-font-dialog-overlay',onClick:a[23]||(a[23]=(0,p.withModifiers)(e=>c.value=!1,['self']))},[(0,p.createElementVNode)('div',{class:'acu-mini-dialog acu-add-font-dialog',onClick:a[22]||(a[22]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('div',Wb,[a[48]||(a[48]=(0,p.createElementVNode)('span',null,'添加自定义字体',-1)),(0,p.createElementVNode)('button',{class:'acu-icon-btn',onClick:a[18]||(a[18]=(0,p.withModifiers)(e=>c.value=!1,['stop']))},[...a[47]||(a[47]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])]),(0,p.createElementVNode)('div',Gb,[(0,p.createElementVNode)('div',Yb,[(0,p.createElementVNode)('div',Xb,[a[49]||(a[49]=(0,p.createElementVNode)('label',null,'字体名称',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[19]||(a[19]=e=>s.value=e),type:'text',placeholder:'例如：霞鹜文楷'},null,512),[[p.vModelText,s.value]])]),(0,p.createElementVNode)('div',Kb,[a[50]||(a[50]=(0,p.createElementVNode)('label',null,'字体链接',-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[20]||(a[20]=e=>u.value=e),type:'text',placeholder:'@import URL 或 CDN 链接'},null,512),[[p.vModelText,u.value]])])])]),(0,p.createElementVNode)('div',qb,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:a[21]||(a[21]=(0,p.withModifiers)(e=>c.value=!1,['stop']))},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:!N.value,onClick:(0,p.withModifiers)(V,['stop'])},'添加',8,Jb)])])])):(0,p.createCommentVNode)('v-if',!0)]),_:1}),(0,p.createCommentVNode)(' 底部留白适配移动端安全区 '),a[51]||(a[51]=(0,p.createElementVNode)('div',{class:'acu-bottom-spacer'},'—— ACU Visualizer 8.1.3 ——',-1))],512)])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}});d(931);const Qb=(0,on.A)(Zb,[['__scopeId','data-v-ffe7c458']]),eh={class:'acu-modal acu-crop-dialog'},th={class:'acu-modal-header'},ah={class:'acu-modal-title'},oh={class:'acu-modal-body acu-crop-body'},nh={class:'acu-crop-preview-wrapper'},rh={key:0,class:'acu-crop-placeholder'},lh={class:'acu-crop-controls'},ih={class:'acu-crop-control-row'},ch=['value'],sh={class:'acu-crop-value'},uh={class:'acu-crop-control-row'},dh=['value'],ph={class:'acu-crop-value'},mh={class:'acu-crop-control-row'},fh=['value'],gh={class:'acu-crop-value'},vh={key:0,class:'acu-crop-invert-section'},bh={class:'acu-settings-row'},hh={class:'acu-settings-control'},xh={class:'acu-switch'},yh={class:'acu-crop-upload-section'},wh={class:'acu-modal-footer'},kh=(0,p.defineComponent)({__name:'AvatarCropDialog',props:{visible:{type:Boolean,default:!1},imageUrl:{default:''},name:{default:''},initialOffsetX:{default:50},initialOffsetY:{default:50},initialScale:{default:150},initialInvert:{type:Boolean,default:!1},showInvertOption:{type:Boolean,default:!1}},emits:['close','apply','upload'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.ref)(a.initialOffsetX),r=(0,p.ref)(a.initialOffsetY),l=(0,p.ref)(a.initialScale),i=(0,p.ref)(a.initialInvert),c=(0,p.ref)(null),s=(0,p.ref)(null),u=(0,p.ref)(!1),d=(0,p.ref)(0),m=(0,p.ref)(0),f=(0,p.ref)(0),g=(0,p.ref)(0),v=(0,p.computed)(()=>{if(!a.imageUrl)return{};const e={backgroundImage:`url('${a.imageUrl}')`,backgroundPosition:`${n.value}% ${r.value}%`,backgroundSize:`${l.value}%`};return i.value&&a.showInvertOption&&(e.filter='invert(1)'),e});function b(){o('close')}function h(){o('apply',{offsetX:n.value,offsetY:r.value,scale:l.value,invert:a.showInvertOption?i.value:void 0})}function x(){n.value=50,r.value=50,l.value=150,i.value=!1}function y(){c.value?.click()}function w(e){const t=e.target,a=t.files?.[0];a&&o('upload',a),t.value=''}function k(e){if(!a.imageUrl)return;u.value=!0,d.value=e.clientX,m.value=e.clientY,f.value=n.value,g.value=r.value;const t=window.parent?.document||document;t.addEventListener('mousemove',N),t.addEventListener('mouseup',B)}function C(e){if(!a.imageUrl||1!==e.touches.length)return;const t=e.touches[0];u.value=!0,d.value=t.clientX,m.value=t.clientY,f.value=n.value,g.value=r.value;const o=window.parent?.document||document;o.addEventListener('touchmove',V,{passive:!1}),o.addEventListener('touchend',S)}function N(e){if(!u.value)return;E(e.clientX-d.value,e.clientY-m.value)}function V(e){if(!u.value||1!==e.touches.length)return;e.preventDefault();const t=e.touches[0];E(t.clientX-d.value,t.clientY-m.value)}function E(e,t){const a=f.value-e/120*100*.8,o=g.value-t/120*100*.8;n.value=Math.max(0,Math.min(100,Math.round(a))),r.value=Math.max(0,Math.min(100,Math.round(o)))}function B(){u.value=!1;const e=window.parent?.document||document;e.removeEventListener('mousemove',N),e.removeEventListener('mouseup',B)}function S(){u.value=!1;const e=window.parent?.document||document;e.removeEventListener('touchmove',V),e.removeEventListener('touchend',S)}return(0,p.watch)(()=>a.visible,e=>{e&&(n.value=a.initialOffsetX,r.value=a.initialOffsetY,l.value=a.initialScale,i.value=a.initialInvert)}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-crop-modal-overlay',onClick:(0,p.withModifiers)(b,['self'])},[(0,p.createElementVNode)('div',eh,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',th,[(0,p.createElementVNode)('span',ah,[a[4]||(a[4]=(0,p.createElementVNode)('i',{class:'fas fa-crop-simple'},null,-1)),(0,p.createTextVNode)(' 调整头像 - '+(0,p.toDisplayString)(e.name),1)]),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(b,['stop'])},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])]),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',oh,[(0,p.createCommentVNode)(' 预览区 - 支持拖动 '),(0,p.createElementVNode)('div',nh,[(0,p.createElementVNode)('div',{ref_key:'previewRef',ref:s,class:(0,p.normalizeClass)(['acu-crop-preview',{'is-dragging':u.value}]),style:(0,p.normalizeStyle)(v.value),onMousedown:k,onTouchstart:(0,p.withModifiers)(C,['prevent'])},[(0,p.createCommentVNode)(' 无图片时显示占位 '),e.imageUrl?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',rh,[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-image'},null,-1),(0,p.createElementVNode)('span',null,'暂无图片',-1)])]))],38)]),(0,p.createCommentVNode)(' 滑块控制 '),(0,p.createElementVNode)('div',lh,[(0,p.createCommentVNode)(' X 偏移 '),(0,p.createElementVNode)('div',ih,[a[7]||(a[7]=(0,p.createElementVNode)('label',{class:'acu-crop-label'},[(0,p.createElementVNode)('i',{class:'fas fa-arrows-left-right'}),(0,p.createTextVNode)(' X偏移 ')],-1)),(0,p.createElementVNode)('input',{type:'range',class:'acu-crop-slider',min:'0',max:'100',value:n.value,onInput:a[0]||(a[0]=e=>n.value=Number(e.target.value))},null,40,ch),(0,p.createElementVNode)('span',sh,(0,p.toDisplayString)(n.value)+'%',1)]),(0,p.createCommentVNode)(' Y 偏移 '),(0,p.createElementVNode)('div',uh,[a[8]||(a[8]=(0,p.createElementVNode)('label',{class:'acu-crop-label'},[(0,p.createElementVNode)('i',{class:'fas fa-arrows-up-down'}),(0,p.createTextVNode)(' Y偏移 ')],-1)),(0,p.createElementVNode)('input',{type:'range',class:'acu-crop-slider',min:'0',max:'100',value:r.value,onInput:a[1]||(a[1]=e=>r.value=Number(e.target.value))},null,40,dh),(0,p.createElementVNode)('span',ph,(0,p.toDisplayString)(r.value)+'%',1)]),(0,p.createCommentVNode)(' 缩放 '),(0,p.createElementVNode)('div',mh,[a[9]||(a[9]=(0,p.createElementVNode)('label',{class:'acu-crop-label'},[(0,p.createElementVNode)('i',{class:'fas fa-magnifying-glass-plus'}),(0,p.createTextVNode)(' 缩放 ')],-1)),(0,p.createElementVNode)('input',{type:'range',class:'acu-crop-slider',min:'100',max:'300',value:l.value,onInput:a[2]||(a[2]=e=>l.value=Number(e.target.value))},null,40,fh),(0,p.createElementVNode)('span',gh,(0,p.toDisplayString)(l.value)+'%',1)])]),(0,p.createCommentVNode)(' 反色选项 - 仅当 showInvertOption 为 true 时显示 '),e.showInvertOption?((0,p.openBlock)(),(0,p.createElementBlock)('div',vh,[(0,p.createElementVNode)('div',bh,[a[11]||(a[11]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createElementVNode)('i',{class:'fas fa-adjust'}),(0,p.createTextVNode)(' 反色效果 '),(0,p.createElementVNode)('span',{class:'hint'},'白变黑/黑变白')],-1)),(0,p.createElementVNode)('div',hh,[(0,p.createElementVNode)('label',xh,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>i.value=e),type:'checkbox'},null,512),[[p.vModelCheckbox,i.value]]),a[10]||(a[10]=(0,p.createElementVNode)('span',{class:'acu-switch-slider'},null,-1))])])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 上传新图片按钮 '),(0,p.createElementVNode)('div',yh,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(y,['stop'])},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1),(0,p.createTextVNode)(' 上传新图片 ',-1)])]),(0,p.createElementVNode)('input',{ref_key:'fileInputRef',ref:c,type:'file',accept:'image/*',style:{display:'none'},onChange:w},null,544)])]),(0,p.createCommentVNode)(' 底部按钮 '),(0,p.createElementVNode)('div',wh,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(x,['stop'])},'重置'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',onClick:(0,p.withModifiers)(h,['stop'])},'确定')])])])):(0,p.createCommentVNode)('v-if',!0)}}),Ch={class:'acu-modal acu-avatar-manager-dialog'},Nh={class:'acu-modal-header'},Vh={class:'acu-avatar-tab-bar'},Eh={class:'acu-avatar-search-bar'},Bh=['placeholder'],Sh={class:'acu-modal-body acu-avatar-list'},Th={key:0,class:'acu-avatar-loading'},Dh={class:'acu-avatar-empty'},Ah={class:'acu-avatar-items'},zh=['onClick'],Ih={class:'acu-avatar-column'},_h=['onClick'],Uh={key:0,class:'acu-avatar-initial'},Mh={key:1,class:'fas fa-camera acu-avatar-camera-hint'},Lh={class:'acu-avatar-info'},$h={class:'acu-avatar-name-row'},Ph={class:'acu-avatar-name-left'},Fh={class:'acu-avatar-name'},jh={key:0,class:'acu-avatar-label-preview'},Rh={class:'acu-avatar-name-right'},Oh=['onClick'],Hh={class:'acu-import-dropdown'},Wh=['onClick'],Gh={key:0,class:'acu-dropdown-menu'},Yh=['onClick'],Xh=['onClick'],Kh=['onClick'],qh={class:'acu-avatar-url-row'},Jh=['value','onChange','onBlur'],Zh={class:'acu-avatar-alias-row'},Qh=['value','onChange','onBlur'],ex={class:'acu-avatar-footer'},tx={class:'acu-footer-left'},ax=['disabled'],ox={class:'acu-footer-right'},nx=['disabled'],rx='acu_graph_config',lx=(0,p.defineComponent)({__name:'AvatarManagerDialog',props:{visible:{type:Boolean,default:!1},nodes:{default:()=>[]},factions:{default:()=>[]}},emits:['close','update','label-change'],setup(e,{emit:t}){function a(){try{return getVariables({type:'chat'})[rx]||{}}catch(e){return console.warn('[AvatarManager] 获取聊天变量失败:',e),{}}}function o(e){try{insertOrAssignVariables({[rx]:e},{type:'chat'})}catch(e){console.warn('[AvatarManager] 保存聊天变量失败:',e)}}const n=e,r=t,l=xo(),i=(0,Aa.d)(),c=Ea(),s=(0,p.ref)('character'),u=(0,p.ref)(!0),d=(0,p.ref)([]),m=(0,p.ref)([]),f=(0,p.ref)(new Map),g=(0,p.computed)(()=>f.value.size>0),v=(0,p.ref)(''),b=(0,p.ref)(!1),h=(0,p.ref)(new Set),x=(0,p.ref)(null),y=(0,p.ref)(null),w=(0,p.ref)(null),k=(0,p.ref)(null),C=(0,p.ref)(!1),N=(0,p.ref)(null),V=(0,p.computed)(()=>'character'===s.value?d.value:m.value),E=(0,p.computed)(()=>{if(!v.value.trim())return V.value;const e=v.value.toLowerCase().trim();return V.value.filter(t=>!!t.name.toLowerCase().includes(e)||(!!t.aliases.some(t=>t.toLowerCase().includes(e))||!!t.displayLabel?.toLowerCase().includes(e)))}),B=(0,p.computed)(()=>!!l.getSillyTavernCharacterAvatar()),S=(0,p.computed)(()=>!!l.getSillyTavernUserAvatar());async function T(e,t,a,o){const n=await l.getAvatar(t),r=await l.getAvatarUrl(t),i=!!n?.blob;let c=null;i?c='local':n?.url?c='url':r&&l.isPlayerNode(t)?c='auto':'faction'!==a||r?'faction'===a&&r&&(c='auto'):c=null;const s=o[t],u=s?.displayLabel,d=s?.selectedIndices,p=n?.aliases||[];return{id:e,name:t,label:u||t,type:a,avatarUrl:r,url:n?.url,offsetX:n?.offsetX??50,offsetY:n?.offsetY??50,scale:n?.scale??150,labelIndices:d,displayLabel:u,source:c,hasLocalBlob:i,aliases:p,aliasesText:p.join(', ')}}async function D(){u.value=!0;try{const e=[],t=[],o=new Set(n.factions.map(e=>e.name)),r=a().labels||{};for(const t of n.nodes){if(o.has(t.name))continue;const a=await T(t.id,t.name,t.type,r);e.push(a)}for(const e of n.factions){const a=await T(e.id,e.name,'faction',r);t.push(a)}if(f.value.size>0)for(const[a,o]of f.value){const n=e.findIndex(e=>e.name===a);if(-1!==n){const t=e[n];e[n]={...t,offsetX:o.offsetX??t.offsetX,offsetY:o.offsetY??t.offsetY,scale:o.scale??t.scale,url:o.url??t.url,avatarUrl:o.url??t.avatarUrl,source:o.url?'url':t.source,displayLabel:o.displayLabel??t.displayLabel,labelIndices:o.labelIndices??t.labelIndices,label:o.displayLabel??t.label,aliases:o.aliases??t.aliases,aliasesText:o.aliases?o.aliases.join(', '):t.aliasesText}}const r=t.findIndex(e=>e.name===a);if(-1!==r){const e=t[r];t[r]={...e,offsetX:o.offsetX??e.offsetX,offsetY:o.offsetY??e.offsetY,scale:o.scale??e.scale,url:o.url??e.url,avatarUrl:o.url??e.avatarUrl,source:o.url?'url':e.source,displayLabel:o.displayLabel??e.displayLabel,labelIndices:o.labelIndices??e.labelIndices,label:o.displayLabel??e.label,aliases:o.aliases??e.aliases,aliasesText:o.aliases?o.aliases.join(', '):e.aliasesText}}}d.value=e,m.value=t}catch(e){console.error('[AvatarManager] 加载数据失败:',e),i.error('加载数据失败')}finally{u.value=!1}}function A(e){s.value=e,v.value='',X()}function I(){g.value&&!confirm('有未保存的更改，确定要关闭吗？')||(f.value.clear(),r('close'))}function U(e){if(!e)return'?';if(/^[A-Za-z\s'-]+$/.test(e)&&e.includes(' ')){const t=e.split(' ')[0];return t.length>6?t.slice(0,6):t}return e[e.length-1]}function M(e){switch(e){case'local':return'本地';case'url':return'URL';case'auto':return'酒馆';default:return''}}function L(e){return e.avatarUrl?{backgroundImage:`url('${e.avatarUrl}')`,backgroundPosition:`${e.offsetX}% ${e.offsetY}%`,backgroundSize:`${e.scale}%`}:{}}function P(){x.value=null}async function F(e){const t=e.target,a=t.files?.[0];if(!a||!w.value)return void(t.value='');const o=w.value;try{const e=await vt(a),t=await bt(e,300,.85),n=await fetch(t),c=await n.blob();await l.saveAvatar({name:o.name,blob:c,offsetX:o.offsetX,offsetY:o.offsetY,scale:o.scale,aliases:[...(0,p.toRaw)(o.aliases)],updatedAt:Date.now()}),await D(),r('update'),i.success('头像已上传')}catch(e){console.error('[AvatarManager] 上传失败:',e),alert('上传失败')}t.value='',w.value=null}function j(e,t){const a=t.trim();q(e.name,{url:a||void 0}),J(e.id,{url:a||void 0,avatarUrl:a||e.avatarUrl,source:a?'url':e.source})}function R(e,t){const a=t.split(/[,，、\s]+/).map(e=>e.trim()).filter(Boolean);q(e.name,{aliases:a}),J(e.id,{aliases:a,aliasesText:a.join(', ')})}function O(e){const t=a(),o=t.labels?.[e.name],n={...e,labelIndices:o?.selectedIndices||[],displayLabel:o?.displayLabel,label:o?.displayLabel||e.name};k.value=n,c.openNodeLabelDialog({fullName:n.name,initialIndices:n.labelIndices||[]},{onApply:e=>{const t=e.sort((e,t)=>e-t).map(e=>n.name[e]).join('');!function(e,t){q(e.name,{displayLabel:t.displayLabel,labelIndices:t.selectedIndices}),J(e.id,{displayLabel:t.displayLabel,labelIndices:t.selectedIndices,label:t.displayLabel})}(n,{displayLabel:t,selectedIndices:e})},onReset:()=>{!function(e){q(e.name,{displayLabel:void 0,labelIndices:void 0}),J(e.id,{displayLabel:void 0,labelIndices:void 0,label:e.name})}(n)}})}function H(){C.value=!1,N.value=null}function W(e){if(!N.value)return;const t=N.value;q(t.name,{offsetX:e.offsetX,offsetY:e.offsetY,scale:e.scale}),J(t.id,{offsetX:e.offsetX,offsetY:e.offsetY,scale:e.scale}),N.value={...t,offsetX:e.offsetX,offsetY:e.offsetY,scale:e.scale},H()}async function G(e){if(!N.value)return;w.value=N.value;const t=new DataTransfer;t.items.add(e);const a={target:{files:t.files,value:''}};await F(a),H()}function Y(){b.value=!0,h.value.clear()}function X(){b.value=!1,h.value.clear()}async function K(){if(0===h.value.size)return;const e=V.value.filter(e=>h.value.has(e.id)).map(e=>e.name);if(confirm(`确定要删除 ${e.length} 个头像配置吗？\n\n这将从 IndexedDB 中永久删除图片数据。`))try{await l.deleteAvatars(e);const t=a();if(t.labels){let a=!1;for(const o of e)t.labels[o]&&(delete t.labels[o],a=!0);a&&o(t)}await D(),X(),r('update'),i.success('删除成功')}catch(e){console.error('[AvatarManager] 删除失败:',e),i.error('删除失败')}}function q(e,t){const a=f.value.get(e)||{};f.value.set(e,{...a,...t})}function J(e,t){const a=d.value.findIndex(t=>t.id===e);-1!==a&&(d.value[a]={...d.value[a],...t});const o=m.value.findIndex(t=>t.id===e);-1!==o&&(m.value[o]={...m.value[o],...t})}async function Z(){if(0!==f.value.size)try{const e=a();e.labels||(e.labels={});let t=!1;for(const[a,o]of f.value)if(void 0===o.displayLabel&&void 0===o.labelIndices||(o.displayLabel?e.labels[a]={displayLabel:o.displayLabel,selectedIndices:o.labelIndices||[]}:void 0===o.displayLabel&&void 0===o.labelIndices&&delete e.labels[a],t=!0),void 0!==o.url||void 0!==o.offsetX||void 0!==o.offsetY||void 0!==o.scale||void 0!==o.aliases){const e=await l.getAvatar(a);let t=[];void 0!==o.aliases?t=[...(0,p.toRaw)(o.aliases)]:e?.aliases&&(t=[...e.aliases]);const n={name:a,blob:e?.blob,url:void 0!==o.url?o.url:e?.url,offsetX:o.offsetX??e?.offsetX??50,offsetY:o.offsetY??e?.offsetY??50,scale:o.scale??e?.scale??150,aliases:t,updatedAt:Date.now()};await l.saveAvatar(n)}t&&o(e),f.value.clear(),i.success('保存成功'),r('update'),r('label-change')}catch(e){console.error('[AvatarManager] 保存失败:',e),i.error('保存失败: '+(e instanceof Error?e.message:String(e)))}}return(0,p.onMounted)(()=>{n.visible&&D()}),(0,p.watch)(()=>n.visible,e=>{e?D():(b.value=!1,h.value.clear(),x.value=null,s.value='character',f.value.clear())}),(0,p.watch)(x,e=>{if(e){const e=()=>{x.value=null,document.removeEventListener('click',e)};setTimeout(()=>{document.addEventListener('click',e)},0)}}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-avatar-manager-overlay',onClick:(0,p.withModifiers)(I,['self'])},[(0,p.createElementVNode)('div',Ch,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Nh,[a[4]||(a[4]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-user-circle'}),(0,p.createTextVNode)(' 头像管理 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(I,['stop'])},'完成')]),(0,p.createCommentVNode)(' Tab 切换栏 '),(0,p.createElementVNode)('div',Vh,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-avatar-tab-btn',{active:'character'===s.value}]),onClick:a[0]||(a[0]=(0,p.withModifiers)(e=>A('character'),['stop']))},[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-user'},null,-1),(0,p.createTextVNode)(' 人物头像 ',-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-avatar-tab-btn',{active:'faction'===s.value}]),onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>A('faction'),['stop']))},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-users'},null,-1),(0,p.createTextVNode)(' 势力头像 ',-1)])],2)]),(0,p.createCommentVNode)(' 搜索框 '),(0,p.createElementVNode)('div',Eh,[a[8]||(a[8]=(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>v.value=e),type:'text',class:'acu-avatar-search-input',placeholder:'character'===s.value?'搜索角色名称或别名...':'搜索势力名称...'},null,8,Bh),[[p.vModelText,v.value]]),v.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-search-clear',onClick:a[3]||(a[3]=(0,p.withModifiers)(e=>v.value='',['stop']))},[...a[7]||(a[7]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 内容区 - 可滚动 '),(0,p.createElementVNode)('div',Sh,[(0,p.createCommentVNode)(' 加载中 '),u.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',Th,[...a[9]||(a[9]=[(0,p.createElementVNode)('i',{class:'fas fa-spinner fa-spin'},null,-1),(0,p.createElementVNode)('span',null,'加载中...',-1)])])):0===E.value.length?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 空状态 '),(0,p.createElementVNode)('div',Dh,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)('character'===s.value?'fas fa-user-slash':'fas fa-users-slash')},null,2),(0,p.createElementVNode)('p',null,(0,p.toDisplayString)(v.value?'未找到匹配的数据':'character'===s.value?'暂无角色数据':'暂无势力数据'),1)])],2112)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 统一头像列表 '),(0,p.createElementVNode)('div',Ah,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(E.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['acu-avatar-item',{selected:h.value.has(e.id)}])},[(0,p.createCommentVNode)(' 批量删除选择框 '),b.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-avatar-checkbox',onClick:(0,p.withModifiers)(t=>function(e){const t=new Set(h.value);t.has(e)?t.delete(e):t.add(e),h.value=t}(e.id),['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(h.value.has(e.id)?'fas fa-check-square':'far fa-square')},null,2)],8,zh)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 头像区：头像 + 来源标签 '),(0,p.createElementVNode)('div',Ih,[(0,p.createCommentVNode)(' 头像预览 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-avatar-preview',{'has-image':!!e.avatarUrl}]),style:(0,p.normalizeStyle)(L(e)),onClick:(0,p.withModifiers)(t=>function(e){if(!e.avatarUrl)return w.value=e,void y.value?.click();N.value=e,C.value=!0}(e),['stop'])},[e.avatarUrl?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('span',Uh,(0,p.toDisplayString)(e.displayLabel||U(e.name)),1)),e.avatarUrl?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('i',Mh))],14,_h),(0,p.createCommentVNode)(' 来源标签 '),e.source?((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:0,class:(0,p.normalizeClass)(['acu-avatar-source','acu-source-'+e.source])},(0,p.toDisplayString)(M(e.source)),3)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 信息区 '),(0,p.createElementVNode)('div',Lh,[(0,p.createCommentVNode)(' 名称行 '),(0,p.createElementVNode)('div',$h,[(0,p.createCommentVNode)(' 左侧：全名 + 标签预览 '),(0,p.createElementVNode)('div',Ph,[(0,p.createElementVNode)('span',Fh,(0,p.toDisplayString)(e.name),1),e.displayLabel?((0,p.openBlock)(),(0,p.createElementBlock)('span',jh,'('+(0,p.toDisplayString)(e.displayLabel)+')',1)):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 右侧：按钮区 '),(0,p.createElementVNode)('div',Rh,[(0,p.createCommentVNode)(' 名字配置按钮 '),(0,p.createElementVNode)('button',{class:'acu-avatar-name-btn',title:'配置头像显示名称',onClick:(0,p.withModifiers)(t=>O(e),['stop'])},' 姓名显示 ',8,Oh),(0,p.createCommentVNode)(' 导入下拉 '),(0,p.createElementVNode)('div',Hh,[(0,p.createElementVNode)('button',{class:'acu-avatar-import-btn',title:'导入头像',onClick:(0,p.withModifiers)(t=>{return a=e.id,void(x.value=x.value===a?null:a);var a},['stop'])},[...a[10]||(a[10]=[(0,p.createTextVNode)(' 导入 ',-1),(0,p.createElementVNode)('i',{class:'fas fa-caret-down'},null,-1)])],8,Wh),x.value===e.id?((0,p.openBlock)(),(0,p.createElementBlock)('div',Gh,[(0,p.createElementVNode)('div',{class:'acu-dropdown-item',onClick:(0,p.withModifiers)(t=>function(e){P(),w.value=e,y.value?.click()}(e),['stop'])},[...a[11]||(a[11]=[(0,p.createElementVNode)('i',{class:'fas fa-upload'},null,-1),(0,p.createTextVNode)(' 本地导入 ',-1)])],8,Yh),(0,p.createCommentVNode)(' 仅人物头像显示酒馆导入选项 '),'character'===s.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-dropdown-item',{disabled:!B.value}]),onClick:(0,p.withModifiers)(t=>function(e){P();const t=l.getSillyTavernCharacterAvatar();t?(q(e.name,{url:t}),J(e.id,{url:t,avatarUrl:t,source:'url'})):alert('未找到角色卡头像')}(e),['stop'])},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-user-circle'},null,-1),(0,p.createTextVNode)(' 角色卡头像 ',-1)])],10,Xh),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-dropdown-item',{disabled:!S.value}]),onClick:(0,p.withModifiers)(t=>function(e){P();const t=l.getSillyTavernUserAvatar();t?(q(e.name,{url:t}),J(e.id,{url:t,avatarUrl:t,source:'url'})):alert('未找到用户头像')}(e),['stop'])},[...a[13]||(a[13]=[(0,p.createElementVNode)('i',{class:'fas fa-user'},null,-1),(0,p.createTextVNode)(' 用户头像 ',-1)])],10,Kh)],64)):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0)])])]),(0,p.createCommentVNode)(' URL 输入 '),(0,p.createElementVNode)('div',qh,[a[14]||(a[14]=(0,p.createElementVNode)('span',{class:'acu-url-label'},'URL:',-1)),(0,p.createElementVNode)('input',{type:'text',class:'acu-avatar-url-input',placeholder:'粘贴图片URL...',value:e.url||'',onChange:t=>j(e,t.target.value),onBlur:t=>j(e,t.target.value)},null,40,Jh)]),(0,p.createCommentVNode)(' 别名输入 '),(0,p.createElementVNode)('div',Zh,[a[15]||(a[15]=(0,p.createElementVNode)('span',{class:'acu-alias-label'},'别名:',-1)),(0,p.createElementVNode)('input',{type:'text',class:'acu-avatar-alias-input',placeholder:'输入别名，用逗号分隔...',value:e.aliasesText||'',onChange:t=>R(e,t.target.value),onBlur:t=>R(e,t.target.value)},null,40,Qh)])])],2))),128))])],2112))]),(0,p.createCommentVNode)(' 底部固定栏 '),(0,p.createElementVNode)('div',ex,[(0,p.createElementVNode)('div',tx,[b.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(X,['stop'])},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn danger',disabled:0===h.value.size,onClick:(0,p.withModifiers)(K,['stop'])},' 删除 ('+(0,p.toDisplayString)(h.value.size)+') ',9,ax)],64)):((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(Y,['stop'])},[...a[16]||(a[16]=[(0,p.createElementVNode)('i',{class:'fas fa-trash-alt'},null,-1),(0,p.createTextVNode)(' 批量删除 ',-1)])]))]),(0,p.createElementVNode)('div',ox,[(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',disabled:!g.value,onClick:(0,p.withModifiers)(Z,['stop'])},[...a[17]||(a[17]=[(0,p.createElementVNode)('i',{class:'fas fa-save'},null,-1),(0,p.createTextVNode)(' 保存 ',-1)])],8,nx)])])]),(0,p.createCommentVNode)(' 隐藏的文件输入 '),(0,p.createElementVNode)('input',{ref_key:'fileInputRef',ref:y,type:'file',accept:'image/*',style:{display:'none'},onChange:F},null,544),(0,p.createCommentVNode)(' 裁剪弹窗 '),C.value?((0,p.openBlock)(),(0,p.createBlock)(kh,{key:0,visible:C.value,'image-url':N.value?.avatarUrl||'',name:N.value?.name||'','initial-offset-x':N.value?.offsetX??50,'initial-offset-y':N.value?.offsetY??50,'initial-scale':N.value?.scale??150,onClose:H,onApply:W,onUpload:G},null,8,['visible','image-url','name','initial-offset-x','initial-offset-y','initial-scale'])):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0)}}),ix=lx,cx={class:'acu-modal acu-faction-settings-modal'},sx={class:'acu-modal-header'},ux={class:'acu-modal-title'},dx={class:'acu-modal-body'},px={class:'acu-settings-section'},mx={class:'acu-settings-group'},fx={class:'acu-settings-row'},gx={class:'acu-settings-control'},vx={class:'acu-settings-row'},bx={class:'acu-settings-control'},hx={class:'acu-settings-row'},xx={class:'acu-settings-label'},yx={class:'hint'},wx={class:'acu-settings-control'},kx={class:'acu-settings-section'},Cx={class:'acu-settings-group'},Nx={class:'acu-settings-row'},Vx={class:'acu-settings-control'},Ex={class:'acu-settings-row'},Bx={class:'acu-settings-label'},Sx={class:'hint'},Tx={class:'acu-settings-control'},Dx={class:'acu-settings-section'},Ax={class:'acu-settings-group'},zx={class:'acu-settings-row acu-action-row'},Ix=(0,p.defineComponent)({__name:'FactionSettingsDialog',props:{visible:{type:Boolean,default:!1},factionId:{default:''},factionName:{default:''}},emits:['close','save'],setup(e,{emit:t}){const a=e,o=t,n=Ho(),r=(0,p.reactive)({borderColor:Lo.border,backgroundColor:l(Lo.background),backgroundOpacity:Lo.opacity??10,labelPosition:'top',labelFontSize:14});function l(e){if(e.startsWith('#'))return e;const t=e.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);if(t){const e=parseInt(t[1],10),a=parseInt(t[2],10),o=parseInt(t[3],10);return`#${e.toString(16).padStart(2,'0')}${a.toString(16).padStart(2,'0')}${o.toString(16).padStart(2,'0')}`}return'#808080'}function i(){const e=n.getFactionOverride(a.factionId);e?(r.borderColor=e.border||Lo.border,r.backgroundColor=l(e.background||Lo.background),r.backgroundOpacity=e.opacity??Lo.opacity??10,r.labelPosition=e.labelPosition??'top',r.labelFontSize=e.labelFontSize??n.config.factionLabelFontSize):(r.borderColor=Lo.border,r.backgroundColor=l(Lo.background),r.backgroundOpacity=Lo.opacity??10,r.labelPosition='top',r.labelFontSize=n.config.factionLabelFontSize)}function c(){o('close')}function s(){n.removeFactionOverride(a.factionId),r.borderColor=Lo.border,r.backgroundColor=l(Lo.background),r.backgroundOpacity=Lo.opacity??10,r.labelPosition='top',r.labelFontSize=n.config.factionLabelFontSize}return(0,p.watch)(()=>a.visible,e=>{e&&a.factionId&&i()}),(0,p.watch)(()=>a.factionId,e=>{e&&a.visible&&i()}),(0,p.watchEffect)(()=>{var e,t;a.visible&&a.factionId&&(n.setFactionOverride(a.factionId,{border:r.borderColor,background:(e=r.backgroundColor,t=r.backgroundOpacity,`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t/100})`),opacity:r.backgroundOpacity,labelPosition:r.labelPosition,labelFontSize:r.labelFontSize}),o('save'))}),(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(c,['self'])},[(0,p.createElementVNode)('div',cx,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',sx,[(0,p.createElementVNode)('span',ux,'势力设置 - '+(0,p.toDisplayString)(e.factionName),1),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(c,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',dx,[(0,p.createCommentVNode)(' 颜色设置 '),(0,p.createElementVNode)('div',px,[a[8]||(a[8]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 颜色设置 ')],-1)),(0,p.createElementVNode)('div',mx,[(0,p.createCommentVNode)(' 边框&tag颜色 '),(0,p.createElementVNode)('div',fx,[a[5]||(a[5]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 边框&tag颜色 '),(0,p.createElementVNode)('span',{class:'hint'},'虚线框颜色')],-1)),(0,p.createElementVNode)('div',gx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[0]||(a[0]=e=>r.borderColor=e),type:'color',class:'acu-dashed',title:'边框颜色'},null,512),[[p.vModelText,r.borderColor]])])]),(0,p.createCommentVNode)(' 背景颜色 '),(0,p.createElementVNode)('div',vx,[a[6]||(a[6]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 背景颜色 '),(0,p.createElementVNode)('span',{class:'hint'},'容器填充色')],-1)),(0,p.createElementVNode)('div',bx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[1]||(a[1]=e=>r.backgroundColor=e),type:'color',title:'背景颜色'},null,512),[[p.vModelText,r.backgroundColor]])])]),(0,p.createCommentVNode)(' 背景透明度 '),(0,p.createElementVNode)('div',hx,[(0,p.createElementVNode)('div',xx,[a[7]||(a[7]=(0,p.createTextVNode)(' 背景透明度 ',-1)),(0,p.createElementVNode)('span',yx,(0,p.toDisplayString)(r.backgroundOpacity)+'%',1)]),(0,p.createElementVNode)('div',wx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>r.backgroundOpacity=e),type:'range',min:'0',max:'100',step:'5'},null,512),[[p.vModelText,r.backgroundOpacity,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 标签设置 '),(0,p.createElementVNode)('div',kx,[a[12]||(a[12]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-tag'}),(0,p.createTextVNode)(' 标签设置 ')],-1)),(0,p.createElementVNode)('div',Cx,[(0,p.createCommentVNode)(' 标签位置 '),(0,p.createElementVNode)('div',Nx,[a[10]||(a[10]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 标签位置 '),(0,p.createElementVNode)('span',{class:'hint'},'势力名称显示位置')],-1)),(0,p.createElementVNode)('div',Vx,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[3]||(a[3]=e=>r.labelPosition=e)},[...a[9]||(a[9]=[(0,p.createElementVNode)('option',{value:'top'},'顶部',-1),(0,p.createElementVNode)('option',{value:'bottom'},'底部',-1),(0,p.createElementVNode)('option',{value:'top-left'},'内部左上',-1),(0,p.createElementVNode)('option',{value:'top-right'},'内部右上',-1),(0,p.createElementVNode)('option',{value:'bottom-left'},'内部左下',-1),(0,p.createElementVNode)('option',{value:'bottom-right'},'内部右下',-1),(0,p.createElementVNode)('option',{value:'none'},'不显示',-1)])],512),[[p.vModelSelect,r.labelPosition]])])]),(0,p.createCommentVNode)(' 标签字体大小 '),(0,p.createElementVNode)('div',Ex,[(0,p.createElementVNode)('div',Bx,[a[11]||(a[11]=(0,p.createTextVNode)(' 标签字体 ',-1)),(0,p.createElementVNode)('span',Sx,(0,p.toDisplayString)(r.labelFontSize)+'px',1)]),(0,p.createElementVNode)('div',Tx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>r.labelFontSize=e),type:'range',min:'10',max:'24',step:'1'},null,512),[[p.vModelText,r.labelFontSize,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 操作按钮 '),(0,p.createElementVNode)('div',Dx,[(0,p.createElementVNode)('div',Ax,[(0,p.createElementVNode)('div',zx,[(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-secondary',onClick:(0,p.withModifiers)(s,['stop'])},[...a[13]||(a[13]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 重置为默认 ',-1)])])])])])])])])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}});d(390);const _x=Ix,Ux={class:'acu-modal acu-graph-settings-modal'},Mx={class:'acu-modal-header'},Lx={class:'acu-modal-body'},$x={class:'acu-settings-section'},Px={class:'acu-settings-group'},Fx={class:'acu-settings-row'},jx={class:'acu-settings-label'},Rx={class:'hint'},Ox={class:'acu-settings-control'},Hx={class:'acu-settings-row'},Wx={class:'acu-settings-label'},Gx={class:'hint'},Yx={class:'acu-settings-control'},Xx={class:'acu-settings-row'},Kx={class:'acu-settings-control'},qx={class:'acu-switch'},Jx={class:'acu-settings-section'},Zx={class:'acu-settings-group'},Qx={class:'acu-settings-row'},ey={class:'acu-settings-label'},ty={class:'hint'},ay={class:'acu-settings-control'},oy={class:'acu-settings-row'},ny={class:'acu-settings-label'},ry={class:'hint'},ly={class:'acu-settings-control'},iy={class:'acu-settings-row'},cy={class:'acu-settings-label'},sy={class:'hint'},uy={class:'acu-settings-control'},dy={key:0,class:'acu-settings-section'},py={class:'acu-settings-title'},my={style:{'font-weight':'400','font-size':'11px',color:'var(--acu-text-sub)','margin-left':'auto'}},fy={class:'acu-faction-color-group acu-faction-color-scrollable'},gy={class:'acu-settings-label'},vy={class:'acu-settings-control acu-faction-color-control'},by=['value','onInput'],hy=['value','onInput'],xy=['value','title','onInput'],yy={class:'acu-opacity-value'},wy={class:'acu-settings-section'},ky={class:'acu-settings-group'},Cy={class:'acu-settings-row'},Ny={class:'acu-settings-control'},Vy={class:'acu-switch'},Ey=['checked'],By={class:'acu-settings-section'},Sy={class:'acu-settings-group'},Ty={class:'acu-settings-row'},Dy={class:'acu-settings-control'},Ay={class:'acu-switch'},zy={key:0,class:'acu-legend-items-section'},Iy={class:'acu-legend-items-header'},_y={class:'acu-legend-items-list'},Uy={key:0,class:'acu-legend-item-edit'},My={class:'acu-legend-edit-row'},Ly={class:'acu-legend-edit-row'},$y={class:'acu-legend-edit-actions'},Py={class:'acu-legend-item-display'},Fy={class:'acu-legend-emoji'},jy={class:'acu-legend-label'},Ry={class:'acu-legend-keywords'},Oy={key:0,class:'acu-legend-keyword-more'},Hy={class:'acu-legend-item-actions'},Wy=['onClick'],Gy=['onClick'],Yy={key:0,class:'acu-legend-empty'},Xy={class:'acu-legend-reset-wrapper'},Ky={class:'acu-settings-section'},qy={class:'acu-settings-group'},Jy={class:'acu-settings-row acu-action-row'},Zy=(0,p.defineComponent)({__name:'GraphSettingsDialog',props:{visible:{type:Boolean},factions:{}},emits:['close','open-avatar-manager'],setup(e,{emit:t}){const a=e,o=t,n=Ho(),r=(Ea(),(0,p.computed)(()=>n.config)),l=(0,p.computed)(()=>a.factions||[]),i=(0,p.computed)(()=>n.getLegendConfig()),c=(0,p.ref)(null),s=(0,p.reactive)({label:'',color:'#888888',emoji:'',keywordsStr:''});function u(e){const t=n.config.factionColors[e];if(t)return t.border;const a=l.value.indexOf(e);return a>=0&&a<Mo.length?Mo[a].border:Lo.border}function d(e){const t=n.config.factionColors[e];if(t){const e=t.background.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(e){const t=parseInt(e[1]),a=parseInt(e[2]),o=parseInt(e[3]);return`#${t.toString(16).padStart(2,'0')}${a.toString(16).padStart(2,'0')}${o.toString(16).padStart(2,'0')}`}return t.background}const a=l.value.indexOf(e);let o;o=a>=0&&a<Mo.length?Mo[a].background:Lo.background;const r=o.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(r){const e=parseInt(r[1]),t=parseInt(r[2]),a=parseInt(r[3]);return`#${e.toString(16).padStart(2,'0')}${t.toString(16).padStart(2,'0')}${a.toString(16).padStart(2,'0')}`}return'#808080'}function m(e){const t=n.config.factionColors[e];if(t&&void 0!==t.opacity)return t.opacity;const a=l.value.indexOf(e);return a>=0&&a<Mo.length?Mo[a].opacity:Lo.opacity??10}function f(e,t){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`}function g(){o('close'),o('open-avatar-manager')}function v(){o('close')}function b(){n.resetToDefault()}function h(){n.setLegendEnabled(i.value.enabled)}function x(){n.addLegendItem({label:'新图例',color:'#888888',emoji:'⚪',keywords:[]});const e=n.getLegendConfig().items,t=e[e.length-1];t&&y(t)}function y(e){c.value=e.id,s.label=e.label,s.color=e.color,s.emoji=e.emoji||'',s.keywordsStr=e.keywords.join(', ')}function w(){if(!c.value)return;const e=s.keywordsStr.split(/[,，]/).map(e=>e.trim()).filter(e=>e.length>0);n.updateLegendItem(c.value,{label:s.label,color:s.color,emoji:s.emoji||void 0,keywords:e}),c.value=null}function k(){c.value=null}function C(){n.resetLegendConfig()}return(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(v,['self'])},[(0,p.createElementVNode)('div',Ux,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Mx,[a[12]||(a[12]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'关系图设置',-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(v,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',Lx,[(0,p.createCommentVNode)(' 显示设置 '),(0,p.createElementVNode)('div',$x,[a[18]||(a[18]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-eye'}),(0,p.createTextVNode)(' 显示设置 ')],-1)),(0,p.createElementVNode)('div',Px,[(0,p.createCommentVNode)(' 节点大小 '),(0,p.createElementVNode)('div',Fx,[(0,p.createElementVNode)('div',jx,[a[13]||(a[13]=(0,p.createTextVNode)(' 节点大小 ',-1)),(0,p.createElementVNode)('span',Rx,(0,p.toDisplayString)(r.value.nodeSize)+'px',1)]),(0,p.createElementVNode)('div',Ox,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[0]||(a[0]=e=>r.value.nodeSize=e),type:'range',min:'30',max:'80',step:'5'},null,512),[[p.vModelText,r.value.nodeSize,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 边宽度 '),(0,p.createElementVNode)('div',Hx,[(0,p.createElementVNode)('div',Wx,[a[14]||(a[14]=(0,p.createTextVNode)(' 边宽度 ',-1)),(0,p.createElementVNode)('span',Gx,(0,p.toDisplayString)(r.value.edgeWidth.toFixed(1))+'px',1)]),(0,p.createElementVNode)('div',Yx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[1]||(a[1]=e=>r.value.edgeWidth=e),type:'range',min:'1',max:'5',step:'0.5'},null,512),[[p.vModelText,r.value.edgeWidth,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 显示图例 '),(0,p.createElementVNode)('div',Xx,[a[16]||(a[16]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 显示图例 '),(0,p.createElementVNode)('span',{class:'hint'},'关系颜色图例')],-1)),(0,p.createElementVNode)('div',Kx,[(0,p.createElementVNode)('label',qx,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>r.value.showLegend=e),type:'checkbox'},null,512),[[p.vModelCheckbox,r.value.showLegend]]),a[15]||(a[15]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])]),(0,p.createCommentVNode)(' 头像管理入口 '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:(0,p.withModifiers)(g,['stop'])},[...a[17]||(a[17]=[(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 头像管理 '),(0,p.createElementVNode)('span',{class:'hint'},'管理节点头像')],-1),(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1)])])])]),(0,p.createCommentVNode)(' 字体设置 '),(0,p.createElementVNode)('div',Jx,[a[22]||(a[22]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-font'}),(0,p.createTextVNode)(' 字体设置 ')],-1)),(0,p.createElementVNode)('div',Zx,[(0,p.createCommentVNode)(' 关系标签字体 '),(0,p.createElementVNode)('div',Qx,[(0,p.createElementVNode)('div',ey,[a[19]||(a[19]=(0,p.createTextVNode)(' 关系标签 ',-1)),(0,p.createElementVNode)('span',ty,(0,p.toDisplayString)(r.value.relationLabelFontSize)+'px',1)]),(0,p.createElementVNode)('div',ay,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[3]||(a[3]=e=>r.value.relationLabelFontSize=e),type:'range',min:'8',max:'16',step:'1'},null,512),[[p.vModelText,r.value.relationLabelFontSize,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 人名标签字体 '),(0,p.createElementVNode)('div',oy,[(0,p.createElementVNode)('div',ny,[a[20]||(a[20]=(0,p.createTextVNode)(' 人名标签 ',-1)),(0,p.createElementVNode)('span',ry,(0,p.toDisplayString)(r.value.nameLabelFontSize)+'px',1)]),(0,p.createElementVNode)('div',ly,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>r.value.nameLabelFontSize=e),type:'range',min:'8',max:'18',step:'1'},null,512),[[p.vModelText,r.value.nameLabelFontSize,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 势力名标签字体 '),(0,p.createElementVNode)('div',iy,[(0,p.createElementVNode)('div',cy,[a[21]||(a[21]=(0,p.createTextVNode)(' 势力名标签 ',-1)),(0,p.createElementVNode)('span',sy,(0,p.toDisplayString)(r.value.factionLabelFontSize)+'px',1)]),(0,p.createElementVNode)('div',uy,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[5]||(a[5]=e=>r.value.factionLabelFontSize=e),type:'range',min:'10',max:'20',step:'1'},null,512),[[p.vModelText,r.value.factionLabelFontSize,void 0,{number:!0}]])])])])]),(0,p.createCommentVNode)(' 势力颜色设置 '),l.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',dy,[(0,p.createElementVNode)('div',py,[a[23]||(a[23]=(0,p.createElementVNode)('i',{class:'fas fa-palette'},null,-1)),a[24]||(a[24]=(0,p.createTextVNode)(' 势力颜色 ',-1)),(0,p.createElementVNode)('span',my,(0,p.toDisplayString)(l.value.length)+' 个势力 ',1)]),(0,p.createCommentVNode)(' 颜色提示 '),a[25]||(a[25]=(0,p.createElementVNode)('div',{class:'acu-faction-color-hint'},[(0,p.createElementVNode)('span',{class:'hint-item'},[(0,p.createElementVNode)('span',{class:'hint-box dashed'}),(0,p.createTextVNode)(' 边框色 ')]),(0,p.createElementVNode)('span',{class:'hint-item'},[(0,p.createElementVNode)('span',{class:'hint-box solid'}),(0,p.createTextVNode)(' 背景色 ')]),(0,p.createElementVNode)('span',{class:'hint-item'},[(0,p.createElementVNode)('i',{class:'fas fa-adjust',style:{'font-size':'12px','margin-right':'2px'}}),(0,p.createTextVNode)(' 透明度 ')])],-1)),(0,p.createCommentVNode)(' 可滚动的势力列表 '),(0,p.createElementVNode)('div',fy,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e,class:'acu-settings-row acu-faction-color-row'},[(0,p.createElementVNode)('div',gy,(0,p.toDisplayString)(e),1),(0,p.createElementVNode)('div',vy,[(0,p.createElementVNode)('input',{type:'color',class:'acu-dashed',value:u(e),title:'边框颜色（虚线框）',onInput:t=>function(e,t){const a=t.target.value,o=n.config.factionColors[e]||{border:u(e),background:f(d(e),.1)};n.setFactionColor(e,{...o,border:a})}(e,t)},null,40,by),(0,p.createElementVNode)('input',{type:'color',value:d(e),title:'背景颜色',onInput:t=>function(e,t){const a=t.target.value,o=m(e),r=n.config.factionColors[e]||{border:u(e),background:f(a,o/100),opacity:o};n.setFactionColor(e,{...r,background:f(a,o/100)})}(e,t)},null,40,hy),(0,p.createElementVNode)('input',{type:'range',class:'acu-opacity-slider',value:m(e),min:'0',max:'100',step:'5',title:`透明度: ${m(e)}%`,onInput:t=>function(e,t){const a=t.target,o=parseInt(a.value,10),r=d(e),l=n.config.factionColors[e]||{border:u(e),background:f(r,o/100),opacity:o};n.setFactionColor(e,{...l,background:f(r,o/100),opacity:o})}(e,t)},null,40,xy),(0,p.createElementVNode)('span',yy,(0,p.toDisplayString)(m(e))+'%',1)])]))),128))])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 背景配置 '),(0,p.createElementVNode)('div',wy,[a[29]||(a[29]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-image'}),(0,p.createTextVNode)(' 背景配置 ')],-1)),(0,p.createElementVNode)('div',ky,[(0,p.createElementVNode)('div',Cy,[a[27]||(a[27]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 显示背景图片 '),(0,p.createElementVNode)('span',{class:'hint'},'使用全局主题背景')],-1)),(0,p.createElementVNode)('div',Ny,[(0,p.createElementVNode)('label',Vy,[(0,p.createElementVNode)('input',{checked:r.value.showBackground,type:'checkbox',onChange:a[6]||(a[6]=e=>(0,p.unref)(n).setShowBackground(e.target.checked))},null,40,Ey),a[26]||(a[26]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])]),a[28]||(a[28]=(0,p.createElementVNode)('div',{class:'acu-settings-row',style:{'justify-content':'flex-start','padding-top':'0','padding-bottom':'8px'}},[(0,p.createElementVNode)('span',{style:{'font-size':'11px',color:'var(--acu-text-sub)'}},[(0,p.createElementVNode)('i',{class:'fas fa-info-circle',style:{'margin-right':'4px'}}),(0,p.createTextVNode)(' 如需更换背景图片，请前往"设置 > 主题配置" ')])],-1))])]),(0,p.createCommentVNode)(' 图例配置 '),(0,p.createElementVNode)('div',By,[a[40]||(a[40]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-th-list'}),(0,p.createTextVNode)(' 图例配置 '),(0,p.createElementVNode)('span',{style:{'font-weight':'400','font-size':'11px',color:'var(--acu-text-sub)','margin-left':'auto'}},' 自定义关系颜色 ')],-1)),(0,p.createElementVNode)('div',Sy,[(0,p.createCommentVNode)(' 启用自定义图例 '),(0,p.createElementVNode)('div',Ty,[a[31]||(a[31]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 启用自定义图例 '),(0,p.createElementVNode)('span',{class:'hint'},'覆盖默认颜色规则')],-1)),(0,p.createElementVNode)('div',Dy,[(0,p.createElementVNode)('label',Ay,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[7]||(a[7]=e=>i.value.enabled=e),type:'checkbox',onChange:h},null,544),[[p.vModelCheckbox,i.value.enabled]]),a[30]||(a[30]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])])]),(0,p.createCommentVNode)(' 图例项列表 '),i.value.enabled?((0,p.openBlock)(),(0,p.createElementBlock)('div',zy,[(0,p.createElementVNode)('div',Iy,[a[33]||(a[33]=(0,p.createElementVNode)('span',null,'图例项',-1)),(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-small',onClick:(0,p.withModifiers)(x,['stop'])},[...a[32]||(a[32]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1),(0,p.createTextVNode)(' 添加 ',-1)])])]),(0,p.createElementVNode)('div',_y,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(i.value.items,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-legend-item-row'},[(0,p.createCommentVNode)(' 编辑模式 '),c.value===e.id?((0,p.openBlock)(),(0,p.createElementBlock)('div',Uy,[(0,p.createElementVNode)('div',My,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[8]||(a[8]=e=>s.label=e),type:'text',placeholder:'名称',class:'acu-legend-input'},null,512),[[p.vModelText,s.label]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[9]||(a[9]=e=>s.color=e),type:'color',class:'acu-legend-color-input',title:'颜色'},null,512),[[p.vModelText,s.color]]),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[10]||(a[10]=e=>s.emoji=e),type:'text',placeholder:'Emoji',class:'acu-legend-emoji-input',maxlength:'4'},null,512),[[p.vModelText,s.emoji]])]),(0,p.createElementVNode)('div',Ly,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[11]||(a[11]=e=>s.keywordsStr=e),type:'text',placeholder:'关键词（逗号分隔）',class:'acu-legend-keywords-input'},null,512),[[p.vModelText,s.keywordsStr]])]),(0,p.createElementVNode)('div',$y,[(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-small acu-action-btn-primary',onClick:(0,p.withModifiers)(w,['stop'])},[...a[34]||(a[34]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-small',onClick:(0,p.withModifiers)(k,['stop'])},[...a[35]||(a[35]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 显示模式 '),(0,p.createElementVNode)('div',Py,[(0,p.createElementVNode)('span',{class:'acu-legend-color-dot',style:(0,p.normalizeStyle)({backgroundColor:e.color})},null,4),(0,p.createElementVNode)('span',Fy,(0,p.toDisplayString)(e.emoji||''),1),(0,p.createElementVNode)('span',jy,(0,p.toDisplayString)(e.label),1),(0,p.createElementVNode)('div',Ry,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.keywords.slice(0,3),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e,class:'acu-legend-keyword-tag'},(0,p.toDisplayString)(e),1))),128)),e.keywords.length>3?((0,p.openBlock)(),(0,p.createElementBlock)('span',Oy,' +'+(0,p.toDisplayString)(e.keywords.length-3),1)):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createElementVNode)('div',Hy,[(0,p.createElementVNode)('button',{class:'acu-legend-action-btn',title:'编辑',onClick:(0,p.withModifiers)(t=>y(e),['stop'])},[...a[36]||(a[36]=[(0,p.createElementVNode)('i',{class:'fas fa-edit'},null,-1)])],8,Wy),(0,p.createElementVNode)('button',{class:'acu-legend-action-btn acu-legend-action-btn-danger',title:'删除',onClick:(0,p.withModifiers)(t=>{return a=e.id,void n.removeLegendItem(a);var a},['stop'])},[...a[37]||(a[37]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1)])],8,Gy)])],64))]))),128)),0===i.value.items.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',Yy,[...a[38]||(a[38]=[(0,p.createElementVNode)('span',null,'暂无图例项，点击上方"添加"按钮创建',-1)])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 重置为默认图例 '),(0,p.createElementVNode)('div',Xy,[(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-secondary acu-action-btn-small',onClick:(0,p.withModifiers)(C,['stop'])},[...a[39]||(a[39]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 重置为默认图例 ',-1)])])])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 操作按钮 '),(0,p.createElementVNode)('div',Ky,[(0,p.createElementVNode)('div',qy,[(0,p.createElementVNode)('div',Jy,[(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-secondary',onClick:(0,p.withModifiers)(b,['stop'])},[...a[41]||(a[41]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 恢复默认 ',-1)])])])])])])])])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}}),Qy=Zy,ew={class:'acu-modal acu-node-config-modal'},tw={class:'acu-modal-header'},aw={class:'acu-modal-title'},ow={class:'acu-modal-body'},nw={class:'acu-settings-section'},rw={class:'acu-settings-group'},lw={class:'acu-char-selector'},iw=['onClick'],cw={class:'acu-node-preview'},sw={class:'acu-node-config-actions'},uw={class:'acu-settings-section'},dw={class:'acu-settings-group'},pw={class:'acu-settings-row'},mw={class:'acu-settings-label'},fw={class:'hint'},gw={class:'acu-settings-control'},vw={class:'acu-settings-row'},bw={class:'acu-settings-control'},hw={class:'acu-settings-row'},xw={class:'acu-settings-label'},yw={class:'hint'},ww={class:'acu-settings-control'},kw={class:'acu-settings-row'},Cw={class:'acu-settings-control'},Nw={class:'acu-settings-section'},Vw={class:'acu-settings-group'},Ew={class:'acu-settings-row acu-action-row'},Bw=(0,p.defineComponent)({__name:'NodeConfigDialog',props:{visible:{type:Boolean,default:!1},nodeId:{default:''},fullName:{default:''},currentLabel:{default:''},selectedIndices:{default:()=>[]}},emits:['close','confirm','reset-to-full-name','style-update'],setup(e,{emit:t}){const a=e,o=t,n=Ho(),r=(0,p.ref)(new Set);function l(){try{const e=(window.parent?.document||document).querySelector('.acu-wrapper');if(e){const t=getComputedStyle(e).getPropertyValue('--acu-text-main').trim();if(t)return t}return'#333333'}catch{return'#333333'}}const i=(0,p.reactive)({size:$o??60,borderColor:l(),borderWidth:Po??2,shape:Fo??'ellipse'});function c(){const e=n.getNodeStyleOverride(a.nodeId),t=l();e?(i.size=e.size??$o??60,i.borderColor=e.borderColor??t,i.borderWidth=e.borderWidth??Po??2,i.shape=e.shape??Fo??'ellipse'):(i.size=$o??60,i.borderColor=t,i.borderWidth=Po??2,i.shape=Fo??'ellipse')}function s(e){return/^[A-Za-z\s'-]+$/.test(e)&&e.includes(' ')}function u(e){return s(e)?e.split(' ').filter(Boolean):e.split('')}(0,p.watch)(()=>a.selectedIndices,e=>{r.value=new Set(e)},{immediate:!0}),(0,p.watch)(()=>a.visible,e=>{e&&(a.selectedIndices.length>0?r.value=new Set(a.selectedIndices):r.value=new Set(function(e){const t=u(e);if(s(e))return[0];return t.length>0?[t.length-1]:[]}(a.fullName)),c())}),(0,p.watch)(()=>a.nodeId,e=>{e&&a.visible&&c()});const d=(0,p.computed)(()=>u(a.fullName)),m=(0,p.computed)(()=>{if(!a.fullName)return'';const e=d.value,t=Array.from(r.value).sort((e,t)=>e-t).map(t=>e[t]).filter(Boolean);return 0===t.length?function(e){if(s(e)){const t=e.split(' ')[0];return t.length>6?t.slice(0,6):t}return e.length>0?e[e.length-1]:e}(a.fullName):s(a.fullName)?t.join(' '):t.join('')});function f(){const e=Array.from(r.value);o('confirm',a.nodeId,m.value,e),o('close')}function g(){o('reset-to-full-name',a.nodeId,a.fullName)}function v(){n.removeNodeStyleOverride(a.nodeId),i.size=$o??60,i.borderColor=l(),i.borderWidth=Po??2,i.shape=Fo??'ellipse',o('style-update',a.nodeId)}return(0,p.watchEffect)(()=>{a.visible&&a.nodeId&&(n.setNodeStyleOverride(a.nodeId,{size:i.size,borderColor:i.borderColor,borderWidth:i.borderWidth,shape:i.shape}),o('style-update',a.nodeId))}),(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',onClick:(0,p.withModifiers)(f,['self'])},[(0,p.createElementVNode)('div',ew,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',tw,[(0,p.createElementVNode)('span',aw,'节点配置 - '+(0,p.toDisplayString)(e.fullName),1),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(f,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',ow,[(0,p.createCommentVNode)(' 显示名称设置 '),(0,p.createElementVNode)('div',nw,[a[5]||(a[5]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-font'}),(0,p.createTextVNode)(' 显示名称 ')],-1)),(0,p.createElementVNode)('div',rw,[a[4]||(a[4]=(0,p.createElementVNode)('p',{class:'acu-node-hint'},'点击选择要显示的字符（可多选）',-1)),(0,p.createElementVNode)('div',lw,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(d.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:t,class:(0,p.normalizeClass)(['acu-char-btn',{active:r.value.has(t)}]),onClick:(0,p.withModifiers)(e=>function(e){const t=new Set(r.value);t.has(e)?t.delete(e):t.add(e),r.value=t}(t),['stop'])},(0,p.toDisplayString)(e),11,iw))),128))]),(0,p.createElementVNode)('p',cw,'预览：'+(0,p.toDisplayString)(m.value),1),(0,p.createElementVNode)('div',sw,[(0,p.createElementVNode)('button',{class:'acu-action-btn secondary',onClick:(0,p.withModifiers)(g,['stop'])},'显示全名')])])]),(0,p.createCommentVNode)(' 样式设置 '),(0,p.createElementVNode)('div',uw,[a[11]||(a[11]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-palette'}),(0,p.createTextVNode)(' 节点样式 ')],-1)),(0,p.createElementVNode)('div',dw,[(0,p.createCommentVNode)(' 节点大小 '),(0,p.createElementVNode)('div',pw,[(0,p.createElementVNode)('div',mw,[a[6]||(a[6]=(0,p.createTextVNode)(' 节点大小 ',-1)),(0,p.createElementVNode)('span',fw,(0,p.toDisplayString)(i.size)+'px',1)]),(0,p.createElementVNode)('div',gw,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[0]||(a[0]=e=>i.size=e),type:'range',min:'30',max:'120',step:'5'},null,512),[[p.vModelText,i.size,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 边框颜色 '),(0,p.createElementVNode)('div',vw,[a[7]||(a[7]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 边框颜色 '),(0,p.createElementVNode)('span',{class:'hint'},'头像边框色')],-1)),(0,p.createElementVNode)('div',bw,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[1]||(a[1]=e=>i.borderColor=e),type:'color',class:'acu-dashed',title:'边框颜色'},null,512),[[p.vModelText,i.borderColor]])])]),(0,p.createCommentVNode)(' 边框宽度 '),(0,p.createElementVNode)('div',hw,[(0,p.createElementVNode)('div',xw,[a[8]||(a[8]=(0,p.createTextVNode)(' 边框宽度 ',-1)),(0,p.createElementVNode)('span',yw,(0,p.toDisplayString)(i.borderWidth)+'px',1)]),(0,p.createElementVNode)('div',ww,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>i.borderWidth=e),type:'range',min:'0',max:'10',step:'0.5'},null,512),[[p.vModelText,i.borderWidth,void 0,{number:!0}]])])]),(0,p.createCommentVNode)(' 节点形状 '),(0,p.createElementVNode)('div',kw,[a[10]||(a[10]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 头像形状 '),(0,p.createElementVNode)('span',{class:'hint'},'圆角样式')],-1)),(0,p.createElementVNode)('div',Cw,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[3]||(a[3]=e=>i.shape=e)},[...a[9]||(a[9]=[(0,p.createElementVNode)('option',{value:'ellipse'},'圆形',-1),(0,p.createElementVNode)('option',{value:'round-rectangle'},'圆角矩形',-1),(0,p.createElementVNode)('option',{value:'rectangle'},'矩形',-1),(0,p.createElementVNode)('option',{value:'hexagon'},'六边形',-1)])],512),[[p.vModelSelect,i.shape]])])])])]),(0,p.createCommentVNode)(' 操作按钮 '),(0,p.createElementVNode)('div',Nw,[(0,p.createElementVNode)('div',Vw,[(0,p.createElementVNode)('div',Ew,[(0,p.createElementVNode)('button',{class:'acu-action-btn acu-action-btn-secondary',onClick:(0,p.withModifiers)(v,['stop'])},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1),(0,p.createTextVNode)(' 重置样式 ',-1)])])])])])])])])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}});d(717);const Sw=Bw,Tw={class:'acu-modal acu-node-config-modal'},Dw={class:'acu-modal-header'},Aw={class:'acu-modal-body'},zw={class:'acu-node-fullname',style:{'margin-bottom':'8px','font-weight':'600'}},Iw={class:'acu-char-selector'},_w=['onClick'],Uw={class:'acu-node-preview'},Mw={class:'acu-node-config-actions'},Lw=(0,p.defineComponent)({__name:'NodeLabelDialog',props:{visible:{type:Boolean,default:!1},fullName:{default:''},initialIndices:{default:()=>[]}},emits:['close','apply','reset'],setup(e,{expose:t,emit:a}){const o=e,n=a,r=(0,p.ref)(new Set);function l(e){return/^[A-Za-z\s'-]+$/.test(e)&&e.includes(' ')}function i(e){return e?l(e)?e.split(' ').filter(Boolean):e.split(''):[]}function c(e){const t=i(e);return l(e)?[0]:t.length>0?[t.length-1]:[]}function s(e){if(l(e)){const t=e.split(' ')[0];return t.length>6?t.slice(0,6):t}return e.length>0?e[e.length-1]:e}const u=(0,p.computed)(()=>i(o.fullName)),d=(0,p.computed)(()=>{if(!o.fullName)return'';const e=u.value,t=Array.from(r.value).sort((e,t)=>e-t).map(t=>e[t]).filter(Boolean);return 0===t.length?s(o.fullName):l(o.fullName)?t.join(' '):t.join('')});function m(){n('apply',{displayLabel:d.value,selectedIndices:Array.from(r.value)}),n('close')}function f(){n('reset'),n('close')}function g(){n('close')}return(0,p.watch)(()=>[o.visible,o.fullName,o.initialIndices],([e])=>{e&&(o.initialIndices&&o.initialIndices.length>0?r.value=new Set(o.initialIndices):r.value=new Set(c(o.fullName)))},{immediate:!0}),t({isEnglishName:l,getDisplayChars:i,getDefaultIndices:c,getDefaultLabel:s}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container',style:{'z-index':'2147483647'},onClick:(0,p.withModifiers)(g,['self'])},[(0,p.createElementVNode)('div',Tw,[(0,p.createElementVNode)('div',Dw,[a[0]||(a[0]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},'选择显示的字符',-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(g,['stop'])},'取消')]),(0,p.createElementVNode)('div',Aw,[(0,p.createElementVNode)('p',zw,'全名：'+(0,p.toDisplayString)(e.fullName),1),a[1]||(a[1]=(0,p.createElementVNode)('p',{class:'acu-node-hint'},'点击选择要显示的字符（可多选）',-1)),(0,p.createElementVNode)('div',Iw,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(u.value,(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:t,class:(0,p.normalizeClass)(['acu-char-btn',{active:r.value.has(t)}]),onClick:(0,p.withModifiers)(e=>function(e){const t=new Set(r.value);t.has(e)?t.delete(e):t.add(e),r.value=t}(t),['stop'])},(0,p.toDisplayString)(e),11,_w))),128))]),(0,p.createElementVNode)('p',Uw,'预览：'+(0,p.toDisplayString)(d.value),1),(0,p.createElementVNode)('div',Mw,[(0,p.createElementVNode)('button',{class:'acu-action-btn secondary',onClick:(0,p.withModifiers)(f,['stop'])},'显示全名'),(0,p.createElementVNode)('button',{class:'acu-action-btn primary',onClick:(0,p.withModifiers)(m,['stop'])},'确定')])])])])):(0,p.createCommentVNode)('v-if',!0)}}),$w=Lw,Pw={class:'acu-modal acu-row-edit-modal'},Fw={class:'acu-modal-header'},jw={class:'acu-modal-title'},Rw={class:'acu-modal-body'},Ow={class:'acu-row-edit-content'},Hw=(0,p.defineComponent)({__name:'RowEditDialog',props:{visible:{type:Boolean,default:!1},tableName:{},tableId:{},rowIndex:{},currentRowData:{default:null},titleColIndex:{default:1}},emits:['update:visible','close','showHistory'],setup(e,{emit:t}){const a=e,o=Ve(),n=(0,p.computed)(()=>`acu-theme-${o.theme}`),r=t,l=(0,p.computed)(()=>{if(!a.currentRowData)return a.tableName;const e=a.titleColIndex;if(e>=0&&a.currentRowData.cells.length>e){const t=a.currentRowData.cells[e]?.value;if(t)return`${a.tableName} - ${t}`}return`${a.tableName} - 第 ${a.rowIndex+1} 行`});function i(){r('update:visible',!1),r('close')}function c(){i()}function s(){r('showHistory')}return(0,p.watch)(()=>a.visible,e=>{}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:(0,p.normalizeClass)(['acu-modal-container acu-row-edit-modal-container',n.value]),onClick:(0,p.withModifiers)(i,['self'])},[(0,p.createElementVNode)('div',Pw,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Fw,[(0,p.createCommentVNode)(' 移动端拖动把手 '),a[1]||(a[1]=(0,p.createElementVNode)('div',{class:'acu-drag-handle acu-mobile-only'},null,-1)),(0,p.createElementVNode)('span',jw,[a[0]||(a[0]=(0,p.createElementVNode)('i',{class:'fas fa-edit'},null,-1)),(0,p.createTextVNode)(' 编辑 - '+(0,p.toDisplayString)(l.value),1)]),(0,p.createCommentVNode)(' PC端在头部显示完成按钮 '),(0,p.createElementVNode)('button',{class:'acu-close-pill acu-pc-only',onClick:(0,p.withModifiers)(c,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',Rw,[(0,p.createElementVNode)('div',Ow,[(0,p.createCommentVNode)(' 使用 DataCard 展示和编辑行数据 '),e.currentRowData?((0,p.openBlock)(),(0,p.createBlock)(Hn,{key:0,data:e.currentRowData,'table-name':e.tableName,'table-id':e.tableId,'view-mode':'list','show-header':!0,'show-index':!0,'show-history-button':!0,'title-col-index':e.titleColIndex,onShowHistory:s},null,8,['data','table-name','table-id','title-col-index'])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 底部留白适配移动端安全区 '),a[2]||(a[2]=(0,p.createElementVNode)('div',{class:'acu-bottom-spacer'},null,-1))])],2)):(0,p.createCommentVNode)('v-if',!0)}}),Ww={class:'acu-modal acu-widget-actions-modal'},Gw={class:'acu-modal-header'},Yw={class:'acu-modal-body'},Xw={class:'acu-settings-section'},Kw={class:'acu-settings-group'},qw={class:'acu-settings-label'},Jw={class:'hint'},Zw={class:'acu-settings-control'},Qw={class:'acu-switch'},ek=['checked','onChange'],tk={class:'acu-settings-section'},ak={class:'acu-settings-title'},ok={class:'acu-settings-group'},nk={key:0,class:'acu-empty-hint'},rk={key:1,class:'acu-selected-actions-list'},lk={class:'acu-settings-label'},ik={class:'acu-settings-control'},ck=['onClick'],sk=(0,p.defineComponent)({__name:'WidgetActionsDialog',props:{visible:{type:Boolean},widgetId:{},currentActions:{default:()=>[]}},emits:['update:visible','close'],setup(e,{emit:t}){const a=e,o=t,n=Uo(),r=(0,p.ref)([]),l=(0,p.computed)(()=>Object.values($e).filter(e=>'settings'!==e.id&&'goToTable'!==e.id));function i(e){return $e[e]?.icon||'fa-question'}function c(e){return $e[e]?.label||e}function s(){a.widgetId&&n.updateWidget(a.widgetId,{actions:r.value}),o('update:visible',!1),o('close')}return(0,p.watch)(()=>a.visible,e=>{e&&(r.value=a.currentActions.filter(e=>'settings'!==e&&'goToTable'!==e))},{immediate:!0}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(s,['self'])},[(0,p.createElementVNode)('div',Ww,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',Gw,[a[0]||(a[0]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-plus'}),(0,p.createTextVNode)(' 配置快捷按钮 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(s,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',Yw,[(0,p.createElementVNode)('div',Xw,[a[2]||(a[2]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-bolt'}),(0,p.createTextVNode)(' 可用的快捷按钮 ')],-1)),(0,p.createElementVNode)('div',Kw,[(0,p.createCommentVNode)(' 按钮选择列表 - 使用标准设置行布局 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(l.value,e=>{return(0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'acu-settings-row'},[(0,p.createElementVNode)('div',qw,[(0,p.createElementVNode)('span',null,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',e.icon]),style:{'margin-right':'8px',color:'var(--acu-title-color)'}},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(e.label),1)]),(0,p.createElementVNode)('span',Jw,(0,p.toDisplayString)(e.tooltip),1)]),(0,p.createElementVNode)('div',Zw,[(0,p.createCommentVNode)(' 使用标准 acu-switch 开关 '),(0,p.createElementVNode)('label',Qw,[(0,p.createElementVNode)('input',{type:'checkbox',checked:(t=e.id,r.value.includes(t)),onChange:t=>function(e){const t=r.value.indexOf(e);t>-1?r.value.splice(t,1):r.value.push(e)}(e.id)},null,40,ek),a[1]||(a[1]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])]);var t}),128))])]),(0,p.createCommentVNode)(' 已选按钮预览 '),(0,p.createElementVNode)('div',tk,[(0,p.createElementVNode)('div',ak,[a[3]||(a[3]=(0,p.createElementVNode)('i',{class:'fas fa-eye'},null,-1)),(0,p.createTextVNode)(' 已选按钮 ('+(0,p.toDisplayString)(r.value.length)+') ',1)]),(0,p.createElementVNode)('div',ok,[0===r.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',nk,'暂未选择任何快捷按钮')):((0,p.openBlock)(),(0,p.createElementBlock)('div',rk,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e,class:'acu-settings-row'},[(0,p.createElementVNode)('div',lk,[(0,p.createElementVNode)('span',null,[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',i(e)]),style:{'margin-right':'8px',color:'var(--acu-title-color)'}},null,2),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(c(e)),1)])]),(0,p.createElementVNode)('div',ik,[(0,p.createElementVNode)('button',{class:'acu-tool-btn acu-btn-danger',title:'移除',onClick:(0,p.withModifiers)(t=>function(e){const t=r.value.indexOf(e);t>-1&&r.value.splice(t,1)}(e),['stop'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])],8,ck)])]))),128))]))])])])])])):(0,p.createCommentVNode)('v-if',!0)}}),uk={ref:'dialogRef',class:'acu-modal acu-widget-settings-modal'},dk={class:'acu-modal-header'},pk={class:'acu-modal-body'},mk={class:'acu-settings-section'},fk={class:'acu-settings-group'},gk={class:'acu-settings-row'},vk={class:'acu-settings-control'},bk=['value'],hk={class:'acu-settings-section'},xk={class:'acu-settings-group'},yk={class:'acu-settings-row'},wk={class:'acu-settings-control'},kk=['value'],Ck={class:'acu-settings-section'},Nk={class:'acu-settings-group'},Vk={class:'acu-settings-row'},Ek={class:'acu-settings-control'},Bk=['value'],Sk={key:0,class:'acu-selected-tags'},Tk=['onClick'],Dk={class:'acu-settings-section'},Ak={class:'acu-settings-group'},zk={class:'acu-settings-label'},Ik={key:0,class:'hint'},_k={key:1,class:'hint'},Uk={class:'acu-settings-row'},Mk={class:'acu-settings-control'},Lk=(0,p.defineComponent)({__name:'WidgetSettingsDialog',props:{visible:{type:Boolean},widgetId:{},widgetConfig:{default:null},tableHeaders:{default:()=>[]}},emits:['update:visible','close'],setup(e,{emit:t}){const a=e,o=t,n=Ve(),r=Uo(),l=Ea(),i=(0,p.computed)(()=>f.widgetTagConfig?.displayedTagIds?.length||0),c=(0,p.computed)(()=>f.widgetTagConfig?.displayedCategoryIds?.length||0);function s(){l.openTagManagerDialog({widgetId:a.widgetId,displayedTagIds:f.widgetTagConfig?.displayedTagIds||[],displayedCategoryIds:f.widgetTagConfig?.displayedCategoryIds||[]},(e,t)=>{f.widgetTagConfig={displayedTagIds:e,displayedCategoryIds:t}})}const u=(0,p.ref)(''),d=(0,p.computed)(()=>a.tableHeaders.filter(e=>!f.displayTagColumns.includes(e)));function m(){u.value&&(f.displayTagColumns.push(u.value),u.value='')}const f=(0,p.reactive)({titleColumn:'',displayTagColumns:[],widgetTagConfig:{displayedTagIds:[],displayedCategoryIds:[]},displayStyle:'list'});function g(){o('update:visible',!1),o('close')}return(0,p.watch)(()=>a.visible,e=>{e&&(a.widgetConfig?(f.titleColumn=a.widgetConfig.titleColumn||'',f.displayTagColumns=[...a.widgetConfig.displayTagColumns||[]],f.displayStyle=a.widgetConfig.displayStyle||'list',f.widgetTagConfig={displayedTagIds:[...a.widgetConfig.widgetTagConfig?.displayedTagIds||[]],displayedCategoryIds:[...a.widgetConfig.widgetTagConfig?.displayedCategoryIds||[]]}):(f.titleColumn='',f.displayTagColumns=[],f.displayStyle='list',f.widgetTagConfig={displayedTagIds:[],displayedCategoryIds:[]}))},{immediate:!0}),(0,p.watch)(f,()=>{a.visible&&a.widgetId&&function(){if(!a.widgetId)return;const e=(f.widgetTagConfig.displayedTagIds?.length||0)>0||(f.widgetTagConfig.displayedCategoryIds?.length||0)>0;r.updateWidget(a.widgetId,{titleColumn:f.titleColumn||void 0,displayTagColumns:f.displayTagColumns.length>0?f.displayTagColumns:void 0,widgetTagConfig:e?f.widgetTagConfig:void 0,displayStyle:f.displayStyle})}()},{deep:!0}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(g,['self'])},[(0,p.createElementVNode)('div',uk,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',dk,[a[4]||(a[4]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-cog'}),(0,p.createTextVNode)(' 组件设置 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(g,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',pk,[(0,p.createCommentVNode)(' 显示风格配置 '),(0,p.createElementVNode)('div',mk,[a[6]||(a[6]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-paint-brush'}),(0,p.createTextVNode)(' 显示风格 ')],-1)),(0,p.createElementVNode)('div',fk,[(0,p.createElementVNode)('div',gk,[a[5]||(a[5]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 组件模板 '),(0,p.createElementVNode)('span',{class:'hint'},'选择组件的展示方式')],-1)),(0,p.createElementVNode)('div',vk,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[0]||(a[0]=e=>f.displayStyle=e),class:'acu-select'},[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)((0,p.unref)(Le),e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e.value,value:e.value},(0,p.toDisplayString)(e.label),9,bk))),128))],512),[[p.vModelSelect,f.displayStyle]])])])])]),(0,p.createCommentVNode)(' 行标题配置 '),(0,p.createElementVNode)('div',hk,[a[9]||(a[9]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-heading'}),(0,p.createTextVNode)(' 行标题列 ')],-1)),(0,p.createElementVNode)('div',xk,[(0,p.createElementVNode)('div',yk,[a[8]||(a[8]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 标题来源列 '),(0,p.createElementVNode)('span',{class:'hint'},'每行显示的主标题取自哪一列')],-1)),(0,p.createElementVNode)('div',wk,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[1]||(a[1]=e=>f.titleColumn=e),class:'acu-select'},[a[7]||(a[7]=(0,p.createElementVNode)('option',{value:''},'默认（第一列）',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(e.tableHeaders,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,kk))),128))],512),[[p.vModelSelect,f.titleColumn]])])])])]),(0,p.createCommentVNode)(' 展示标签配置 '),(0,p.createElementVNode)('div',Ck,[a[13]||(a[13]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-tags'}),(0,p.createTextVNode)(' 展示标签 ')],-1)),(0,p.createElementVNode)('div',Nk,[(0,p.createElementVNode)('div',Vk,[a[11]||(a[11]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 标签来源列 '),(0,p.createElementVNode)('span',{class:'hint'},'选中的列值将作为徽章显示在行上（纯展示）')],-1)),(0,p.createElementVNode)('div',Ek,[(0,p.withDirectives)((0,p.createElementVNode)('select',{'onUpdate:modelValue':a[2]||(a[2]=e=>u.value=e),class:'acu-select',onChange:m},[a[10]||(a[10]=(0,p.createElementVNode)('option',{value:''},'选择要添加的列...',-1)),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(d.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('option',{key:e,value:e},(0,p.toDisplayString)(e),9,Bk))),128))],544),[[p.vModelSelect,u.value]])])]),(0,p.createCommentVNode)(' 已选择的列标签 '),f.displayTagColumns.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',Sk,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(f.displayTagColumns,e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e,class:'acu-selected-tag'},[(0,p.createTextVNode)((0,p.toDisplayString)(e)+' ',1),(0,p.createElementVNode)('button',{class:'acu-tag-remove',onClick:(0,p.withModifiers)(t=>function(e){const t=f.displayTagColumns.indexOf(e);t>-1&&f.displayTagColumns.splice(t,1)}(e),['stop'])},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])],8,Tk)]))),128))])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 互动标签配置入口 '),(0,p.createElementVNode)('div',Dk,[a[17]||(a[17]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-bolt'}),(0,p.createTextVNode)(' 互动标签 ')],-1)),(0,p.createElementVNode)('div',Ak,[(0,p.createCommentVNode)(' 导航行：点击打开标签管理器（含已配置预览） '),(0,p.createElementVNode)('div',{class:'acu-settings-row acu-nav-row',onClick:(0,p.withModifiers)(s,['stop'])},[(0,p.createElementVNode)('div',zk,[a[14]||(a[14]=(0,p.createTextVNode)(' 管理互动标签 ',-1)),i.value>0||c.value>0?((0,p.openBlock)(),(0,p.createElementBlock)('span',Ik,' 已配置 '+(0,p.toDisplayString)(i.value)+' 个标签，'+(0,p.toDisplayString)(c.value)+' 个分类 ',1)):((0,p.openBlock)(),(0,p.createElementBlock)('span',_k,'点击配置可点击的互动标签'))]),a[15]||(a[15]=(0,p.createElementVNode)('div',{class:'acu-settings-control'},[(0,p.createElementVNode)('i',{class:'fas fa-chevron-right'})],-1))]),(0,p.createCommentVNode)(' 自动存入互动标签 (全局设置) '),(0,p.createElementVNode)('div',Uk,[a[16]||(a[16]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 自动存入互动标签 '),(0,p.createElementVNode)('span',{class:'hint'},'AI 生成交互表格后自动存入标签库 (全局生效)')],-1)),(0,p.createElementVNode)('div',Mk,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-switch',{active:(0,p.unref)(n).config.autoImportInteractions}]),onClick:a[3]||(a[3]=e=>(0,p.unref)(n).config.autoImportInteractions=!(0,p.unref)(n).config.autoImportInteractions)},null,2)])])])])])],512)])):(0,p.createCommentVNode)('v-if',!0)}}),$k={class:'tarot-card__inner'},Pk={class:'tarot-card__face tarot-card__back'},Fk={class:'tarot-card__face tarot-card__front'},jk=(0,p.defineComponent)({__name:'TarotCard',props:{themeId:{default:'wafuku'},isFlipped:{type:Boolean},result:{},cardBackImage:{default:''},peepMode:{type:Boolean,default:!1}},emits:['flip','confirm'],setup(e,{emit:t}){const a=e,o=t,n=(0,p.computed)(()=>{return e=a.themeId,Qg[e]||Qg.wafuku;var e}),r=(0,p.computed)(()=>a.cardBackImage||n.value.defaultBackImage||''),l=(0,p.ref)(220/385),i=(0,p.computed)(()=>({aspectRatio:`${l.value}`}));function c(e){const t=Math.max(.5,Math.min(1,e));l.value=t}const s=(0,p.computed)(()=>a.result?{luckName:a.result.luck.name,luckColor:a.result.luck.color,dimensions:a.result.dimensions.map(e=>e.value),words:a.result.words,peepMode:a.peepMode}:null);function u(){a.isFlipped?o('confirm'):o('flip')}return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['tarot-card',[`tarot-card--theme-${e.themeId}`,{'tarot-card--flipped':e.isFlipped}]]),style:(0,p.normalizeStyle)(i.value),onClick:(0,p.withModifiers)(u,['stop'])},[(0,p.createElementVNode)('div',$k,[(0,p.createCommentVNode)(' 卡背（初始显示） '),(0,p.createElementVNode)('div',Pk,[((0,p.openBlock)(),(0,p.createBlock)((0,p.resolveDynamicComponent)(n.value.CardBack),{'image-url':r.value,onLoad:c},null,40,['image-url']))]),(0,p.createCommentVNode)(' 卡面（翻转后显示） '),(0,p.createElementVNode)('div',Fk,[s.value?((0,p.openBlock)(),(0,p.createBlock)((0,p.resolveDynamicComponent)(n.value.CardFront),{key:0,'luck-name':s.value.luckName,'luck-color':s.value.luckColor,dimensions:s.value.dimensions,words:s.value.words,'peep-mode':s.value.peepMode},null,8,['luck-name','luck-color','dimensions','words','peep-mode'])):(0,p.createCommentVNode)('v-if',!0)])])],6))}}),Rk={class:'divination-starfield'},Ok={class:'divination-content'},Hk={class:'divination-stage'},Wk={key:0,class:'divination-hint'},Gk={class:'divination-footer'},Yk=(0,p.defineComponent)({__name:'DivinationOverlay',props:{visible:{type:Boolean},result:{}},emits:['close','confirm','retry'],setup(e,{emit:t}){const a=e,o=t,n=ua(),r=Ve(),l=window.parent.document.body,i=(0,p.ref)(!1),c=(0,p.computed)(()=>Array.from({length:50}).map((_,e)=>({id:e,left:100*Math.random()+'%',top:100*Math.random()+'%',size:2*Math.random()+1,delay:5*Math.random(),duration:3*Math.random()+2})));function s(){o('close')}function u(){i.value&&m(n.config.peepMode?'hide':'reveal')}function d(){i.value=!0}function m(e){o('confirm',e)}function f(){o('retry')}return(0,p.watch)(()=>a.visible,e=>{e&&('auto'===n.config.flipMode?(i.value=!1,setTimeout(()=>{i.value=!0},500)):i.value=!1)}),(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Teleport,{to:(0,p.unref)(l)},[(0,p.createVNode)(p.Transition,{'enter-active-class':'divination-overlay-enter-active','leave-active-class':'divination-overlay-leave-active'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'divination-overlay',style:(0,p.normalizeStyle)({zIndex:2147483647,paddingBottom:`${(0,p.unref)(r).config.mobileSafeAreaBottom??50}px`}),onClick:u},[(0,p.createCommentVNode)(' 噪点纹理层 '),a[4]||(a[4]=(0,p.createElementVNode)('div',{class:'divination-grain'},null,-1)),(0,p.createCommentVNode)(' 动态星空 '),(0,p.createElementVNode)('div',Rk,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(c.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:'divination-star',style:(0,p.normalizeStyle)({left:e.left,top:e.top,width:`${e.size}px`,height:`${e.size}px`,'--duration':`${e.duration}s`,'--delay':`${e.delay}s`})},null,4))),128))]),(0,p.createCommentVNode)(' 流动星云 '),a[5]||(a[5]=(0,p.createElementVNode)('div',{class:'divination-nebula divination-nebula--purple'},null,-1)),a[6]||(a[6]=(0,p.createElementVNode)('div',{class:'divination-nebula divination-nebula--golden'},null,-1)),(0,p.createCommentVNode)(' 中心光晕 '),a[7]||(a[7]=(0,p.createElementVNode)('div',{class:'divination-central-glow'},null,-1)),(0,p.createCommentVNode)(' 神圣几何背景 '),a[8]||(a[8]=(0,p.createElementVNode)('div',{class:'divination-geometry divination-geometry--outer'},[(0,p.createElementVNode)('svg',{viewBox:'0 0 100 100',fill:'none',stroke:'#D4AF37','stroke-width':'0.05'},[(0,p.createElementVNode)('circle',{cx:'50',cy:'50',r:'48'}),(0,p.createElementVNode)('path',{d:'M50 0 L93 75 L6 75 Z',opacity:'0.5'}),(0,p.createElementVNode)('path',{d:'M50 100 L93 25 L6 25 Z',opacity:'0.5'})])],-1)),a[9]||(a[9]=(0,p.createElementVNode)('div',{class:'divination-geometry divination-geometry--inner'},[(0,p.createElementVNode)('svg',{viewBox:'0 0 100 100',fill:'none',stroke:'#C6A664','stroke-width':'0.1'},[(0,p.createElementVNode)('circle',{cx:'50',cy:'50',r:'45','stroke-dasharray':'2 1'}),(0,p.createElementVNode)('circle',{cx:'50',cy:'50',r:'30'}),(0,p.createElementVNode)('rect',{x:'29',y:'29',width:'42',height:'42',transform:'rotate(45 50 50)'}),(0,p.createElementVNode)('rect',{x:'29',y:'29',width:'42',height:'42',transform:'rotate(0 50 50)'})])],-1)),(0,p.createCommentVNode)(' 装饰边框 '),a[10]||(a[10]=(0,p.createElementVNode)('div',{class:'divination-frame'},[(0,p.createElementVNode)('div',{class:'divination-frame__corner divination-frame__corner--tl'}),(0,p.createElementVNode)('div',{class:'divination-frame__corner divination-frame__corner--tr'}),(0,p.createElementVNode)('div',{class:'divination-frame__corner divination-frame__corner--bl'}),(0,p.createElementVNode)('div',{class:'divination-frame__corner divination-frame__corner--br'}),(0,p.createElementVNode)('div',{class:'divination-frame__top-line'}),(0,p.createElementVNode)('div',{class:'divination-frame__bottom-line'})],-1)),(0,p.createCommentVNode)(' 关闭按钮 '),(0,p.createElementVNode)('button',{class:'divination-close',onClick:(0,p.withModifiers)(s,['stop'])},[...a[1]||(a[1]=[(0,p.createElementVNode)('svg',{xmlns:'http://www.w3.org/2000/svg',width:'20',height:'20',viewBox:'0 0 24 24',fill:'none',stroke:'currentColor','stroke-width':'2','stroke-linecap':'round','stroke-linejoin':'round'},[(0,p.createElementVNode)('path',{d:'M18 6 6 18'}),(0,p.createElementVNode)('path',{d:'m6 6 12 12'})],-1)])]),(0,p.createCommentVNode)(' 内容区域 '),(0,p.createElementVNode)('div',Ok,[(0,p.createCommentVNode)(' 顶部装饰（移除文字，保留装饰元素） '),a[3]||(a[3]=(0,p.createElementVNode)('div',{class:'divination-header'},[(0,p.createElementVNode)('div',{class:'divination-header__title'},[(0,p.createElementVNode)('span',{class:'divination-header__sparkle divination-header__sparkle--static'},[(0,p.createElementVNode)('svg',{xmlns:'http://www.w3.org/2000/svg',width:'32',height:'32',viewBox:'0 0 24 24',fill:'none',stroke:'currentColor','stroke-width':'1.5','stroke-linecap':'round','stroke-linejoin':'round'},[(0,p.createElementVNode)('path',{d:'M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z'})])]),(0,p.createElementVNode)('div',{class:'divination-header__divider'})])],-1)),(0,p.createCommentVNode)(' 卡片舞台 '),(0,p.createElementVNode)('div',Hk,[(0,p.createVNode)(jk,{'is-flipped':i.value,result:e.result,'card-back-image':(0,p.unref)(n).config.cardBackImage,'theme-id':(0,p.unref)(n).config.themeId,'peep-mode':(0,p.unref)(n).config.peepMode,onFlip:d,onConfirm:a[0]||(a[0]=e=>m((0,p.unref)(n).config.peepMode?'hide':'reveal'))},null,8,['is-flipped','result','card-back-image','theme-id','peep-mode']),(0,p.createCommentVNode)(' 翻牌前提示 '),i.value?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',Wk,[...a[2]||(a[2]=[(0,p.createElementVNode)('p',{class:'divination-hint__text'},'点击牌面 揭晓命运',-1)])]))]),(0,p.createCommentVNode)(' 底部控制区 '),(0,p.createElementVNode)('div',Gk,[i.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'divination-btn divination-btn--retry',onClick:(0,p.withModifiers)(f,['stop'])},' 再抽一次 ')):(0,p.createCommentVNode)('v-if',!0)])])],4)):(0,p.createCommentVNode)('v-if',!0)]),_:1})],8,['to']))}}),Xk={class:'acu-action-bar'},Kk=['title','onClick','onMousedown','onTouchstartPassive'],qk={key:0,class:'secondary-indicator'},Jk=['title','onClick'];Boolean,Boolean;d(590);const Zk={key:0,class:'acu-toast'},Qk={class:'acu-toast-message'},eC=(0,p.defineComponent)({__name:'Toast',props:{visible:{type:Boolean},message:{}},setup:e=>(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'toast'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',Zk,[a[0]||(a[0]=(0,p.createElementVNode)('i',{class:'fas fa-info-circle'},null,-1)),(0,p.createElementVNode)('span',Qk,(0,p.toDisplayString)(e.message),1)])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}),tC={class:'acu-relationship-graph'},aC={key:1,class:'acu-graph-legend'},oC={class:'label'},nC={class:'acu-graph-toolbar'},rC={key:2,class:'acu-graph-empty'},lC='acu_graph_config',iC=(0,p.defineComponent)({__name:'RelationshipGraph',props:{relationshipTable:{default:null},characterTables:{default:()=>[]},factionTable:{default:null},allTables:{default:()=>[]},showLegend:{type:Boolean,default:!0},initialLayout:{default:'fcose'}},emits:['node-click','edge-click'],setup(e,{expose:t,emit:a}){r.use(i),r.use(l),c(r);const o=Ve(),n=Ea(),s=Ho(),u=Xe(),d=xo(),m=(0,p.ref)(new Map),f=(0,p.ref)(new Map),g=(0,p.ref)(null),v=e,b=a,h=(0,p.ref)(null);let x=null;const y=(0,p.ref)(!1),w=(0,p.ref)(''),k=(0,p.ref)(null),C=(0,p.ref)(null),N=(0,p.ref)(new Set);const V=(0,p.ref)(B().lastLayout||v.initialLayout),E=(0,p.ref)(null);function B(){try{const e=getVariables({type:'chat'})[lC]||{};return e.positions&&!e.layoutPositions&&(console.info('[RelationshipGraph] 迁移旧格式位置数据到 fcose'),e.layoutPositions={fcose:e.positions},delete e.positions,S(e)),e}catch(e){return console.warn('[RelationshipGraph] 获取聊天变量失败:',e),{}}}function S(e){try{insertOrAssignVariables({[lC]:e},{type:'chat'})}catch(e){console.warn('[RelationshipGraph] 保存聊天变量失败:',e)}}function D(e){const t=e||V.value;return B().layoutPositions?.[t]}function A(e,t){try{const a=window.parent?.document||document,o=a.querySelector('.acu-wrapper');if(o){const t=getComputedStyle(o).getPropertyValue(e).trim();if(t)return t}return getComputedStyle(a.documentElement).getPropertyValue(e).trim()||t}catch{return t}}function I(){return{textMain:A('--acu-text-main','#333333'),textSub:A('--acu-text-sub','#666666'),cardBg:A('--acu-card-bg','#ffffff'),border:A('--acu-border','#e0e0e0'),titleColor:A('--acu-title-color','#d35400'),bgPanel:A('--acu-bg-panel','#e6e2d3'),btnBg:A('--acu-btn-bg','#dcd0c0'),highlight:A('--acu-highlight','#d35400'),fontFamily:A('--acu-font-family','Source Han Sans SC, sans-serif')}}async function U(){const e=I().fontFamily.split(',')[0].trim().replace(/['"]/g,'');if(e)try{const t=window.parent?.document||document;await t.fonts.load(`16px "${e}"`),console.info('[RelationshipGraph] 字体预加载完成:',e)}catch(t){console.warn('[RelationshipGraph] 字体预加载失败:',e,t)}}const M=(0,p.computed)(()=>function(){const e={S:'💗',A:'💙',B:'💚',C:'⚪',D:'🟡',E:'🔴','?':'🟣'};return[...Ke.map(t=>({level:t.level,name:t.name,color:t.color,emoji:e[t.level]})),{level:qe,name:Je,color:Ze,emoji:e['?']},{level:'dashed',name:'过往/隐藏',color:'#888888',emoji:'┄',isDashed:!0}]}()),L=(0,p.computed)(()=>{if(!s.config.showBackground)return{enabled:!1,style:{}};const e=u.backgroundConfig,t=g.value||e.externalUrl||'';if(!e.enabled||!t)return{enabled:!1,style:{}};const a=(e.scale||100)/100;return{enabled:!0,style:{backgroundImage:`url(${t})`,backgroundPosition:'center center',backgroundSize:'auto'===e.size?'100%':e.size,backgroundRepeat:'no-repeat',transform:`translate(${e.offsetX||0}%, ${e.offsetY||0}%) scale(${a})`,transformOrigin:'center center',opacity:e.opacity/100,filter:e.blur>0?`blur(${e.blur}px)`:'none',position:'absolute',top:'0',left:'0',width:'100%',height:'100%',zIndex:'0',pointerEvents:'none'}}}),P=(0,p.computed)(()=>{const e=s.getLegendConfig();if(e.enabled&&e.items?.length)return e.items.map(e=>({label:e.label,color:e.color,keywords:e.keywords}))}),F=(0,p.computed)(()=>{console.info('[RelationshipGraph] 解析数据 - props:',{relationshipTable:v.relationshipTable?.name,characterTablesCount:v.characterTables?.length,characterTablesNames:v.characterTables?.map(e=>e.name),factionTable:v.factionTable?.name,aliasMapSize:f.value.size,customLegendEnabled:!!P.value});const e=pt(v.relationshipTable,v.characterTables,v.factionTable,f.value,P.value);if(console.info('[RelationshipGraph] 专用关系表解析结果:',{nodeCount:e.nodeCount,edgeCount:e.edgeCount,warnings:e.warnings}),0===e.nodeCount&&v.characterTables&&v.characterTables.length>0){console.info('[RelationshipGraph] 无专用关系表，尝试从角色表内嵌字段解析');const e=function(e=[],t,a,o){const n=[],r=[];e.forEach(e=>{const t=e.name.toLowerCase();t.includes('主角')||t.includes('protagonist')?n.push(e):r.push(e)});const l=mt(n,{nameColKeywords:['姓名','name','名称','角色名'],relationColKeywords:['人际关系','关系','relationship','relations'],nodeType:'protagonist',aliasMap:a,customLegendItems:o}),i=mt(r,{nameColKeywords:['姓名','name','名称','角色名'],relationColKeywords:['人际关系','关系','relationship','relations'],nodeType:'character',aliasMap:a,customLegendItems:o}),c=new Map,s=[],u=[...l.warnings,...i.warnings],d=e=>{e.elements.forEach(e=>{if(e.data.source&&e.data.target){const t={...e};t.data.id=`edge-${s.length}`,s.push(t)}else{const t=e.data.id;c.has(t)||c.set(t,e)}})};d(l),d(i);const p=new Set(c.keys()),m=['所属','势力','阵营','组织','身份','职业','faction','affiliation','organization'];return e.forEach(e=>{const t=ct(e.headers,['姓名','name','名称','角色名']),a=ct(e.headers,m);-1!==t&&-1!==a&&e.rows.forEach(o=>{const n=lt(o,t),r=lt(o,a);if(n&&r&&!p.has(n)){const t=e.name.toLowerCase().includes('主角')?'protagonist':'character',a=dt(n);c.set(n,{data:{id:n,label:a,type:t},classes:t}),p.add(n)}})}),{elements:[...c.values(),...s],nodeCount:c.size,edgeCount:s.length,warnings:u}}(v.characterTables,v.factionTable,f.value,P.value);return console.info('[RelationshipGraph] 内嵌字段解析结果:',{nodeCount:e.nodeCount,edgeCount:e.edgeCount,warnings:e.warnings}),e}return e}),j=(0,p.computed)(()=>F.value.nodeCount>0),R=(0,p.computed)(()=>{const{factionList:e,characterToFaction:t}=gt(v.allTables||[],v.characterTables||[]);return e.filter(e=>{for(const[_,a]of t)if(a===e)return!0;return!1})});function O(){n.setActiveTab(ka)}function H(e){switch(e){case'cola':return{name:'fcose',quality:'proof',randomize:!1,animate:!0,animationDuration:500,fit:!0,padding:30,nodeSeparation:75,idealEdgeLength:100,edgeElasticity:.45,nestingFactor:.1,gravity:.25,numIter:2500,nodeRepulsion:4500,tilingPaddingVertical:10,tilingPaddingHorizontal:10};case'circle':return{name:'concentric',concentric:e=>E.value&&e.id()===E.value?100:E.value||'protagonist'!==e.data('type')?1:100,levelWidth:()=>1,minNodeSpacing:80,animate:!0,animationDuration:500,fit:!0,padding:30};case'dagre':return{name:'breadthfirst',directed:!0,padding:30,spacingFactor:1.5,animate:!0,animationDuration:300};default:return{name:'fcose',quality:'proof',randomize:!1,animate:!0,animationDuration:500,fit:!0,padding:30,nodeSeparation:100,idealEdgeLength:120,edgeElasticity:.45,nestingFactor:.1,gravity:.25,numIter:2500,nodeRepulsion:4500}}}function W(){if(!h.value)return;const e=I(),t=D(),a=t?Object.keys(t).length:0,o=F.value.nodeCount,l=a>0&&o>0&&a>=.8*o;console.info('[RelationshipGraph] 布局检查:',{保存的位置数:a,当前节点数:o,使用保存位置:l});const i=F.value.elements.map(e=>{const a=e.data?.id;if(a&&!e.data?.source){const o=m.value.get(a);let n;l&&t&&(t[a]?(console.info('[RelationshipGraph] 恢复节点位置:',a,t[a]),n=t[a]):n={x:200*(Math.random()-.5),y:200*(Math.random()-.5)});const r=e.data?.fullName||e.data?.id||'',i=s.getNodeStyleOverride(a),c=i?.size??s.config.nodeSize,u=i?.shape??'ellipse',d=i?.borderWidth??0,p=I().textMain,f=i?.borderColor??p;return{...e,data:{...e.data,avatarUrl:o?.url||void 0,avatarOffsetX:o?.offsetX??50,avatarOffsetY:o?.offsetY??50,avatarScale:o?.scale??150,fullName:r,nodeSize:c,nodeShape:u,nodeBorderWidth:d,nodeBorderColor:f},...n?{position:n}:{}}}return e});x=r({container:h.value,elements:i,style:[{selector:'node',style:{label:'data(label)','text-valign':'center','text-halign':'center','text-wrap':'wrap','text-max-width':s.config.nodeSize-4+'px','background-color':e.btnBg,color:e.textMain,'font-family':e.fontFamily,'font-size':e=>{const t=(e.data('label')||'').length,a=s.config.nodeSize;let o;return o=t<=1?.6:t<=2?.45:t<=3?.35:t<=4?.28:.22,`${Math.round(a*o)}px`},'font-weight':'bold',width:s.config.nodeSize,height:s.config.nodeSize,'border-width':1.5,'border-color':e.textMain}},{selector:'node.protagonist',style:{'background-color':e.highlight,color:e.textMain,'border-width':1.5,'border-color':e.textMain}},{selector:'node.character',style:{}},{selector:'node.faction',style:{'background-color':e.btnBg,color:e.textMain,'border-width':1.5,'border-color':e.textMain,shape:'round-rectangle',width:70,height:35,'font-size':'14px'}},{selector:'node.unknown',style:{'background-color':e.btnBg,color:e.textMain,'border-width':1.5,'border-color':e.textMain}},{selector:'node[avatarUrl]',style:{'background-color':'transparent','background-opacity':0,'border-width':0,width:s.config.nodeSize,height:s.config.nodeSize,label:''}},{selector:'edge',style:{'curve-style':'bezier','target-arrow-shape':'triangle','target-arrow-color':'data(color)','line-color':'data(color)','line-style':'solid',width:s.config.edgeWidth,label:'data(label)','font-size':`${s.config.relationLabelFontSize}px`,'font-family':e.fontFamily,'text-rotation':'autorotate','text-margin-y':-8,color:'#fff','text-background-color':'data(color)','text-background-opacity':.95,'text-background-padding':`${Math.max(3,Math.round(.25*s.config.relationLabelFontSize))}px`,'text-background-shape':'roundrectangle'}},{selector:'edge[lineStyle = "dashed"]',style:{'line-style':'dashed'}},{selector:'edge[?bidirectional]',style:{'source-arrow-shape':'triangle','source-arrow-color':'data(color)','curve-style':'straight'}},{selector:'node:selected',style:{'border-width':4,'border-color':'#FFC107','overlay-opacity':.2,'overlay-color':'#FFC107'}},{selector:'edge:selected',style:{width:4,'line-color':'#FFC107','target-arrow-color':'#FFC107'}},{selector:'.search-dimmed',style:{display:'none'}}],layout:l?{name:'preset'}:H(V.value),userZoomingEnabled:!0,userPanningEnabled:!0,boxSelectionEnabled:!1,minZoom:.3,maxZoom:3}),x.on('tap','node',e=>{const t=e.target,a=t.id(),o=t.data('type')||'unknown';y.value?K(a):('circle'===V.value&&function(e){if(!x)return;if(E.value===e)return;console.info(`[RelationshipGraph] 切换环形中心节点: ${E.value||'(主角)'} → ${e}`),E.value=e;x.layout(H('circle')).run()}(a),b('node-click',{id:a,type:o}))}),x.on('dbltap','node:childless',e=>{const t=e.target;t.hasClass('faction-container')||function(e,t){const a=ae()[e],o=a?.displayLabel||t,r=a?.selectedIndices||function(e){const t=function(e){if(ut(e))return e.split(' ').filter(Boolean);return e.split('')}(e);if(ut(e))return[0];return t.length>0?[t.length-1]:[]}(t);n.openNodeConfigDialog({nodeId:e,fullName:t,currentLabel:o,selectedIndices:r},{onConfirm:re,onResetToFullName:le,onStyleUpdate:ie})}(t.id(),t.id())}),x.on('dbltap','node.faction-container',e=>{const t=e.target,a=t.id(),o=t.data('label')||a.replace('faction-container-','');n.openFactionSettingsDialog(a,o)}),x.on('tap','edge',e=>{const t=e.target;b('edge-click',{source:t.source().id(),target:t.target().id(),relation:t.data('label')||''})});const c=T(()=>{ee()},1e3);x.on('dragfree','node',()=>{c()}),l&&x.fit(void 0,30),ne(),'cola'===V.value&&(console.info('[RelationshipGraph] 初始化时检测到 cola 布局，创建势力容器'),Z(),se()),ue(),x.nodeHtmlLabel([{query:'node[avatarUrl]',halign:'center',valign:'center',halignBox:'center',valignBox:'center',tpl:e=>{const t=e.avatarUrl||'',a=e.avatarOffsetX??50,o=e.avatarOffsetY??50,n=e.avatarScale??150,r=e.fullName||e.id||'',l=s.config.nameLabelFontSize||14,i=e.nodeSize||s.config.nodeSize||50,c=e.nodeShape||'ellipse',u=e.nodeBorderWidth??0,d=I().textMain;let p,m='none';'ellipse'===c?p='50%':'round-rectangle'===c?p='12px':'hexagon'===c?(p='0',m='polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%)'):p='0';const f=i-2*u;return`\n          <div class="acu-graph-avatar-wrapper">\n            <div class="acu-graph-avatar" style="\n              width: ${f}px;\n              height: ${f}px;\n              border-radius: ${p};\n              border: ${u}px solid ${e.nodeBorderColor??d};\n              background-image: url('${t}');\n              background-position: ${a}% ${o}%;\n              background-size: ${n}%;\n              background-repeat: no-repeat;\n              box-sizing: content-box;\n              clip-path: ${m};\n            "></div>\n            <div class="acu-graph-avatar-name" style="font-size: ${l}px;">${r}</div>\n          </div>\n        `}}])}function G(){x&&(x.elements().remove(),x.add(F.value.elements),x.layout(H(V.value)).run())}function Y(){y.value=!y.value,y.value?setTimeout(()=>{k.value?.focus()},100):q()}function X(e){if(!x)return;const t=e.trim().toLowerCase();if(!t)return void q();const a=x.nodes().filter(e=>{if(e.hasClass('faction-container')||e.hasClass('hidden-in-cola'))return!1;const a=(e.id()||'').toLowerCase(),o=(e.data('label')||'').toLowerCase(),n=(e.data('fullName')||'').toLowerCase();return a.includes(t)||o.includes(t)||n.includes(t)}).first();a&&a.length>0&&K(a.id())}function K(e){if(!x)return;const t=x.getElementById(e);if(!t||0===t.length)return;C.value=e,w.value=t.data('label')||e,x.batch(()=>{0===N.value.size&&x.elements('.hidden-in-cola').forEach(e=>{N.value.add(e.id())});let e=t.neighborhood('node').filter(e=>!e.hasClass('hidden-in-cola')).add(t),a=t.connectedEdges().filter(e=>!e.hasClass('hidden-in-cola'));if('cola'===V.value){const t=new Set;e.forEach(e=>{const a=e.parent();a.length>0&&a.hasClass('faction-container')&&t.add(a.id())}),t.forEach(t=>{const a=x.getElementById(t);a.length>0&&(e=e.add(a))}),x.edges('.faction-edge').forEach(e=>{const o=e.source().id(),n=e.target().id();t.has(o)&&t.has(n)&&(a=a.add(e))})}x.elements().addClass('search-dimmed'),e.removeClass('search-dimmed'),a.removeClass('search-dimmed')});const a=x.elements().not('.search-dimmed');x.animate({fit:{eles:a,padding:50},duration:400})}function q(){x&&(C.value=null,w.value='',x.batch(()=>{x.elements().removeClass('search-dimmed'),N.value.size>0&&N.value.forEach(e=>{const t=x.getElementById(e);t.length>0&&t.addClass('hidden-in-cola')})}),N.value.clear())}function J(){x?.fit(void 0,30)}function Z(){if(!x)return!1;const e=I(),{factionList:t,characterToFaction:a,factionRelations:o}=gt(v.allTables||[],v.characterTables||[]);if(0===t.length)return console.info('[RelationshipGraph] 未找到势力数据，跳过容器创建'),!1;console.info(`[RelationshipGraph] 创建势力容器: ${t.length} 个势力`),x.nodes('.faction-container').remove();for(const e of t){const t=x.getElementById(e);t&&t.length>0&&!t.hasClass('faction-container')&&(t.addClass('hidden-in-cola'),console.info(`[RelationshipGraph] 隐藏与势力同名的节点: "${e}"`))}for(const e of t){let o=!1;for(const[_,t]of a)if(t===e){o=!0;break}if(!o){console.info(`[RelationshipGraph] 跳过无成员势力: "${e}"`);continue}let n;if(s.hasFactionColor(e))n=s.getFactionColor(e,t);else{const a=t.indexOf(e);n=a>=0&&a<8?s.getFactionColor(e,t):Lo}x.add({group:'nodes',data:{id:`faction-container-${e}`,label:e,type:'faction-container',borderColor:n.border,backgroundColor:n.background},classes:'faction-container'})}a.forEach((e,t)=>{const a=x?.getElementById(t);a&&a.length>0&&(a.move({parent:`faction-container-${e}`}),console.info(`[RelationshipGraph] 角色 "${t}" → 势力 "${e}"`))});let n=0;const r=new Set;for(const e of o){const t=`faction-container-${e.source}`,a=`faction-container-${e.target}`,l=[e.source,e.target].sort().join('<->');if(!r.has(l)&&(x.getElementById(t).length>0&&x.getElementById(a).length>0)){const i=o.find(t=>t.source===e.target&&t.target===e.source),c=i&&i.relation===e.relation;c&&r.add(l);const s=et(e.relation);x.add({group:'edges',data:{id:'faction-edge-'+n++,source:t,target:a,label:e.relation,color:s.color,level:s.level,bidirectional:c},classes:'faction-edge'}),console.info(`[RelationshipGraph] 势力边: "${e.source}" ${c?'↔':'→'} "${e.target}" (${e.relation})`)}}return x.style().selector('node.faction-container').style({'background-color':'data(backgroundColor)','background-opacity':1,'border-width':2,'border-style':'dashed','border-color':'data(borderColor)',shape:'roundrectangle',padding:'20px',label:'data(label)','text-valign':'top','text-halign':'center','font-size':`${s.config.factionLabelFontSize}px`,'font-family':e.fontFamily,'font-weight':'bold',color:'data(borderColor)','text-background-color':'data(backgroundColor)','text-background-opacity':1,'text-background-padding':`${Math.max(4,Math.round(.4*s.config.factionLabelFontSize))}px`,'text-background-shape':'roundrectangle','text-border-width':2,'text-border-color':'data(borderColor)','text-margin-y':-8}).selector('edge.faction-edge').style({'curve-style':'bezier','target-arrow-shape':'triangle','target-arrow-color':'data(color)','line-color':'data(color)','line-style':'solid',width:3,label:'data(label)','font-size':`${s.config.relationLabelFontSize}px`,'font-family':e.fontFamily,'text-rotation':'autorotate','text-margin-y':-10,color:'#fff','text-background-color':'data(color)','text-background-opacity':.95,'text-background-padding':`${Math.max(3,Math.round(.25*s.config.relationLabelFontSize))}px`,'text-background-shape':'roundrectangle'}).selector('node.hidden-in-cola').style({display:'none'}).selector('edge.hidden-in-cola').style({display:'none'}).update(),x.nodes('.hidden-in-cola').connectedEdges().addClass('hidden-in-cola'),!0}function Q(e){if(!x)return;if(e===V.value)return;const t=V.value;'cola'===t&&'cola'!==e&&x&&(x.nodes().forEach(e=>{e.parent().length>0&&e.parent().is('.faction-container')&&e.move({parent:null})}),x.elements('.hidden-in-cola').removeClass('hidden-in-cola'),x.edges('.faction-edge').remove(),x.nodes('.faction-container').remove(),console.info('[RelationshipGraph] 已移除势力容器')),V.value=e,console.info(`[RelationshipGraph] 布局切换: ${t} → ${e}`);const a=B();a.lastLayout=e,S(a),'cola'===e&&(Z(),se());const o=function(e){const t=e||V.value,a=B();console.info(`[RelationshipGraph] hasSavedPositions(${t}):`,{layoutPositions:a.layoutPositions?Object.keys(a.layoutPositions):'undefined',targetLayoutData:a.layoutPositions?.[t]?Object.keys(a.layoutPositions[t]).length+' 个节点':'无'});const o=a.layoutPositions?.[t];return!!(o&&Object.keys(o).length>0)}(e);if(console.info(`[RelationshipGraph] 检查 [${e}] 是否有保存位置: ${o}`),o)console.info(`[RelationshipGraph] 恢复 [${e}] 保存的位置`),function(e){if(!x)return!1;const t=e||V.value,a=D(t);if(!a)return!1;const o=Object.keys(a)[0],n=a[o];console.info(`[RelationshipGraph] 准备恢复 [${t}] 位置，共 ${Object.keys(a).length} 个节点 (首节点 "${o}": 保存=${n?.x?.toFixed(0)}, ${n?.y?.toFixed(0)})`);let r=!1,l=0;x.nodes().forEach(e=>{const t=e.id(),o=a[t];if(o){const a=e.position();console.info(`[RelationshipGraph] 设置节点 "${t}": 目标=(${o.x?.toFixed?.(0)??o.x}, ${o.y?.toFixed?.(0)??o.y}), 当前=(${a.x.toFixed(0)}, ${a.y.toFixed(0)})`),e.position({x:o.x,y:o.y});const n=e.position();console.info(`[RelationshipGraph] 节点 "${t}": (${a.x.toFixed(0)}, ${a.y.toFixed(0)}) → (${n.x.toFixed(0)}, ${n.y.toFixed(0)})`),r=!0,l++}}),r&&(console.info(`[RelationshipGraph] 从 [${t}] 恢复了 ${l} 个节点位置`),x.fit(void 0,30))}(e);else{console.info(`[RelationshipGraph] [${e}] 无保存位置，运行布局算法`);x.layout(H(e)).run()}}function ee(e){if(!x)return;const t=e||V.value,a={};let o=!0;if(x.nodes().forEach(e=>{const t=e.position();t&&isFinite(t.x)&&isFinite(t.y)&&(a[e.id()]={x:t.x,y:t.y},0===t.x&&0===t.y||(o=!1))}),o&&Object.keys(a).length>0)return void console.warn('[RelationshipGraph] 跳过保存：所有位置都是 (0, 0)，布局可能未完成');const n=Object.keys(a)[0],r=a[n];console.info(`[RelationshipGraph] 保存节点位置到 [${t}]:`,Object.keys(a).length,`个节点 (首节点 "${n}": ${r?.x?.toFixed(0)}, ${r?.y?.toFixed(0)})`);const l=B();l.layoutPositions||(l.layoutPositions={}),l.layoutPositions[t]=a,S(l)}function te(){const e=B();e.layoutPositions&&(delete e.layoutPositions[V.value],S(e));const t=V.value;console.info(`[RelationshipGraph] 清除 [${t}] 布局位置，重新运行布局`);const a=H(t);'fcose'!==t&&'cola'!==t||(a.randomize=!0);const o=x?.layout(a);o?.one('layoutstop',()=>{ee(t)}),o?.run()}function ae(){return B().labels||{}}function oe(e){const t=B();t.labels=e,S(t)}function ne(){if(!x)return;const e=ae();x.nodes().forEach(t=>{const a=t.id(),o=e[a];o&&o.displayLabel?t.data('label',o.displayLabel):t.data('label',a)}),console.info('[RelationshipGraph] 标签配置已应用，共配置:',Object.keys(e).length,'个节点')}function re(e,t,a){const o=ae();if(o[e]={displayLabel:t,selectedIndices:a},oe(o),x){const a=x.getElementById(e);a&&a.data('label',t)}}function le(e,t){const a=ae();if(delete a[e],oe(a),x){const a=x.getElementById(e);a&&a.data('label',t)}}function ie(e){if(!x)return;const t=x.getElementById(e);if(!t||0===t.length)return;const a=s.getNodeStyleOverride(e),o=s.config.nodeSize||50,n=a?.size??o,r=a?.borderWidth??0,l=a?.borderColor??'transparent',i=a?.shape??'ellipse';t.style({width:n,height:n}),t.data('nodeSize',n),t.data('nodeBorderWidth',r),t.data('nodeBorderColor',l),t.data('nodeShape',i),t.trigger('data'),console.info(`[RelationshipGraph] 应用节点样式覆盖: ${e}, size=${n}, border=${r}px ${l}, shape=${i}`)}function ce(){if(!x)return;const e=s.config.nodeOverrides||{},t=Object.entries(e);0!==t.length&&(x.batch(()=>{for(const[e,a]of t){const t=x.getElementById(e);t&&0!==t.length&&(void 0!==a.size&&(t.style({width:a.size,height:a.size}),t.data('nodeSize',a.size)),void 0!==a.borderWidth&&t.data('nodeBorderWidth',a.borderWidth),void 0!==a.borderColor&&t.data('nodeBorderColor',a.borderColor),void 0!==a.shape&&t.data('nodeShape',a.shape))}}),console.info(`[RelationshipGraph] 应用了 ${t.length} 个节点样式覆盖`))}function se(){if(!x)return;const e=x.nodes('.faction-container');if(0===e.length)return;I();const{factionList:t}=gt(v.allTables||[],v.characterTables||[]);x.batch(()=>{e.forEach(e=>{const a=e.id(),o=a.replace('faction-container-',''),n=s.getFactionOverride(a)||s.getFactionColor(o,t);e.data('borderColor',n.border),e.data('backgroundColor',n.background);const r={},l=n.opacity??function(e,t=10){const a=e.match(/rgba?\s*\([^)]+,\s*([\d.]+)\s*\)/);return a?Math.round(100*parseFloat(a[1])):t}(n.background,10);r['background-opacity']=l/100;const i=n.labelPosition??'top';if('none'===i)r['text-opacity']=0,r['text-background-opacity']=0;else switch(r['text-opacity']=1,r['text-background-opacity']=1,r.label=o,r['text-valign']=function(e){switch(e){case'top':case'top-left':case'top-right':case'none':default:return'top';case'bottom':case'bottom-left':case'bottom-right':return'bottom'}}(i),r['text-halign']=function(e){switch(e){case'top-left':case'bottom-left':return'left';case'top-right':case'bottom-right':return'right';default:return'center'}}(i),i){case'top':default:r['text-margin-y']=-8,r['text-margin-x']=0;break;case'bottom':r['text-margin-y']=8,r['text-margin-x']=0;break;case'top-left':r['text-valign']='top',r['text-halign']='left',r['text-margin-x']=25,r['text-margin-y']=25;break;case'top-right':r['text-valign']='top',r['text-halign']='right',r['text-margin-x']=-25,r['text-margin-y']=25;break;case'bottom-left':r['text-valign']='bottom',r['text-halign']='left',r['text-margin-x']=25,r['text-margin-y']=-25;break;case'bottom-right':r['text-valign']='bottom',r['text-halign']='right',r['text-margin-x']=-25,r['text-margin-y']=-25}void 0!==n.labelFontSize&&(r['font-size']=`${n.labelFontSize}px`),r['text-background-color']=n.background,r['text-background-opacity']=l/100,r.color=n.border,r['text-border-color']=n.border,e.style(r)})}),console.info(`[RelationshipGraph] 应用了 ${e.length} 个势力容器样式`)}function ue(){x&&(console.info('[RelationshipGraph] 应用所有配置...'),x.batch(()=>{ce(),se()}),x.style().update(),console.info('[RelationshipGraph] 所有配置应用完成'))}const de=(0,p.computed)(()=>F.value&&F.value.elements?F.value.elements.filter(e=>!e.data.source&&!e.data.target).map(e=>({id:e.data.id,name:e.data.id,label:e.data.label||e.data.id,type:e.data.type||'character'})):[]),pe=(0,p.computed)(()=>R.value.map((e,t)=>({id:`faction_${t}`,name:e})));function me(){n.openGraphSettingsDialog(R.value)}async function fe(){try{const e=await d.getAliasMap();f.value=e,console.info(`[RelationshipGraph] 别名映射加载完成: ${e.size} 个别名`)}catch(e){console.warn('[RelationshipGraph] 加载别名映射失败:',e)}}async function ge(){const e=F.value.elements.filter(e=>!e.data.source&&!e.data.target),t=new Map;for(const a of e){const e=a.data.id;if(e)try{const a=await d.getAvatarUrl(e);if(a){const o=await d.getAvatarDisplayConfig(e);t.set(e,{url:a,offsetX:o.offsetX,offsetY:o.offsetY,scale:o.scale})}}catch(t){console.warn(`[RelationshipGraph] 获取头像失败: ${e}`,t)}}m.value=t,console.info(`[RelationshipGraph] 头像预加载完成: ${t.size}/${e.length}`)}async function ve(){console.log('[RelationshipGraph] handleAvatarUpdate 被调用'),await fe(),await ge(),x&&(x.nodes().forEach(e=>{const t=e.id(),a=m.value.get(t);a?(e.data('avatarUrl',a.url),e.data('avatarOffsetX',a.offsetX),e.data('avatarOffsetY',a.offsetY),e.data('avatarScale',a.scale)):(e.removeData('avatarUrl'),e.removeData('avatarOffsetX'),e.removeData('avatarOffsetY'),e.removeData('avatarScale'))}),ne(),x.nodes().trigger('data'),x.style().update())}function be(){console.log('[RelationshipGraph] handleLabelChange 被调用'),x&&(ne(),x.style().update())}(0,p.watch)(()=>n.avatarManagerDialog.visible,e=>{if(!e){const{$}=xt();$('.acu-data-display').removeClass('has-modal')}}),(0,p.watch)(()=>s.config,()=>{!function(){if(!x)return;const e=s.config;console.info('[RelationshipGraph] 实时更新图形样式'),x.batch(()=>{x.style().selector('node').style({width:e.nodeSize,height:e.nodeSize,'text-max-width':e.nodeSize-4+'px'}).selector('node[avatarUrl]').style({width:e.nodeSize,height:e.nodeSize}).selector('edge').style({width:e.edgeWidth,'font-size':`${e.relationLabelFontSize}px`}).selector('node.faction-container').style({'font-size':`${e.factionLabelFontSize}px`}).selector('edge.faction-edge').style({'font-size':`${e.relationLabelFontSize}px`}).update()}),ue()}()},{deep:!0}),(0,p.watch)(()=>s.config.nodeOverrides,()=>{x&&(ce(),x.style().update())},{deep:!0}),(0,p.watch)(()=>s.config.factionColors,()=>{x&&(se(),x.style().update())},{deep:!0}),(0,p.watch)(()=>s.config.legendConfig,()=>{x&&j.value&&(console.info('[RelationshipGraph] 图例配置变化，重新应用边颜色'),x.batch(()=>{const e=F.value.elements.filter(e=>e.data.source&&e.data.target);for(const t of e){const e=t.data.id;if(!e)continue;const a=x.getElementById(e);a&&a.length>0&&(a.data('color',t.data.color),a.data('level',t.data.level))}}),x.style().update())},{deep:!0}),(0,p.watch)(()=>[u.backgroundConfig.hasIndexedDBImage,u.backgroundConfig.externalUrl],()=>{xe()});const he=(0,p.ref)(!1);async function xe(){const e=u.backgroundConfig;if(g.value?.startsWith('blob:')&&(Ie(g.value),g.value=null),e.externalUrl)g.value=e.externalUrl;else if(e.hasIndexedDBImage)try{const e=await ze(Se);g.value=e}catch(e){console.warn('[RelationshipGraph] 加载背景图片失败:',e),g.value=null}else g.value=null}function ye(){if(!x)return;const e=I();x.batch(()=>{x.nodes().forEach(t=>{const a={'font-family':e.fontFamily,color:e.textMain,'border-width':1.5,'border-color':e.textMain};t.hasClass('protagonist')?a['background-color']=e.highlight:t.hasClass('faction-container')||t.data('avatarUrl')||(a['background-color']=e.btnBg),t.style(a)}),x.edges().forEach(t=>{t.style('font-family',e.fontFamily)})}),x.style().update(),console.info('[RelationshipGraph] 节点颜色和字体已更新')}return(0,p.onMounted)(async()=>{await Promise.all([fe(),xe()]),j.value&&(await ge(),await U(),W(),he.value=!0)}),(0,p.watch)(j,async e=>{e&&!he.value&&h.value&&(console.info('[RelationshipGraph] 数据准备就绪，预加载头像和字体...'),await ge(),await U(),console.info('[RelationshipGraph] 初始化图形'),W(),he.value=!0)},{immediate:!0}),(0,p.onBeforeUnmount)(()=>{x?.destroy(),x=null,g.value?.startsWith('blob:')&&(Ie(g.value),g.value=null)}),(0,p.watch)(()=>v.relationshipTable,()=>{x&&G()},{deep:!0}),(0,p.watch)(()=>o.config.theme,()=>{x&&setTimeout(()=>{ye()},50)}),(0,p.watch)(()=>o.config.fontFamily,async()=>{x&&(await U(),ye())}),t({fitToView:J,zoomIn:function(){x&&x.zoom(1.2*x.zoom())},zoomOut:function(){x&&x.zoom(x.zoom()/1.2)},setLayout:Q,refresh:function(){G()},applyAllConfigs:ue,applyAllNodeStyleOverrides:ce,applyAllFactionStyles:se,openAvatarManager:function(){const{$}=xt();$('.acu-data-display').addClass('has-modal'),n.openAvatarManagerDialog({nodes:de.value,factions:pe.value},{onUpdate:ve,onLabelChange:be})}}),(e,t)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',tC,[(0,p.createCommentVNode)(' 背景层 '),L.value.enabled?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-graph-background',style:(0,p.normalizeStyle)(L.value.style)},null,4)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 图例（顶部） '),(0,p.unref)(s).config.showLegend?((0,p.openBlock)(),(0,p.createElementBlock)('div',aC,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(M.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.level,class:'acu-legend-item'},[(0,p.createElementVNode)('span',{class:(0,p.normalizeClass)(['dot',{dashed:e.isDashed}]),style:(0,p.normalizeStyle)({backgroundColor:e.isDashed?'transparent':e.color,borderColor:e.color})},null,6),(0,p.createElementVNode)('span',oC,(0,p.toDisplayString)(e.emoji)+' '+(0,p.toDisplayString)(e.name),1)]))),128))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 图容器（中间） '),(0,p.createElementVNode)('div',{ref_key:'containerRef',ref:h,class:'acu-graph-container'},null,512),(0,p.createCommentVNode)(' 搜索框（工具栏上方，仅搜索模式显示） '),(0,p.createVNode)(p.Transition,{name:'acu-slide-up'},{default:(0,p.withCtx)(()=>[y.value?((0,p.openBlock)(),(0,p.createBlock)(ss,{key:0,ref_key:'searchInputRef',ref:k,modelValue:w.value,'onUpdate:modelValue':t[0]||(t[0]=e=>w.value=e),class:'acu-graph-search-input',placeholder:'搜索人物...',autofocus:!0,'show-result-count':!1,onSearch:X,onClear:q},null,8,['modelValue'])):(0,p.createCommentVNode)('v-if',!0)]),_:1}),(0,p.createCommentVNode)(' 工具栏（底部） '),(0,p.createElementVNode)('div',nC,[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-graph-btn',{active:y.value}]),title:'搜索模式',onClick:Y},[...t[5]||(t[5]=[(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)])],2),t[14]||(t[14]=(0,p.createElementVNode)('span',{class:'acu-toolbar-divider'},null,-1)),(0,p.createElementVNode)('button',{class:'acu-graph-btn',title:'适应视图',onClick:J},[...t[6]||(t[6]=[(0,p.createElementVNode)('i',{class:'fas fa-compress-arrows-alt'},null,-1)])]),t[15]||(t[15]=(0,p.createElementVNode)('span',{class:'acu-toolbar-divider'},null,-1)),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-graph-btn',{active:'fcose'===V.value}]),title:'力导向布局',onClick:t[1]||(t[1]=e=>Q('fcose'))},[...t[7]||(t[7]=[(0,p.createElementVNode)('i',{class:'fas fa-project-diagram'},null,-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-graph-btn',{active:'cola'===V.value}]),title:'势力分组布局',onClick:t[2]||(t[2]=e=>Q('cola'))},[...t[8]||(t[8]=[(0,p.createElementVNode)('i',{class:'fas fa-object-group'},null,-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-graph-btn',{active:'circle'===V.value}]),title:'环形布局',onClick:t[3]||(t[3]=e=>Q('circle'))},[...t[9]||(t[9]=[(0,p.createElementVNode)('i',{class:'fas fa-circle-notch'},null,-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-graph-btn',{active:'dagre'===V.value}]),title:'层级布局',onClick:t[4]||(t[4]=e=>Q('dagre'))},[...t[10]||(t[10]=[(0,p.createElementVNode)('i',{class:'fas fa-sitemap'},null,-1)])],2),t[16]||(t[16]=(0,p.createElementVNode)('span',{class:'acu-toolbar-divider'},null,-1)),(0,p.createElementVNode)('button',{class:'acu-graph-btn',title:'重置布局',onClick:te},[...t[11]||(t[11]=[(0,p.createElementVNode)('i',{class:'fas fa-undo'},null,-1)])]),t[17]||(t[17]=(0,p.createElementVNode)('span',{class:'acu-toolbar-divider'},null,-1)),(0,p.createElementVNode)('button',{class:'acu-graph-btn',title:'图形设置',onClick:(0,p.withModifiers)(me,['stop'])},[...t[12]||(t[12]=[(0,p.createElementVNode)('i',{class:'fas fa-cog'},null,-1)])]),t[18]||(t[18]=(0,p.createElementVNode)('span',{class:'acu-toolbar-divider'},null,-1)),(0,p.createElementVNode)('button',{class:'acu-graph-btn',title:'返回仪表盘',onClick:(0,p.withModifiers)(O,['stop'])},[...t[13]||(t[13]=[(0,p.createElementVNode)('i',{class:'fas fa-arrow-left'},null,-1)])])]),(0,p.createCommentVNode)(' 空状态 '),j.value?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',rC,[...t[19]||(t[19]=[(0,p.createElementVNode)('i',{class:'fas fa-project-diagram'},null,-1),(0,p.createElementVNode)('p',null,'暂无关系数据',-1),(0,p.createElementVNode)('p',{class:'hint'},'请确保存在"关系表"并包含有效数据',-1)])]))]))}});d(732);const cC=iC,sC=['title','onClick'],uC=(0,p.defineComponent)({__name:'TabsPopup',props:{visible:{type:Boolean},tabs:{},activeTab:{},gridColumns:{default:'repeat(auto-fill, minmax(90px, 1fr))'},showDashboard:{type:Boolean,default:!0},showRelationshipGraph:{type:Boolean,default:!1},showOptionsPanel:{type:Boolean,default:!1}},emits:['close','tab-click'],setup(e,{emit:t}){const a=e,o=t,n=ea(),r=Ea();function l(e){return e===ka||e===Ca||e===Na}const i=(0,p.computed)(()=>{const e=r.visibleTabs;if(!e||0===e.length){const e=[];return a.showDashboard&&e.push({id:ka,name:'仪表盘',icon:'fas fa-home'}),e.push(...a.tabs),a.showRelationshipGraph&&e.push({id:Na,name:'关系图',icon:'fas fa-project-diagram'}),a.showOptionsPanel&&e.push({id:Ca,name:'选项',icon:'fas fa-sliders-h'}),e}return e.map(e=>function(e){return e===ka?{id:ka,name:'仪表盘',icon:'fas fa-home'}:e===Na?{id:Na,name:'关系图',icon:'fas fa-project-diagram'}:e===Ca?{id:Ca,name:'选项',icon:'fas fa-sliders-h'}:a.tabs.find(t=>t.id===e)}(e)).filter(e=>!!e&&(!(e.id===ka&&!a.showDashboard)&&(!(e.id===Na&&!a.showRelationshipGraph)&&!(e.id===Ca&&!a.showOptionsPanel))))});function c(e){return n.hasTableIssues(e)}return(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'hidden-popup'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-tabs-popup',onClick:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['stop']))},[(0,p.createElementVNode)('div',{class:'popup-tabs-grid',style:(0,p.normalizeStyle)({'--acu-nav-cols':e.gridColumns})},[(0,p.createCommentVNode)(' 统一 Tab 列表（已过滤和排序） '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(i.value,t=>{return(0,p.openBlock)(),(0,p.createElementBlock)('button',{key:t.id,class:(0,p.normalizeClass)(['acu-nav-btn',{active:e.activeTab===t.id,'has-issues':!l(t.id)&&c(t.name),'has-ai-changes':!l(t.id)&&!c(t.name)&&(a=t.name,n.hasTableAiChanges(a))}]),title:t.name,onClick:(0,p.withModifiers)(e=>{return a=t.id,o('tab-click',a),void o('close');var a},['stop'])},[t.icon?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(t.icon)},null,2)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(t.name),1)],10,sC);var a}),128))],4)])):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}});d(651);const dC=(0,on.A)(uC,[['__scopeId','data-v-53ac0e66']]),pC={class:'acu-modal acu-prompt-editor-modal'},mC={class:'acu-modal-header'},fC={class:'acu-modal-body'},gC={class:'acu-settings-section'},vC={class:'acu-settings-group'},bC={class:'acu-settings-row',style:{'flex-direction':'column','align-items':'flex-start'}},hC={class:'acu-modal-footer'},xC=(0,p.defineComponent)({__name:'PromptEditorDialog',props:{visible:{type:Boolean},prompt:{}},emits:['close','save'],setup(e,{emit:t}){const a=e,o=t,n=Ea(),r=(0,Aa.d)(),l=(0,p.ref)('');function i(){o('close')}function c(){l.value='',r.info('提示词已清空（需点击保存生效）')}function s(){o('save',l.value),r.success('隐藏提示词已保存'),i()}return(0,p.watch)(()=>[a.visible,a.prompt],([e,t])=>{e&&(l.value=t||'')},{immediate:!0}),(t,a)=>((0,p.openBlock)(),(0,p.createBlock)(p.Transition,{name:'modal'},{default:(0,p.withCtx)(()=>[e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:(0,p.normalizeClass)(['acu-modal-container',{'acu-center-modal':(0,p.unref)(n).isMobile}]),onClick:(0,p.withModifiers)(i,['self'])},[(0,p.createElementVNode)('div',pC,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',mC,[a[1]||(a[1]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-eye-slash'}),(0,p.createTextVNode)(' 隐藏提示词 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(i,['stop'])},'关闭')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',fC,[(0,p.createElementVNode)('div',gC,[a[3]||(a[3]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-edit'}),(0,p.createTextVNode)(' 编辑提示词 ')],-1)),(0,p.createElementVNode)('div',vC,[(0,p.createElementVNode)('div',bC,[a[2]||(a[2]=(0,p.createElementVNode)('div',{class:'acu-settings-label',style:{'margin-bottom':'8px'}},[(0,p.createTextVNode)(' 提示词内容 '),(0,p.createElementVNode)('span',{class:'hint'},'发送消息时会自动注入到用户输入之前')],-1)),(0,p.withDirectives)((0,p.createElementVNode)('textarea',{'onUpdate:modelValue':a[0]||(a[0]=e=>l.value=e),class:'acu-textarea-scrollable',style:{width:'100%',height:'150px'},placeholder:'输入要隐藏的提示词...'},null,512),[[p.vModelText,l.value]])])])])]),(0,p.createCommentVNode)(' 底部按钮 '),(0,p.createElementVNode)('div',hC,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(c,['stop'])},'清空'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary',onClick:(0,p.withModifiers)(s,['stop'])},'保存')])])],2)):(0,p.createCommentVNode)('v-if',!0)]),_:1}))}}),yC=['onClick'],wC={class:'acu-badge-label'},kC={key:0,class:'acu-badge-icon'},CC={key:0,class:'fas fa-check added-icon'},NC={key:1,class:'fas fa-plus add-icon'},VC={key:1,class:'acu-badge-icon tap-icon'},EC={key:2,class:'acu-badge-delete'},BC={key:0,class:'acu-grid-empty'},SC=(0,p.defineComponent)({__name:'TagBadgeGrid',props:{mode:{},displayedTagIds:{default:()=>[]}},emits:['tagClick','createTag','deleteTag','addTag'],setup(e,{emit:t}){const a=e,o=t,n=Ko(),r=(0,p.computed)(()=>n.filteredTags),l=(0,p.computed)(()=>n.selectedTagIds),i=(0,p.computed)(()=>new Set(a.displayedTagIds)),c=(0,p.computed)(()=>n.searchKeyword?'未找到匹配的标签':'未分类'===n.selectedLevel1?'暂无未分类的标签':n.selectedLevel1?`"${n.selectedLevel1}" 分类下暂无标签`:'暂无标签，点击新建按钮创建');function s(e){switch(a.mode){case'normal':case'create':o('tagClick',e);break;case'add':o('addTag',e.id);break;case'delete':o('deleteTag',e.id);break;case'migrate':case'export':t=e.id,n.toggleTagSelection(t)}var t}function u(){'create'===a.mode&&o('createTag')}return(t,a)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:'acu-tag-grid',onClick:u},[(0,p.createCommentVNode)(' 标签列表 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.id,class:(0,p.normalizeClass)(['acu-tag-badge',{selected:l.value.has(t.id),added:i.value.has(t.id),'mode-add':'add'===e.mode,'mode-delete':'delete'===e.mode}]),onClick:(0,p.withModifiers)(e=>s(t),['stop'])},[(0,p.createCommentVNode)(' 标签文本 '),(0,p.createElementVNode)('span',wC,(0,p.toDisplayString)(t.label),1),(0,p.createCommentVNode)(' 添加模式：已添加显示✓，未添加显示+ '),'add'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('span',kC,[i.value.has(t.id)?((0,p.openBlock)(),(0,p.createElementBlock)('i',CC)):((0,p.openBlock)(),(0,p.createElementBlock)('i',NC))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 迁移/导出模式：手指点击图标 '),'migrate'===e.mode||'export'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('span',VC,[...a[0]||(a[0]=[(0,p.createElementVNode)('i',{class:'fas fa-hand-pointer'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 删除模式：删除图标（常驻） '),'delete'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('span',EC,[...a[1]||(a[1]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)],10,yC))),128)),(0,p.createCommentVNode)(' 空状态 '),0===r.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',BC,[a[2]||(a[2]=(0,p.createElementVNode)('i',{class:'fas fa-tag'},null,-1)),(0,p.createElementVNode)('span',null,(0,p.toDisplayString)(c.value),1)])):(0,p.createCommentVNode)('v-if',!0)]))}}),TC={class:'acu-tree-icon'},DC={key:1},AC={class:'acu-tree-count'},zC={key:0,class:'acu-root-icon-editor'},IC={class:'acu-tree-count'},_C={key:1,class:'acu-tree-divider'},UC=['data-category-id','onClick'],MC=['onClick'],LC={key:1,class:'acu-tree-toggle-placeholder'},$C={key:2,class:'acu-tree-icon'},PC={key:1},FC={class:'acu-tree-label'},jC={class:'acu-tree-count'},RC=['onClick'],OC=['onClick'],HC=['onClick'],WC=['onClick'],GC={key:2,class:'acu-tree-empty'},YC='acu_tag_library_root_icon',XC=(0,p.defineComponent)({__name:'TagCategoryTree',props:{mode:{}},emits:['categoryClick','addCategory','migrateToCategory','deleteCategory'],setup(e,{emit:t}){const a=e,o=t,n=Ko(),r=(Ea(),(0,p.ref)(null)),l=(0,p.ref)(new Set),i=(0,p.ref)(null),c=(0,p.ref)(!1),s=(0,p.ref)(''),u=(0,p.ref)(localStorage.getItem(YC)||'📂'),d=(0,p.computed)(()=>n.selectedLevel1),m=(0,p.computed)(()=>{if(!n.selectedLevel1||'全部'===n.selectedLevel1||'未分类'===n.selectedLevel1)return null;const e=n.selectedLevel2?`${n.selectedLevel1}/${n.selectedLevel2}`:n.selectedLevel1;return n.getCategoryByPath(e)?.id||null}),f=(0,p.computed)(()=>n.totalTags),g=(0,p.computed)(()=>n.uncategorizedCount),v=(0,p.computed)(()=>n.selectedCategoryIds),b=(0,p.computed)(()=>n.selectionType),h=(0,p.computed)(()=>{const e=[],t=n.library.categories,a=new Map;t.forEach(e=>{a.set(e.path,e)});function o(r,i,c){const s=a.get(r);if(!s)return;const u=t.filter(e=>{if(!e.path.startsWith(r+'/'))return!1;return!e.path.slice(r.length+1).includes('/')}),d=r.split('/');e.push({id:s.id,name:d[d.length-1],level1:d[0],path:s.path,icon:s.icon,depth:i,hasChildren:u.length>0,tagCount:n.getCategoryTagCount(s.id),parentId:c}),l.value.has(s.id)&&u.sort((e,t)=>e.path.localeCompare(t.path,'zh-CN')).forEach(e=>{o(e.path,i+1,s.id)})}return t.filter(e=>!e.path.includes('/')).sort((e,t)=>e.path.localeCompare(t.path,'zh-CN')).forEach(e=>{o(e.path,0)}),e});function x(e){return e.startsWith('fa')||e.includes(' fa-')}function y(){s.value&&(u.value=s.value,localStorage.setItem(YC,s.value),s.value='',c.value=!1)}function w(){n.selectLevel1(''),o('categoryClick',null)}function k(e){o('migrateToCategory',e)}function C(e){const t=e.target,a=t.querySelectorAll('.acu-tag-tree-item'),o=t.getBoundingClientRect().top;let n=null;for(let e=0;e<a.length;e++){const t=a[e];if(!(t.getBoundingClientRect().top<o+10))break;n=t}if(!n)return void(i.value=null);const r=n.dataset.categoryId;if(!r)return void(i.value=null);const c=h.value.find(e=>e.id===r);c?c.hasChildren&&l.value.has(c.id)?i.value=c.id:c.parentId&&l.value.has(c.parentId)?i.value=c.parentId:i.value=null:i.value=null}return(0,p.watch)(()=>a.mode,e=>{'migrate'!==e&&n.clearSelection()}),(t,N)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{ref_key:'treeContainer',ref:r,class:'acu-tag-tree',onScroll:C},[(0,p.createCommentVNode)(' 根目录（原"全部"） '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-tag-tree-item acu-root-item',{active:'全部'===d.value||''===d.value,'migrate-target':'migrate'===e.mode}]),onClick:w},[(0,p.createElementVNode)('span',TC,[x(u.value)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(u.value)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',DC,(0,p.toDisplayString)(u.value),1))]),N[12]||(N[12]=(0,p.createElementVNode)('span',{class:'acu-tree-label'},'根目录',-1)),(0,p.createElementVNode)('span',AC,'('+(0,p.toDisplayString)(f.value)+')',1),(0,p.createCommentVNode)(' 添加模式：添加按钮 '),'add'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-add-btn',title:'添加根目录到展示区',onClick:N[0]||(N[0]=(0,p.withModifiers)(e=>o('addCategory','root'),['stop']))},[...N[8]||(N[8]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 迁移模式：迁入按钮（将分类迁移到根级=变成一级分类） '),'migrate'===e.mode&&'category'===b.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:1,class:'acu-migrate-btn',title:'迁入到根目录（变成一级分类）',onClick:N[1]||(N[1]=(0,p.withModifiers)(e=>k('root'),['stop']))},[...N[9]||(N[9]=[(0,p.createElementVNode)('i',{class:'fas fa-sign-in-alt'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 删除模式：清空按钮 '),'delete'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:2,class:'acu-delete-btn',title:'清空所有标签和分类',onClick:N[2]||(N[2]=(0,p.withModifiers)(e=>o('deleteCategory','root'),['stop']))},[...N[10]||(N[10]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 编辑图标按钮（普通模式） '),'normal'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:3,class:'acu-edit-icon-btn',title:'修改图标',onClick:N[3]||(N[3]=(0,p.withModifiers)(e=>c.value=!c.value,['stop']))},[...N[11]||(N[11]=[(0,p.createElementVNode)('i',{class:'fas fa-palette'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)],2),(0,p.createCommentVNode)(' 根目录图标编辑器 '),c.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',zC,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':N[4]||(N[4]=e=>s.value=e),type:'text',class:'acu-icon-input',placeholder:'输入emoji',maxlength:'2',onKeyup:(0,p.withKeys)(y,['enter'])},null,544),[[p.vModelText,s.value]]),(0,p.createElementVNode)('button',{class:'acu-btn-small',onClick:(0,p.withModifiers)(y,['stop'])},[...N[13]||(N[13]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-btn-small',onClick:N[5]||(N[5]=(0,p.withModifiers)(e=>c.value=!1,['stop']))},[...N[14]||(N[14]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 未分类 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-tag-tree-item',{active:'未分类'===d.value,'migrate-target':'migrate'===e.mode&&'tag'===b.value}]),onClick:N[7]||(N[7]=e=>function(e){if('add'===a.mode){if('全部'!==e&&'未分类'!==e){const t=n.library.categories.find(t=>t.path===e);t&&o('categoryClick',t)}}else n.selectLevel1('全部'===e?'':e),o('categoryClick',null)}('未分类'))},[N[16]||(N[16]=(0,p.createElementVNode)('span',{class:'acu-tree-icon'},'📦',-1)),N[17]||(N[17]=(0,p.createElementVNode)('span',{class:'acu-tree-label'},'未分类',-1)),(0,p.createElementVNode)('span',IC,'('+(0,p.toDisplayString)(g.value)+')',1),(0,p.createCommentVNode)(' 迁移模式：迁入按钮 '),'migrate'===e.mode&&'tag'===b.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-migrate-btn',title:'迁入此分类',onClick:N[6]||(N[6]=(0,p.withModifiers)(e=>k(''),['stop']))},[...N[15]||(N[15]=[(0,p.createElementVNode)('i',{class:'fas fa-sign-in-alt'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)],2),(0,p.createCommentVNode)(' 分隔线 '),h.value.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',_C)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 自定义分类 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(h.value,t=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:t.id,class:(0,p.normalizeClass)(['acu-tag-tree-item',{active:m.value===t.id||d.value===t.level1,expanded:l.value.has(t.id),sticky:i.value===t.id,selected:v.value.has(t.id),'migrate-target':'migrate'===e.mode}]),'data-category-id':t.id,onClick:e=>function(e){if('migrate'===a.mode&&'category'===n.selectionType)return void n.toggleCategorySelection(e.id);if('add'===a.mode)return n.selectLevel1(e.level1),void(e.depth>0?n.selectLevel2(e.name):n.selectLevel2(''));const t=m.value===e.id;if(n.selectLevel1(e.level1),e.depth>0?n.selectLevel2(e.name):n.selectLevel2(''),e.hasChildren){let a=!1;l.value.has(e.id)?t&&(l.value.delete(e.id),a=!0):(l.value.add(e.id),a=!0),a&&(l.value=new Set(l.value))}o('categoryClick',n.getCategoryById(e.id)||null)}(t)},[(0,p.createCommentVNode)(' 展开/折叠按钮 '),t.hasChildren?((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:0,class:'acu-tree-toggle',onClick:(0,p.withModifiers)(e=>{return a=t.id,l.value.has(a)?l.value.delete(a):l.value.add(a),void(l.value=new Set(l.value));var a},['stop'])},(0,p.toDisplayString)(l.value.has(t.id)?'▼':'▶'),9,MC)):((0,p.openBlock)(),(0,p.createElementBlock)('span',LC)),(0,p.createCommentVNode)(' 图标 '),t.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',$C,[x(t.icon)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(t.icon)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',PC,(0,p.toDisplayString)(t.icon),1))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 名称 '),(0,p.createElementVNode)('span',FC,(0,p.toDisplayString)(t.name),1),(0,p.createCommentVNode)(' 计数 '),(0,p.createElementVNode)('span',jC,'('+(0,p.toDisplayString)(t.tagCount)+')',1),(0,p.createCommentVNode)(' 添加模式：添加按钮（常驻） '),'add'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:3,class:'acu-add-btn',title:'添加到展示区',onClick:(0,p.withModifiers)(e=>{return a=t.id,void o('addCategory',a);var a},['stop'])},[...N[18]||(N[18]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])],8,RC)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 迁移模式：选中按钮 + 迁入按钮 '),'migrate'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:4},[(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-select-btn',{active:v.value.has(t.id)}]),title:'选中此分类',onClick:(0,p.withModifiers)(e=>{return a=t.id,void n.toggleCategorySelection(a);var a},['stop'])},[(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(v.value.has(t.id)?'fas fa-check-square':'far fa-square')},null,2)],10,OC),(0,p.createElementVNode)('button',{class:'acu-migrate-btn',title:'迁入到此分类',onClick:(0,p.withModifiers)(e=>k(t.id),['stop'])},[...N[19]||(N[19]=[(0,p.createElementVNode)('i',{class:'fas fa-sign-in-alt'},null,-1)])],8,HC)],64)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 删除模式：删除按钮 '),'delete'===e.mode?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:5,class:'acu-delete-btn',title:'删除分类',onClick:(0,p.withModifiers)(e=>{return a=t.id,void o('deleteCategory',a);var a},['stop'])},[...N[20]||(N[20]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])],8,WC)):(0,p.createCommentVNode)('v-if',!0)],10,UC))),128)),(0,p.createCommentVNode)(' 空状态 '),0===h.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',GC,[...N[21]||(N[21]=[(0,p.createElementVNode)('i',{class:'fas fa-folder-open'},null,-1),(0,p.createElementVNode)('span',null,'暂无自定义分类',-1)])])):(0,p.createCommentVNode)('v-if',!0)],544))}}),KC={class:'acu-modal acu-tag-edit-modal'},qC={class:'acu-modal-header'},JC={class:'acu-modal-title'},ZC={class:'acu-header-actions'},QC=['disabled'],eN={class:'acu-modal-body'},tN={class:'acu-settings-section'},aN={class:'acu-settings-group'},oN={class:'acu-settings-row'},nN={class:'acu-settings-control'},rN={class:'acu-settings-row acu-category-row'},lN={class:'acu-settings-control acu-category-control'},iN={class:'selected-value'},cN={key:1},sN={class:'text'},uN={key:1,class:'placeholder'},dN={key:0,class:'acu-custom-dropdown-menu'},pN=['onClick'],mN={key:1},fN={class:'text'},gN={class:'acu-settings-row'},vN={class:'acu-settings-control'},bN={class:'selected-value'},hN={key:1},xN={class:'text'},yN={key:1,class:'placeholder'},wN={key:0,class:'acu-custom-dropdown-menu'},kN=['onClick'],CN={key:1},NN={class:'text'},VN={class:'acu-settings-row acu-new-category-row'},EN={class:'acu-settings-control acu-new-category-control'},BN={key:1},SN={class:'acu-settings-row'},TN={class:'acu-settings-control'},DN={class:'acu-switch'},AN={class:'acu-settings-section'},zN={class:'acu-settings-group'},IN={class:'acu-settings-row column'},_N={class:'acu-settings-control'},UN={class:'acu-wildcard-shortcuts'},MN=['textContent'],LN=['textContent'],$N=['textContent'],PN={class:'acu-wildcard-help'},FN={key:0},jN=['textContent'],RN=['textContent'],ON=['textContent'],HN=(0,p.defineComponent)({__name:'TagEditDialog',props:{visible:{type:Boolean},tag:{},defaultCategoryId:{default:''}},emits:['update:visible','saved','close'],setup(e,{emit:t}){const a=e,o=t,n=Ko(),r=Ea(),l=(0,p.ref)(null),i=(0,p.ref)(null),c=(0,p.ref)({label:'',categoryId:'',promptTemplate:'',allowPreEdit:!1}),s=(0,p.ref)(!1),u=(0,p.ref)(''),d=(0,p.ref)(''),m=(0,p.ref)(!0),f=(0,p.ref)(!1),g=(0,p.ref)(!1),v=(0,p.ref)(''),b='{{value}}',h='{{rowTitle}}',x='{{user}}',y=(0,p.computed)(()=>!a.tag),w=(0,p.computed)(()=>n.library.categories),k=(0,p.computed)(()=>c.value.label.trim().length>0),C=(0,p.computed)(()=>c.value.categoryId&&w.value.find(e=>e.id===c.value.categoryId)||null),N=(0,p.computed)(()=>v.value&&w.value.find(e=>e.id===v.value)||null);function V(){o('update:visible',!1),o('close')}function E(){if(!k.value)return;const e={id:a.tag?.id||`tag_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,label:c.value.label.trim(),categoryId:c.value.categoryId,promptTemplate:c.value.promptTemplate,createdAt:a.tag?.createdAt||(new Date).toISOString(),allowPreEdit:c.value.allowPreEdit};n.upsertTag(e),o('saved',e),V()}function B(e){if(!i.value)return;const t=i.value,a=t.selectionStart,o=t.selectionEnd,n=c.value.promptTemplate;c.value.promptTemplate=n.slice(0,a)+e+n.slice(o),(0,p.nextTick)(()=>{t.focus(),t.setSelectionRange(a+e.length,a+e.length)})}function S(){let e=u.value.trim();if(!e)return;N.value&&(e=N.value.path+'/'+e);const t=n.addCategory(e,d.value||void 0);c.value.categoryId=t.id,s.value=!1,u.value='',d.value='',v.value=''}function T(){r.openIconSelectDialog({currentIcon:d.value},{onSelect:e=>{d.value=e}})}function D(e){return e.startsWith('fa')||e.includes(' fa-')}function A(){f.value=!f.value}function I(e){c.value.categoryId=e,f.value=!1}function U(){g.value=!g.value}function M(e){v.value=e,g.value=!1}function L(){f.value=!1,g.value=!1}return(0,p.watch)(()=>a.visible,e=>{e&&(a.tag?c.value={label:a.tag.label,categoryId:a.tag.categoryId,promptTemplate:a.tag.promptTemplate,allowPreEdit:a.tag.allowPreEdit||!1}:c.value={label:'',categoryId:a.defaultCategoryId,promptTemplate:'',allowPreEdit:!1},s.value=!1,u.value='',d.value='',f.value=!1,g.value=!1,v.value='',(0,p.nextTick)(()=>{l.value?.focus()}))}),(0,p.watch)([f,g],([e,t])=>{e||t?setTimeout(()=>window.addEventListener('click',L),0):window.removeEventListener('click',L)}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(V,['self'])},[(0,p.createElementVNode)('div',KC,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',qC,[(0,p.createElementVNode)('span',JC,(0,p.toDisplayString)(y.value?'新建标签':'编辑标签'),1),(0,p.createElementVNode)('div',ZC,[(0,p.createElementVNode)('button',{class:'acu-close-pill',disabled:!k.value,onClick:(0,p.withModifiers)(E,['stop'])},'保存',8,QC),(0,p.createElementVNode)('button',{class:'acu-icon-btn',title:'关闭',onClick:(0,p.withModifiers)(V,['stop'])},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',eN,[(0,p.createCommentVNode)(' 标签文本 '),(0,p.createElementVNode)('div',tN,[a[26]||(a[26]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-tag'}),(0,p.createTextVNode)(' 基本信息 ')],-1)),(0,p.createElementVNode)('div',aN,[(0,p.createCommentVNode)(' 标签文本 '),(0,p.createElementVNode)('div',oN,[a[13]||(a[13]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 标签文本 '),(0,p.createElementVNode)('span',{class:'hint'},'标签显示的文字内容')],-1)),(0,p.createElementVNode)('div',nN,[(0,p.withDirectives)((0,p.createElementVNode)('input',{ref_key:'labelInput',ref:l,'onUpdate:modelValue':a[0]||(a[0]=e=>c.value.label=e),type:'text',placeholder:'输入标签文本'},null,512),[[p.vModelText,c.value.label]])])]),(0,p.createCommentVNode)(' 分类选择 '),(0,p.createElementVNode)('div',rN,[a[17]||(a[17]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 所属分类 '),(0,p.createElementVNode)('span',{class:'hint'},'选择或创建分类')],-1)),(0,p.createElementVNode)('div',lN,[(0,p.createCommentVNode)(' 自定义下拉框 '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-custom-select',{active:f.value}]),onClick:(0,p.withModifiers)(A,['stop'])},[(0,p.createElementVNode)('div',iN,[C.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[D(C.value.icon||'')?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(C.value.icon)},null,2)):C.value.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',cN,(0,p.toDisplayString)(C.value.icon),1)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',sN,(0,p.toDisplayString)(C.value.path),1)],64)):((0,p.openBlock)(),(0,p.createElementBlock)('span',uN,'未分类'))]),a[15]||(a[15]=(0,p.createElementVNode)('i',{class:'fas fa-chevron-down arrow'},null,-1)),(0,p.createCommentVNode)(' 下拉菜单 '),f.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',dN,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['dropdown-item',{selected:''===c.value.categoryId}]),onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>I(''),['stop']))},[...a[14]||(a[14]=[(0,p.createElementVNode)('span',{class:'text'},'未分类',-1)])],2),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(w.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['dropdown-item',{selected:c.value.categoryId===e.id}]),onClick:(0,p.withModifiers)(t=>I(e.id),['stop'])},[D(e.icon||'')?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(e.icon)},null,2)):e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',mN,(0,p.toDisplayString)(e.icon),1)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',fN,(0,p.toDisplayString)(e.path),1)],10,pN))),128))])):(0,p.createCommentVNode)('v-if',!0)],2),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'新增分类',onClick:a[2]||(a[2]=(0,p.withModifiers)(e=>s.value=!0,['stop']))},[...a[16]||(a[16]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1)])])])]),(0,p.createCommentVNode)(' 新增分类输入（条件显示） '),s.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createCommentVNode)(' 上级分类选择 '),(0,p.createElementVNode)('div',gN,[a[20]||(a[20]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 上级分类 '),(0,p.createElementVNode)('span',{class:'hint'},'可选：在此分类下创建子分类')],-1)),(0,p.createElementVNode)('div',vN,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-custom-select',{active:g.value}]),onClick:(0,p.withModifiers)(U,['stop'])},[(0,p.createElementVNode)('div',bN,[N.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[D(N.value.icon||'')?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(N.value.icon)},null,2)):N.value.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',hN,(0,p.toDisplayString)(N.value.icon),1)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',xN,(0,p.toDisplayString)(N.value.path),1)],64)):((0,p.openBlock)(),(0,p.createElementBlock)('span',yN,'无'))]),a[19]||(a[19]=(0,p.createElementVNode)('i',{class:'fas fa-chevron-down arrow'},null,-1)),g.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',wN,[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['dropdown-item',{selected:''===v.value}]),onClick:a[3]||(a[3]=(0,p.withModifiers)(e=>M(''),['stop']))},[...a[18]||(a[18]=[(0,p.createElementVNode)('span',{class:'text'},'无',-1)])],2),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(w.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['dropdown-item',{selected:v.value===e.id}]),onClick:(0,p.withModifiers)(t=>M(e.id),['stop'])},[D(e.icon||'')?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(e.icon)},null,2)):e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',CN,(0,p.toDisplayString)(e.icon),1)):(0,p.createCommentVNode)('v-if',!0),(0,p.createElementVNode)('span',NN,(0,p.toDisplayString)(e.path),1)],10,kN))),128))])):(0,p.createCommentVNode)('v-if',!0)],2)])]),(0,p.createElementVNode)('div',VN,[a[23]||(a[23]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 新分类 '),(0,p.createElementVNode)('span',{class:'hint'},'路径格式如：互动/日常')],-1)),(0,p.createElementVNode)('div',EN,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[4]||(a[4]=e=>u.value=e),type:'text',placeholder:'分类路径',onKeyup:(0,p.withKeys)(S,['enter'])},null,544),[[p.vModelText,u.value]]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'选择图标',onClick:(0,p.withModifiers)(T,['stop'])},[D(d.value)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(d.value)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',BN,(0,p.toDisplayString)(d.value||'图标'),1))]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'确认',onClick:(0,p.withModifiers)(S,['stop'])},[...a[21]||(a[21]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)])]),(0,p.createElementVNode)('button',{class:'acu-tool-btn',title:'取消',onClick:a[5]||(a[5]=(0,p.withModifiers)(e=>s.value=!1,['stop']))},[...a[22]||(a[22]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])])])],64)):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 二次编辑开关 '),(0,p.createElementVNode)('div',SN,[a[25]||(a[25]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 追加前二次编辑 '),(0,p.createElementVNode)('span',{class:'hint'},'点击标签时弹出编辑器，可修改后再追加')],-1)),(0,p.createElementVNode)('div',TN,[(0,p.createElementVNode)('label',DN,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[6]||(a[6]=e=>c.value.allowPreEdit=e),type:'checkbox'},null,512),[[p.vModelCheckbox,c.value.allowPreEdit]]),a[24]||(a[24]=(0,p.createElementVNode)('span',{class:'slider'},null,-1))])])])])]),(0,p.createCommentVNode)(' 提示词模板 '),(0,p.createElementVNode)('div',AN,[a[34]||(a[34]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-file-alt'}),(0,p.createTextVNode)(' 提示词模板 ')],-1)),(0,p.createElementVNode)('div',zN,[(0,p.createElementVNode)('div',IN,[a[27]||(a[27]=(0,p.createElementVNode)('div',{class:'acu-settings-label'},[(0,p.createTextVNode)(' 模板内容 '),(0,p.createElementVNode)('span',{class:'hint'},'支持通配符替换')],-1)),(0,p.createElementVNode)('div',_N,[(0,p.withDirectives)((0,p.createElementVNode)('textarea',{ref_key:'promptInput',ref:i,'onUpdate:modelValue':a[7]||(a[7]=e=>c.value.promptTemplate=e),class:'acu-textarea',placeholder:'输入提示词模板，支持通配符',rows:'4'},null,512),[[p.vModelText,c.value.promptTemplate]])])]),(0,p.createCommentVNode)(' 通配符快捷按钮 '),(0,p.createElementVNode)('div',UN,[a[28]||(a[28]=(0,p.createElementVNode)('span',{class:'hint'},'点击插入:',-1)),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[8]||(a[8]=(0,p.withModifiers)(e=>B(b),['stop']))},[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(b)},null,8,MN)]),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[9]||(a[9]=(0,p.withModifiers)(e=>B(h),['stop']))},[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(h)},null,8,LN)]),(0,p.createElementVNode)('button',{class:'acu-wildcard-btn',onClick:a[10]||(a[10]=(0,p.withModifiers)(e=>B(x),['stop']))},[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(x)},null,8,$N)])]),(0,p.createCommentVNode)(' 通配符说明 '),(0,p.createElementVNode)('div',PN,[(0,p.createElementVNode)('div',{class:'acu-help-header',onClick:a[11]||(a[11]=e=>m.value=!m.value)},[a[29]||(a[29]=(0,p.createElementVNode)('i',{class:'fas fa-lightbulb'},null,-1)),a[30]||(a[30]=(0,p.createElementVNode)('strong',null,'通配符说明',-1)),(0,p.createElementVNode)('i',{class:(0,p.normalizeClass)(['fas',m.value?'fa-chevron-up':'fa-chevron-down'])},null,2)]),m.value?((0,p.openBlock)(),(0,p.createElementBlock)('ul',FN,[(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(b)},null,8,jN),a[31]||(a[31]=(0,p.createTextVNode)(' - 标签本身的值（label）',-1))]),(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(h)},null,8,RN),a[32]||(a[32]=(0,p.createTextVNode)(' - 当前行标题',-1))]),(0,p.createElementVNode)('li',null,[(0,p.createElementVNode)('code',{textContent:(0,p.toDisplayString)(x)},null,8,ON),a[33]||(a[33]=(0,p.createTextVNode)(' - 主角名（酒馆宏）',-1))])])):(0,p.createCommentVNode)('v-if',!0)])])])])])])):(0,p.createCommentVNode)('v-if',!0)}}),WN={class:'acu-modal acu-import-modal'},GN={class:'acu-modal-header'},YN={class:'acu-modal-body'},XN={key:0,class:'acu-import-upload'},KN={class:'acu-import-preview'},qN={class:'acu-import-stats'},JN={class:'acu-stat-item'},ZN={class:'acu-stat-value'},QN={class:'acu-stat-item'},eV={class:'acu-stat-value'},tV={key:0,class:'acu-stat-item acu-stat-conflict'},aV={class:'acu-stat-value'},oV={key:0,class:'acu-conflict-options'},nV={class:'acu-settings-group'},rV={class:'acu-radio-option'},lV={class:'acu-radio-option'},iV={class:'acu-import-list'},cV={class:'acu-preview-scroll'},sV={key:0,class:'acu-preview-section'},uV={class:'acu-preview-header'},dV={class:'acu-preview-items'},pV={key:0,class:'acu-preview-more'},mV={key:1,class:'acu-preview-section'},fV={class:'acu-preview-header'},gV={class:'acu-preview-items'},vV={key:0,class:'acu-preview-more'},bV={class:'acu-import-actions'},hV={key:2,class:'acu-import-error'},xV=(0,p.defineComponent)({__name:'TagImportDialog',props:{visible:{type:Boolean}},emits:['update:visible','imported'],setup(e,{emit:t}){const a=t,o=Ko(),n=(0,p.ref)(null),r=(0,p.ref)(null),l=(0,p.ref)('rename'),i=(0,p.ref)(''),c=(0,p.computed)(()=>{if(!r.value)return{categories:0,tags:0,conflicts:0};let e=0;return r.value.tags.forEach(t=>{g(t)&&e++}),{categories:r.value.categories.length,tags:r.value.tags.length,conflicts:e}});function s(){v(),a('update:visible',!1)}function u(){n.value?.click()}function d(e){const t=e.target,a=t.files?.[0];a&&f(a)}function m(e){const t=e.dataTransfer?.files?.[0];t&&'application/json'===t.type?f(t):i.value='请选择 JSON 文件'}async function f(e){i.value='';try{const t=await e.text(),a=JSON.parse(t);if(!a.version||!Array.isArray(a.categories)||!Array.isArray(a.tags))throw new Error('无效的标签库文件格式');r.value=a}catch(e){i.value=e instanceof Error?e.message:'解析文件失败',r.value=null}}function g(e){const t=o.getCategoryByPath(e.category)?.id||'';return o.library.tags.some(a=>a.label===e.label&&a.categoryId===t)}function v(){r.value=null,i.value='',l.value='rename',n.value&&(n.value.value='')}function b(){if(!r.value)return;const e=o.importLibrary(r.value,{conflictStrategy:l.value});e.success?(a('imported',{addedTags:e.addedTags+e.renamedTags,addedCategories:e.addedCategories}),s()):i.value=e.error||'导入失败'}return(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(s,['self'])},[(0,p.createElementVNode)('div',WN,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',GN,[a[3]||(a[3]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-file-import'}),(0,p.createTextVNode)(' 导入标签库 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(s,['stop'])},'关闭')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',YN,[(0,p.createCommentVNode)(' 文件选择 '),r.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 导入预览 '),(0,p.createElementVNode)('div',KN,[(0,p.createCommentVNode)(' 统计信息 '),(0,p.createElementVNode)('div',qN,[(0,p.createElementVNode)('div',JN,[a[5]||(a[5]=(0,p.createElementVNode)('i',{class:'fas fa-folder'},null,-1)),(0,p.createElementVNode)('span',ZN,(0,p.toDisplayString)(c.value.categories),1),a[6]||(a[6]=(0,p.createElementVNode)('span',{class:'acu-stat-label'},'分类',-1))]),(0,p.createElementVNode)('div',QN,[a[7]||(a[7]=(0,p.createElementVNode)('i',{class:'fas fa-tag'},null,-1)),(0,p.createElementVNode)('span',eV,(0,p.toDisplayString)(c.value.tags),1),a[8]||(a[8]=(0,p.createElementVNode)('span',{class:'acu-stat-label'},'标签',-1))]),c.value.conflicts>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',tV,[a[9]||(a[9]=(0,p.createElementVNode)('i',{class:'fas fa-exclamation-triangle'},null,-1)),(0,p.createElementVNode)('span',aV,(0,p.toDisplayString)(c.value.conflicts),1),a[10]||(a[10]=(0,p.createElementVNode)('span',{class:'acu-stat-label'},'冲突',-1))])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 冲突处理选项 '),c.value.conflicts>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',oV,[a[15]||(a[15]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-cog'}),(0,p.createTextVNode)(' 冲突处理 ')],-1)),(0,p.createElementVNode)('div',nV,[(0,p.createElementVNode)('label',rV,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[1]||(a[1]=e=>l.value=e),type:'radio',value:'overwrite'},null,512),[[p.vModelRadio,l.value]]),a[11]||(a[11]=(0,p.createElementVNode)('span',null,'覆盖现有标签',-1)),a[12]||(a[12]=(0,p.createElementVNode)('span',{class:'hint'},'用导入的内容替换同名标签',-1))]),(0,p.createElementVNode)('label',lV,[(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[2]||(a[2]=e=>l.value=e),type:'radio',value:'rename'},null,512),[[p.vModelRadio,l.value]]),a[13]||(a[13]=(0,p.createElementVNode)('span',null,'重命名导入标签',-1)),a[14]||(a[14]=(0,p.createElementVNode)('span',{class:'hint'},'为冲突的标签添加序号后缀',-1))])])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 预览列表 '),(0,p.createElementVNode)('div',iV,[a[16]||(a[16]=(0,p.createElementVNode)('div',{class:'acu-settings-title'},[(0,p.createElementVNode)('i',{class:'fas fa-list'}),(0,p.createTextVNode)(' 导入内容预览 ')],-1)),(0,p.createElementVNode)('div',cV,[(0,p.createCommentVNode)(' 分类 '),r.value.categories.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',sV,[(0,p.createElementVNode)('div',uV,'分类 ('+(0,p.toDisplayString)(r.value.categories.length)+')',1),(0,p.createElementVNode)('div',dV,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value.categories.slice(0,10),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-preview-item'},(0,p.toDisplayString)(e.icon?e.icon+' ':'')+(0,p.toDisplayString)(e.path),1))),128)),r.value.categories.length>10?((0,p.openBlock)(),(0,p.createElementBlock)('span',pV,' 还有 '+(0,p.toDisplayString)(r.value.categories.length-10)+' 个... ',1)):(0,p.createCommentVNode)('v-if',!0)])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 标签 '),r.value.tags.length>0?((0,p.openBlock)(),(0,p.createElementBlock)('div',mV,[(0,p.createElementVNode)('div',fV,'标签 ('+(0,p.toDisplayString)(r.value.tags.length)+')',1),(0,p.createElementVNode)('div',gV,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(r.value.tags.slice(0,20),e=>((0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:(0,p.normalizeClass)(['acu-preview-item',{conflict:g(e)}])},(0,p.toDisplayString)(e.label),3))),128)),r.value.tags.length>20?((0,p.openBlock)(),(0,p.createElementBlock)('span',vV,' 还有 '+(0,p.toDisplayString)(r.value.tags.length-20)+' 个... ',1)):(0,p.createCommentVNode)('v-if',!0)])])):(0,p.createCommentVNode)('v-if',!0)])]),(0,p.createCommentVNode)(' 操作按钮 '),(0,p.createElementVNode)('div',bV,[(0,p.createElementVNode)('button',{class:'acu-btn-secondary',onClick:(0,p.withModifiers)(v,['stop'])},[...a[17]||(a[17]=[(0,p.createElementVNode)('i',{class:'fas fa-redo'},null,-1),(0,p.createTextVNode)(' 重新选择',-1)])]),(0,p.createElementVNode)('button',{class:'acu-btn-primary',onClick:(0,p.withModifiers)(b,['stop'])},[...a[18]||(a[18]=[(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1),(0,p.createTextVNode)(' 确认导入',-1)])])])])],2112)):((0,p.openBlock)(),(0,p.createElementBlock)('div',XN,[(0,p.createElementVNode)('div',{class:'acu-upload-area',onClick:u,onDragover:a[0]||(a[0]=(0,p.withModifiers)(()=>{},['prevent'])),onDrop:(0,p.withModifiers)(m,['prevent'])},[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-cloud-upload-alt'},null,-1),(0,p.createElementVNode)('p',null,'点击选择文件或拖拽 JSON 文件到此处',-1),(0,p.createElementVNode)('span',{class:'hint'},'支持从其他设备导出的标签库文件',-1)])],32),(0,p.createElementVNode)('input',{ref_key:'fileInput',ref:n,type:'file',accept:'.json',style:{display:'none'},onChange:d},null,544)])),(0,p.createCommentVNode)(' 错误提示 '),i.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',hV,[a[19]||(a[19]=(0,p.createElementVNode)('i',{class:'fas fa-exclamation-circle'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(i.value),1)])):(0,p.createCommentVNode)('v-if',!0)])])])):(0,p.createCommentVNode)('v-if',!0)}}),yV={class:'acu-modal acu-tag-manager-modal'},wV={class:'acu-modal-header'},kV={class:'acu-modal-body acu-tag-manager-body'},CV={class:'acu-displayed-area'},NV=['onClick'],VV={key:0,class:'acu-tag-icon'},EV={key:1},BV={key:1,class:'acu-empty-hint'},SV={class:'acu-tag-search'},TV={class:'acu-tag-toolbar'},DV={key:0,class:'mode-actions'},AV=['disabled'],zV={class:'acu-tag-manager'},IV=(0,p.defineComponent)({__name:'TagManagerDialog',props:{visible:{type:Boolean},displayedTagIds:{},displayedCategoryIds:{default:()=>[]}},emits:['update:visible','save','close'],setup(e,{emit:t}){const a=e,o=t,n=Ko(),r=(0,p.ref)(''),l=(0,p.ref)(!1),i=(0,p.ref)(!1),c=(0,p.ref)(null),s=(0,p.ref)(''),u=(0,p.ref)([]),d=(0,p.ref)([]),m=(0,p.computed)(()=>n.currentMode),f=(0,p.computed)(()=>n.selectedTagIds),g=(0,p.computed)(()=>n.filteredTags),v=(0,p.computed)(()=>0!==g.value.length&&g.value.every(e=>f.value.has(e.id))),b=(0,p.computed)(()=>{const e=[];return d.value.forEach(t=>{const a=n.getCategoryById(t);a&&e.push({id:t,type:'category',label:a.path,icon:a.icon})}),u.value.forEach(t=>{const a=n.getTagById(t);a&&e.push({id:t,type:'tag',label:a.label})}),e}),h=(0,p.computed)(()=>u.value);function x(){n.setMode('normal'),o('save',[...u.value],[...d.value]),o('update:visible',!1),o('close')}function y(e){m.value===e?(n.setMode('normal'),k('已退出'+w(e)+'模式')):(n.setMode(e),k(w(e)+'模式已启用'))}function w(e){return{normal:'普通',create:'新建',add:'展示',delete:'删除',migrate:'迁移',export:'导出'}[e]||e}function k(e){'undefined'!=typeof toastr&&toastr.info(e,'',{timeOut:2e3})}function C(){n.searchKeyword=r.value}function N(){r.value='',n.searchKeyword=''}function V(e){'add'===m.value&&e&&U(e.id)}function E(e){const t=n.selectedCategoryIds,a=f.value.size,o=t.size;if(0===a&&0===o)return void k('请先选中要迁移的标签或分类');'root'===e?n.migrateSelectedItems(''):n.migrateSelectedItems(e);const r=[];a>0&&r.push(`${a} 个标签`),o>0&&r.push(`${o} 个分类`);const l='root'===e?'根目录':'目标分类';k('已迁移 '+r.join(' 和 ')+' 到'+l),n.setMode('normal')}function B(e){if('root'===e)return void(confirm('确定要清空所有标签和分类吗？此操作不可撤销！')&&(n.clearAll(),u.value=[],d.value=[],k('已清空所有标签和分类')));const t=n.getCategoryById(e);t&&(n.deleteCategory(e),k('已删除分类：'+t.path),L(e))}function S(e){'add'===m.value?A(e.id):'normal'!==m.value&&'create'!==m.value||(c.value=e,l.value=!0)}function T(){c.value=null;const e=n.selectedLevel1;if(e&&'全部'!==e&&'未分类'!==e){const t=n.getCategoryByPath(e);s.value=t?.id||''}else s.value='';l.value=!0}function D(e){const t=n.getTagById(e);t&&(n.deleteTag(e),k('已删除标签：'+t.label),M(e))}function A(e){if(u.value.includes(e))k('该标签已在展示区');else{u.value=[...u.value,e];const t=n.getTagById(e);t&&k('已添加：'+t.label)}}function I(e){'root'!==e?U(e):d.value.includes('root')?k('根目录已在展示区'):(d.value=[...d.value,'root'],k('已添加：根目录'))}function U(e){if(d.value.includes(e))k('该分类已在展示区');else{d.value=[...d.value,e];const t=n.getCategoryById(e);t&&k('已添加分类：'+t.path)}}function M(e){u.value=u.value.filter(t=>t!==e)}function L(e){d.value=d.value.filter(t=>t!==e)}function P(e){k('已保存：'+e.label)}function F(){c.value=null}function j(){i.value=!0}function R(e){k(`已导入 ${e.addedCategories} 个分类，${e.addedTags} 个标签`)}function O(){v.value?g.value.forEach(e=>{f.value.has(e.id)&&n.toggleTagSelection(e.id)}):g.value.forEach(e=>{f.value.has(e.id)||n.toggleTagSelection(e.id)})}function H(){G(n.exportLibrary('all'),'tag-library-all.json'),n.setMode('normal')}function W(){G(n.exportLibrary('selected'),'tag-library-selected.json'),n.setMode('normal')}function G(e,t){const a=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),o=URL.createObjectURL(a),n=document.createElement('a');n.href=o,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),k('导出成功')}return(0,p.onMounted)(async()=>{await n.loadLibrary()}),(0,p.watch)(()=>a.visible,e=>{e&&(n.setMode('normal'),n.resetSelection(),r.value='',u.value=[...a.displayedTagIds],d.value=[...a.displayedCategoryIds])}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(x,['self'])},[(0,p.createElementVNode)('div',yV,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',wV,[a[7]||(a[7]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-tags'}),(0,p.createTextVNode)(' 标签管理器 ')],-1)),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(x,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',kV,[(0,p.createCommentVNode)(' 已展示区（顶部） '),(0,p.createElementVNode)('div',CV,[a[9]||(a[9]=(0,p.createElementVNode)('span',{class:'acu-displayed-label'},'已展示：',-1)),b.value.length>0?((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,{key:0},(0,p.renderList)(b.value,e=>{return(0,p.openBlock)(),(0,p.createElementBlock)('span',{key:e.id,class:'acu-displayed-tag',onClick:(0,p.withModifiers)(t=>function(e){'tag'===e.type?M(e.id):L(e.id)}(e),['stop'])},[e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',VV,[(t=e.icon,t.startsWith('fa')||t.includes(' fa-')?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(e.icon)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',EV,(0,p.toDisplayString)(e.icon),1)))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(e.label)+' ',1),a[8]||(a[8]=(0,p.createElementVNode)('i',{class:'fas fa-times acu-remove-icon'},null,-1))],8,NV);var t}),128)):((0,p.openBlock)(),(0,p.createElementBlock)('span',BV,'点击下方标签或分类添加到展示区'))]),(0,p.createCommentVNode)(' 搜索栏 '),(0,p.createElementVNode)('div',SV,[a[11]||(a[11]=(0,p.createElementVNode)('i',{class:'fas fa-search'},null,-1)),(0,p.withDirectives)((0,p.createElementVNode)('input',{'onUpdate:modelValue':a[0]||(a[0]=e=>r.value=e),type:'text',placeholder:'搜索标签...',onInput:C},null,544),[[p.vModelText,r.value]]),r.value?((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:0,class:'acu-clear-search',onClick:(0,p.withModifiers)(N,['stop'])},[...a[10]||(a[10]=[(0,p.createElementVNode)('i',{class:'fas fa-times'},null,-1)])])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 工具栏 '),(0,p.createElementVNode)('div',TV,[(0,p.createCommentVNode)(' 模式按钮 '),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-mode-btn',{active:'add'===m.value}]),title:'展示模式：点击标签/分类添加到展示区',onClick:a[1]||(a[1]=(0,p.withModifiers)(e=>y('add'),['stop']))},[...a[12]||(a[12]=[(0,p.createElementVNode)('i',{class:'fas fa-eye'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'展示',-1)])],2),(0,p.createElementVNode)('button',{class:'acu-mode-btn',title:'新建标签',onClick:(0,p.withModifiers)(T,['stop'])},[...a[13]||(a[13]=[(0,p.createElementVNode)('i',{class:'fas fa-plus'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'新建',-1)])]),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-mode-btn',{active:'delete'===m.value}]),title:'删除模式：点击标签/分类立即删除',onClick:a[2]||(a[2]=(0,p.withModifiers)(e=>y('delete'),['stop']))},[...a[14]||(a[14]=[(0,p.createElementVNode)('i',{class:'fas fa-trash'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'删除',-1)])],2),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-mode-btn',{active:'migrate'===m.value}]),title:'迁移模式：选中标签后点击目标分类迁入',onClick:a[3]||(a[3]=(0,p.withModifiers)(e=>y('migrate'),['stop']))},[...a[15]||(a[15]=[(0,p.createElementVNode)('i',{class:'fas fa-arrows-alt'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'迁移',-1)])],2),(0,p.createElementVNode)('button',{class:'acu-mode-btn',title:'导入标签库',onClick:(0,p.withModifiers)(j,['stop'])},[...a[16]||(a[16]=[(0,p.createElementVNode)('i',{class:'fas fa-file-import'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'导入',-1)])]),(0,p.createElementVNode)('button',{class:(0,p.normalizeClass)(['acu-mode-btn',{active:'export'===m.value}]),title:'导出模式：选择要导出的标签',onClick:a[4]||(a[4]=(0,p.withModifiers)(e=>y('export'),['stop']))},[...a[17]||(a[17]=[(0,p.createElementVNode)('i',{class:'fas fa-file-export'},null,-1),(0,p.createElementVNode)('span',{class:'btn-label'},'导出',-1)])],2),(0,p.createCommentVNode)(' 迁移/导出模式额外按钮 '),'migrate'===m.value||'export'===m.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',DV,[(0,p.createElementVNode)('button',{class:'acu-mode-btn',onClick:(0,p.withModifiers)(O,['stop'])},[a[18]||(a[18]=(0,p.createElementVNode)('i',{class:'fas fa-check-double'},null,-1)),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(v.value?'取消全选':'全选当前'),1)]),'export'===m.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:0},[(0,p.createElementVNode)('button',{class:'acu-mode-btn',onClick:(0,p.withModifiers)(H,['stop'])},[...a[19]||(a[19]=[(0,p.createElementVNode)('i',{class:'fas fa-download'},null,-1),(0,p.createTextVNode)(' 全部导出 ',-1)])]),(0,p.createElementVNode)('button',{class:'acu-mode-btn',disabled:0===f.value.size,onClick:(0,p.withModifiers)(W,['stop'])},[a[20]||(a[20]=(0,p.createElementVNode)('i',{class:'fas fa-check'},null,-1)),(0,p.createTextVNode)(' 导出选中 ('+(0,p.toDisplayString)(f.value.size)+') ',1)],8,AV)],64)):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0)]),(0,p.createCommentVNode)(' 双栏布局 '),(0,p.createElementVNode)('div',zV,[(0,p.createCommentVNode)(' 左侧：目录树 '),(0,p.createVNode)(XC,{mode:m.value,onCategoryClick:V,onAddCategory:I,onMigrateToCategory:E,onDeleteCategory:B},null,8,['mode']),(0,p.createCommentVNode)(' 右侧：标签网格 '),(0,p.createVNode)(SC,{mode:m.value,'displayed-tag-ids':h.value,onTagClick:S,onCreateTag:T,onDeleteTag:D,onAddTag:A},null,8,['mode','displayed-tag-ids'])])])]),(0,p.createCommentVNode)(' 编辑弹窗 '),(0,p.createVNode)(HN,{visible:l.value,'onUpdate:visible':a[5]||(a[5]=e=>l.value=e),tag:c.value,'default-category-id':s.value,onSaved:P,onClose:F},null,8,['visible','tag','default-category-id']),(0,p.createCommentVNode)(' 导入弹窗 '),i.value?((0,p.openBlock)(),(0,p.createBlock)(xV,{key:0,visible:i.value,'onUpdate:visible':a[6]||(a[6]=e=>i.value=e),onImported:R},null,8,['visible'])):(0,p.createCommentVNode)('v-if',!0)])):(0,p.createCommentVNode)('v-if',!0)}}),_V={class:'acu-modal-header'},UV={class:'acu-modal-title'},MV={key:0,class:'acu-category-icon'},LV={key:1},$V={class:'acu-modal-body'},PV={key:0,class:'acu-category-select-dual'},FV={class:'acu-category-tree'},jV={class:'acu-tree-count'},RV=['onClick'],OV={key:0,class:'acu-tree-icon'},HV={key:1},WV={key:1,class:'acu-tree-icon'},GV={class:'acu-tree-label'},YV={class:'acu-tree-count'},XV={class:'acu-category-tags-grid'},KV=['onClick'],qV={key:0,class:'acu-tags-empty'},JV={class:'acu-category-tags-only'},ZV={class:'acu-tags-scroll'},QV=['onClick'],eE={key:0,class:'acu-tags-empty'},tE={class:'acu-modal-footer',style:{'justify-content':'flex-start','margin-top':'0','padding-top':'12px','border-top':'1px solid var(--acu-border)'}},aE=(0,p.defineComponent)({__name:'CategorySelectPopup',props:{visible:{type:Boolean},categoryId:{},rowContext:{default:()=>({title:'',value:''})},widgetId:{default:''}},emits:['update:visible','select','close'],setup(e,{emit:t}){const a=e,o=t,n=Ko(),r=Ea(),l=Uo(),i=(0,p.ref)(null),c=(0,p.computed)(()=>n.getCategoryById(a.categoryId)),s=(0,p.computed)(()=>{if(!c.value)return'未知分类';const e=c.value.path.split('/');return e[e.length-1]}),u=(0,p.computed)(()=>{if(!c.value)return[];const e=c.value.path;return n.library.categories.filter(t=>{if(!t.path.startsWith(e+'/'))return!1;return!t.path.slice(e.length+1).includes('/')})}),d=(0,p.computed)(()=>u.value.length>0),m=(0,p.computed)(()=>{if(!c.value)return[];const e=new Set;return n.library.categories.forEach(t=>{(t.path===c.value.path||t.path.startsWith(c.value.path+'/'))&&e.add(t.id)}),n.library.tags.filter(t=>e.has(t.categoryId))}),f=(0,p.computed)(()=>m.value.length),g=(0,p.computed)(()=>{if(null===i.value)return m.value;const e=n.getCategoryById(i.value);if(!e)return[];const t=new Set;return n.library.categories.forEach(a=>{(a.path===e.path||a.path.startsWith(e.path+'/'))&&t.add(a.id)}),n.library.tags.filter(e=>t.has(e.categoryId))});function v(e){const t=e.path.split('/');return t[t.length-1]}function b(e){const t=n.getCategoryById(e);if(!t)return 0;const a=new Set;return n.library.categories.forEach(e=>{(e.path===t.path||e.path.startsWith(t.path+'/'))&&a.add(e.id)}),n.library.tags.filter(e=>a.has(e.categoryId)).length}function h(e){i.value=e}function x(){o('update:visible',!1),o('close')}function y(e){o('select',e,a.rowContext)}function w(){x();let e=[],t=[];if(a.widgetId){const o=l.getWidgetById(a.widgetId);o&&o.widgetTagConfig&&(e=o.widgetTagConfig.displayedTagIds||[],t=o.widgetTagConfig.displayedCategoryIds||[])}0===t.length&&a.categoryId&&(t=[a.categoryId]),r.openTagManagerDialog({widgetId:a.widgetId||'',displayedTagIds:e,displayedCategoryIds:t},(e,t)=>{if(a.widgetId){const o=l.getWidgetById(a.widgetId);o&&l.updateWidget(a.widgetId,{widgetTagConfig:{...o.widgetTagConfig,displayedTagIds:e,displayedCategoryIds:t}})}})}function k(e){return e.startsWith('fa')||e.includes(' fa-')}return(0,p.watch)(()=>a.visible,e=>{e&&(i.value=null)}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(x,['self'])},[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-modal acu-category-select-modal',{'has-subcategories':d.value}])},[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',_V,[(0,p.createElementVNode)('span',UV,[c.value?.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',MV,[k(c.value.icon)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(c.value.icon)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',LV,(0,p.toDisplayString)(c.value.icon),1))])):(0,p.createCommentVNode)('v-if',!0),(0,p.createTextVNode)(' '+(0,p.toDisplayString)(s.value),1)]),(0,p.createElementVNode)('button',{class:'acu-close-pill',onClick:(0,p.withModifiers)(x,['stop'])},'完成')]),(0,p.createCommentVNode)(' 内容区 '),(0,p.createElementVNode)('div',$V,[(0,p.createCommentVNode)(' 有子分类：左右布局 '),d.value?((0,p.openBlock)(),(0,p.createElementBlock)('div',PV,[(0,p.createCommentVNode)(' 左侧：子分类目录树 '),(0,p.createElementVNode)('div',FV,[(0,p.createCommentVNode)(' 全部（显示所有标签） '),(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-tree-item',{active:null===i.value}]),onClick:a[0]||(a[0]=(0,p.withModifiers)(e=>h(null),['stop']))},[a[1]||(a[1]=(0,p.createElementVNode)('span',{class:'acu-tree-icon'},'📦',-1)),a[2]||(a[2]=(0,p.createElementVNode)('span',{class:'acu-tree-label'},'全部',-1)),(0,p.createElementVNode)('span',jV,(0,p.toDisplayString)(f.value),1)],2),(0,p.createCommentVNode)(' 子分类列表 '),((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(u.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.id,class:(0,p.normalizeClass)(['acu-tree-item',{active:i.value===e.id}]),onClick:(0,p.withModifiers)(t=>h(e.id),['stop'])},[e.icon?((0,p.openBlock)(),(0,p.createElementBlock)('span',OV,[k(e.icon)?((0,p.openBlock)(),(0,p.createElementBlock)('i',{key:0,class:(0,p.normalizeClass)(e.icon)},null,2)):((0,p.openBlock)(),(0,p.createElementBlock)('span',HV,(0,p.toDisplayString)(e.icon),1))])):((0,p.openBlock)(),(0,p.createElementBlock)('span',WV,[...a[3]||(a[3]=[(0,p.createElementVNode)('i',{class:'fas fa-folder'},null,-1)])])),(0,p.createElementVNode)('span',GV,(0,p.toDisplayString)(v(e)),1),(0,p.createElementVNode)('span',YV,(0,p.toDisplayString)(b(e.id)),1)],10,RV))),128))]),(0,p.createCommentVNode)(' 右侧：标签网格 '),(0,p.createElementVNode)('div',XV,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(g.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:'acu-tag-btn',onClick:(0,p.withModifiers)(t=>y(e),['stop'])},(0,p.toDisplayString)(e.label),9,KV))),128)),(0,p.createCommentVNode)(' 空状态 '),0===g.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',qV,[...a[4]||(a[4]=[(0,p.createElementVNode)('i',{class:'fas fa-tag'},null,-1),(0,p.createElementVNode)('span',null,'暂无标签',-1)])])):(0,p.createCommentVNode)('v-if',!0)])])):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 无子分类：只显示标签滚动框 '),(0,p.createElementVNode)('div',JV,[(0,p.createElementVNode)('div',ZV,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(m.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('button',{key:e.id,class:'acu-tag-btn',onClick:(0,p.withModifiers)(t=>y(e),['stop'])},(0,p.toDisplayString)(e.label),9,QV))),128))]),(0,p.createCommentVNode)(' 空状态 '),0===m.value.length?((0,p.openBlock)(),(0,p.createElementBlock)('div',eE,[...a[5]||(a[5]=[(0,p.createElementVNode)('i',{class:'fas fa-tag'},null,-1),(0,p.createElementVNode)('span',null,'该分类下暂无标签',-1)])])):(0,p.createCommentVNode)('v-if',!0)])],2112))]),(0,p.createCommentVNode)(' 底部：管理入口 '),(0,p.createElementVNode)('div',tE,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary',onClick:(0,p.withModifiers)(w,['stop'])},[...a[6]||(a[6]=[(0,p.createElementVNode)('i',{class:'fas fa-tags'},null,-1),(0,p.createTextVNode)(' 管理标签 ',-1)])])])],2)])):(0,p.createCommentVNode)('v-if',!0)}}),oE={class:'acu-modal acu-pre-edit-modal'},nE={class:'acu-modal-header'},rE={class:'acu-header-actions'},lE=['disabled'],iE={class:'acu-modal-body'},cE={class:'acu-pre-edit-content'},sE={class:'acu-pre-edit-info-row'},uE={class:'acu-pre-edit-label'},dE=['onKeydown'],pE={key:0,class:'acu-companion-selector'},mE={class:'acu-avatar-list'},fE=['onClick'],gE=['src','alt'],vE={key:1,class:'acu-avatar-text-icon'},bE={class:'acu-avatar-name'},hE={key:0,class:'acu-avatar-empty'},xE=(0,p.defineComponent)({__name:'TagPreEditDialog',props:{visible:{type:Boolean},tagLabel:{default:''},resolvedPrompt:{default:''},showCompanions:{type:Boolean,default:!1},widgetId:{default:''}},emits:['update:visible','confirm','close'],setup(e,{emit:t}){const a=e,o=t,{setInput:n}=co(),{getAvatarUrl:r}=xo(),l=(Ea(),(0,p.inject)('allTables')),i=(0,p.ref)(null),c=(0,p.ref)(''),s=(0,p.ref)([]),u=(0,p.ref)(!1);function d(){o('update:visible',!1),o('close')}function m(){const e=c.value.trim();e&&(n(e),o('confirm',e),d())}return(0,p.watch)(()=>a.visible,async e=>{e&&(c.value=a.resolvedPrompt,a.showCompanions&&async function(){u.value=!0;try{const e=new Set,t=l?l():[];l||console.warn('[TagPreEditDialog] getAllTables injection failed'),console.log('[TagPreEditDialog] Loading avatars. Tables:',t.length),t.length>0&&t.forEach(t=>{if(st(t.name,t.id)){console.log('[TagPreEditDialog] Found character table:',t.name);let a=t.headers.findIndex(e=>['name','名称','姓名','角色'].includes(e.toLowerCase()));-1===a&&(a=t.headers.length>1?1:0),t.rows.forEach(t=>{const o=t.cells.find(e=>e.colIndex===a);o&&o.value&&String(o.value).trim()&&e.add(String(o.value).trim())})}});const a='undefined'!=typeof getVariables?getVariables({type:'chat'}):{},o=(a.acu_graph_config||{}).labels||{},n=await Promise.all(Array.from(e).map(async e=>{const t=await r(e),a=o[e];let n='';if(a?.selectedIndices&&a.selectedIndices.length>0)n=a.selectedIndices.map(t=>e[t]).join('');else{n=(a?.displayLabel||e).charAt(0)}return{name:e,displayUrl:t||'',textAvatar:n}}));s.value=n}catch(e){console.error('Failed to load avatars:',e)}finally{u.value=!1}}(),await(0,p.nextTick)(),i.value?.focus(),i.value?.setSelectionRange(c.value.length,c.value.length))}),(t,a)=>e.visible?((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:0,class:'acu-modal-container acu-center-modal',onClick:(0,p.withModifiers)(d,['self'])},[(0,p.createElementVNode)('div',oE,[(0,p.createCommentVNode)(' 头部 '),(0,p.createElementVNode)('div',nE,[a[2]||(a[2]=(0,p.createElementVNode)('span',{class:'acu-modal-title'},[(0,p.createElementVNode)('i',{class:'fas fa-edit'}),(0,p.createTextVNode)(' 编辑提示词 ')],-1)),(0,p.createElementVNode)('div',rE,[(0,p.createElementVNode)('button',{class:'acu-modal-btn secondary small',onClick:(0,p.withModifiers)(d,['stop'])},'取消'),(0,p.createElementVNode)('button',{class:'acu-modal-btn primary small',disabled:!c.value.trim(),onClick:(0,p.withModifiers)(m,['stop'])},[...a[1]||(a[1]=[(0,p.createElementVNode)('i',{class:'fas fa-paper-plane'},null,-1),(0,p.createTextVNode)(' 追加 ',-1)])],8,lE)])]),(0,p.createCommentVNode)(' 内容 '),(0,p.createElementVNode)('div',iE,[(0,p.createElementVNode)('div',cE,[(0,p.createCommentVNode)(' 标签信息 '),(0,p.createElementVNode)('div',sE,[(0,p.createElementVNode)('div',uE,'标签：'+(0,p.toDisplayString)(e.tagLabel),1)]),(0,p.createCommentVNode)(' 编辑区 '),(0,p.withDirectives)((0,p.createElementVNode)('textarea',{ref_key:'textareaRef',ref:i,'onUpdate:modelValue':a[0]||(a[0]=e=>c.value=e),class:'acu-pre-edit-textarea',placeholder:'输入要追加的内容...',onKeydown:[(0,p.withKeys)((0,p.withModifiers)(m,['ctrl']),['enter']),(0,p.withKeys)((0,p.withModifiers)(m,['meta']),['enter'])]},null,40,dE),[[p.vModelText,c.value]]),(0,p.createCommentVNode)(' 同伴选择器 '),e.showCompanions?((0,p.openBlock)(),(0,p.createElementBlock)('div',pE,[a[3]||(a[3]=(0,p.createElementVNode)('div',{class:'acu-companion-header'},[(0,p.createElementVNode)('i',{class:'fas fa-user-friends'}),(0,p.createTextVNode)(' 选择同伴 (点击插入) ')],-1)),(0,p.createElementVNode)('div',mE,[((0,p.openBlock)(!0),(0,p.createElementBlock)(p.Fragment,null,(0,p.renderList)(s.value,e=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{key:e.name,class:'acu-avatar-item',onClick:t=>function(e){const t=`和${e.name}`,a=c.value;if(a.includes('{{user}}')){const e=a.lastIndexOf('{{user}}')+8;c.value=a.slice(0,e)+t+a.slice(e)}else c.value=t+a;(0,p.nextTick)(()=>{i.value?.focus()})}(e)},[(0,p.createElementVNode)('div',{class:(0,p.normalizeClass)(['acu-avatar-img-wrapper',{'no-img':!e.displayUrl}])},[e.displayUrl?((0,p.openBlock)(),(0,p.createElementBlock)('img',{key:0,src:e.displayUrl,alt:e.name,loading:'lazy'},null,8,gE)):((0,p.openBlock)(),(0,p.createElementBlock)('span',vE,(0,p.toDisplayString)(e.textAvatar),1))],2),(0,p.createElementVNode)('span',bE,(0,p.toDisplayString)(e.name),1)],8,fE))),128)),0!==s.value.length||u.value?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createElementBlock)('div',hE,'暂无头像数据'))])])):(0,p.createCommentVNode)('v-if',!0),(0,p.createCommentVNode)(' 提示 '),a[4]||(a[4]=(0,p.createElementVNode)('div',{class:'acu-pre-edit-hint'},[(0,p.createElementVNode)('i',{class:'fas fa-lightbulb'}),(0,p.createElementVNode)('span',null,'按 Ctrl+Enter 快速追加')],-1))])])])])):(0,p.createCommentVNode)('v-if',!0)}}),yE=(0,p.defineComponent)({__name:'App',setup(e){const t=Ea(),a=ea(),o=Uo(),n=Ve(),r=Ko(),l=ua(),{init:i,cleanup:c}=Vt(),{saveToDatabase:s,getTableData:u,purgeFloorRange:d,stopAutoSave:m}=Qa(),{refresh:f}=Do(),{state:g}=(0,Aa.d)(),{setInput:v}=co(),{setHiddenPrompt:b,setupSendIntercept:h,cleanupSendIntercept:x}=io(),{performDivination:y,confirmDivination:w}=Wn();!function(){const e=(0,p.ref)(0),t=(0,p.ref)(0);let a=null,o=null;function n(a){const o=a.target;if(!o.closest?.('.acu-layout-horizontal .acu-panel-content'))return;const n=a.touches[0];e.value=n.clientX,t.value=n.clientY}function r(a){const o=a.target;if(!o.closest?.('.acu-layout-horizontal .acu-panel-content'))return;if('INPUT'===o.tagName||'TEXTAREA'===o.tagName||o.isContentEditable)return;let n=o,r=!1;for(;n&&n.classList&&!n.classList.contains('acu-panel-content');){if(n.scrollHeight>n.clientHeight){const e=window.getComputedStyle(n);if(['auto','scroll'].includes(e.overflowY)){r=!0;break}}n=n.parentElement}if(r)return;const l=a.touches[0],i=l.clientX-e.value,c=l.clientY-t.value;Math.abs(c)>Math.abs(i)&&a.cancelable&&a.preventDefault()}function l(){const e=window.parent?.document;e?(a=n,o=r,e.addEventListener('touchstart',a,{capture:!0,passive:!1}),e.addEventListener('touchmove',o,{capture:!0,passive:!1}),console.info('[ACU] 触摸滚动修复已安装（composable 管理）')):console.warn('[ACU] 无法访问父窗口 document，触摸滚动修复未安装')}function i(){const e=window.parent?.document;e&&(a&&(e.removeEventListener('touchstart',a,{capture:!0}),a=null),o&&(e.removeEventListener('touchmove',o,{capture:!0}),o=null),console.info('[ACU] 触摸滚动修复已卸载'))}(0,p.onMounted)(()=>{l()}),(0,p.onUnmounted)(()=>{i()})}(),Ga();const k=go(),C=(0,p.ref)(),N=(0,p.ref)(),V=(0,p.ref)();(0,p.provide)('allTables',()=>A.value);const E=(0,p.ref)(''),B=(0,p.ref)(!1),S=(0,p.reactive)({visible:!1,x:0,y:0,tableId:'',tableName:'',rowIndex:0,isDeleting:!1}),T=(0,p.computed)(()=>[`acu-theme-${n.config.theme}`,`acu-font-${n.config.fontFamily.replace(/\s+/g,'-').toLowerCase()}`,{'acu-mobile':t.isMobile,'acu-layout-horizontal':'horizontal'===n.config.layout,'acu-layout-vertical':'vertical'===n.config.layout}]),D=(0,p.computed)(()=>t.activeTab===ka?'ACU 仪表盘':t.activeTab===Ca?'ACU 选项面板':`ACU - ${t.activeTab||'可视化表格'}`),A=(0,p.computed)(()=>{const e=a.stagedData;if(!e)return[];const t=wt(e);return t?Object.entries(t).map(([e,t])=>{const{key:a,headers:o,rows:n}=t,r=n.map((t,a)=>{const n=t.map((e,t)=>({colIndex:t,key:o[t]||`col_${t}`,value:String(e??'')}));return{index:a,key:`${e}-row-${a}`,cells:n}});return{id:a,name:e,headers:o.map(e=>String(e)),rows:r}}):[]}),I=(0,p.computed)(()=>A.value.map(e=>({id:e.id,name:e.name,icon:G(e.name)}))),U=(0,p.computed)(()=>A.value.some(e=>e.name.includes('选项')||e.name.toLowerCase().includes('option'))),M=(0,p.computed)(()=>!0===n.config.collapseTabBar),L=(0,p.computed)(()=>A.value.filter(e=>e.name.includes('选项')||e.name.toLowerCase().includes('option'))),P=(0,p.computed)(()=>A.value.some(e=>st(e.name,e.id))),F=(0,p.computed)(()=>A.value.find(e=>{const t=e.name.toLowerCase(),a=e.id.toLowerCase();return t.includes('关系')||a.includes('relationship')||a.includes('relation')})||null),j=(0,p.computed)(()=>A.value.filter(e=>st(e.name,e.id))),R=(0,p.computed)(()=>{const e=['势力','faction','组织','organization','阵营','帮派','宗门','门派','派系'];return A.value.find(t=>{const a=t.name.toLowerCase(),o=t.id.toLowerCase();return e.some(e=>a.includes(e)||o.includes(e))})||null}),O=((0,p.computed)(()=>{const e=new Set;for(const t of j.value){const a=t.headers.findIndex(e=>{const t=e.toLowerCase();return t.includes('势力')||t.includes('阵营')||t.includes('faction')});if(a>=0)for(const o of t.rows){const t=o.cells.find(e=>e.colIndex===a);t&&t.value&&String(t.value).trim()&&e.add(String(t.value).trim())}}return Array.from(e)}),(0,p.computed)(()=>t.activeTab&&A.value.find(e=>e.id===t.activeTab)||null)),H=(0,p.computed)(()=>0),W=(0,p.computed)(()=>{const e=window.SillyTavern?.chat;return Array.isArray(e)?e.length-1:0});function G(e){const t=e.toLowerCase();if(t.includes('主角')||t.includes('player'))return'fas fa-user';if(t.includes('任务')||t.includes('quest'))return'fas fa-tasks';if(t.includes('物品')||t.includes('item'))return'fas fa-box-open';if(t.includes('装备')||t.includes('equip'))return'fas fa-shield-alt';if(t.includes('状态')||t.includes('status'))return'fas fa-heart';if(t.includes('事件')||t.includes('event'))return'fas fa-calendar-alt';if(t.includes('选项')||t.includes('option'))return'fas fa-sliders-h';const a=Va(e);return'fas fa-table'!==a?a:'fas fa-table'}function Y(){t.closePanel(),console.info('[ACU] 面板已关闭')}function X(){B.value=!B.value}function K(){t.isCollapsed=!0,console.info('[ACU] 面板已收起为悬浮球')}function q(e){e&&N.value&&N.value.exitCenteredMode();const a=N.value?.getDataAreaElement();a&&(a.style.height='',a.style.minHeight='',a.style.maxHeight=''),t.setActiveTab(e),E.value='',B.value=!1,console.info(`[ACU] 切换到 Tab: ${e}`),(0,p.nextTick)(()=>{setTimeout(()=>{requestAnimationFrame(()=>{J(e)})},50)})}function J(e){const a=N.value?.getDataAreaElement();if(!a)return;const o=t.getTableHeight(e);o?(a.style.height=`${o}px`,console.info(`[ACU] 恢复高度: ${e} = ${o}px`)):N.value?.resetHeight()}function Z(e){t.setTableOrder(e),console.info('[ACU] Tab 顺序已更新')}function Q(){t.toggleTabsPopup(),console.info('[ACU] Tab浮窗: '+(t.tabsPopup?'显示':'隐藏'))}function ee(e){t.closeTabsPopup(),q(e)}function te(e){const a=N.value?.getDataAreaElement();a&&(a.style.height='',a.style.minHeight='',a.style.maxHeight=''),t.setActiveTab(e),console.info(`[ACU] 导航到表格: ${e}`),(0,p.nextTick)(()=>{setTimeout(()=>{requestAnimationFrame(()=>{J(e)})},50)})}function ae(){P.value?(t.setActiveTab(Na),console.info('[ACU] 导航到关系图 Tab')):Aa.toast.warning('未找到人物关系数据')}function oe(){V.value&&V.value.openAvatarManager()}function ne(){t.openInputFloorDialog(H.value)}function re(){t.openPurgeRangeDialog(W.value)}function le(e,a){switch(e){case'clear':re();break;case'undo':fe();break;case'manualUpdate':De();break;case'console':t.openDirectorDialog();break;default:console.log('[ACU Dashboard] 未处理的动作:',e,a)}}function ie(){q(ka),console.info('[ACU] 返回仪表盘')}function ce(e,a){let o=String(e.promptTemplate||'');o=o.replace(/\{\{value\}\}/gi,e.label),o=a?.title?o.replace(/\{\{rowTitle\}\}/gi,a.title):o.replace(/\{\{rowTitle\}\}/gi,'');const n=function(){const e=window.parent||window;try{const t=e.SillyTavern?.getContext?.();if(t?.name1)return t.name1}catch(e){console.warn('[ACU] 获取主角名失败',e)}return'{{user}}'}();o=o.replace(/\{\{playerName\}\}/gi,n),o=o.replace(/\{\{tableName\}\}/gi,'');const l=o.trim(),i=r.getCategoryById(e.categoryId),c=!!i&&(i.path.includes('地点')||i.path.includes('Location'));e.allowPreEdit||c?t.openTagPreEditDialog({tagLabel:e.label,resolvedPrompt:l,showCompanions:c}):l&&v(l)}function se(e,a){const o=N.value?.getDataAreaElement();if(!o||!a)return;if(0!==e.button)return;e.preventDefault(),e.stopPropagation(),a.setPointerCapture(e.pointerId);const n=e.clientY,r=o.offsetHeight,l=e=>{const t=n-e.clientY;let a=r+t;a=Math.max(200,a),o.style.height=`${a}px`},i=e=>{a.releasePointerCapture(e.pointerId),a.removeEventListener('pointermove',l),a.removeEventListener('pointerup',i);const n=t.activeTab;if(n&&o){const e=o.offsetHeight;t.setTableHeight(n,e),console.info(`[ACU] 保存高度: ${n} = ${e}px`)}};a.addEventListener('pointermove',l),a.addEventListener('pointerup',i)}function ue(){const e=t.activeTab;e&&(t.resetTableHeight(e),console.info(`[ACU] 清除高度记忆: ${e}`)),N.value?.resetHeight(),console.info('[ACU] 高度已重置为自适应')}async function de(){const e=u();if(e){const o=a.setStagedData(e);a.saveSnapshot(o);const n=Object.keys(e).filter(e=>e.startsWith('sheet_'));t.syncNewTablesToVisibleTabs(n),a.clearChanges(!0),f().catch(e=>{console.warn('[ACU] 刷新表格更新状态失败（非阻塞）:',e)})}}async function pe(){try{await de(),console.info('[ACU] 数据已刷新')}catch(e){console.error('[ACU] 刷新失败:',e)}}async function me(){try{a.saveLastState();await s(null,!1,!0)&&(console.info('[ACU] 数据已保存'),await de())}catch(e){console.error('[ACU] 保存失败:',e)}}function fe(){if(!a.hasUndoData)return void Aa.toast.warning('没有可撤回的数据');a.undoToLastSave()?(Aa.toast.success('已撤回到上次保存前的状态（需手动保存）'),console.info('[ACU] 已撤回到上次保存前的状态, hasUnsavedChanges:',a.hasUnsavedChanges)):Aa.toast.error('撤回失败')}function ge(e,t,a){console.info(`[ACU] 单元格点击: ${e}[${t}][${a}]`)}function ve(e,t){console.info(`[ACU] 行点击: ${e}[${t.index}]`)}async function be(e,t){console.info(`[ACU] 插入行: ${e} 在索引 ${t} 之后`);if(!A.value.find(t=>t.id===e))return void console.warn('[ACU] 未找到表格:',e);const{insertRow:a}=co();await a(e,t),await de()}function he(e,t){const o=A.value.find(t=>t.id===e),n=`${o?.name||e}-row-${t}`;a.toggleDelete(n),console.info(`[ACU] 切换删除状态: ${n}`)}function xe(e,t,o){const n=A.value.find(e=>e.id===t),r=n?.name||t,l=`${r}-row-${o}`;S.visible=!0,S.x=e.clientX,S.y=e.clientY,S.tableId=t,S.tableName=r,S.rowIndex=o,S.isDeleting=a.pendingDeletes.has(l)}function ye(){be(S.tableId,S.rowIndex),S.visible=!1}function we(){const e=A.value.find(e=>e.id===S.tableId),t=e?.rows[S.rowIndex];if(t){const e=t.cells.map(e=>`${e.key}: ${e.value}`).join('\n');navigator.clipboard.writeText(e).then(()=>{console.info('[ACU] 内容已复制')})}S.visible=!1}function ke(){he(S.tableId,S.rowIndex),S.visible=!1}function Ce(){he(S.tableId,S.rowIndex),S.visible=!1}function Ne(e,a,o,n){const r=A.value.find(t=>t.id===e);let l=1;if(r&&(a.includes('总结')||a.includes('大纲'))){const e=r.headers.findIndex(e=>e&&(e.includes('索引')||e.includes('编号')||e.includes('代码')));l=e>0?e:1}t.openHistoryDialog({tableId:e,tableName:a,rowIndex:o,currentRowData:n,titleColIndex:l}),console.info(`[ACU] 打开历史记录: ${a}[${o}], titleColIndex=${l}`)}async function Ee(e){const{tableId:o,tableName:n,rowIndex:r,currentRowData:l}=t.historyDialog.props;if(!l||0===e.size)return void t.closeHistoryDialog();const{saveSnapshot:i,getCurrentChatId:c}=Ot();c()&&(await i(n,r,function(e){const t={};return e.cells.forEach((e,a)=>{t[a]=String(e.value)}),t}(l),'manual'),console.info('[ACU] 已保存历史记录（批量操作前）'));for(const[t,o]of e)a.updateCell(n,r,t,o,{skipHistory:!0});console.info(`[ACU] 应用历史更改: ${e.size} 个单元格`),t.closeHistoryDialog()}function Be(e='reveal'){const a=t.divinationOverlay.result;a?w(a,e):console.error('[ACU] Confirm divination failed: No result found')}function Se(e){b(e),h()}function Te(){console.info('[ACU] 设置已保存')}function De(){t.openManualUpdateDialog()}function Ae(){try{const e=(window.parent||window).AutoCardUpdaterAPI||window.AutoCardUpdaterAPI;e&&'function'==typeof e.openVisualizer?(e.openVisualizer(),console.info('[ACU] 已打开原生编辑器')):console.warn('[ACU] AutoCardUpdaterAPI.openVisualizer 不可用')}catch(e){console.error('[ACU] 打开原生编辑器失败:',e)}}async function ze(e){try{await s(null,!1,!1,e)&&(console.info(`[ACU] 数据已保存到第 ${e} 楼`),await de())}catch(e){console.error('[ACU] 保存到指定楼层失败:',e)}}async function Ie(e,t){try{await d(e,t),console.info(`[ACU] 已清除第 ${e} 到 ${t} 楼的数据`),await de()}catch(e){console.error('[ACU] 清除范围失败:',e)}}async function _e(e){console.info(`[ACU] 高级清除完成，影响 ${e.changedCount} 楼层，表格:`,e.tables),await de()}return(0,p.onMounted)(async()=>{console.info('[ACU] App 组件已挂载'),i();try{k.init(),console.info('[ACU] Swipe 增强功能初始化成功')}catch(e){console.error('[ACU] Swipe 增强功能初始化失败:',e)}t.setMobile(window.innerWidth<=768),window.addEventListener('resize',()=>{t.setMobile(window.innerWidth<=768)});try{await de(),await o.loadConfig(),l.loadConfig(),await l.loadFromWorldbook(),t.setInitialized(!0);let e=!1;try{const a=localStorage.getItem('acu_win_config'),o=a?JSON.parse(a):null;!0===o?.isCentered&&(e=!0,t.setActiveTab(null),t.isCollapsed=!1,console.info('[ACU] 居中模式（首次加载）：强制清除 Tab，展开面板，只显示导航栏'))}catch(e){}!e&&!t.activeTab&&A.value.length>0&&t.setActiveTab(ka)}catch(e){console.error('[ACU] 初始化数据加载失败:',e)}}),(0,p.onUnmounted)(()=>{console.info('[ACU] App 组件已卸载'),m(),x(),c()}),(0,p.onMounted)(()=>{const e=window.parent?.document||document,a=e=>{if(!t.isPanelVisible||t.isPinned)return;(function(e){const a=window.parent?.document||document;if(a.querySelector('.acu-inline-editor'))return console.info('[ACU] 检测到 InlineEditor 存在，阻止收起面板'),!0;if(a.querySelector('.acu-editing-lock'))return console.info('[ACU] 检测到编辑锁定状态，阻止收起面板'),!0;const o=a.activeElement;return!o||'TEXTAREA'!==o.tagName&&'INPUT'!==o.tagName||!o.closest('.acu-wrapper')&&!o.closest('.acu-inline-editor')?!!(t.settingsDialog||t.inputFloorDialog.visible||t.purgeRangeDialog.visible||t.manualUpdateDialog||t.historyDialog.visible||t.presetSaveDialog.visible)||!!(e.closest('.acu-wrapper')||e.closest('.acu-floating-ball-vue')||e.closest('.acu-context-menu')||e.closest('.acu-modal-overlay')||e.closest('.acu-modal')||e.closest('.acu-modal-container')||e.closest('.acu-history-modal')||e.closest('.acu-dialog')||e.closest('[class*="acu-settings"]')||e.closest('#acu_visualizer_vue-root')||e.closest('.acu-inline-editor')||e.closest('.acu-editing-lock')||e.closest('.acu-edit-textarea')):(console.info('[ACU] 检测到 ACU 内的输入框活动，阻止收起面板'),!0)})(e.target)||(t.closePanel(),console.info('[ACU] 点击外部，面板已收起'))};e.addEventListener('click',a),(0,p.onUnmounted)(()=>{e.removeEventListener('click',a)})}),(0,p.watchEffect)(()=>{const e=n.config.mobileSafeAreaBottom??50;window.parent?.document?.documentElement&&window.parent.document.documentElement.style.setProperty('--acu-safe-area-bottom',`${e}px`)}),(0,p.watch)(()=>a.stagedData,e=>{e&&a.generateDiffMap(e)},{deep:!0}),(e,o)=>((0,p.openBlock)(),(0,p.createElementBlock)('div',{class:(0,p.normalizeClass)(['acu-app',T.value])},[(0,p.createCommentVNode)(' 悬浮球 (面板隐藏时显示) '),(0,p.createVNode)((0,p.unref)(Qo),{ref_key:'floatingBallRef',ref:C,style:(0,p.normalizeStyle)({display:(0,p.unref)(t).isPanelVisible?'none':'block'})},null,8,['style']),(0,p.createCommentVNode)(' 主面板 '),(0,p.createVNode)((0,p.unref)(fn),{ref_key:'mainPanelRef',ref:N,style:(0,p.normalizeStyle)({display:(0,p.unref)(t).isPanelVisible?'flex':'none'}),title:D.value,theme:(0,p.unref)(n).config.theme,layout:(0,p.unref)(n).config.layout,'is-collapsed':(0,p.unref)(t).isCollapsed,'is-pinned':(0,p.unref)(t).isPinned,'is-content-hidden':B.value,'lock-panel':(0,p.unref)(n).config.lockPanel,'has-changes':(0,p.unref)(a).hasUnsavedChanges,onRefresh:pe,onSave:me,onSaveAs:ne,onUndo:fe,onManualUpdate:De,onPurge:re,onOpenNative:Ae,onSettings:(0,p.unref)(t).openSettingsDialog,onTogglePin:(0,p.unref)(t).togglePin,onToggle:K,onClose:Y,onHideContent:X,onCollapseTab:Q},{tabs:(0,p.withCtx)(()=>[M.value?(0,p.createCommentVNode)('v-if',!0):((0,p.openBlock)(),(0,p.createBlock)((0,p.unref)(bn),{key:0,tabs:I.value,'active-tab':(0,p.unref)(t).activeTab,'show-dashboard':!0,'has-options-tabs':U.value,'has-relationship-graph':P.value,'is-editing-order':(0,p.unref)(t).isEditingOrder,'grid-columns':(0,p.unref)(n).gridColumnsCss,onTabChange:q,onOrderChange:Z,onExitEditing:o[0]||(o[0]=e=>(0,p.unref)(t).setEditingOrder(!1))},null,8,['tabs','active-tab','has-options-tabs','has-relationship-graph','is-editing-order','grid-columns']))]),'tabs-popup':(0,p.withCtx)(()=>[(0,p.createVNode)((0,p.unref)(dC),{visible:(0,p.unref)(t).tabsPopup,tabs:I.value,'active-tab':(0,p.unref)(t).activeTab,'grid-columns':(0,p.unref)(n).gridColumnsCss,'show-dashboard':!0,'show-options-panel':U.value,'show-relationship-graph':P.value,onTabClick:ee,onClose:(0,p.unref)(t).closeTabsPopup},null,8,['visible','tabs','active-tab','grid-columns','show-options-panel','show-relationship-graph','onClose'])]),default:(0,p.withCtx)(()=>[(0,p.createCommentVNode)(' 仪表盘视图 '),(0,p.unref)(t).activeTab===(0,p.unref)(ka)?((0,p.openBlock)(),(0,p.createBlock)((0,p.unref)(gc),{key:0,tables:A.value,onNavigate:te,onRowClick:ve,onShowRelationshipGraph:ae,onAction:le,onHeightDragStart:se,onHeightReset:ue},null,8,['tables'])):(0,p.unref)(t).activeTab===(0,p.unref)(Ca)?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:1},[(0,p.createCommentVNode)(' 选项面板视图 '),(0,p.createVNode)((0,p.unref)(Oc),{tables:L.value,onCellClick:ge,onToggleDelete:he},null,8,['tables'])],2112)):(0,p.unref)(t).activeTab===(0,p.unref)(Na)?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:2},[(0,p.createCommentVNode)(' 关系图视图 '),(0,p.createVNode)((0,p.unref)(cC),{ref_key:'relationshipGraphRef',ref:V,'relationship-table':F.value,'character-tables':j.value,'faction-table':R.value,'all-tables':A.value,'show-legend':!0},null,8,['relationship-table','character-tables','faction-table','all-tables'])],2112)):O.value?((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:3},[(0,p.createCommentVNode)(' 普通表格视图 '),((0,p.openBlock)(),(0,p.createBlock)((0,p.unref)(Dc),{key:O.value.id,'table-id':O.value.id,'table-name':O.value.name,rows:O.value.rows,headers:O.value.headers,'search-term':E.value,onCellClick:ge,onInsertRow:be,onToggleDelete:he,onContextMenu:xe,onSearchChange:o[1]||(o[1]=e=>E.value=e),onClose:ie,onHeightDragStart:se,onHeightReset:ue,onShowHistory:Ne},null,8,['table-id','table-name','rows','headers','search-term']))],2112)):((0,p.openBlock)(),(0,p.createElementBlock)(p.Fragment,{key:4},[(0,p.createCommentVNode)(' 无数据状态 '),o[14]||(o[14]=(0,p.createElementVNode)('div',{class:'acu-no-data'},[(0,p.createElementVNode)('i',{class:'fas fa-inbox'}),(0,p.createElementVNode)('p',null,'请选择一个表格')],-1))],2112))]),_:1},8,['style','title','theme','layout','is-collapsed','is-pinned','is-content-hidden','lock-panel','has-changes','onSettings','onTogglePin']),(0,p.createCommentVNode)(' 右键菜单 '),(0,p.createVNode)((0,p.unref)(Hc),{visible:(0,p.unref)(S).visible,'onUpdate:visible':o[2]||(o[2]=e=>(0,p.unref)(S).visible=e),x:(0,p.unref)(S).x,y:(0,p.unref)(S).y,'table-id':(0,p.unref)(S).tableId,'table-name':(0,p.unref)(S).tableName,'row-index':(0,p.unref)(S).rowIndex,onInsertRow:ye,onCopy:we,onDelete:ke,onUndoDelete:Ce},null,8,['visible','x','y','table-id','table-name','row-index']),(0,p.createCommentVNode)(' 设置弹窗 '),(0,p.createVNode)((0,p.unref)(Qb),{visible:(0,p.unref)(t).settingsDialog,'onUpdate:visible':o[3]||(o[3]=e=>(0,p.unref)(t).settingsDialog=e),onSave:Te},null,8,['visible']),(0,p.createCommentVNode)(' 导演控制台弹窗 '),(0,p.createVNode)((0,p.unref)(As),{visible:(0,p.unref)(t).directorDialog,'onUpdate:visible':o[4]||(o[4]=e=>(0,p.unref)(t).directorDialog=e)},null,8,['visible']),(0,p.createCommentVNode)(' 输入楼层弹窗 '),(0,p.createVNode)((0,p.unref)(Zu),{visible:(0,p.unref)(t).inputFloorDialog.visible,'onUpdate:visible':o[5]||(o[5]=e=>(0,p.unref)(t).inputFloorDialog.visible=e),'current-floor':(0,p.unref)(t).inputFloorDialog.props.currentFloor,onConfirm:ze},null,8,['visible','current-floor']),(0,p.createCommentVNode)(' 清除范围弹窗 '),(0,p.createVNode)((0,p.unref)(ep),{visible:(0,p.unref)(t).purgeRangeDialog.visible,'onUpdate:visible':o[6]||(o[6]=e=>(0,p.unref)(t).purgeRangeDialog.visible=e),'max-floor':(0,p.unref)(t).purgeRangeDialog.props.maxFloor,onConfirm:Ie,onAdvancedConfirm:_e},null,8,['visible','max-floor']),(0,p.createCommentVNode)(' 高级清除弹窗 (全局) '),(0,p.createVNode)((0,p.unref)(xs),{visible:(0,p.unref)(t).advancedPurgeDialog.visible,'onUpdate:visible':o[7]||(o[7]=e=>(0,p.unref)(t).advancedPurgeDialog.visible=e),'initial-start-floor':(0,p.unref)(t).advancedPurgeDialog.props.initialStartFloor,'initial-end-floor':(0,p.unref)(t).advancedPurgeDialog.props.initialEndFloor,onConfirm:(0,p.unref)(t).handleAdvancedPurgeConfirm},null,8,['visible','initial-start-floor','initial-end-floor','onConfirm']),(0,p.createCommentVNode)(' 手动更新配置弹窗 '),(0,p.createVNode)((0,p.unref)(Ld),{visible:(0,p.unref)(t).manualUpdateDialog,'onUpdate:visible':o[8]||(o[8]=e=>(0,p.unref)(t).manualUpdateDialog=e)},null,8,['visible']),(0,p.createCommentVNode)(' 历史记录弹窗 (DataTable 使用) '),(0,p.createVNode)((0,p.unref)(Eu),{visible:(0,p.unref)(t).historyDialog.visible,'onUpdate:visible':o[9]||(o[9]=e=>(0,p.unref)(t).historyDialog.visible=e),'table-name':(0,p.unref)(t).historyDialog.props.tableName,'table-id':(0,p.unref)(t).historyDialog.props.tableId,'row-index':(0,p.unref)(t).historyDialog.props.rowIndex,'current-row-data':(0,p.unref)(t).historyDialog.props.currentRowData,'title-col-index':(0,p.unref)(t).historyDialog.props.titleColIndex,onApply:Ee},null,8,['visible','table-name','table-id','row-index','current-row-data','title-col-index']),(0,p.createCommentVNode)(' 行编辑弹窗 (Dashboard 使用) '),(0,p.createVNode)((0,p.unref)(Hw),{visible:(0,p.unref)(t).rowEditDialog.visible,'onUpdate:visible':o[10]||(o[10]=e=>(0,p.unref)(t).rowEditDialog.visible=e),'table-name':(0,p.unref)(t).rowEditDialog.props.tableName,'table-id':(0,p.unref)(t).rowEditDialog.props.tableId,'row-index':(0,p.unref)(t).rowEditDialog.props.rowIndex,'current-row-data':(0,p.unref)(t).rowEditDialog.props.currentRowData,onClose:(0,p.unref)(t).closeRowEditDialog,onShowHistory:(0,p.unref)(t).switchFromRowEditToHistory},null,8,['visible','table-name','table-id','row-index','current-row-data','onClose','onShowHistory']),(0,p.createCommentVNode)(' 历史记录弹窗 (Dashboard 使用) '),(0,p.createVNode)((0,p.unref)(Eu),{visible:(0,p.unref)(t).dashboardHistoryDialog.visible,'onUpdate:visible':o[11]||(o[11]=e=>(0,p.unref)(t).dashboardHistoryDialog.visible=e),'table-name':(0,p.unref)(t).dashboardHistoryDialog.props.tableName,'table-id':(0,p.unref)(t).dashboardHistoryDialog.props.tableId,'row-index':(0,p.unref)(t).dashboardHistoryDialog.props.rowIndex,'current-row-data':(0,p.unref)(t).dashboardHistoryDialog.props.currentRowData,'title-col-index':(0,p.unref)(t).dashboardHistoryDialog.props.titleColIndex,onClose:(0,p.unref)(t).closeDashboardHistoryDialog},null,8,['visible','table-name','table-id','row-index','current-row-data','title-col-index','onClose']),(0,p.createCommentVNode)(' 组件设置弹窗 (Dashboard 使用) '),(0,p.createVNode)((0,p.unref)(Lk),{visible:(0,p.unref)(t).widgetSettingsDialog.visible,'onUpdate:visible':o[12]||(o[12]=e=>(0,p.unref)(t).widgetSettingsDialog.visible=e),'widget-id':(0,p.unref)(t).widgetSettingsDialog.props.widgetId,'widget-config':(0,p.unref)(t).widgetSettingsDialog.props.widgetConfig,'table-headers':(0,p.unref)(t).widgetSettingsDialog.props.tableHeaders,onClose:(0,p.unref)(t).closeWidgetSettingsDialog},null,8,['visible','widget-id','widget-config','table-headers','onClose']),(0,p.createCommentVNode)(' 头像裁剪弹窗 (全局) '),(0,p.createVNode)((0,p.unref)(kh),{visible:(0,p.unref)(t).avatarCropDialog.visible,'image-url':(0,p.unref)(t).avatarCropDialog.props.imageUrl,name:(0,p.unref)(t).avatarCropDialog.props.name,'initial-offset-x':(0,p.unref)(t).avatarCropDialog.props.initialOffsetX,'initial-offset-y':(0,p.unref)(t).avatarCropDialog.props.initialOffsetY,'initial-scale':(0,p.unref)(t).avatarCropDialog.props.initialScale,'initial-invert':(0,p.unref)(t).avatarCropDialog.props.initialInvert,'show-invert-option':(0,p.unref)(t).avatarCropDialog.props.showInvertOption,onClose:(0,p.unref)(t).closeAvatarCropDialog,onApply:(0,p.unref)(t).handleAvatarCropApply,onUpload:(0,p.unref)(t).handleAvatarCropUpload},null,8,['visible','image-url','name','initial-offset-x','initial-offset-y','initial-scale','initial-invert','show-invert-option','onClose','onApply','onUpload']),(0,p.createCommentVNode)(' 快捷按钮配置弹窗 (Dashboard 使用) '),(0,p.createVNode)((0,p.unref)(sk),{visible:(0,p.unref)(t).widgetActionsDialog.visible,'onUpdate:visible':o[13]||(o[13]=e=>(0,p.unref)(t).widgetActionsDialog.visible=e),'widget-id':(0,p.unref)(t).widgetActionsDialog.props.widgetId,'current-actions':(0,p.unref)(t).widgetActionsDialog.props.currentActions,onClose:(0,p.unref)(t).closeWidgetActionsDialog},null,8,['visible','widget-id','current-actions','onClose']),(0,p.createCommentVNode)(' 头像管理弹窗 (RelationshipGraph 使用) '),(0,p.createVNode)((0,p.unref)(ix),{visible:(0,p.unref)(t).avatarManagerDialog.visible,nodes:(0,p.unref)(t).avatarManagerDialog.props.nodes,factions:(0,p.unref)(t).avatarManagerDialog.props.factions,onClose:(0,p.unref)(t).closeAvatarManagerDialog,onUpdate:(0,p.unref)(t).handleAvatarManagerUpdate,onLabelChange:(0,p.unref)(t).handleAvatarManagerLabelChange},null,8,['visible','nodes','factions','onClose','onUpdate','onLabelChange']),(0,p.createCommentVNode)(' 节点配置弹窗 (RelationshipGraph 使用) '),(0,p.createVNode)((0,p.unref)(Sw),{visible:(0,p.unref)(t).nodeConfigDialog.visible,'node-id':(0,p.unref)(t).nodeConfigDialog.props.nodeId,'full-name':(0,p.unref)(t).nodeConfigDialog.props.fullName,'current-label':(0,p.unref)(t).nodeConfigDialog.props.currentLabel,'selected-indices':(0,p.unref)(t).nodeConfigDialog.props.selectedIndices,onClose:(0,p.unref)(t).closeNodeConfigDialog,onConfirm:(0,p.unref)(t).handleNodeConfigConfirm,onResetToFullName:(0,p.unref)(t).handleNodeConfigResetToFullName,onStyleUpdate:(0,p.unref)(t).handleNodeConfigStyleUpdate},null,8,['visible','node-id','full-name','current-label','selected-indices','onClose','onConfirm','onResetToFullName','onStyleUpdate']),(0,p.createCommentVNode)(' 姓名选择弹窗 (AvatarManagerDialog 使用) '),(0,p.createVNode)((0,p.unref)($w),{visible:(0,p.unref)(t).nodeLabelDialog.visible,'full-name':(0,p.unref)(t).nodeLabelDialog.props.fullName,'initial-indices':(0,p.unref)(t).nodeLabelDialog.props.initialIndices,onClose:(0,p.unref)(t).closeNodeLabelDialog,onApply:(0,p.unref)(t).handleNodeLabelApply,onReset:(0,p.unref)(t).handleNodeLabelReset},null,8,['visible','full-name','initial-indices','onClose','onApply','onReset']),(0,p.createCommentVNode)(' 关系图设置弹窗 (RelationshipGraph 使用) '),(0,p.createVNode)((0,p.unref)(Qy),{visible:(0,p.unref)(t).graphSettingsDialog.visible,factions:(0,p.unref)(t).graphSettingsDialog.props.factions,onClose:(0,p.unref)(t).closeGraphSettingsDialog,onOpenAvatarManager:oe},null,8,['visible','factions','onClose']),(0,p.createCommentVNode)(' 势力设置弹窗 (RelationshipGraph 使用) '),(0,p.createVNode)((0,p.unref)(_x),{visible:(0,p.unref)(t).factionSettingsDialog.visible,'faction-id':(0,p.unref)(t).factionSettingsDialog.props.factionId,'faction-name':(0,p.unref)(t).factionSettingsDialog.props.factionName,onClose:(0,p.unref)(t).closeFactionSettingsDialog},null,8,['visible','faction-id','faction-name','onClose']),(0,p.createCommentVNode)(' 标签管理器弹窗 (WidgetSettingsDialog 使用) '),(0,p.createVNode)((0,p.unref)(IV),{visible:(0,p.unref)(t).tagManagerDialog.visible,'widget-id':(0,p.unref)(t).tagManagerDialog.props.widgetId,'displayed-tag-ids':(0,p.unref)(t).tagManagerDialog.props.displayedTagIds,'displayed-category-ids':(0,p.unref)(t).tagManagerDialog.props.displayedCategoryIds,onClose:(0,p.unref)(t).closeTagManagerDialog,onSave:(0,p.unref)(t).handleTagManagerSave},null,8,['visible','widget-id','displayed-tag-ids','displayed-category-ids','onClose','onSave']),(0,p.createCommentVNode)(' 分类选择弹窗 (DashboardWidget 使用) '),(0,p.createVNode)((0,p.unref)(aE),{visible:(0,p.unref)(t).categorySelectDialog.visible,'category-id':(0,p.unref)(t).categorySelectDialog.props.categoryId,'row-context':(0,p.unref)(t).categorySelectDialog.props.rowContext,'widget-id':(0,p.unref)(t).categorySelectDialog.props.widgetId,onClose:(0,p.unref)(t).closeCategorySelectDialog,onSelect:ce},null,8,['visible','category-id','row-context','widget-id','onClose']),(0,p.createCommentVNode)(' 标签二次编辑弹窗 (DashboardWidget 使用) '),(0,p.createVNode)((0,p.unref)(xE),{visible:(0,p.unref)(t).tagPreEditDialog.visible,'tag-label':(0,p.unref)(t).tagPreEditDialog.props.tagLabel,'resolved-prompt':(0,p.unref)(t).tagPreEditDialog.props.resolvedPrompt,'show-companions':(0,p.unref)(t).tagPreEditDialog.props.showCompanions,'widget-id':(0,p.unref)(t).tagPreEditDialog.props.widgetId,onClose:(0,p.unref)(t).closeTagPreEditDialog},null,8,['visible','tag-label','resolved-prompt','show-companions','widget-id','onClose']),(0,p.createCommentVNode)(' 预设保存弹窗 (全局) '),(0,p.createVNode)((0,p.unref)(Xd),{visible:(0,p.unref)(t).presetSaveDialog.visible,'preset-type':(0,p.unref)(t).presetSaveDialog.props.presetType,'summary-items':(0,p.unref)(t).presetSaveDialog.props.summaryItems,'initial-name':(0,p.unref)(t).presetSaveDialog.props.initialName,'check-duplicate':(0,p.unref)(t).presetSaveDialog.props.checkDuplicate,'onUpdate:visible':(0,p.unref)(t).closePresetSaveDialog,onSave:(0,p.unref)(t).handlePresetSave},null,8,['visible','preset-type','summary-items','initial-name','check-duplicate','onUpdate:visible','onSave']),(0,p.createCommentVNode)(' 抽签覆盖层 '),(0,p.createVNode)((0,p.unref)(Yk),{visible:(0,p.unref)(t).divinationOverlay.visible,result:(0,p.unref)(t).divinationOverlay.result,onClose:(0,p.unref)(t).closeDivinationOverlay,onRetry:(0,p.unref)(y),onConfirm:Be},null,8,['visible','result','onClose','onRetry']),(0,p.createCommentVNode)(' 隐藏提示词编辑弹窗 '),(0,p.createVNode)((0,p.unref)(xC),{visible:(0,p.unref)(t).promptEditorDialog.visible,prompt:(0,p.unref)(t).promptEditorDialog.props.prompt,onClose:(0,p.unref)(t).closePromptEditorDialog,onSave:Se},null,8,['visible','prompt','onClose']),(0,p.createCommentVNode)(' 全局图标选择弹窗 '),(0,p.createVNode)((0,p.unref)(Wu),{visible:(0,p.unref)(t).iconSelectDialog.visible,'current-icon':(0,p.unref)(t).iconSelectDialog.props.currentIcon,'onUpdate:visible':(0,p.unref)(t).closeIconSelectDialog,onSelect:(0,p.unref)(t).handleIconSelect},null,8,['visible','current-icon','onUpdate:visible','onSelect']),(0,p.createCommentVNode)(' 全局 Toast 通知 '),(0,p.createVNode)((0,p.unref)(eC),{visible:(0,p.unref)(g).visible,message:(0,p.unref)(g).message,type:(0,p.unref)(g).type},null,8,['visible','message','type'])],2))}}),wE=yE;window.$=window.parent.$;const kE='acu-parent-container',CE='acu_win_config',NE='acu_active_tab',VE='acu_ui_collapse_state';let EE=null,BE=null,SE=null,TE=!1;function DE(){!function(){try{const e=localStorage.getItem(CE);if(!e){const e={width:400,left:'50%',bottom:'50%',isCentered:!0};return localStorage.setItem(CE,JSON.stringify(e)),localStorage.removeItem(NE),localStorage.setItem(VE,'false'),void console.info('[ACU] 首次加载：设置居中模式，清除 activeTab')}const t=JSON.parse(e);!0===t?.isCentered&&(localStorage.removeItem(NE),localStorage.setItem(VE,'false'),console.info('[ACU] 居中模式：清除 activeTab，确保面板展开'))}catch(e){const t={width:400,left:'50%',bottom:'50%',isCentered:!0};localStorage.setItem(CE,JSON.stringify(t)),localStorage.removeItem(NE),localStorage.setItem(VE,'false'),console.warn('[ACU] 解析 win_config 失败，重置为居中模式:',e)}}();let t=0;const a=()=>{if(TE)return void console.info('[ACU] 脚本正在卸载，停止 API 检查');const{$,getDB:o}=xt(),n=o();if(n&&'function'==typeof n.exportTableAsJson&&$){const o=n.exportTableAsJson();if(!(o&&Object.keys(o).length>0)&&t<10)return t++,console.info(`[ACU] API 就绪但无数据，等待中... (${t}/10)`),void(SE=setTimeout(a,1e3));SE=null,function(){const t=window.parent.document;if(t.getElementById(kE))return void console.warn('[ACU] Vue 应用已存在，跳过重复初始化');BE=t.createElement('div'),BE.id=kE,t.body.appendChild(BE);const a=e();EE=(0,p.createApp)(wE),EE.use(a),EE.mount(BE),console.info(`[ACU] Vue 应用已挂载到父窗口 (${kE})`)}()}else SE=setTimeout(a,1e3)};a()}$(()=>{console.info(`[ACU] 脚本加载: ${kE}`),replaceScriptButtons([{name:'🎴 隐藏提示词',visible:!0}]),eventOn(getButtonEvent('🎴 隐藏提示词'),()=>{if(!EE)return void console.warn('[ACU] Vue 应用尚未初始化');const e=Ea(),t=window.__acu_hidden_prompt||'';e.openPromptEditorDialog(t)}),setTimeout(()=>{no()},500),DE(),$(window).on('pagehide',()=>{console.info('[ACU] 页面卸载，执行清理'),ro(),console.info('[ACU] 开始清理资源...'),TE=!0,null!==SE&&(clearTimeout(SE),SE=null,console.info('[ACU] 初始化定时器已清除')),EE&&(EE.unmount(),EE=null,console.info('[ACU] Vue 应用已卸载')),BE&&(BE.remove(),BE=null,console.info('[ACU] 挂载点已移除')),console.info('[ACU] 资源清理完成')})});
//# sourceMappingURL=index.js.map