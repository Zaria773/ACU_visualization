# 头像管理功能开发计划

## 1. 存储方案（简化版）

**全部存储到 IndexedDB**，独立于酒馆变量系统：

```typescript
// IndexedDB: acu_avatars
interface AvatarRecord {
  /** 角色名（主键） */
  name: string;
  /** 图片 Blob（可选，有 URL 时可为空） */
  blob?: Blob;
  /** 远程 URL（可选） */
  url?: string;
  /** 裁剪配置 */
  offsetX: number;  // 0-100
  offsetY: number;  // 0-100
  scale: number;    // 100-300
  /** 别名列表（用于姓名映射） */
  aliases: string[];
  /** 显示标签配置（选中的字符索引） */
  labelIndices?: number[];
  /** 更新时间 */
  updatedAt: number;
}
```

### 优点
- 完全独立，不受角色卡更新影响
- 数据统一在一处管理
- 实现简单直接

### 限制
- 不跟随角色卡导出（需要清楚告知用户）
- 换浏览器/清缓存会丢失

---

## 2. 头像来源优先级

```
1. 本地上传图片 (IndexedDB Blob → ObjectURL)
2. 用户配置的 URL
3. 酒馆自动获取（仅主角和角色卡头像）
4. 首字母占位符 (Fallback)
```

---

## 3. UI 设计

### 3.1 头像管理弹窗

```
┌─────────────────────────────────────────────────────────────┐
│ 头像管理                                              [X]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │  [头像]   张三    [名字▼]  [导入▼: 本地|酒馆]           │ │
│ │                                                         │ │
│ │           URL: _____________________________________    │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │  [头像]   主角    [名字▼]  [导入▼: 本地|酒馆]  [酒馆]   │ │
│ │           (自动获取酒馆头像)                            │ │
│ │           URL: _____________________________________    │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │  ... 更多角色 ...                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                       [批量删除]  [保存]                    │  ← 固定底栏
└─────────────────────────────────────────────────────────────┘
```

### 3.2 交互说明

| 元素 | 交互 | 说明 |
|------|------|------|
| **头像预览** | 点击 | 打开裁剪调整弹窗 |
| **[名字▼]** | 点击 | 打开现有的「选择显示字符」弹窗 |
| **[导入▼]** | 下拉选项 | `本地导入`: 选择本地图片文件<br>`酒馆导入`: 获取酒馆角色卡头像 |
| **[酒馆]** | 标签显示 | 仅主角显示，表示自动使用酒馆头像 |
| **URL 输入框** | 粘贴 | 直接输入远程图片 URL |
| **[批量删除]** | 点击 | 进入批量选择模式，勾选后删除（含 IndexedDB） |
| **[保存]** | 点击 | 保存所有修改到 IndexedDB |

### 3.3 与现有姓名选择弹窗的集成

复用 `RelationshipGraph.vue` 中现有的 `acu-node-config-panel` 组件：

```vue
<!-- 现有的选择显示字符弹窗 -->
<div v-if="showNodeConfig" class="acu-node-config-overlay">
  <div class="acu-node-config-panel">
    <div class="acu-node-config-header">
      <span>选择显示的字符</span>
      <button class="acu-close-btn" @click.stop="closeNodeConfig">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="acu-node-config-body">
      <p class="acu-node-fullname">全名：{{ configNodeFullName }}</p>
      <p class="acu-node-hint">点击选择要显示的字符（可多选）</p>
      <div class="acu-char-selector">
        <button
          v-for="(char, index) in getDisplayChars(configNodeFullName)"
          :key="index"
          class="acu-char-btn"
          :class="{ active: configSelectedIndices.has(index) }"
          @click.stop="toggleCharSelection(index)"
        >
          {{ char }}
        </button>
      </div>
      <p class="acu-node-preview">预览：{{ getPreviewLabel() }}</p>
      <div class="acu-node-config-actions">
        <button class="acu-action-btn secondary" @click.stop="resetToFullName">显示全名</button>
        <button class="acu-action-btn primary" @click.stop="applyAndClose">确定</button>
      </div>
    </div>
  </div>
</div>
```

**需要的修改**：
- 将这个弹窗逻辑抽取为独立组件 `NodeLabelDialog.vue`
- 在头像管理弹窗中复用
- 保存时将 `labelIndices` 存入 `AvatarRecord`

---

## 4. 组件架构

```
src/可视化表格/
├── composables/
│   └── useAvatarManager.ts     # 头像管理核心逻辑 (IndexedDB)
├── components/
│   ├── dialogs/
│   │   ├── AvatarManagerDialog.vue  # 头像管理主弹窗
│   │   ├── AvatarCropDialog.vue     # 头像裁剪弹窗
│   │   └── NodeLabelDialog.vue      # 抽取的姓名选择弹窗（复用）
│   └── RelationshipGraph.vue        # 集成头像显示
├── styles/
│   └── overlays/
│       └── avatar-dialogs.scss      # 头像弹窗样式
└── types.ts                         # 类型定义扩展
```

---

## 5. 分步实现计划

### Phase 7.1 - 创建 useAvatarManager composable

**文件**: `src/可视化表格/composables/useAvatarManager.ts`

```typescript
/**
 * 头像管理 Composable - 纯 IndexedDB 存储
 */
export function useAvatarManager() {
  // === IndexedDB 操作 ===
  async function initDB(): Promise<IDBDatabase>
  async function saveAvatar(record: AvatarRecord): Promise<void>
  async function getAvatar(name: string): Promise<AvatarRecord | null>
  async function deleteAvatar(name: string): Promise<void>
  async function deleteAvatars(names: string[]): Promise<void>  // 批量删除
  async function getAllAvatars(): Promise<AvatarRecord[]>
  async function getStats(): Promise<{ count: number; totalSizeMB: string }>

  // === 头像获取 (核心 API) ===
  async function getAvatarUrl(name: string): Promise<string | null>

  // === 酒馆集成 ===
  function getSillyTavernUserAvatar(): string | null
  function getSillyTavernCharacterAvatar(): string | null
  function isPlayerNode(name: string): boolean

  // === 别名解析 ===
  function resolvePrimaryName(name: string): string

  // === 显示标签 ===
  function getDisplayLabel(name: string): string

  return { /* ... */ }
}
```

### Phase 7.2 - 抽取 NodeLabelDialog 组件

**文件**: `src/可视化表格/components/dialogs/NodeLabelDialog.vue`

从 `RelationshipGraph.vue` 中抽取现有的「选择显示字符」弹窗逻辑。

### Phase 7.3 - 创建 AvatarManagerDialog 弹窗

**文件**: `src/可视化表格/components/dialogs/AvatarManagerDialog.vue`

**关键特性**：
- 列表区可滚动，底部操作栏固定
- 使用下拉菜单替代多个按钮
- 集成 NodeLabelDialog
- 批量删除模式

### Phase 7.4 - 创建 AvatarCropDialog 裁剪弹窗

**文件**: `src/可视化表格/components/dialogs/AvatarCropDialog.vue`

### Phase 7.5 - 集成到 RelationshipGraph 组件

- Cytoscape 节点显示头像
- 工具栏添加入口按钮

---

## 6. 样式规范

### 6.1 固定底栏

```scss
.acu-avatar-manager-dialog {
  display: flex;
  flex-direction: column;
  max-height: 80vh;

  .acu-avatar-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
  }

  .acu-avatar-footer {
    position: sticky;
    bottom: 0;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--acu-border);
    background: var(--acu-bg-panel);
  }
}
```

### 6.2 导入下拉菜单

```scss
.acu-import-dropdown {
  position: relative;

  .acu-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--acu-card-bg);
    border: 1px solid var(--acu-border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;

    .acu-dropdown-item {
      padding: 8px 16px;
      cursor: pointer;

      &:hover {
        background: var(--acu-table-hover);
      }
    }
  }
}
```

---

## 7. 关键注意事项

1. **事件冒泡**：弹窗内所有按钮使用 `@click.stop`
2. **异步加载**：头像获取是异步的，需要处理 loading 状态
3. **ObjectURL 生命周期**：组件卸载时要 `URL.revokeObjectURL()`
4. **批量删除确认**：删除前需要用户确认，明确告知「将从 IndexedDB 永久删除」

---

## 8. 测试场景

| 场景 | 预期行为 |
|------|----------|
| 本地导入 | 选择文件 → 保存到 IndexedDB → 显示预览 |
| 酒馆导入 | 获取酒馆头像 URL → 保存配置 |
| URL 输入 | 粘贴 URL → 验证可访问 → 保存配置 |
| 点击名字 | 打开姓名选择弹窗 → 选择字符 → 更新显示 |
| 点击头像 | 打开裁剪弹窗 → 调整参数 → 保存 |
| 批量删除 | 进入选择模式 → 勾选 → 确认删除 → IndexedDB 清理 |
| 主角自动获取 | 无配置时自动使用酒馆头像 |
