# 导航栏初始化居中修复计划

## 问题描述

脚本重载后，导航栏渲染在屏幕底部外面，用户无法点击。

## 根本原因

### 从 Chrome DevTools 检查结果：
```
视口高度: 541px
.acu-wrapper boundingRect.top: 270.67px
.acu-wrapper boundingRect.bottom: 812px  ← 远超视口
.acu-nav-container top: 649.83px  ← 完全超出视口
.acu-tab-bar top: 656.5px
```

### 原因分析：

1. **CSS 布局设计缺陷**：
   - `flex-direction: column-reverse` 让导航栏在视觉底部
   - `bottom: 50%` + `transform: translate(-50%, 50%)` 的组合
   - 当有内容区域时，容器高度增加，导航栏被推到屏幕外

2. **初始化状态不正确**：
   - `activeTab` 有值（Dashboard）
   - Dashboard 被渲染，产生内容高度
   - 导航栏被推出屏幕

## 修复方案

### 核心思路：居中模式使用完全不同的定位策略

**居中模式（初始化/重置后）**：
- 使用 `top: 50%; left: 50%; transform: translate(-50%, -50%);`
- 隐藏内容区域，只显示导航栏
- `activeTab = null`

**非居中模式（用户拖动后）**：
- 保持当前的 `bottom` 定位逻辑
- 正常显示所有内容

## 修改文件清单

### 1. `src/可视化表格/styles/layouts/container.scss`

**修改内容**：
- 添加 `.acu-centered-mode` 类的特殊样式
- 居中模式使用 `top` 定位而非 `bottom`

```scss
// 居中模式：使用 top 定位实现真正居中
.acu-wrapper.acu-centered-mode {
  // 覆盖默认的 bottom 定位
  bottom: auto !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;

  // 居中模式下隐藏内容区域
  .acu-data-display {
    display: none !important;
  }
}
```

### 2. `src/可视化表格/components/MainPanel.vue`

**修改内容**：

a) 添加 `acu-centered-mode` class 绑定：
```vue
<div
  ref="panelRef"
  class="acu-wrapper"
  :class="[
    `acu-theme-${theme}`,
    `acu-layout-${layout}`,
    {
      collapsed: isCollapsed,
      pinned: isPinned,
      'acu-centered-mode': windowConfig.isCentered,  // 新增
    },
  ]"
>
```

b) 修改 watchEffect 中的 transform 逻辑：
```typescript
// 居中模式：使用 top 定位
if (savedWin.isCentered) {
  el.style.setProperty('--acu-win-top', '50%');
  el.style.setProperty('--acu-win-left', '50%');
  el.style.transform = 'translate(-50%, -50%)';
  // 清除 bottom 变量避免冲突
  el.style.removeProperty('--acu-win-bottom');
} else {
  // 非居中模式：使用 bottom 定位
  el.style.removeProperty('--acu-win-top');
  el.style.transform = 'none';
}
```

### 3. `src/可视化表格/index.ts`

**修改内容**：
确保 `checkAndResetCenteredMode()` 函数正确处理所有情况：

```typescript
function checkAndResetCenteredMode(): void {
  try {
    const winConfigRaw = localStorage.getItem(STORAGE_KEYS.WIN_CONFIG);

    // 情况1：没有保存过位置（首次加载）
    if (!winConfigRaw) {
      // 设置默认居中配置
      const defaultConfig = { width: 400, left: '50%', bottom: '50%', isCentered: true };
      localStorage.setItem(STORAGE_KEYS.WIN_CONFIG, JSON.stringify(defaultConfig));
      // 清除 activeTab
      localStorage.removeItem(STORAGE_KEYS.ACTIVE_TAB);
      // 确保面板展开（不显示悬浮球）
      localStorage.setItem(STORAGE_KEYS.UI_COLLAPSE, 'false');
      console.info('[ACU] 首次加载：设置居中模式，清除 activeTab');
      return;
    }

    // 情况2：已保存位置，检查是否是居中模式
    const winConfig = JSON.parse(winConfigRaw);
    if (winConfig?.isCentered === true) {
      localStorage.removeItem(STORAGE_KEYS.ACTIVE_TAB);
      localStorage.setItem(STORAGE_KEYS.UI_COLLAPSE, 'false');
      console.info('[ACU] 居中模式：清除 activeTab，确保面板展开');
    }
  } catch (e) {
    // 解析失败，重置为安全状态
    const defaultConfig = { width: 400, left: '50%', bottom: '50%', isCentered: true };
    localStorage.setItem(STORAGE_KEYS.WIN_CONFIG, JSON.stringify(defaultConfig));
    localStorage.removeItem(STORAGE_KEYS.ACTIVE_TAB);
    localStorage.setItem(STORAGE_KEYS.UI_COLLAPSE, 'false');
    console.warn('[ACU] 解析失败，重置为居中模式:', e);
  }
}
```

### 4. `src/可视化表格/stores/useUIStore.ts`

**修改内容**：
添加 `isCenteredMode` 计算属性，供组件使用

```typescript
// 从 localStorage 读取 windowConfig 判断是否居中模式
const isCenteredMode = computed(() => {
  try {
    const raw = localStorage.getItem('acu_win_config');
    if (!raw) return true; // 默认居中
    const config = JSON.parse(raw);
    return config?.isCentered === true;
  } catch {
    return true;
  }
});
```

## 预期效果

1. **首次加载/重置后**：
   - 悬浮球不出现（`isCollapsed = false`）
   - 导航栏出现在屏幕正中央
   - 没有 Tab 被选中（`activeTab = null`）
   - 内容区域不显示

2. **用户点击 Tab 后**：
   - 内容区域展开
   - 面板正常显示
   - `isCentered` 变为 `false`（拖动时）

3. **用户拖动面板后**：
   - 退出居中模式
   - 使用 `bottom` 定位
   - 位置持久化到 localStorage

## 测试检查点

1. [ ] 清除 localStorage 后重载脚本，导航栏在屏幕中心
2. [ ] 导航栏只有 Tab 按钮和操作按钮，没有内容区域
3. [ ] 点击任意 Tab，内容区域正常展开
4. [ ] 拖动面板，位置正常保存
5. [ ] 再次重载脚本，面板出现在保存的位置

## 风险评估

**低风险**：修改范围集中在居中模式的处理逻辑，不影响正常使用时的功能。
