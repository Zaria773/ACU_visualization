# å¿«æ·é‡æŠ½åŠŸèƒ½å®ç°è®¡åˆ’

> **åˆ›å»ºæ—¶é—´**: 2026-02-01
> **çŠ¶æ€**: è¿›è¡Œä¸­

## åŠŸèƒ½æ¦‚è¿°

æ–°å¢ä¸€ä¸ªå¯é…ç½®çš„å¿«æ·æŒ‰é’®ç±»å‹ `quickReroll`ï¼Œç”¨æˆ·å¯ä»¥å°†å®ƒæ·»åŠ åˆ°ä»»æ„ä»ªè¡¨ç›˜ç»„ä»¶çš„å¿«æ·æŒ‰é’®æ ä¸­ã€‚æŒ‰é’®æ˜¾ç¤ºä¸º**åŒå›¾æ ‡**ï¼ˆéª°å­ğŸ² + åˆ·æ–°ğŸ”„ï¼‰ï¼Œç‚¹å‡»åæ‰§è¡ŒæŠ½ç­¾å¹¶å°†ç»“æœæ³¨å…¥åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„ `<å‰§æƒ…å…ƒæŒ‡ä»¤>` æ ‡ç­¾ä¸­ï¼Œæ–¹ä¾¿ç”¨æˆ·é‡ rollã€‚

## è®¾è®¡åŸåˆ™

**æ ¸å¿ƒæ€è·¯**: å¤ç”¨ç°æœ‰æŠ½ç­¾æµç¨‹ï¼ˆç¿»ç‰ŒåŠ¨ç”»ã€å·çœ‹æ¨¡å¼ç­‰ï¼‰ï¼Œåªåœ¨æœ€åæ³¨å…¥é˜¶æ®µæ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„æ³¨å…¥æ–¹å¼ã€‚

## æµç¨‹å›¾

```
[ç”¨æˆ·ç‚¹å‡»å¿«æ·é‡æŠ½æŒ‰é’®]
        â†“
[è®¾ç½® isQuickRerollMode = true]
        â†“
[æ‰§è¡Œæ™®é€šæŠ½ç­¾æµç¨‹]
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ flipMode è®¾ç½® â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â†“             â†“
[skip]       [auto/manual]
    â†“             â†“
[ç›´æ¥æ³¨å…¥]   [æ‰“å¼€ç¿»ç‰Œè¦†ç›–å±‚]
                  â†“
           [ç”¨æˆ·ç‚¹å‡»ç¡®è®¤]
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ isQuickRerollMode? â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                 â†“
      [æ˜¯]              [å¦]
        â†“                 â†“
[æ›¿æ¢æœ€åä¸€æ¡      [åŸæœ‰é€»è¾‘:
 ç”¨æˆ·æ¶ˆæ¯]          hide/reveal]
```

## ä»»åŠ¡æ‹†åˆ†

### Task 1: ç±»å‹å®šä¹‰æ‰©å±•
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/types.ts`
**å†…å®¹**:
1. `WidgetActionId` è”åˆç±»å‹æ·»åŠ  `'quickReroll'`
2. `WidgetAction` æ¥å£æ·»åŠ  `secondaryIcon?: string` å¯é€‰å­—æ®µ
3. `WIDGET_ACTIONS` å¸¸é‡æ·»åŠ  `quickReroll` é…ç½®:
   ```typescript
   quickReroll: {
     id: 'quickReroll',
     icon: 'fa-dice',
     secondaryIcon: 'fa-redo-alt',
     label: 'å¿«æ·é‡æŠ½',
     tooltip: 'æŠ½ç­¾å¹¶æ›¿æ¢æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¸­çš„å‰§æƒ…å…ƒæŒ‡ä»¤'
   }
   ```

### Task 2: UI Store æ¨¡å¼æ ‡è®°
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/stores/useUIStore.ts`
**å†…å®¹**:
1. `divinationOverlay` reactive å¯¹è±¡æ·»åŠ  `isQuickRerollMode: boolean` å­—æ®µ
2. ä¿®æ”¹ `openDivinationOverlay` å‡½æ•°ç­¾åï¼Œæ·»åŠ  `isQuickReroll = false` å‚æ•°
3. ä¿®æ”¹ `closeDivinationOverlay` å‡½æ•°ï¼Œé‡ç½® `isQuickRerollMode`

### Task 3: æŠ½ç­¾åŠ¨ä½œæ ¸å¿ƒé€»è¾‘
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/composables/useDivinationAction.ts`
**å†…å®¹**:
1. ä¿®æ”¹ `confirmDivination` å‡½æ•°ç­¾åä¸º `(result, action: 'reveal' | 'hide' | 'reroll')`
2. æ–°å¢ `injectIntoLastUserMessage(prompt: string)` å‡½æ•°:
   - è·å–æœ€è¿‘ 20 æ¡æ¶ˆæ¯
   - ç­›é€‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå–æœ€åä¸€æ¡
   - æ­£åˆ™åŒ¹é… `<å‰§æƒ…å…ƒæŒ‡ä»¤>...</å‰§æƒ…å…ƒæŒ‡ä»¤>`
   - æ›¿æ¢æˆ–è¿½åŠ åˆ°å¼€å¤´
   - è°ƒç”¨ `setChatMessages` æ›´æ–°
3. æ–°å¢ `triggerQuickReroll()` å‡½æ•°:
   - å¤ç”¨ `performDivination` é€»è¾‘
   - æ‰§è¡ŒæŠ½ç­¾åè°ƒç”¨ `uiStore.openDivinationOverlay(result, true)`

### Task 4: DivinationOverlay é€‚é…
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/components/dialogs/divination/DivinationOverlay.vue`
**å†…å®¹**:
1. ä¿®æ”¹ `handleConfirm` å‡½æ•°ï¼Œæ£€æŸ¥ `uiStore.divinationOverlay.isQuickRerollMode`
2. æ›´æ–° `emit` ç±»å‹å®šä¹‰ï¼Œæ”¯æŒ `'reroll'` action

### Task 5: App.vue å¤„ç†å‡½æ•°é€‚é…
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/App.vue`
**å†…å®¹**:
1. ä¿®æ”¹ `handleDivinationConfirm` å‡½æ•°ç­¾åä¸º `(action: 'reveal' | 'hide' | 'reroll')`
2. åœ¨ `handleWidgetAction` ä¸­æ·»åŠ  `quickReroll` case

### Task 6: åŒå›¾æ ‡æŒ‰é’®æ ·å¼
**æ–‡ä»¶**: `src/å¯è§†åŒ–è¡¨æ ¼/styles/components/buttons.scss`
**å†…å®¹**:
æ–°å¢ `.acu-dual-icon` æ ·å¼:
```scss
.acu-icon-btn.acu-dual-icon {
  position: relative;

  .icon-secondary {
    position: absolute;
    bottom: 0;
    right: 0;
    font-size: 8px;
    opacity: 0.9;
    background: var(--acu-card-bg);
    border-radius: 50%;
    padding: 2px;
    line-height: 1;
  }
}
```

### Task 7: ç»„ä»¶åŒå›¾æ ‡æ¸²æŸ“æ”¯æŒ
**æ–‡ä»¶**:
- `src/å¯è§†åŒ–è¡¨æ ¼/components/dashboard/DashboardWidget.vue`
- `src/å¯è§†åŒ–è¡¨æ ¼/components/dashboard/RandomWordPoolWidget.vue`
- `src/å¯è§†åŒ–è¡¨æ ¼/components/dashboard/InteractionTableWidget.vue`

**å†…å®¹**:
1. ä¿®æ”¹æŒ‰é’®æ¸²æŸ“æ¨¡æ¿ï¼Œæ”¯æŒæ¬¡çº§å›¾æ ‡
2. æ·»åŠ  `hasSecondaryIcon(actionId)` å’Œ `getSecondaryIcon(actionId)` è¾…åŠ©å‡½æ•°

## æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | å…³é”®å˜æ›´ |
|------|----------|----------|
| `types.ts` | ä¿®æ”¹ | æ·»åŠ  `quickReroll` åˆ° `WidgetActionId` å’Œ `WIDGET_ACTIONS` |
| `useUIStore.ts` | ä¿®æ”¹ | `divinationOverlay` æ·»åŠ  `isQuickRerollMode` |
| `useDivinationAction.ts` | ä¿®æ”¹ | æ·»åŠ  `triggerQuickReroll()` å’Œ `injectIntoLastUserMessage()` |
| `DivinationOverlay.vue` | ä¿®æ”¹ | `handleConfirm` æ”¯æŒå¿«æ·é‡æŠ½æ¨¡å¼ |
| `App.vue` | ä¿®æ”¹ | å¤„ç† `quickReroll` action |
| `buttons.scss` | ä¿®æ”¹ | æ·»åŠ  `.acu-dual-icon` æ ·å¼ |
| `DashboardWidget.vue` | ä¿®æ”¹ | åŒå›¾æ ‡æ¸²æŸ“æ”¯æŒ |
| `RandomWordPoolWidget.vue` | ä¿®æ”¹ | åŒå›¾æ ‡æ¸²æŸ“æ”¯æŒ |
| `InteractionTableWidget.vue` | ä¿®æ”¹ | åŒå›¾æ ‡æ¸²æŸ“æ”¯æŒ |

## ä¾èµ–å…³ç³»

```
Task 1 (types.ts)
    â†“
Task 2 (useUIStore.ts)
    â†“
Task 3 (useDivinationAction.ts)
    â†“
Task 4 (DivinationOverlay.vue)
    â†“
Task 5 (App.vue)

Task 6 (buttons.scss) â† ç‹¬ç«‹
    â†“
Task 7 (ç»„ä»¶åŒå›¾æ ‡æ¸²æŸ“)
```

## æµ‹è¯•è¦ç‚¹

1. **æŒ‰é’®é…ç½®**: åœ¨ä»ªè¡¨ç›˜ç¼–è¾‘æ¨¡å¼ä¸­èƒ½å¤Ÿæ·»åŠ å¿«æ·é‡æŠ½æŒ‰é’®
2. **åŒå›¾æ ‡æ˜¾ç¤º**: æŒ‰é’®æ­£ç¡®æ˜¾ç¤ºéª°å­+åˆ·æ–°åŒå›¾æ ‡
3. **åŠ¨ç”»æ¨¡å¼**:
   - `flipMode=skip`: ç›´æ¥æ›¿æ¢
   - `flipMode=auto/manual`: æ˜¾ç¤ºç¿»ç‰ŒåŠ¨ç”»åæ›¿æ¢
4. **å·çœ‹æ¨¡å¼**: å¿«æ·é‡æŠ½æ¨¡å¼ä¸‹å·çœ‹æ¨¡å¼æ­£å¸¸ç”Ÿæ•ˆï¼ˆæ¨¡ç³Šæ˜¾ç¤ºï¼‰
5. **æ¶ˆæ¯æ›¿æ¢**:
   - æœ‰ `<å‰§æƒ…å…ƒæŒ‡ä»¤>` æ ‡ç­¾æ—¶æ­£ç¡®æ›¿æ¢
   - æ— æ ‡ç­¾æ—¶è¿½åŠ åˆ°æ¶ˆæ¯å¼€å¤´
6. **è¾¹ç•Œæƒ…å†µ**: æ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯æ—¶çš„é™çº§å¤„ç†

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ 7 ä¸ªä»»åŠ¡å®Œæˆ
- [ ] åŒå›¾æ ‡æŒ‰é’®æ­£å¸¸æ˜¾ç¤º
- [ ] å¿«æ·é‡æŠ½æµç¨‹ä¸æ™®é€šæŠ½ç­¾è¡Œä¸ºä¸€è‡´ï¼ˆåŠ¨ç”»ã€å·çœ‹æ¨¡å¼ï¼‰
- [ ] æœ€åæ³¨å…¥åˆ°ç”¨æˆ·æ¶ˆæ¯è€Œéè¾“å…¥æ¡†
- [ ] æ—  TypeScript ç±»å‹é”™è¯¯
