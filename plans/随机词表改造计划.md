# 随机词表改造计划

## 需求概述

将随机词表的分类维度从 **列名** 改为 **表名**：
- **原逻辑**：一个列 = 一个分类，单元格按逗号拆分 = 多个词
- **新逻辑**：一个表 = 一个分类，每表只有一行，一个单元格 = 一个完整的词

## 影响范围

| 文件 | 改动程度 | 说明 |
|------|----------|------|
| `composables/useWordPool.ts` | ★★★★★ | 核心逻辑全面重构 |
| `components/dashboard/RandomWordPoolWidget.vue` | ★★★★☆ | UI 展示和配置逻辑 |
| `stores/useDivinationStore.ts` | ★★★☆☆ | 配置字段重命名 |
| `types.ts` | ★★☆☆☆ | 类型定义更新 |
| `components/settings/divination/DivinationPanel.vue` | ★★☆☆☆ | 设置面板适配 |

---

## 详细修改计划

### 第一阶段：核心数据结构 (useWordPool.ts)

#### 1.1 更新 WordPool 接口

```typescript
// 原来
export interface WordPool {
  category: string;  // 列名
  words: string[];
}

// 改为
export interface WordPool {
  /** 表ID（如 "sheet_随机事件"） */
  tableId: string;
  /** 表显示名称（如 "随机事件"） */
  tableName: string;
  /** 该表第一行所有非空单元格 */
  words: string[];
}
```

#### 1.2 新增 getTableDisplayName() 辅助函数

```typescript
/**
 * 获取表的显示名称
 * @param tableId 表ID（不含 sheet_ 前缀）
 * @returns 显示名称，若无则返回 tableId
 */
export function getTableDisplayName(tableId: string): string {
  const api = getCore().getDB();
  const tableData = api?.exportTableAsJson?.();
  if (!tableData) return tableId;

  const sheetKey = `sheet_${tableId}`;
  const data = tableData[sheetKey];
  return (data as any)?.name || tableId;
}
```

#### 1.3 重写 parseWordPool()

```typescript
/**
 * 解析词库表数据（按表分组，单元格不拆分）
 */
export function parseWordPoolByTable(
  tableId: string,
  tableData: TableRow[],
): WordPool {
  const words: string[] = [];

  // 取最新一行（每表只有一行）
  const row = tableData[tableData.length - 1];
  if (row) {
    for (const cellValue of Object.values(row)) {
      if (cellValue && typeof cellValue === 'string') {
        const trimmed = cellValue.trim();
        if (trimmed) {
          words.push(trimmed);
        }
      }
    }
  }

  return {
    tableId,
    tableName: getTableDisplayName(tableId),
    words,
  };
}

/**
 * 【废弃兼容】原 parseWordPool 保留但标记废弃
 * @deprecated 使用 parseWordPoolByTable 代替
 */
export function parseWordPool(tableData: TableRow[]): WordPool[] {
  // 旧逻辑保留，但不再推荐使用
}
```

#### 1.4 重写 drawFromLatestRowWithConfig()

```typescript
export interface TableConfig {
  enabled: boolean;
  limit: number;  // 0 = 不限
}

export function drawFromLatestRowWithConfig(
  mode: 'perItem' | 'custom' | 'mixed',
  wordsPerItem: number,
  drawCount: number,
  tableConfig: Record<string, TableConfig>,  // 表ID → 配置
): string[] {
  const tables = detectWordPoolTables();
  const tableWords: Map<string, string[]> = new Map();

  for (const tableId of tables) {
    // 检查表是否启用
    const cfg = tableConfig[tableId];
    if (cfg && !cfg.enabled) continue;

    const rows = getWordPoolTableData(tableId);
    if (rows.length === 0) continue;

    const latestRow = rows[rows.length - 1];
    const words: string[] = [];

    // 每个单元格是一个词（不再按逗号拆分）
    for (const cellValue of Object.values(latestRow)) {
      if (cellValue && typeof cellValue === 'string') {
        const trimmed = cellValue.trim();
        if (trimmed) words.push(trimmed);
      }
    }

    if (words.length > 0) {
      tableWords.set(tableId, words);
    }
  }

  // 抽词逻辑
  const result: string[] = [];

  if (mode === 'perItem') {
    for (const [tableId, words] of tableWords) {
      const count = Math.min(wordsPerItem, words.length);
      const shuffled = shuffleArray([...words]);
      result.push(...shuffled.slice(0, count));
    }
  } else if (mode === 'custom') {
    let remaining = drawCount;
    for (const [tableId, words] of tableWords) {
      if (remaining <= 0) break;
      const cfg = tableConfig[tableId];
      const limit = cfg?.limit || 0;
      const maxFromTable = limit > 0
        ? Math.min(limit, remaining)
        : Math.min(wordsPerItem, remaining);
      const count = Math.min(maxFromTable, words.length);
      const shuffled = shuffleArray([...words]);
      result.push(...shuffled.slice(0, count));
      remaining -= count;
    }
  } else {
    // mixed 模式：所有表的词混合
    const allWords: string[] = [];
    for (const words of tableWords.values()) {
      allWords.push(...words);
    }
    const shuffled = shuffleArray(allWords);
    result.push(...shuffled.slice(0, Math.min(drawCount, shuffled.length)));
  }

  return result;
}
```

#### 1.5 更新 getAvailableColumns() → getAvailableTables()

```typescript
/**
 * 获取所有可用的词库表（用于 UI 配置）
 */
export function getAvailableTables(): { id: string; name: string }[] {
  const tables = detectWordPoolTables();
  return tables.map(tableId => ({
    id: tableId,
    name: getTableDisplayName(tableId),
  }));
}

// 【废弃兼容】
export function getAvailableColumns(): string[] {
  return getAvailableTables().map(t => t.id);
}
```

---

### 第二阶段：类型定义 (types.ts)

#### 2.1 更新 DivinationConfig

```typescript
export interface DivinationConfig {
  // ...其他字段保持不变

  /** @deprecated 使用 tablePoolConfig */
  tableColumnConfig?: Record<string, { enabled: boolean; limit: number }>;

  /** 表词库配置（表ID → 配置） */
  tablePoolConfig: Record<string, { enabled: boolean; limit: number }>;
}
```

---

### 第三阶段：Store 更新 (useDivinationStore.ts)

#### 3.1 配置迁移

```typescript
const DEFAULT_CONFIG: DivinationConfig = {
  // ...
  tablePoolConfig: {},  // 新字段
  tableColumnConfig: undefined,  // 废弃
};

// loadConfig() 中添加迁移逻辑
function loadConfig() {
  // ...原有加载逻辑

  // 迁移旧配置
  if (config.value.tableColumnConfig && !config.value.tablePoolConfig) {
    config.value.tablePoolConfig = { ...config.value.tableColumnConfig };
    delete config.value.tableColumnConfig;
    console.info('[Divination] Migrated tableColumnConfig → tablePoolConfig');
  }
}
```

#### 3.2 更新抽词调用

```typescript
// performDivination() 中
if (config.value.enableTableWords) {
  const tableWords = drawFromLatestRowWithConfig(
    config.value.wordDrawMode,
    config.value.wordsPerItem,
    config.value.drawCount,
    config.value.tablePoolConfig,  // 改用新字段
  );
  drawnWords.push(...tableWords);
}
```

---

### 第四阶段：UI 组件 (RandomWordPoolWidget.vue)

#### 4.1 数据结构

```typescript
interface TableData {
  id: string;       // 表ID
  name: string;     // 表显示名称
  words: string[];  // 该表所有词
}

const tables = ref<TableData[]>([]);
```

#### 4.2 加载逻辑

```typescript
function loadTableData(): void {
  const detectedTables = detectWordPoolTables();
  const result: TableData[] = [];

  for (const tableId of detectedTables) {
    const rows = getWordPoolTableData(tableId);
    if (rows.length === 0) continue;

    const latestRow = rows[rows.length - 1];
    const words: string[] = [];

    for (const cellValue of Object.values(latestRow)) {
      if (cellValue && typeof cellValue === 'string') {
        const trimmed = cellValue.trim();
        if (trimmed) words.push(trimmed);
      }
    }

    result.push({
      id: tableId,
      name: getTableDisplayName(tableId),
      words,
    });
  }

  tables.value = result;
}
```

#### 4.3 配置读写

```typescript
// 检查表是否启用
function isTableEnabled(tableId: string): boolean {
  const config = divinationStore.config.tablePoolConfig[tableId];
  return config ? config.enabled : true;  // 默认启用
}

// 切换表启用状态
function toggleTableEnabled(tableId: string): void {
  const current = divinationStore.config.tablePoolConfig[tableId] || {
    enabled: true,
    limit: 0,
  };
  divinationStore.config.tablePoolConfig[tableId] = {
    ...current,
    enabled: !current.enabled,
  };
}

// 获取/设置表的抽词限制
function getTableLimit(tableId: string): number {
  return divinationStore.config.tablePoolConfig[tableId]?.limit || 0;
}

function setTableLimit(tableId: string, limit: number): void {
  const current = divinationStore.config.tablePoolConfig[tableId] || {
    enabled: true,
    limit: 0,
  };
  divinationStore.config.tablePoolConfig[tableId] = {
    ...current,
    limit,
  };
}
```

#### 4.4 模板更新

```vue
<!-- 原来的 "列分组" 改为 "表分组" -->
<div
  v-for="table in tables"
  :key="table.id"
  class="rwp-table-group"
  :class="{ collapsed: !expandedTables[table.id] }"
>
  <div class="rwp-group-header" @click="toggleTable(table.id)">
    <div class="rwp-header-left">
      <i class="fas" :class="expandedTables[table.id] ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
      <span class="rwp-table-name">{{ table.name }}</span>
      <span class="rwp-word-count">({{ table.words.length }})</span>
    </div>
    <!-- 配置控件使用 table.id 作为键 -->
  </div>
</div>
```

---

### 第五阶段：样式更新 (可选)

如果 CSS 类名也需要更新（非必须，但建议）：

```scss
// styles/components/random-word-pool.scss

// 原来的 .rwp-column-* 改为 .rwp-table-*（或保持不变也可）
.rwp-table-group { /* ... */ }
.rwp-table-name { /* ... */ }
```

---

## 兼容性处理

1. **配置迁移**：`tableColumnConfig` → `tablePoolConfig`，loadConfig 时自动迁移
2. **API 兼容**：保留 `parseWordPool()` 和 `getAvailableColumns()` 但标记 `@deprecated`
3. **渐进式**：先发布带迁移逻辑的版本，下一版本再移除废弃 API

---

## 测试要点

1. **新表检测**：创建名为 "随机xxx" 的表，确认被正确识别
2. **单元格不拆分**：单元格内容 "苹果,香蕉" 应作为整体一个词
3. **抽词逻辑**：
   - perItem 模式：每表抽 N 个
   - custom 模式：每表最多抽 limit 个，总数不超过 drawCount
   - mixed 模式：所有表混合后抽取
4. **配置持久化**：刷新页面后配置（启用/限制）应保留
5. **仪表盘展示**：按表分组显示词条

---

## 工作量估计

| 阶段 | 文件数 | 复杂度 |
|------|--------|--------|
| 核心逻辑 | 1 | 高 |
| 类型定义 | 1 | 低 |
| Store | 1 | 中 |
| UI 组件 | 1 | 中 |
| 样式 | 1 | 低 |

总计约 **5 个文件**，预计 **中等工作量**。

---

## 下一步

确认此计划后，切换到 Code 模式逐步实现。建议按阶段顺序进行：
1. 先改 useWordPool.ts（核心）
2. 再改 types.ts（定义）
3. 然后改 useDivinationStore.ts（调用）
4. 最后改 RandomWordPoolWidget.vue（展示）
