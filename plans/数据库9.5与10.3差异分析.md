# æ•°æ®åº“ 9.5 ä¸ 10.3 å·®å¼‚åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

ç”¨æˆ·åé¦ˆï¼šåœ¨ä½¿ç”¨å¯è§†åŒ–è¡¨æ ¼æŒ‰åˆ·æ–°æŒ‰é’®åï¼Œæ•°æ®åº“ 9.5 å’Œ 10.3 è¿”å›çš„æ•°æ®ä¸ä¸€è‡´ã€‚

- **9.5**: æœªæ›´æ–°æ¥¼å±‚ - å‰3è¡¨æ˜¾ç¤º2ï¼Œå3è¡¨æ˜¾ç¤º1ï¼ˆæ¯ä¸ªè¡¨ç‹¬ç«‹è¿½è¸ªæœ€æ–°ä½ç½®ï¼‰
- **10.3**: æœªæ›´æ–°æ¥¼å±‚ç»Ÿç»Ÿæ˜¾ç¤º52ï¼ˆä¼¼ä¹æŒ‰æŸç§"æ•´ä½“"é€»è¾‘å¤„ç†ï¼‰

---

## ğŸ” æ ¸å¿ƒå‘ç°

### 10.3 æ–°å¢çš„ã€ŒæŒ‡å¯¼è¡¨ã€(SheetGuide) æœºåˆ¶

10.3 ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„æ¦‚å¿µï¼š**èŠå¤©çº§ç©ºç™½æŒ‡å¯¼è¡¨**ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†è¡¨æ ¼ç»“æ„ã€å‚æ•°å’Œé¡ºåºã€‚

#### å­˜å‚¨ä½ç½®
```
chat[0].TavernDB_ACU_InternalSheetGuide = {
  version: 1,
  tags: {
    [isolationKey]: {  // éš”ç¦»æ ‡ç­¾é”®ï¼ˆæ— æ ‡ç­¾æ—¶ä¸ºç©ºå­—ç¬¦ä¸² ""ï¼‰
      data: { mate: {...}, sheet_0: {...}, sheet_1: {...} },  // åªå«è¡¨å¤´+å‚æ•°
      updatedAt: 1736502600000,  // æ›´æ–°æ—¶é—´æˆ³
      reason: 'visualizer_save'  // æ›´æ–°åŸå› 
    }
  }
}
```

#### æŒ‡å¯¼è¡¨çš„ä½œç”¨
1. **è¡¨ç»“æ„æŒ‡å¯¼**ï¼šåªä¿ç•™è¡¨å¤´è¡Œï¼Œæ— æ•°æ®è¡Œ
2. **å‚æ•°ç»Ÿä¸€**ï¼šåŒ…å« `sourceData`ã€`updateConfig`ã€`exportConfig` ç­‰
3. **é¡ºåºæ§åˆ¶**ï¼šåŒ…å« `orderNo` å­—æ®µæ§åˆ¶è¡¨æ ¼æ˜¾ç¤ºé¡ºåº
4. **è¿‡æ»¤æ—§è¡¨**ï¼šä¸åœ¨æŒ‡å¯¼è¡¨ä¸­çš„è¡¨æ ¼ä¼šè¢«æ’é™¤

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®ç´¢å¼•

### æ•°æ®åº“è„šæœ¬å·®å¼‚

| åŠŸèƒ½ | 9.5 ä½ç½® | 10.3 ä½ç½® | å˜åŒ–è¯´æ˜ |
|------|----------|-----------|----------|
| exportTableAsJson | [è¡Œ1182-1186](.kilocode/æ•°æ®åº“/9.5index.js:1182) | [è¡Œ2333-2337](.kilocode/æ•°æ®åº“/10.3index.js:2333) | **æ— å˜åŒ–** - éƒ½åªè¿”å› `currentJsonTableData_ACU` |
| mergeAllIndependentTables_ACU | [è¡Œ2161-2293](.kilocode/æ•°æ®åº“/9.5index.js:2161) | [è¡Œ3542-3784](.kilocode/æ•°æ®åº“/10.3index.js:3542) | **é‡å¤§å˜åŒ–** - 10.3 æ–°å¢æŒ‡å¯¼è¡¨å¤„ç†é€»è¾‘ |
| refreshMergedDataAndNotify_ACU | [è¡Œ2296-2370](.kilocode/æ•°æ®åº“/9.5index.js:2296) | [è¡Œ3786-3890](.kilocode/æ•°æ®åº“/10.3index.js:3786) | **å˜åŒ–** - 10.3 æ–°å¢ç©ºæ•°æ®å…œåº•é€»è¾‘ |
| syncWorldbookEntries | [è¡Œ1436-1444](.kilocode/æ•°æ®åº“/9.5index.js:1436) | [è¡Œ2542-2550](.kilocode/æ•°æ®åº“/10.3index.js:2542) | **æ— å˜åŒ–** |
| saveVisualizerChanges_ACU | [è¡Œ16724](.kilocode/æ•°æ®åº“/9.5index.js:16724) | [è¡Œ19280-19400](.kilocode/æ•°æ®åº“/10.3index.js:19280) | **å˜åŒ–** - 10.3 æ–°å¢æŒ‡å¯¼è¡¨æ›´æ–° |

### 10.3 æ–°å¢ä»£ç 

| åŠŸèƒ½ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| CHAT_SHEET_GUIDE_FIELD å¸¸é‡ | [è¡Œ3086-3087](.kilocode/æ•°æ®åº“/10.3index.js:3086) | æŒ‡å¯¼è¡¨å­—æ®µåå®šä¹‰ |
| getChatSheetGuideDataForIsolationKey_ACU | [è¡Œ3132-3175](.kilocode/æ•°æ®åº“/10.3index.js:3132) | è·å–æŒ‡å¯¼è¡¨æ•°æ® |
| setChatSheetGuideDataForIsolationKey_ACU | [è¡Œ3175-3192](.kilocode/æ•°æ®åº“/10.3index.js:3175) | è®¾ç½®æŒ‡å¯¼è¡¨æ•°æ® |
| buildChatSheetGuideDataFromData_ACU | [è¡Œ3195-3215](.kilocode/æ•°æ®åº“/10.3index.js:3195) | ä»æ•°æ®æ„å»ºæŒ‡å¯¼è¡¨ |
| buildGuidedBaseDataFromSheetGuide_ACU | [è¡Œ3320-3324](.kilocode/æ•°æ®åº“/10.3index.js:3320) | ä»æŒ‡å¯¼è¡¨æ„å»ºåŸºç¡€æ•°æ® |
| normalizeGuideData_ACU | [è¡Œ3105-3130](.kilocode/æ•°æ®åº“/10.3index.js:3105) | è§„èŒƒåŒ–æŒ‡å¯¼è¡¨æ•°æ® |

---

## ğŸ”„ åˆå¹¶é€»è¾‘å·®å¼‚è¯¦è§£

### 9.5 çš„é€»è¾‘ (è¡Œ2161-2293)

```javascript
// ç®€åŒ–ç‰ˆé€»è¾‘
for (let i = chat.length - 1; i >= 0; i--) {  // å€’åºéå†æ‰€æœ‰æ¥¼å±‚
    Object.keys(independentData).forEach(sheetKey => {
        if (!foundSheets[sheetKey]) {  // æ¯ä¸ªè¡¨ç‹¬ç«‹æ‰¾æœ€æ–°
            mergedData[sheetKey] = independentData[sheetKey];
            foundSheets[sheetKey] = true;
            // è®°å½•è¿™ä¸ªè¡¨çš„"æœ€è¿‘æ›´æ–°æ¥¼å±‚"
        }
    });
}
// å¦‚æœæ²¡æ‰¾åˆ°ä»»ä½•è¡¨ï¼Œè¿”å› null
if (foundCount <= 0) return null;

return reorderDataBySheetKeys(mergedData);  // ç›´æ¥è¿”å›
```

### 10.3 çš„é€»è¾‘ (è¡Œ3542-3784)

```javascript
// ç¬¬1æ­¥ï¼šè·å–æŒ‡å¯¼è¡¨
const sheetGuideData = getChatSheetGuideDataForIsolationKey_ACU(currentIsolationKey);
const hasSheetGuide = !!(sheetGuideData && ...);

// ç¬¬2æ­¥ï¼šå’Œ9.5ä¸€æ ·ï¼Œå€’åºæ‰¾æ¯ä¸ªè¡¨çš„æœ€æ–°æ•°æ®
for (let i = chat.length - 1; i >= 0; i--) { /* åŒ9.5 */ }

// ç¬¬3æ­¥ã€æ–°å¢ã€‘ï¼šå¦‚æœ foundCount <= 0
if (foundCount <= 0) {
    if (hasSheetGuide) {
        // ç”¨æŒ‡å¯¼è¡¨ç»“æ„ + æ¨¡æ¿é¢„ç½®æ•°æ®å¡«å……
        return buildGuidedBaseDataFromSheetGuide(...);
    }
    return null;
}

// ç¬¬4æ­¥ã€æ–°å¢ã€‘ï¼šupdateConfig å…¼å®¹è¿ç§» (0 â†’ -1)
Object.keys(mergedData).forEach(k => { /* è½¬æ¢é€»è¾‘ */ });

// ç¬¬5æ­¥ã€æ–°å¢ã€‘ï¼šå¦‚æœå­˜åœ¨æŒ‡å¯¼è¡¨ï¼Œç”¨æŒ‡å¯¼è¡¨é‡ç»„æ•°æ®
if (hasSheetGuide) {
    const guided = buildGuidedBaseDataFromSheetGuide(sheetGuideData);
    guideKeys.forEach(k => {
        if (mergedData[k]) guided[k] = mergedData[k];  // ä¿ç•™å†å²æ•°æ®
        else { /* ç”¨æ¨¡æ¿å¡«å…… */ }
    });
    mergedData = guided;  // â† å…³é”®ï¼šç”¨æŒ‡å¯¼è¡¨çš„ç»“æ„æ›¿æ¢
}

return reorderDataBySheetKeys(mergedData);
```

---

## âš ï¸ é—®é¢˜æ ¹å› 

å¯è§†åŒ–è¡¨æ ¼é¡¹ç›®åœ¨ä¿å­˜æ—¶ï¼š
1. âœ… æ­£ç¡®å†™å…¥ `TavernDB_ACU_IsolatedData` åˆ°ç›®æ ‡æ¥¼å±‚
2. âŒ **æ²¡æœ‰æ›´æ–° `chat[0].TavernDB_ACU_InternalSheetGuide`**

å¯¼è‡´ 10.3 åˆ·æ–°æ—¶ï¼š
1. è¯»å–æ—§çš„æŒ‡å¯¼è¡¨ï¼ˆå¯èƒ½æ˜¯ä¹‹å‰æ•°æ®åº“ç¼–è¾‘å™¨åˆ›å»ºçš„ï¼‰
2. ç”¨æ—§æŒ‡å¯¼è¡¨çš„ç»“æ„é‡ç»„æ•°æ®
3. ç»“æœä¸é¢„æœŸä¸ç¬¦

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### å·²å®æ–½çš„ä¿®æ”¹

**æ–‡ä»¶**: [`src/å¯è§†åŒ–è¡¨æ ¼/composables/useDataPersistence.ts`](../src/å¯è§†åŒ–è¡¨æ ¼/composables/useDataPersistence.ts)

#### 1. æ–°å¢å¸¸é‡å’Œè¾…åŠ©å‡½æ•°ï¼ˆè¡Œ19-200ï¼‰

```typescript
// 10.3+ æŒ‡å¯¼è¡¨å­—æ®µå
const CHAT_SHEET_GUIDE_FIELD = 'TavernDB_ACU_InternalSheetGuide';
const CHAT_SHEET_GUIDE_VERSION = 1;
const TABLE_ORDER_FIELD = 'orderNo';

// æ„å»ºæŒ‡å¯¼è¡¨æ•°æ®
function buildSheetGuideData(rawData: RawDatabaseData): Record<string, unknown> { ... }

// æ›´æ–° chat[0] ä¸­çš„æŒ‡å¯¼è¡¨
function updateSheetGuide(ST: any, configKey: string, guideData: Record<string, unknown>): boolean { ... }

// è·å–æŒ‡å¯¼è¡¨ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
function getSheetGuideInfo(ST: any, configKey: string): { ... } { ... }
```

#### 2. åœ¨ executeCoreSave ä¸­è°ƒç”¨ï¼ˆè¡Œ350-358ï¼‰

```typescript
// F. åŒæ­¥æ›´æ–°æŒ‡å¯¼è¡¨ï¼ˆ10.3+ å…¼å®¹ï¼‰
if (sheetsToSave.length > 0) {
    const guideData = buildSheetGuideData(finalData);
    if (Object.keys(guideData).some(k => k.startsWith('sheet_'))) {
        updateSheetGuide(ST, finalKey, guideData);
    }
}
```

### å…¼å®¹æ€§è¯´æ˜

- **9.5 åŠä»¥ä¸‹ç‰ˆæœ¬**ï¼š`chat[0].TavernDB_ACU_InternalSheetGuide` å­—æ®µä¸å­˜åœ¨ï¼Œæˆ‘ä»¬çš„å†™å…¥æ“ä½œä¼šæˆåŠŸï¼Œä½†ä¸ä¼šå½±å“æ—§ç‰ˆæ•°æ®åº“çš„åˆå¹¶é€»è¾‘
- **10.3 åŠä»¥ä¸Šç‰ˆæœ¬**ï¼šæŒ‡å¯¼è¡¨ä¼šè¢«æ­£ç¡®æ›´æ–°ï¼Œç¡®ä¿åˆ·æ–°æ—¶ä½¿ç”¨æœ€æ–°çš„è¡¨ç»“æ„

---

## ğŸ“Š å·²çŸ¥çš„ reason å€¼

| reason | è§¦å‘åœºæ™¯ |
|--------|---------|
| `'first_fill'` | æ•°æ®åº“ç¬¬ä¸€æ¬¡å¡«è¡¨ ([è¡Œ9094-9100](.kilocode/æ•°æ®åº“/10.3index.js:9094)) |
| `'visualizer_save'` | æ•°æ®åº“å¯è§†åŒ–ç¼–è¾‘å™¨æ™®é€šä¿å­˜ ([è¡Œ19315-19318](.kilocode/æ•°æ®åº“/10.3index.js:19315)) |
| `'visualizer_save_to_template'` | æ•°æ®åº“å¯è§†åŒ–ç¼–è¾‘å™¨ä¿å­˜åˆ°æ¨¡æ¿ |
| `'template_changed'` | æ¨¡æ¿å˜æ›´ ([è¡Œ3244](.kilocode/æ•°æ®åº“/10.3index.js:3244)) |
| `'vue_visualizer_save'` | **æˆ‘ä»¬çš„å¯è§†åŒ–è¡¨æ ¼ä¿å­˜** |

---

## ğŸ”§ è°ƒè¯•æ–¹æ³•

åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹å½“å‰æŒ‡å¯¼è¡¨ï¼š

```javascript
// æŸ¥çœ‹å®Œæ•´çš„æŒ‡å¯¼è¡¨
console.log(SillyTavern.chat[0]?.TavernDB_ACU_InternalSheetGuide);

// è·å–å½“å‰éš”ç¦»é”®ä¸‹çš„è¯¦ç»†ä¿¡æ¯
const settings = JSON.parse(localStorage.getItem('shujuku_v34_allSettings_v2') || '{}');
const isolationKey = settings.dataIsolationEnabled ? settings.dataIsolationCode : '';
const container = SillyTavern.chat[0]?.TavernDB_ACU_InternalSheetGuide;
if (container?.tags?.[isolationKey]) {
    const slot = container.tags[isolationKey];
    console.log('æ›´æ–°æ—¶é—´:', new Date(slot.updatedAt).toLocaleString());
    console.log('æ›´æ–°åŸå› :', slot.reason);
    console.log('è¡¨æ ¼åˆ—è¡¨:', Object.keys(slot.data).filter(k => k.startsWith('sheet_')));
}
```

---

## ğŸ“… æ›´æ–°æ—¥æœŸ

2026-01-10
# ğŸ“¦ 10.3 è¡¨æ ¼æ¨¡æ¿çƒ­é‡è½½æœºåˆ¶

### æ¨¡æ¿å­˜å‚¨ä¸åŠ è½½

10.3 ä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ `TABLE_TEMPLATE_ACU` å­˜å‚¨æ¨¡æ¿ï¼š

```javascript
// å†…å­˜å˜é‡
let TABLE_TEMPLATE_ACU = DEFAULT_TABLE_TEMPLATE_ACU;  // Line 1461

// ä» localStorage è¯»å–ï¼ˆæŒ‰ Profile åŒºåˆ†ï¼‰
function loadProfileTemplate_ACU(code) {
    const store = getConfigStorage_ACU();
    const key = getProfileTemplateKey_ACU(code);
    const raw = store.getItem(key);
    // è§£æã€éªŒè¯ã€æ¸…æ´—...
    TABLE_TEMPLATE_ACU = JSON.stringify(sanitizedTemplate);
    writeProfileTemplateToStorage_ACU(code, TABLE_TEMPLATE_ACU);
}
```

---

### çƒ­é‡è½½è§¦å‘æ—¶æœº

10.3 åœ¨ä»¥ä¸‹æ“ä½œåä¼šé‡æ–°åŠ è½½æ¨¡æ¿å¹¶åˆ·æ–°æ•°æ®ï¼š

| è§¦å‘åœºæ™¯ | å…³é”®å‡½æ•° | è¡Œå· |
|----------|----------|------|
| **å¯¼å…¥æ¨¡æ¿** | `importTableTemplate_ACU()` | 17349-17437 |
| **é‡ç½®æ¨¡æ¿** | é‡ç½®æŒ‰é’®å¤„ç† | 17303-17340 |
| **å¯¼å…¥åˆå¹¶æ–‡ä»¶** | å«æ¨¡æ¿çš„å¯¼å…¥ | 16895-16901 |
| **åˆ‡æ¢èŠå¤©** | `CHAT_CHANGED` äº‹ä»¶ | 9444-9468 |

---

### å…³é”®ï¼š10.3 çš„ç©ºç™½æŒ‡å¯¼è¡¨åŒæ­¥

**è¿™æ˜¯9.5æ²¡æœ‰çš„æ–°æœºåˆ¶**ï¼šæ¯æ¬¡ä¿®æ”¹æ¨¡æ¿åï¼Œéƒ½ä¼šåŒæ­¥æ›´æ–° `chat[0]` ä¸­çš„"ç©ºç™½æŒ‡å¯¼è¡¨"ï¼š

```javascript
// Line 17421-17422 (å¯¼å…¥æ¨¡æ¿å)
try {
    await overwriteChatSheetGuideFromTemplate_ACU(sanitized, { reason: 'import_template' });
} catch (e) {}
```

[`overwriteChatSheetGuideFromTemplate_ACU`](.kilocode/æ•°æ®åº“/10.3index.js:3243) çš„å®Œæ•´æµç¨‹ï¼š

```javascript
async function overwriteChatSheetGuideFromTemplate_ACU(templateObj, { reason }) {
    // 1. ä»æ¨¡æ¿æ„å»ºç©ºç™½æŒ‡å¯¼è¡¨ï¼ˆåªä¿ç•™è¡¨å¤´+å‚æ•°ï¼‰
    const guideData = buildChatSheetGuideDataFromTemplateObj_ACU(templateObj, { stripSeedRows: true });

    // 2. å†™å…¥ chat[0] çš„ TavernDB_ACU_InternalSheetGuide
    setChatSheetGuideDataForIsolationKey_ACU(isolationKey, guideData, { reason });

    // 3. ä¿å­˜èŠå¤©
    await SillyTavern_API_ACU.saveChat();

    // 4. åˆ·æ–°åˆå¹¶æ•°æ®å¹¶é€šçŸ¥å‰ç«¯
    await refreshMergedDataAndNotify_ACU();
}
```

---

### refreshMergedDataAndNotify_ACU çš„åˆ·æ–°é“¾è·¯

è¿™æ˜¯æ ¸å¿ƒåˆ·æ–°å‡½æ•° [Line 3786](.kilocode/æ•°æ®åº“/10.3index.js:3786)ï¼š

```javascript
async function refreshMergedDataAndNotify_ACU() {
    // 1. é‡æ–°åŠ è½½èŠå¤©è®°å½•
    await loadAllChatMessages_ACU();

    // 2. åˆå¹¶æ•°æ®ï¼ˆæ­¤æ—¶ä¼šè¯»å–æ–°çš„ç©ºç™½æŒ‡å¯¼è¡¨ï¼ï¼‰
    const merged = mergeAllIndependentTables_ACU(...);
    currentJsonTableData_ACU = merged;

    // 3. æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®
    await updateReadableLorebookEntry_ACU();

    // 4. é€šçŸ¥å‰ç«¯ UI åˆ·æ–°
    AutoCardUpdaterAPI._notifyTableUpdate();
}
```

---

### ä¸ºä»€ä¹ˆ9.5å’Œ10.3åˆ·æ–°ç»“æœä¸åŒï¼Ÿ

**9.5 çš„åˆ·æ–°**ï¼š
- ç›´æ¥ä»èŠå¤©è®°å½•åˆå¹¶æ•°æ®
- ä½¿ç”¨ `TABLE_TEMPLATE_ACU` ä½œä¸ºç»“æ„å‚è€ƒ
- æ²¡æœ‰"æŒ‡å¯¼è¡¨"æ¦‚å¿µ

**10.3 çš„åˆ·æ–°**ï¼š
1. å…ˆæ£€æŸ¥ `chat[0]` æ˜¯å¦æœ‰ `TavernDB_ACU_InternalSheetGuide`
2. å¦‚æœæœ‰ â†’ ç”¨å®ƒæ¥é‡ç»„æ•°æ®ï¼ˆè¿‡æ»¤è¡¨ã€å¡«å……ç¼ºå¤±è¡¨ï¼‰
3. å¦‚æœæ²¡æœ‰ä½†æœ‰æ—§çš„ `TavernDB_ACU_TableHeaderGuide` â†’ ä»æ¨¡æ¿æ„å»ºä¸€ä¸ªä¸´æ—¶æŒ‡å¯¼è¡¨
4. æœ€åæ‰å›é€€åˆ°9.5çš„é€»è¾‘

---

### ğŸ”§ å¦‚ä½•è®©å¯è§†åŒ–è¡¨æ ¼å…¼å®¹10.3çš„çƒ­é‡è½½ï¼Ÿ

**æ–¹æ¡ˆA**ï¼šç›‘å¬æ¨¡æ¿å˜æ›´äº‹ä»¶ï¼ˆå¦‚æœæœ‰æš´éœ²çš„è¯ï¼‰

```javascript
// å‡è®¾æ•°æ®åº“æœ‰æš´éœ²æ¨¡æ¿å˜æ›´é€šçŸ¥
AutoCardUpdaterAPI.onTemplateChange?.(() => {
    // é‡æ–°è·å–æ•°æ®
    const newData = AutoCardUpdaterAPI.exportTableAsJson();
    // æ›´æ–° store
});
```

**æ–¹æ¡ˆB**ï¼šä¿å­˜æ—¶åŒæ­¥æ›´æ–°æŒ‡å¯¼è¡¨ï¼ˆå·²å®ç°ï¼‰

æˆ‘ä»¬ä¹‹å‰åœ¨ `useDataPersistence.ts` ä¸­æ·»åŠ çš„ `updateSheetGuide()` å‡½æ•°å°±æ˜¯ä¸ºæ­¤è®¾è®¡çš„ï¼Œå®ƒä¼šåœ¨ä¿å­˜æ•°æ®æ—¶åŒæ­¥æ›´æ–° `chat[0]` çš„æŒ‡å¯¼è¡¨ç»“æ„ï¼Œç¡®ä¿10.3çš„åˆå¹¶é€»è¾‘èƒ½è·å–æ­£ç¡®çš„è¡¨æ ¼å®šä¹‰ã€‚

---

### æ€»ç»“

10.3 çš„"çƒ­é‡è½½"ä¸æ˜¯çœŸæ­£çš„è¿è¡Œæ—¶çƒ­æ›¿æ¢ï¼Œè€Œæ˜¯ï¼š
1. **ä¿®æ”¹å†…å­˜å˜é‡** `TABLE_TEMPLATE_ACU`
2. **æŒä¹…åŒ–åˆ° localStorage**ï¼ˆæŒ‰ Profileï¼‰
3. **åŒæ­¥åˆ° chat[0] çš„ç©ºç™½æŒ‡å¯¼è¡¨**ï¼ˆæ–°æœºåˆ¶ï¼‰
4. **è§¦å‘ `refreshMergedDataAndNotify_ACU`** é‡æ–°åˆå¹¶æ•°æ®
5. **é€šçŸ¥æ‰€æœ‰å‰ç«¯å›è°ƒ**

æ ¸å¿ƒåŒºåˆ«æ˜¯ç¬¬3æ­¥çš„ç©ºç™½æŒ‡å¯¼è¡¨åŒæ­¥ï¼Œè¿™ç¡®ä¿äº†æ¨¡æ¿å˜æ›´åï¼Œæ•°æ®åˆå¹¶é€»è¾‘èƒ½ç«‹å³ä½¿ç”¨æ–°ç»“æ„ã€‚
# ğŸ“¦ 10.3 æ•°æ®åº“æœªæ›´æ–°æ¥¼å±‚ï¼ˆlastUpdatedAiFloorï¼‰æœºåˆ¶
## âœ… å®Œå…¨ç†è§£äº†æ•°æ®åº“çš„åˆå¹¶é€»è¾‘ï¼

### åˆå¹¶æ•°æ®æ—¶ [10.3index.js:3573-3596](file:.kilocode/æ•°æ®åº“/10.3index.js:3573)

```javascript
Object.keys(independentData).forEach(storedSheetKey => {
    if (!foundSheets[storedSheetKey]) {  // â† åªå–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
        mergedData[storedSheetKey] = independentData[storedSheetKey];
        foundSheets[storedSheetKey] = true;

        // åŒæ—¶æ›´æ–° lastUpdatedAiFloor
        let wasUpdated = false;
        if (updateGroupKeys.length > 0 && modifiedKeys.length > 0) {
            wasUpdated = updateGroupKeys.includes(storedSheetKey);
        } else if (modifiedKeys.length > 0) {
            wasUpdated = modifiedKeys.includes(storedSheetKey);
        } else {
            wasUpdated = true;  // â† éƒ½æ²¡æœ‰å°±é»˜è®¤ trueï¼
        }

        if (wasUpdated) {
            lastUpdatedAiFloor = currentAiFloor;  // æ›´æ–°æ¥¼å±‚è®°å½•
        }
    }
});
```

### æ€»ç»“

| åŠŸèƒ½ | æ˜¯å¦çœ‹ keys | è¯´æ˜ |
|------|------------|------|
| æ•°æ®åˆå¹¶ | **å¦** | åªå–ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„è¡¨æ•°æ®ï¼Œä¸ç®¡ keys |
| æ¥¼å±‚è®¡ç®— | **æ˜¯** | ç”¨ keys åˆ¤æ–­"è¿™ä¸ªè¡¨åœ¨æ­¤æ¥¼å±‚æ˜¯å¦è¢«æ›´æ–°" |

### å›ç­”æ‚¨çš„é—®é¢˜

> è‡ªåŠ¨æ›´æ–°æ—¶ï¼Œæ•°æ®åº“çœ‹ä¸çœ‹è¿™ä¸¤ä¸ªkeyï¼Ÿè¿˜æ˜¯åªè¦æ‰¾åˆ°äº†æœ€è¿‘çš„æ•°æ®éƒ½ç›´æ¥ç”¨æ¥åˆå¹¶ï¼Ÿ

**ä¸¤è€…éƒ½å¯¹**ï¼š
1. **æ•°æ®**ï¼šç›´æ¥ç”¨æœ€è¿‘æ‰¾åˆ°çš„ï¼ˆ190æ¥¼æœ‰å°±ç”¨190æ¥¼çš„ï¼‰
2. **æ¥¼å±‚è®°å½•**ï¼šçœ‹ keys æ¥å†³å®š `lastUpdatedAiFloor`

### æ‚¨çš„æœŸæœ›åŠŸèƒ½

> æˆ‘å¯¹æ€»ç»“è¡¨è¿›è¡Œä¿®æ”¹åï¼Œä¸‹ä¸€æ¬¡è§¦å‘è‡ªåŠ¨æ€»ç»“æ—¶ï¼Œä¼šåœ¨æˆ‘çš„ä¿®æ”¹ä¸Šç»§ç»­å¡«è¡¨å—ï¼Ÿ

**æ˜¯çš„ï¼** å› ä¸ºæ•°æ®åˆå¹¶ä¸çœ‹ keysï¼Œåªå–æœ€æ–°æ•°æ®ã€‚æ‰€ä»¥å³ä½¿ `lastUpdatedAiFloor` å˜äº†ï¼ŒAI å¡«è¡¨æ—¶è¯»å–çš„**æ•°æ®**ä»ç„¶æ˜¯æ‚¨ä¿®æ”¹åçš„ç‰ˆæœ¬ã€‚

åªæ˜¯"æœªè®°å½•æ¥¼å±‚"ä¼šå˜æˆ0ï¼ˆæç¤ºæ‚¨æ‰‹åŠ¨ä¿®æ”¹å·²åŒæ­¥ï¼‰ï¼Œä½†ä¸å½±å“ AI ç»§ç»­åœ¨æ‚¨çš„åŸºç¡€ä¸Šå¡«è¡¨ã€‚
## âœ… å®Œå…¨ç†è§£äº†ï¼`updateGroupKeys` çš„ä½œç”¨

### æ•°æ®åº“çš„ä¿å­˜é€»è¾‘ [10.3index.js:9155-9162](file:.kilocode/æ•°æ®åº“/10.3index.js:9155)

```javascript
// åªæœ‰å½“ updateGroupKeys å‚æ•°å­˜åœ¨ä¸”æœ‰å®é™…ä¿®æ”¹æ—¶æ‰å†™å…¥
if (updateGroupKeys && updateGroupKeys.length > 0 && actuallyModifiedKeys.length > 0) {
    currentTagData.updateGroupKeys = [...new Set([...existingGroupKeys, ...updateGroupKeys])];
}
```

**`updateGroupKeys` æ˜¯ç”±æ•°æ®åº“åœ¨ AI è‡ªåŠ¨æ›´æ–°æ—¶ä¼ å…¥çš„**ï¼Œè¡¨ç¤º"æœ¬æ‰¹æ¬¡å‚ä¸åˆå¹¶æ›´æ–°çš„æ‰€æœ‰è¡¨æ ¼"ã€‚

### æˆ‘ä»¬çš„é—®é¢˜

æˆ‘ä»¬çš„å¯è§†åŒ–å·¥å…·ä¿å­˜æ—¶ï¼š
```typescript
updateGroupKeys: [],  // ç©ºï¼æ²¡æœ‰ä¼ å…¥åˆå¹¶ç»„ä¿¡æ¯
```

è¿™å¯¼è‡´ï¼š
- **æ™®é€šä¿å­˜**ï¼šå†™å…¥å·²æœ‰æ•°æ®çš„æ¥¼å±‚ï¼Œ188æ¥¼å·²æœ‰ `updateGroupKeys = [4ä¸ªæ™®é€šè¡¨]`
- **å¦å­˜ä¸º**ï¼šå†™å…¥æ–°æ¥¼å±‚190ï¼Œ`updateGroupKeys = []`

### åˆ¤æ–­é€»è¾‘åˆ†æ

| è¡¨æ ¼ç±»å‹ | æ¥¼å±‚190åˆ¤æ–­ | ç»“æœ |
|----------|-------------|------|
| æ™®é€šè¡¨ | `[] > 0` = false â†’ ç”¨ modifiedKeys â†’ æ‰¾åˆ° | åº”è¯¥è¯†åˆ« |
| æ€»ç»“è¡¨ | åŒä¸Š | åº”è¯¥è¯†åˆ« |

**ç†è®ºä¸Š190æ¥¼åº”è¯¥è¢«è¯†åˆ«ä¸ºæ‰€æœ‰è¡¨çš„æœ€æ–°æ›´æ–°ä½ç½®ï¼**

### éªŒè¯è¯·æ±‚

è¯·åœ¨é…’é¦†ä¸­æ‰‹åŠ¨åˆ·æ–°æ•°æ®åº“çŠ¶æ€ï¼Œç„¶åå†çœ‹æœªè®°å½•æ¥¼å±‚ï¼š

```javascript
// è°ƒç”¨æ•°æ®åº“çš„åˆ·æ–°å‡½æ•°
window.AutoCardUpdaterAPI.notifyTableUpdate && window.AutoCardUpdaterAPI.notifyTableUpdate();

// æˆ–è€…é‡æ–°æ‰“å¼€æ•°æ®åº“é¢æ¿
```

