# 人际关系图功能规划

## 一、关系类型与颜色体系

### 1.1 关系类型分级（从亲密到敌对）

| 级别 | 类型名 | 颜色 | 关键词示例 |
|------|--------|------|-----------|
| **S** | 爱情/伴侣/沉迷 | 💗 #E91E63 (粉红) | 恋、恋人、男友、女友、爱、暧昧、暗恋、情人、伴侣、老婆、老公、丈夫、妻子、粉丝、迷 |
| **A** | 家人/挚友 | 💙 #2196F3 (蓝) | 父、母、兄、弟、姐、妹、爷、奶、叔、姑、舅、姨、挚友、知己、青梅竹马、发小、闺蜜、死党、义兄、义妹 |
| **B** | 朋友/同伴 | 💚 #4CAF50 (绿) | 友、朋友、战友、伙伴、同窗、师徒、弟子、师傅、老师、学生、队友 |
| **C** | 社会关系 | ⚪ #9E9E9E (灰) | 同事、邻居、舍友、室友、顾客、客户、上司、下属、同学、路人、熟人 |
| **D** | 利益关系 | 💛 #FF9800 (橙) | 合作、雇佣、交易、债务、炮友、利用、工具人、棋子、操控 |
| **E** | 敌对关系 | ❤️‍🔥 #F44336 (红) | 仇、敌、死、对手、竞争、仇敌、死敌、宿敌、威胁、敌对 |
| **?** | 复杂/未知 | 🟣 #9C27B0 (紫) | 无法归类或混合对立情感 |

### 1.2 多关系词颜色覆盖规则

**方案：冲突检测 + 最高级优先**
- 如果同时出现正面（S/A/B级）和负面（E级）→ 显示紫色（复杂）
- 否则取最高级：`S > A > E > D > B > C`

---

## 二、布局模式说明

### 2.1 三种布局对比

| 布局 | 名称 | 算法原理 | 适用场景 | 效果图示 |
|------|------|----------|----------|----------|
| **cose** | 力导向布局 | 模拟物理弹簧系统，节点互相排斥，边像弹簧拉近 | **默认推荐**，自然分布，适合复杂关系网 | 节点自动散开，关系紧密的聚在一起 |
| **circle** | 环形布局 | 所有节点均匀排列在圆周上 | 查看全局概览，节点数较少时 | 围成一个圈 |
| **dagre** | 层级布局 | 有向无环图，从上到下或从左到右排列 | 有明确层级的关系（如势力/组织架构、师徒链） | 像树形结构 |

### 2.2 建议

- **初始默认**：cose（最通用）
- **用户可切换**：提供按钮在三种模式间切换
- **后续可加**：grid（网格）、concentric（同心圆，按重要度分层）

---

## 三、入口位置与 UI 设计

### 3.1 入口位置（已确定）

**位置**：DataTable 组件顶栏，仅在以下表格显示：
- 表名包含"人物"、"NPC"、"角色"、"主角"
- 或 tableId 包含 `protagonist`、`npc`、`character`

**图标**：`fas fa-project-diagram` 或 `fas fa-users`（带连线的人头）

**交互**：
1. 点击图标 → 数据区切换为关系图视图
2. 再次点击 → 切换回表格视图
3. 或提供一个"返回表格"按钮

### 3.2 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  [表名]    [人际关系图][高度拖手] [表格视图切换] [倒序排列]  [搜索框]   │  ← 关系图按钮在这
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │            [关系图视图]                            │ │
│  │             [工具栏] + -（缩放） 📐适应 🔄布局      │ │
│  │                                                    │ │
│  │                                                    │ │
│  │         ┌───┐          ┌───┐                       │ │
│  │         │主角│─────────→│NPC│                      │ │
│  │         └───┘   💗恋人 └───┘                       │ │
│  │                                                   │ │
│  │   [图例] 💗爱情 💙家人 💚朋友 ⚪社会 💛利益 ❤️敌对│ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  [返回表格]                                             │
└─────────────────────────────────────────────────────────┘
```

---

## 四、数据来源策略

### 4.1 双模式支持

| 模式 | 数据来源 | 优点 | 缺点 |
|------|----------|------|------|
| **关系表模式** | 专用的 `sheet_relationships` 表 | 结构清晰，LLM 填写简单 | 需要用户创建新表 |
| **内嵌字段模式** | 从 NPC 表的"人际关系"列解析 | 兼容现有模板 | 格式多样，解析复杂 |

### 4.2 关系表模式（推荐，Phase 1 实现）

**表结构**：
```
| source | target | 关系词 | 备注 |
|--------|--------|--------|------|
| 主角   | 艾莉丝 | 暗恋   | 未表白 |
```

**解析规则**：简单直接，列名匹配即可

### 4.3 内嵌字段模式（Phase 2 实现）

**常见格式示例**：
```
格式1: "主角:挚友; 艾莉丝:恋人"     → {target}:{relation}
格式2: "主角的挚友; 艾莉丝的恋人"   → {target}的{relation}
格式3: "挚友主角; 恋人艾莉丝"       → {relation}{target}
格式4: "父亲张三; 母亲李四"         → {relation}{target}（族谱类）
```

**解析策略（复杂，后续实现）**：
1. 尝试分隔符切分：`;`、`；`、`,`、`，`、`\`、`|`
2. 对每段尝试多种模式匹配
3. 匹配失败则标记为"未识别"

**建议**：Phase 1 只支持关系表模式，等基础功能稳定后再做内嵌字段解析。

---

## 五、关于势力容器

### 5.1 Cytoscape 的复合节点（Compound Nodes）

Cytoscape.js **原生支持**复合节点（父子关系），可以实现"势力包含成员"。

**实现方式**：
```typescript
// 势力节点
{ data: { id: '魔法学院' } }

// 成员节点，parent 指向势力
{ data: { id: '艾莉丝', parent: '魔法学院' } }
```

**效果**：
- 势力显示为一个大框，成员节点在框内
- 拖动势力时，所有成员跟随移动
- 可以收起/展开势力

### 5.2 潜在问题

| 问题 | 说明 | 解决方案 |
|------|------|----------|
| **布局混乱** | 成员太多时容器很大，挤占空间 | 限制容器内布局算法，或默认折叠 |
| **多重归属** | 一个角色属于多个势力？ | Cytoscape 不支持多 parent，需选择主要势力 |
| **关系线交叉** | 容器边界导致线条绕路 | 使用 `compound: true` 布局算法 |

### 5.3 建议

**Phase 1**：不启用势力容器，势力和角色作为平级节点显示
**Phase 3**：作为可选功能，用户可在设置中开启"按势力分组"

---

## 六、开发计划（更新）

### Phase 1 - 基础功能（当前目标）

- [ ] 1.1 关系词颜色映射工具函数
- [ ] 1.2 关系表数据解析器
- [ ] 1.3 RelationshipGraph.vue 组件骨架
- [ ] 1.4 Cytoscape 初始化 + 三种布局
- [ ] 1.5 样式文件 + 父窗口注入
- [ ] 1.6 DataTable 顶栏添加关系图按钮
- [ ] 1.7 视图切换逻辑（表格 ↔ 关系图）

### Phase 2 - 内嵌字段解析

- [ ] 2.1 解析"人际关系"列的多种格式
- [ ] 2.2 模糊匹配 + 用户确认机制
- [ ] 2.3 角色名与表格数据关联

### Phase 3 - 高级功能

- [ ] 3.1 势力容器模式（可选）
- [ ] 3.2 头像系统
- [ ] 3.3 关系筛选
- [ ] 3.4 中心换人
- [ ] 3.5 关系编辑模式

---

## 七、组件 API 设计（精简版）

### Props

```typescript
interface RelationshipGraphProps {
  /** 关系表数据（优先使用） */
  relationshipTable?: ProcessedTable | null;
  /** 人物表列表（用于提取节点，如果没有关系表则解析其中的人际关系列） */
  characterTables?: ProcessedTable[];
  /** 势力表 */
  factionTable?: ProcessedTable | null;
  /** 是否显示图例 */
  showLegend?: boolean;
  /** 初始布局 */
  initialLayout?: 'cose' | 'circle' | 'dagre';
}
```

### Emits

```typescript
interface Emits {
  (e: 'node-click', data: { id: string; type: 'character' | 'faction' }): void;
  (e: 'edge-click', data: { source: string; target: string; relation: string }): void;
  (e: 'back'): void; // 返回表格视图
}
```

### Expose

```typescript
interface Expose {
  fitToView(): void;
  resetZoom(): void;
  setLayout(mode: 'cose' | 'circle' | 'dagre'): void;
  refresh(): void;
}
```

---

## 八、待办确认 ✅

- [x] 入口位置：DataTable 顶栏，仅人物/NPC/角色表显示
- [x] 布局选择：默认 cose，可切换 circle/dagre
- [x] 数据来源：Phase 1 只支持关系表，Phase 2 再做内嵌字段解析
- [x] 势力容器：Phase 1 不启用，Phase 3 作为可选功能
