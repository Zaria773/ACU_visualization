<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç°å®åœ°å›¾è½¬ SVG (AI è¾…åŠ©ä¸“ç”¨)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 20px; display: flex; gap: 30px; background-color: #f4f4f9; color: #333; }
        h2 { margin-top: 0; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .column { flex: 1; display: flex; flex-direction: column; gap: 15px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        textarea {
            height: 300px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }

        #svg-container {
            border: 2px dashed #ccc;
            width: 512px;
            height: 512px;
            background: #2E8B57; /* é»˜è®¤ç»¿åœ°èƒŒæ™¯ */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin: 0 auto;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        label { display: flex; align-items: center; justify-content: space-between; font-weight: 500; }
        input[type="color"] { border: none; width: 40px; height: 25px; cursor: pointer; }

        button {
            padding: 12px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        button.download { background: #28a745; }
        button.download:hover { background: #218838; }

        .help {
            font-size: 0.9em;
            color: #555;
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            line-height: 1.5;
        }
        .help a { color: #007bff; text-decoration: none; }
        .help a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="column">
    <h2>1. æ•°æ®è¾“å…¥</h2>
    <div class="help">
        <strong>ç¬¬ä¸€æ­¥ï¼šè·å–æ•°æ®</strong><br>
        å» <a href="https://geojson.io/" target="_blank">geojson.io</a> ç½‘ç«™ï¼š<br>
        1. åœ¨åœ°å›¾ä¸Šæ‰¾åˆ°ä½ æƒ³ç”Ÿæˆçš„åŸå¸‚åŒºåŸŸã€‚<br>
        2. ç”¨å·¦ä¾§å·¥å…·æ çš„çŸ©å½¢æˆ–å¤šè¾¹å½¢å·¥å…·æ¡†é€‰åŒºåŸŸï¼Œæˆ–è€…æ‰‹åŠ¨ç”»å‡ æ¡è·¯ã€‚<br>
        3. å¤åˆ¶å³ä¾§ç”Ÿæˆçš„ JSON ä»£ç ï¼Œç²˜è´´åˆ°ä¸‹æ–¹ã€‚<br>
        <br>
        <em>è¿›é˜¶ï¼šä¹Ÿå¯ä»¥å» <a href="http://datav.aliyun.com/portal/school/atlas/area_selector" target="_blank">é˜¿é‡Œäº‘ DataV</a> ä¸‹è½½è¡Œæ”¿åŒº JSONã€‚</em>
    </div>
    <textarea id="geojson-input" placeholder="åœ¨æ­¤å¤„ç²˜è´´ GeoJSON å†…å®¹..."></textarea>

    <h3>é¢œè‰²æ˜ å°„è®¾ç½® (AI è¯­ä¹‰)</h3>
    <div class="controls">
        <label>ä½å®… (Brown): <input type="color" id="color-residential" value="#8B4513" title="å±…æ°‘åŒºï¼Œå¯¹åº” house/residential"></label>
        <label>å•†ä¸š (Grey): <input type="color" id="color-commercial" value="#708090" title="é«˜æ¥¼/å•†ä¸šåŒºï¼Œå¯¹åº” skyscrapers"></label>
        <label>ç»¿åœ° (Green): <input type="color" id="color-park" value="#228B22" title="å…¬å›­/è‰åœ°"></label>
        <label>é“è·¯ (Beige): <input type="color" id="color-road" value="#F5DEB3"></label>
        <label>æ°´åŸŸ (Blue): <input type="color" id="color-water" value="#1E90FF"></label>
        <label>èƒŒæ™¯ (Green): <input type="color" id="color-bg" value="#2E8B57"></label>
    </div>
    <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 5px;">
        <label><input type="checkbox" id="random-variation" checked> å¼€å¯éšæœºè‰²å·® (é˜²æ­¢å»ºç­‘ç²˜è¿)</label>
        <label style="color: #d63384; font-weight: bold;">
            <input type="checkbox" id="auto-grid" checked>
            è‡ªåŠ¨å¡«å……è™šæ„è·¯ç½‘ (ä¸“æ²»åªæœ‰è½®å»“çš„å¤§è‰²å—)
        </label>
        <label style="font-size: 0.8em; margin-left: 20px;">
            ç½‘æ ¼å¯†åº¦: <input type="range" id="grid-size" min="10" max="100" value="30" oninput="renderSVG()">
        </label>
    </div>

    <button onclick="renderSVG()">âš¡ ç”Ÿæˆ SVG é¢„è§ˆ</button>
</div>

<div class="column">
    <h2>2. ç»“æœé¢„è§ˆ & ä¸‹è½½</h2>
    <div id="svg-container">
        <span style="color: white; font-weight: bold; text-shadow: 0 1px 2px black;">é¢„è§ˆåŒºåŸŸ</span>
    </div>

    <button class="download" onclick="downloadSVG()">ğŸ’¾ ä¸‹è½½ SVG æ–‡ä»¶</button>

    <div class="help">
        <strong>ç”Ÿæˆçš„ SVG æ€ä¹ˆç”¨ï¼Ÿ</strong><br>
        1. <strong>AI ç”Ÿå›¾ (ControlNet)</strong>ï¼š<br>
           æŠŠ SVG æˆªå›¾æˆ–ä¸‹è½½ï¼Œæ”¾å…¥ Stable Diffusion çš„ ControlNet (Segmentation æ¨¡å¼)ã€‚<br>
           <em>æç¤ºè¯ï¼štop down view map, realistic...</em><br>
        <br>
        2. <strong>ç½‘é¡µäº¤äº’</strong>ï¼š<br>
           åœ¨ç½‘é¡µä»£ç ä¸­ç›´æ¥ä½¿ç”¨è¿™ä¸ª SVGï¼Œè®¾ç½®ä¸ºé€æ˜ï¼Œå®ƒå°±æ˜¯å¤©ç„¶çš„ç‚¹å‡»çƒ­åŒºï¼
    </div>
</div>

<script>
    let currentSVG = null;

    function renderSVG() {
        const input = document.getElementById('geojson-input').value;
        const container = document.getElementById('svg-container');

        // è·å–é¢œè‰²è®¾ç½®
        const colorResidential = document.getElementById('color-residential').value;
        const colorCommercial = document.getElementById('color-commercial').value;
        const colorPark = document.getElementById('color-park').value;
        const colorRoad = document.getElementById('color-road').value;
        const colorWater = document.getElementById('color-water').value;
        const colorBg = document.getElementById('color-bg').value;
        const useRandom = document.getElementById('random-variation').checked;

        // è¾…åŠ©å‡½æ•°ï¼šé¢œè‰²å¾®è°ƒ (è®©æ¯ä¸ªå—é¢œè‰²ä¸ä¸€æ ·ï¼ŒAIæ›´å¥½è¯†åˆ«è¾¹ç¼˜)
        function jitterColor(hex, amount = 20) {
            if (!useRandom) return hex;
            const num = parseInt(hex.slice(1), 16);
            let r = (num >> 16) + (Math.random() * amount - amount/2);
            let g = ((num >> 8) & 0x00FF) + (Math.random() * amount - amount/2);
            let b = (num & 0x0000FF) + (Math.random() * amount - amount/2);
            r = Math.max(0, Math.min(255, r));
            g = Math.max(0, Math.min(255, g));
            b = Math.max(0, Math.min(255, b));
            return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
        }

        // è®¾ç½®å®¹å™¨èƒŒæ™¯è‰²
        container.style.backgroundColor = colorBg;

        if (!input.trim()) {
            alert("è¯·å…ˆç²˜è´´ GeoJSON æ•°æ®ï¼");
            return;
        }

        try {
            const geojson = JSON.parse(input);
            container.innerHTML = ''; // æ¸…ç©º

            const width = 512;
            const height = 512;

            const useAutoGrid = document.getElementById('auto-grid').checked;
            const gridSize = parseInt(document.getElementById('grid-size').value);

            // åˆ›å»º SVG
            const svg = d3.select("#svg-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("xmlns", "http://www.w3.org/2000/svg");

            // å®šä¹‰è™šæ„è·¯ç½‘çº¹ç† (Pattern)
            const defs = svg.append("defs");

            // å•†ä¸šåŒº/é«˜æ¥¼çº¹ç†
            const commercialPattern = defs.append("pattern")
                .attr("id", "pattern-commercial")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", gridSize)
                .attr("height", gridSize);
            // è·¯åº•
            commercialPattern.append("rect")
                .attr("width", gridSize)
                .attr("height", gridSize)
                .attr("fill", colorRoad);
            // å»ºç­‘å— (ä¸­é—´ç•™å‡ºè·¯)
            commercialPattern.append("rect")
                .attr("x", 2)
                .attr("y", 2)
                .attr("width", gridSize - 4)
                .attr("height", gridSize - 4)
                .attr("fill", colorCommercial);

            // ä½å®…åŒºçº¹ç†
            const residentialPattern = defs.append("pattern")
                .attr("id", "pattern-residential")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", gridSize * 0.7) // ä½å®…æ›´å¯†é›†
                .attr("height", gridSize * 0.7);
            residentialPattern.append("rect")
                .attr("width", gridSize * 0.7)
                .attr("height", gridSize * 0.7)
                .attr("fill", colorRoad);
            residentialPattern.append("rect")
                .attr("x", 1)
                .attr("y", 1)
                .attr("width", gridSize * 0.7 - 2)
                .attr("height", gridSize * 0.7 - 2)
                .attr("fill", colorResidential);


            // æ·»åŠ èƒŒæ™¯çŸ©å½¢ (ä¸ºäº†å¯¼å‡ºæ—¶ä¹Ÿæœ‰èƒŒæ™¯)
            svg.append("rect")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("fill", colorBg);

            // æ™ºèƒ½æŠ•å½±ï¼šè‡ªåŠ¨ç¼©æ”¾ GeoJSON ä»¥é€‚åº” 512x512 ç”»å¸ƒ
            const projection = d3.geoMercator()
                .fitSize([width, height], geojson);

            const pathGenerator = d3.geoPath().projection(projection);

            // ç»˜åˆ¶è·¯å¾„
            svg.selectAll("path")
                .data(geojson.features)
                .enter()
                .append("path")
                .attr("d", pathGenerator)
                .attr("stroke", "none")
                .attr("fill", d => {
                    // å¢å¼ºçš„è¯­ä¹‰çŒœæµ‹é€»è¾‘
                    const props = d.properties || {};
                    const type = (props.type || props.kind || props.building || props.landuse || props.leisure || props.highway || "").toLowerCase();
                    const name = (props.name || "").toLowerCase();

                    // æ°´åŸŸ
                    if (type.includes('water') || type.includes('river') || type.includes('lake') || name.includes('æ²³') || name.includes('æ¹–')) return colorWater;

                    // é“è·¯
                    if (type.includes('road') || type.includes('highway') || type.includes('street') || props.highway) return colorRoad;

                    // ç»¿åœ°/å…¬å›­
                    if (type.includes('park') || type.includes('grass') || type.includes('garden') || type.includes('forest') || type.includes('pitch')) return jitterColor(colorPark, 10);

                    // å•†ä¸š/é«˜æ¥¼ (æ ¹æ®å±æ€§æˆ–åå­—çŒœæµ‹)
                    if (type.includes('commercial') || type.includes('retail') || type.includes('office') || type.includes('school') || type.includes('university') || name.includes('å¤§å¦') || name.includes('ä¸­å¿ƒ') || name.includes('å•†åœº')) {
                        return jitterColor(colorCommercial);
                    }

                    // é»˜è®¤ä½å®…/ä¸€èˆ¬å»ºç­‘
                    if (useAutoGrid && !type.includes('water') && !type.includes('park')) {
                        return "url(#pattern-residential)";
                    }
                    return jitterColor(colorResidential);
                })
                // å¦‚æœæ˜¯çº¿å‹æ•°æ®ï¼ˆå¦‚é“è·¯ï¼‰ï¼Œè®¾ç½®æè¾¹
                .attr("stroke", d => {
                     const type = (d.geometry.type);
                     // æ£€æŸ¥å±æ€§æ˜¯å¦æ˜ç¡®æ˜¯è·¯
                     const props = d.properties || {};
                     if (props.highway || type === 'LineString' || type === 'MultiLineString') return colorRoad;
                     return "none";
                })
                .attr("stroke-width", d => {
                     // ç®€å•åŒºåˆ†ä¸»å¹²é“
                     const props = d.properties || {};
                     if (props.highway === 'primary' || props.highway === 'motorway') return 8;
                     return 3;
                });

            currentSVG = svg.node();

        } catch (e) {
            alert("GeoJSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
            console.error(e);
        }
    }

    function downloadSVG() {
        if (!currentSVG) {
            alert("è¯·å…ˆç”Ÿæˆ SVGï¼");
            return;
        }

        const serializer = new XMLSerializer();
        const source = serializer.serializeToString(currentSVG);

        // æ·»åŠ  XML å£°æ˜
        const blob = new Blob(['<?xml version="1.0" standalone="no"?>\r\n', source], {type: "image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "map_base.svg";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
